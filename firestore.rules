rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/adminUsers/$(request.auth.uid));
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ============================================
    // USER PROFILES
    // ============================================
    
    match /users/{userId} {
      // Users can read their own profile, admins can read all
      allow read: if isOwner(userId) || isAdmin();
      
      // Users can only update specific fields (not subscription or usage)
      allow update: if isOwner(userId) && 
                       request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['displayName', 'photoURL', 'lastLoginAt']);
      
      // Only Cloud Functions can create users (via Admin SDK)
      allow create: if false;
      
      // Only admins can delete users
      allow delete: if isAdmin();
    }
    
    // ============================================
    // OPTIMIZATIONS (HISTORY)
    // ============================================
    
    match /optimizations/{optimizationId} {
      // Users can read their own optimizations
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Cloud Functions create optimizations (via Admin SDK which bypasses rules)
      // Users cannot create/update directly from client
      allow create, update: if false;
      
      // Users can delete their own optimization history
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // ============================================
    // SUBSCRIPTION PLANS
    // ============================================
    
    match /subscriptionPlans/{planId} {
      // Everyone can read plans (for pricing page)
      allow read: if true;
      
      // Only admins can create/update/delete plans
      allow write: if isAdmin();
    }
    
    // ============================================
    // ADMIN SETTINGS
    // ============================================

    match /adminSettings/{document} {
      // Only admins can read/write settings
      allow read, write: if isAdmin();
    }

    // ============================================
    // SETTINGS (Quota settings, etc.)
    // ============================================

    match /settings/{document} {
      // Anyone authenticated can read settings (for quota info)
      allow read: if isAuthenticated();

      // Only admins can write settings
      allow write: if isAdmin();
    }
    
    // ============================================
    // ADMIN USERS
    // ============================================
    
    match /adminUsers/{userId} {
      // Only admins can manage admin users
      allow read, write: if isAdmin();
    }
    
    // ============================================
    // USAGE LOGS
    // ============================================
    
    match /usageLogs/{logId} {
      // Only admins can read logs
      allow read: if isAdmin();
      
      // Cloud Functions write logs (via Admin SDK)
      allow write: if false;
    }
    
    // ============================================
    // PLACEMENT FINDER HISTORY
    // ============================================

    match /placementFinderHistory/{historyId} {
      // Users can read their own placement finder history
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Cloud Functions create/update history (via Admin SDK which bypasses rules)
      allow create, update: if false;

      // Users can delete their own placement finder history
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // LEGACY ANALYSES (from old system) - NOW SECURED
    // ============================================

    match /analyses/{analysisId} {
      // SECURITY FIX: Users can only read their own analyses
      // Admins can read all analyses (including legacy ones without userId)
      allow read: if isAuthenticated() &&
                    (resource.data.userId == request.auth.uid || isAdmin());

      // Cloud Functions create/update analyses (via Admin SDK which bypasses rules)
      // Users cannot create/update directly from client
      allow create, update: if false;

      // Users can only delete their own analyses
      // Admins can delete any analysis (including legacy ones)
      allow delete: if isAuthenticated() &&
                      (resource.data.userId == request.auth.uid || isAdmin());
    }

    // ============================================
    // CAMPAIGN REPORTS (Admin-created reports for clients)
    // ============================================

    match /campaignReports/{reportId} {
      // Admins can read all reports
      // Clients can only read reports assigned to them
      allow read: if isAuthenticated() &&
                    (isAdmin() || resource.data.clientId == request.auth.uid);

      // Only Cloud Functions (Admin SDK) can create/update/delete
      allow create, update, delete: if false;
    }

    // ============================================
    // USER NOTIFICATIONS
    // ============================================

    match /userNotifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Users can update their own notifications (mark as read)
      allow update: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid &&
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']);

      // Only Cloud Functions can create/delete notifications
      allow create, delete: if false;
    }

    // ============================================
    // PROMPT TEMPLATES (Creative Studio)
    // ============================================

    match /promptTemplates/{templateId} {
      // All authenticated users can read active prompts (for Creative Studio)
      allow read: if isAuthenticated();

      // Only admins can create/update/delete prompt templates
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // CREATIVE TOKENS
    // ============================================

    match /creativeTokens/{userId} {
      // Users can read their own token balance
      allow read: if isOwner(userId);

      // Only Cloud Functions can modify token balances
      allow write: if false;
    }

    // ============================================
    // CREATIVE HISTORY
    // ============================================

    match /creativeHistory/{historyId} {
      // Users can read their own creative history
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Cloud Functions create history (via Admin SDK)
      allow create, update: if false;

      // Users can delete their own history
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // CREATIVE GALLERY (Community Gallery)
    // ============================================

    match /creativeGallery/{galleryId} {
      // Anyone can read public gallery items (for community gallery display)
      allow read: if true;

      // Cloud Functions handle all writes (via Admin SDK)
      allow create, update, delete: if false;
    }

    // ============================================
    // COMPETITOR HISTORY
    // ============================================

    match /competitorHistory/{historyId} {
      // Users can read their own competitor analysis history
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Cloud Functions create history (via Admin SDK)
      allow create, update: if false;

      // Users can delete their own history
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // TREND HISTORY
    // ============================================

    match /trendHistory/{historyId} {
      // Users can read their own trend analysis history
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Cloud Functions create history (via Admin SDK)
      allow create, update: if false;

      // Users can delete their own history
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // THUMBNAIL HISTORY
    // ============================================

    match /thumbnailHistory/{historyId} {
      // Users can read their own thumbnail history
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Cloud Functions create history (via Admin SDK)
      allow create, update: if false;

      // Users can delete their own history
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // CHANNEL AUDIT HISTORY
    // ============================================

    match /channelAuditHistory/{historyId} {
      // Users can read their own channel audit history
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Cloud Functions create history (via Admin SDK)
      allow create, update: if false;

      // Users can delete their own history
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // AI TOOLS HUB - SCRIPT HISTORY
    // ============================================

    match /scriptHistory/{historyId} {
      // Users can read their own script history
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Cloud Functions create history (via Admin SDK)
      allow create, update: if false;

      // Users can delete their own history
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // AI TOOLS HUB - HOOK HISTORY
    // ============================================

    match /hookHistory/{historyId} {
      // Users can read their own hook history
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Cloud Functions create history (via Admin SDK)
      allow create, update: if false;

      // Users can delete their own history
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // AI TOOLS HUB - CONTENT MULTIPLIER HISTORY
    // ============================================

    match /contentMultiplierHistory/{historyId} {
      // Users can read their own content multiplier history
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Cloud Functions create history (via Admin SDK)
      allow create, update: if false;

      // Users can delete their own history
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // AI TOOLS HUB - THUMBNAIL TEST HISTORY
    // ============================================

    match /thumbnailTestHistory/{historyId} {
      // Users can read their own thumbnail test history
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Cloud Functions create history (via Admin SDK)
      allow create, update: if false;

      // Users can delete their own history
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // AI TOOLS HUB - CONTENT GAP HISTORY
    // ============================================

    match /contentGapHistory/{historyId} {
      // Users can read their own content gap history
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Cloud Functions create history (via Admin SDK)
      allow create, update: if false;

      // Users can delete their own history
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // AI TOOLS HUB - AUDIENCE HISTORY
    // ============================================

    match /audienceHistory/{historyId} {
      // Users can read their own audience analysis history
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Cloud Functions create history (via Admin SDK)
      allow create, update: if false;

      // Users can delete their own history
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // AI TOOLS HUB - COLLAB HISTORY
    // ============================================

    match /collabHistory/{historyId} {
      // Users can read their own collab matchmaker history
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Cloud Functions create history (via Admin SDK)
      allow create, update: if false;

      // Users can delete their own history
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // AI TOOLS HUB - REVENUE HISTORY
    // ============================================

    match /revenueHistory/{historyId} {
      // Users can read their own revenue analysis history
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Cloud Functions create history (via Admin SDK)
      allow create, update: if false;

      // Users can delete their own history
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // AI TOOLS HUB - COACH HISTORY
    // ============================================

    match /coachHistory/{historyId} {
      // Users can read their own coaching history
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Cloud Functions create history (via Admin SDK)
      allow create, update: if false;

      // Users can delete their own history
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // ENTERPRISE SUITE - VIRAL PREDICTOR HISTORY
    // ============================================

    match /viralPredictorHistory/{historyId} {
      // Users can read their own viral predictor history
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Cloud Functions create history (via Admin SDK)
      allow create, update: if false;

      // Users can delete their own history
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // ENTERPRISE SUITE - MONETIZATION HISTORY
    // ============================================

    match /monetizationHistory/{historyId} {
      // Users can read their own monetization analysis history
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Cloud Functions create history (via Admin SDK)
      allow create, update: if false;

      // Users can delete their own history
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // ENTERPRISE SUITE - SCRIPT WRITER HISTORY
    // ============================================

    match /scriptWriterHistory/{historyId} {
      // Users can read their own script writer history
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Cloud Functions create history (via Admin SDK)
      allow create, update: if false;

      // Users can delete their own history
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // ENTERPRISE SUITE - SPONSORSHIP HISTORY
    // ============================================

    match /sponsorshipHistory/{historyId} {
      // Users can read their own sponsorship rate history
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Cloud Functions create history (via Admin SDK)
      allow create, update: if false;

      // Users can delete their own history
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // ENTERPRISE SUITE - DIVERSIFICATION HISTORY
    // ============================================

    match /diversificationHistory/{historyId} {
      // Users can read their own diversification analysis history
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Cloud Functions create history (via Admin SDK)
      allow create, update: if false;

      // Users can delete their own history
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // ENTERPRISE SUITE - CPM BOOSTER HISTORY
    // ============================================

    match /cpmBoosterHistory/{historyId} {
      // Users can read their own CPM booster history
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Cloud Functions create history (via Admin SDK)
      allow create, update: if false;

      // Users can delete their own history
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // ENTERPRISE SUITE - AUDIENCE PROFILE HISTORY
    // ============================================

    match /audienceProfileHistory/{historyId} {
      // Users can read their own audience profile history
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Cloud Functions create history (via Admin SDK)
      allow create, update: if false;

      // Users can delete their own history
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // TOKEN TRANSACTIONS
    // ============================================

    match /tokenTransactions/{transactionId} {
      // Users can read their own transactions, admins can read all
      allow read: if isAuthenticated() &&
                    (resource.data.userId == request.auth.uid || isAdmin());

      // Cloud Functions create transactions (via Admin SDK)
      allow create, update, delete: if false;
    }

    // ============================================
    // PROMO CODES
    // ============================================

    match /promoCodes/{codeId} {
      // Only admins can read/write promo codes
      allow read, write: if isAdmin();
    }
  }
}
