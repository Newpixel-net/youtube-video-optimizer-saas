<!-- ================================================================
     YOUTUBE VIDEO OPTIMIZER - ADMIN DASHBOARD
     ================================================================

     Purpose: Admin-only dashboard for managing the platform

     Tabs:
     - Plans: Manage subscription plan limits
     - API Tokens: Manage API keys and usage
     - Prompts Management: CRUD for prompt templates

     Access: Admin users only

     Last Updated: 2024
     ================================================================ -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Admin Dashboard - YouTube Video Optimizer</title>

    <!-- External Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-functions-compat.js"></script>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            min-height: 100vh;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, Arial, sans-serif;
            font-size: 16px;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            color: white;
        }

        #app-root {
            width: 100%;
            min-height: 100vh;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top-color: #ffd700;
            width: 24px;
            height: 24px;
            animation: spin 0.6s linear infinite;
            display: inline-block;
        }

        /* Main Layout */
        .admin-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header */
        .admin-header {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-title {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-subtitle {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.95rem;
        }

        /* Main Tabs */
        .main-tabs {
            display: flex;
            gap: 0.25rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.75rem;
            padding: 0.35rem;
            width: fit-content;
        }

        .main-tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-radius: 0.5rem;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .main-tab:hover {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }

        .main-tab.active {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
            color: #1a1a2e;
        }

        .main-tab-icon {
            font-size: 1.1rem;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.03) 100%);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 1.25rem;
            padding: 1.75rem;
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: rgba(255, 215, 0, 0.3);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Plan Cards */
        .plan-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.03) 100%);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 1.25rem;
            padding: 1.75rem;
            transition: all 0.3s ease;
        }

        .plan-card:hover {
            border-color: rgba(255, 215, 0, 0.3);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .plan-card.free { border-top: 4px solid #6b7280; }
        .plan-card.lite { border-top: 4px solid #3b82f6; }
        .plan-card.pro { border-top: 4px solid #8b5cf6; }
        .plan-card.enterprise { border-top: 4px solid #ffd700; }

        /* Form Inputs */
        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.06);
            border: 1.5px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.625rem;
            color: white;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.06);
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.1);
        }

        .input-field::-webkit-inner-spin-button,
        .input-field::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .input-field[type=number] {
            -moz-appearance: textfield;
        }

        .textarea-field {
            width: 100%;
            min-height: 120px;
            padding: 0.875rem 1rem;
            background: rgba(255, 255, 255, 0.06);
            border: 1.5px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.625rem;
            color: white;
            font-size: 0.9rem;
            font-family: inherit;
            line-height: 1.5;
            resize: vertical;
            transition: all 0.2s ease;
        }

        .textarea-field:focus {
            outline: none;
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.06);
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        /* Buttons */
        .btn-primary {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%);
            color: #1a1a2e;
            font-weight: 600;
            border-radius: 0.625rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.25);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.35);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            padding: 0.75rem 1.5rem;
            background: rgba(255, 255, 255, 0.08);
            color: white;
            font-weight: 600;
            border-radius: 0.625rem;
            border: 1.5px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-secondary:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-success {
            padding: 0.625rem 1.25rem;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .btn-success:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-danger {
            padding: 0.5rem 1rem;
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            font-weight: 600;
            font-size: 0.8rem;
            border-radius: 0.5rem;
            border: 1px solid rgba(239, 68, 68, 0.3);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-icon:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .btn-icon.btn-cover {
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.3);
        }

        .btn-icon.btn-cover:hover {
            background: rgba(139, 92, 246, 0.35);
        }

        /* Cover Modal Styles */
        .cover-modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .cover-modal {
            background: #1a1a2e;
            border-radius: 1rem;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .cover-modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cover-modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
        }

        .cover-modal-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .cover-modal-close:hover {
            color: white;
        }

        .cover-modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .cover-preview-area {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1rem;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cover-preview-area img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 0.5rem;
        }

        .cover-preview-placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .cover-preview-placeholder span {
            font-size: 3rem;
            display: block;
            margin-bottom: 0.75rem;
        }

        .cover-info-box {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
        }

        .cover-info-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 0.25rem;
        }

        .cover-info-value {
            font-size: 0.9rem;
            color: white;
        }

        .cover-modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
            max-width: 400px;
        }

        .toast-success {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }

        .toast-error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .toast-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        /* Tool Row */
        .tool-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.875rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 0.625rem;
            margin-bottom: 0.625rem;
        }

        .tool-row:last-child {
            margin-bottom: 0;
        }

        .tool-icon {
            width: 36px;
            height: 36px;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .tool-name {
            flex: 1;
            color: rgba(255, 255, 255, 0.85);
            font-weight: 500;
            min-width: 140px;
        }

        .tool-input {
            width: 80px;
        }

        /* Confirm Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-content {
            background: linear-gradient(145deg, #1e1e3f 0%, #0f0f23 100%);
            border: 1.5px solid rgba(255, 255, 255, 0.15);
            border-radius: 1.25rem;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 0.5rem;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Prompt Template Table */
        .prompt-table {
            width: 100%;
            border-collapse: collapse;
        }

        .prompt-table th {
            text-align: left;
            padding: 0.875rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .prompt-table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
        }

        .prompt-table tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .prompt-preview {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
        }

        .category-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.75rem;
            background: rgba(139, 92, 246, 0.2);
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #a78bfa;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .status-badge.active {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .status-badge.inactive {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* Stats Grid (Users Tab) */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-card.stat-highlight {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(99, 102, 241, 0.2) 100%);
            border-color: rgba(139, 92, 246, 0.3);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 500;
        }

        /* API Token Cards */
        .api-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
        }

        .api-card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .api-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(236, 72, 153, 0.2) 100%);
            border-radius: 0.75rem;
            font-size: 1.5rem;
        }

        .api-info h3 {
            font-size: 1rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.25rem;
        }

        .api-info p {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .api-key-display {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .api-key-value {
            flex: 1;
            font-family: monospace;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .api-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .api-stat {
            text-align: center;
        }

        .api-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
        }

        .api-stat-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Category Filter Pills */
        .category-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .category-filter {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .category-filter:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .category-filter.active {
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            border-color: transparent;
            color: white;
        }

        /* Search Box */
        .search-box {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .search-input {
            width: 100%;
            padding: 0.875rem 1rem 0.875rem 3rem;
            background: rgba(255, 255, 255, 0.06);
            border: 1.5px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.75rem;
            color: white;
            font-size: 0.95rem;
        }

        .search-input:focus {
            outline: none;
            border-color: #ffd700;
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.4);
        }

        /* Grid Layouts */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .grid-4 {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 1024px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            .grid-3 {
                grid-template-columns: repeat(2, 1fr);
            }
            .grid-4 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .admin-container {
                padding: 1rem;
            }

            .main-tabs {
                width: 100%;
                overflow-x: auto;
                flex-wrap: nowrap;
            }

            .main-tab {
                flex: 0 0 auto;
                padding: 0.6rem 1rem;
                font-size: 0.85rem;
            }

            .tool-row {
                flex-wrap: wrap;
            }

            .tool-name {
                width: 100%;
                margin-bottom: 0.5rem;
            }

            .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }

            .api-stats {
                grid-template-columns: 1fr;
            }

            .prompt-table {
                display: block;
                overflow-x: auto;
            }
        }

        /* Select dropdown */
        .select-field {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.06);
            border: 1.5px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.625rem;
            color: white;
            font-size: 0.95rem;
            cursor: pointer;
        }

        .select-field:focus {
            outline: none;
            border-color: #ffd700;
        }

        .select-field option {
            background: #1a1a2e;
            color: white;
        }

        /* Info Box */
        .info-box {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .info-box p {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.8);
            margin: 0;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 1rem;
            border: 1px dashed rgba(255, 255, 255, 0.1);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 1.5rem;
        }

        /* Action Buttons Row */
        .actions-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .actions-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .actions-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
    </style>
</head>
<body>
    <div id="app-root"></div>

    <script>
        // Platform Version
        const PLATFORM_VERSION = '1.0.1';

        // Firebase Configuration
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAGczY5ZEIJdTq25BpQdia3lv2I556wOZo",
            authDomain: "ytseo-6d1b0.firebaseapp.com",
            projectId: "ytseo-6d1b0",
            storageBucket: "ytseo-6d1b0.firebasestorage.app",
            messagingSenderId: "382790048044",
            appId: "1:382790048044:web:cd427679ff72108c1f3489"
        };

        firebase.initializeApp(FIREBASE_CONFIG);
        const auth = firebase.auth();
        const functions = firebase.functions();
        const db = firebase.firestore();

        // Prompt Categories Configuration
        const promptCategoriesConfig = [
            { key: 'photorealism', name: 'Photorealism & Aesthetics', icon: 'üì∏' },
            { key: 'creative', name: 'Creative Experiments', icon: 'üé®' },
            { key: 'scripts', name: 'Structured Scripts (JSON)', icon: 'üìú' },
            { key: 'education', name: 'Education & Knowledge', icon: 'üìö' },
            { key: 'ecommerce', name: 'E-commerce & Virtual Studio', icon: 'üõí' },
            { key: 'workplace', name: 'Workplace & Productivity', icon: 'üíº' },
            { key: 'photoediting', name: 'Photo Editing & Restoration', icon: '‚ú®' },
            { key: 'interior', name: 'Interior Design', icon: 'üè†' },
            { key: 'social', name: 'Social Media & Marketing', icon: 'üì±' },
            { key: 'daily', name: 'Daily Life & Translation', icon: 'üåç' },
            { key: 'avatars', name: 'Social Networking & Avatars', icon: 'üë§' },
            { key: 'new', name: 'New Additions', icon: 'üÜï' }
        ];

        // Application State
        const state = {
            currentView: 'loading',
            activeTab: 'users', // users | plans | api | prompts
            user: null,
            isAdmin: false,

            // Users state (moved from dual-auth-widget)
            adminUsers: [],
            usersLoading: false,
            resetTimeMinutes: 1440,

            // Plans state
            plans: [],
            editedPlans: {},
            loading: false,
            saving: {},
            syncing: {},

            // API Tokens state
            apiKeys: {
                gemini: { key: '***hidden***', status: 'active', usage: 1250, limit: 10000 },
                openai: { key: '***hidden***', status: 'active', usage: 890, limit: 5000 },
                youtube: { key: '***hidden***', status: 'active', usage: 2340, limit: 50000 }
            },

            // Prompts state
            prompts: [],
            promptsLoading: false,
            promptFilter: 'all',
            promptSearch: '',
            editingPrompt: null,

            // Token Configuration state
            tokenConfig: null,
            tokenConfigLoading: false,
            editedTokenConfig: {},

            // API Costs & Pricing state
            apiCosts: null,
            apiCostsLoading: false,
            editedApiCosts: {},

            // Promo Codes state
            promoCodes: [],
            promoCodesLoading: false,
            newPromoCode: { code: '', tokenAmount: 10, maxUses: 0, expiresAt: '', description: '' },

            // Analytics state
            analytics: null,
            analyticsLoading: false,
            analyticsPeriod: '30d',

            // Token Transactions state
            transactions: [],
            transactionsLoading: false,

            // UI state
            toast: null,
            confirmModal: null,
            promptModal: null,

            // Cover image modal state
            coverModal: null,  // { promptId, prompt, generatedImage, generating, saving }
        };

        // Tool configuration with icons and colors
        const toolConfig = {
            warpOptimizer: { name: 'Warp Optimizer', icon: 'üöÄ', bg: 'bg-blue-500/20' },
            competitorAnalysis: { name: 'Competitor Analysis', icon: 'üéØ', bg: 'bg-orange-500/20' },
            trendPredictor: { name: 'Trend Predictor', icon: 'üìà', bg: 'bg-pink-500/20' },
            thumbnailGenerator: { name: 'AI Thumbnails', icon: 'üé®', bg: 'bg-purple-500/20' },
            channelAudit: { name: 'Channel Audit', icon: 'üîç', bg: 'bg-teal-500/20' }
        };

        // Utility Functions
        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showToast(message, type) {
            state.toast = { message: message, type: type || 'success' };
            render();
            setTimeout(function() {
                state.toast = null;
                render();
            }, 4000);
        }

        function truncateText(text, maxLength) {
            if (!text || text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        // Main Render
        function render() {
            var root = document.getElementById('app-root');
            var html = '';

            // Toast notification
            if (state.toast) {
                html += '<div class="toast toast-' + state.toast.type + '">';
                html += (state.toast.type === 'success' ? '‚úì ' : state.toast.type === 'error' ? '‚ö† ' : '‚Ñπ ') + escapeHtml(state.toast.message);
                html += '</div>';
            }

            // Modals
            if (state.confirmModal) {
                html += renderConfirmModal();
            }
            if (state.promptModal) {
                html += renderPromptModal();
            }
            if (state.coverModal) {
                html += renderCoverModal();
            }

            if (state.currentView === 'loading') {
                html += renderLoading();
            } else if (state.currentView === 'unauthorized') {
                html += renderUnauthorized();
            } else if (state.currentView === 'dashboard') {
                html += renderDashboard();
            }

            root.innerHTML = html;
        }

        function renderLoading() {
            return '<div class="flex items-center justify-center min-h-screen">' +
                '<div class="text-center">' +
                '<div class="spinner mx-auto mb-4"></div>' +
                '<p class="text-white/70">Loading admin dashboard...</p>' +
                '</div></div>';
        }

        function renderUnauthorized() {
            return '<div class="flex items-center justify-center min-h-screen">' +
                '<div class="text-center card max-w-md">' +
                '<div class="text-6xl mb-4">üîí</div>' +
                '<h2 class="text-2xl font-bold text-white mb-2">Access Denied</h2>' +
                '<p class="text-white/60 mb-6">You need admin privileges to access this page.</p>' +
                '<button onclick="goToDashboard()" class="btn-secondary">‚Üê Back to Dashboard</button>' +
                '</div></div>';
        }

        function renderConfirmModal() {
            var modal = state.confirmModal;
            return '<div class="modal-overlay" onclick="closeConfirmModal()">' +
                '<div class="modal-content fade-in" onclick="event.stopPropagation()" style="max-width: 450px; text-align: center;">' +
                '<div class="text-5xl mb-4">' + modal.icon + '</div>' +
                '<h3 class="text-xl font-bold text-white mb-2">' + escapeHtml(modal.title) + '</h3>' +
                '<p class="text-white/70 mb-6">' + escapeHtml(modal.message) + '</p>' +
                '<div class="flex gap-3 justify-center">' +
                '<button onclick="closeConfirmModal()" class="btn-secondary">Cancel</button>' +
                '<button onclick="' + modal.confirmAction + '" class="btn-primary">' + escapeHtml(modal.confirmText) + '</button>' +
                '</div></div></div>';
        }

        function renderPromptModal() {
            var prompt = state.editingPrompt || {};
            var isNew = !prompt.id;
            var title = isNew ? 'Add New Prompt Template' : 'Edit Prompt Template';

            var html = '<div class="modal-overlay" onclick="closePromptModal()">';
            html += '<div class="modal-content fade-in" onclick="event.stopPropagation()">';

            // Header
            html += '<div class="modal-header">';
            html += '<h3 class="modal-title">' + title + '</h3>';
            html += '<button onclick="closePromptModal()" class="modal-close">‚úï</button>';
            html += '</div>';

            // Form
            html += '<form onsubmit="savePrompt(event)">';

            // Name & Category Row
            html += '<div class="form-row">';
            html += '<div class="form-group">';
            html += '<label class="form-label">Template Name *</label>';
            html += '<input type="text" id="prompt-name" class="input-field" value="' + escapeHtml(prompt.name || '') + '" placeholder="e.g., Business Portrait" required />';
            html += '</div>';
            html += '<div class="form-group">';
            html += '<label class="form-label">Category *</label>';
            html += '<select id="prompt-category" class="select-field" required>';
            for (var i = 0; i < promptCategoriesConfig.length; i++) {
                var cat = promptCategoriesConfig[i];
                var selected = prompt.category === cat.key ? ' selected' : '';
                html += '<option value="' + cat.key + '"' + selected + '>' + cat.icon + ' ' + cat.name + '</option>';
            }
            html += '</select>';
            html += '</div>';
            html += '</div>';

            // Description
            html += '<div class="form-group">';
            html += '<label class="form-label">Short Description *</label>';
            html += '<input type="text" id="prompt-description" class="input-field" value="' + escapeHtml(prompt.description || '') + '" placeholder="Brief description for users" required />';
            html += '</div>';

            // User-Facing Prompt (what users see)
            html += '<div class="form-group">';
            html += '<label class="form-label">User-Facing Prompt</label>';
            html += '<textarea id="prompt-user" class="textarea-field" placeholder="Simple prompt users see, e.g., Create a {{subject}} in {{style}} style...">' + escapeHtml(prompt.userPrompt || '') + '</textarea>';
            html += '<p style="font-size: 0.75rem; color: rgba(255,255,255,0.4); margin-top: 0.35rem;">Use {{variable}} for user inputs. Leave empty to use simplified version.</p>';
            html += '</div>';

            // Professional Prompt (backend)
            html += '<div class="form-group">';
            html += '<label class="form-label">Professional Prompt (Backend) *</label>';
            html += '<textarea id="prompt-professional" class="textarea-field" style="min-height: 200px;" placeholder="Full professional prompt sent to the API..." required>' + escapeHtml(prompt.professionalPrompt || '') + '</textarea>';
            html += '<p style="font-size: 0.75rem; color: rgba(255,255,255,0.4); margin-top: 0.35rem;">This detailed prompt is sent to Gemini API. Include all technical details, lighting, camera settings, etc.</p>';
            html += '</div>';

            // Token Cost & Status Row
            html += '<div class="form-row">';
            html += '<div class="form-group">';
            html += '<label class="form-label">Token Cost</label>';
            html += '<input type="number" id="prompt-cost" class="input-field" value="' + (prompt.tokenCost || 2) + '" min="1" max="10" />';
            html += '</div>';
            html += '<div class="form-group">';
            html += '<label class="form-label">Status</label>';
            html += '<select id="prompt-status" class="select-field">';
            html += '<option value="active"' + (prompt.isActive !== false ? ' selected' : '') + '>Active</option>';
            html += '<option value="inactive"' + (prompt.isActive === false ? ' selected' : '') + '>Inactive</option>';
            html += '</select>';
            html += '</div>';
            html += '</div>';

            // Actions
            html += '<div style="display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">';
            html += '<button type="button" onclick="closePromptModal()" class="btn-secondary">Cancel</button>';
            html += '<button type="submit" class="btn-primary">' + (isNew ? '‚ûï Create Template' : 'üíæ Save Changes') + '</button>';
            html += '</div>';

            html += '</form>';
            html += '</div></div>';
            return html;
        }

        // Dashboard View
        function renderDashboard() {
            var html = '<div class="admin-container fade-in">';

            // Header
            html += '<div class="admin-header">';
            html += '<div class="header-top">';
            html += '<div>';
            html += '<h1 class="header-title">Admin Dashboard</h1>';
            html += '<p class="header-subtitle">Manage plans, API tokens, and prompt templates <span style="opacity:0.5;margin-left:8px;">v' + PLATFORM_VERSION + '</span></p>';
            html += '</div>';
            html += '<div class="flex gap-3">';
            html += '<button onclick="refreshData()" class="btn-secondary"' + (state.loading ? ' disabled' : '') + '>';
            html += state.loading ? '<span class="spinner" style="width:16px;height:16px"></span>' : '‚Üª Refresh';
            html += '</button>';
            html += '<button onclick="goToDashboard()" class="btn-secondary">‚Üê Dashboard</button>';
            html += '</div>';
            html += '</div>';

            // Main Tabs - Row 1: Core Management
            html += '<div class="main-tabs">';
            html += '<button class="main-tab' + (state.activeTab === 'users' ? ' active' : '') + '" onclick="setActiveTab(\'users\')">';
            html += '<span class="main-tab-icon">üë•</span>';
            html += '<span>Users</span>';
            html += '</button>';
            html += '<button class="main-tab' + (state.activeTab === 'plans' ? ' active' : '') + '" onclick="setActiveTab(\'plans\')">';
            html += '<span class="main-tab-icon">üìã</span>';
            html += '<span>Plans</span>';
            html += '</button>';
            html += '<button class="main-tab' + (state.activeTab === 'tokenConfig' ? ' active' : '') + '" onclick="setActiveTab(\'tokenConfig\')">';
            html += '<span class="main-tab-icon">ü™ô</span>';
            html += '<span>Tokens</span>';
            html += '</button>';
            html += '<button class="main-tab' + (state.activeTab === 'pricing' ? ' active' : '') + '" onclick="setActiveTab(\'pricing\')">';
            html += '<span class="main-tab-icon">üí∞</span>';
            html += '<span>Pricing</span>';
            html += '</button>';
            html += '</div>';

            // Main Tabs - Row 2: Marketing & Analytics
            html += '<div class="main-tabs" style="margin-top: 0.5rem;">';
            html += '<button class="main-tab' + (state.activeTab === 'promoCodes' ? ' active' : '') + '" onclick="setActiveTab(\'promoCodes\')">';
            html += '<span class="main-tab-icon">üéÅ</span>';
            html += '<span>Promo Codes</span>';
            html += '</button>';
            html += '<button class="main-tab' + (state.activeTab === 'analytics' ? ' active' : '') + '" onclick="setActiveTab(\'analytics\')">';
            html += '<span class="main-tab-icon">üìä</span>';
            html += '<span>Analytics</span>';
            html += '</button>';
            html += '<button class="main-tab' + (state.activeTab === 'transactions' ? ' active' : '') + '" onclick="setActiveTab(\'transactions\')">';
            html += '<span class="main-tab-icon">üìú</span>';
            html += '<span>Transactions</span>';
            html += '</button>';
            html += '<button class="main-tab' + (state.activeTab === 'prompts' ? ' active' : '') + '" onclick="setActiveTab(\'prompts\')">';
            html += '<span class="main-tab-icon">‚ú®</span>';
            html += '<span>Prompts</span>';
            html += '</button>';
            html += '</div>';
            html += '</div>';

            // Tab Content
            html += '<div class="tab-content' + (state.activeTab === 'users' ? ' active' : '') + '">';
            html += renderUsersTab();
            html += '</div>';

            html += '<div class="tab-content' + (state.activeTab === 'plans' ? ' active' : '') + '">';
            html += renderPlansTab();
            html += '</div>';

            html += '<div class="tab-content' + (state.activeTab === 'tokenConfig' ? ' active' : '') + '">';
            html += renderTokenConfigTab();
            html += '</div>';

            html += '<div class="tab-content' + (state.activeTab === 'pricing' ? ' active' : '') + '">';
            html += renderPricingTab();
            html += '</div>';

            html += '<div class="tab-content' + (state.activeTab === 'promoCodes' ? ' active' : '') + '">';
            html += renderPromoCodesTab();
            html += '</div>';

            html += '<div class="tab-content' + (state.activeTab === 'analytics' ? ' active' : '') + '">';
            html += renderAnalyticsTab();
            html += '</div>';

            html += '<div class="tab-content' + (state.activeTab === 'transactions' ? ' active' : '') + '">';
            html += renderTransactionsTab();
            html += '</div>';

            html += '<div class="tab-content' + (state.activeTab === 'prompts' ? ' active' : '') + '">';
            html += renderPromptsTab();
            html += '</div>';

            html += '</div>';
            return html;
        }

        // =============================================
        // USERS TAB (Moved from dual-auth-widget.html)
        // =============================================
        function renderUsersTab() {
            var html = '';

            // Stats Cards
            var totalUsers = state.adminUsers ? state.adminUsers.length : 0;
            var proUsers = state.adminUsers ? state.adminUsers.filter(function(u) { return u.subscription && u.subscription.plan === 'pro'; }).length : 0;
            var enterpriseUsers = state.adminUsers ? state.adminUsers.filter(function(u) { return u.subscription && u.subscription.plan === 'enterprise'; }).length : 0;
            var liteUsers = state.adminUsers ? state.adminUsers.filter(function(u) { return u.subscription && u.subscription.plan === 'lite'; }).length : 0;
            var freeUsers = totalUsers - proUsers - enterpriseUsers - liteUsers;

            html += '<div class="stats-grid">';

            html += '<div class="stat-card">';
            html += '<div class="stat-icon">üë•</div>';
            html += '<div class="stat-value">' + totalUsers + '</div>';
            html += '<div class="stat-label">Total Users</div>';
            html += '</div>';

            html += '<div class="stat-card stat-highlight">';
            html += '<div class="stat-icon">‚≠ê</div>';
            html += '<div class="stat-value">' + proUsers + '</div>';
            html += '<div class="stat-label">Pro Users</div>';
            html += '</div>';

            html += '<div class="stat-card">';
            html += '<div class="stat-icon">üíé</div>';
            html += '<div class="stat-value">' + enterpriseUsers + '</div>';
            html += '<div class="stat-label">Enterprise</div>';
            html += '</div>';

            html += '<div class="stat-card">';
            html += '<div class="stat-icon">üÜì</div>';
            html += '<div class="stat-value">' + freeUsers + '</div>';
            html += '<div class="stat-label">Free Users</div>';
            html += '</div>';

            html += '</div>';

            // Two-column layout for settings and user table
            html += '<div class="grid-2" style="margin-top: 1.5rem;">';

            // Left Column: User Management Table
            html += '<div class="card" style="grid-column: span 2;">';
            html += '<h3 class="card-title">üë• User Management</h3>';

            if (state.usersLoading) {
                html += '<div style="text-align: center; padding: 3rem;">';
                html += '<div class="spinner" style="margin: 0 auto 1rem;"></div>';
                html += '<p style="color: rgba(255,255,255,0.6);">Loading users...</p>';
                html += '</div>';
            } else if (!state.adminUsers || state.adminUsers.length === 0) {
                html += '<p style="color: rgba(255,255,255,0.5); text-align: center; padding: 2rem;">No users found</p>';
            } else {
                html += '<div style="overflow-x: auto;">';
                html += '<table class="prompt-table">';
                html += '<thead><tr>';
                html += '<th>User</th>';
                html += '<th>Plan</th>';
                html += '<th>Usage Today</th>';
                html += '<th>Actions</th>';
                html += '</tr></thead>';
                html += '<tbody>';

                for (var i = 0; i < state.adminUsers.length; i++) {
                    var user = state.adminUsers[i];
                    var plan = user.subscription ? user.subscription.plan : 'free';
                    var planColors = {
                        'free': 'background: rgba(107, 114, 128, 0.2); color: #9ca3af;',
                        'lite': 'background: rgba(59, 130, 246, 0.2); color: #60a5fa;',
                        'pro': 'background: rgba(139, 92, 246, 0.2); color: #a78bfa;',
                        'enterprise': 'background: rgba(245, 158, 11, 0.2); color: #fbbf24;'
                    };

                    var baseLimit = user.usage && user.usage.warpOptimizer ? user.usage.warpOptimizer.limit : 0;
                    var bonusUses = user.bonusUses && user.bonusUses.warpOptimizer ? user.bonusUses.warpOptimizer : 0;
                    var usedToday = user.usage && user.usage.warpOptimizer ? user.usage.warpOptimizer.usedToday : 0;
                    var totalLimit = baseLimit + bonusUses;

                    html += '<tr>';
                    html += '<td>';
                    html += '<div style="font-weight: 600; color: white;">' + escapeHtml(user.email || 'No email') + '</div>';
                    html += '<div style="font-size: 0.75rem; color: rgba(255,255,255,0.4);">ID: ' + escapeHtml(user.uid ? user.uid.substring(0, 12) + '...' : '') + '</div>';
                    html += '</td>';
                    html += '<td>';
                    html += '<span style="padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; ' + (planColors[plan] || planColors['free']) + '">' + plan.toUpperCase() + '</span>';
                    html += '</td>';
                    html += '<td>';
                    html += '<span style="color: white; font-weight: 500;">' + usedToday + '/' + totalLimit + '</span>';
                    if (bonusUses > 0) {
                        html += '<span style="color: #10b981; font-size: 0.75rem; margin-left: 0.5rem;">(+' + bonusUses + ' bonus)</span>';
                    }
                    html += '</td>';
                    html += '<td>';
                    html += '<select onchange="updateUserPlan(\'' + user.uid + '\', this.value)" class="select-field" style="width: auto; padding: 0.5rem 1rem;">';
                    html += '<option value="free"' + (plan === 'free' ? ' selected' : '') + '>Free</option>';
                    html += '<option value="lite"' + (plan === 'lite' ? ' selected' : '') + '>Lite</option>';
                    html += '<option value="pro"' + (plan === 'pro' ? ' selected' : '') + '>Pro</option>';
                    html += '<option value="enterprise"' + (plan === 'enterprise' ? ' selected' : '') + '>Enterprise</option>';
                    html += '</select>';
                    html += '</td>';
                    html += '</tr>';
                }

                html += '</tbody></table>';
                html += '</div>';
            }
            html += '</div>';

            html += '</div>'; // End grid-2

            // Bottom row: Settings cards
            html += '<div class="grid-2" style="margin-top: 1.5rem;">';

            // Quota Reset Time
            html += '<div class="card">';
            html += '<h3 class="card-title">‚è±Ô∏è Quota Reset Time</h3>';
            html += '<p style="color: rgba(255,255,255,0.6); font-size: 0.85rem; margin-bottom: 1rem;">Set how often user quotas reset. Default: 1440 minutes (24 hours).</p>';
            html += '<div style="display: flex; gap: 0.75rem; align-items: flex-end;">';
            html += '<div style="flex: 1;">';
            html += '<label class="input-label">Reset Interval (minutes)</label>';
            html += '<input type="number" id="reset-time-input" value="' + (state.resetTimeMinutes || 1440) + '" min="1" class="input-field" />';
            html += '</div>';
            html += '<button onclick="setQuotaResetTime()" class="btn-primary" style="height: 42px;">Save</button>';
            html += '</div>';
            html += '<p style="font-size: 0.75rem; color: rgba(255,255,255,0.4); margin-top: 0.5rem;">Examples: 60 = 1 hour, 240 = 4 hours, 1440 = 24 hours</p>';
            html += '</div>';

            // Grant Bonus Uses
            html += '<div class="card">';
            html += '<h3 class="card-title">üéÅ Grant Bonus Uses</h3>';
            html += '<p style="color: rgba(255,255,255,0.6); font-size: 0.85rem; margin-bottom: 1rem;">Give extra uses to a specific user as a gift or bonus.</p>';

            html += '<div style="display: grid; gap: 0.75rem;">';

            html += '<div>';
            html += '<label class="input-label">Select User</label>';
            html += '<select id="bonus-user-select" class="select-field">';
            html += '<option value="">-- Select a user --</option>';
            if (state.adminUsers) {
                for (var j = 0; j < state.adminUsers.length; j++) {
                    var u = state.adminUsers[j];
                    html += '<option value="' + u.uid + '">' + escapeHtml(u.email || u.uid) + '</option>';
                }
            }
            html += '</select>';
            html += '</div>';

            html += '<div>';
            html += '<label class="input-label">Select Tool</label>';
            html += '<select id="bonus-tool-select" class="select-field">';
            html += '<option value="warpOptimizer">Warp Optimizer</option>';
            html += '<option value="competitorAnalysis">Competitor Analysis</option>';
            html += '<option value="trendPredictor">Trend Predictor</option>';
            html += '<option value="thumbnailGenerator">AI Thumbnails</option>';
            html += '<option value="channelAudit">Channel Audit</option>';
            html += '</select>';
            html += '</div>';

            html += '<div>';
            html += '<label class="input-label">Bonus Amount</label>';
            html += '<input type="number" id="bonus-amount-input" value="5" min="1" class="input-field" />';
            html += '</div>';

            html += '<button onclick="grantBonusUses()" class="btn-primary" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">üéÅ Grant Bonus Uses</button>';
            html += '</div>';

            html += '</div>';

            html += '</div>'; // End grid-2

            return html;
        }

        // Plans Tab
        function renderPlansTab() {
            var html = '<div class="grid-2">';

            for (var i = 0; i < state.plans.length; i++) {
                var plan = state.plans[i];
                html += renderPlanCard(plan);
            }

            html += '</div>';

            // Info section
            html += '<div class="card" style="margin-top: 1.5rem;">';
            html += '<h3 class="card-title">üí° How It Works</h3>';
            html += '<ul style="color: rgba(255,255,255,0.7); font-size: 0.9rem; list-style: disc; padding-left: 1.5rem; margin-top: 0.75rem;">';
            html += '<li style="margin-bottom: 0.5rem;"><strong style="color:white">Daily Limit:</strong> Maximum uses per day for each tool (0-1000)</li>';
            html += '<li style="margin-bottom: 0.5rem;"><strong style="color:white">Save Changes:</strong> Updates the plan configuration in the database</li>';
            html += '<li style="margin-bottom: 0.5rem;"><strong style="color:white">Sync Users:</strong> Applies new limits to all existing users on that plan</li>';
            html += '<li><strong style="color:white">New Users:</strong> Will automatically get the updated limits when they sign up</li>';
            html += '</ul>';
            html += '</div>';

            return html;
        }

        function renderPlanCard(plan) {
            var planId = plan.id;
            var isSaving = state.saving[planId];
            var isSyncing = state.syncing[planId];
            var hasChanges = state.editedPlans[planId] !== undefined;

            var html = '<div class="plan-card ' + planId + '">';

            // Header
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem;">';
            html += '<div>';
            html += '<h2 style="font-size: 1.25rem; font-weight: 700; color: white;">' + escapeHtml(plan.name || planId) + '</h2>';
            html += '<p style="color: rgba(255,255,255,0.5); font-size: 0.85rem;">$' + (plan.price || 0).toFixed(2) + '/week</p>';
            html += '</div>';
            if (plan.badge) {
                html += '<span style="padding: 0.35rem 0.75rem; background: rgba(255,215,0,0.2); color: #ffd700; font-size: 0.7rem; font-weight: 700; border-radius: 9999px;">' + escapeHtml(plan.badge) + '</span>';
            }
            html += '</div>';

            // Tools
            html += '<div style="margin-bottom: 1.25rem;">';
            var tools = Object.keys(toolConfig);
            for (var i = 0; i < tools.length; i++) {
                var tool = tools[i];
                var config = toolConfig[tool];
                var limit = getEditedLimit(planId, tool);
                if (limit === null) {
                    limit = plan.limits && plan.limits[tool] ? plan.limits[tool].dailyLimit : 0;
                }

                html += '<div class="tool-row">';
                html += '<div class="tool-icon ' + config.bg + '">' + config.icon + '</div>';
                html += '<span class="tool-name">' + config.name + '</span>';
                html += '<input type="number" class="input-field tool-input" ';
                html += 'value="' + limit + '" ';
                html += 'min="0" max="1000" ';
                html += 'onchange="updateLimit(\'' + planId + '\', \'' + tool + '\', this.value)" ';
                html += 'placeholder="0" />';
                html += '<span style="color: rgba(255,255,255,0.4); font-size: 0.85rem;">/day</span>';
                html += '</div>';
            }
            html += '</div>';

            // Actions
            html += '<div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">';

            // Save button
            html += '<button onclick="savePlanLimits(\'' + planId + '\')" class="btn-primary" style="flex: 1;" ';
            html += (isSaving || !hasChanges) ? 'disabled' : '';
            html += '>';
            if (isSaving) {
                html += '<span class="spinner" style="width:16px;height:16px;border-width:2px"></span> Saving...';
            } else {
                html += 'üíæ Save Changes';
            }
            html += '</button>';

            // Sync button
            html += '<button onclick="confirmSyncUsers(\'' + planId + '\')" class="btn-success" ';
            html += isSyncing ? 'disabled' : '';
            html += '>';
            if (isSyncing) {
                html += '<span class="spinner" style="width:14px;height:14px;border-width:2px"></span> Syncing...';
            } else {
                html += 'üîÑ Sync Users';
            }
            html += '</button>';

            html += '</div>';

            html += '</div>';
            return html;
        }

        // API Tokens Tab
        function renderApiTab() {
            var html = '';

            // Info box
            html += '<div class="info-box">';
            html += '<p>üîê <strong>API keys are managed via Firebase Functions Config.</strong> To update, use: <code style="background: rgba(0,0,0,0.3); padding: 0.15rem 0.4rem; border-radius: 0.25rem;">firebase functions:config:set gemini.key="YOUR_KEY"</code></p>';
            html += '</div>';

            html += '<div class="grid-3">';

            // Gemini API Card
            html += '<div class="api-card">';
            html += '<div class="api-card-header">';
            html += '<div class="api-icon">ü§ñ</div>';
            html += '<div class="api-info">';
            html += '<h3>Gemini / Imagen API</h3>';
            html += '<p>Image generation</p>';
            html += '</div>';
            html += '</div>';
            html += '<div class="api-key-display">';
            html += '<span class="api-key-value">gemini.key = ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>';
            html += '<button class="btn-icon" title="Copy command">üìã</button>';
            html += '</div>';
            html += '<div class="api-stats">';
            html += '<div class="api-stat">';
            html += '<div class="api-stat-value">1,250</div>';
            html += '<div class="api-stat-label">This Month</div>';
            html += '</div>';
            html += '<div class="api-stat">';
            html += '<div class="api-stat-value">10,000</div>';
            html += '<div class="api-stat-label">Monthly Limit</div>';
            html += '</div>';
            html += '<div class="api-stat">';
            html += '<div class="api-stat-value" style="color: #22c55e;">Active</div>';
            html += '<div class="api-stat-label">Status</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';

            // OpenAI API Card
            html += '<div class="api-card">';
            html += '<div class="api-card-header">';
            html += '<div class="api-icon">üß†</div>';
            html += '<div class="api-info">';
            html += '<h3>OpenAI API</h3>';
            html += '<p>Text optimization</p>';
            html += '</div>';
            html += '</div>';
            html += '<div class="api-key-display">';
            html += '<span class="api-key-value">openai.key = ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>';
            html += '<button class="btn-icon" title="Copy command">üìã</button>';
            html += '</div>';
            html += '<div class="api-stats">';
            html += '<div class="api-stat">';
            html += '<div class="api-stat-value">890</div>';
            html += '<div class="api-stat-label">This Month</div>';
            html += '</div>';
            html += '<div class="api-stat">';
            html += '<div class="api-stat-value">5,000</div>';
            html += '<div class="api-stat-label">Monthly Limit</div>';
            html += '</div>';
            html += '<div class="api-stat">';
            html += '<div class="api-stat-value" style="color: #22c55e;">Active</div>';
            html += '<div class="api-stat-label">Status</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';

            // YouTube API Card
            html += '<div class="api-card">';
            html += '<div class="api-card-header">';
            html += '<div class="api-icon">‚ñ∂Ô∏è</div>';
            html += '<div class="api-info">';
            html += '<h3>YouTube Data API</h3>';
            html += '<p>Video & channel data</p>';
            html += '</div>';
            html += '</div>';
            html += '<div class="api-key-display">';
            html += '<span class="api-key-value">youtube.key = ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>';
            html += '<button class="btn-icon" title="Copy command">üìã</button>';
            html += '</div>';
            html += '<div class="api-stats">';
            html += '<div class="api-stat">';
            html += '<div class="api-stat-value">2,340</div>';
            html += '<div class="api-stat-label">This Month</div>';
            html += '</div>';
            html += '<div class="api-stat">';
            html += '<div class="api-stat-value">50,000</div>';
            html += '<div class="api-stat-label">Monthly Limit</div>';
            html += '</div>';
            html += '<div class="api-stat">';
            html += '<div class="api-stat-value" style="color: #22c55e;">Active</div>';
            html += '<div class="api-stat-label">Status</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';

            html += '</div>';

            // Usage Info
            html += '<div class="card" style="margin-top: 1.5rem;">';
            html += '<h3 class="card-title">üìä API Usage Notes</h3>';
            html += '<ul style="color: rgba(255,255,255,0.7); font-size: 0.9rem; list-style: disc; padding-left: 1.5rem; margin-top: 0.75rem;">';
            html += '<li style="margin-bottom: 0.5rem;">Usage statistics update in real-time from Cloud Functions logs</li>';
            html += '<li style="margin-bottom: 0.5rem;">Monthly limits reset on the 1st of each month</li>';
            html += '<li style="margin-bottom: 0.5rem;">You can monitor detailed usage in the Firebase Console</li>';
            html += '<li>Rate limiting is enforced per-user to prevent abuse</li>';
            html += '</ul>';
            html += '</div>';

            return html;
        }

        // Prompts Management Tab
        function renderPromptsTab() {
            var html = '';

            // Actions Row
            html += '<div class="actions-row">';
            html += '<div class="actions-left">';
            html += '<button onclick="openPromptModal()" class="btn-primary">‚ûï Add New Prompt</button>';
            html += '<button onclick="seedPrompts()" class="btn-secondary" title="Import professional prompts from template">üì• Seed Defaults</button>';
            html += '</div>';
            html += '<div class="actions-right">';
            html += '<span style="color: rgba(255,255,255,0.5); font-size: 0.85rem;">' + state.prompts.length + ' templates</span>';
            html += '</div>';
            html += '</div>';

            // Search Box
            html += '<div class="search-box">';
            html += '<span class="search-icon">üîç</span>';
            html += '<input type="text" class="search-input" placeholder="Search prompts..." value="' + escapeHtml(state.promptSearch) + '" oninput="searchPrompts(this.value)" />';
            html += '</div>';

            // Category Filters
            html += '<div class="category-filters">';
            html += '<button class="category-filter' + (state.promptFilter === 'all' ? ' active' : '') + '" onclick="filterPrompts(\'all\')">All Categories</button>';
            for (var i = 0; i < promptCategoriesConfig.length; i++) {
                var cat = promptCategoriesConfig[i];
                var count = getPromptCountByCategory(cat.key);
                html += '<button class="category-filter' + (state.promptFilter === cat.key ? ' active' : '') + '" onclick="filterPrompts(\'' + cat.key + '\')">';
                html += cat.icon + ' ' + cat.name + ' <span style="opacity: 0.6;">(' + count + ')</span>';
                html += '</button>';
            }
            html += '</div>';

            // Prompts Table
            if (state.promptsLoading) {
                html += '<div style="text-align: center; padding: 3rem;">';
                html += '<div class="spinner" style="margin: 0 auto 1rem;"></div>';
                html += '<p style="color: rgba(255,255,255,0.6);">Loading prompts...</p>';
                html += '</div>';
            } else if (getFilteredPrompts().length === 0) {
                html += '<div class="empty-state">';
                html += '<div class="empty-state-icon">‚ú®</div>';
                html += '<h3>No prompts yet</h3>';
                html += '<p>Create your first prompt template or seed the defaults.</p>';
                html += '<button onclick="seedPrompts()" class="btn-primary" style="margin-top: 0.5rem;">üì• Seed Default Prompts</button>';
                html += '</div>';
            } else {
                html += '<div class="card" style="padding: 0; overflow: hidden;">';
                html += '<table class="prompt-table">';
                html += '<thead>';
                html += '<tr>';
                html += '<th style="width: 8%;">Cover</th>';
                html += '<th style="width: 22%;">Template Name</th>';
                html += '<th style="width: 12%;">Category</th>';
                html += '<th style="width: 28%;">Professional Prompt Preview</th>';
                html += '<th style="width: 6%;">Cost</th>';
                html += '<th style="width: 6%;">Status</th>';
                html += '<th style="width: 18%;">Actions</th>';
                html += '</tr>';
                html += '</thead>';
                html += '<tbody>';

                var filteredPrompts = getFilteredPrompts();
                for (var i = 0; i < filteredPrompts.length; i++) {
                    var prompt = filteredPrompts[i];
                    var catConfig = promptCategoriesConfig.find(function(c) { return c.key === prompt.category; });

                    html += '<tr>';
                    // Cover image thumbnail
                    html += '<td style="padding: 0.5rem;">';
                    html += '<div class="cover-thumbnail">';
                    if (prompt.coverImage) {
                        html += '<img src="' + prompt.coverImage + '" alt="Cover" style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px;">';
                    } else {
                        html += '<div style="width: 50px; height: 50px; background: rgba(139,92,246,0.2); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.4); font-size: 1.2rem;">üñºÔ∏è</div>';
                    }
                    html += '</div>';
                    html += '</td>';
                    html += '<td>';
                    html += '<div style="font-weight: 600; color: white;">' + escapeHtml(prompt.name) + '</div>';
                    html += '<div style="font-size: 0.75rem; color: rgba(255,255,255,0.5);">' + escapeHtml(prompt.description) + '</div>';
                    html += '</td>';
                    html += '<td>';
                    if (catConfig) {
                        html += '<span class="category-badge">' + catConfig.icon + ' ' + catConfig.name + '</span>';
                    }
                    html += '</td>';
                    html += '<td class="prompt-preview">' + escapeHtml(truncateText(prompt.professionalPrompt, 60)) + '</td>';
                    html += '<td style="text-align: center;">ü™ô ' + (prompt.tokenCost || 2) + '</td>';
                    html += '<td>';
                    html += '<span class="status-badge ' + (prompt.isActive !== false ? 'active' : 'inactive') + '">';
                    html += prompt.isActive !== false ? '‚úì Active' : '‚úó Inactive';
                    html += '</span>';
                    html += '</td>';
                    html += '<td>';
                    html += '<div style="display: flex; gap: 0.35rem; flex-wrap: wrap;">';
                    html += '<button class="btn-icon btn-cover" onclick="openCoverModal(\'' + prompt.id + '\')" title="Generate Cover Image">üñºÔ∏è</button>';
                    html += '<button class="btn-icon" onclick="editPrompt(\'' + prompt.id + '\')" title="Edit">‚úèÔ∏è</button>';
                    html += '<button class="btn-icon" onclick="confirmDeletePrompt(\'' + prompt.id + '\', \'' + escapeHtml(prompt.name) + '\')" title="Delete" style="color: #ef4444;">üóëÔ∏è</button>';
                    html += '</div>';
                    html += '</td>';
                    html += '</tr>';
                }

                html += '</tbody>';
                html += '</table>';
                html += '</div>';
            }

            return html;
        }

        // Get prompt count by category
        function getPromptCountByCategory(category) {
            return state.prompts.filter(function(p) { return p.category === category; }).length;
        }

        // Get filtered prompts
        function getFilteredPrompts() {
            var filtered = state.prompts;

            // Filter by category
            if (state.promptFilter !== 'all') {
                filtered = filtered.filter(function(p) { return p.category === state.promptFilter; });
            }

            // Filter by search
            if (state.promptSearch) {
                var search = state.promptSearch.toLowerCase();
                filtered = filtered.filter(function(p) {
                    return (p.name && p.name.toLowerCase().indexOf(search) !== -1) ||
                           (p.description && p.description.toLowerCase().indexOf(search) !== -1) ||
                           (p.professionalPrompt && p.professionalPrompt.toLowerCase().indexOf(search) !== -1);
                });
            }

            return filtered;
        }

        // =============================================
        // TOKEN CONFIGURATION TAB
        // =============================================
        function renderTokenConfigTab() {
            var html = '';

            html += '<div class="card">';
            html += '<h3 class="card-title">ü™ô Token Allocation Per Plan</h3>';
            html += '<p style="color: rgba(255,255,255,0.6); margin-bottom: 1.5rem;">Configure how many tokens each subscription plan receives monthly.</p>';

            if (state.tokenConfigLoading) {
                html += '<div style="text-align: center; padding: 2rem;"><div class="spinner" style="margin: 0 auto;"></div></div>';
            } else {
                var config = state.tokenConfig || { plans: { free: { monthlyTokens: 10, rolloverPercent: 0 }, lite: { monthlyTokens: 50, rolloverPercent: 25 }, pro: { monthlyTokens: 200, rolloverPercent: 50 }, enterprise: { monthlyTokens: 1000, rolloverPercent: 100 } } };

                html += '<div class="grid-2">';

                var planOrder = ['free', 'lite', 'pro', 'enterprise'];
                var planNames = { free: 'Free', lite: 'Lite', pro: 'Pro', enterprise: 'Enterprise' };
                var planColors = { free: '#9ca3af', lite: '#60a5fa', pro: '#a78bfa', enterprise: '#fbbf24' };

                for (var i = 0; i < planOrder.length; i++) {
                    var planId = planOrder[i];
                    var planConfig = config.plans[planId] || { monthlyTokens: 0, rolloverPercent: 0 };
                    var edited = state.editedTokenConfig[planId] || {};

                    html += '<div class="card" style="border-left: 4px solid ' + planColors[planId] + ';">';
                    html += '<h4 style="color: white; margin-bottom: 1rem;">' + planNames[planId] + ' Plan</h4>';

                    html += '<div style="margin-bottom: 1rem;">';
                    html += '<label class="input-label">Monthly Tokens</label>';
                    html += '<input type="number" class="input-field" value="' + (edited.monthlyTokens !== undefined ? edited.monthlyTokens : planConfig.monthlyTokens) + '" ';
                    html += 'onchange="updateTokenConfig(\'' + planId + '\', \'monthlyTokens\', this.value)" min="0" />';
                    html += '</div>';

                    html += '<div>';
                    html += '<label class="input-label">Rollover %</label>';
                    html += '<input type="number" class="input-field" value="' + (edited.rolloverPercent !== undefined ? edited.rolloverPercent : planConfig.rolloverPercent) + '" ';
                    html += 'onchange="updateTokenConfig(\'' + planId + '\', \'rolloverPercent\', this.value)" min="0" max="100" />';
                    html += '<p style="font-size: 0.75rem; color: rgba(255,255,255,0.4); margin-top: 0.25rem;">% of unused tokens that carry over to next month</p>';
                    html += '</div>';

                    html += '</div>';
                }

                html += '</div>';

                html += '<div style="margin-top: 1.5rem; text-align: right;">';
                html += '<button onclick="saveTokenConfig()" class="btn-primary">üíæ Save Token Configuration</button>';
                html += '</div>';
            }

            html += '</div>';

            // Manual Token Adjustment Section
            html += '<div class="card" style="margin-top: 1.5rem;">';
            html += '<h3 class="card-title">‚ûï Manual Token Adjustment</h3>';
            html += '<p style="color: rgba(255,255,255,0.6); margin-bottom: 1.5rem;">Add or remove tokens from a specific user.</p>';

            html += '<div class="grid-2">';

            html += '<div>';
            html += '<label class="input-label">Select User</label>';
            html += '<select id="token-user-select" class="select-field">';
            html += '<option value="">-- Select a user --</option>';
            if (state.adminUsers) {
                for (var j = 0; j < state.adminUsers.length; j++) {
                    var u = state.adminUsers[j];
                    var tokenBal = u.tokens ? u.tokens.balance : 0;
                    html += '<option value="' + u.uid + '">' + escapeHtml(u.email || u.uid) + ' (' + tokenBal + ' tokens)</option>';
                }
            }
            html += '</select>';
            html += '</div>';

            html += '<div>';
            html += '<label class="input-label">Amount (+/- tokens)</label>';
            html += '<input type="number" id="token-amount-input" class="input-field" placeholder="e.g., 50 or -10" />';
            html += '</div>';

            html += '</div>';

            html += '<div style="margin-top: 1rem;">';
            html += '<label class="input-label">Reason (optional)</label>';
            html += '<input type="text" id="token-reason-input" class="input-field" placeholder="e.g., Bonus for feedback, Refund, etc." />';
            html += '</div>';

            html += '<div style="margin-top: 1rem;">';
            html += '<button onclick="adjustUserTokens()" class="btn-primary" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">üí∞ Adjust Tokens</button>';
            html += '</div>';

            html += '</div>';

            return html;
        }

        // =============================================
        // PRICING TAB (API Costs & Markup)
        // =============================================
        function renderPricingTab() {
            var html = '';

            html += '<div class="card">';
            html += '<h3 class="card-title">üí∞ API Cost & Profit Control</h3>';
            html += '<p style="color: rgba(255,255,255,0.6); margin-bottom: 1.5rem;">Configure the token cost for each module and set your markup percentage.</p>';

            if (state.apiCostsLoading) {
                html += '<div style="text-align: center; padding: 2rem;"><div class="spinner" style="margin: 0 auto;"></div></div>';
            } else {
                var costs = state.apiCosts || { modules: {} };
                var modules = costs.modules || {};

                html += '<div style="overflow-x: auto;">';
                html += '<table class="prompt-table">';
                html += '<thead><tr>';
                html += '<th>Module</th>';
                html += '<th>Provider</th>';
                html += '<th>API Cost (USD)</th>';
                html += '<th>Token Cost</th>';
                html += '<th>Markup %</th>';
                html += '<th>Est. Profit</th>';
                html += '</tr></thead>';
                html += '<tbody>';

                var moduleIds = ['warpOptimizer', 'competitorAnalysis', 'trendPredictor', 'thumbnailGenerator', 'channelAudit'];

                for (var i = 0; i < moduleIds.length; i++) {
                    var moduleId = moduleIds[i];
                    var mod = modules[moduleId] || { name: moduleId, provider: 'Unknown', estimatedCostUSD: 0, tokenCost: 5, markupPercent: 100 };
                    var edited = state.editedApiCosts[moduleId] || {};

                    var apiCost = edited.estimatedCostUSD !== undefined ? edited.estimatedCostUSD : mod.estimatedCostUSD;
                    var tokenCost = edited.tokenCost !== undefined ? edited.tokenCost : mod.tokenCost;
                    var markup = edited.markupPercent !== undefined ? edited.markupPercent : mod.markupPercent;

                    // Calculate profit per token (assuming $0.01 per token as base price)
                    var tokenValue = tokenCost * 0.01 * (markup / 100);
                    var profit = tokenValue - apiCost;
                    var profitColor = profit >= 0 ? '#10b981' : '#ef4444';

                    html += '<tr>';
                    html += '<td><strong style="color: white;">' + escapeHtml(mod.name) + '</strong></td>';
                    html += '<td style="color: rgba(255,255,255,0.7);">' + escapeHtml(mod.provider || 'Unknown') + '</td>';
                    html += '<td>';
                    html += '<input type="number" class="input-field" style="width: 100px;" step="0.001" value="' + apiCost + '" ';
                    html += 'onchange="updateApiCost(\'' + moduleId + '\', \'estimatedCostUSD\', this.value)" />';
                    html += '</td>';
                    html += '<td>';
                    html += '<input type="number" class="input-field" style="width: 80px;" value="' + tokenCost + '" ';
                    html += 'onchange="updateApiCost(\'' + moduleId + '\', \'tokenCost\', this.value)" min="1" />';
                    html += '</td>';
                    html += '<td>';
                    html += '<input type="number" class="input-field" style="width: 80px;" value="' + markup + '" ';
                    html += 'onchange="updateApiCost(\'' + moduleId + '\', \'markupPercent\', this.value)" min="0" />%';
                    html += '</td>';
                    html += '<td style="color: ' + profitColor + '; font-weight: 600;">$' + profit.toFixed(3) + '</td>';
                    html += '</tr>';
                }

                html += '</tbody></table>';
                html += '</div>';

                html += '<div style="margin-top: 1.5rem; display: flex; justify-content: space-between; align-items: center;">';
                html += '<p style="font-size: 0.85rem; color: rgba(255,255,255,0.5);">Profit = (Token Cost √ó $0.01 √ó Markup%) - API Cost</p>';
                html += '<button onclick="saveApiCosts()" class="btn-primary">üíæ Save Pricing</button>';
                html += '</div>';
            }

            html += '</div>';

            return html;
        }

        // =============================================
        // PROMO CODES TAB
        // =============================================
        function renderPromoCodesTab() {
            var html = '';

            // Create New Promo Code
            html += '<div class="card">';
            html += '<h3 class="card-title">üéÅ Create Promo Code</h3>';

            html += '<div class="grid-2" style="margin-bottom: 1rem;">';

            html += '<div>';
            html += '<label class="input-label">Code</label>';
            html += '<input type="text" id="promo-code-input" class="input-field" placeholder="e.g., WELCOME50" style="text-transform: uppercase;" />';
            html += '</div>';

            html += '<div>';
            html += '<label class="input-label">Token Amount</label>';
            html += '<input type="number" id="promo-tokens-input" class="input-field" value="10" min="1" />';
            html += '</div>';

            html += '<div>';
            html += '<label class="input-label">Max Uses (0 = unlimited)</label>';
            html += '<input type="number" id="promo-maxuses-input" class="input-field" value="0" min="0" />';
            html += '</div>';

            html += '<div>';
            html += '<label class="input-label">Expires At (optional)</label>';
            html += '<input type="date" id="promo-expires-input" class="input-field" />';
            html += '</div>';

            html += '</div>';

            html += '<div style="margin-bottom: 1rem;">';
            html += '<label class="input-label">Description (optional)</label>';
            html += '<input type="text" id="promo-desc-input" class="input-field" placeholder="e.g., Welcome bonus for new users" />';
            html += '</div>';

            html += '<button onclick="createPromoCode()" class="btn-primary">‚ûï Create Promo Code</button>';
            html += '</div>';

            // Existing Promo Codes
            html += '<div class="card" style="margin-top: 1.5rem;">';
            html += '<h3 class="card-title">üìã Existing Promo Codes</h3>';

            if (state.promoCodesLoading) {
                html += '<div style="text-align: center; padding: 2rem;"><div class="spinner" style="margin: 0 auto;"></div></div>';
            } else if (!state.promoCodes || state.promoCodes.length === 0) {
                html += '<p style="color: rgba(255,255,255,0.5); text-align: center; padding: 2rem;">No promo codes created yet</p>';
            } else {
                html += '<div style="overflow-x: auto;">';
                html += '<table class="prompt-table">';
                html += '<thead><tr>';
                html += '<th>Code</th>';
                html += '<th>Tokens</th>';
                html += '<th>Usage</th>';
                html += '<th>Expires</th>';
                html += '<th>Status</th>';
                html += '<th>Actions</th>';
                html += '</tr></thead>';
                html += '<tbody>';

                for (var i = 0; i < state.promoCodes.length; i++) {
                    var code = state.promoCodes[i];
                    var isExpired = code.expiresAt && code.expiresAt < Date.now();
                    var statusColor = code.isActive && !isExpired ? '#10b981' : '#ef4444';
                    var statusText = !code.isActive ? 'Disabled' : (isExpired ? 'Expired' : 'Active');

                    html += '<tr>';
                    html += '<td><code style="background: rgba(139,92,246,0.2); padding: 0.25rem 0.5rem; border-radius: 4px; color: #a78bfa;">' + escapeHtml(code.code) + '</code></td>';
                    html += '<td style="color: white; font-weight: 600;">' + code.tokenAmount + '</td>';
                    html += '<td>' + code.usedCount + (code.maxUses > 0 ? '/' + code.maxUses : '/‚àû') + '</td>';
                    html += '<td style="color: rgba(255,255,255,0.6);">' + (code.expiresAt ? new Date(code.expiresAt).toLocaleDateString() : 'Never') + '</td>';
                    html += '<td><span style="color: ' + statusColor + ';">‚óè ' + statusText + '</span></td>';
                    html += '<td>';
                    if (code.isActive) {
                        html += '<button onclick="togglePromoCode(\'' + code.code + '\', false)" class="btn-icon" title="Disable" style="color: #ef4444;">‚è∏Ô∏è</button>';
                    } else {
                        html += '<button onclick="togglePromoCode(\'' + code.code + '\', true)" class="btn-icon" title="Enable" style="color: #10b981;">‚ñ∂Ô∏è</button>';
                    }
                    html += '</td>';
                    html += '</tr>';
                }

                html += '</tbody></table>';
                html += '</div>';
            }

            html += '</div>';

            return html;
        }

        // =============================================
        // ANALYTICS TAB
        // =============================================
        function renderAnalyticsTab() {
            var html = '';

            // Period Selector
            html += '<div class="card">';
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">';
            html += '<h3 class="card-title" style="margin: 0;">üìä Revenue & Usage Analytics</h3>';
            html += '<div style="display: flex; gap: 0.5rem;">';
            html += '<button onclick="setAnalyticsPeriod(\'7d\')" class="' + (state.analyticsPeriod === '7d' ? 'btn-primary' : 'btn-secondary') + '" style="padding: 0.5rem 1rem;">7 Days</button>';
            html += '<button onclick="setAnalyticsPeriod(\'30d\')" class="' + (state.analyticsPeriod === '30d' ? 'btn-primary' : 'btn-secondary') + '" style="padding: 0.5rem 1rem;">30 Days</button>';
            html += '<button onclick="setAnalyticsPeriod(\'90d\')" class="' + (state.analyticsPeriod === '90d' ? 'btn-primary' : 'btn-secondary') + '" style="padding: 0.5rem 1rem;">90 Days</button>';
            html += '</div>';
            html += '</div>';

            if (state.analyticsLoading) {
                html += '<div style="text-align: center; padding: 3rem;"><div class="spinner" style="margin: 0 auto;"></div></div>';
            } else if (!state.analytics) {
                html += '<p style="color: rgba(255,255,255,0.5); text-align: center; padding: 2rem;">Click a period to load analytics</p>';
            } else {
                var a = state.analytics;

                // Revenue Summary
                html += '<div class="stats-grid">';

                html += '<div class="stat-card stat-highlight">';
                html += '<div class="stat-icon">üíµ</div>';
                html += '<div class="stat-value">$' + (a.revenue?.estimatedMonthly || 0).toFixed(2) + '</div>';
                html += '<div class="stat-label">Est. Monthly Revenue</div>';
                html += '</div>';

                html += '<div class="stat-card">';
                html += '<div class="stat-icon">üìâ</div>';
                html += '<div class="stat-value">$' + (a.costs?.estimatedApiCost || 0).toFixed(2) + '</div>';
                html += '<div class="stat-label">API Costs (' + state.analyticsPeriod + ')</div>';
                html += '</div>';

                html += '<div class="stat-card">';
                html += '<div class="stat-icon">üìà</div>';
                html += '<div class="stat-value">' + (a.revenue?.profitMargin || 0).toFixed(1) + '%</div>';
                html += '<div class="stat-label">Profit Margin</div>';
                html += '</div>';

                html += '<div class="stat-card">';
                html += '<div class="stat-icon">‚ö°</div>';
                html += '<div class="stat-value">' + (a.usage?.totalCalls || 0) + '</div>';
                html += '<div class="stat-label">API Calls (' + state.analyticsPeriod + ')</div>';
                html += '</div>';

                html += '</div>';

                // User Distribution
                html += '<div class="grid-2" style="margin-top: 1.5rem;">';

                html += '<div class="card">';
                html += '<h4 style="color: white; margin-bottom: 1rem;">üë• User Distribution</h4>';
                var users = a.users || { total: 0, paid: 0, byPlan: {} };
                html += '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';

                var planNames = { free: 'Free', lite: 'Lite', pro: 'Pro', enterprise: 'Enterprise' };
                var planColors = { free: '#9ca3af', lite: '#60a5fa', pro: '#a78bfa', enterprise: '#fbbf24' };

                for (var plan in planNames) {
                    var count = users.byPlan[plan] || 0;
                    var pct = users.total > 0 ? Math.round(count / users.total * 100) : 0;
                    html += '<div>';
                    html += '<div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">';
                    html += '<span style="color: ' + planColors[plan] + ';">' + planNames[plan] + '</span>';
                    html += '<span style="color: white;">' + count + ' (' + pct + '%)</span>';
                    html += '</div>';
                    html += '<div style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">';
                    html += '<div style="width: ' + pct + '%; height: 100%; background: ' + planColors[plan] + ';"></div>';
                    html += '</div>';
                    html += '</div>';
                }

                html += '</div>';
                html += '</div>';

                html += '<div class="card">';
                html += '<h4 style="color: white; margin-bottom: 1rem;">üìä Usage by Module</h4>';
                var usage = a.usage?.byModule || {};
                html += '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';

                var totalUsage = Object.values(usage).reduce(function(sum, v) { return sum + v; }, 0);

                var modNames = { warpOptimizer: 'Warp Optimizer', competitorAnalysis: 'Competitor Analysis', trendPredictor: 'Trend Predictor', thumbnailGenerator: 'AI Thumbnails', channelAudit: 'Channel Audit' };

                for (var mod in modNames) {
                    var modCount = usage[mod] || 0;
                    var modPct = totalUsage > 0 ? Math.round(modCount / totalUsage * 100) : 0;
                    html += '<div>';
                    html += '<div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">';
                    html += '<span style="color: rgba(255,255,255,0.7);">' + modNames[mod] + '</span>';
                    html += '<span style="color: white;">' + modCount + '</span>';
                    html += '</div>';
                    html += '<div style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">';
                    html += '<div style="width: ' + modPct + '%; height: 100%; background: #8b5cf6;"></div>';
                    html += '</div>';
                    html += '</div>';
                }

                html += '</div>';
                html += '</div>';

                html += '</div>';
            }

            html += '</div>';

            return html;
        }

        // =============================================
        // TRANSACTIONS TAB
        // =============================================
        function renderTransactionsTab() {
            var html = '';

            html += '<div class="card">';
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">';
            html += '<h3 class="card-title" style="margin: 0;">üìú Token Transaction History</h3>';
            html += '<button onclick="loadTransactions()" class="btn-secondary">‚Üª Refresh</button>';
            html += '</div>';

            if (state.transactionsLoading) {
                html += '<div style="text-align: center; padding: 3rem;"><div class="spinner" style="margin: 0 auto;"></div></div>';
            } else if (!state.transactions || state.transactions.length === 0) {
                html += '<p style="color: rgba(255,255,255,0.5); text-align: center; padding: 2rem;">No transactions yet</p>';
            } else {
                html += '<div style="overflow-x: auto;">';
                html += '<table class="prompt-table">';
                html += '<thead><tr>';
                html += '<th>Date</th>';
                html += '<th>User</th>';
                html += '<th>Type</th>';
                html += '<th>Amount</th>';
                html += '<th>Balance After</th>';
                html += '<th>Reason</th>';
                html += '</tr></thead>';
                html += '<tbody>';

                for (var i = 0; i < state.transactions.length; i++) {
                    var tx = state.transactions[i];
                    var typeColors = {
                        admin_credit: '#10b981',
                        admin_debit: '#ef4444',
                        promo_redemption: '#8b5cf6',
                        usage: '#f59e0b',
                        refill: '#3b82f6'
                    };
                    var typeLabels = {
                        admin_credit: 'Admin Credit',
                        admin_debit: 'Admin Debit',
                        promo_redemption: 'Promo Code',
                        usage: 'Usage',
                        refill: 'Monthly Refill'
                    };

                    html += '<tr>';
                    html += '<td style="color: rgba(255,255,255,0.6);">' + new Date(tx.createdAt).toLocaleString() + '</td>';
                    html += '<td style="color: white;">' + escapeHtml(tx.userEmail || 'Unknown') + '</td>';
                    html += '<td><span style="color: ' + (typeColors[tx.type] || '#fff') + ';">' + (typeLabels[tx.type] || tx.type) + '</span></td>';
                    html += '<td style="color: ' + (tx.amount >= 0 ? '#10b981' : '#ef4444') + '; font-weight: 600;">' + (tx.amount >= 0 ? '+' : '') + tx.amount + '</td>';
                    html += '<td style="color: white;">' + tx.balanceAfter + '</td>';
                    html += '<td style="color: rgba(255,255,255,0.6); max-width: 200px; overflow: hidden; text-overflow: ellipsis;">' + escapeHtml(tx.reason || '-') + '</td>';
                    html += '</tr>';
                }

                html += '</tbody></table>';
                html += '</div>';
            }

            html += '</div>';

            return html;
        }

        // Tab Navigation
        function setActiveTab(tab) {
            state.activeTab = tab;
            render();

            // Load data if needed
            if (tab === 'users' && state.adminUsers.length === 0) {
                loadUsers();
            } else if (tab === 'plans' && state.plans.length === 0) {
                loadPlans();
            } else if (tab === 'prompts' && state.prompts.length === 0) {
                loadPrompts();
            } else if (tab === 'tokenConfig' && !state.tokenConfig) {
                loadTokenConfig();
                if (state.adminUsers.length === 0) loadUsers(); // Need users for dropdown
            } else if (tab === 'pricing' && !state.apiCosts) {
                loadApiCosts();
            } else if (tab === 'promoCodes' && state.promoCodes.length === 0) {
                loadPromoCodes();
            } else if (tab === 'analytics' && !state.analytics) {
                loadAnalytics();
            } else if (tab === 'transactions' && state.transactions.length === 0) {
                loadTransactions();
            }
        }

        // =============================================
        // USER MANAGEMENT FUNCTIONS
        // =============================================

        function loadUsers() {
            state.usersLoading = true;
            render();

            db.collection('users')
                .get()
                .then(function(snapshot) {
                    state.adminUsers = [];
                    snapshot.forEach(function(doc) {
                        state.adminUsers.push({ uid: doc.id, ...doc.data() });
                    });
                    state.usersLoading = false;
                    render();
                })
                .catch(function(error) {
                    console.error('Error loading users:', error);
                    state.usersLoading = false;
                    showToast('Failed to load users', 'error');
                    render();
                });

            // Also load quota reset time
            loadQuotaResetTime();
        }

        function loadQuotaResetTime() {
            db.collection('settings').doc('quotaSettings').get()
                .then(function(doc) {
                    if (doc.exists && doc.data().resetTimeMinutes) {
                        state.resetTimeMinutes = doc.data().resetTimeMinutes;
                        render();
                    }
                })
                .catch(function(error) {
                    console.error('Error loading quota settings:', error);
                });
        }

        function updateUserPlan(uid, newPlan) {
            var adminUpdateUserPlan = functions.httpsCallable('adminUpdateUserPlan');

            adminUpdateUserPlan({ userId: uid, plan: newPlan })
                .then(function(result) {
                    showToast('User plan updated to ' + newPlan.toUpperCase(), 'success');
                    loadUsers(); // Refresh the list
                })
                .catch(function(error) {
                    console.error('Error updating plan:', error);
                    showToast('Failed to update plan: ' + error.message, 'error');
                });
        }

        function setQuotaResetTime() {
            var input = document.getElementById('reset-time-input');
            var minutes = parseInt(input.value, 10);

            if (isNaN(minutes) || minutes < 1) {
                showToast('Please enter a valid number of minutes (minimum 1)', 'error');
                return;
            }

            var adminSetQuotaSettings = functions.httpsCallable('adminSetQuotaSettings');

            adminSetQuotaSettings({ resetTimeMinutes: minutes })
                .then(function(result) {
                    state.resetTimeMinutes = minutes;
                    showToast('Quota reset time updated to ' + minutes + ' minutes', 'success');
                    render();
                })
                .catch(function(error) {
                    console.error('Error setting quota reset time:', error);
                    showToast('Failed to update: ' + error.message, 'error');
                });
        }

        function grantBonusUses() {
            var userSelect = document.getElementById('bonus-user-select');
            var toolSelect = document.getElementById('bonus-tool-select');
            var amountInput = document.getElementById('bonus-amount-input');

            var uid = userSelect.value;
            var tool = toolSelect.value;
            var amount = parseInt(amountInput.value, 10);

            if (!uid) {
                showToast('Please select a user', 'error');
                return;
            }
            if (isNaN(amount) || amount < 1) {
                showToast('Please enter a valid amount (minimum 1)', 'error');
                return;
            }

            var adminGrantBonusUses = functions.httpsCallable('adminGrantBonusUses');

            adminGrantBonusUses({ userId: uid, tool: tool, bonusAmount: amount })
                .then(function(result) {
                    var toolName = toolConfig[tool] ? toolConfig[tool].name : tool;
                    showToast('Granted ' + amount + ' bonus uses for ' + toolName, 'success');
                    loadUsers(); // Refresh to show new bonus
                })
                .catch(function(error) {
                    console.error('Error granting bonus:', error);
                    showToast('Failed to grant bonus: ' + error.message, 'error');
                });
        }

        // =============================================
        // TOKEN CONFIGURATION FUNCTIONS
        // =============================================

        function loadTokenConfig() {
            state.tokenConfigLoading = true;
            render();

            functions.httpsCallable('adminGetTokenConfig')()
                .then(function(result) {
                    state.tokenConfig = result.data.config;
                    state.editedTokenConfig = {};
                    state.tokenConfigLoading = false;
                    render();
                })
                .catch(function(error) {
                    console.error('Error loading token config:', error);
                    state.tokenConfigLoading = false;
                    showToast('Failed to load token configuration', 'error');
                    render();
                });
        }

        function updateTokenConfig(planId, field, value) {
            if (!state.editedTokenConfig[planId]) {
                state.editedTokenConfig[planId] = {};
            }
            state.editedTokenConfig[planId][field] = parseInt(value) || 0;
            render();
        }

        function saveTokenConfig() {
            var plans = {};
            var planOrder = ['free', 'lite', 'pro', 'enterprise'];

            for (var i = 0; i < planOrder.length; i++) {
                var planId = planOrder[i];
                var current = state.tokenConfig?.plans?.[planId] || { monthlyTokens: 0, rolloverPercent: 0 };
                var edited = state.editedTokenConfig[planId] || {};

                plans[planId] = {
                    monthlyTokens: edited.monthlyTokens !== undefined ? edited.monthlyTokens : current.monthlyTokens,
                    rolloverPercent: edited.rolloverPercent !== undefined ? edited.rolloverPercent : current.rolloverPercent
                };
            }

            functions.httpsCallable('adminUpdateTokenConfig')({ plans: plans })
                .then(function(result) {
                    showToast('Token configuration saved successfully', 'success');
                    loadTokenConfig();
                })
                .catch(function(error) {
                    console.error('Error saving token config:', error);
                    showToast('Failed to save: ' + error.message, 'error');
                });
        }

        function adjustUserTokens() {
            var userId = document.getElementById('token-user-select').value;
            var amount = parseInt(document.getElementById('token-amount-input').value, 10);
            var reason = document.getElementById('token-reason-input').value;

            if (!userId) {
                showToast('Please select a user', 'error');
                return;
            }
            if (isNaN(amount) || amount === 0) {
                showToast('Please enter a valid token amount', 'error');
                return;
            }

            functions.httpsCallable('adminAdjustUserTokens')({ userId: userId, amount: amount, reason: reason })
                .then(function(result) {
                    showToast(result.data.message, 'success');
                    document.getElementById('token-amount-input').value = '';
                    document.getElementById('token-reason-input').value = '';
                    loadUsers();
                })
                .catch(function(error) {
                    console.error('Error adjusting tokens:', error);
                    showToast('Failed: ' + error.message, 'error');
                });
        }

        // =============================================
        // API COSTS / PRICING FUNCTIONS
        // =============================================

        function loadApiCosts() {
            state.apiCostsLoading = true;
            render();

            functions.httpsCallable('adminGetApiCosts')()
                .then(function(result) {
                    state.apiCosts = result.data.costs;
                    state.editedApiCosts = {};
                    state.apiCostsLoading = false;
                    render();
                })
                .catch(function(error) {
                    console.error('Error loading API costs:', error);
                    state.apiCostsLoading = false;
                    showToast('Failed to load API costs', 'error');
                    render();
                });
        }

        function updateApiCost(moduleId, field, value) {
            if (!state.editedApiCosts[moduleId]) {
                state.editedApiCosts[moduleId] = {};
            }
            if (field === 'estimatedCostUSD') {
                state.editedApiCosts[moduleId][field] = parseFloat(value) || 0;
            } else {
                state.editedApiCosts[moduleId][field] = parseInt(value) || 0;
            }
            render();
        }

        function saveApiCosts() {
            var modules = {};
            var moduleIds = ['warpOptimizer', 'competitorAnalysis', 'trendPredictor', 'thumbnailGenerator', 'channelAudit'];

            for (var i = 0; i < moduleIds.length; i++) {
                var moduleId = moduleIds[i];
                var current = state.apiCosts?.modules?.[moduleId] || {};
                var edited = state.editedApiCosts[moduleId] || {};

                modules[moduleId] = {
                    name: current.name || moduleId,
                    provider: current.provider || 'Unknown',
                    apiModel: current.apiModel || 'Unknown',
                    estimatedCostUSD: edited.estimatedCostUSD !== undefined ? edited.estimatedCostUSD : current.estimatedCostUSD,
                    tokenCost: edited.tokenCost !== undefined ? edited.tokenCost : current.tokenCost,
                    markupPercent: edited.markupPercent !== undefined ? edited.markupPercent : current.markupPercent
                };
            }

            functions.httpsCallable('adminUpdateApiCosts')({ modules: modules })
                .then(function(result) {
                    showToast('API pricing saved successfully', 'success');
                    loadApiCosts();
                })
                .catch(function(error) {
                    console.error('Error saving API costs:', error);
                    showToast('Failed to save: ' + error.message, 'error');
                });
        }

        // =============================================
        // PROMO CODES FUNCTIONS
        // =============================================

        function loadPromoCodes() {
            state.promoCodesLoading = true;
            render();

            functions.httpsCallable('adminGetPromoCodes')()
                .then(function(result) {
                    state.promoCodes = result.data.codes || [];
                    state.promoCodesLoading = false;
                    render();
                })
                .catch(function(error) {
                    console.error('Error loading promo codes:', error);
                    state.promoCodesLoading = false;
                    showToast('Failed to load promo codes', 'error');
                    render();
                });
        }

        function createPromoCode() {
            var code = document.getElementById('promo-code-input').value.trim().toUpperCase();
            var tokenAmount = parseInt(document.getElementById('promo-tokens-input').value, 10);
            var maxUses = parseInt(document.getElementById('promo-maxuses-input').value, 10) || 0;
            var expiresAt = document.getElementById('promo-expires-input').value;
            var description = document.getElementById('promo-desc-input').value.trim();

            if (!code || code.length < 3) {
                showToast('Code must be at least 3 characters', 'error');
                return;
            }
            if (isNaN(tokenAmount) || tokenAmount < 1) {
                showToast('Token amount must be at least 1', 'error');
                return;
            }

            functions.httpsCallable('adminCreatePromoCode')({
                code: code,
                tokenAmount: tokenAmount,
                maxUses: maxUses,
                expiresAt: expiresAt || null,
                description: description
            })
                .then(function(result) {
                    showToast(result.data.message, 'success');
                    document.getElementById('promo-code-input').value = '';
                    document.getElementById('promo-tokens-input').value = '10';
                    document.getElementById('promo-maxuses-input').value = '0';
                    document.getElementById('promo-expires-input').value = '';
                    document.getElementById('promo-desc-input').value = '';
                    loadPromoCodes();
                })
                .catch(function(error) {
                    console.error('Error creating promo code:', error);
                    showToast('Failed: ' + error.message, 'error');
                });
        }

        function togglePromoCode(code, isActive) {
            functions.httpsCallable('adminTogglePromoCode')({ code: code, isActive: isActive })
                .then(function(result) {
                    showToast(result.data.message, 'success');
                    loadPromoCodes();
                })
                .catch(function(error) {
                    console.error('Error toggling promo code:', error);
                    showToast('Failed: ' + error.message, 'error');
                });
        }

        // =============================================
        // ANALYTICS FUNCTIONS
        // =============================================

        function loadAnalytics() {
            state.analyticsLoading = true;
            render();

            functions.httpsCallable('adminGetAnalytics')({ period: state.analyticsPeriod })
                .then(function(result) {
                    state.analytics = result.data.analytics;
                    state.analyticsLoading = false;
                    render();
                })
                .catch(function(error) {
                    console.error('Error loading analytics:', error);
                    state.analyticsLoading = false;
                    showToast('Failed to load analytics', 'error');
                    render();
                });
        }

        function setAnalyticsPeriod(period) {
            state.analyticsPeriod = period;
            state.analytics = null;
            loadAnalytics();
        }

        // =============================================
        // TRANSACTIONS FUNCTIONS
        // =============================================

        function loadTransactions() {
            state.transactionsLoading = true;
            render();

            functions.httpsCallable('adminGetTokenTransactions')({ limit: 100 })
                .then(function(result) {
                    state.transactions = result.data.transactions || [];
                    state.transactionsLoading = false;
                    render();
                })
                .catch(function(error) {
                    console.error('Error loading transactions:', error);
                    state.transactionsLoading = false;
                    showToast('Failed to load transactions', 'error');
                    render();
                });
        }

        // Data Functions - Plans
        function getEditedLimit(planId, tool) {
            if (state.editedPlans[planId] && state.editedPlans[planId][tool] !== undefined) {
                return state.editedPlans[planId][tool];
            }
            return null;
        }

        function updateLimit(planId, tool, value) {
            if (!state.editedPlans[planId]) {
                state.editedPlans[planId] = {};
            }
            state.editedPlans[planId][tool] = parseInt(value) || 0;
            render();
        }

        function loadPlans() {
            state.loading = true;
            render();

            functions.httpsCallable('adminGetPlanSettings')()
                .then(function(result) {
                    state.plans = result.data.plans || [];
                    state.editedPlans = {};
                    state.loading = false;
                    render();
                })
                .catch(function(error) {
                    console.error('Error loading plans:', error);
                    state.loading = false;
                    showToast('Failed to load plans: ' + error.message, 'error');
                });
        }

        function savePlanLimits(planId) {
            var edited = state.editedPlans[planId];
            if (!edited) return;

            var plan = state.plans.find(function(p) { return p.id === planId; });
            var limits = {};

            Object.keys(toolConfig).forEach(function(tool) {
                var newLimit = edited[tool];
                var currentLimit = plan && plan.limits && plan.limits[tool] ? plan.limits[tool].dailyLimit : 0;
                limits[tool] = {
                    dailyLimit: newLimit !== undefined ? newLimit : currentLimit,
                    cooldownHours: plan && plan.limits && plan.limits[tool] ? plan.limits[tool].cooldownHours : 0
                };
            });

            state.saving[planId] = true;
            render();

            functions.httpsCallable('adminUpdatePlanLimits')({
                planId: planId,
                limits: limits
            })
                .then(function(result) {
                    state.saving[planId] = false;
                    delete state.editedPlans[planId];
                    loadPlans();
                    showToast('Plan "' + planId + '" limits updated successfully!', 'success');
                })
                .catch(function(error) {
                    console.error('Error saving plan:', error);
                    state.saving[planId] = false;
                    render();
                    showToast('Failed to save: ' + error.message, 'error');
                });
        }

        function confirmSyncUsers(planId) {
            state.confirmModal = {
                icon: 'üîÑ',
                title: 'Sync Users',
                message: 'This will update the limits for all existing users on the "' + planId + '" plan. Continue?',
                confirmText: 'Sync Users',
                confirmAction: 'syncUsers(\'' + planId + '\')'
            };
            render();
        }

        function closeConfirmModal() {
            state.confirmModal = null;
            render();
        }

        function syncUsers(planId) {
            closeConfirmModal();
            state.syncing[planId] = true;
            render();

            functions.httpsCallable('adminSyncExistingUsers')({ planId: planId })
                .then(function(result) {
                    state.syncing[planId] = false;
                    render();
                    showToast(result.data.message, 'success');
                })
                .catch(function(error) {
                    console.error('Error syncing users:', error);
                    state.syncing[planId] = false;
                    render();
                    showToast('Failed to sync: ' + error.message, 'error');
                });
        }

        // Data Functions - Prompts
        function loadPrompts() {
            state.promptsLoading = true;
            render();

            // Simple query without composite index requirement
            db.collection('promptTemplates')
                .get()
                .then(function(snapshot) {
                    state.prompts = [];
                    snapshot.forEach(function(doc) {
                        state.prompts.push({ id: doc.id, ...doc.data() });
                    });
                    // Sort in JavaScript: by category, then by name
                    state.prompts.sort(function(a, b) {
                        var catCompare = (a.category || '').localeCompare(b.category || '');
                        if (catCompare !== 0) return catCompare;
                        return (a.name || '').localeCompare(b.name || '');
                    });
                    state.promptsLoading = false;
                    render();
                })
                .catch(function(error) {
                    console.error('Error loading prompts:', error);
                    state.promptsLoading = false;
                    showToast('Failed to load prompts', 'error');
                });
        }

        function filterPrompts(category) {
            state.promptFilter = category;
            render();
        }

        function searchPrompts(query) {
            state.promptSearch = query;
            render();
        }

        function openPromptModal(prompt) {
            state.editingPrompt = prompt || {};
            state.promptModal = true;
            render();
        }

        function closePromptModal() {
            state.editingPrompt = null;
            state.promptModal = false;
            render();
        }

        function editPrompt(promptId) {
            var prompt = state.prompts.find(function(p) { return p.id === promptId; });
            if (prompt) {
                openPromptModal(prompt);
            }
        }

        function savePrompt(event) {
            event.preventDefault();

            var promptData = {
                name: document.getElementById('prompt-name').value.trim(),
                category: document.getElementById('prompt-category').value,
                description: document.getElementById('prompt-description').value.trim(),
                userPrompt: document.getElementById('prompt-user').value.trim(),
                professionalPrompt: document.getElementById('prompt-professional').value.trim(),
                tokenCost: parseInt(document.getElementById('prompt-cost').value) || 2,
                isActive: document.getElementById('prompt-status').value === 'active',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            var isNew = !state.editingPrompt.id;
            var docRef;

            if (isNew) {
                promptData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                docRef = db.collection('promptTemplates').doc();
            } else {
                docRef = db.collection('promptTemplates').doc(state.editingPrompt.id);
            }

            docRef.set(promptData, { merge: true })
                .then(function() {
                    closePromptModal();
                    loadPrompts();
                    showToast(isNew ? 'Prompt template created!' : 'Prompt template updated!', 'success');
                })
                .catch(function(error) {
                    console.error('Error saving prompt:', error);
                    showToast('Failed to save prompt', 'error');
                });
        }

        function confirmDeletePrompt(promptId, promptName) {
            state.confirmModal = {
                icon: 'üóëÔ∏è',
                title: 'Delete Prompt',
                message: 'Are you sure you want to delete "' + promptName + '"? This cannot be undone.',
                confirmText: 'Delete',
                confirmAction: 'deletePrompt(\'' + promptId + '\')'
            };
            render();
        }

        function deletePrompt(promptId) {
            closeConfirmModal();

            db.collection('promptTemplates').doc(promptId).delete()
                .then(function() {
                    loadPrompts();
                    showToast('Prompt deleted', 'success');
                })
                .catch(function(error) {
                    console.error('Error deleting prompt:', error);
                    showToast('Failed to delete prompt', 'error');
                });
        }

        // =============================================
        // COVER IMAGE MODAL FUNCTIONS
        // =============================================

        function openCoverModal(promptId) {
            var prompt = state.prompts.find(function(p) { return p.id === promptId; });
            if (!prompt) return;

            state.coverModal = {
                promptId: promptId,
                prompt: prompt,
                generatedImage: null,
                generating: false,
                saving: false
            };
            render();
        }

        function closeCoverModal() {
            state.coverModal = null;
            render();
        }

        function generateCoverImage() {
            if (!state.coverModal || state.coverModal.generating) return;

            state.coverModal.generating = true;
            state.coverModal.generatedImage = null;
            render();

            var prompt = state.coverModal.prompt;

            // Build a simple prompt for the cover image
            var coverPrompt = prompt.professionalPrompt || prompt.name + ' - ' + prompt.description;

            // Use the existing generateCreativeImage function
            var generateCreativeImage = firebase.functions().httpsCallable('generateCreativeImage');

            generateCreativeImage({
                prompt: coverPrompt,
                model: 'imagen-4',
                quantity: 1,
                aspectRatio: '1:1',
                quality: 'hd'
            })
            .then(function(result) {
                if (result.data && result.data.images && result.data.images.length > 0) {
                    state.coverModal.generatedImage = result.data.images[0].url;
                    showToast('Cover image generated!', 'success');
                } else {
                    showToast('No image generated', 'error');
                }
                state.coverModal.generating = false;
                render();
            })
            .catch(function(error) {
                console.error('Error generating cover:', error);
                showToast('Failed to generate cover: ' + (error.message || 'Unknown error'), 'error');
                state.coverModal.generating = false;
                render();
            });
        }

        function saveCoverImage() {
            if (!state.coverModal || !state.coverModal.generatedImage || state.coverModal.saving) return;

            state.coverModal.saving = true;
            render();

            var promptId = state.coverModal.promptId;
            var coverImage = state.coverModal.generatedImage;

            // Update the prompt document with the cover image URL
            db.collection('promptTemplates').doc(promptId).update({
                coverImage: coverImage,
                coverUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(function() {
                showToast('Cover image saved!', 'success');
                loadPrompts(); // Reload to show updated cover
                closeCoverModal();
            })
            .catch(function(error) {
                console.error('Error saving cover:', error);
                showToast('Failed to save cover image', 'error');
                state.coverModal.saving = false;
                render();
            });
        }

        function renderCoverModal() {
            if (!state.coverModal) return '';

            var modal = state.coverModal;
            var prompt = modal.prompt;

            var html = '<div class="cover-modal-backdrop" onclick="closeCoverModal()">';
            html += '<div class="cover-modal" onclick="event.stopPropagation()">';

            // Header
            html += '<div class="cover-modal-header">';
            html += '<h3 class="cover-modal-title">üñºÔ∏è Generate Cover Image</h3>';
            html += '<button class="cover-modal-close" onclick="closeCoverModal()">&times;</button>';
            html += '</div>';

            // Body
            html += '<div class="cover-modal-body">';

            // Template info
            html += '<div class="cover-info-box">';
            html += '<div class="cover-info-label">Template</div>';
            html += '<div class="cover-info-value" style="font-weight: 600;">' + escapeHtml(prompt.name) + '</div>';
            html += '<div style="font-size: 0.8rem; color: rgba(255,255,255,0.5); margin-top: 0.25rem;">' + escapeHtml(prompt.description) + '</div>';
            html += '</div>';

            // Preview area
            html += '<div class="cover-preview-area">';
            if (modal.generating) {
                html += '<div style="text-align: center;">';
                html += '<div class="spinner" style="width: 40px; height: 40px; margin: 0 auto 1rem;"></div>';
                html += '<p style="color: rgba(255,255,255,0.6);">Generating cover image...</p>';
                html += '</div>';
            } else if (modal.generatedImage) {
                html += '<img src="' + modal.generatedImage + '" alt="Generated cover">';
            } else if (prompt.coverImage) {
                html += '<div>';
                html += '<img src="' + prompt.coverImage + '" alt="Current cover" style="margin-bottom: 0.5rem;">';
                html += '<p style="color: rgba(255,255,255,0.5); font-size: 0.8rem;">Current cover image</p>';
                html += '</div>';
            } else {
                html += '<div class="cover-preview-placeholder">';
                html += '<span>üñºÔ∏è</span>';
                html += '<p>Click "Generate Preview" to create a cover image</p>';
                html += '</div>';
            }
            html += '</div>';

            html += '</div>'; // body

            // Footer
            html += '<div class="cover-modal-footer">';
            html += '<button class="btn-secondary" onclick="closeCoverModal()">Cancel</button>';

            if (modal.generatedImage && !modal.generating) {
                html += '<button class="btn-secondary" onclick="generateCoverImage()" ' + (modal.saving ? 'disabled' : '') + '>üîÑ Regenerate</button>';
                html += '<button class="btn-primary" onclick="saveCoverImage()" ' + (modal.saving ? 'disabled' : '') + '>';
                html += modal.saving ? '<span class="spinner" style="width: 16px; height: 16px; margin-right: 0.5rem;"></span> Saving...' : 'üíæ Save as Cover';
                html += '</button>';
            } else {
                html += '<button class="btn-primary" onclick="generateCoverImage()" ' + (modal.generating ? 'disabled' : '') + '>';
                html += modal.generating ? '<span class="spinner" style="width: 16px; height: 16px; margin-right: 0.5rem;"></span> Generating...' : '‚ú® Generate Preview';
                html += '</button>';
            }

            html += '</div>';

            html += '</div>'; // modal
            html += '</div>'; // backdrop

            return html;
        }

        // Seed default prompts from template
        function seedPrompts() {
            state.confirmModal = {
                icon: 'üì•',
                title: 'Seed Default Prompts',
                message: 'This will import 31 professional prompt templates. Existing prompts with the same ID will be updated. Continue?',
                confirmText: 'Import Prompts',
                confirmAction: 'doSeedPrompts()'
            };
            render();
        }

        function doSeedPrompts() {
            closeConfirmModal();
            showToast('Seeding prompts... This may take a moment.', 'info');

            var seedCreativePrompts = functions.httpsCallable('seedCreativePrompts');
            seedCreativePrompts({})
                .then(function(result) {
                    loadPrompts();
                    showToast('Successfully seeded ' + (result.data.count || 31) + ' prompt templates!', 'success');
                })
                .catch(function(error) {
                    console.error('Error seeding prompts:', error);
                    showToast('Failed to seed prompts: ' + error.message, 'error');
                });
        }

        // Refresh Data
        function refreshData() {
            if (state.activeTab === 'plans') {
                loadPlans();
            } else if (state.activeTab === 'prompts') {
                loadPrompts();
            }
        }

        // Navigation
        function goToDashboard() {
            window.location.href = 'https://ytseo.siteuo.com/video-optimizer';
        }

        // Authentication
        function checkAuth() {
            auth.onAuthStateChanged(function(user) {
                if (!user) {
                    state.currentView = 'unauthorized';
                    render();
                    return;
                }

                state.user = user;

                db.collection('adminUsers').doc(user.uid).get()
                    .then(function(doc) {
                        if (doc.exists) {
                            state.isAdmin = true;
                            state.currentView = 'dashboard';

                            // Check URL parameter for tab selection
                            var urlParams = new URLSearchParams(window.location.search);
                            var tabParam = urlParams.get('tab');
                            var validTabs = ['plans', 'prompts', 'users', 'tokenConfig', 'pricing', 'promoCodes', 'analytics', 'transactions'];
                            if (tabParam && validTabs.includes(tabParam)) {
                                state.activeTab = tabParam;
                            }

                            loadPlans();
                            loadPrompts();

                            // Load data based on active tab
                            if (state.activeTab === 'users') {
                                loadUsers();
                            } else if (state.activeTab === 'tokenConfig') {
                                loadTokenConfig();
                                loadUsers(); // Need users for dropdown
                            } else if (state.activeTab === 'pricing') {
                                loadApiCosts();
                            } else if (state.activeTab === 'promoCodes') {
                                loadPromoCodes();
                            } else if (state.activeTab === 'analytics') {
                                loadAnalytics();
                            } else if (state.activeTab === 'transactions') {
                                loadTransactions();
                            }
                        } else {
                            state.currentView = 'unauthorized';
                            render();
                        }
                    })
                    .catch(function(error) {
                        console.error('Error checking admin status:', error);
                        state.currentView = 'unauthorized';
                        render();
                    });
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            render();
            checkAuth();
        });
    </script>
</body>
</html>
