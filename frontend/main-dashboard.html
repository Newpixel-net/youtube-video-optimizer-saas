<!-- ================================================================
     YOUTUBE VIDEO OPTIMIZER - MAIN DASHBOARD
     ================================================================

     This is the primary Single Page Application (SPA) for the platform.
     All core functionality is contained within this file.

     Structure:
     - SECTION 1: External Dependencies (CDN)
     - SECTION 2: Styles (CSS)
     - SECTION 3: HTML Views
     - SECTION 4: Scripts (JavaScript)

     Views:
     - Authentication: login, register, forgot-password
     - Main: dashboard, optimizer, results, history
     - Tools: competitor, trends, thumbnail, placement, channelAudit
     - Admin: admin, admin-reports, report-editor
     - Reports: client-reports, view-report

     Main Dashboard URL: https://ytseo.siteuo.com/video-optimizer

     Last Updated: December 2025
     ================================================================ -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>YouTubeHub</title>

    <!-- PWA Manifest & Theme (Inline - no external file needed) -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"YouTubeHub","short_name":"YouTubeHub","description":"AI-powered YouTube video optimization and campaign analysis platform","start_url":"/video-optimizer","display":"standalone","background_color":"#0f172a","theme_color":"#7c3aed","orientation":"portrait-primary","icons":[{"src":"https://ytseo.siteuo.com/icon-192.png","sizes":"192x192","type":"image/png","purpose":"any maskable"},{"src":"https://ytseo.siteuo.com/icon-512.png","sizes":"512x512","type":"image/png","purpose":"any maskable"}],"categories":["productivity","business","utilities"],"lang":"en","dir":"ltr"}'>
    <meta name="theme-color" content="#7c3aed">

    <!-- ============================================
         SECTION 1: EXTERNAL DEPENDENCIES
         ============================================ -->

    <!-- 1.0 Performance: Preconnect & DNS Prefetch -->
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://identitytoolkit.googleapis.com" crossorigin>
    <link rel="dns-prefetch" href="https://www.gstatic.com">
    <link rel="dns-prefetch" href="https://firestore.googleapis.com">

    <!-- 1.1 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 1.2 Firebase SDKs (with preload for critical path) -->
    <link rel="preload" href="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js" as="script">
    <link rel="preload" href="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js" as="script">
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-functions-compat.js"></script>

    <!-- 1.3 PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- 1.4 ZIP Download Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- ============================================
         SECTION 2: STYLES
         ============================================ -->
    <style>
        /* ------------------------------------------
           2.1 BASE & RESET
           ------------------------------------------ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }

        body {
            background: #0f1419;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 1rem;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        #app-root {
            width: 100%;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            position: relative;
            z-index: 1;
        }

        /* Base typography scale */
        h1 { font-size: 2.5rem; line-height: 1.2; font-weight: 700; letter-spacing: -0.02em; }
        h2 { font-size: 2rem; line-height: 1.25; font-weight: 700; letter-spacing: -0.01em; }
        h3 { font-size: 1.5rem; line-height: 1.3; font-weight: 600; }
        h4 { font-size: 1.25rem; line-height: 1.4; font-weight: 600; }
        p, span, label { font-size: 1rem; line-height: 1.6; }

        /* ------------------------------------------
           2.2 ANIMATIONS
           ------------------------------------------ */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            width: 40px;
            height: 40px;
            animation: spin 0.6s linear infinite;
        }

        .spinner-dark {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top-color: #3b82f6;
        }

        /* Professional Loading Animation */
        @keyframes progressPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-5px) rotate(2deg); }
            75% { transform: translateY(5px) rotate(-2deg); }
        }

        .loading-container {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 1.5rem;
            padding: 3rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        }

        .progress-bar-container {
            background: #e2e8f0;
            border-radius: 1rem;
            height: 12px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 1rem;
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
            background-size: 200% 100%;
            animation: shimmer 2s ease-in-out infinite;
            transition: width 0.5s ease-out;
        }

        .progress-percentage {
            font-size: 3.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
        }

        .loading-step {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.875rem 1.25rem;
            border-radius: 0.875rem;
            transition: all 0.3s ease;
        }

        .loading-step.active {
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
        }

        .loading-step.completed {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        }

        .step-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .step-icon.pending {
            background: #e2e8f0;
            color: #94a3b8;
        }

        .step-icon.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .step-icon.completed {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }

        .loading-emoji {
            font-size: 4rem;
            animation: float 3s ease-in-out infinite;
        }

        .loading-tip {
            background: rgba(99, 102, 241, 0.1);
            border-left: 4px solid #6366f1;
            padding: 1rem 1.25rem;
            border-radius: 0 0.75rem 0.75rem 0;
        }

        /* ------------------------------------------
           2.2.5 NOTIFICATION & REPORT STYLES
           ------------------------------------------ */
        @keyframes notificationPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { transform: scale(1.1); box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }

        @keyframes notificationGlow {
            0%, 100% { box-shadow: 0 0 5px rgba(34, 197, 94, 0.5); }
            50% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.8), 0 0 30px rgba(34, 197, 94, 0.4); }
        }

        /* New notification attention animation - triggered when new notifications arrive */
        @keyframes notificationBounce {
            0%, 100% { transform: scale(1); }
            10% { transform: scale(1.3); }
            20% { transform: scale(1); }
            30% { transform: scale(1.2); }
            40% { transform: scale(1); }
            50% { transform: scale(1.15); }
            60% { transform: scale(1); }
        }

        @keyframes notificationFlash {
            0%, 100% { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
            25% { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
            50% { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
            75% { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
        }

        .notification-badge.notification-new {
            animation: notificationBounce 1s ease-in-out, notificationFlash 1s ease-in-out 3;
        }

        .notification-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            min-width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            font-size: 11px;
            font-weight: 700;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
            animation: notificationPulse 2s ease-in-out infinite;
        }

        .notification-dot {
            width: 12px;
            height: 12px;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            border-radius: 50%;
            animation: notificationGlow 2s ease-in-out infinite;
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 8px;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .notification-bell:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Token Display in Header */
        .token-display {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(245, 158, 11, 0.2) 100%);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-right: 8px;
        }

        .token-display:hover {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.3) 0%, rgba(245, 158, 11, 0.3) 100%);
            border-color: rgba(251, 191, 36, 0.5);
            transform: scale(1.02);
        }

        .token-icon {
            font-size: 1.1rem;
        }

        .token-amount {
            font-size: 0.9rem;
            font-weight: 700;
            color: #fbbf24;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 360px;
            max-height: 480px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            z-index: 1001;
            margin-top: 8px;
            animation: fadeIn 0.2s ease-out;
        }

        .notification-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }

        .notification-tab {
            flex: 1;
            padding: 0.875rem 1rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.5);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
        }

        .notification-tab:hover {
            color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.05);
        }

        .notification-tab.active {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .notification-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #8b5cf6, #ec4899);
        }

        .notification-tab-badge {
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            font-size: 10px;
            font-weight: 700;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-header {
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .notification-header-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
        }

        .notification-mark-read {
            font-size: 0.75rem;
            color: #8b5cf6;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: color 0.2s;
        }

        .notification-mark-read:hover {
            color: #a78bfa;
        }

        .notification-list {
            max-height: 320px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.2) transparent;
        }

        .notification-list::-webkit-scrollbar {
            width: 6px;
        }

        .notification-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .notification-list::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }

        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: background 0.2s;
        }

        .notification-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .notification-item.unread {
            background: rgba(139, 92, 246, 0.1);
        }

        .notification-item-content {
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
        }

        .notification-item-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .notification-item-text {
            flex: 1;
            min-width: 0;
        }

        .notification-item-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.25rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .notification-item-message {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.4;
        }

        .notification-item-time {
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 0.25rem;
        }

        .notification-empty {
            padding: 2.5rem 1.5rem;
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
        }

        .notification-empty-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
            opacity: 0.5;
        }

        .notification-empty-text {
            font-size: 0.875rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.6);
        }

        .notification-empty-subtext {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 0.25rem;
        }

        /* Click-outside overlay for notifications */
        .notification-overlay {
            position: fixed;
            inset: 0;
            z-index: 999;
        }

        /* ------------------------------------------
           2.2.6 SCROLLABLE TABS (Mobile-friendly)
           ------------------------------------------ */
        .history-tabs-container {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }

        .history-tabs-container::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        .history-tab-btn {
            min-width: max-content;
        }

        /* Scrollbar hide utility */
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        /* Global Header */
        .global-header {
            position: fixed;
            top: 0;
            right: 0;
            left: 0;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 2rem 0 1rem;
            z-index: 1000;
            pointer-events: none;
        }

        .global-header > * {
            pointer-events: auto;
        }

        .global-header-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Anti-Flicker Optimizations */
        #app-root {
            /* Prevent layout shifts and improve rendering performance */
            contain: layout style;
            will-change: opacity, transform;
        }

        /* Prevent image flicker during re-renders */
        img {
            content-visibility: auto;
        }

        /* Smooth re-renders for common interactive elements */
        .card, .metric-card, .btn-primary, .btn-secondary,
        .notification-dropdown, .dropdown-menu {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        /* View Transitions */
        .view-transitioning {
            opacity: 0;
            transform: translateY(8px);
        }

        .view-entering {
            animation: viewEnter 0.25s ease-out forwards;
        }

        @keyframes viewEnter {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Hide carousel during initialization */
        .carousel-initializing {
            visibility: hidden;
        }

        .carousel-ready {
            visibility: visible;
            animation: fadeIn 0.3s ease-out;
        }

        .upload-zone {
            border: 3px dashed #cbd5e1;
            border-radius: 16px;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #f8fafc;
        }

        .upload-zone:hover, .upload-zone.drag-over {
            border-color: #6366f1;
            background: #eef2ff;
        }

        .upload-zone.has-images {
            border-style: solid;
            border-color: #22c55e;
            background: #f0fdf4;
        }

        .image-preview {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 16/9;
            background: #f1f5f9;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview .remove-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .image-preview .remove-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .report-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0;
        }

        .report-card:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-draft { background: #f1f5f9; color: #64748b; }
        .status-ready { background: #dbeafe; color: #2563eb; }
        .status-sent { background: #dcfce7; color: #16a34a; }
        .status-viewed { background: #f3e8ff; color: #9333ea; }

        .metric-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }

        .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1e293b;
        }

        .metric-label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .recommendation-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            border-left: 4px solid;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .recommendation-card.priority-high { border-left-color: #ef4444; }
        .recommendation-card.priority-medium { border-left-color: #f59e0b; }
        .recommendation-card.priority-low { border-left-color: #22c55e; }

        /* ========== STRATEGIC GROWTH DASHBOARD STYLES ========== */

        .strategic-section {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .strategic-section::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.15) 0%, transparent 70%);
            pointer-events: none;
        }

        .strategic-section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .strategic-section-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .strategic-section-title {
            color: #fff;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .strategic-section-subtitle {
            color: #94a3b8;
            font-size: 0.875rem;
        }

        /* Channel Health Score */
        .health-score-container {
            display: flex;
            align-items: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .health-score-ring {
            position: relative;
            width: 140px;
            height: 140px;
            flex-shrink: 0;
        }

        .health-score-ring svg {
            transform: rotate(-90deg);
        }

        .health-score-ring circle {
            fill: none;
            stroke-width: 10;
        }

        .health-score-ring .bg-ring {
            stroke: #334155;
        }

        .health-score-ring .score-ring {
            stroke-linecap: round;
            transition: stroke-dashoffset 1s ease;
        }

        .health-score-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .health-score-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: #fff;
            line-height: 1;
        }

        .health-score-label {
            font-size: 0.75rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .health-score-breakdown {
            flex: 1;
            min-width: 200px;
        }

        .score-category {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #334155;
        }

        .score-category:last-child {
            border-bottom: none;
        }

        .score-category-name {
            color: #e2e8f0;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .score-category-bar {
            width: 100px;
            height: 6px;
            background: #334155;
            border-radius: 3px;
            overflow: hidden;
        }

        .score-category-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.8s ease;
        }

        /* Enhanced Metrics Dashboard */
        .metrics-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
        }

        .metric-tile {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 16px;
            padding: 1.25rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .metric-tile::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--metric-color, #8b5cf6), transparent);
        }

        .metric-tile-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .metric-tile-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: #fff;
            margin-bottom: 0.25rem;
        }

        .metric-tile-label {
            font-size: 0.7rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-tile-trend {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            margin-top: 0.5rem;
        }

        .metric-tile-trend.positive {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .metric-tile-trend.neutral {
            background: rgba(148, 163, 184, 0.2);
            color: #94a3b8;
        }

        /* Action Cards for Recommendations */
        .action-cards-grid {
            display: grid;
            gap: 1rem;
        }

        .action-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .action-card:hover {
            border-color: rgba(139, 92, 246, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .action-card-header {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .action-card-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .action-card-icon.high { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .action-card-icon.medium { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .action-card-icon.low { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }

        .action-card-title-area {
            flex: 1;
        }

        .action-card-title {
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .action-card-category {
            color: #64748b;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .action-card-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .action-badge {
            font-size: 0.65rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .action-badge.priority-high {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .action-badge.priority-medium {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .action-badge.priority-low {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .action-badge.impact {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
        }

        .action-card-description {
            color: #cbd5e1;
            font-size: 0.875rem;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .action-card-impact {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
        }

        .impact-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .impact-label {
            color: #4ade80;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .impact-value {
            color: #4ade80;
            font-size: 0.875rem;
            font-weight: 700;
        }

        .impact-bar {
            height: 6px;
            background: rgba(34, 197, 94, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }

        .impact-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e 0%, #4ade80 100%);
            border-radius: 3px;
            transition: width 0.8s ease;
        }

        .action-card-evidence {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
        }

        .evidence-label {
            color: #60a5fa;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.375rem;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .evidence-text {
            color: #93c5fd;
            font-size: 0.8rem;
            line-height: 1.5;
        }

        .action-card-steps {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 1rem;
        }

        .steps-toggle {
            color: #8b5cf6;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: color 0.2s;
        }

        .steps-toggle:hover {
            color: #a78bfa;
        }

        /* Growth Projection */
        .growth-projection {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 50%, #ec4899 100%);
            border-radius: 16px;
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .growth-projection-content {
            flex: 1;
            min-width: 200px;
        }

        .growth-projection-title {
            color: #fff;
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .growth-projection-text {
            color: rgba(255, 255, 255, 0.85);
            font-size: 0.875rem;
        }

        .growth-projection-value {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            text-align: center;
        }

        .growth-value-number {
            font-size: 1.75rem;
            font-weight: 800;
            color: #fff;
        }

        .growth-value-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        @media (max-width: 640px) {
            .strategic-section {
                padding: 1.25rem;
            }
            .health-score-container {
                flex-direction: column;
                align-items: stretch;
                gap: 1.5rem;
            }
            .health-score-ring {
                margin: 0 auto;
            }
            .growth-projection {
                flex-direction: column;
                text-align: center;
            }
        }

        /* ========== PDF EXPORT STYLES ========== */
        /* Keeps original design, only adds structural rules for proper page breaks */

        .pdf-mode {
            width: 800px !important;
            max-width: 800px !important;
            margin: 0 auto;
        }

        /* Structural rules only - preserve original colors */
        .pdf-mode .strategic-section,
        .pdf-mode .health-score-container,
        .pdf-mode .metric-tile,
        .pdf-mode .action-card,
        .pdf-mode .growth-projection,
        .pdf-mode .youtube-hero,
        .pdf-mode .report-image-item,
        .pdf-mode .bg-gray-50.rounded-xl.p-5 {
            page-break-inside: avoid;
            break-inside: avoid;
        }

        .pdf-mode .strategic-section {
            margin-bottom: 16px;
        }

        .pdf-mode .action-card {
            margin-bottom: 10px;
        }

        /* PDF Section Wrapper for page breaks */
        .pdf-section {
            page-break-inside: avoid;
            break-inside: avoid;
            margin-bottom: 16px;
        }

        .pdf-page-break {
            page-break-after: always;
            break-after: page;
            height: 1px;
        }

        .client-report-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .client-report-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
        }

        .client-report-card.has-new::after {
            content: 'NEW';
            position: absolute;
            top: 12px;
            right: -28px;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 4px 32px;
            transform: rotate(45deg);
        }

        /* ------------------------------------------
           2.2.6 LIVING AURORA EFFECT
           Animated orbs + noise texture + time-aware colors
           ------------------------------------------ */

        /* Time-aware color CSS custom properties - set by JavaScript */
        :root {
            /* Default colors (will be overridden by JS based on time) */
            --aurora-primary: #6366f1;
            --aurora-secondary: #8b5cf6;
            --aurora-tertiary: #a855f7;
            --aurora-accent: #06b6d4;
            --aurora-glow: rgba(99, 102, 241, 0.3);

            /* Morning colors (6am-12pm) */
            --aurora-morning-primary: #f59e0b;
            --aurora-morning-secondary: #fb923c;
            --aurora-morning-tertiary: #fbbf24;
            --aurora-morning-accent: #fcd34d;

            /* Afternoon colors (12pm-6pm) */
            --aurora-afternoon-primary: #22c55e;
            --aurora-afternoon-secondary: #34d399;
            --aurora-afternoon-tertiary: #10b981;
            --aurora-afternoon-accent: #06b6d4;

            /* Evening colors (6pm-9pm) */
            --aurora-evening-primary: #f97316;
            --aurora-evening-secondary: #ef4444;
            --aurora-evening-tertiary: #ec4899;
            --aurora-evening-accent: #f59e0b;

            /* Night colors (9pm-6am) */
            --aurora-night-primary: #6366f1;
            --aurora-night-secondary: #8b5cf6;
            --aurora-night-tertiary: #a855f7;
            --aurora-night-accent: #3b82f6;
        }

        /* Aurora gradient animation */
        @keyframes auroraFlow {
            0%, 100% {
                background-position: 0% 50%;
            }
            25% {
                background-position: 50% 100%;
            }
            50% {
                background-position: 100% 50%;
            }
            75% {
                background-position: 50% 0%;
            }
        }

        @keyframes auroraShift {
            0%, 100% {
                filter: hue-rotate(0deg);
                transform: scale(1);
            }
            33% {
                filter: hue-rotate(15deg);
                transform: scale(1.02);
            }
            66% {
                filter: hue-rotate(-10deg);
                transform: scale(0.98);
            }
        }

        /* Floating orb animations */
        @keyframes orbFloat1 {
            0%, 100% {
                transform: translate(0, 0) scale(1);
                opacity: 0.6;
            }
            25% {
                transform: translate(30%, -20%) scale(1.1);
                opacity: 0.8;
            }
            50% {
                transform: translate(60%, 10%) scale(0.9);
                opacity: 0.5;
            }
            75% {
                transform: translate(20%, 30%) scale(1.05);
                opacity: 0.7;
            }
        }

        @keyframes orbFloat2 {
            0%, 100% {
                transform: translate(0, 0) scale(1);
                opacity: 0.5;
            }
            25% {
                transform: translate(-40%, 30%) scale(0.8);
                opacity: 0.7;
            }
            50% {
                transform: translate(-20%, -30%) scale(1.2);
                opacity: 0.4;
            }
            75% {
                transform: translate(30%, -10%) scale(0.9);
                opacity: 0.6;
            }
        }

        @keyframes orbFloat3 {
            0%, 100% {
                transform: translate(0, 0) scale(0.9);
                opacity: 0.4;
            }
            33% {
                transform: translate(50%, 40%) scale(1.1);
                opacity: 0.6;
            }
            66% {
                transform: translate(-30%, 20%) scale(0.85);
                opacity: 0.5;
            }
        }

        @keyframes orbPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.3);
                opacity: 0.8;
            }
        }

        @keyframes noiseAnimation {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-1%, -1%); }
            20% { transform: translate(1%, 1%); }
            30% { transform: translate(-0.5%, 0.5%); }
            40% { transform: translate(0.5%, -0.5%); }
            50% { transform: translate(-1%, 1%); }
            60% { transform: translate(1%, -1%); }
            70% { transform: translate(0, 0.5%); }
            80% { transform: translate(-0.5%, 0); }
            90% { transform: translate(0.5%, 0.5%); }
        }

        /* Living Aurora Card Container */
        .living-aurora {
            position: relative;
            overflow: hidden;
            isolation: isolate;
            /* PERFORMANCE: Isolate rendering from rest of page */
            contain: layout style paint;
        }

        /* Aurora gradient background layer - OPTIMIZED */
        .living-aurora::before {
            content: '';
            position: absolute;
            inset: -20%; /* Reduced from -50% */
            background: linear-gradient(
                135deg,
                var(--aurora-primary) 0%,
                var(--aurora-secondary) 25%,
                var(--aurora-tertiary) 50%,
                var(--aurora-accent) 75%,
                var(--aurora-primary) 100%
            );
            background-size: 200% 200%; /* Reduced from 400% 400% */
            animation: auroraFlow 25s ease-in-out infinite; /* Slower animation */
            z-index: -3;
            opacity: 1;
            will-change: background-position;
        }

        /* Noise texture overlay - OPTIMIZED: removed animation for performance */
        .living-aurora::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            background-size: 200px 200px;
            opacity: 0.05;
            mix-blend-mode: overlay;
            /* REMOVED animation - was causing performance issues */
            /* animation: noiseAnimation 8s steps(10) infinite; */
            z-index: 1;
            pointer-events: none;
        }

        /* Animated orbs container */
        .aurora-orbs {
            position: absolute;
            inset: 0;
            overflow: hidden;
            z-index: -2;
            pointer-events: none;
        }

        /* Individual orbs - OPTIMIZED for performance */
        .aurora-orb {
            position: absolute;
            border-radius: 50%;
            /* REMOVED blur filter - was causing major performance issues */
            /* filter: blur(40px); */
            mix-blend-mode: screen;
            /* REMOVED will-change to prevent separate compositing layer issues during navigation */
            /* will-change: transform, opacity; */
            /* Use a softer gradient instead of blur for performance */
            opacity: 0.4;
            /* Ensure orbs transition with parent */
            transition: opacity 0.15s ease-out;
        }

        /* Hide aurora orbs when clicked to prevent flash during navigation */
        a:active .aurora-orb,
        a:active .aurora-orbs,
        a:active .living-aurora::before,
        a:active .aurora-shimmer,
        .living-aurora:active .aurora-orb,
        .living-aurora:active .aurora-orbs,
        .living-aurora:active::before,
        .living-aurora:active .aurora-shimmer {
            opacity: 0 !important;
            transition: none;
        }

        /* Also hide during view transitions */
        .view-transitioning .aurora-orb,
        .view-transitioning .aurora-orbs,
        .view-transitioning .living-aurora::before {
            opacity: 0;
        }

        .aurora-orb-1 {
            width: 80%;
            height: 80%;
            top: -25%;
            left: -15%;
            /* Softer gradient to simulate blur without GPU cost */
            background: radial-gradient(circle, var(--aurora-primary) 0%, var(--aurora-tertiary) 30%, transparent 55%);
            animation: orbFloat1 20s ease-in-out infinite; /* Slower = less GPU work */
        }

        .aurora-orb-2 {
            width: 70%;
            height: 70%;
            bottom: -20%;
            right: -20%;
            background: radial-gradient(circle, var(--aurora-secondary) 0%, var(--aurora-accent) 30%, transparent 55%);
            animation: orbFloat2 18s ease-in-out infinite;
            animation-delay: -3s;
        }

        /* PERFORMANCE: Reduced from 4 orbs to 2 - orbs 3 & 4 hidden */
        .aurora-orb-3,
        .aurora-orb-4 {
            display: none;
        }

        /* Card content wrapper - ensures content is above aurora */
        .aurora-content {
            position: relative;
            z-index: 2;
        }

        /* Glassmorphism overlay for better text readability - OPTIMIZED */
        .aurora-glass {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.08);
            /* REMOVED backdrop-filter for performance */
            /* backdrop-filter: blur(1px); */
            z-index: 0;
            pointer-events: none;
        }

        /* Aurora glow effect on hover - DISABLED for performance */
        /* Hover acceleration was causing jank */
        /*
        .living-aurora:hover::before {
            animation-duration: 8s;
        }

        .living-aurora:hover .aurora-orb {
            animation-duration: 6s;
        }
        */

        /* Accessibility: Respect reduced motion preference */
        @media (prefers-reduced-motion: reduce) {
            .living-aurora::before,
            .living-aurora::after,
            .aurora-orb {
                animation: none;
            }
            .living-aurora::before {
                background-position: 50% 50%;
            }
        }

        /* Pause all animations when tab is not visible (saves CPU/GPU) */
        .animations-paused *,
        .animations-paused *::before,
        .animations-paused *::after {
            animation-play-state: paused !important;
        }

        /* Time-aware theme classes */
        .aurora-morning {
            --aurora-primary: var(--aurora-morning-primary);
            --aurora-secondary: var(--aurora-morning-secondary);
            --aurora-tertiary: var(--aurora-morning-tertiary);
            --aurora-accent: var(--aurora-morning-accent);
        }

        .aurora-afternoon {
            --aurora-primary: var(--aurora-afternoon-primary);
            --aurora-secondary: var(--aurora-afternoon-secondary);
            --aurora-tertiary: var(--aurora-afternoon-tertiary);
            --aurora-accent: var(--aurora-afternoon-accent);
        }

        .aurora-evening {
            --aurora-primary: var(--aurora-evening-primary);
            --aurora-secondary: var(--aurora-evening-secondary);
            --aurora-tertiary: var(--aurora-evening-tertiary);
            --aurora-accent: var(--aurora-evening-accent);
        }

        .aurora-night {
            --aurora-primary: var(--aurora-night-primary);
            --aurora-secondary: var(--aurora-night-secondary);
            --aurora-tertiary: var(--aurora-night-tertiary);
            --aurora-accent: var(--aurora-night-accent);
        }

        /* Specific aurora themes for different card types */
        .aurora-emerald {
            --aurora-primary: #10b981;
            --aurora-secondary: #14b8a6;
            --aurora-tertiary: #06b6d4;
            --aurora-accent: #22c55e;
            /* Solid fallback background - visible when ::before is hidden */
            background: linear-gradient(135deg, #10b981 0%, #14b8a6 50%, #06b6d4 100%);
        }

        .aurora-gold {
            --aurora-primary: #f59e0b;
            --aurora-secondary: #fbbf24;
            --aurora-tertiary: #f97316;
            --aurora-accent: #eab308;
            /* Solid fallback background - visible when ::before is hidden */
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 50%, #f97316 100%);
        }

        .aurora-creative {
            --aurora-primary: #8b5cf6;
            --aurora-secondary: #a855f7;
            --aurora-tertiary: #ec4899;
            --aurora-accent: #d946ef;
            /* Solid fallback background */
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 50%, #ec4899 100%);
        }

        /* Aurora shimmer for subtle movement */
        @keyframes auroraShimmer {
            0% {
                opacity: 0.3;
                transform: translateX(-100%) rotate(45deg);
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 0.3;
                transform: translateX(100%) rotate(45deg);
            }
        }

        .aurora-shimmer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.15) 50%,
                transparent 100%
            );
            animation: auroraShimmer 8s ease-in-out infinite; /* Slower */
            will-change: transform, opacity;
            z-index: 1;
            pointer-events: none;
        }

        /* Image Lightbox Modal */
        .lightbox-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            animation: fadeIn 0.2s ease;
        }

        .lightbox-content {
            position: relative;
            max-width: 95vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .lightbox-image {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
        }

        .lightbox-close {
            position: absolute;
            top: -50px;
            right: 0;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lightbox-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lightbox-nav:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .lightbox-nav.prev { left: -70px; }
        .lightbox-nav.next { right: -70px; }

        .lightbox-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .lightbox-download {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .lightbox-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4);
        }

        .lightbox-counter {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            margin-top: 1rem;
        }

        /* Report Image Gallery */
        .report-image-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .report-image-item:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .report-image-item img {
            width: 100%;
            height: auto;
            display: block;
        }

        .report-image-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding: 1rem;
        }

        .report-image-item:hover .report-image-overlay {
            opacity: 1;
        }

        .report-image-actions {
            display: flex;
            gap: 0.5rem;
        }

        .report-image-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.9);
            color: #1e293b;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            transition: all 0.2s ease;
        }

        .report-image-btn:hover {
            background: white;
            transform: translateY(-2px);
        }

        /* YouTube Performance Hero Section */
        .youtube-hero {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .youtube-hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff0000 0%, #ff4444 50%, #ff6666 100%);
        }

        .youtube-hero-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }

        .youtube-hero-main {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .youtube-hero-main::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }

        .youtube-views-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .youtube-views-value {
            color: white;
            font-size: 3.5rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 1rem;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .youtube-view-rate {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .view-rate-bar {
            flex: 1;
            max-width: 200px;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .view-rate-fill {
            height: 100%;
            background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 100%);
            border-radius: 4px;
            transition: width 1s ease;
        }

        .view-rate-text {
            color: #fbbf24;
            font-weight: 700;
            font-size: 1.125rem;
        }

        .youtube-metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .youtube-metric-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .youtube-metric-card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .youtube-metric-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .youtube-metric-value {
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .youtube-metric-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.25rem;
        }

        .youtube-video-info {
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .youtube-video-title {
            color: white;
            font-weight: 600;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .youtube-video-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 0.75rem;
            flex-wrap: wrap;
        }

        .youtube-video-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.8rem;
        }

        .youtube-video-tag.status-eligible {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        @media (max-width: 640px) {
            .youtube-hero { padding: 1.25rem; }
            .youtube-views-value { font-size: 2.5rem; }
            .youtube-metrics-grid { grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
            .youtube-metric-card { padding: 0.75rem 0.5rem; }
            .youtube-metric-value { font-size: 1.125rem; }
            .lightbox-nav { display: none; }
        }

        /* ------------------------------------------
           2.3 COMPONENTS - Buttons
           ------------------------------------------ */
        .btn-primary {
            width: 100%;
            padding: 1.125rem 1.5rem;
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            color: white;
            font-weight: 600;
            font-size: 1.0625rem;
            border-radius: 0.875rem;
            border: none;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 14px rgba(124, 58, 237, 0.25);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #6d28d9 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(124, 58, 237, 0.35);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(124, 58, 237, 0.25);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            padding: 0.75rem 1.25rem;
            background: rgba(255, 255, 255, 0.25);
            /* REMOVED backdrop-filter for performance */
            color: white;
            font-weight: 600;
            font-size: 0.9375rem;
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .google-btn {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1rem;
        }

        .google-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .google-btn:active {
            transform: translateY(0);
        }

        /* ------------------------------------------
           2.4 COMPONENTS - Cards
           ------------------------------------------ */
        .tool-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.08);
            /* PERFORMANCE: Isolate rendering and skip off-screen */
            contain: layout style paint;
            content-visibility: auto;
            contain-intrinsic-size: auto 280px;
        }

        .tool-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4), 0 0 30px rgba(236, 72, 153, 0.2);
            border-color: rgba(236, 72, 153, 0.3);
        }

        .card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1.25rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
            padding: 2.5rem;
        }

        /* ------------------------------------------
           2.4b COMPONENTS - Tabs
           ------------------------------------------ */
        .tabs-container {
            display: flex;
            gap: 0.375rem;
            background: #f3f4f6;
            padding: 0.375rem;
            border-radius: 1rem;
            margin-bottom: 1.75rem;
        }

        .tab-btn {
            flex: 1;
            padding: 0.875rem 1.25rem;
            border: none;
            background: transparent;
            color: #6b7280;
            font-weight: 600;
            font-size: 0.9375rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-btn:hover {
            color: #374151;
            background: rgba(255, 255, 255, 0.6);
        }

        .tab-btn.active {
            background: white;
            color: #7c3aed;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .tab-content {
            animation: fadeIn 0.3s ease-out;
        }

        /* ------------------------------------------
           2.4c COMPONENTS - Score Gauge
           ------------------------------------------ */
        .score-gauge {
            position: relative;
            width: 140px;
            height: 140px;
        }

        .score-circle {
            transform: rotate(-90deg);
        }

        .score-circle-bg {
            fill: none;
            stroke: #e5e7eb;
            stroke-width: 10;
        }

        .score-circle-fill {
            fill: none;
            stroke-width: 10;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s ease-out;
        }

        .score-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        /* ------------------------------------------
           2.5 COMPONENTS - Forms
           ------------------------------------------ */
        .input-field {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1rem;
            padding: 1rem 1.25rem;
        }

        .input-field:focus {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            border-color: #7c3aed;
        }

        .input-field::placeholder {
            color: #9ca3af;
        }

        /* ------------------------------------------
           2.6 COMPONENTS - Progress & Usage
           ------------------------------------------ */
        .usage-bar {
            transition: width 0.5s ease-out;
        }

        .usage-green { background-color: #22c55e; }
        .usage-yellow { background-color: #eab308; }
        .usage-red { background-color: #ef4444; }

        /* ------------------------------------------
           2.7 COMPONENTS - Messages
           ------------------------------------------ */
        .alert-error {
            padding: 0.75rem;
            background-color: #fef2f2;
            color: #b91c1c;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .alert-success {
            padding: 0.75rem;
            background-color: #f0fdf4;
            color: #15803d;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        /* ------------------------------------------
           2.8 COMPONENTS - Tags
           ------------------------------------------ */
        .tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background-color: #f3e8ff;
            color: #7c3aed;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* ------------------------------------------
           2.9 LAYOUT - Views
           ------------------------------------------ */
        .view-container {
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding: 2rem 1.5rem;
        }

        .view-centered {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .content-wrapper {
            max-width: 90rem;
            margin: 0 auto;
            width: 100%;
        }

        /* Desktop-optimized widths - expanded for better space utilization */
        @media (min-width: 1024px) {
            .max-w-6xl {
                max-width: 94% !important;
                padding-left: 1.5rem;
                padding-right: 1.5rem;
            }
            .max-w-4xl {
                max-width: 80% !important;
                min-width: 700px;
            }
        }

        @media (min-width: 1280px) {
            .max-w-6xl {
                max-width: 92% !important;
            }
            .max-w-4xl {
                max-width: 76% !important;
                min-width: 800px;
            }
            .view-container {
                padding: 1.75rem 2rem;
            }
        }

        @media (min-width: 1536px) {
            .max-w-6xl {
                max-width: 90% !important;
            }
            .max-w-4xl {
                max-width: 72% !important;
                min-width: 900px;
            }
            .view-container {
                padding: 2rem 3rem;
            }
        }

        @media (min-width: 1920px) {
            .max-w-6xl {
                max-width: 88% !important;
                max-width: min(88%, 1800px) !important;
            }
            .max-w-4xl {
                max-width: 68% !important;
                max-width: min(68%, 1200px) !important;
                min-width: 1000px;
            }
            .view-container {
                padding: 2.5rem 4rem;
            }
        }

        /* Dashboard grid - more columns on larger screens */
        @media (min-width: 1280px) {
            .dashboard-grid-4 {
                grid-template-columns: repeat(4, 1fr) !important;
            }
            .dashboard-grid-2 {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }

        @media (min-width: 1536px) {
            .dashboard-grid-4 {
                gap: 1.5rem !important;
            }
            .dashboard-grid-2 {
                gap: 2rem !important;
            }
        }

        /* ------------------------------------------
           2.10 MOBILE & RESPONSIVE
           ------------------------------------------ */

        /* Tablet styles (769px - 1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            html {
                font-size: 16px;
            }

            .view-container {
                padding: 1.75rem 1.5rem;
            }
        }

        /* Mobile styles (up to 768px) */
        @media (max-width: 768px) {
            html {
                font-size: 17px; /* Larger base for mobile readability */
            }

            body {
                -webkit-text-size-adjust: 100%;
            }

            /* Typography scale for mobile */
            h1 { font-size: 1.875rem !important; line-height: 1.2; }
            h2 { font-size: 1.5rem !important; line-height: 1.25; }
            h3 { font-size: 1.25rem !important; line-height: 1.3; }
            h4 { font-size: 1.125rem !important; line-height: 1.4; }
            p, span, label { font-size: 1rem; line-height: 1.6; }

            .view-container {
                padding: 1.25rem 1rem;
            }

            .mobile-full-screen {
                min-height: 100vh;
                min-height: -webkit-fill-available;
                padding: 1.25rem;
            }

            .mobile-card {
                width: 100%;
                max-width: 100%;
                margin: 0;
            }

            .mobile-padding {
                padding: 1.75rem !important;
            }

            .mobile-text-lg {
                font-size: 1.25rem !important;
            }

            .mobile-text-xl {
                font-size: 1.5rem !important;
            }

            .mobile-grid-cols-1 {
                grid-template-columns: 1fr !important;
            }

            /* Mobile Swipeable Usage Cards */
            .mobile-swipe-container {
                display: flex;
                overflow-x: auto;
                scroll-snap-type: x mandatory;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
                gap: 1rem;
                padding: 0.5rem 0;
                margin: 0 -1rem;
                padding-left: 1rem;
                padding-right: 1rem;
            }

            .mobile-swipe-container::-webkit-scrollbar {
                display: none;
            }

            .mobile-swipe-card {
                flex: 0 0 85%;
                scroll-snap-align: center;
                scroll-snap-stop: always;
            }

            .mobile-swipe-dots {
                display: flex;
                justify-content: center;
                gap: 0.5rem;
                margin-top: 1rem;
                margin-bottom: 0.5rem;
            }

            .mobile-swipe-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background-color: rgba(255, 255, 255, 0.4);
                transition: all 0.3s ease;
                cursor: pointer;
            }

            .mobile-swipe-dot.active {
                background-color: white;
                transform: scale(1.3);
            }

            .mobile-gap-4 {
                gap: 1rem !important;
            }

            /* Mobile wide container - expands content to near full width */
            .mobile-wide-container {
                max-width: 100% !important;
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
            }

            .mobile-wide-container .bg-white {
                margin-left: 0 !important;
                margin-right: 0 !important;
            }

            /* Dashboard cards side-by-side on mobile */
            .dashboard-cards-grid {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 0.75rem !important;
            }

            .dashboard-cards-grid .dashboard-card {
                padding: 0.875rem !important;
            }

            .dashboard-cards-grid .dashboard-card-icon {
                width: 2.5rem !important;
                height: 2.5rem !important;
                font-size: 1.5rem !important;
            }

            .dashboard-cards-grid .dashboard-card-title {
                font-size: 0.875rem !important;
                line-height: 1.2 !important;
            }

            .dashboard-cards-grid .dashboard-card-subtitle {
                display: none !important;
            }

            .dashboard-cards-grid .dashboard-card-arrow {
                font-size: 1.25rem !important;
            }

            /* Optimization results mobile layout */
            .optimization-scores-mobile {
                flex-direction: row !important;
                flex-wrap: wrap !important;
                justify-content: center !important;
                gap: 1rem !important;
            }

            .optimization-scores-mobile .score-gauge {
                transform: scale(0.85);
            }

            .optimization-scores-mobile .improvement-badge {
                width: 100% !important;
                margin-top: 0.5rem !important;
            }

            /* Improve touch targets for Apple HIG compliance */
            button, .google-btn, input, select, .tab-btn {
                min-height: 50px;
                font-size: 17px !important; /* Apple's recommended mobile size */
            }

            .btn-primary {
                padding: 1rem 1.25rem;
                font-size: 1.0625rem !important;
            }

            .btn-secondary {
                padding: 0.875rem 1rem;
                min-height: 48px;
            }

            /* Cards - more padding on mobile */
            .card {
                padding: 1.75rem;
                border-radius: 1rem;
            }

            /* Forms - larger inputs */
            .input-field {
                padding: 1rem 1rem;
                font-size: 17px !important;
                border-radius: 0.75rem;
            }

            /* Tabs - larger on mobile */
            .tabs-container {
                padding: 0.25rem;
                border-radius: 0.875rem;
            }

            .tab-btn {
                padding: 0.75rem 0.5rem;
                font-size: 0.9375rem !important;
            }

            /* Score gauges - smaller on mobile */
            .score-gauge {
                width: 100px;
                height: 100px;
            }

            .score-value {
                font-size: 1.5rem;
            }

            /* Better spacing for mobile lists */
            .space-y-4 > * + * {
                margin-top: 1.25rem;
            }

            /* Full width buttons on mobile */
            .btn-secondary {
                width: 100%;
            }

            /* Hide desktop grid on mobile, show swipe container */
            .desktop-usage-grid {
                display: none !important;
            }
            .mobile-swipe-container {
                display: flex !important;
            }
            .mobile-swipe-dots {
                display: flex !important;
            }
        }

        /* Desktop: Hide swipe container, show carousel (outside mobile media query) */
        @media (min-width: 769px) {
            .mobile-swipe-container {
                display: none !important;
            }
            .mobile-swipe-dots {
                display: none !important;
            }
            .desktop-usage-grid {
                display: none !important;
            }
            .desktop-usage-carousel {
                display: flex !important;
            }
        }

        /* Desktop Usage Carousel - Compact Horizontal Strip */
        .desktop-usage-carousel {
            display: none;
            overflow-x: auto;
            scroll-behavior: smooth;
            gap: 1rem;
            padding: 0.5rem 0;
            margin-bottom: 2rem;
            cursor: grab;
            user-select: none;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.3) transparent;
        }

        .desktop-usage-carousel:active {
            cursor: grabbing;
        }

        .desktop-usage-carousel::-webkit-scrollbar {
            height: 6px;
        }

        .desktop-usage-carousel::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        .desktop-usage-carousel::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }

        .desktop-usage-carousel::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.5);
        }

        .compact-usage-cell {
            flex: 0 0 auto;
            min-width: 180px;
            max-width: 200px;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            padding: 1rem 1.25rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }

        .compact-usage-cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3), 0 0 20px rgba(236, 72, 153, 0.15);
            border-color: rgba(236, 72, 153, 0.2);
        }

        .compact-cell-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .compact-cell-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .compact-cell-info {
            flex: 1;
            min-width: 0;
        }

        .compact-cell-name {
            font-weight: 700;
            font-size: 0.875rem;
            color: #ffffff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .compact-cell-usage {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .compact-cell-usage strong {
            font-size: 1rem;
            color: #ffffff;
        }

        .compact-cell-bonus {
            color: #34d399;
            font-weight: 700;
        }

        .compact-progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .compact-progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .compact-cell-footer {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .compact-cell-footer.exhausted {
            color: #f87171;
            font-weight: 600;
        }

        .compact-cell-countdown {
            font-weight: 700;
            color: #f87171;
        }

        /* Small phones (up to 375px) */
        @media (max-width: 375px) {
            html {
                font-size: 16px;
            }

            h1 { font-size: 1.625rem !important; }
            h2 { font-size: 1.375rem !important; }

            .mobile-padding {
                padding: 1.25rem !important;
            }

            .tab-btn {
                padding: 0.625rem 0.375rem;
                font-size: 0.8125rem !important;
            }
        }

        /* ------------------------------------------
           2.11 SAFE AREA (Notched Devices)
           ------------------------------------------ */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(0px, env(safe-area-inset-left));
                padding-right: max(0px, env(safe-area-inset-right));
            }
        }

        /* ------------------------------------------
           2.12 UTILITIES
           ------------------------------------------ */
        .text-truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .scrollable {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .hidden {
            display: none !important;
        }

        /* Feature Info Collapsible Section - works same on all screen sizes */
        .feature-info-content {
            max-height: 0;
            padding: 0 1rem !important;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.3s ease, padding 0.3s ease, opacity 0.2s ease;
        }

        .expanded .feature-info-content {
            max-height: 500px;
            padding: 0 1rem 1rem 1rem !important;
            opacity: 1;
        }

        /* Glass morphism effect - OPTIMIZED: removed blur for performance */
        .glass {
            background: rgba(255, 255, 255, 0.15);
            /* REMOVED backdrop-filter for performance */
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Better selection colors */
        ::selection {
            background: rgba(124, 58, 237, 0.3);
            color: inherit;
        }

        /* Large screens - desktop optimizations */
        @media (min-width: 1280px) {
            /* Larger padding for cards on big screens */
            .card {
                padding: 3rem;
            }

            /* More gap in grids */
            .grid {
                gap: 1.5rem;
            }

            /* Wider form elements */
            .max-w-md {
                max-width: 30rem;
            }
        }

        @media (min-width: 1536px) {
            .card {
                padding: 3.5rem;
            }

            .max-w-md {
                max-width: 32rem;
            }
        }

        /* ------------------------------------------
           2.13 VELVET AURORA - Main Page Background
           ------------------------------------------
           A sophisticated animated background inspired by
           premium art galleries at dusk - warm ambient
           lighting mixing with cool shadows.
        */

        /* Base container - fixed behind all content */
        .velvet-aurora {
            position: fixed;
            inset: 0;
            z-index: -1;
            background: linear-gradient(
                145deg,
                #0f1419 0%,
                #121820 30%,
                #0d1117 60%,
                #101418 100%
            );
            overflow: hidden;
        }

        /* Grain texture overlay - editorial premium feel */
        .velvet-aurora::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='grain'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.7' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23grain)'/%3E%3C/svg%3E");
            opacity: 0.03;
            pointer-events: none;
            z-index: 2;
        }

        /* Orbs container */
        .velvet-orbs {
            position: absolute;
            inset: 0;
            overflow: hidden;
            z-index: 1;
        }

        /* Base orb styling - PERFORMANCE OPTIMIZED: No blur, no animations */
        .velvet-orb {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            /* REMOVED will-change - not animating anymore */
            /* REMOVED blur filters - major performance killer */
        }

        /* Warm coral/dusty rose - top-left region (closer/brighter) */
        .velvet-orb-coral {
            width: 70vmax;
            height: 70vmax;
            top: -20%;
            left: -15%;
            background: radial-gradient(
                circle at center,
                rgba(220, 120, 130, 0.35) 0%,
                rgba(200, 100, 110, 0.20) 25%,
                rgba(180, 85, 95, 0.08) 45%,
                transparent 65%
            );
            /* REMOVED: filter: blur(60px); - causes GPU thrashing */
            /* REMOVED: animation - continuous animations kill performance */
        }

        /* Soft amber/gold - accent glow (mid-depth) */
        .velvet-orb-amber {
            width: 55vmax;
            height: 55vmax;
            top: 5%;
            left: 20%;
            background: radial-gradient(
                circle at center,
                rgba(230, 180, 100, 0.30) 0%,
                rgba(215, 160, 85, 0.15) 30%,
                rgba(195, 140, 70, 0.05) 50%,
                transparent 65%
            );
            /* REMOVED: filter: blur(65px); */
            /* REMOVED: animation */
        }

        /* Muted lavender - center blend (mid-depth) */
        .velvet-orb-lavender {
            width: 60vmax;
            height: 60vmax;
            top: 25%;
            left: 30%;
            background: radial-gradient(
                circle at center,
                rgba(170, 140, 200, 0.25) 0%,
                rgba(155, 125, 185, 0.12) 30%,
                rgba(140, 110, 170, 0.05) 50%,
                transparent 65%
            );
            /* REMOVED: filter: blur(70px); */
            /* REMOVED: animation */
        }

        /* Deep teal/cyan - bottom-right region (closer/brighter) */
        .velvet-orb-teal {
            width: 75vmax;
            height: 75vmax;
            bottom: -25%;
            right: -20%;
            background: radial-gradient(
                circle at center,
                rgba(70, 180, 190, 0.35) 0%,
                rgba(55, 160, 170, 0.18) 25%,
                rgba(45, 140, 150, 0.08) 45%,
                transparent 65%
            );
            /* REMOVED: filter: blur(55px); */
            /* REMOVED: animation */
        }

        /* Secondary amber - subtle accent (further/dimmer) */
        .velvet-orb-amber-soft {
            width: 45vmax;
            height: 45vmax;
            bottom: 15%;
            left: 0%;
            background: radial-gradient(
                circle at center,
                rgba(215, 165, 100, 0.20) 0%,
                rgba(195, 145, 85, 0.08) 40%,
                transparent 65%
            );
            /* REMOVED: filter: blur(70px); */
            /* REMOVED: animation */
        }

        /* Secondary teal - distant accent (further/dimmer) */
        .velvet-orb-teal-soft {
            width: 50vmax;
            height: 50vmax;
            top: 0%;
            right: 5%;
            background: radial-gradient(
                circle at center,
                rgba(65, 165, 175, 0.22) 0%,
                rgba(50, 145, 155, 0.10) 35%,
                transparent 60%
            );
            /* REMOVED: filter: blur(65px); */
            /* REMOVED: animation */
        }

        /* DISABLED: Smooth drift animations - caused severe performance issues
        @keyframes velvetDrift1 {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            25% {
                transform: translate(15%, 10%) scale(1.08);
            }
            50% {
                transform: translate(5%, 20%) scale(0.95);
            }
            75% {
                transform: translate(-10%, 12%) scale(1.03);
            }
        }

        @keyframes velvetDrift2 {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            20% {
                transform: translate(-18%, 12%) scale(0.9);
            }
            50% {
                transform: translate(8%, 25%) scale(1.12);
            }
            75% {
                transform: translate(20%, -8%) scale(0.95);
            }
        }

        @keyframes velvetDrift3 {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            33% {
                transform: translate(-15%, -18%) scale(1.15);
            }
            66% {
                transform: translate(18%, 10%) scale(0.88);
            }
        }

        @keyframes velvetDrift4 {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            30% {
                transform: translate(-20%, -15%) scale(1.1);
            }
            65% {
                transform: translate(-8%, 12%) scale(0.92);
            }
        }

        @keyframes velvetDrift5 {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            35% {
                transform: translate(25%, -15%) scale(1.2);
            }
            70% {
                transform: translate(-12%, 20%) scale(0.85);
            }
        }

        @keyframes velvetDrift6 {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            40% {
                transform: translate(-12%, 22%) scale(0.88);
            }
            75% {
                transform: translate(15%, -12%) scale(1.15);
            }
        }
        END OF DISABLED ANIMATIONS */

        /* Accessibility: Respect reduced motion preference - kept for future use */
        @media (prefers-reduced-motion: reduce) {
            .velvet-orb,
            .aurora-orb,
            .living-aurora::before {
                animation: none !important;
            }
        }

        /* ------------------------------------------
           PWA Install Button - Add to Home Screen
           ------------------------------------------ */
        .a2hs-native-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            color: white;
            border: none;
            padding: 16px 28px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
            display: none;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .a2hs-native-button.show {
            display: flex;
        }

        .a2hs-native-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(124, 58, 237, 0.5);
        }

        .a2hs-native-button:active {
            transform: translateY(0);
        }

        .a2hs-icon {
            font-size: 20px;
        }

        @media (max-width: 768px) {
            .a2hs-native-button {
                bottom: 15px;
                right: 15px;
                left: 15px;
                justify-content: center;
                padding: 18px 24px;
            }
        }
    </style>
</head>

<body>
    <!-- ============================================
         VELVET AURORA - Animated Background
         ============================================ -->
    <div class="velvet-aurora" aria-hidden="true">
        <div class="velvet-orbs">
            <!-- Closer/brighter orbs -->
            <div class="velvet-orb velvet-orb-coral"></div>
            <div class="velvet-orb velvet-orb-teal"></div>
            <!-- Mid-depth orbs -->
            <div class="velvet-orb velvet-orb-amber"></div>
            <div class="velvet-orb velvet-orb-lavender"></div>
            <!-- Further/dimmer orbs -->
            <div class="velvet-orb velvet-orb-amber-soft"></div>
            <div class="velvet-orb velvet-orb-teal-soft"></div>
        </div>
    </div>

    <!-- ============================================
         SECTION 3: HTML VIEWS
         ============================================

         All views are rendered dynamically into #app-root
         See render functions in Section 4.5
         ============================================ -->
    <div id="app-root"></div>

    <!-- ============================================
         SECTION 4: SCRIPTS
         ============================================ -->
    <script>
    (function() {
        'use strict';

        /* ==========================================
           4.1 FIREBASE CONFIGURATION
           ========================================== */

        // Simple Firebase check - no error screen, just wait patiently
        // Firebase scripts are in <head>, they will load
        function waitForFirebase() {
            if (typeof firebase !== 'undefined') {
                runApp();
            } else {
                setTimeout(waitForFirebase, 50);
            }
        }

        // Check immediately, poll if not ready
        if (typeof firebase !== 'undefined') {
            runApp();
        } else {
            waitForFirebase();
        }

        function runApp() {

        // Platform Version
        const PLATFORM_VERSION = '1.0.3';

        // Firebase project configuration
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAGczY5ZEIJdTq25BpQdia3lv2I556wOZo",
            authDomain: "ytseo-6d1b0.firebaseapp.com",
            projectId: "ytseo-6d1b0",
            storageBucket: "ytseo-6d1b0.firebasestorage.app",
            messagingSenderId: "382790048044",
            appId: "1:382790048044:web:cd427679ff72108c1f3489"
        };

        // Initialize Firebase
        firebase.initializeApp(FIREBASE_CONFIG);
        const auth = firebase.auth();
        const functions = firebase.functions();
        const db = firebase.firestore();

        // Enable offline persistence for faster loading
        db.enablePersistence({ synchronizeTabs: true })
            .catch(function(err) {
                if (err.code === 'failed-precondition') {
                    console.log('Persistence failed: Multiple tabs open');
                } else if (err.code === 'unimplemented') {
                    console.log('Persistence not supported by browser');
                }
            });

        // Real-time notification listener unsubscribe function
        let notificationUnsubscribe = null;

        /* ==========================================
           4.2 APPLICATION STATE
           ========================================== */

        const state = {
            // Current view: initializing | login | register | forgot-password | dashboard | optimizer | results | history | admin | competitor | trends | thumbnail
            currentView: 'initializing',

            // App initialization state
            initializing: true,

            // User data
            user: null,
            profile: null,
            isAdmin: false,

            // UI state
            loading: false,
            error: null,
            success: null,

            // Loading progress state
            loadingProgress: 0,
            loadingStep: 0,
            loadingSteps: [
                { name: 'Fetching video data', icon: '' },
                { name: 'Analyzing content', icon: '' },
                { name: 'Generating titles', icon: '' },
                { name: 'Writing description', icon: '' },
                { name: 'Creating tags', icon: '' },
                { name: 'Calculating SEO score', icon: '' }
            ],
            loadingInterval: null,

            // Results page
            currentResults: null,    // Current optimization results
            resultsTab: 'titles',    // Current tab: titles | description | tags

            // History/Admin data
            historyData: null,       // List of past optimizations
            historyTab: 'all',       // Current history tab: 'all', 'optimization', 'competitor', 'trend', 'thumbnail', 'placement'
            allHistory: null,        // Combined history from all types
            competitorHistory: null, // Competitor analysis history
            trendHistory: null,      // Trend predictor history
            thumbnailHistory: null,  // Thumbnail history
            placementHistory: null,  // Placement Finder history
            historyCounts: null,     // Counts for each history type
            adminUsers: null,        // Admin user list
            adminLoading: false,

            // New features state
            competitorResults: null,  // Competitor analysis results
            trendResults: null,       // Trend prediction results
            thumbnailJob: null,       // Thumbnail generation job
            thumbnailStatus: null,    // Thumbnail job status
            thumbnailImage: null,     // Generated thumbnail URL

            // Channel Audit Pro state
            channelAuditResults: null,  // Channel audit results
            channelAuditLoading: false, // Loading state for channel audit
            channelAuditHistory: null,  // Channel audit history

            // Thumbnail from optimizer context
            lastOptimization: null,   // Last optimization results for thumbnail context
            thumbnailStyle: 'professional', // professional | dramatic | minimal | bold
            thumbnailFromOptimizer: false,   // Flag if user came from optimizer results

            // Thumbnail Pro - Enhanced thumbnail generator
            thumbnailMode: 'quick', // quick | reference | upgrade
            thumbnailCategory: 'general', // general | gaming | tutorial | vlog | review | news | entertainment
            thumbnailVariations: 1, // 1-4 variations
            thumbnailReference: null, // { dataUrl, file, mimeType, name }

            // Phase 8: Advanced Reference Settings
            thumbnailReferenceType: 'auto', // auto | face | product | style | background
            thumbnailComposition: 'auto', // auto | face-right | face-center | split-screen | product-hero | action-shot | collage
            thumbnailFaceStrength: 0.85, // 0.5 - 1.0 (face preservation strength)
            thumbnailStyleStrength: 0.7, // 0.5 - 1.0 (style transfer strength)
            thumbnailExpression: 'keep', // keep | excited | serious | surprised | curious | confident
            thumbnailBackground: 'auto', // auto | studio | blur | gradient | contextual | dark | vibrant
            showAdvancedOptions: false, // Toggle for advanced options panel
            thumbnailTokenBalance: 50, // Token balance from creativeTokens (default like Creative Studio)
            thumbnailTokenPlan: 'free', // User's subscription plan
            thumbnailTokenRollover: 0, // Rollover tokens from previous month
            thumbnailTokenCost: 2, // Calculated cost
            showTokenModal: false, // Token usage modal visibility
            generatedThumbnails: [], // Array of generated thumbnails for multi-variation
            selectedThumbnailIndex: 0, // Currently selected thumbnail from variations
            showYouTubePreview: false, // YouTube preview modal visibility

            // Thumbnail Upgrade - YouTube URL Feature
            thumbnailUpgradeMode: 'upload', // 'upload' or 'youtube' or 'bulk'
            thumbnailYoutubeUrl: '',
            thumbnailYoutubeData: null, // { videoId, title, description, channelName, thumbnailUrl, tags }
            thumbnailYoutubeLoading: false,
            thumbnailYoutubeError: null,
            thumbnailTitle: '', // Auto-filled from YouTube or manual entry
            titleAutoFilled: false, // Flag to show "From YouTube" indicator

            // Bulk Mode State
            bulkUrls: [], // Array of { id, url, status, youtubeData, generatedThumbnail, error }
            bulkMaxItems: 10,
            bulkProcessing: false,
            bulkCurrentIndex: 0,
            bulkIdCounter: 0,

            // Playlist Mode State
            playlistUrl: '',
            playlistData: null, // { playlistId, playlistTitle, channelName, videos: [] }
            playlistLoading: false,
            playlistError: null,
            playlistSelectedVideos: [], // Array of videoIds that are selected
            playlistProcessing: false,
            playlistCurrentIndex: 0,
            playlistResults: [], // Array of { videoId, status, thumbnailUrl, error }

            // Face Lock State (for bulk/playlist modes)
            faceReferenceEnabled: false,          // Toggle for face lock feature
            faceReferenceSource: 'first',         // 'first' | 'upload' | 'select'
            faceReferenceImage: null,             // { dataUrl, base64, mimeType }
            faceReferenceVideoIndex: 0,           // Which video to use as face source
            faceReferenceLoading: false,          // Loading state when fetching face

            // HD Upscale State
            hdUpscaleLoading: false,              // Loading state for upscale operations
            hdUpscalingIndex: null,               // Index of item currently being upscaled
            hdUpscalingMode: null,                // Mode of item being upscaled ('single'|'bulk'|'playlist')
            hdUpscaleCost: 1,                     // Cost per image (tokens)

            // Thumbnail Editing State (AI Inpainting)
            thumbnailEditMode: false,             // Is editing modal open
            thumbnailEditingImage: null,          // { url, index, mode } - image being edited
            thumbnailEditMask: null,              // Canvas mask data URL
            thumbnailEditPrompt: '',              // Edit prompt text
            thumbnailEditLoading: false,          // Processing state
            thumbnailEditError: null,             // Error message
            thumbnailEditResult: null,            // { originalUrl, editedUrl } - result for comparison
            thumbnailEditBrushSize: 30,           // Brush size in pixels
            thumbnailEditHistory: [],             // For undo functionality
            thumbnailEditOriginalData: null,      // Original canvas image data
            thumbnailEditMaskCanvas: null,        // Mask canvas element
            thumbnailEditMaskCtx: null,           // Mask canvas 2D context

            // Quota settings (from getUserProfile)
            quotaInfo: null,           // Quota info for each tool with reset times
            resetTimeMinutes: 1440,    // Admin-configured reset time in minutes
            countdownInterval: null,    // Interval for countdown timer

            // Quota Bypass Modal (use tokens to skip wait)
            showQuotaBypassModal: false,
            quotaBypassData: null,     // { tool, toolName, tokenCost, tokenBalance, remainingMs, canBypass, pendingAction }

            // Token Modal (unified token display and management)
            showTokenModal: false,
            tokenBypassCosts: null,    // Admin-configured token costs per tool

            // Admin settings
            adminQuotaSettings: null,   // For admin panel
            adminSelectedUser: null,    // Selected user for bonus uses

            // Bonus history
            bonusHistory: null,         // User's bonus history
            showBonusHistory: false,    // Modal visibility

            // Campaign Reports (Admin feature)
            campaignReports: null,       // List of all reports (admin view)
            clientReports: null,         // Reports for current user
            currentReport: null,         // Report being viewed/edited
            reportImages: [],            // Images for new report
            reportAnalysis: null,        // AI analysis result
            reportLoading: false,        // Loading state for report operations
            editingReport: null,         // Report being edited

            // Unified Notifications System
            notifications: [],           // Campaign report notifications (from Firestore listener)
            unreadCount: 0,              // Unread report notification count
            userNotifications: null,      // User notifications { notifications: [], unreadCount: 0 }
            userNotificationsLoading: false, // Loading state for user notifications
            showNotifications: false,    // Unified notification dropdown visibility
            notificationTab: 'reports',  // Current tab: 'reports' | 'alerts'

            // Dashboard Recent Activity
            dashboardRecentActivity: null, // Recent activity items for dashboard widget
            dashboardActivityLoading: false, // Loading state for recent activity

            // Renewal Request state
            showRenewalModal: false,      // Renewal request modal visibility
            renewalForm: {                // Form data for renewal request
                preferredPlan: 'pro',
                preferredDuration: 'month',
                message: ''
            },
            renewalRequests: [],          // User's renewal requests
            renewalSubmitting: false,     // Submitting state

            // Report modals
            sendModalReportId: null,     // Report ID for send modal

            // Lightbox state
            lightboxOpen: false,         // Is lightbox open
            lightboxImages: [],          // Array of image URLs
            lightboxIndex: 0             // Current image index
        };

        /* ==========================================
           4.2.5 TIME-AWARE AURORA COLOR SYSTEM
           ========================================== */

        // Get time-based aurora theme class
        function getAuroraTimeClass() {
            var hour = new Date().getHours();

            // Morning: 6am-12pm (warm, energetic)
            if (hour >= 6 && hour < 12) {
                return 'aurora-morning';
            }
            // Afternoon: 12pm-6pm (productive, green)
            else if (hour >= 12 && hour < 18) {
                return 'aurora-afternoon';
            }
            // Evening: 6pm-9pm (sunset, warm)
            else if (hour >= 18 && hour < 21) {
                return 'aurora-evening';
            }
            // Night: 9pm-6am (calm, purple)
            else {
                return 'aurora-night';
            }
        }

        // Update all aurora elements with time-aware theme
        function updateAuroraTheme() {
            var auroraElements = document.querySelectorAll('.living-aurora');
            var timeClass = getAuroraTimeClass();

            auroraElements.forEach(function(el) {
                // Remove existing time classes
                el.classList.remove('aurora-morning', 'aurora-afternoon', 'aurora-evening', 'aurora-night');

                // Only add time class if element doesn't have a specific theme
                if (!el.classList.contains('aurora-emerald') && !el.classList.contains('aurora-gold') && !el.classList.contains('aurora-creative')) {
                    el.classList.add(timeClass);
                }
            });
        }

        // Schedule aurora theme updates (every hour)
        function scheduleAuroraUpdates() {
            // Update immediately
            updateAuroraTheme();

            // Calculate time until next hour
            var now = new Date();
            var msUntilNextHour = (60 - now.getMinutes()) * 60 * 1000 - now.getSeconds() * 1000;

            // Update at the top of each hour
            setTimeout(function() {
                updateAuroraTheme();
                // Then set regular hourly interval
                setInterval(updateAuroraTheme, 60 * 60 * 1000);
            }, msUntilNextHour);
        }

        // Initialize aurora theme on load
        scheduleAuroraUpdates();

        // Loading progress simulation - OPTIMIZED to prevent flickering
        // Adjusted timing to match ~90 second RunPod processing time
        function startLoadingProgress() {
            state.loadingProgress = 0;
            state.loadingStep = 0;

            if (state.loadingInterval) {
                clearInterval(state.loadingInterval);
            }

            state.loadingInterval = setInterval(function() {
                if (state.loadingProgress < 95) {
                    // Simulate realistic progress with slower speeds to match ~90s RunPod processing
                    // 0-30%: Initial analysis (fast) - ~10 seconds
                    // 30-60%: AI prompt creation (medium) - ~15 seconds
                    // 60-85%: Image generation (slow) - ~45 seconds (main RunPod work)
                    // 85-95%: Rendering HD (very slow) - ~20 seconds
                    var increment;
                    if (state.loadingProgress < 30) {
                        increment = Math.random() * 2 + 1; // Fast start: 1-3%
                    } else if (state.loadingProgress < 60) {
                        increment = Math.random() * 1.2 + 0.3; // Medium: 0.3-1.5%
                    } else if (state.loadingProgress < 85) {
                        increment = Math.random() * 0.4 + 0.1; // Slow: 0.1-0.5%
                    } else {
                        increment = Math.random() * 0.2 + 0.05; // Very slow: 0.05-0.25%
                    }

                    state.loadingProgress = Math.min(95, state.loadingProgress + increment);

                    // Update current step based on progress (4 steps to match UI)
                    if (state.loadingProgress < 25) state.loadingStep = 0;      // Analyzing video context
                    else if (state.loadingProgress < 50) state.loadingStep = 1; // Creating AI prompt
                    else if (state.loadingProgress < 80) state.loadingStep = 2; // Generating image
                    else state.loadingStep = 3;                                  // Rendering HD

                    // OPTIMIZED: Only update specific elements instead of full render
                    updateLoadingUI();
                }
            }, 1000); // Increased interval from 500ms to 1000ms for slower progress
        }

        // Targeted loading UI update to prevent flickering
        function updateLoadingUI() {
            // Update percentage display
            var percentEls = document.querySelectorAll('.progress-percentage');
            percentEls.forEach(function(el) {
                el.textContent = Math.round(state.loadingProgress) + '%';
            });

            // Update progress bar
            var barEls = document.querySelectorAll('.progress-bar-fill');
            barEls.forEach(function(el) {
                el.style.width = state.loadingProgress + '%';
            });

            // Update step icons
            var stepEls = document.querySelectorAll('.loading-step');
            stepEls.forEach(function(el, index) {
                var iconEl = el.querySelector('.step-icon');
                if (index < state.loadingStep) {
                    el.className = 'loading-step completed';
                    if (iconEl) {
                        iconEl.className = 'step-icon completed';
                        iconEl.textContent = '';
                    }
                } else if (index === state.loadingStep) {
                    el.className = 'loading-step active';
                    if (iconEl) {
                        iconEl.className = 'step-icon active';
                    }
                }
            });
        }

        function stopLoadingProgress() {
            if (state.loadingInterval) {
                clearInterval(state.loadingInterval);
                state.loadingInterval = null;
            }
            state.loadingProgress = 100;
            state.loadingStep = state.loadingSteps.length - 1;
        }

        // Countdown timer for quota reset - OPTIMIZED
        var cachedCountdownElements = null;

        function startCountdownTimer() {
            if (state.countdownInterval) {
                clearInterval(state.countdownInterval);
            }
            // Clear cache when starting new timer
            cachedCountdownElements = null;
            state.countdownInterval = setInterval(function() {
                updateCountdownDisplays();
            }, 1000);
        }

        function updateCountdownDisplays() {
            // Cache DOM elements - only query once per view
            if (!cachedCountdownElements) {
                cachedCountdownElements = document.querySelectorAll('.quota-countdown');
            }
            // If no countdown elements, clear interval to save resources
            if (!cachedCountdownElements || cachedCountdownElements.length === 0) {
                return;
            }
            var now = Date.now();
            cachedCountdownElements.forEach(function(el) {
                var resetAt = parseInt(el.getAttribute('data-reset-at'));
                if (resetAt) {
                    var remaining = Math.max(0, resetAt - now);
                    if (remaining > 0) {
                        var hours = Math.floor(remaining / 3600000);
                        var minutes = Math.floor((remaining % 3600000) / 60000);
                        var seconds = Math.floor((remaining % 60000) / 1000);
                        var timeStr = '';
                        if (hours > 0) timeStr += hours + 'h ';
                        if (minutes > 0 || hours > 0) timeStr += minutes + 'm ';
                        timeStr += seconds + 's';
                        el.textContent = timeStr;
                    } else {
                        el.textContent = 'Ready!';
                        el.classList.add('text-green-500');
                    }
                }
            });
        }

        function formatCountdown(ms) {
            if (ms <= 0) return 'Ready!';
            var hours = Math.floor(ms / 3600000);
            var minutes = Math.floor((ms % 3600000) / 60000);
            var seconds = Math.floor((ms % 60000) / 1000);
            var parts = [];
            if (hours > 0) parts.push(hours + 'h');
            if (minutes > 0 || hours > 0) parts.push(minutes + 'm');
            parts.push(seconds + 's');
            return parts.join(' ');
        }

        /* ==========================================
           4.3 UTILITY FUNCTIONS
           ========================================== */

        const utils = {
            /**
             * Format large numbers (e.g., 1500000 -> 1.5M)
             */
            formatNumber: function(n) {
                if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
                if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
                return String(n);
            },

            /**
             * Calculate usage percentage
             */
            getUsagePercent: function(used, limit) {
                return Math.min(100, Math.round((used / limit) * 100));
            },

            /**
             * Get color class based on usage percentage
             */
            getUsageColor: function(percent) {
                if (percent >= 80) return 'bg-red-500';
                if (percent >= 60) return 'bg-yellow-500';
                return 'bg-green-500';
            },

            /**
             * Validate email format
             */
            validateEmail: function(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            },

            /**
             * Escape HTML special characters
             */
            escapeHtml: function(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            /**
             * Escape string for use in JavaScript
             */
            escapeJs: function(text) {
                return String(text)
                    .replace(/\\/g, '\\\\')
                    .replace(/'/g, "\\'")
                    .replace(/"/g, '\\"')
                    .replace(/\n/g, '\\n')
                    .replace(/\r/g, '\\r');
            },

            /**
             * Format date for display
             */
            formatDate: function(timestamp) {
                const date = new Date(timestamp);
                return {
                    date: date.toLocaleDateString(),
                    time: date.toLocaleTimeString()
                };
            },

            /**
             * Format timestamp as relative time (e.g., "2 hours ago")
             */
            formatTimeAgo: function(timestamp) {
                if (!timestamp) return 'Recently';
                const now = Date.now();
                const time = typeof timestamp === 'number' ? timestamp : new Date(timestamp).getTime();
                const diff = now - time;

                const seconds = Math.floor(diff / 1000);
                const minutes = Math.floor(seconds / 60);
                const hours = Math.floor(minutes / 60);
                const days = Math.floor(hours / 24);
                const weeks = Math.floor(days / 7);
                const months = Math.floor(days / 30);

                if (months > 0) return months === 1 ? '1 month ago' : months + ' months ago';
                if (weeks > 0) return weeks === 1 ? '1 week ago' : weeks + ' weeks ago';
                if (days > 0) return days === 1 ? 'Yesterday' : days + ' days ago';
                if (hours > 0) return hours === 1 ? '1 hour ago' : hours + ' hours ago';
                if (minutes > 0) return minutes === 1 ? '1 min ago' : minutes + ' mins ago';
                return 'Just now';
            }
        };

        /* ==========================================
           4.4 AUTH & API FUNCTIONS
           ========================================== */

        // Start real-time notification listener
        function startNotificationListener(userId) {
            // Stop any existing listener
            stopNotificationListener();

            // Listen for unread notifications in real-time
            notificationUnsubscribe = db.collection('userNotifications')
                .where('userId', '==', userId)
                .where('isRead', '==', false)
                .orderBy('createdAt', 'desc')
                .limit(20)
                .onSnapshot(function(snapshot) {
                    var previousCount = state.unreadCount;
                    var notifications = [];

                    snapshot.forEach(function(doc) {
                        var data = doc.data();
                        notifications.push({
                            id: doc.id,
                            type: data.type,
                            reportId: data.reportId,
                            title: data.title,
                            message: data.message,
                            isRead: data.isRead,
                            createdAt: data.createdAt ? (data.createdAt.toDate ? data.createdAt.toDate().toISOString() : data.createdAt) : null
                        });
                    });

                    state.notifications = notifications;
                    state.unreadCount = notifications.length;

                    // If new notifications arrived, trigger attention animation
                    if (notifications.length > previousCount && previousCount >= 0) {
                        triggerNotificationAttention();
                    }

                    // OPTIMIZATION: Only update notification badge, NOT full render
                    // This prevents flickering caused by full DOM replacement
                    updateNotificationBadge(previousCount, notifications.length);
                }, function(error) {
                    console.error('Notification listener error:', error);
                });
        }

        // Stop real-time notification listener
        function stopNotificationListener() {
            if (notificationUnsubscribe) {
                notificationUnsubscribe();
                notificationUnsubscribe = null;
            }
        }

        // Trigger attention animation for new notifications
        function triggerNotificationAttention() {
            var badge = document.querySelector('.notification-badge');
            if (badge) {
                badge.classList.add('notification-new');
                setTimeout(function() {
                    badge.classList.remove('notification-new');
                }, 3000);
            }
        }

        // OPTIMIZATION: Update notification badge without full render
        // This prevents flickering by doing targeted DOM updates
        function updateNotificationBadge(previousCount, newCount) {
            // Only update if count actually changed
            if (previousCount === newCount) return;

            // Update notification badge in header
            var badge = document.querySelector('.notification-badge');
            if (badge) {
                if (newCount > 0) {
                    badge.textContent = newCount > 99 ? '99+' : newCount;
                    badge.style.display = '';
                } else {
                    badge.style.display = 'none';
                }
            }

            // Update unread count on dashboard card
            var dashboardBadge = document.querySelector('.dashboard-card .notification-dot');
            if (dashboardBadge) {
                var countSpan = dashboardBadge.parentElement.querySelector('span:last-child');
                if (countSpan && newCount > 0) {
                    countSpan.textContent = newCount;
                }
            }
        }

        // Auth state listener
        auth.onAuthStateChanged(async function(user) {
            var wasInitializing = state.initializing;
            state.initializing = false;

            if (user) {
                state.user = user;
                try {
                    const result = await functions.httpsCallable('getUserProfile')();
                    state.profile = result.data.profile;
                    state.quotaInfo = result.data.quotaInfo || null;
                    state.resetTimeMinutes = result.data.resetTimeMinutes || 1440;
                    // Check admin status
                    state.isAdmin = state.profile.isAdmin === true;
                    // Start countdown timer if on dashboard
                    startCountdownTimer();
                    // Start real-time notification listener
                    startNotificationListener(user.uid);
                    // Redirect to dashboard if coming from initializing, login, or register
                    if (wasInitializing || state.currentView === 'login' || state.currentView === 'register' || state.currentView === 'initializing') {
                        state.currentView = 'dashboard';
                    }
                    render();
                } catch (e) {
                    state.error = 'Failed to load profile';
                    state.currentView = 'login';
                    render();
                }
            } else {
                // Stop notification listener on logout
                stopNotificationListener();
                state.user = null;
                state.profile = null;
                state.isAdmin = false;
                state.notifications = [];
                state.unreadCount = 0;
                if (state.currentView !== 'register' && state.currentView !== 'forgot-password') {
                    state.currentView = 'login';
                }
                render();
            }
        });

        /* ==========================================
           4.4.1 Toast Notifications
           ========================================== */
        function showToast(message, type) {
            type = type || 'info';
            var toast = document.createElement('div');
            toast.className = 'toast-notification toast-' + type;
            toast.textContent = message;

            // Apply styles inline for simplicity
            toast.style.cssText = 'position:fixed;bottom:20px;right:20px;padding:12px 24px;border-radius:8px;color:#fff;font-size:14px;font-weight:500;z-index:100000;opacity:0;transition:opacity 0.3s ease;box-shadow:0 4px 12px rgba(0,0,0,0.3);max-width:350px;';

            if (type === 'success') {
                toast.style.backgroundColor = '#10b981';
            } else if (type === 'error') {
                toast.style.backgroundColor = '#ef4444';
            } else {
                toast.style.backgroundColor = '#6366f1';
            }

            document.body.appendChild(toast);

            // Trigger animation
            setTimeout(function() { toast.style.opacity = '1'; }, 10);

            // Auto remove
            setTimeout(function() {
                toast.style.opacity = '0';
                setTimeout(function() {
                    if (toast.parentNode) toast.parentNode.removeChild(toast);
                }, 300);
            }, type === 'error' ? 5000 : 3000);
        }

        /* ==========================================
           4.5 APP ACTIONS (Global)
           ========================================== */

        window.app = {

            /* ------------------------------------------
               4.5.1 Navigation Actions
               ------------------------------------------ */

            goToLogin: function() {
                state.currentView = 'login';
                state.error = null;
                state.success = null;
                render();
            },

            goToRegister: function() {
                state.currentView = 'register';
                state.error = null;
                state.success = null;
                render();
            },

            goToForgotPassword: function() {
                state.currentView = 'forgot-password';
                state.error = null;
                state.success = null;
                render();
            },

            goToDashboard: function(skipRefresh) {
                state.currentView = 'dashboard';
                state.error = null;
                state.showNotifications = false;

                // Show dashboard immediately with cached/loading state
                render();

                // Refresh all data in parallel unless explicitly skipped
                if (!skipRefresh && state.user) {
                    // Set loading states (no render - will be picked up by batched render)
                    state.dashboardActivityLoading = true;
                    state.userNotificationsLoading = true;

                    // Batch all API calls with Promise.all to prevent multiple renders
                    Promise.all([
                        functions.httpsCallable('getUserProfile')().catch(function(e) {
                            console.warn('Failed to refresh profile:', e);
                            return null;
                        }),
                        functions.httpsCallable('getAllHistory')({ limit: 5 }).catch(function(e) {
                            console.warn('Failed to load recent activity:', e);
                            return null;
                        }),
                        functions.httpsCallable('userGetNotifications')({ limit: 20 }).catch(function(e) {
                            console.warn('Failed to load user notifications:', e);
                            return null;
                        }),
                        functions.httpsCallable('getUnreadNotifications')({}).catch(function(e) {
                            console.warn('Failed to load notifications:', e);
                            return null;
                        })
                    ]).then(function(results) {
                        // Update all state at once from batched results
                        var profileResult = results[0];
                        var historyResult = results[1];
                        var userNotifResult = results[2];
                        var notifResult = results[3];

                        // Profile data
                        if (profileResult && profileResult.data) {
                            state.profile = profileResult.data.profile;
                            state.quotaInfo = profileResult.data.quotaInfo || null;
                            state.resetTimeMinutes = profileResult.data.resetTimeMinutes || 1440;
                            state.isAdmin = state.profile.isAdmin === true;
                            startCountdownTimer();
                        }

                        // Recent activity
                        if (historyResult && historyResult.data) {
                            state.dashboardRecentActivity = (historyResult.data.history.all || []).slice(0, 5);
                        } else {
                            state.dashboardRecentActivity = [];
                        }
                        state.dashboardActivityLoading = false;

                        // User notifications (backend)
                        if (userNotifResult && userNotifResult.data) {
                            state.userNotifications = {
                                notifications: userNotifResult.data.notifications || [],
                                unreadCount: userNotifResult.data.unreadCount || 0
                            };
                        }
                        state.userNotificationsLoading = false;

                        // Unread notifications (for badge - but real-time listener handles this too)
                        if (notifResult && notifResult.data && notifResult.data.success) {
                            // Only update if real-time listener hasn't already
                            if (state.notifications.length === 0) {
                                state.notifications = notifResult.data.notifications || [];
                                state.unreadCount = notifResult.data.unreadCount || 0;
                            }
                        }

                        // Single render after all data is loaded
                        render();
                    });
                }
            },

            // Standalone loader for when dashboard is already visible
            loadDashboardActivity: function() {
                state.dashboardActivityLoading = true;
                functions.httpsCallable('getAllHistory')({ limit: 5 })
                    .then(function(result) {
                        var data = result.data;
                        state.dashboardRecentActivity = (data.history.all || []).slice(0, 5);
                        state.dashboardActivityLoading = false;
                        render();
                    })
                    .catch(function(e) {
                        console.warn('Failed to load recent activity:', e);
                        state.dashboardActivityLoading = false;
                        state.dashboardRecentActivity = [];
                    });
            },

            goToOptimizer: function() {
                state.currentView = 'optimizer';
                state.error = null;
                render();
            },

            goToResults: function() {
                state.currentView = 'results';
                state.error = null;
                render();
            },

            goToHistory: function(tab) {
                state.currentView = 'history';
                state.error = null;
                state.loading = true;
                state.historyTab = tab || 'all';
                state.allHistory = null;
                state.historyData = null;
                state.competitorHistory = null;
                state.trendHistory = null;
                state.thumbnailHistory = null;
                state.placementHistory = null;
                state.channelAuditHistory = null;
                state.historyCounts = null;
                render();

                // Fetch all history from backend
                functions.httpsCallable('getAllHistory')({ limit: 20 })
                    .then(function(result) {
                        var data = result.data;
                        state.allHistory = data.history.all || [];
                        state.historyData = data.history.optimizations || [];
                        state.competitorHistory = data.history.competitor || [];
                        state.trendHistory = data.history.trends || [];
                        state.thumbnailHistory = data.history.thumbnails || [];
                        state.placementHistory = data.history.placements || [];
                        state.channelAuditHistory = data.history.channelAudit || [];
                        state.historyCounts = data.counts || {};
                        state.loading = false;
                        render();
                    })
                    .catch(function(e) {
                        state.loading = false;
                        state.error = 'Failed to load history';
                        render();
                    });
            },

            setHistoryTab: function(tab) {
                state.historyTab = tab;
                render();
            },

            goToCompetitor: function() {
                state.currentView = 'competitor';
                state.error = null;
                state.competitorResults = null;
                render();
            },

            goToTrends: function() {
                state.currentView = 'trends';
                state.error = null;
                state.trendResults = null;
                render();
            },

            goToThumbnail: function(fromOptimizer) {
                state.currentView = 'thumbnail';
                state.error = null;
                state.thumbnailJob = null;
                state.thumbnailStatus = null;
                state.thumbnailImage = null;
                state.thumbnailFromOptimizer = fromOptimizer === true;
                // Reset Thumbnail Pro state
                state.generatedThumbnails = [];
                state.selectedThumbnailIndex = 0;
                state.thumbnailReference = null;
                state.showYouTubePreview = false;
                // Load token balance
                app.loadThumbnailTokenBalance();
                render();
            },

            goToPlacement: function() {
                state.currentView = 'placement';
                state.error = null;
                state.placementResults = null;
                state.placementLoading = false;
                render();
            },

            goToChannelAudit: function() {
                state.currentView = 'channelAudit';
                state.error = null;
                state.channelAuditResults = null;
                state.channelAuditLoading = false;
                render();
            },

            goToMoreTools: function() {
                // Navigate to AI Tools Hub page
                window.location.href = '/aitools';
            },

            runChannelAudit: function(e) {
                e.preventDefault();
                var channelUrl = document.getElementById('audit-channel-url').value.trim();

                if (!channelUrl) {
                    state.error = { message: 'Please enter a YouTube channel URL' };
                    render();
                    return;
                }

                state.channelAuditLoading = true;
                state.loading = true;
                state.error = null;
                state.loadingSteps = [
                    { name: 'Fetching channel data', icon: '' },
                    { name: 'Analyzing content strategy', icon: '' },
                    { name: 'Evaluating SEO health', icon: '' },
                    { name: 'Checking engagement metrics', icon: '' },
                    { name: 'Identifying growth opportunities', icon: '' },
                    { name: 'Generating recommendations', icon: '' }
                ];
                startLoadingProgress();
                render();

                functions.httpsCallable('auditChannel')({ channelUrl: channelUrl })
                    .then(function(result) {
                        stopLoadingProgress();
                        state.channelAuditResults = result.data;
                        state.channelAuditLoading = false;
                        state.loading = false;
                        render();
                    })
                    .catch(function(e) {
                        stopLoadingProgress();
                        state.channelAuditLoading = false;
                        state.loading = false;
                        // Check for token bypass option
                        if (e.code === 'functions/resource-exhausted' && e.details && e.details.tokenBypass && e.details.tokenBypass.available) {
                            app.showQuotaBypassModal(
                                e.details.toolType || 'channelAudit',
                                'Channel Audit',
                                e.details,
                                function() { app.auditChannel({ preventDefault: function(){} }); }
                            );
                            return;
                        }
                        state.error = { message: 'Failed to audit channel: ' + e.message };
                        render();
                    });
            },

            viewPlacementHistory: function(id) {
                // Find the item from history
                var item = (state.allHistory || []).find(function(h) { return h.id === id && h.type === 'placement'; });
                if (!item && state.placementHistory) {
                    item = state.placementHistory.find(function(h) { return h.id === id; });
                }
                if (item) {
                    state.placementResults = {
                        historyId: item.id,
                        channelInfo: item.channelInfo,
                        analysis: item.analysis,
                        placements: item.placements || [],
                        totalFound: item.totalFound || 0,
                        maxAllowed: 50
                    };
                    state.currentView = 'placement';
                    render();
                }
            },

            viewChannelAuditHistory: function(id) {
                // Find the item from history
                var item = (state.allHistory || []).find(function(h) { return h.id === id && h.type === 'channelAudit'; });
                if (!item && state.channelAuditHistory) {
                    item = state.channelAuditHistory.find(function(h) { return h.id === id; });
                }
                if (item) {
                    state.channelAuditResults = {
                        historyId: item.id,
                        channelInfo: item.channelInfo,
                        scores: item.scores,
                        analysis: item.analysis,
                        recommendations: item.recommendations,
                        metrics: item.metrics
                    };
                    state.currentView = 'channelAudit';
                    render();
                }
            },

            // Bonus history modal functions
            openBonusHistory: function() {
                state.showBonusHistory = true;
                state.bonusHistory = null;
                render();

                // Fetch bonus history from backend
                functions.httpsCallable('getBonusHistory')()
                    .then(function(result) {
                        state.bonusHistory = result.data.history || [];
                        render();
                    })
                    .catch(function(e) {
                        state.bonusHistory = [];
                        state.error = { message: 'Failed to load bonus history' };
                        render();
                    });
            },

            closeBonusHistory: function() {
                state.showBonusHistory = false;
                render();
            },

            // Scroll to specific usage card (mobile swipe)
            scrollToUsageCard: function(index) {
                var container = document.getElementById('usageSwipeContainer');
                if (container) {
                    var cards = container.querySelectorAll('.mobile-swipe-card');
                    if (cards[index]) {
                        cards[index].scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                    }
                }
            },

            // Initialize swipe dots listener
            initSwipeDots: function() {
                var container = document.getElementById('usageSwipeContainer');
                var dotsContainer = document.getElementById('usageSwipeDots');
                if (container && dotsContainer) {
                    container.addEventListener('scroll', function() {
                        var cards = container.querySelectorAll('.mobile-swipe-card');
                        var containerRect = container.getBoundingClientRect();
                        var containerCenter = containerRect.left + containerRect.width / 2;

                        var closestIndex = 0;
                        var closestDistance = Infinity;

                        cards.forEach(function(card, index) {
                            var cardRect = card.getBoundingClientRect();
                            var cardCenter = cardRect.left + cardRect.width / 2;
                            var distance = Math.abs(containerCenter - cardCenter);

                            if (distance < closestDistance) {
                                closestDistance = distance;
                                closestIndex = index;
                            }
                        });

                        var dots = dotsContainer.querySelectorAll('.mobile-swipe-dot');
                        dots.forEach(function(dot, index) {
                            if (index === closestIndex) {
                                dot.classList.add('active');
                            } else {
                                dot.classList.remove('active');
                            }
                        });
                    }, { passive: true });
                }
            },

            // Initialize desktop carousel drag-to-scroll
            initDesktopCarousel: function() {
                var carousel = document.getElementById('desktopUsageCarousel');
                if (!carousel) return;

                var isDown = false;
                var startX;
                var scrollLeft;

                carousel.addEventListener('mousedown', function(e) {
                    isDown = true;
                    carousel.classList.add('active');
                    startX = e.pageX - carousel.offsetLeft;
                    scrollLeft = carousel.scrollLeft;
                    e.preventDefault();
                });

                carousel.addEventListener('mouseleave', function() {
                    isDown = false;
                    carousel.classList.remove('active');
                });

                carousel.addEventListener('mouseup', function() {
                    isDown = false;
                    carousel.classList.remove('active');
                });

                carousel.addEventListener('mousemove', function(e) {
                    if (!isDown) return;
                    e.preventDefault();
                    var x = e.pageX - carousel.offsetLeft;
                    var walk = (x - startX) * 1.5; // Scroll speed multiplier
                    carousel.scrollLeft = scrollLeft - walk;
                });

                // Touch support for hybrid devices
                carousel.addEventListener('touchstart', function(e) {
                    startX = e.touches[0].pageX - carousel.offsetLeft;
                    scrollLeft = carousel.scrollLeft;
                }, { passive: true });

                carousel.addEventListener('touchmove', function(e) {
                    var x = e.touches[0].pageX - carousel.offsetLeft;
                    var walk = (x - startX) * 1.5;
                    carousel.scrollLeft = scrollLeft - walk;
                }, { passive: true });
            },

            /* ------------------------------------------
               4.5.2 Authentication Actions
               ------------------------------------------ */

            signInWithGoogle: function() {
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.setCustomParameters({
                    prompt: 'select_account'
                });

                state.loading = true;
                render();

                auth.signInWithPopup(provider)
                    .then(function(result) {
                        state.loading = false;
                    })
                    .catch(function(error) {
                        state.loading = false;
                        state.error = 'Google sign-in failed. Please try again.';
                        render();
                    });
            },

            register: function(e) {
                e.preventDefault();
                const email = document.getElementById('register-email').value.trim();
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;

                state.error = null;

                // Validation
                if (!utils.validateEmail(email)) {
                    state.error = 'Please enter a valid email address';
                    render();
                    return;
                }

                if (password.length < 6) {
                    state.error = 'Password must be at least 6 characters';
                    render();
                    return;
                }

                if (password !== confirmPassword) {
                    state.error = 'Passwords do not match';
                    render();
                    return;
                }

                state.loading = true;
                render();

                auth.createUserWithEmailAndPassword(email, password)
                    .then(function(result) {
                        state.loading = false;
                    })
                    .catch(function(error) {
                        state.loading = false;

                        switch (error.code) {
                            case 'auth/email-already-in-use':
                                state.error = 'This email is already registered. Please sign in.';
                                break;
                            case 'auth/invalid-email':
                                state.error = 'Invalid email address';
                                break;
                            case 'auth/weak-password':
                                state.error = 'Password is too weak';
                                break;
                            default:
                                state.error = 'Registration failed: ' + error.message;
                        }
                        render();
                    });
            },

            signIn: function(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value.trim();
                const password = document.getElementById('login-password').value;

                state.error = null;

                if (!email || !password) {
                    state.error = 'Please enter email and password';
                    render();
                    return;
                }

                state.loading = true;
                render();

                auth.signInWithEmailAndPassword(email, password)
                    .then(function(result) {
                        state.loading = false;
                    })
                    .catch(function(error) {
                        state.loading = false;

                        switch (error.code) {
                            case 'auth/user-not-found':
                            case 'auth/wrong-password':
                                state.error = 'Invalid email or password';
                                break;
                            case 'auth/invalid-email':
                                state.error = 'Invalid email address';
                                break;
                            case 'auth/user-disabled':
                                state.error = 'This account has been disabled';
                                break;
                            default:
                                state.error = 'Sign in failed: ' + error.message;
                        }
                        render();
                    });
            },

            resetPassword: function(e) {
                e.preventDefault();
                const email = document.getElementById('reset-email').value.trim();

                state.error = null;
                state.success = null;

                if (!utils.validateEmail(email)) {
                    state.error = 'Please enter a valid email address';
                    render();
                    return;
                }

                state.loading = true;
                render();

                auth.sendPasswordResetEmail(email)
                    .then(function() {
                        state.loading = false;
                        state.success = 'Password reset email sent! Check your inbox.';
                        render();
                    })
                    .catch(function(error) {
                        state.loading = false;

                        switch (error.code) {
                            case 'auth/user-not-found':
                                state.error = 'No account found with this email';
                                break;
                            case 'auth/invalid-email':
                                state.error = 'Invalid email address';
                                break;
                            default:
                                state.error = 'Failed to send reset email: ' + error.message;
                        }
                        render();
                    });
            },

            signOut: function() {
                auth.signOut();
            },

            /* ------------------------------------------
               4.5.2b User Notifications Actions (Legacy - now handled in Unified Notifications)
               ------------------------------------------ */

            // Legacy function - now redirects to handleAlertNotificationClick
            markNotificationRead: function(notificationId) {
                this.handleAlertNotificationClick(notificationId);
            },

            /* ------------------------------------------
               4.5.2c Renewal Request Actions
               ------------------------------------------ */

            openRenewalModal: function() {
                // Set default plan based on previous subscription
                var p = state.profile;
                if (p && p.subscription && p.subscription.plan && p.subscription.plan !== 'free') {
                    state.renewalForm.preferredPlan = p.subscription.plan;
                }
                state.showRenewalModal = true;
                this.loadRenewalRequests();
                render();
            },

            closeRenewalModal: function() {
                state.showRenewalModal = false;
                render();
            },

            updateRenewalForm: function(field, value) {
                state.renewalForm[field] = value;
                render();
            },

            submitRenewalRequest: function() {
                if (state.renewalSubmitting) return;

                var form = state.renewalForm;
                if (!form.preferredPlan) {
                    alert('Please select a plan');
                    return;
                }

                state.renewalSubmitting = true;
                render();

                functions.httpsCallable('userSubmitRenewalRequest')({
                    preferredPlan: form.preferredPlan,
                    preferredDuration: form.preferredDuration,
                    message: form.message
                })
                    .then(function(result) {
                        state.renewalSubmitting = false;
                        state.renewalForm.message = '';
                        alert('Renewal request submitted! We will review it shortly.');
                        app.loadRenewalRequests();
                        app.loadUserNotifications();
                        render();
                    })
                    .catch(function(error) {
                        state.renewalSubmitting = false;
                        alert('Failed to submit request: ' + error.message);
                        render();
                    });
            },

            loadRenewalRequests: function() {
                functions.httpsCallable('userGetRenewalRequests')()
                    .then(function(result) {
                        state.renewalRequests = result.data.requests || [];
                        render();
                    })
                    .catch(function(error) {
                        console.error('Error loading renewal requests:', error);
                    });
            },

            cancelRenewalRequest: function(requestId) {
                if (!confirm('Cancel this renewal request?')) return;

                functions.httpsCallable('userCancelRenewalRequest')({ requestId: requestId })
                    .then(function() {
                        app.loadRenewalRequests();
                    })
                    .catch(function(error) {
                        alert('Failed to cancel: ' + error.message);
                    });
            },

            /* ------------------------------------------
               4.5.3 Optimizer Actions
               ------------------------------------------ */

            optimize: function(e) {
                e.preventDefault();
                const url = document.getElementById('video-url').value.trim();

                if (!url) {
                    state.error = { message: 'Please enter a video URL', type: 'validation' };
                    render();
                    return;
                }

                // Validate URL format
                if (!url.includes('youtube.com') && !url.includes('youtu.be')) {
                    state.error = { message: 'Please enter a valid YouTube URL', type: 'validation' };
                    render();
                    return;
                }

                state.loading = true;
                state.error = null;
                startLoadingProgress();
                render();

                functions.httpsCallable('optimizeVideo')({ videoUrl: url })
                    .then(function(result) {
                        stopLoadingProgress();
                        state.currentResults = result.data;
                        state.lastOptimization = result.data; // Save for thumbnail generator
                        state.loading = false;
                        state.currentView = 'results';
                        return functions.httpsCallable('getUserProfile')();
                    })
                    .then(function(result) {
                        state.profile = result.data.profile;
                        render();
                    })
                    .catch(function(e) {
                        stopLoadingProgress();
                        state.loading = false;

                        // Parse Firebase error for detailed message
                        var errorMessage = 'Optimization failed. Please try again.';
                        var errorDetails = null;
                        var errorType = 'unknown';

                        if (e.code) {
                            errorType = e.code;

                            // Map Firebase error codes to user-friendly messages
                            switch (e.code) {
                                case 'functions/internal':
                                    // Check the error message for more specific issues
                                    if (e.message && e.message.includes('API')) {
                                        errorMessage = 'YouTube API error. The API may not be enabled.';
                                        errorDetails = 'Admin: Enable YouTube Data API v3 in Google Cloud Console';
                                    } else if (e.message && e.message.includes('quota')) {
                                        errorMessage = 'API quota exceeded. Please try again later.';
                                    } else {
                                        errorMessage = 'Server error occurred.';
                                        errorDetails = e.message || 'No additional details available';
                                    }
                                    break;
                                case 'functions/failed-precondition':
                                    // API not enabled or configured
                                    errorMessage = e.message || 'Service not properly configured.';
                                    if (e.message && e.message.includes('YouTube API')) {
                                        errorDetails = 'Go to Google Cloud Console  APIs & Services  Enable YouTube Data API v3';
                                    } else if (e.message && e.message.includes('API key')) {
                                        errorDetails = 'Check Firebase Functions config: firebase functions:config:set youtube.key="YOUR_KEY"';
                                    }
                                    break;
                                case 'functions/unauthenticated':
                                    errorMessage = 'You must be logged in to optimize videos.';
                                    break;
                                case 'functions/resource-exhausted':
                                    // Check if token bypass is available
                                    if (e.details && e.details.tokenBypass && e.details.tokenBypass.available) {
                                        // Show the quota bypass modal instead of error
                                        app.showQuotaBypassModal(
                                            e.details.toolType || 'warpOptimizer',
                                            'WARP Optimizer',
                                            e.details,
                                            function() {
                                                // Retry the optimization after token bypass
                                                app.warpOptimizer();
                                            }
                                        );
                                        return; // Don't show error, modal will handle it
                                    }
                                    if (e.message && e.message.includes('quota')) {
                                        errorMessage = 'YouTube API quota exceeded. Please try again later.';
                                        errorDetails = 'The daily API limit has been reached. Try again tomorrow.';
                                    } else {
                                        errorMessage = 'Daily limit reached. Please upgrade your plan or try again tomorrow.';
                                        errorDetails = e.message;
                                    }
                                    break;
                                case 'functions/invalid-argument':
                                    errorMessage = 'Invalid video URL. Please check and try again.';
                                    break;
                                case 'functions/not-found':
                                    errorMessage = e.message || 'Video not found. Please check the URL.';
                                    break;
                                case 'functions/permission-denied':
                                    errorMessage = 'Access denied. Please check your subscription.';
                                    break;
                                case 'functions/unavailable':
                                    errorMessage = 'Service temporarily unavailable. Please try again.';
                                    break;
                                default:
                                    errorMessage = e.message || 'An unexpected error occurred.';
                            }
                        } else if (e.message) {
                            errorMessage = e.message;
                        }

                        state.error = {
                            message: errorMessage,
                            details: errorDetails,
                            code: e.code || 'unknown',
                            type: errorType,
                            raw: e.message // For debugging
                        };
                        render();
                    });
            },

            /* ------------------------------------------
               4.5.4 Utility Actions
               ------------------------------------------ */

            copyToClipboard: function(text, buttonId) {
                const showSuccess = function(btn) {
                    if (!btn) return;
                    const originalText = btn.innerHTML;
                    btn.innerHTML = ' Copied!';
                    btn.classList.add('bg-green-500');
                    setTimeout(function() {
                        btn.innerHTML = originalText;
                        btn.classList.remove('bg-green-500');
                    }, 2000);
                };

                const btn = document.getElementById(buttonId);

                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).then(function() {
                        showSuccess(btn);
                    });
                } else {
                    // Fallback for older browsers
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        showSuccess(btn);
                    } catch (err) {
                        alert('Copy failed. Please copy manually.');
                    }
                    document.body.removeChild(textarea);
                }
            },

            viewHistoryItem: function(index, id) {
                var item = null;
                if (id) {
                    // Find by ID (from "all" tab)
                    item = (state.allHistory || []).find(function(h) { return h.id === id && h.type === 'optimization'; });
                    if (!item) item = (state.historyData || []).find(function(h) { return h.id === id; });
                } else if (state.historyData && state.historyData[index]) {
                    item = state.historyData[index];
                }
                if (item) {
                    state.currentResults = item;
                    state.lastOptimization = item; // For thumbnail generator
                    state.currentView = 'results';
                    render();
                }
            },

            viewCompetitorHistory: function(index, id) {
                var item = null;
                if (id) {
                    item = (state.allHistory || []).find(function(h) { return h.id === id && h.type === 'competitor'; });
                    if (!item) item = (state.competitorHistory || []).find(function(h) { return h.id === id; });
                } else if (state.competitorHistory && state.competitorHistory[index]) {
                    item = state.competitorHistory[index];
                }
                if (item) {
                    state.competitorResults = item;
                    state.currentView = 'competitor';
                    render();
                }
            },

            viewTrendHistory: function(index, id) {
                var item = null;
                if (id) {
                    item = (state.allHistory || []).find(function(h) { return h.id === id && h.type === 'trend'; });
                    if (!item) item = (state.trendHistory || []).find(function(h) { return h.id === id; });
                } else if (state.trendHistory && state.trendHistory[index]) {
                    item = state.trendHistory[index];
                }
                if (item) {
                    state.trendResults = item;
                    state.currentView = 'trends';
                    render();
                }
            },

            viewThumbnailHistory: function(index, id) {
                var item = null;
                if (id) {
                    item = (state.allHistory || []).find(function(h) { return h.id === id && h.type === 'thumbnail'; });
                    if (!item) item = (state.thumbnailHistory || []).find(function(h) { return h.id === id; });
                } else if (state.thumbnailHistory && state.thumbnailHistory[index]) {
                    item = state.thumbnailHistory[index];
                }
                if (item) {
                    state.thumbnailImage = item.imageUrl;
                    state.thumbnailJob = { id: item.jobId };
                    state.thumbnailStatus = item.status;
                    state.currentView = 'thumbnail';
                    render();
                }
            },

            deleteHistoryItem: function(type, id, index) {
                if (!confirm('Are you sure you want to delete this item?')) return;

                var functionName;
                switch(type) {
                    case 'optimization': functionName = 'deleteOptimization'; break;
                    case 'competitor': functionName = 'deleteCompetitorAnalysis'; break;
                    case 'trend': functionName = 'deleteTrendPrediction'; break;
                    case 'thumbnail': functionName = 'deleteThumbnail'; break;
                    case 'placement': functionName = 'deletePlacementFinder'; break;
                    case 'channelAudit': functionName = 'deleteChannelAudit'; break;
                    default: return;
                }

                state.loading = true;
                render();

                functions.httpsCallable(functionName)({ id: id })
                    .then(function(result) {
                        // Remove from local state
                        switch(type) {
                            case 'optimization':
                                state.historyData.splice(index, 1);
                                state.historyCounts.optimizations--;
                                break;
                            case 'competitor':
                                state.competitorHistory.splice(index, 1);
                                state.historyCounts.competitor--;
                                break;
                            case 'trend':
                                state.trendHistory.splice(index, 1);
                                state.historyCounts.trends--;
                                break;
                            case 'thumbnail':
                                state.thumbnailHistory.splice(index, 1);
                                state.historyCounts.thumbnails--;
                                break;
                            case 'placement':
                                if (state.placementHistory) state.placementHistory.splice(index, 1);
                                if (state.historyCounts) state.historyCounts.placements--;
                                break;
                            case 'channelAudit':
                                if (state.channelAuditHistory) state.channelAuditHistory.splice(index, 1);
                                if (state.historyCounts) state.historyCounts.channelAudit--;
                                break;
                        }
                        // Also remove from allHistory
                        if (state.allHistory) {
                            state.allHistory = state.allHistory.filter(function(item) {
                                return item.id !== id;
                            });
                        }
                        state.loading = false;
                        state.success = 'Item deleted successfully';
                        render();
                        setTimeout(function() { state.success = null; render(); }, 3000);
                    })
                    .catch(function(e) {
                        state.loading = false;
                        state.error = 'Failed to delete: ' + e.message;
                        render();
                    });
            },

            toggleErrorDetails: function() {
                var details = document.getElementById('error-details');
                if (details) {
                    details.classList.toggle('hidden');
                    var btn = details.previousElementSibling;
                    if (btn && btn.tagName === 'BUTTON') {
                        btn.textContent = details.classList.contains('hidden') ? 'Show Technical Details' : 'Hide Technical Details';
                    }
                }
            },

            /* ------------------------------------------
               4.5.5 Results Tab Actions
               ------------------------------------------ */

            setResultsTab: function(tab) {
                state.resultsTab = tab;
                render();
            },

            /* ------------------------------------------
               4.5.6 Admin Actions
               ------------------------------------------ */

            goToAdmin: function() {
                // Redirect to consolidated admin panel at admin-plans.html with Users tab
                window.location.href = 'admin-plans.html?tab=users';
            },

            setupAdmin: function() {
                state.loading = true;
                render();

                functions.httpsCallable('setupAdmin')()
                    .then(function(result) {
                        state.loading = false;
                        state.isAdmin = true;
                        state.success = result.data.message;
                        render();
                    })
                    .catch(function(e) {
                        state.loading = false;
                        state.error = { message: 'Failed to setup admin: ' + e.message };
                        render();
                    });
            },

            updateUserPlan: function(userId, newPlan) {
                state.adminLoading = true;
                render();

                functions.httpsCallable('adminUpdateUserPlan')({ userId: userId, plan: newPlan })
                    .then(function(result) {
                        // Refresh user list
                        return functions.httpsCallable('adminGetUsers')();
                    })
                    .then(function(result) {
                        state.adminUsers = result.data.users || [];
                        state.adminLoading = false;
                        state.success = 'User plan updated successfully!';
                        render();
                        setTimeout(function() { state.success = null; render(); }, 3000);
                    })
                    .catch(function(e) {
                        state.adminLoading = false;
                        state.error = { message: 'Failed to update user: ' + e.message };
                        render();
                    });
            },

            checkAdminStatus: function() {
                // Check if user is admin when profile loads
                if (state.profile && state.profile.isAdmin) {
                    state.isAdmin = true;
                }
            },

            setQuotaResetTime: function() {
                var resetMinutes = parseInt(document.getElementById('reset-time-input').value);
                if (!resetMinutes || resetMinutes < 1) {
                    state.error = { message: 'Please enter a valid number of minutes (minimum 1)' };
                    render();
                    return;
                }

                state.adminLoading = true;
                render();

                functions.httpsCallable('adminSetQuotaSettings')({ resetTimeMinutes: resetMinutes })
                    .then(function(result) {
                        state.adminLoading = false;
                        state.resetTimeMinutes = resetMinutes;
                        state.success = 'Quota reset time updated to ' + resetMinutes + ' minutes!';
                        render();
                        setTimeout(function() { state.success = null; render(); }, 3000);
                    })
                    .catch(function(e) {
                        state.adminLoading = false;
                        // Firebase Functions errors have code, message, and details
                        var errorMsg = e.message || 'Unknown error';
                        if (e.details) errorMsg = e.details;
                        // If only got error code, provide more context
                        if (errorMsg === 'internal' || errorMsg === 'INTERNAL') {
                            errorMsg = 'Server error occurred. Please check Firebase Functions logs for details.';
                        }
                        console.error('Admin setQuotaResetTime error:', e);
                        state.error = { message: 'Failed to update reset time: ' + errorMsg };
                        render();
                    });
            },

            grantBonusUses: function() {
                var userId = document.getElementById('bonus-user-select').value;
                var tool = document.getElementById('bonus-tool-select').value;
                var amount = parseInt(document.getElementById('bonus-amount-input').value);

                if (!userId) {
                    state.error = { message: 'Please select a user' };
                    render();
                    return;
                }
                if (!amount || amount < 1) {
                    state.error = { message: 'Please enter a valid bonus amount (minimum 1)' };
                    render();
                    return;
                }

                state.adminLoading = true;
                render();

                functions.httpsCallable('adminGrantBonusUses')({ userId: userId, tool: tool, bonusAmount: amount })
                    .then(function(result) {
                        state.adminLoading = false;
                        state.success = 'Granted ' + amount + ' bonus uses for ' + tool + '!';
                        // Refresh user list
                        return functions.httpsCallable('adminGetUsers')();
                    })
                    .then(function(result) {
                        if (result && result.data) {
                            state.adminUsers = result.data.users || [];
                        }
                        render();
                        setTimeout(function() { state.success = null; render(); }, 3000);
                    })
                    .catch(function(e) {
                        state.adminLoading = false;
                        state.error = { message: 'Failed to grant bonus: ' + e.message };
                        render();
                    });
            },

            /* ------------------------------------------
               4.5.5 Competitor Analysis Actions
               ------------------------------------------ */
            analyzeCompetitor: function(e) {
                e.preventDefault();
                const url = document.getElementById('competitor-url').value.trim();

                if (!url) {
                    state.error = { message: 'Please enter a competitor video URL' };
                    render();
                    return;
                }

                state.loading = true;
                state.error = null;
                state.loadingSteps = [
                    { name: 'Fetching video data', icon: '' },
                    { name: 'Analyzing channel', icon: '' },
                    { name: 'Evaluating SEO', icon: '' },
                    { name: 'Finding weaknesses', icon: '' },
                    { name: 'Generating strategy', icon: '' }
                ];
                startLoadingProgress();
                render();

                functions.httpsCallable('analyzeCompetitor')({ videoUrl: url })
                    .then(function(result) {
                        stopLoadingProgress();
                        state.competitorResults = result.data;
                        state.loading = false;
                        render();
                    })
                    .catch(function(e) {
                        stopLoadingProgress();
                        state.loading = false;
                        // Check for token bypass option
                        if (e.code === 'functions/resource-exhausted' && e.details && e.details.tokenBypass && e.details.tokenBypass.available) {
                            app.showQuotaBypassModal(
                                e.details.toolType || 'competitorAnalysis',
                                'Competitor Analysis',
                                e.details,
                                function() { app.analyzeCompetitor({ preventDefault: function(){} }); }
                            );
                            return;
                        }
                        state.error = { message: 'Analysis failed: ' + e.message };
                        render();
                    });
            },

            /* ------------------------------------------
               4.5.6 Trend Predictor Actions
               ------------------------------------------ */
            predictTrends: function(e) {
                e.preventDefault();
                const niche = document.getElementById('trend-niche').value.trim();
                const country = document.getElementById('trend-country').value || 'US';

                if (!niche) {
                    state.error = { message: 'Please enter a niche/topic' };
                    render();
                    return;
                }

                state.loading = true;
                state.error = null;
                state.loadingSteps = [
                    { name: 'Scanning trending videos', icon: '' },
                    { name: 'Analyzing patterns', icon: '' },
                    { name: 'Identifying opportunities', icon: '' },
                    { name: 'Predicting future trends', icon: '' },
                    { name: 'Generating video ideas', icon: '' }
                ];
                startLoadingProgress();
                render();

                functions.httpsCallable('predictTrends')({ niche: niche, country: country })
                    .then(function(result) {
                        stopLoadingProgress();
                        state.trendResults = result.data;
                        state.loading = false;
                        render();
                    })
                    .catch(function(e) {
                        stopLoadingProgress();
                        state.loading = false;
                        // Check for token bypass option
                        if (e.code === 'functions/resource-exhausted' && e.details && e.details.tokenBypass && e.details.tokenBypass.available) {
                            app.showQuotaBypassModal(
                                e.details.toolType || 'trendPredictor',
                                'Trend Predictor',
                                e.details,
                                function() { app.predictTrends({ preventDefault: function(){} }); }
                            );
                            return;
                        }
                        state.error = { message: 'Prediction failed: ' + e.message };
                        render();
                    });
            },

            /* ------------------------------------------
               4.5.7 Thumbnail Generator Actions
               ------------------------------------------ */
            generateThumbnail: function(e) {
                e.preventDefault();
                var title = document.getElementById('thumbnail-title').value.trim();
                var customPrompt = document.getElementById('thumbnail-prompt')?.value.trim() || '';

                // Get video context if available
                var videoContext = '';
                if (state.lastOptimization && state.thumbnailFromOptimizer) {
                    var opt = state.lastOptimization;
                    var videoInfo = opt.videoInfo || {};
                    videoContext = 'Video context: ' + (videoInfo.channelTitle || '') + ' channel. ';
                    if (opt.tags && opt.tags.length > 0) {
                        videoContext += 'Keywords: ' + opt.tags.slice(0, 5).join(', ') + '. ';
                    }
                }

                // Build style-specific prompt
                var stylePrompts = {
                    professional: 'Clean, professional look with sharp focus, studio lighting, high contrast',
                    dramatic: 'Dramatic lighting, intense colors, bold shadows, cinematic feel',
                    minimal: 'Minimalist design, soft colors, clean background, elegant simplicity',
                    bold: 'Vibrant colors, eye-catching, bold graphics, high energy, dynamic composition'
                };

                var fullPrompt = stylePrompts[state.thumbnailStyle] + '. ' + videoContext + customPrompt;

                if (!title) {
                    state.error = { message: 'Please enter a video title' };
                    render();
                    return;
                }

                state.loading = true;
                state.error = null;
                state.thumbnailImage = null;
                state.loadingSteps = [
                    { name: 'Analyzing video context', icon: '' },
                    { name: 'Creating AI prompt', icon: '' },
                    { name: 'Generating image', icon: '' },
                    { name: 'Rendering HD', icon: '' }
                ];
                startLoadingProgress();
                render();

                functions.httpsCallable('generateThumbnail')({
                    title: title,
                    customPrompt: fullPrompt,
                    style: state.thumbnailStyle
                })
                    .then(function(result) {
                        state.thumbnailJob = result.data;
                        // Start polling for result
                        app.pollThumbnailStatus(result.data.jobId);
                    })
                    .catch(function(e) {
                        stopLoadingProgress();
                        state.loading = false;
                        // Check for token bypass option
                        if (e.code === 'functions/resource-exhausted' && e.details && e.details.tokenBypass && e.details.tokenBypass.available) {
                            app.showQuotaBypassModal(
                                e.details.toolType || 'thumbnailGenerator',
                                'Thumbnail Generator',
                                e.details,
                                function() { app.generateThumbnail({ preventDefault: function(){} }); }
                            );
                            return;
                        }
                        state.error = { message: 'Generation failed: ' + e.message };
                        render();
                    });
            },

            pollThumbnailStatus: function(jobId) {
                var pollCount = 0;
                var maxPolls = 60; // Maximum 3 minutes (60 * 3 seconds)

                var pollInterval = setInterval(function() {
                    pollCount++;

                    // Check if exceeded max polls
                    if (pollCount > maxPolls) {
                        clearInterval(pollInterval);
                        stopLoadingProgress();
                        state.loading = false;
                        state.error = { message: 'Generation timed out. Please try again.' };
                        render();
                        return;
                    }

                    functions.httpsCallable('checkThumbnailStatus')({ jobId: jobId })
                        .then(function(result) {
                            state.thumbnailStatus = result.data.status;

                            if (result.data.status === 'COMPLETED') {
                                clearInterval(pollInterval);
                                stopLoadingProgress();
                                state.loading = false;

                                // The image URL was set in the initial generateThumbnail call
                                // RunPod uploads to Firebase Storage at state.thumbnailJob.imageUrl
                                var imageUrl = state.thumbnailJob?.imageUrl;

                                // Also check if RunPod returns output with image data (might be URL or base64)
                                var runpodOutput = result.data.output;
                                console.log('Thumbnail completed. Firebase URL:', imageUrl, 'RunPod output:', runpodOutput ? typeof runpodOutput : 'none');

                                // Try multiple sources for the image
                                // Priority: RunPod direct output > Firebase Storage URL (more reliable if RunPod provides it)
                                if (runpodOutput && typeof runpodOutput === 'string' && runpodOutput.length > 50) {
                                    // RunPod returned a URL or base64 data directly
                                    if (runpodOutput.startsWith('http') || runpodOutput.startsWith('data:')) {
                                        state.thumbnailImage = runpodOutput;
                                    } else {
                                        // Likely base64 encoded image
                                        state.thumbnailImage = 'data:image/png;base64,' + runpodOutput;
                                    }
                                } else if (imageUrl) {
                                    // Use Firebase Storage URL
                                    state.thumbnailImage = imageUrl;
                                } else {
                                    state.error = { message: 'Image generated but URL not available. Check Firebase Storage.' };
                                }

                                render();
                            } else if (result.data.status === 'FAILED') {
                                clearInterval(pollInterval);
                                stopLoadingProgress();
                                state.loading = false;
                                var errorDetail = result.data.error || 'Unknown error';
                                if (typeof errorDetail === 'object') {
                                    errorDetail = errorDetail.message || JSON.stringify(errorDetail);
                                }
                                state.error = { message: 'Thumbnail generation failed: ' + errorDetail };
                                render();
                            } else {
                                // Still processing (IN_QUEUE or IN_PROGRESS), update progress
                                if (state.loadingProgress < 90) {
                                    state.loadingProgress += 2;
                                }
                                updateLoadingUI();
                            }
                        })
                        .catch(function(e) {
                            // Don't clear interval on transient errors, just log
                            console.error('Thumbnail status check error:', e);
                            if (pollCount > 5) {
                                // Only fail after multiple attempts
                                clearInterval(pollInterval);
                                stopLoadingProgress();
                                state.loading = false;
                                state.error = { message: 'Status check failed: ' + e.message };
                                render();
                            }
                        });
                }, 3000); // Poll every 3 seconds
            },

            /* ------------------------------------------
               4.5.7b Thumbnail Pro Actions
               ------------------------------------------ */

            // Targeted UI update functions to avoid full re-renders
            updateThumbnailModeUI: function(mode) {
                var modeCards = document.querySelectorAll('[data-mode-card]');
                modeCards.forEach(function(card) {
                    var cardMode = card.getAttribute('data-mode-card');
                    if (cardMode === mode) {
                        card.classList.remove('border-gray-200', 'hover:border-pink-300');
                        card.classList.add('border-pink-500', 'bg-pink-50', 'shadow-lg');
                        var check = card.querySelector('.mode-check');
                        if (check) check.classList.remove('hidden');
                    } else {
                        card.classList.remove('border-pink-500', 'bg-pink-50', 'shadow-lg');
                        card.classList.add('border-gray-200', 'hover:border-pink-300');
                        var check = card.querySelector('.mode-check');
                        if (check) check.classList.add('hidden');
                    }
                });
            },

            updateThumbnailStyleUI: function(style) {
                var styleCards = document.querySelectorAll('[data-style-card]');
                styleCards.forEach(function(card) {
                    var cardStyle = card.getAttribute('data-style-card');
                    if (cardStyle === style) {
                        card.classList.remove('border-gray-200', 'hover:border-pink-300');
                        card.classList.add('border-pink-500', 'bg-pink-50');
                    } else {
                        card.classList.remove('border-pink-500', 'bg-pink-50');
                        card.classList.add('border-gray-200', 'hover:border-pink-300');
                    }
                });
            },

            updateThumbnailCategoryUI: function(category) {
                var categoryBtns = document.querySelectorAll('[data-category-btn]');
                categoryBtns.forEach(function(btn) {
                    var btnCategory = btn.getAttribute('data-category-btn');
                    if (btnCategory === category) {
                        btn.classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-pink-100');
                        btn.classList.add('bg-pink-500', 'text-white');
                    } else {
                        btn.classList.remove('bg-pink-500', 'text-white');
                        btn.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-pink-100');
                    }
                });
            },

            updateThumbnailVariationsUI: function(variations) {
                var variationBtns = document.querySelectorAll('[data-variation-btn]');
                variationBtns.forEach(function(btn) {
                    var btnVariation = parseInt(btn.getAttribute('data-variation-btn'));
                    if (btnVariation === variations) {
                        btn.classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-pink-100');
                        btn.classList.add('bg-pink-500', 'text-white');
                    } else {
                        btn.classList.remove('bg-pink-500', 'text-white');
                        btn.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-pink-100');
                    }
                });
            },

            updateThumbnailCostUI: function() {
                var modeCosts = { quick: 2, reference: 4, upgrade: 4 };
                var baseCost = modeCosts[state.thumbnailMode] || 2;
                var totalCost = baseCost * state.thumbnailVariations;

                // Update cost displays
                var costDisplay = document.getElementById('thumbnail-cost-display');
                if (costDisplay) costDisplay.textContent = totalCost;

                var costCalc = document.getElementById('thumbnail-cost-calc');
                if (costCalc) costCalc.textContent = baseCost + '  ' + state.thumbnailVariations + ' = ';

                var costTotal = document.getElementById('thumbnail-cost-total');
                if (costTotal) costTotal.textContent = totalCost;

                var imageCount = document.getElementById('thumbnail-image-count');
                if (imageCount) imageCount.textContent = state.thumbnailVariations + ' image' + (state.thumbnailVariations > 1 ? 's' : '');

                // Update submit button text
                var submitBtn = document.getElementById('thumbnail-submit-btn');
                if (submitBtn && !state.loading) {
                    var canSubmit = state.thumbnailTokenBalance >= totalCost;
                    var needsReference = (state.thumbnailMode === 'reference' || state.thumbnailMode === 'upgrade') && !state.thumbnailReference;
                    if (needsReference) {
                        var msg = state.thumbnailMode === 'upgrade' ? ' Upload Thumbnail or Enter YouTube URL First' : ' Upload Reference Image First';
                        submitBtn.textContent = msg;
                        submitBtn.disabled = true;
                    } else if (!canSubmit) {
                        submitBtn.textContent = ' Insufficient Tokens';
                        submitBtn.disabled = true;
                    } else {
                        var actionText = state.thumbnailMode === 'upgrade' ? ' Upgrade' : ' Generate';
                        submitBtn.textContent = actionText + ' ' + state.thumbnailVariations + ' Thumbnail' + (state.thumbnailVariations > 1 ? 's' : '') + ' (' + totalCost + ' tokens)';
                        submitBtn.disabled = false;
                    }
                }

                // Update insufficient tokens warning
                var tokenWarning = document.getElementById('thumbnail-token-warning');
                if (tokenWarning) {
                    if (state.thumbnailTokenBalance < totalCost) {
                        tokenWarning.classList.remove('hidden');
                        tokenWarning.innerHTML = ' Insufficient tokens. You have ' + state.thumbnailTokenBalance + ' but need ' + totalCost + '.';
                    } else {
                        tokenWarning.classList.add('hidden');
                    }
                }
            },

            setThumbnailMode: function(mode) {
                var previousMode = state.thumbnailMode;
                state.thumbnailMode = mode;
                app.calculateThumbnailCost();

                // If switching away from reference/upgrade mode, clear reference and YouTube data
                if (mode !== 'reference' && mode !== 'upgrade') {
                    state.thumbnailReference = null;
                    state.thumbnailYoutubeData = null;
                    state.thumbnailYoutubeUrl = '';
                    state.thumbnailYoutubeError = null;
                }

                // If switching between reference and upgrade, keep reference but clear YouTube
                if (previousMode === 'upgrade' && mode === 'reference') {
                    state.thumbnailYoutubeData = null;
                    state.thumbnailYoutubeUrl = '';
                    state.thumbnailYoutubeError = null;
                }

                // If switching to upgrade from reference, reset upgrade sub-mode
                if (mode === 'upgrade') {
                    state.thumbnailUpgradeMode = 'upload';
                }

                // Full re-render for modes that have special UI sections
                var needsRerender = ['reference', 'upgrade'].includes(previousMode) || ['reference', 'upgrade'].includes(mode);
                if (needsRerender) {
                    render();
                } else {
                    // Just update the UI elements
                    app.updateThumbnailModeUI(mode);
                    app.updateThumbnailCostUI();
                }
            },

            setThumbnailStyle: function(style) {
                state.thumbnailStyle = style;
                render();
            },

            setThumbnailCategory: function(category) {
                state.thumbnailCategory = category;
                render();
            },

            setThumbnailVariations: function(count) {
                state.thumbnailVariations = Math.min(Math.max(parseInt(count) || 1, 1), 4);
                app.calculateThumbnailCost();
                app.updateThumbnailVariationsUI(state.thumbnailVariations);
                app.updateThumbnailCostUI();
            },

            // Phase 8: Advanced Options Handlers
            setThumbnailReferenceType: function(type) {
                state.thumbnailReferenceType = type;
                render();
            },

            setThumbnailComposition: function(composition) {
                state.thumbnailComposition = composition;
                render();
            },

            setThumbnailExpression: function(expression) {
                state.thumbnailExpression = expression;
                render();
            },

            setThumbnailFaceStrength: function(value) {
                state.thumbnailFaceStrength = parseInt(value) / 100;
                render();
            },

            setThumbnailStyleStrength: function(value) {
                state.thumbnailStyleStrength = parseInt(value) / 100;
                render();
            },

            setThumbnailBackground: function(bg) {
                state.thumbnailBackground = bg;
                render();
            },

            toggleAdvancedOptions: function() {
                state.showAdvancedOptions = !state.showAdvancedOptions;
                render();
            },

            // Thumbnail Upgrade - YouTube URL Feature
            setUpgradeMode: function(mode) {
                state.thumbnailUpgradeMode = mode;
                // Clear YouTube data when switching to upload mode
                if (mode === 'upload') {
                    state.thumbnailYoutubeUrl = '';
                    state.thumbnailYoutubeData = null;
                    state.thumbnailYoutubeError = null;
                    state.thumbnailReference = null;
                }
                // Clear single URL data when switching to bulk mode
                if (mode === 'bulk') {
                    state.thumbnailYoutubeUrl = '';
                    state.thumbnailYoutubeData = null;
                    state.thumbnailYoutubeError = null;
                    state.thumbnailReference = null;
                    state.thumbnailTitle = '';
                    state.titleAutoFilled = false;
                }
                // Clear data when switching to playlist mode
                if (mode === 'playlist') {
                    state.thumbnailYoutubeUrl = '';
                    state.thumbnailYoutubeData = null;
                    state.thumbnailYoutubeError = null;
                    state.thumbnailReference = null;
                    state.thumbnailTitle = '';
                    state.titleAutoFilled = false;
                }
                // Clear bulk data when switching away from bulk mode
                if (mode !== 'bulk' && state.bulkUrls.length > 0) {
                    state.bulkUrls = [];
                    state.bulkProcessing = false;
                    state.bulkCurrentIndex = 0;
                }
                // Clear playlist data when switching away from playlist mode
                if (mode !== 'playlist' && (state.playlistData || state.playlistResults.length > 0)) {
                    state.playlistUrl = '';
                    state.playlistData = null;
                    state.playlistError = null;
                    state.playlistSelectedVideos = [];
                    state.playlistResults = [];
                    state.playlistProcessing = false;
                }
                render();
            },

            setYoutubeUrl: function(url) {
                state.thumbnailYoutubeUrl = url;
                state.thumbnailYoutubeError = null;
            },

            fetchYoutubeThumbnail: async function() {
                var url = state.thumbnailYoutubeUrl.trim();
                if (!url) {
                    state.thumbnailYoutubeError = 'Please enter a YouTube URL';
                    render();
                    return;
                }

                state.thumbnailYoutubeLoading = true;
                state.thumbnailYoutubeError = null;
                render();

                try {
                    var fetchYoutubeData = firebase.functions().httpsCallable('fetchYoutubeVideoData');
                    var result = await fetchYoutubeData({ videoUrl: url });

                    if (result.data && result.data.success) {
                        state.thumbnailYoutubeData = {
                            videoId: result.data.videoId,
                            title: result.data.title,
                            description: result.data.description,
                            channelName: result.data.channelName,
                            thumbnailUrl: result.data.thumbnailUrl,
                            tags: result.data.tags || [],
                            fallbackMode: result.data.fallbackMode || false
                        };

                        // Auto-fill title from YouTube data for SEO
                        if (result.data.title) {
                            state.thumbnailTitle = result.data.title;
                            state.titleAutoFilled = true;
                        }

                        // Auto-load thumbnail as reference (will be downloaded by backend)
                        state.thumbnailReference = {
                            dataUrl: result.data.thumbnailUrl,
                            mimeType: 'image/jpeg',
                            name: 'youtube-thumbnail.jpg',
                            isYoutubeThumbnail: true,
                            videoId: result.data.videoId
                        };

                        state.thumbnailYoutubeLoading = false;
                        render();
                    } else {
                        throw new Error('Failed to fetch video data');
                    }
                } catch (error) {
                    console.error('YouTube fetch error:', error);
                    state.thumbnailYoutubeError = error.message || 'Failed to fetch video data. Please check the URL.';
                    state.thumbnailYoutubeLoading = false;
                    render();
                }
            },

            clearYoutubeData: function() {
                state.thumbnailYoutubeUrl = '';
                state.thumbnailYoutubeData = null;
                state.thumbnailYoutubeError = null;
                state.thumbnailReference = null;
                state.thumbnailTitle = '';
                state.titleAutoFilled = false;
                render();
            },

            // ========== BULK MODE FUNCTIONS ==========
            addBulkUrl: function() {
                if (state.bulkUrls.length >= state.bulkMaxItems) {
                    return;
                }
                state.bulkIdCounter++;
                state.bulkUrls.push({
                    id: 'bulk-' + state.bulkIdCounter,
                    url: '',
                    status: 'pending', // pending | fetching | ready | generating | complete | error
                    youtubeData: null,
                    generatedThumbnail: null,
                    error: null
                });
                render();
            },

            removeBulkUrl: function(id) {
                state.bulkUrls = state.bulkUrls.filter(function(item) {
                    return item.id !== id;
                });
                render();
            },

            updateBulkUrl: function(id, url) {
                var item = state.bulkUrls.find(function(i) { return i.id === id; });
                if (item) {
                    item.url = url;
                    item.status = 'pending';
                    item.youtubeData = null;
                    item.error = null;
                }
            },

            fetchBulkYoutubeData: async function(id) {
                var item = state.bulkUrls.find(function(i) { return i.id === id; });
                if (!item || !item.url.trim()) {
                    return;
                }

                item.status = 'fetching';
                item.error = null;
                render();

                try {
                    var fetchYoutubeData = firebase.functions().httpsCallable('fetchYoutubeVideoData');
                    var result = await fetchYoutubeData({ videoUrl: item.url.trim() });

                    if (result.data && result.data.success) {
                        item.youtubeData = {
                            videoId: result.data.videoId,
                            title: result.data.title,
                            description: result.data.description,
                            channelName: result.data.channelName,
                            thumbnailUrl: result.data.thumbnailUrl,
                            tags: result.data.tags || []
                        };
                        item.status = 'ready';
                    } else {
                        throw new Error('Failed to fetch video data');
                    }
                } catch (error) {
                    console.error('Bulk fetch error:', error);
                    item.status = 'error';
                    item.error = error.message || 'Failed to fetch video data';
                }
                render();
            },

            calculateBulkCost: function() {
                var readyItems = state.bulkUrls.filter(function(item) {
                    return item.status === 'ready' || item.status === 'complete';
                });
                var costPerItem = 4; // Upgrade mode cost
                return readyItems.length * costPerItem;
            },

            processBulkUpgrade: async function() {
                var readyItems = state.bulkUrls.filter(function(item) {
                    return item.status === 'ready';
                });

                if (readyItems.length === 0) {
                    state.error = { message: 'No videos ready to process. Please add YouTube URLs and fetch their data.' };
                    render();
                    return;
                }

                // Check total token cost
                var totalCost = this.calculateBulkCost();
                if (state.thumbnailTokenBalance < totalCost) {
                    state.error = { message: 'Insufficient tokens. Need ' + totalCost + ' tokens but you have ' + state.thumbnailTokenBalance };
                    render();
                    return;
                }

                state.bulkProcessing = true;
                state.bulkCurrentIndex = 0;
                state.error = null;
                render();

                var generateThumbnailPro = firebase.functions().httpsCallable('generateThumbnailPro');
                var lastRenderTime = Date.now();

                for (var i = 0; i < state.bulkUrls.length; i++) {
                    var item = state.bulkUrls[i];
                    if (item.status !== 'ready') continue;

                    state.bulkCurrentIndex = i;
                    item.status = 'generating';

                    // Throttle renders to max once per 500ms to prevent flickering
                    if (Date.now() - lastRenderTime > 500) {
                        render();
                        lastRenderTime = Date.now();
                    }

                    try {
                        var payload = {
                            prompt: item.youtubeData.title || 'Professional YouTube thumbnail',
                            mode: 'upgrade',
                            referenceType: 'upgrade',
                            // Use originalThumbnailUrl for YouTube thumbnails (not reference object)
                            originalThumbnailUrl: item.youtubeData.thumbnailUrl,
                            variations: 1,
                            title: item.youtubeData.title,
                            youtubeContext: {
                                videoId: item.youtubeData.videoId,
                                title: item.youtubeData.title,
                                description: item.youtubeData.description,
                                channelName: item.youtubeData.channelName,
                                tags: item.youtubeData.tags || []
                            },
                            // Shared settings from bulk configuration
                            style: state.thumbnailStyle,
                            category: state.thumbnailCategory,
                            composition: state.thumbnailComposition,
                            background: state.thumbnailBackground,
                            faceStrength: state.thumbnailFaceStrength,
                            styleStrength: state.thumbnailStyleStrength,
                            expression: state.thumbnailExpression
                        };

                        // Add face reference if Face Lock is enabled
                        if (state.faceReferenceEnabled && state.faceReferenceImage) {
                            payload.faceReferenceImage = {
                                base64: state.faceReferenceImage.base64,
                                mimeType: state.faceReferenceImage.mimeType
                            };
                        }

                        var result = await generateThumbnailPro(payload);

                        if (result.data && result.data.images && result.data.images.length > 0) {
                            item.status = 'complete';
                            item.generatedThumbnail = result.data.images[0].url;
                            // Update token balance
                            if (typeof result.data.newBalance !== 'undefined') {
                                state.thumbnailTokenBalance = result.data.newBalance;
                            }
                        } else {
                            throw new Error('No image generated');
                        }
                    } catch (error) {
                        console.error('Bulk generation error:', error);
                        item.status = 'error';
                        item.error = error.message || 'Generation failed';
                    }

                    // Render after each completed/failed item (but not too frequently)
                    render();
                    lastRenderTime = Date.now();

                    // Small delay between requests to avoid rate limiting
                    await new Promise(function(resolve) { setTimeout(resolve, 1500); });
                }

                state.bulkProcessing = false;
                render();
            },

            downloadAllAsZip: async function() {
                var completedItems = state.bulkUrls.filter(function(item) {
                    return item.status === 'complete' && item.generatedThumbnail;
                });

                if (completedItems.length === 0) {
                    state.error = { message: 'No completed thumbnails to download' };
                    render();
                    return;
                }

                try {
                    var zip = new JSZip();
                    var folder = zip.folder('thumbnails');

                    for (var i = 0; i < completedItems.length; i++) {
                        var item = completedItems[i];
                        var response = await fetch(item.generatedThumbnail);
                        var blob = await response.blob();

                        // Sanitize filename
                        var title = item.youtubeData && item.youtubeData.title
                            ? item.youtubeData.title.replace(/[<>:"/\\|?*]/g, '').substring(0, 50)
                            : 'thumbnail';
                        var filename = (i + 1) + '_' + title + '.png';
                        folder.file(filename, blob);
                    }

                    var content = await zip.generateAsync({ type: 'blob' });
                    saveAs(content, 'thumbnails.zip');
                } catch (error) {
                    console.error('ZIP download error:', error);
                    state.error = { message: 'Failed to create ZIP file: ' + error.message };
                    render();
                }
            },

            resetBulkMode: function() {
                state.bulkUrls = [];
                state.bulkProcessing = false;
                state.bulkCurrentIndex = 0;
                state.bulkIdCounter = 0;
                render();
            },

            // Regenerate a single failed bulk item
            regenerateBulkItem: async function(idx) {
                var item = state.bulkUrls[idx];
                if (!item || item.status !== 'error') return;

                // Need video data to regenerate
                if (!item.youtubeData) {
                    console.error('No video data for regeneration');
                    return;
                }

                item.status = 'regenerating';
                item.error = null;
                render();

                try {
                    var generateThumbnailPro = firebase.functions().httpsCallable('generateThumbnailPro');
                    var payload = {
                        prompt: item.youtubeData.title || 'Professional YouTube thumbnail',
                        mode: 'upgrade',
                        referenceType: 'upgrade',
                        originalThumbnailUrl: item.youtubeData.thumbnailUrl,
                        variations: 1,
                        title: item.youtubeData.title,
                        youtubeContext: {
                            videoId: item.youtubeData.videoId,
                            title: item.youtubeData.title,
                            channelName: item.youtubeData.channelName || '',
                            description: item.youtubeData.description || ''
                        },
                        style: state.thumbnailStyle,
                        category: state.thumbnailCategory
                    };

                    // Add face reference if Face Lock is enabled
                    if (state.faceReferenceEnabled && state.faceReferenceImage) {
                        payload.faceReferenceImage = {
                            base64: state.faceReferenceImage.base64,
                            mimeType: state.faceReferenceImage.mimeType
                        };
                    }

                    var result = await generateThumbnailPro(payload);

                    if (result.data && result.data.images && result.data.images.length > 0) {
                        item.status = 'complete';
                        item.generatedThumbnail = result.data.images[0].url;
                        if (typeof result.data.newBalance !== 'undefined') {
                            state.thumbnailTokenBalance = result.data.newBalance;
                        }
                    } else {
                        throw new Error('No image generated');
                    }
                } catch (error) {
                    console.error('Bulk regeneration error:', error);
                    item.status = 'error';
                    item.error = error.message || 'Regeneration failed';
                }

                render();
            },

            // Retry all failed bulk items
            retryFailedBulkItems: async function() {
                var failedIndices = [];
                state.bulkUrls.forEach(function(item, idx) {
                    if (item.status === 'error') {
                        failedIndices.push(idx);
                    }
                });

                if (failedIndices.length === 0) return;

                // Process failed items sequentially
                for (var i = 0; i < failedIndices.length; i++) {
                    await app.regenerateBulkItem(failedIndices[i]);
                    // Small delay between retries
                    if (i < failedIndices.length - 1) {
                        await new Promise(function(resolve) { setTimeout(resolve, 1500); });
                    }
                }
            },

            // ========== FACE LOCK FUNCTIONS ==========
            toggleFaceReference: function() {
                state.faceReferenceEnabled = !state.faceReferenceEnabled;

                // If enabling and no face set yet, try to use first video
                if (state.faceReferenceEnabled && !state.faceReferenceImage) {
                    // Try bulk mode first, then playlist
                    if (state.bulkUrls.length > 0 && state.bulkUrls[0].youtubeData?.thumbnailUrl) {
                        app.setFaceFromVideo(0, 'bulk');
                    } else if (state.playlistData?.videos?.length > 0) {
                        app.setFaceFromVideo(0, 'playlist');
                    }
                }
                render();
            },

            setFaceReferenceSource: function(source) {
                state.faceReferenceSource = source;

                if (source === 'first') {
                    // Use first video from current mode
                    if (state.thumbnailUpgradeMode === 'bulk' && state.bulkUrls.length > 0) {
                        app.setFaceFromVideo(0, 'bulk');
                    } else if (state.thumbnailUpgradeMode === 'playlist' && state.playlistData?.videos?.length > 0) {
                        app.setFaceFromVideo(0, 'playlist');
                    }
                } else if (source === 'upload') {
                    app.uploadFaceReference();
                }
                // 'select' mode - user clicks on a video thumbnail
                render();
            },

            setFaceFromVideo: async function(videoIndex, mode) {
                var thumbnailUrl = null;

                if (mode === 'bulk') {
                    var item = state.bulkUrls[videoIndex];
                    if (item?.youtubeData?.thumbnailUrl) {
                        thumbnailUrl = item.youtubeData.thumbnailUrl;
                    }
                } else if (mode === 'playlist') {
                    var video = state.playlistData?.videos?.[videoIndex];
                    if (video?.thumbnailUrl) {
                        thumbnailUrl = video.thumbnailUrl;
                    }
                }

                if (!thumbnailUrl) {
                    console.error('No thumbnail URL found for face reference');
                    return;
                }

                state.faceReferenceVideoIndex = videoIndex;
                state.faceReferenceLoading = true;
                render();

                try {
                    // Fetch the thumbnail and convert to base64
                    var response = await fetch(thumbnailUrl);
                    var blob = await response.blob();
                    var reader = new FileReader();

                    reader.onload = function() {
                        state.faceReferenceImage = {
                            dataUrl: reader.result,
                            base64: reader.result.split(',')[1],
                            mimeType: blob.type || 'image/jpeg'
                        };
                        state.faceReferenceLoading = false;
                        render();
                    };
                    reader.onerror = function() {
                        console.error('Failed to read face reference image');
                        state.faceReferenceLoading = false;
                        render();
                    };
                    reader.readAsDataURL(blob);
                } catch (error) {
                    console.error('Failed to load face reference:', error);
                    state.faceReferenceLoading = false;
                    render();
                }
            },

            uploadFaceReference: function() {
                var input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = function(e) {
                    var file = e.target.files[0];
                    if (!file) return;

                    state.faceReferenceLoading = true;
                    render();

                    var reader = new FileReader();
                    reader.onload = function() {
                        state.faceReferenceImage = {
                            dataUrl: reader.result,
                            base64: reader.result.split(',')[1],
                            mimeType: file.type
                        };
                        state.faceReferenceSource = 'upload';
                        state.faceReferenceLoading = false;
                        render();
                    };
                    reader.onerror = function() {
                        state.faceReferenceLoading = false;
                        render();
                    };
                    reader.readAsDataURL(file);
                };
                input.click();
            },

            clearFaceReference: function() {
                state.faceReferenceEnabled = false;
                state.faceReferenceImage = null;
                state.faceReferenceSource = 'first';
                state.faceReferenceVideoIndex = 0;
                render();
            },

            // ========== PLAYLIST MODE FUNCTIONS ==========
            setPlaylistUrl: function(url) {
                state.playlistUrl = url;
                state.playlistError = null;
            },

            fetchPlaylist: async function() {
                var url = state.playlistUrl.trim();
                if (!url) {
                    state.playlistError = 'Please enter a playlist URL';
                    render();
                    return;
                }

                state.playlistLoading = true;
                state.playlistError = null;
                state.playlistData = null;
                render();

                try {
                    var fetchPlaylistFn = firebase.functions().httpsCallable('fetchYoutubePlaylist');
                    var result = await fetchPlaylistFn({ playlistUrl: url });

                    if (result.data && result.data.success) {
                        state.playlistData = result.data;
                        // Select all videos by default
                        state.playlistSelectedVideos = result.data.videos.map(function(v) {
                            return v.videoId;
                        });
                        state.playlistResults = []; // Clear any previous results
                    } else {
                        throw new Error('Failed to fetch playlist');
                    }
                } catch (error) {
                    console.error('Playlist fetch error:', error);
                    state.playlistError = error.message || 'Failed to fetch playlist. Please check the URL.';
                }

                state.playlistLoading = false;
                render();
            },

            togglePlaylistVideo: function(videoId) {
                var idx = state.playlistSelectedVideos.indexOf(videoId);
                if (idx === -1) {
                    state.playlistSelectedVideos.push(videoId);
                } else {
                    state.playlistSelectedVideos.splice(idx, 1);
                }
                render();
            },

            toggleAllPlaylistVideos: function() {
                if (!state.playlistData) return;
                if (state.playlistSelectedVideos.length === state.playlistData.videos.length) {
                    state.playlistSelectedVideos = [];
                } else {
                    state.playlistSelectedVideos = state.playlistData.videos.map(function(v) {
                        return v.videoId;
                    });
                }
                render();
            },

            calculatePlaylistCost: function() {
                return state.playlistSelectedVideos.length * 4; // 4 tokens per upgrade
            },

            processPlaylist: async function() {
                if (!state.playlistData || state.playlistSelectedVideos.length === 0) {
                    state.error = { message: 'No videos selected. Please select at least one video.' };
                    render();
                    return;
                }

                var totalCost = this.calculatePlaylistCost();
                if (state.thumbnailTokenBalance < totalCost) {
                    state.error = { message: 'Insufficient tokens. Need ' + totalCost + ' tokens but you have ' + state.thumbnailTokenBalance };
                    render();
                    return;
                }

                state.playlistProcessing = true;
                state.playlistCurrentIndex = 0;
                state.playlistResults = [];
                state.error = null;
                render();

                var generateThumbnailPro = firebase.functions().httpsCallable('generateThumbnailPro');
                var selectedVideos = state.playlistData.videos.filter(function(v) {
                    return state.playlistSelectedVideos.indexOf(v.videoId) !== -1;
                });
                var lastRenderTime = Date.now();

                for (var i = 0; i < selectedVideos.length; i++) {
                    var video = selectedVideos[i];
                    state.playlistCurrentIndex = i;

                    // Add to results with 'generating' status
                    state.playlistResults.push({
                        videoId: video.videoId,
                        title: video.title,
                        status: 'generating',
                        thumbnailUrl: null,
                        error: null
                    });

                    // Throttle renders to prevent flickering
                    if (Date.now() - lastRenderTime > 500) {
                        render();
                        lastRenderTime = Date.now();
                    }

                    try {
                        var payload = {
                            prompt: video.title || 'Professional YouTube thumbnail',
                            mode: 'upgrade',
                            referenceType: 'upgrade',
                            // Use originalThumbnailUrl for YouTube thumbnails (not reference object)
                            originalThumbnailUrl: video.thumbnailUrl,
                            variations: 1,
                            title: video.title,
                            youtubeContext: {
                                videoId: video.videoId,
                                title: video.title,
                                description: video.description,
                                channelName: video.channelName,
                                tags: []
                            },
                            style: state.thumbnailStyle,
                            category: state.thumbnailCategory,
                            composition: state.thumbnailComposition,
                            background: state.thumbnailBackground,
                            faceStrength: state.thumbnailFaceStrength,
                            styleStrength: state.thumbnailStyleStrength,
                            expression: state.thumbnailExpression
                        };

                        // Add face reference if Face Lock is enabled
                        if (state.faceReferenceEnabled && state.faceReferenceImage) {
                            payload.faceReferenceImage = {
                                base64: state.faceReferenceImage.base64,
                                mimeType: state.faceReferenceImage.mimeType
                            };
                        }

                        var result = await generateThumbnailPro(payload);

                        if (result.data && result.data.images && result.data.images.length > 0) {
                            state.playlistResults[i].status = 'complete';
                            state.playlistResults[i].thumbnailUrl = result.data.images[0].url;
                            if (typeof result.data.newBalance !== 'undefined') {
                                state.thumbnailTokenBalance = result.data.newBalance;
                            }
                        } else {
                            throw new Error('No image generated');
                        }
                    } catch (error) {
                        console.error('Playlist generation error:', error);
                        state.playlistResults[i].status = 'error';
                        state.playlistResults[i].error = error.message || 'Generation failed';
                    }

                    // Render after each completed/failed item
                    render();
                    lastRenderTime = Date.now();

                    // Small delay between requests
                    await new Promise(function(resolve) { setTimeout(resolve, 1500); });
                }

                state.playlistProcessing = false;
                render();
            },

            downloadPlaylistAsZip: async function() {
                // Delegate to the new downloadAllAsZip function
                return app.downloadAllAsZip('playlist', false);
            },

            clearPlaylist: function() {
                state.playlistUrl = '';
                state.playlistData = null;
                state.playlistError = null;
                state.playlistSelectedVideos = [];
                state.playlistResults = [];
                state.playlistProcessing = false;
                render();
            },

            // Regenerate a single failed playlist item
            regeneratePlaylistItem: async function(idx) {
                var item = state.playlistResults[idx];
                if (!item || item.status !== 'error') return;

                // Find the video data from playlistData
                var video = state.playlistData?.videos?.find(function(v) {
                    return v.videoId === item.videoId;
                });
                if (!video) {
                    console.error('Video not found for regeneration');
                    return;
                }

                item.status = 'regenerating';
                item.error = null;
                render();

                try {
                    var generateThumbnailPro = firebase.functions().httpsCallable('generateThumbnailPro');
                    var payload = {
                        prompt: video.title || 'Professional YouTube thumbnail',
                        mode: 'upgrade',
                        referenceType: 'upgrade',
                        originalThumbnailUrl: video.thumbnailUrl,
                        variations: 1,
                        title: video.title,
                        youtubeContext: {
                            videoId: video.videoId,
                            title: video.title,
                            channelName: state.playlistData?.channelTitle || '',
                            description: video.description || ''
                        },
                        style: state.thumbnailStyle,
                        category: state.thumbnailCategory
                    };

                    // Add face reference if Face Lock is enabled
                    if (state.faceReferenceEnabled && state.faceReferenceImage) {
                        payload.faceReferenceImage = {
                            base64: state.faceReferenceImage.base64,
                            mimeType: state.faceReferenceImage.mimeType
                        };
                    }

                    var result = await generateThumbnailPro(payload);

                    if (result.data && result.data.images && result.data.images.length > 0) {
                        item.status = 'complete';
                        item.thumbnailUrl = result.data.images[0].url;
                        if (typeof result.data.newBalance !== 'undefined') {
                            state.thumbnailTokenBalance = result.data.newBalance;
                        }
                    } else {
                        throw new Error('No image generated');
                    }
                } catch (error) {
                    console.error('Regeneration error:', error);
                    item.status = 'error';
                    item.error = error.message || 'Regeneration failed';
                }

                render();
            },

            // Retry all failed playlist items
            retryFailedPlaylistItems: async function() {
                var failedIndices = [];
                state.playlistResults.forEach(function(item, idx) {
                    if (item.status === 'error') {
                        failedIndices.push(idx);
                    }
                });

                if (failedIndices.length === 0) return;

                // Process failed items sequentially
                for (var i = 0; i < failedIndices.length; i++) {
                    await app.regeneratePlaylistItem(failedIndices[i]);
                    // Small delay between retries
                    if (i < failedIndices.length - 1) {
                        await new Promise(function(resolve) { setTimeout(resolve, 1500); });
                    }
                }
            },

            calculateThumbnailCost: function() {
                var modeCosts = {
                    quick: 2,
                    reference: 4,
                    upgrade: 4
                };
                var baseCost = modeCosts[state.thumbnailMode] || 2;
                state.thumbnailTokenCost = baseCost * state.thumbnailVariations;
                return state.thumbnailTokenCost;
            },

            loadThumbnailTokenBalance: function() {
                // Check for auth like Creative Studio does
                if (!auth.currentUser) {
                    console.log('No auth user, skipping token load');
                    return;
                }

                // Helper to safely parse balance (handles string, number, undefined)
                function parseBalance(val) {
                    var num = Number(val);
                    return isNaN(num) || num < 0 ? 50 : num;
                }

                // Use same function as Creative Studio (already deployed and working)
                var getCreativeTokens = functions.httpsCallable('getCreativeTokens');
                getCreativeTokens({})
                    .then(function(result) {
                        if (result.data) {
                            // Parse balance properly - handles strings like "44" as well as numbers
                            state.thumbnailTokenBalance = parseBalance(result.data.balance);
                            state.thumbnailTokenPlan = result.data.plan || 'free';
                            state.thumbnailTokenRollover = Number(result.data.rollover) || 0;
                            console.log('Token balance loaded:', state.thumbnailTokenBalance, 'Plan:', state.thumbnailTokenPlan);
                            render();
                        }
                    })
                    .catch(function(e) {
                        console.error('Failed to load token balance:', e);
                        // Fallback to direct Firestore read
                        db.collection('creativeTokens').doc(auth.currentUser.uid).get()
                            .then(function(doc) {
                                if (doc.exists) {
                                    var data = doc.data();
                                    state.thumbnailTokenBalance = parseBalance(data.balance);
                                    state.thumbnailTokenPlan = data.plan || 'free';
                                    state.thumbnailTokenRollover = Number(data.rollover) || 0;
                                    console.log('Token balance loaded from Firestore fallback:', state.thumbnailTokenBalance);
                                    render();
                                } else {
                                    console.log('No token document found, using defaults');
                                    state.thumbnailTokenBalance = 50;
                                    render();
                                }
                            })
                            .catch(function(err) {
                                console.error('Firestore fallback failed:', err);
                            });
                    });
            },

            showTokenUsageModal: function() {
                state.showTokenModal = true;
                render();
            },

            hideTokenUsageModal: function() {
                state.showTokenModal = false;
                render();
            },

            // Quota Bypass Modal Functions
            showQuotaBypassModal: function(tool, toolName, errorDetails, pendingAction) {
                var tokenBypass = errorDetails.tokenBypass || {};
                state.quotaBypassData = {
                    tool: tool,
                    toolName: toolName,
                    tokenCost: tokenBypass.cost || 3,
                    tokenBalance: tokenBypass.balance || 0,
                    remainingMs: errorDetails.remainingMs || 0,
                    canBypass: tokenBypass.canBypass || false,
                    pendingAction: pendingAction // Function to call after bypass
                };
                state.showQuotaBypassModal = true;
                render();
            },

            hideQuotaBypassModal: function() {
                state.showQuotaBypassModal = false;
                state.quotaBypassData = null;
                render();
            },

            useTokensForBypass: function() {
                if (!state.quotaBypassData) return;

                var tool = state.quotaBypassData.tool;
                var pendingAction = state.quotaBypassData.pendingAction;
                var tokenCost = state.quotaBypassData.tokenCost;

                // Show loading state
                state.quotaBypassData.processing = true;
                render();

                var useTokensForQuotaBypass = functions.httpsCallable('useTokensForQuotaBypass');
                useTokensForQuotaBypass({ tool: tool })
                    .then(function(result) {
                        if (result.data && result.data.success) {
                            // Update token balance in state
                            state.thumbnailTokenBalance = result.data.newBalance;

                            // Close modal
                            app.hideQuotaBypassModal();

                            // Show success toast
                            utils.showToast('Used ' + tokenCost + ' tokens - proceeding with ' + state.quotaBypassData.toolName, 'success');

                            // Execute the pending action if provided
                            if (pendingAction && typeof pendingAction === 'function') {
                                pendingAction(true); // true = bypassed with tokens
                            }
                        }
                    })
                    .catch(function(error) {
                        console.error('Token bypass error:', error);
                        state.quotaBypassData.processing = false;
                        state.quotaBypassData.error = error.message || 'Failed to use tokens';
                        render();
                    });
            },

            formatBypassCountdown: function(ms) {
                if (!ms || ms <= 0) return '0m';
                var totalSeconds = Math.ceil(ms / 1000);
                var hours = Math.floor(totalSeconds / 3600);
                var minutes = Math.floor((totalSeconds % 3600) / 60);
                var seconds = totalSeconds % 60;

                if (hours > 0) {
                    return hours + 'h ' + minutes + 'm';
                } else if (minutes > 0) {
                    return minutes + 'm ' + seconds + 's';
                } else {
                    return seconds + 's';
                }
            },

            // Token Modal Functions
            showTokenModal: function() {
                // Load token bypass costs if not already loaded
                if (!state.tokenBypassCosts) {
                    app.loadTokenBypassCosts();
                }
                state.showTokenModal = true;
                render();
            },

            hideTokenModal: function() {
                state.showTokenModal = false;
                render();
            },

            loadTokenBypassCosts: function() {
                var getTokenBypassInfo = functions.httpsCallable('getTokenBypassInfo');
                getTokenBypassInfo({ tool: 'all' })
                    .then(function(result) {
                        if (result.data) {
                            state.tokenBypassCosts = result.data.costs || {};
                            // Also update token balance
                            if (result.data.balance !== undefined) {
                                state.thumbnailTokenBalance = result.data.balance;
                            }
                            render();
                        }
                    })
                    .catch(function(error) {
                        console.error('Failed to load token bypass costs:', error);
                    });
            },

            topUpTokens: function() {
                // Placeholder for token top-up - will be implemented with payment integration
                utils.showToast('Token TopUp coming soon! Contact support for now.', 'info');
            },

            handleReferenceUpload: function(e) {
                var file = e.target.files[0];
                if (!file) return;

                // Validate file type
                var validTypes = ['image/jpeg', 'image/png', 'image/webp'];
                if (!validTypes.includes(file.type)) {
                    state.error = { message: 'Please upload a JPG, PNG, or WebP image' };
                    render();
                    return;
                }

                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    state.error = { message: 'Image must be less than 5MB' };
                    render();
                    return;
                }

                // Read file as data URL
                var reader = new FileReader();
                reader.onload = function(event) {
                    state.thumbnailReference = {
                        dataUrl: event.target.result,
                        file: file,
                        mimeType: file.type,
                        name: file.name
                    };
                    // Auto-switch to reference mode
                    state.thumbnailMode = 'reference';
                    app.calculateThumbnailCost();
                    render();
                };
                reader.readAsDataURL(file);
            },

            removeReference: function() {
                state.thumbnailReference = null;
                // Reset file input
                var input = document.getElementById('reference-upload');
                if (input) input.value = '';
                render();
            },

            selectThumbnail: function(index) {
                state.selectedThumbnailIndex = index;
                render();
            },

            toggleYouTubePreview: function() {
                state.showYouTubePreview = !state.showYouTubePreview;
                render();
            },

            generateThumbnailPro: function(e) {
                e.preventDefault();
                var title = document.getElementById('thumbnail-title').value.trim();
                var customPrompt = document.getElementById('thumbnail-prompt')?.value.trim() || '';

                // For upgrade mode with YouTube data, use YouTube title as fallback
                if (!title && state.thumbnailMode === 'upgrade' && state.thumbnailYoutubeData && state.thumbnailYoutubeData.title) {
                    title = state.thumbnailYoutubeData.title;
                }

                if (!title) {
                    state.error = { message: 'Please enter a video title' };
                    render();
                    return;
                }

                // Check token balance
                var cost = app.calculateThumbnailCost();
                if (state.thumbnailTokenBalance < cost) {
                    state.error = { message: 'Insufficient tokens. You need ' + cost + ' tokens but have ' + state.thumbnailTokenBalance + '. Visit Creative Studio to get more tokens.' };
                    render();
                    return;
                }

                // Validate reference for reference mode
                if (state.thumbnailMode === 'reference' && !state.thumbnailReference) {
                    state.error = { message: 'Please upload a reference image for Reference Mode' };
                    render();
                    return;
                }

                state.loading = true;
                state.error = null;
                state.thumbnailImage = null;
                state.generatedThumbnails = [];
                state.selectedThumbnailIndex = 0;
                state.loadingSteps = [
                    { name: 'Preparing request', icon: '' },
                    { name: 'Optimizing prompt', icon: '' },
                    { name: 'Generating ' + state.thumbnailVariations + ' image' + (state.thumbnailVariations > 1 ? 's' : ''), icon: '' },
                    { name: 'Finalizing', icon: '' }
                ];
                startLoadingProgress();
                render();

                // Build request payload
                var payload = {
                    title: title,
                    customPrompt: customPrompt,
                    style: state.thumbnailStyle,
                    mode: state.thumbnailMode,
                    category: state.thumbnailCategory,
                    variations: state.thumbnailVariations,
                    // Phase 8: Advanced options
                    compositionTemplate: state.thumbnailComposition,
                    backgroundStyle: state.thumbnailBackground
                };

                // Add reference image if in reference mode
                if (state.thumbnailMode === 'reference' && state.thumbnailReference) {
                    // Extract base64 data from data URL
                    var dataUrl = state.thumbnailReference.dataUrl;
                    var base64 = dataUrl.split(',')[1];
                    payload.referenceImage = {
                        base64: base64,
                        mimeType: state.thumbnailReference.mimeType
                    };

                    // Phase 8: Reference-specific advanced options
                    payload.referenceType = state.thumbnailReferenceType;
                    payload.faceStrength = state.thumbnailFaceStrength;
                    payload.styleStrength = state.thumbnailStyleStrength;
                    payload.expressionModifier = state.thumbnailExpression;
                }

                // Add reference image for upgrade mode
                if (state.thumbnailMode === 'upgrade' && state.thumbnailReference) {
                    // Check if this is a YouTube thumbnail (URL) or uploaded file (data URL)
                    if (state.thumbnailReference.isYoutubeThumbnail) {
                        // YouTube thumbnail - pass URL for backend to fetch
                        payload.originalThumbnailUrl = state.thumbnailReference.dataUrl;
                        payload.referenceType = 'upgrade';

                        // Pass YouTube context if available (including tags for SEO)
                        if (state.thumbnailYoutubeData) {
                            payload.youtubeContext = {
                                videoId: state.thumbnailYoutubeData.videoId,
                                title: state.thumbnailYoutubeData.title,
                                description: state.thumbnailYoutubeData.description,
                                channelName: state.thumbnailYoutubeData.channelName,
                                tags: state.thumbnailYoutubeData.tags || []
                            };
                        }
                    } else {
                        // Uploaded file - extract base64
                        var dataUrl = state.thumbnailReference.dataUrl;
                        var base64 = dataUrl.split(',')[1];
                        payload.referenceImage = {
                            base64: base64,
                            mimeType: state.thumbnailReference.mimeType
                        };
                        payload.referenceType = 'upgrade';
                    }
                }

                functions.httpsCallable('generateThumbnailPro')(payload)
                    .then(function(result) {
                        stopLoadingProgress();
                        state.loading = false;

                        if (result.data.success) {
                            state.generatedThumbnails = result.data.images || [];
                            state.thumbnailImage = result.data.imageUrl;
                            // Parse remaining balance as number (handles strings)
                            var remaining = Number(result.data.remainingBalance);
                            state.thumbnailTokenBalance = isNaN(remaining) ? 0 : remaining;
                            state.selectedThumbnailIndex = 0;

                            // Show success toast
                            if (typeof showToast === 'function') {
                                showToast('Generated ' + state.generatedThumbnails.length + ' thumbnail(s)! (-' + result.data.tokenCost + ' tokens)', 'success');
                            }
                        } else {
                            state.error = { message: result.data.message || 'Generation failed' };
                        }
                        render();
                    })
                    .catch(function(e) {
                        stopLoadingProgress();
                        state.loading = false;
                        // Check for token bypass option
                        if (e.code === 'functions/resource-exhausted' && e.details && e.details.tokenBypass && e.details.tokenBypass.available) {
                            app.showQuotaBypassModal(
                                e.details.toolType || 'thumbnailGeneratorPro',
                                'Thumbnail Generator Pro',
                                e.details,
                                function() { app.generateThumbnailPro({ preventDefault: function(){} }); }
                            );
                            return;
                        }
                        state.error = { message: 'Generation failed: ' + e.message };
                        render();
                    });
            },

            downloadThumbnail: async function(url, index) {
                try {
                    // Show loading state on the button
                    var btn = document.querySelector('[data-download-btn="' + index + '"]');
                    if (btn) {
                        btn.disabled = true;
                        btn.innerHTML = '<span class="animate-spin"></span> Downloading...';
                    }

                    // Fetch image as blob to bypass cross-origin restriction
                    var response = await fetch(url);
                    var blob = await response.blob();
                    var blobUrl = URL.createObjectURL(blob);

                    var link = document.createElement('a');
                    link.href = blobUrl;
                    link.download = 'thumbnail-' + (index + 1) + '.png';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // Cleanup
                    URL.revokeObjectURL(blobUrl);

                    // Restore button
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<span></span> Download';
                    }
                } catch (error) {
                    console.error('Download failed:', error);
                    // Fallback: open in new tab
                    window.open(url, '_blank');

                    var btn = document.querySelector('[data-download-btn="' + index + '"]');
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<span></span> Download';
                    }
                }
            },

            previewThumbnail: function(url) {
                window.open(url, '_blank');
            },

            resetThumbnailGenerator: function() {
                state.thumbnailImage = null;
                state.generatedThumbnails = [];
                state.selectedThumbnailIndex = 0;
                state.error = null;
                render();
            },

            /* ------------------------------------------
               4.5.7b HD Upscale Actions
               ------------------------------------------ */

            // Upscale a single thumbnail to HD (1920x1080)
            upscaleThumbnail: async function(imageUrl, itemIndex, mode) {
                // mode: 'single' | 'bulk' | 'playlist'
                state.hdUpscaleLoading = true;
                state.hdUpscalingIndex = itemIndex;
                state.hdUpscalingMode = mode;
                render();

                try {
                    var upscale = firebase.functions().httpsCallable('upscaleThumbnail');
                    var result = await upscale({ imageUrl: imageUrl });

                    if (result.data.success) {
                        // Update item based on mode
                        if (mode === 'bulk' && state.bulkUrls[itemIndex]) {
                            state.bulkUrls[itemIndex].hdUrl = result.data.hdUrl;
                        } else if (mode === 'playlist' && state.playlistResults[itemIndex]) {
                            state.playlistResults[itemIndex].hdUrl = result.data.hdUrl;
                        } else if (mode === 'single' && state.generatedThumbnails[itemIndex]) {
                            state.generatedThumbnails[itemIndex].hdUrl = result.data.hdUrl;
                        }

                        // Refresh token balance
                        await app.refreshTokenBalance();
                    }
                } catch (error) {
                    console.error('HD Upscale failed:', error);
                    state.error = { message: 'HD Upscale failed: ' + (error.message || 'Unknown error') };
                }

                state.hdUpscaleLoading = false;
                state.hdUpscalingIndex = null;
                state.hdUpscalingMode = null;
                render();
            },

            // Upscale all thumbnails in bulk/playlist mode
            upscaleAllThumbnails: async function(mode) {
                var images = [];

                if (mode === 'bulk') {
                    state.bulkUrls.forEach(function(item, idx) {
                        if (item.status === 'complete' && item.generatedThumbnail && !item.hdUrl) {
                            images.push({ url: item.generatedThumbnail, id: idx });
                        }
                    });
                } else if (mode === 'playlist') {
                    state.playlistResults.forEach(function(item, idx) {
                        if (item.status === 'complete' && item.thumbnailUrl && !item.hdUrl) {
                            images.push({ url: item.thumbnailUrl, id: idx });
                        }
                    });
                }

                if (images.length === 0) {
                    state.error = { message: 'No images to upscale' };
                    render();
                    return;
                }

                // Confirm cost
                var totalCost = images.length * state.hdUpscaleCost;
                if (!confirm('Upscale ' + images.length + ' images to HD for ' + totalCost + ' credit(s)?')) {
                    return;
                }

                state.hdUpscaleLoading = true;
                render();

                try {
                    var upscaleBatch = firebase.functions().httpsCallable('upscaleBatch');
                    var result = await upscaleBatch({ images: images });

                    if (result.data.success) {
                        // Update items with HD URLs
                        result.data.results.forEach(function(r) {
                            if (r.status === 'success') {
                                if (mode === 'bulk' && state.bulkUrls[r.id]) {
                                    state.bulkUrls[r.id].hdUrl = r.hdUrl;
                                } else if (mode === 'playlist' && state.playlistResults[r.id]) {
                                    state.playlistResults[r.id].hdUrl = r.hdUrl;
                                }
                            }
                        });

                        // Refresh token balance
                        await app.refreshTokenBalance();

                        // Show success message
                        if (result.data.failedCount > 0) {
                            state.error = { message: 'Upscaled ' + result.data.successCount + ' images. ' + result.data.failedCount + ' failed.' };
                        }
                    }
                } catch (error) {
                    console.error('Batch upscale failed:', error);
                    state.error = { message: 'Batch upscale failed: ' + (error.message || 'Unknown error') };
                }

                state.hdUpscaleLoading = false;
                render();
            },

            /* ------------------------------------------
               4.5.7c Thumbnail AI Editing (Inpainting)
               ------------------------------------------ */

            // Open the thumbnail editor modal
            openThumbnailEditor: function(imageUrl, itemIndex, mode) {
                state.thumbnailEditMode = true;
                state.thumbnailEditingImage = {
                    url: imageUrl,
                    index: itemIndex,
                    mode: mode // 'single' | 'playlist' | 'bulk'
                };
                state.thumbnailEditPrompt = '';
                state.thumbnailEditError = null;
                state.thumbnailEditResult = null;
                state.thumbnailEditHistory = [];
                render();

                // Initialize canvas after render
                setTimeout(function() {
                    app.initThumbnailEditCanvas();
                }, 100);
            },

            // Close the thumbnail editor modal
            closeThumbnailEditor: function() {
                state.thumbnailEditMode = false;
                state.thumbnailEditingImage = null;
                state.thumbnailEditPrompt = '';
                state.thumbnailEditError = null;
                state.thumbnailEditResult = null;
                state.thumbnailEditLoading = false;
                state.thumbnailEditOriginalData = null;
                state.thumbnailEditMaskCanvas = null;
                state.thumbnailEditMaskCtx = null;
                state.thumbnailEditHistory = [];
                // Reset drawing state
                app._editCanvasReady = false;
                app._editDrawing = false;
                render();
            },

            // Drawing state (needs to be accessible across event handlers)
            _editDrawing: false,
            _editLastX: 0,
            _editLastY: 0,
            _editCanvasReady: false,
            _editListenersAttached: false,

            // Initialize the canvas for editing
            initThumbnailEditCanvas: function() {
                console.log('initThumbnailEditCanvas called');

                var canvas = document.getElementById('thumbnail-edit-canvas');
                if (!canvas) {
                    console.log('Canvas element not found, retrying in 200ms');
                    setTimeout(function() { app.initThumbnailEditCanvas(); }, 200);
                    return;
                }

                if (!state.thumbnailEditingImage) {
                    console.log('No image to edit');
                    return;
                }

                // Reset drawing state
                app._editDrawing = false;
                app._editCanvasReady = false;

                // Set up document-level event listeners (only once)
                if (!app._editListenersAttached) {
                    app.setupEditEventListeners();
                    app._editListenersAttached = true;
                }

                var ctx = canvas.getContext('2d');
                var img = new Image();
                img.crossOrigin = 'anonymous';

                img.onload = function() {
                    console.log('Image loaded:', img.width, 'x', img.height);

                    // Set canvas size - maintain aspect ratio, max width 650px
                    var maxWidth = 650;
                    var scale = Math.min(1, maxWidth / img.width);
                    canvas.width = Math.floor(img.width * scale);
                    canvas.height = Math.floor(img.height * scale);

                    // Store original dimensions for export
                    canvas.dataset.originalWidth = img.width;
                    canvas.dataset.originalHeight = img.height;

                    // Draw image
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    // Store original image data
                    try {
                        state.thumbnailEditOriginalData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    } catch (e) {
                        console.error('Failed to get image data (CORS?):', e);
                        state.thumbnailEditError = 'Cannot edit this image due to security restrictions.';
                        render();
                        return;
                    }

                    // Create mask canvas (overlay)
                    var maskCanvas = document.createElement('canvas');
                    maskCanvas.width = canvas.width;
                    maskCanvas.height = canvas.height;
                    state.thumbnailEditMaskCanvas = maskCanvas;
                    state.thumbnailEditMaskCtx = maskCanvas.getContext('2d');

                    // Fill with black (unmasked)
                    state.thumbnailEditMaskCtx.fillStyle = 'black';
                    state.thumbnailEditMaskCtx.fillRect(0, 0, maskCanvas.width, maskCanvas.height);

                    // Mark canvas as ready
                    app._editCanvasReady = true;

                    // Set cursor
                    canvas.style.cursor = 'crosshair';

                    console.log('Canvas ready for drawing:', canvas.width, 'x', canvas.height);
                };

                img.onerror = function(e) {
                    console.error('Failed to load image:', e);
                    state.thumbnailEditError = 'Failed to load image. Please try again.';
                    render();
                };

                img.src = state.thumbnailEditingImage.url;
            },

            // Setup document-level event listeners for drawing
            setupEditEventListeners: function() {
                console.log('Setting up edit event listeners');

                // Mouse events at document level
                document.addEventListener('mousedown', function(e) {
                    var canvas = document.getElementById('thumbnail-edit-canvas');
                    if (!canvas || e.target !== canvas || !app._editCanvasReady) return;

                    e.preventDefault();
                    app._editDrawing = true;

                    var rect = canvas.getBoundingClientRect();
                    var scaleX = canvas.width / rect.width;
                    var scaleY = canvas.height / rect.height;
                    app._editLastX = (e.clientX - rect.left) * scaleX;
                    app._editLastY = (e.clientY - rect.top) * scaleY;

                    app.saveEditHistory();
                    app.paintMask(app._editLastX, app._editLastY);
                });

                document.addEventListener('mousemove', function(e) {
                    if (!app._editDrawing || !app._editCanvasReady) return;

                    var canvas = document.getElementById('thumbnail-edit-canvas');
                    if (!canvas) return;

                    var rect = canvas.getBoundingClientRect();
                    var scaleX = canvas.width / rect.width;
                    var scaleY = canvas.height / rect.height;
                    var x = (e.clientX - rect.left) * scaleX;
                    var y = (e.clientY - rect.top) * scaleY;

                    app.paintMaskLine(app._editLastX, app._editLastY, x, y);
                    app._editLastX = x;
                    app._editLastY = y;
                });

                document.addEventListener('mouseup', function(e) {
                    app._editDrawing = false;
                });

                // Touch events
                document.addEventListener('touchstart', function(e) {
                    var canvas = document.getElementById('thumbnail-edit-canvas');
                    if (!canvas || e.target !== canvas || !app._editCanvasReady) return;

                    e.preventDefault();
                    app._editDrawing = true;

                    var touch = e.touches[0];
                    var rect = canvas.getBoundingClientRect();
                    var scaleX = canvas.width / rect.width;
                    var scaleY = canvas.height / rect.height;
                    app._editLastX = (touch.clientX - rect.left) * scaleX;
                    app._editLastY = (touch.clientY - rect.top) * scaleY;

                    app.saveEditHistory();
                    app.paintMask(app._editLastX, app._editLastY);
                }, { passive: false });

                document.addEventListener('touchmove', function(e) {
                    if (!app._editDrawing || !app._editCanvasReady) return;

                    var canvas = document.getElementById('thumbnail-edit-canvas');
                    if (!canvas) return;

                    e.preventDefault();
                    var touch = e.touches[0];
                    var rect = canvas.getBoundingClientRect();
                    var scaleX = canvas.width / rect.width;
                    var scaleY = canvas.height / rect.height;
                    var x = (touch.clientX - rect.left) * scaleX;
                    var y = (touch.clientY - rect.top) * scaleY;

                    app.paintMaskLine(app._editLastX, app._editLastY, x, y);
                    app._editLastX = x;
                    app._editLastY = y;
                }, { passive: false });

                document.addEventListener('touchend', function(e) {
                    app._editDrawing = false;
                });
            },

            // Paint a single point on the mask
            paintMask: function(x, y) {
                if (!state.thumbnailEditMaskCtx) {
                    console.log('paintMask: No mask context');
                    return;
                }

                console.log('paintMask at:', x, y, 'brush size:', state.thumbnailEditBrushSize);

                // Paint on mask canvas (white for area to edit)
                state.thumbnailEditMaskCtx.fillStyle = 'white';
                state.thumbnailEditMaskCtx.beginPath();
                state.thumbnailEditMaskCtx.arc(x, y, state.thumbnailEditBrushSize / 2, 0, Math.PI * 2);
                state.thumbnailEditMaskCtx.fill();

                // Redraw with overlay
                app.redrawCanvasWithMask();
            },

            // Paint a line on the mask (for smooth strokes)
            paintMaskLine: function(x1, y1, x2, y2) {
                if (!state.thumbnailEditMaskCtx) {
                    console.log('paintMaskLine: No mask context');
                    return;
                }

                // Draw line on mask
                state.thumbnailEditMaskCtx.strokeStyle = 'white';
                state.thumbnailEditMaskCtx.lineWidth = state.thumbnailEditBrushSize;
                state.thumbnailEditMaskCtx.lineCap = 'round';
                state.thumbnailEditMaskCtx.lineJoin = 'round';
                state.thumbnailEditMaskCtx.beginPath();
                state.thumbnailEditMaskCtx.moveTo(x1, y1);
                state.thumbnailEditMaskCtx.lineTo(x2, y2);
                state.thumbnailEditMaskCtx.stroke();

                // Redraw with overlay
                app.redrawCanvasWithMask();
            },

            // Redraw canvas with mask overlay
            redrawCanvasWithMask: function() {
                var canvas = document.getElementById('thumbnail-edit-canvas');
                if (!canvas || !state.thumbnailEditOriginalData) {
                    console.log('redrawCanvasWithMask: missing canvas or data');
                    return;
                }

                var ctx = canvas.getContext('2d');

                // Step 1: Draw original image using a temp canvas (putImageData bypasses compositing)
                var imgCanvas = document.createElement('canvas');
                imgCanvas.width = canvas.width;
                imgCanvas.height = canvas.height;
                var imgCtx = imgCanvas.getContext('2d');
                imgCtx.putImageData(state.thumbnailEditOriginalData, 0, 0);

                // Clear and draw original
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(imgCanvas, 0, 0);

                // Step 2: Draw pink overlay where mask is white
                if (state.thumbnailEditMaskCanvas) {
                    // Get mask data to check where we painted
                    var maskCtx = state.thumbnailEditMaskCtx;
                    var maskData = maskCtx.getImageData(0, 0, state.thumbnailEditMaskCanvas.width, state.thumbnailEditMaskCanvas.height);

                    // Create overlay with pink where mask is white
                    var overlayCanvas = document.createElement('canvas');
                    overlayCanvas.width = canvas.width;
                    overlayCanvas.height = canvas.height;
                    var overlayCtx = overlayCanvas.getContext('2d');

                    // Draw the mask
                    overlayCtx.drawImage(state.thumbnailEditMaskCanvas, 0, 0);

                    // Use the mask to create pink overlay
                    var overlayData = overlayCtx.getImageData(0, 0, overlayCanvas.width, overlayCanvas.height);
                    for (var i = 0; i < overlayData.data.length; i += 4) {
                        if (overlayData.data[i] > 128) { // If red channel > 128 (white in mask)
                            // Set to pink with transparency
                            overlayData.data[i] = 236;     // R
                            overlayData.data[i + 1] = 72;  // G
                            overlayData.data[i + 2] = 153; // B
                            overlayData.data[i + 3] = 128; // A (semi-transparent)
                        } else {
                            // Fully transparent
                            overlayData.data[i + 3] = 0;
                        }
                    }
                    overlayCtx.putImageData(overlayData, 0, 0);

                    // Draw overlay on main canvas
                    ctx.drawImage(overlayCanvas, 0, 0);
                }
            },

            // Get mask as base64 PNG (scaled to original image dimensions)
            getMaskAsBase64: function() {
                if (!state.thumbnailEditMaskCanvas) return null;

                var canvas = document.getElementById('thumbnail-edit-canvas');
                var originalWidth = parseInt(canvas.dataset.originalWidth) || 1280;
                var originalHeight = parseInt(canvas.dataset.originalHeight) || 720;

                // Create export canvas at original image size
                var exportCanvas = document.createElement('canvas');
                exportCanvas.width = originalWidth;
                exportCanvas.height = originalHeight;
                var ctx = exportCanvas.getContext('2d');

                // Fill with black background
                ctx.fillStyle = 'black';
                ctx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);

                // Draw scaled mask
                ctx.drawImage(state.thumbnailEditMaskCanvas, 0, 0, exportCanvas.width, exportCanvas.height);

                // Check if mask has any white pixels (edited areas)
                var imageData = ctx.getImageData(0, 0, exportCanvas.width, exportCanvas.height);
                var hasContent = false;
                for (var i = 0; i < imageData.data.length; i += 4) {
                    if (imageData.data[i] > 128) { // R channel > 128 means white
                        hasContent = true;
                        break;
                    }
                }

                if (!hasContent) return null;

                return exportCanvas.toDataURL('image/png').split(',')[1];
            },

            // Set brush size
            setEditBrushSize: function(size) {
                state.thumbnailEditBrushSize = parseInt(size) || 30;
                // Update cursor size indicator if we want to show it
            },

            // Set edit prompt
            setEditPrompt: function(prompt) {
                state.thumbnailEditPrompt = prompt;
            },

            // Clear the mask
            clearEditMask: function() {
                if (!state.thumbnailEditMaskCtx) return;

                app.saveEditHistory();
                state.thumbnailEditMaskCtx.fillStyle = 'black';
                state.thumbnailEditMaskCtx.fillRect(0, 0, state.thumbnailEditMaskCanvas.width, state.thumbnailEditMaskCanvas.height);
                app.redrawCanvasWithMask();
            },

            // Save current mask state to history for undo
            saveEditHistory: function() {
                if (!state.thumbnailEditMaskCanvas) return;

                // Keep max 10 history items
                if (state.thumbnailEditHistory.length >= 10) {
                    state.thumbnailEditHistory.shift();
                }

                state.thumbnailEditHistory.push(
                    state.thumbnailEditMaskCtx.getImageData(0, 0, state.thumbnailEditMaskCanvas.width, state.thumbnailEditMaskCanvas.height)
                );
            },

            // Undo last mask stroke
            undoEditMask: function() {
                if (!state.thumbnailEditMaskCtx || state.thumbnailEditHistory.length === 0) return;

                var lastState = state.thumbnailEditHistory.pop();
                state.thumbnailEditMaskCtx.putImageData(lastState, 0, 0);
                app.redrawCanvasWithMask();
            },

            // Apply the edit via AI
            applyThumbnailEdit: async function() {
                if (!state.thumbnailEditingImage) {
                    state.thumbnailEditError = 'No image selected for editing';
                    render();
                    return;
                }

                // Mask is OPTIONAL - if not provided, AI will edit based on prompt alone
                var maskBase64 = app.getMaskAsBase64();

                // Get prompt - if empty but mask exists, default to "remove marked area"
                var editPrompt = state.thumbnailEditPrompt.trim();
                if (!editPrompt) {
                    if (maskBase64) {
                        // User painted something but didn't write text - default to remove
                        editPrompt = 'Remove/erase the marked area and fill with appropriate background';
                    } else {
                        state.thumbnailEditError = 'Please enter what you want to change, or paint an area to remove';
                        render();
                        return;
                    }
                }

                state.thumbnailEditLoading = true;
                state.thumbnailEditError = null;
                render();

                try {
                    var editThumbnail = firebase.functions().httpsCallable('editThumbnailWithAI');
                    var requestData = {
                        imageUrl: state.thumbnailEditingImage.url,
                        editPrompt: editPrompt
                    };

                    // Only include mask if user painted something
                    if (maskBase64) {
                        requestData.maskBase64 = maskBase64;
                    }

                    var result = await editThumbnail(requestData);

                    if (result.data.success) {
                        state.thumbnailEditResult = {
                            originalUrl: state.thumbnailEditingImage.url,
                            editedUrl: result.data.editedUrl
                        };

                        // Update token balance
                        if (result.data.remainingBalance !== undefined) {
                            state.thumbnailTokenBalance = result.data.remainingBalance;
                        }

                        showToast('Edit applied! Review the changes below.', 'success');
                    } else {
                        throw new Error(result.data.error || 'Edit failed');
                    }
                } catch (error) {
                    console.error('Thumbnail edit error:', error);
                    state.thumbnailEditError = error.message || 'Failed to edit thumbnail. Please try again.';
                }

                state.thumbnailEditLoading = false;
                render();
            },

            // Accept the edited thumbnail
            acceptEdit: function() {
                if (!state.thumbnailEditResult || !state.thumbnailEditingImage) return;

                var editedUrl = state.thumbnailEditResult.editedUrl;
                var info = state.thumbnailEditingImage;

                // Update the appropriate array based on mode
                if (info.mode === 'single') {
                    if (state.generatedThumbnails[info.index]) {
                        state.generatedThumbnails[info.index].url = editedUrl;
                        state.generatedThumbnails[info.index].hdUrl = null; // Reset HD since image changed
                    }
                } else if (info.mode === 'playlist') {
                    if (state.playlistResults[info.index]) {
                        state.playlistResults[info.index].thumbnailUrl = editedUrl;
                        state.playlistResults[info.index].hdUrl = null;
                    }
                } else if (info.mode === 'bulk') {
                    if (state.bulkUrls && state.bulkUrls[info.index]) {
                        state.bulkUrls[info.index].generatedThumbnail = editedUrl;
                        state.bulkUrls[info.index].hdUrl = null;
                    }
                }

                app.closeThumbnailEditor();
                showToast('Thumbnail updated successfully!', 'success');
            },

            // Revert to start a new edit
            revertEdit: function() {
                state.thumbnailEditResult = null;
                state.thumbnailEditPrompt = '';
                state.thumbnailEditError = null;
                state.thumbnailEditHistory = [];
                // Reset canvas state
                state.thumbnailEditOriginalData = null;
                state.thumbnailEditMaskCanvas = null;
                state.thumbnailEditMaskCtx = null;
                app._editCanvasReady = false;
                app._editDrawing = false;
                render();
                // Reinitialize canvas after render
                setTimeout(function() {
                    app.initThumbnailEditCanvas();
                }, 150);
            },

            // Download HD version of a thumbnail
            downloadHdThumbnail: async function(hdUrl, index) {
                try {
                    var btn = document.querySelector('[data-hd-download-btn="' + index + '"]');
                    if (btn) {
                        btn.disabled = true;
                        btn.innerHTML = '<span class="animate-spin"></span> Downloading...';
                    }

                    var response = await fetch(hdUrl);
                    var blob = await response.blob();
                    var blobUrl = URL.createObjectURL(blob);

                    var link = document.createElement('a');
                    link.href = blobUrl;
                    link.download = 'thumbnail-hd-' + (index + 1) + '.png';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    URL.revokeObjectURL(blobUrl);

                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = ' HD';
                    }
                } catch (error) {
                    console.error('HD Download failed:', error);
                    window.open(hdUrl, '_blank');

                    var btn = document.querySelector('[data-hd-download-btn="' + index + '"]');
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = ' HD';
                    }
                }
            },

            // Download all thumbnails as ZIP (with optional HD)
            downloadAllAsZip: async function(mode, includeHd) {
                var items = mode === 'bulk' ? state.bulkUrls : state.playlistResults;
                var completed = items.filter(function(r) {
                    return r.status === 'complete' && (r.generatedThumbnail || r.thumbnailUrl);
                });

                if (completed.length === 0) {
                    state.error = { message: 'No completed thumbnails to download' };
                    render();
                    return;
                }

                try {
                    var zip = new JSZip();
                    var folderName = mode + '-thumbnails' + (includeHd ? '-hd' : '');
                    var folder = zip.folder(folderName);

                    for (var i = 0; i < completed.length; i++) {
                        var item = completed[i];
                        var url = includeHd && item.hdUrl ? item.hdUrl : (item.generatedThumbnail || item.thumbnailUrl);

                        var response = await fetch(url);
                        var blob = await response.blob();

                        var title = (item.title || 'thumbnail').replace(/[<>:"/\\|?*]/g, '').substring(0, 50);
                        var suffix = includeHd && item.hdUrl ? '_HD' : '';
                        var filename = (i + 1) + '_' + title + suffix + '.png';

                        folder.file(filename, blob);
                    }

                    var content = await zip.generateAsync({ type: 'blob' });
                    saveAs(content, folderName + '.zip');
                } catch (error) {
                    console.error('ZIP download error:', error);
                    state.error = { message: 'Failed to create ZIP: ' + error.message };
                    render();
                }
            },

            // Refresh token balance after upscale
            refreshTokenBalance: async function() {
                try {
                    var getBalance = firebase.functions().httpsCallable('getThumbnailTokenBalance');
                    var result = await getBalance();
                    if (result.data) {
                        state.thumbnailTokens = result.data.balance || 0;
                        render();
                    }
                } catch (e) {
                    console.error('Failed to refresh token balance:', e);
                }
            },

            /* ------------------------------------------
               4.5.8 Placement Finder Actions
               ------------------------------------------ */
            findPlacements: function(e) {
                e.preventDefault();
                var channelUrl = document.getElementById('placement-channel-url').value.trim();

                if (!channelUrl) {
                    state.error = { message: 'Please enter your YouTube channel URL' };
                    render();
                    return;
                }

                state.placementLoading = true;
                state.loading = true;
                state.error = null;
                state.loadingSteps = [
                    { name: 'Analyzing your channel', icon: '' },
                    { name: 'Understanding your content', icon: '' },
                    { name: 'Identifying your niche', icon: '' },
                    { name: 'Searching similar channels', icon: '' },
                    { name: 'Scoring relevance', icon: '' },
                    { name: 'Compiling results', icon: '' }
                ];
                startLoadingProgress();
                render();

                functions.httpsCallable('findPlacements')({ channelUrl: channelUrl })
                    .then(function(result) {
                        stopLoadingProgress();
                        state.placementResults = result.data;
                        state.placementLoading = false;
                        state.loading = false;
                        render();
                    })
                    .catch(function(e) {
                        stopLoadingProgress();
                        state.placementLoading = false;
                        state.loading = false;
                        // Check for token bypass option
                        if (e.code === 'functions/resource-exhausted' && e.details && e.details.tokenBypass && e.details.tokenBypass.available) {
                            app.showQuotaBypassModal(
                                e.details.toolType || 'placementFinder',
                                'Placement Finder',
                                e.details,
                                function() { app.findPlacements({ preventDefault: function(){} }); }
                            );
                            return;
                        }
                        state.error = { message: 'Failed to find placements: ' + e.message };
                        render();
                    });
            },

            findMorePlacements: function() {
                if (!state.placementResults || !state.placementResults.historyId) return;

                state.placementLoading = true;
                render();

                functions.httpsCallable('findMorePlacements')({ historyId: state.placementResults.historyId })
                    .then(function(result) {
                        state.placementResults.placements = result.data.placements;
                        state.placementResults.totalFound = result.data.totalFound;
                        state.placementLoading = false;
                        if (result.data.added === 0) {
                            state.error = { message: 'No more channels found matching your criteria.' };
                        }
                        render();
                    })
                    .catch(function(e) {
                        state.placementLoading = false;
                        state.error = { message: 'Failed to find more: ' + e.message };
                        render();
                    });
            },

            copyAllPlacements: function() {
                if (!state.placementResults || !state.placementResults.placements) return;

                var urls = state.placementResults.placements.map(function(p) {
                    return p.channelUrl;
                }).join('\n');

                navigator.clipboard.writeText(urls).then(function() {
                    state.copySuccess = 'Copied ' + state.placementResults.placements.length + ' channel URLs!';
                    render();
                    setTimeout(function() {
                        state.copySuccess = null;
                        render();
                    }, 3000);
                }).catch(function(err) {
                    state.error = { message: 'Failed to copy: ' + err.message };
                    render();
                });
            },

            copySinglePlacement: function(url) {
                navigator.clipboard.writeText(url).then(function() {
                    state.copySuccess = 'Channel URL copied!';
                    render();
                    setTimeout(function() {
                        state.copySuccess = null;
                        render();
                    }, 2000);
                }).catch(function(err) {
                    state.error = { message: 'Failed to copy: ' + err.message };
                    render();
                });
            },

            /* ------------------------------------------
               4.5.10 Campaign Reports Functions
               ------------------------------------------ */

            // Navigation
            goToAdminReports: function() {
                state.currentView = 'admin-reports';
                state.error = null;
                state.success = null;
                state.reportImages = [];
                state.reportAnalysis = null;
                state.sendModalReportId = null;
                this.loadAdminReports();
                render();
            },

            goToClientReports: function() {
                state.currentView = 'client-reports';
                state.error = null;
                state.success = null;
                this.loadClientReports();
                render();
            },

            goToReportEditor: function() {
                if (!state.reportAnalysis && !state.editingReport) {
                    state.error = 'No report to edit';
                    render();
                    return;
                }

                if (!state.editingReport) {
                    // Creating new report from analysis
                    state.editingReport = {
                        id: null,
                        campaignName: document.getElementById('campaign-name')?.value || 'Campaign Report',
                        images: state.reportImages,
                        aiAnalysis: state.reportAnalysis,
                        editedContent: {
                            title: document.getElementById('campaign-name')?.value || 'Campaign Performance Report',
                            summary: state.reportAnalysis.summary || '',
                            metrics: state.reportAnalysis.metrics || {},
                            youtubeMetrics: state.reportAnalysis.youtubeMetrics || {},
                            performance: state.reportAnalysis.performance || {},
                            recommendations: state.reportAnalysis.recommendations || [],
                            callToAction: state.reportAnalysis.fiverCTA || ''
                        }
                    };
                }

                state.currentView = 'report-editor';
                state.error = null;
                state.success = null;
                render();
            },

            // Image Upload Handling
            handleImageUpload: function(event) {
                var files = event.target.files;
                if (!files || files.length === 0) return;

                var maxImages = 6;
                var currentCount = state.reportImages.length;
                var remainingSlots = maxImages - currentCount;

                if (files.length > remainingSlots) {
                    state.error = 'Maximum ' + maxImages + ' images allowed. You can add ' + remainingSlots + ' more.';
                    render();
                    return;
                }

                for (var i = 0; i < files.length && i < remainingSlots; i++) {
                    var file = files[i];

                    // Validate file type
                    if (!file.type.match(/^image\/(png|jpe?g|webp)$/)) {
                        state.error = 'Only PNG, JPG, and WebP images are supported';
                        render();
                        return;
                    }

                    // Validate file size (10MB max)
                    if (file.size > 10 * 1024 * 1024) {
                        state.error = 'Each image must be under 10MB';
                        render();
                        return;
                    }

                    // Read file and create preview
                    (function(f) {
                        var reader = new FileReader();
                        reader.onload = function(e) {
                            state.reportImages.push({
                                file: f,
                                preview: e.target.result,
                                base64: e.target.result.split(',')[1],
                                mimeType: f.type,
                                name: f.name
                            });
                            render();
                        };
                        reader.readAsDataURL(f);
                    })(file);
                }

                // Clear input
                event.target.value = '';
            },

            removeReportImage: function(index) {
                state.reportImages.splice(index, 1);
                render();
            },

            clearReportImages: function() {
                state.reportImages = [];
                state.reportAnalysis = null;
                render();
            },

            // Drag and Drop Handler
            handleImageDrop: function(event) {
                event.preventDefault();
                event.stopPropagation();

                var uploadZone = document.getElementById('upload-zone');
                if (uploadZone) uploadZone.classList.remove('drag-over');

                var files = event.dataTransfer.files;
                if (!files || files.length === 0) return;

                var maxImages = 6;
                var currentCount = state.reportImages.length;
                var remainingSlots = maxImages - currentCount;

                if (files.length > remainingSlots) {
                    state.error = 'Maximum ' + maxImages + ' images allowed. You can add ' + remainingSlots + ' more.';
                    render();
                    return;
                }

                for (var i = 0; i < files.length && i < remainingSlots; i++) {
                    var file = files[i];

                    // Validate file type
                    if (!file.type.match(/^image\/(png|jpe?g|webp)$/)) {
                        state.error = 'Only PNG, JPG, and WebP images are supported';
                        render();
                        return;
                    }

                    // Validate file size (10MB max)
                    if (file.size > 10 * 1024 * 1024) {
                        state.error = 'Each image must be under 10MB';
                        render();
                        return;
                    }

                    // Read file and create preview
                    (function(f) {
                        var reader = new FileReader();
                        reader.onload = function(e) {
                            state.reportImages.push({
                                file: f,
                                preview: e.target.result,
                                base64: e.target.result.split(',')[1],
                                mimeType: f.type,
                                name: f.name
                            });
                            render();
                        };
                        reader.readAsDataURL(f);
                    })(file);
                }
            },

            handleDragOver: function(event) {
                event.preventDefault();
                event.stopPropagation();
                var uploadZone = document.getElementById('upload-zone');
                if (uploadZone) uploadZone.classList.add('drag-over');
            },

            handleDragLeave: function(event) {
                event.preventDefault();
                event.stopPropagation();
                var uploadZone = document.getElementById('upload-zone');
                if (uploadZone) uploadZone.classList.remove('drag-over');
            },

            // Lightbox Functions
            openLightbox: function(images, index) {
                state.lightboxImages = images;
                state.lightboxIndex = index || 0;
                state.lightboxOpen = true;
                document.body.style.overflow = 'hidden';
                render();
            },

            closeLightbox: function() {
                state.lightboxOpen = false;
                state.lightboxImages = [];
                state.lightboxIndex = 0;
                document.body.style.overflow = '';
                render();
            },

            prevLightboxImage: function() {
                if (state.lightboxIndex > 0) {
                    state.lightboxIndex--;
                    render();
                }
            },

            nextLightboxImage: function() {
                if (state.lightboxIndex < state.lightboxImages.length - 1) {
                    state.lightboxIndex++;
                    render();
                }
            },

            downloadImage: function(url, filename) {
                // Create a temporary link to download the image
                var link = document.createElement('a');
                link.href = url;
                link.download = filename || 'campaign-screenshot.png';
                link.target = '_blank';

                // For cross-origin images, open in new tab
                if (url.includes('firebasestorage.googleapis.com')) {
                    window.open(url, '_blank');
                } else {
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            },

            // PDF Download for Campaign Reports - Section-aware intelligent generation
            downloadReportPDF: async function() {
                var element = document.getElementById('pdf-report-content');
                if (!element) {
                    console.error('PDF content element not found');
                    showToast('Could not find report content to export.', 'error');
                    return;
                }

                // Check if libraries are loaded
                if (typeof html2canvas === 'undefined') {
                    console.error('html2canvas library not loaded');
                    showToast('PDF library not loaded. Please refresh the page.', 'error');
                    return;
                }

                // Check jsPDF - handle different global names
                var jsPDFClass = null;
                if (typeof jspdf !== 'undefined' && jspdf.jsPDF) {
                    jsPDFClass = jspdf.jsPDF;
                } else if (typeof jsPDF !== 'undefined') {
                    jsPDFClass = jsPDF;
                } else if (typeof window.jspdf !== 'undefined' && window.jspdf.jsPDF) {
                    jsPDFClass = window.jspdf.jsPDF;
                }

                if (!jsPDFClass) {
                    console.error('jsPDF library not loaded');
                    showToast('PDF library not loaded. Please refresh the page.', 'error');
                    return;
                }

                // Show loading state
                showToast('Generating PDF... This may take a moment.', 'info');

                var report = state.currentReport || {};
                var content = report.editedContent || {};
                var reportTitle = content.title || report.campaignName || 'Campaign Report';

                // Add PDF mode class for print-friendly styles
                element.classList.add('pdf-mode');

                // Wait for styles to apply
                await new Promise(function(resolve) { setTimeout(resolve, 100); });

                try {
                    var pdf = new jsPDFClass({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4',
                        compress: true
                    });

                    // Page dimensions
                    var pageWidth = pdf.internal.pageSize.getWidth();
                    var pageHeight = pdf.internal.pageSize.getHeight();
                    var margin = 10;
                    var contentWidth = pageWidth - (margin * 2);
                    var headerHeight = 32;
                    var footerHeight = 12;
                    var usableHeight = pageHeight - headerHeight - footerHeight;

                    // Helper function to add header
                    function addHeader(pageNum, totalPages) {
                        pdf.setFillColor(88, 28, 135); // Purple
                        pdf.rect(0, 0, pageWidth, headerHeight, 'F');

                        pdf.setFontSize(14);
                        pdf.setTextColor(255, 255, 255);
                        pdf.text(reportTitle, margin, 12);

                        pdf.setFontSize(8);
                        pdf.setTextColor(220, 220, 220);
                        pdf.text('Generated on ' + new Date().toLocaleDateString(), margin, 19);
                        pdf.text('YouTubeHub - Campaign Report', margin, 25);

                        pdf.setFontSize(9);
                        pdf.text('Page ' + pageNum + ' of ' + totalPages, pageWidth - margin - 22, 19);
                    }

                    // Helper function to add footer
                    function addFooter() {
                        pdf.setFontSize(7);
                        pdf.setTextColor(107, 114, 128);
                        pdf.text('Powered by YouTubeHub', margin, pageHeight - 6);
                    }

                    // Identify section boundaries for intelligent page breaks
                    var sectionSelectors = [
                        '.youtube-hero',
                        '.bg-gradient-to-r.from-purple-50',  // Executive Summary
                        '.bg-gradient-to-r.from-blue-50',    // Detailed Analysis
                        '.strategic-section',
                        '.bg-gradient-to-r.from-green-500'   // CTA
                    ];

                    var sectionBoundaries = [];
                    var elementRect = element.getBoundingClientRect();
                    var elementTop = elementRect.top;

                    sectionSelectors.forEach(function(selector) {
                        var els = element.querySelectorAll(selector);
                        els.forEach(function(el) {
                            var rect = el.getBoundingClientRect();
                            sectionBoundaries.push({
                                top: rect.top - elementTop,
                                bottom: rect.bottom - elementTop
                            });
                        });
                    });

                    // Sort boundaries by position
                    sectionBoundaries.sort(function(a, b) { return a.top - b.top; });

                    // Capture the entire element as one image (preserves all styling)
                    var canvas = await html2canvas(element, {
                        backgroundColor: null, // Preserve original backgrounds
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        allowTaint: true,
                        imageTimeout: 30000
                    });

                    // Calculate dimensions
                    var imgWidth = contentWidth;
                    var imgHeight = (canvas.height * imgWidth) / canvas.width;
                    var scaleFactor = imgWidth / canvas.width;

                    // Calculate page breaks at section boundaries
                    var pageBreakPositions = [0]; // Start of first page
                    var currentPageEnd = usableHeight;

                    // Convert section boundaries to PDF coordinates
                    var pdfSectionBoundaries = sectionBoundaries.map(function(b) {
                        return {
                            top: b.top * scaleFactor * 2, // Account for scale
                            bottom: b.bottom * scaleFactor * 2
                        };
                    });

                    // Find optimal page break points
                    while (currentPageEnd < imgHeight) {
                        // Find the best section boundary to break at
                        var bestBreakPoint = currentPageEnd;

                        for (var i = 0; i < pdfSectionBoundaries.length; i++) {
                            var boundary = pdfSectionBoundaries[i];
                            // If section top is before page end and provides a good break point
                            if (boundary.top > pageBreakPositions[pageBreakPositions.length - 1] + 20 &&
                                boundary.top <= currentPageEnd &&
                                boundary.top > bestBreakPoint - usableHeight * 0.3) {
                                bestBreakPoint = boundary.top;
                            }
                        }

                        // If no good boundary found, use the calculated end
                        if (bestBreakPoint === currentPageEnd) {
                            // Try to avoid breaking in the middle of content
                            bestBreakPoint = Math.max(pageBreakPositions[pageBreakPositions.length - 1] + usableHeight * 0.5, currentPageEnd - 20);
                        }

                        pageBreakPositions.push(bestBreakPoint);
                        currentPageEnd = bestBreakPoint + usableHeight;
                    }

                    var totalPages = pageBreakPositions.length;

                    // Render each page
                    for (var page = 0; page < totalPages; page++) {
                        if (page > 0) {
                            pdf.addPage();
                        }

                        // Add header
                        addHeader(page + 1, totalPages);

                        // Calculate source region for this page
                        var sourceY = pageBreakPositions[page] / (scaleFactor * 2) * 2; // Convert back to canvas coords
                        var nextBreak = page < totalPages - 1 ? pageBreakPositions[page + 1] : imgHeight;
                        var sourceHeight = (nextBreak - pageBreakPositions[page]) / (scaleFactor * 2) * 2;

                        // Clamp values
                        sourceY = Math.max(0, Math.min(sourceY, canvas.height));
                        sourceHeight = Math.min(sourceHeight, canvas.height - sourceY);

                        if (sourceHeight > 0) {
                            // Create temporary canvas for this page portion
                            var pageCanvas = document.createElement('canvas');
                            pageCanvas.width = canvas.width;
                            pageCanvas.height = sourceHeight;

                            var ctx = pageCanvas.getContext('2d');
                            ctx.drawImage(
                                canvas,
                                0, sourceY,
                                canvas.width, sourceHeight,
                                0, 0,
                                canvas.width, sourceHeight
                            );

                            var pageImgData = pageCanvas.toDataURL('image/jpeg', 0.92);
                            var pageImgHeight = (sourceHeight * imgWidth) / canvas.width;

                            pdf.addImage(pageImgData, 'JPEG', margin, headerHeight + 2, imgWidth, pageImgHeight);
                        }

                        // Add footer
                        addFooter();
                    }

                    // Remove PDF mode class
                    element.classList.remove('pdf-mode');

                    // Download the PDF
                    var filename = 'campaign-report-' + new Date().toISOString().slice(0, 10) + '.pdf';
                    pdf.save(filename);

                    showToast('PDF downloaded successfully!', 'success');

                } catch (pdfError) {
                    console.error('PDF creation error:', pdfError);
                    element.classList.remove('pdf-mode');
                    showToast('Failed to create PDF: ' + pdfError.message, 'error');
                }
            },

            // AI Analysis
            analyzeReportImages: async function() {
                if (state.reportImages.length === 0) {
                    state.error = 'Please upload at least one image';
                    render();
                    return;
                }

                state.reportLoading = true;
                state.error = null;
                render();

                try {
                    var campaignName = document.getElementById('campaign-name')?.value || '';
                    var additionalContext = document.getElementById('additional-context')?.value || '';

                    var analyzeReportImages = firebase.functions().httpsCallable('analyzeReportImages');
                    var result = await analyzeReportImages({
                        images: state.reportImages.map(function(img) {
                            return {
                                base64: img.base64,
                                mimeType: img.mimeType
                            };
                        }),
                        campaignName: campaignName,
                        additionalContext: additionalContext
                    });

                    if (result.data.success) {
                        state.reportAnalysis = result.data.analysis;
                        state.success = 'AI analysis completed successfully!';
                    } else {
                        state.error = 'Analysis failed. Please try again.';
                    }
                } catch (err) {
                    console.error('Analysis error:', err);
                    state.error = err.message || 'Failed to analyze images';
                } finally {
                    state.reportLoading = false;
                    render();
                }
            },

            // Save Report
            saveReportAsDraft: async function() {
                if (!state.reportAnalysis || state.reportImages.length === 0) {
                    state.error = 'No analysis to save';
                    render();
                    return;
                }

                state.reportLoading = true;
                state.error = null;
                render();

                try {
                    // First upload images to storage
                    var uploadReportImages = firebase.functions().httpsCallable('uploadReportImages');
                    var uploadResult = await uploadReportImages({
                        images: state.reportImages.map(function(img) {
                            return {
                                base64: img.base64,
                                mimeType: img.mimeType
                            };
                        })
                    });

                    if (!uploadResult.data.success) {
                        throw new Error('Failed to upload images');
                    }

                    // Then create the report
                    var createCampaignReport = firebase.functions().httpsCallable('createCampaignReport');
                    var campaignName = document.getElementById('campaign-name')?.value || 'Campaign Report';

                    var result = await createCampaignReport({
                        reportId: uploadResult.data.reportId,
                        images: uploadResult.data.images,
                        aiAnalysis: state.reportAnalysis,
                        campaignName: campaignName,
                        status: 'draft'
                    });

                    if (result.data.success) {
                        state.success = 'Report saved as draft!';
                        state.reportImages = [];
                        state.reportAnalysis = null;
                        this.loadAdminReports();
                    }
                } catch (err) {
                    console.error('Save report error:', err);
                    state.error = err.message || 'Failed to save report';
                } finally {
                    state.reportLoading = false;
                    render();
                }
            },

            saveReportChanges: async function() {
                if (!state.editingReport) {
                    state.error = 'No report to save';
                    render();
                    return;
                }

                state.reportLoading = true;
                state.error = null;
                render();

                try {
                    var title = document.getElementById('edit-title')?.value || '';
                    var summary = document.getElementById('edit-summary')?.value || '';
                    var cta = document.getElementById('edit-cta')?.value || '';

                    // Get recommendations from inputs
                    var recInputs = document.querySelectorAll('.rec-input');
                    var recommendations = [];
                    recInputs.forEach(function(input) {
                        if (input.value.trim()) {
                            recommendations.push({ title: input.value.trim() });
                        }
                    });

                    var editedContent = {
                        title: title,
                        summary: summary,
                        metrics: state.editingReport.editedContent?.metrics || state.editingReport.aiAnalysis?.metrics || {},
                        youtubeMetrics: state.editingReport.editedContent?.youtubeMetrics || state.editingReport.aiAnalysis?.youtubeMetrics || {},
                        performance: state.editingReport.editedContent?.performance || state.editingReport.aiAnalysis?.performance || {},
                        recommendations: recommendations,
                        callToAction: cta
                    };

                    if (state.editingReport.id) {
                        // Update existing report
                        var updateCampaignReport = firebase.functions().httpsCallable('updateCampaignReport');
                        var result = await updateCampaignReport({
                            reportId: state.editingReport.id,
                            editedContent: editedContent,
                            campaignName: title,
                            status: 'ready'
                        });

                        if (result.data.success) {
                            state.success = 'Report updated successfully!';
                            state.editingReport.editedContent = editedContent;
                        }
                    } else {
                        // Create new report
                        var uploadReportImages = firebase.functions().httpsCallable('uploadReportImages');
                        var uploadResult = await uploadReportImages({
                            images: state.editingReport.images.map(function(img) {
                                return {
                                    base64: img.base64,
                                    mimeType: img.mimeType
                                };
                            })
                        });

                        if (!uploadResult.data.success) {
                            throw new Error('Failed to upload images');
                        }

                        var createCampaignReport = firebase.functions().httpsCallable('createCampaignReport');
                        var result = await createCampaignReport({
                            reportId: uploadResult.data.reportId,
                            images: uploadResult.data.images,
                            aiAnalysis: state.editingReport.aiAnalysis,
                            editedContent: editedContent,
                            campaignName: title,
                            status: 'ready'
                        });

                        if (result.data.success) {
                            state.success = 'Report created successfully!';
                            state.editingReport.id = result.data.reportId;
                            state.editingReport.images = uploadResult.data.images;
                        }
                    }
                } catch (err) {
                    console.error('Save changes error:', err);
                    state.error = err.message || 'Failed to save changes';
                } finally {
                    state.reportLoading = false;
                    render();
                }
            },

            // Edit/Delete Reports
            editReport: async function(reportId) {
                state.reportLoading = true;
                render();

                try {
                    var getCampaignReport = firebase.functions().httpsCallable('getCampaignReport');
                    var result = await getCampaignReport({ reportId: reportId });

                    if (result.data.success) {
                        state.editingReport = result.data.report;
                        state.currentView = 'report-editor';
                    }
                } catch (err) {
                    console.error('Load report error:', err);
                    state.error = err.message || 'Failed to load report';
                } finally {
                    state.reportLoading = false;
                    render();
                }
            },

            deleteReport: async function(reportId) {
                if (!confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
                    return;
                }

                state.reportLoading = true;
                render();

                try {
                    var deleteCampaignReport = firebase.functions().httpsCallable('deleteCampaignReport');
                    var result = await deleteCampaignReport({ reportId: reportId });

                    if (result.data.success) {
                        state.success = 'Report deleted successfully';
                        this.loadAdminReports();
                    }
                } catch (err) {
                    console.error('Delete report error:', err);
                    state.error = err.message || 'Failed to delete report';
                } finally {
                    state.reportLoading = false;
                    render();
                }
            },

            // Send to Client
            openSendModal: function(reportId) {
                state.sendModalReportId = reportId;
                render();
            },

            closeSendModal: function() {
                state.sendModalReportId = null;
                render();
            },

            sendReportToClient: async function() {
                var clientId = document.getElementById('send-client-select')?.value;
                if (!clientId) {
                    state.error = 'Please select a client';
                    render();
                    return;
                }

                state.reportLoading = true;
                render();

                try {
                    var sendReportToClient = firebase.functions().httpsCallable('sendReportToClient');
                    var result = await sendReportToClient({
                        reportId: state.sendModalReportId,
                        clientId: clientId
                    });

                    if (result.data.success) {
                        state.success = result.data.message;
                        state.sendModalReportId = null;
                        this.loadAdminReports();
                    }
                } catch (err) {
                    console.error('Send report error:', err);
                    state.error = err.message || 'Failed to send report';
                } finally {
                    state.reportLoading = false;
                    render();
                }
            },

            // Load Reports
            loadAdminReports: async function() {
                try {
                    // Load reports and users in parallel
                    var getAdminReports = firebase.functions().httpsCallable('getAdminReports');
                    var adminGetUsers = firebase.functions().httpsCallable('adminGetUsers');

                    var [reportsResult, usersResult] = await Promise.all([
                        getAdminReports({}),
                        adminGetUsers({})
                    ]);

                    if (reportsResult.data.success) {
                        state.campaignReports = reportsResult.data.reports;
                    }

                    // Load users for the "Send to Client" dropdown
                    if (usersResult.data && usersResult.data.users) {
                        state.adminUsers = usersResult.data.users;
                    }
                } catch (err) {
                    console.error('Load admin reports error:', err);
                    state.campaignReports = [];
                }
                render();
            },

            loadClientReports: async function() {
                try {
                    var getClientReports = firebase.functions().httpsCallable('getClientReports');
                    var result = await getClientReports({});

                    if (result.data.success) {
                        state.clientReports = result.data.reports;
                    }
                } catch (err) {
                    console.error('Load client reports error:', err);
                    state.clientReports = [];
                }
                render();
            },

            // View Report (Client)
            viewReport: async function(reportId) {
                state.currentReport = { id: null };
                state.currentView = 'view-report';
                render();

                try {
                    var getCampaignReport = firebase.functions().httpsCallable('getCampaignReport');
                    var result = await getCampaignReport({ reportId: reportId });

                    if (result.data.success) {
                        state.currentReport = result.data.report;

                        // Mark as viewed
                        var markReportViewed = firebase.functions().httpsCallable('markReportViewed');
                        await markReportViewed({ reportId: reportId });

                        // Update local state
                        if (state.clientReports) {
                            state.clientReports = state.clientReports.map(function(r) {
                                if (r.id === reportId) {
                                    r.status = 'viewed';
                                }
                                return r;
                            });
                        }

                        // Refresh notifications
                        this.loadNotifications();
                    }
                } catch (err) {
                    console.error('View report error:', err);
                    state.error = err.message || 'Failed to load report';
                }
                render();
            },

            // Recommendations editing
            addRecommendation: function() {
                if (!state.editingReport) return;
                if (!state.editingReport.editedContent) {
                    state.editingReport.editedContent = { recommendations: [] };
                }
                if (!state.editingReport.editedContent.recommendations) {
                    state.editingReport.editedContent.recommendations = [];
                }
                state.editingReport.editedContent.recommendations.push({ title: '' });
                render();
            },

            removeRecommendation: function(index) {
                if (!state.editingReport?.editedContent?.recommendations) return;
                state.editingReport.editedContent.recommendations.splice(index, 1);
                render();
            },

            // Unified Notifications System
            loadNotifications: async function() {
                try {
                    var getUnreadNotifications = firebase.functions().httpsCallable('getUnreadNotifications');
                    var result = await getUnreadNotifications({});

                    if (result.data.success) {
                        state.notifications = result.data.notifications;
                        state.unreadCount = result.data.unreadCount;
                    }
                } catch (err) {
                    console.error('Load notifications error:', err);
                }
                render();
            },

            loadUserNotifications: function() {
                state.userNotificationsLoading = true;
                // Don't render here - debounced system will batch with other state changes
                // Render only when data arrives

                functions.httpsCallable('userGetNotifications')({ limit: 20 })
                    .then(function(result) {
                        state.userNotifications = {
                            notifications: result.data.notifications || [],
                            unreadCount: result.data.unreadCount || 0
                        };
                        state.userNotificationsLoading = false;
                        render();
                    })
                    .catch(function(error) {
                        console.error('Error loading user notifications:', error);
                        state.userNotificationsLoading = false;
                        render();
                    });
            },

            toggleNotifications: function() {
                state.showNotifications = !state.showNotifications;
                // Load user notifications when opening if not already loaded
                if (state.showNotifications && !state.userNotifications) {
                    this.loadUserNotifications();
                }
                render();
            },

            closeNotifications: function() {
                if (state.showNotifications) {
                    state.showNotifications = false;
                    render();
                }
            },

            setNotificationTab: function(tab) {
                state.notificationTab = tab;
                // Load user notifications when switching to alerts tab if not loaded
                if (tab === 'alerts' && !state.userNotifications && !state.userNotificationsLoading) {
                    this.loadUserNotifications();
                }
                render();
            },

            // Mark all report notifications as read
            markAllReportNotificationsRead: async function() {
                try {
                    var markNotificationRead = firebase.functions().httpsCallable('markNotificationRead');
                    await markNotificationRead({ markAll: true });
                    state.notifications = [];
                    state.unreadCount = 0;
                } catch (err) {
                    console.error('Mark report notifications error:', err);
                }
                render();
            },

            // Mark all alert/user notifications as read
            markAllAlertNotificationsRead: function() {
                functions.httpsCallable('userMarkNotificationRead')({ markAllRead: true })
                    .then(function() {
                        if (state.userNotifications) {
                            state.userNotifications.notifications.forEach(function(n) { n.read = true; });
                            state.userNotifications.unreadCount = 0;
                        }
                        render();
                    })
                    .catch(function(error) {
                        console.error('Error marking all alerts read:', error);
                    });
            },

            // Legacy function for backwards compatibility
            markAllNotificationsRead: async function() {
                await this.markAllReportNotificationsRead();
            },

            // Handle clicking on an alert notification
            handleAlertNotificationClick: function(notificationId) {
                // Mark as read
                functions.httpsCallable('userMarkNotificationRead')({ notificationId: notificationId })
                    .then(function() {
                        if (state.userNotifications) {
                            var notif = state.userNotifications.notifications.find(function(n) { return n.id === notificationId; });
                            if (notif && !notif.read) {
                                notif.read = true;
                                state.userNotifications.unreadCount = Math.max(0, state.userNotifications.unreadCount - 1);
                            }
                        }
                        render();
                    })
                    .catch(function(error) {
                        console.error('Error marking alert read:', error);
                    });
            },

            openNotificationReport: async function(reportId, notificationId) {
                // Mark notification as read
                try {
                    var markNotificationRead = firebase.functions().httpsCallable('markNotificationRead');
                    await markNotificationRead({ notificationId: notificationId });
                    // Update local state
                    state.notifications = state.notifications.filter(function(n) { return n.id !== notificationId; });
                    state.unreadCount = Math.max(0, state.unreadCount - 1);
                } catch (err) {
                    console.error('Mark notification error:', err);
                }

                state.showNotifications = false;
                this.viewReport(reportId);
            }
        };

        /* ==========================================
           4.6 RENDER FUNCTIONS (Views)
           ========================================== */

        /* ------------------------------------------
           4.6.0 Initializing View (Loading Screen)
           ------------------------------------------ */
        function renderInitializing() {
            var html = '';
            html += '<div class="min-h-screen flex items-center justify-center">';
            html += '<div class="text-center fade-in">';
            html += '<div class="text-7xl mb-6"></div>';
            html += '<div class="spinner mx-auto mb-4"></div>';
            html += '<p class="text-white/80 text-lg">Loading...</p>';
            html += '</div>';
            html += '</div>';
            return html;
        }

        /* ------------------------------------------
           4.6.1 Login View
           ------------------------------------------ */
        function renderLogin() {
            var html = '';

            // Container
            html += '<div class="min-h-screen mobile-full-screen flex items-center justify-center px-4 py-8">';
            html += '<div class="max-w-md w-full mobile-card">';

            // Header
            html += '<div class="text-center mb-8 fade-in">';
            html += '<div class="text-6xl mb-4"></div>';
            html += '<h1 class="text-4xl mobile-text-xl font-bold text-white mb-2">YouTubeHub</h1>';
            html += '<p class="text-white/80 text-lg mobile-text-lg">AI-powered video optimization</p>';
            html += '</div>';

            // Card
            html += '<div class="bg-white rounded-2xl shadow-2xl p-8 mobile-padding fade-in">';
            html += '<h2 class="text-2xl mobile-text-xl font-bold text-gray-800 mb-6">Sign In</h2>';

            // Error message
            if (state.error) {
                html += '<div class="alert-error">' + utils.escapeHtml(state.error) + '</div>';
            }

            // Google Sign-In Button
            html += '<button onclick="app.signInWithGoogle()" class="google-btn w-full flex items-center justify-center gap-3 bg-white border-2 border-gray-300 rounded-xl py-4 px-6 text-gray-700 font-semibold hover:border-gray-400 mb-6"';
            if (state.loading) html += ' disabled';
            html += '>';
            html += '<svg width="20" height="20" viewBox="0 0 20 20"><path fill="#4285F4" d="M19.6 10.23c0-.82-.1-1.42-.25-2.05H10v3.72h5.5c-.15.96-.74 2.31-2.04 3.22v2.45h3.16c1.89-1.73 2.98-4.3 2.98-7.34z"/><path fill="#34A853" d="M13.46 15.13c-.83.59-1.96 1-3.46 1-2.64 0-4.88-1.74-5.68-4.15H1.07v2.52C2.72 17.75 6.09 20 10 20c2.7 0 4.96-.89 6.62-2.42l-3.16-2.45z"/><path fill="#FBBC05" d="M3.99 10c0-.69.12-1.35.32-1.97V5.51H1.07A9.973 9.973 0 000 10c0 1.61.39 3.14 1.07 4.49l3.24-2.52c-.2-.62-.32-1.28-.32-1.97z"/><path fill="#EA4335" d="M10 3.88c1.88 0 3.13.81 3.85 1.48l2.84-2.76C14.96.99 12.7 0 10 0 6.09 0 2.72 2.25 1.07 5.51l3.24 2.52C5.12 5.62 7.36 3.88 10 3.88z"/></svg>';
            html += state.loading ? 'Signing in...' : 'Sign in with Google';
            html += '</button>';

            // Divider
            html += '<div class="relative my-6">';
            html += '<div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>';
            html += '<div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">Or sign in with email</span></div>';
            html += '</div>';

            // Email/Password Form
            html += '<form onsubmit="app.signIn(event)">';
            html += '<div class="mb-4">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Email</label>';
            html += '<input type="email" id="login-email" required class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="your@email.com" />';
            html += '</div>';

            html += '<div class="mb-6">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Password</label>';
            html += '<input type="password" id="login-password" required class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="" />';
            html += '</div>';

            html += '<button type="submit" class="btn-primary"';
            if (state.loading) html += ' disabled';
            html += '>';
            html += state.loading ? ' Signing in...' : ' Sign In';
            html += '</button>';
            html += '</form>';

            // Forgot password link
            html += '<div class="mt-6 text-center">';
            html += '<button onclick="app.goToForgotPassword()" class="text-blue-600 hover:text-blue-700 font-semibold">Forgot Password?</button>';
            html += '</div>';

            // Register link
            html += '<div class="mt-4 pt-4 border-t border-gray-200 text-center">';
            html += '<p class="text-gray-600">Don\'t have an account?</p>';
            html += '<button onclick="app.goToRegister()" class="mt-2 text-purple-600 hover:text-purple-700 font-bold">Create Account </button>';
            html += '</div>';

            html += '</div></div></div>';

            return html;
        }

        /* ------------------------------------------
           4.6.2 Register View
           ------------------------------------------ */
        function renderRegister() {
            var html = '';

            // Container
            html += '<div class="min-h-screen flex items-center justify-center px-4 py-8">';
            html += '<div class="max-w-md w-full">';

            // Header
            html += '<div class="text-center mb-8 fade-in">';
            html += '<div class="text-6xl mb-4"></div>';
            html += '<h1 class="text-4xl font-bold text-white mb-2">Create Account</h1>';
            html += '<p class="text-white/80 text-lg">Start optimizing your videos</p>';
            html += '</div>';

            // Card
            html += '<div class="bg-white rounded-2xl shadow-2xl p-8 fade-in">';
            html += '<h2 class="text-2xl font-bold text-gray-800 mb-6">Register</h2>';

            // Error message
            if (state.error) {
                html += '<div class="alert-error">' + utils.escapeHtml(state.error) + '</div>';
            }

            // Google Sign-Up Button
            html += '<button onclick="app.signInWithGoogle()" class="google-btn w-full flex items-center justify-center gap-3 bg-white border-2 border-gray-300 rounded-xl py-4 px-6 text-gray-700 font-semibold hover:border-gray-400 mb-6"';
            if (state.loading) html += ' disabled';
            html += '>';
            html += '<svg width="20" height="20" viewBox="0 0 20 20"><path fill="#4285F4" d="M19.6 10.23c0-.82-.1-1.42-.25-2.05H10v3.72h5.5c-.15.96-.74 2.31-2.04 3.22v2.45h3.16c1.89-1.73 2.98-4.3 2.98-7.34z"/><path fill="#34A853" d="M13.46 15.13c-.83.59-1.96 1-3.46 1-2.64 0-4.88-1.74-5.68-4.15H1.07v2.52C2.72 17.75 6.09 20 10 20c2.7 0 4.96-.89 6.62-2.42l-3.16-2.45z"/><path fill="#FBBC05" d="M3.99 10c0-.69.12-1.35.32-1.97V5.51H1.07A9.973 9.973 0 000 10c0 1.61.39 3.14 1.07 4.49l3.24-2.52c-.2-.62-.32-1.28-.32-1.97z"/><path fill="#EA4335" d="M10 3.88c1.88 0 3.13.81 3.85 1.48l2.84-2.76C14.96.99 12.7 0 10 0 6.09 0 2.72 2.25 1.07 5.51l3.24 2.52C5.12 5.62 7.36 3.88 10 3.88z"/></svg>';
            html += state.loading ? 'Creating account...' : 'Sign up with Google';
            html += '</button>';

            // Divider
            html += '<div class="relative my-6">';
            html += '<div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>';
            html += '<div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">Or register with email</span></div>';
            html += '</div>';

            // Email/Password Form
            html += '<form onsubmit="app.register(event)">';
            html += '<div class="mb-4">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Email</label>';
            html += '<input type="email" id="register-email" required class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="your@email.com" />';
            html += '</div>';

            html += '<div class="mb-4">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Password (min 6 characters)</label>';
            html += '<input type="password" id="register-password" required minlength="6" class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="" />';
            html += '</div>';

            html += '<div class="mb-6">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Confirm Password</label>';
            html += '<input type="password" id="register-confirm-password" required minlength="6" class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="" />';
            html += '</div>';

            html += '<button type="submit" class="btn-primary"';
            if (state.loading) html += ' disabled';
            html += '>';
            html += state.loading ? ' Creating account...' : ' Create Account';
            html += '</button>';
            html += '</form>';

            // Login link
            html += '<div class="mt-6 pt-4 border-t border-gray-200 text-center">';
            html += '<p class="text-gray-600">Already have an account?</p>';
            html += '<button onclick="app.goToLogin()" class="mt-2 text-purple-600 hover:text-purple-700 font-bold">Sign In </button>';
            html += '</div>';

            html += '</div></div></div>';

            return html;
        }

        /* ------------------------------------------
           4.6.3 Forgot Password View
           ------------------------------------------ */
        function renderForgotPassword() {
            var html = '';

            // Container
            html += '<div class="min-h-screen flex items-center justify-center px-4 py-8">';
            html += '<div class="max-w-md w-full">';

            // Header
            html += '<div class="text-center mb-8 fade-in">';
            html += '<div class="text-6xl mb-4"></div>';
            html += '<h1 class="text-4xl font-bold text-white mb-2">Reset Password</h1>';
            html += '<p class="text-white/80 text-lg">We\'ll send you a reset link</p>';
            html += '</div>';

            // Card
            html += '<div class="bg-white rounded-2xl shadow-2xl p-8 fade-in">';
            html += '<h2 class="text-2xl font-bold text-gray-800 mb-6">Forgot Password?</h2>';

            // Messages
            if (state.error) {
                html += '<div class="alert-error">' + utils.escapeHtml(state.error) + '</div>';
            }
            if (state.success) {
                html += '<div class="alert-success">' + utils.escapeHtml(state.success) + '</div>';
            }

            // Form
            html += '<form onsubmit="app.resetPassword(event)">';
            html += '<div class="mb-6">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Email Address</label>';
            html += '<input type="email" id="reset-email" required class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="your@email.com" />';
            html += '<p class="text-sm text-gray-500 mt-2">Enter your email and we\'ll send you a password reset link</p>';
            html += '</div>';

            html += '<button type="submit" class="btn-primary"';
            if (state.loading) html += ' disabled';
            html += '>';
            html += state.loading ? ' Sending...' : ' Send Reset Link';
            html += '</button>';
            html += '</form>';

            // Back link
            html += '<div class="mt-6 pt-4 border-t border-gray-200 text-center">';
            html += '<button onclick="app.goToLogin()" class="text-purple-600 hover:text-purple-700 font-bold"> Back to Sign In</button>';
            html += '</div>';

            html += '</div></div></div>';

            return html;
        }

        /* ------------------------------------------
           4.6.3b User Notification Panel (DEPRECATED)
           Now handled by the unified notification system in renderGlobalHeader()
           ------------------------------------------ */
        // Legacy function - kept for backwards compatibility
        function renderUserNotificationPanel() {
            // This function is now deprecated. User notifications are handled
            // in the unified notification dropdown via renderAlertNotifications()
            return '';
        }

        /* ------------------------------------------
           4.6.3c Renewal Request Modal
           ------------------------------------------ */
        function renderRenewalModal() {
            if (!state.showRenewalModal) return '';

            var form = state.renewalForm;
            var requests = state.renewalRequests || [];
            var hasPendingRequest = requests.some(function(r) { return r.status === 'pending'; });

            var html = '<div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4" onclick="app.closeRenewalModal()">';
            html += '<div class="bg-gray-900 rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto shadow-2xl" onclick="event.stopPropagation()">';

            // Header
            html += '<div class="px-6 py-4 border-b border-gray-700">';
            html += '<h2 class="text-xl font-bold text-white"> Request Subscription Renewal</h2>';
            html += '<p class="text-gray-400 text-sm mt-1">Submit a request and we\'ll review it shortly</p>';
            html += '</div>';

            // Body
            html += '<div class="p-6">';

            if (hasPendingRequest) {
                html += '<div class="bg-amber-500/10 border border-amber-500/30 rounded-xl p-4 mb-6">';
                html += '<div class="flex items-center gap-2 text-amber-400 font-medium"><span></span> You have a pending request</div>';
                html += '<p class="text-gray-400 text-sm mt-1">Please wait for your current request to be reviewed.</p>';
                html += '</div>';
            } else {
                // Form
                html += '<div class="space-y-4">';

                // Plan selection
                html += '<div>';
                html += '<label class="block text-gray-300 text-sm font-medium mb-2">Preferred Plan</label>';
                html += '<div class="grid grid-cols-3 gap-2">';

                ['lite', 'pro', 'enterprise'].forEach(function(planOption) {
                    var isSelected = form.preferredPlan === planOption;
                    var bgClass = isSelected ? 'bg-gradient-to-r from-purple-500 to-indigo-500 border-transparent' : 'bg-gray-800 border-gray-700 hover:border-gray-600';
                    html += '<button onclick="app.updateRenewalForm(\'preferredPlan\', \'' + planOption + '\')" class="' + bgClass + ' border rounded-xl py-3 px-4 text-center transition-all">';
                    html += '<div class="font-semibold text-white">' + planOption.charAt(0).toUpperCase() + planOption.slice(1) + '</div>';
                    html += '</button>';
                });

                html += '</div>';
                html += '</div>';

                // Duration selection
                html += '<div>';
                html += '<label class="block text-gray-300 text-sm font-medium mb-2">Preferred Duration</label>';
                html += '<select onchange="app.updateRenewalForm(\'preferredDuration\', this.value)" class="w-full bg-gray-800 border border-gray-700 rounded-xl py-3 px-4 text-white">';
                ['week', 'month', '3months', 'year'].forEach(function(dur) {
                    var labels = { week: '1 Week', month: '1 Month', '3months': '3 Months', year: '1 Year' };
                    var selected = form.preferredDuration === dur ? ' selected' : '';
                    html += '<option value="' + dur + '"' + selected + '>' + labels[dur] + '</option>';
                });
                html += '</select>';
                html += '</div>';

                // Message
                html += '<div>';
                html += '<label class="block text-gray-300 text-sm font-medium mb-2">Message (optional)</label>';
                html += '<textarea onchange="app.updateRenewalForm(\'message\', this.value)" class="w-full bg-gray-800 border border-gray-700 rounded-xl py-3 px-4 text-white h-24 resize-none" placeholder="Any additional notes for the admin...">' + utils.escapeHtml(form.message || '') + '</textarea>';
                html += '</div>';

                html += '</div>';
            }

            // Previous requests
            if (requests.length > 0) {
                html += '<div class="mt-6 pt-6 border-t border-gray-700">';
                html += '<h3 class="text-gray-300 font-medium mb-3">Previous Requests</h3>';
                html += '<div class="space-y-2 max-h-40 overflow-y-auto">';

                requests.slice(0, 5).forEach(function(req) {
                    var statusColor = req.status === 'approved' ? 'text-green-400' : req.status === 'denied' ? 'text-red-400' : req.status === 'pending' ? 'text-amber-400' : 'text-gray-400';
                    var statusIcon = req.status === 'approved' ? '' : req.status === 'denied' ? '' : req.status === 'pending' ? '' : '';
                    var date = req.createdAt ? new Date(req.createdAt).toLocaleDateString() : '';

                    html += '<div class="bg-gray-800/50 rounded-lg px-3 py-2 flex items-center justify-between">';
                    html += '<div>';
                    html += '<span class="text-white text-sm">' + (req.preferredPlan || '').toUpperCase() + '</span>';
                    html += '<span class="text-gray-500 text-xs ml-2">' + date + '</span>';
                    html += '</div>';
                    html += '<div class="flex items-center gap-2">';
                    html += '<span class="' + statusColor + ' text-sm">' + statusIcon + ' ' + (req.status || '').charAt(0).toUpperCase() + (req.status || '').slice(1) + '</span>';
                    if (req.status === 'pending') {
                        html += '<button onclick="app.cancelRenewalRequest(\'' + req.id + '\')" class="text-red-400 hover:text-red-300 text-xs">Cancel</button>';
                    }
                    html += '</div>';
                    html += '</div>';
                });

                html += '</div>';
                html += '</div>';
            }

            html += '</div>';

            // Footer
            html += '<div class="px-6 py-4 border-t border-gray-700 flex justify-end gap-3">';
            html += '<button onclick="app.closeRenewalModal()" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-xl transition-all">Cancel</button>';
            if (!hasPendingRequest) {
                var submitDisabled = state.renewalSubmitting ? ' disabled' : '';
                var submitText = state.renewalSubmitting ? '<span class="spinner w-4 h-4 mr-2"></span>Submitting...' : 'Submit Request';
                html += '<button onclick="app.submitRenewalRequest()"' + submitDisabled + ' class="px-4 py-2 bg-gradient-to-r from-purple-500 to-indigo-500 hover:from-purple-600 hover:to-indigo-600 text-white rounded-xl transition-all font-semibold">' + submitText + '</button>';
            }
            html += '</div>';

            html += '</div>';
            html += '</div>';
            return html;
        }

        /* ------------------------------------------
           4.6.4 Dashboard View
           ------------------------------------------ */
        function renderDashboard() {
            if (!state.profile) {
                return '<div class="text-white text-center py-12"><div class="spinner mx-auto mb-4"></div>Loading profile...</div>';
            }

            const p = state.profile;
            const plan = (p.subscription && p.subscription.plan) || 'free';
            const planName = plan.charAt(0).toUpperCase() + plan.slice(1);

            var html = '';

            // Container
            html += '<div class="min-h-screen mobile-full-screen py-8 px-4 lg:py-12 mobile-wide-container">';
            html += '<div class="max-w-6xl mx-auto">';

            // Check subscription status
            var subEndDate = p.subscription && p.subscription.endDate ? new Date(p.subscription.endDate) : null;
            var isExpired = subEndDate && subEndDate < new Date() && plan !== 'free';
            var isExpiringSoon = subEndDate && !isExpired && (subEndDate - new Date()) < 7 * 24 * 60 * 60 * 1000 && plan !== 'free';

            // Header - larger and more prominent
            html += '<div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-10 ' + fadeClass() + ' gap-6">';
            html += '<div>';
            html += '<h1 class="text-4xl lg:text-5xl font-bold text-white mb-3">Welcome back!</h1>';
            html += '<div class="flex flex-wrap gap-3 text-white/90">';
            html += '<span class="flex items-center gap-2 bg-white/10 px-4 py-2 rounded-full backdrop-blur"><span class="text-lg"></span> ' + utils.escapeHtml(p.email || '') + '</span>';
            html += '<span class="flex items-center gap-2 bg-gradient-to-r from-purple-500/30 to-indigo-500/30 px-4 py-2 rounded-full backdrop-blur font-semibold"><span class="text-lg"></span> ' + planName + ' Plan</span>';

            // Fiverr Verified Badge
            if (p.isFiverrVerified) {
                html += '<span class="flex items-center gap-2 bg-gradient-to-r from-green-500/30 to-emerald-500/30 px-4 py-2 rounded-full backdrop-blur font-semibold border border-green-500/30" title="Fiverr Verified Client"><span class="text-lg"></span> Fiverr Verified</span>';
            }

            html += '</div>';

            // Subscription expiry warning
            if (isExpired) {
                html += '<div class="mt-3 flex items-center gap-3">';
                html += '<span class="text-red-400 text-sm"> Your subscription has expired</span>';
                html += '<button onclick="app.openRenewalModal()" class="bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white font-semibold px-4 py-2 rounded-full text-sm transition-all shadow-lg hover:shadow-xl"> Renew Subscription</button>';
                html += '</div>';
            } else if (isExpiringSoon) {
                var daysLeft = Math.ceil((subEndDate - new Date()) / (1000 * 60 * 60 * 24));
                html += '<div class="mt-3 flex items-center gap-3">';
                html += '<span class="text-amber-400 text-sm"> Subscription expires in ' + daysLeft + ' day' + (daysLeft > 1 ? 's' : '') + '</span>';
                html += '<button onclick="app.openRenewalModal()" class="bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white font-semibold px-4 py-2 rounded-full text-sm transition-all shadow-lg hover:shadow-xl"> Renew Early</button>';
                html += '</div>';
            }

            html += '</div>';
            html += '<div class="flex items-center gap-3">';
            html += '<button onclick="app.signOut()" class="btn-secondary">Sign Out</button>';
            html += '</div>';
            html += '</div>';

            // Usage Stats - Tools data
            var tools = [
                { name: 'Warp Optimizer', key: 'warpOptimizer', emoji: '', color: 'from-blue-500 to-indigo-600' },
                { name: 'Competitor Analysis', key: 'competitorAnalysis', emoji: '', color: 'from-red-500 to-orange-600' },
                { name: 'Trend Predictor', key: 'trendPredictor', emoji: '', color: 'from-cyan-500 to-blue-600' },
                { name: 'AI Thumbnails', key: 'thumbnailGenerator', emoji: '', color: 'from-pink-500 to-rose-600' },
                { name: 'Channel Audit Pro', key: 'channelAudit', emoji: '', color: 'from-emerald-500 to-teal-600' }
            ];

            // Helper function to generate card HTML
            function generateUsageCard(tool, extraClass) {
                var usage = (p.usage && p.usage[tool.key]) || { usedToday: 0, limit: 2, lastResetAt: new Date().toISOString() };
                var quotaData = state.quotaInfo && state.quotaInfo[tool.key] ? state.quotaInfo[tool.key] : null;
                var totalLimit = quotaData ? quotaData.totalLimit : (usage.limit || 2);
                var baseLimit = quotaData ? quotaData.baseLimit : (usage.limit || 2);
                var bonusUses = quotaData ? quotaData.bonusUses : 0;

                var nextResetMs = 0;
                if (quotaData && quotaData.nextResetMs) {
                    nextResetMs = quotaData.nextResetMs;
                } else if (usage.lastResetAt) {
                    var lastResetTime = usage.lastResetAt;
                    if (typeof lastResetTime === 'object' && lastResetTime.seconds) {
                        lastResetTime = lastResetTime.seconds * 1000;
                    } else if (typeof lastResetTime === 'object' && lastResetTime._seconds) {
                        lastResetTime = lastResetTime._seconds * 1000;
                    } else if (typeof lastResetTime === 'string') {
                        lastResetTime = new Date(lastResetTime).getTime();
                    }
                    var resetIntervalMs = (state.resetTimeMinutes || 1440) * 60 * 1000;
                    nextResetMs = lastResetTime + resetIntervalMs;
                }

                var remainingUses = totalLimit - usage.usedToday;
                var isExhausted = remainingUses <= 0;
                var percent = utils.getUsagePercent(usage.usedToday, totalLimit);
                var color = utils.getUsageColor(percent);

                var cardHtml = '<div class="rounded-2xl shadow-lg p-6 lg:p-8 mobile-padding hover:shadow-xl transition-all ' + (extraClass || '') + '" style="background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08);">';
                cardHtml += '<div class="flex justify-between items-start mb-4">';
                cardHtml += '<div class="w-14 h-14 lg:w-16 lg:h-16 bg-gradient-to-br ' + tool.color + ' rounded-2xl flex items-center justify-center text-3xl lg:text-4xl shadow-lg">' + tool.emoji + '</div>';
                cardHtml += '<div class="text-right">';
                cardHtml += '<span class="text-3xl lg:text-4xl font-bold text-white">' + usage.usedToday + '<span class="text-xl lg:text-2xl text-white/50">/' + baseLimit + '</span></span>';
                if (bonusUses > 0) {
                    cardHtml += '<span class="text-lg lg:text-xl font-bold text-green-400 ml-1">+' + bonusUses + '</span>';
                }
                cardHtml += '</div>';
                cardHtml += '</div>';
                cardHtml += '<h4 class="font-bold text-white text-lg lg:text-xl mb-3">' + tool.name + '</h4>';
                cardHtml += '<div class="w-full rounded-full h-3 mb-3" style="background: rgba(255, 255, 255, 0.1);">';
                cardHtml += '<div class="' + color + ' h-3 rounded-full usage-bar transition-all" style="width:' + percent + '%"></div>';
                cardHtml += '</div>';

                if (isExhausted) {
                    var now = Date.now();
                    if (!nextResetMs || nextResetMs <= now) {
                        var resetIntervalMs = (state.resetTimeMinutes || 1440) * 60 * 1000;
                        nextResetMs = now + resetIntervalMs;
                    }
                    var remainingMs = Math.max(0, nextResetMs - now);
                    cardHtml += '<div class="flex items-center justify-between">';
                    cardHtml += '<p class="text-sm lg:text-base text-red-400 font-medium"> Resets in:</p>';
                    cardHtml += '<span class="quota-countdown text-red-400 font-bold text-lg" data-reset-at="' + nextResetMs + '">' + formatCountdown(remainingMs) + '</span>';
                    cardHtml += '</div>';
                } else {
                    cardHtml += '<p class="text-sm lg:text-base text-white/70 font-medium">' + remainingUses + ' uses remaining</p>';
                }
                cardHtml += '</div>';
                return cardHtml;
            }

            // Helper function to generate compact usage cell for desktop carousel
            function generateCompactUsageCell(tool) {
                var usage = (p.usage && p.usage[tool.key]) || { usedToday: 0, limit: 2, lastResetAt: new Date().toISOString() };
                var quotaData = state.quotaInfo && state.quotaInfo[tool.key] ? state.quotaInfo[tool.key] : null;
                var totalLimit = quotaData ? quotaData.totalLimit : (usage.limit || 2);
                var baseLimit = quotaData ? quotaData.baseLimit : (usage.limit || 2);
                var bonusUses = quotaData ? quotaData.bonusUses : 0;

                var nextResetMs = 0;
                if (quotaData && quotaData.nextResetMs) {
                    nextResetMs = quotaData.nextResetMs;
                } else if (usage.lastResetAt) {
                    var lastResetTime = usage.lastResetAt;
                    if (typeof lastResetTime === 'object' && lastResetTime.seconds) {
                        lastResetTime = lastResetTime.seconds * 1000;
                    } else if (typeof lastResetTime === 'object' && lastResetTime._seconds) {
                        lastResetTime = lastResetTime._seconds * 1000;
                    } else if (typeof lastResetTime === 'string') {
                        lastResetTime = new Date(lastResetTime).getTime();
                    }
                    var resetIntervalMs = (state.resetTimeMinutes || 1440) * 60 * 1000;
                    nextResetMs = lastResetTime + resetIntervalMs;
                }

                var remainingUses = totalLimit - usage.usedToday;
                var isExhausted = remainingUses <= 0;
                var percent = utils.getUsagePercent(usage.usedToday, totalLimit);

                // Determine progress bar color class
                var progressColor = 'bg-gradient-to-r from-green-400 to-green-500';
                if (percent >= 100) {
                    progressColor = 'bg-gradient-to-r from-red-400 to-red-500';
                } else if (percent >= 50) {
                    progressColor = 'bg-gradient-to-r from-yellow-400 to-orange-500';
                }

                var cellHtml = '<div class="compact-usage-cell">';

                // Header: Icon + Info
                cellHtml += '<div class="compact-cell-header">';
                cellHtml += '<div class="compact-cell-icon bg-gradient-to-br ' + tool.color + '">' + tool.emoji + '</div>';
                cellHtml += '<div class="compact-cell-info">';
                cellHtml += '<div class="compact-cell-name">' + tool.name + '</div>';
                cellHtml += '<div class="compact-cell-usage"><strong>' + usage.usedToday + '</strong>/' + baseLimit;
                if (bonusUses > 0) {
                    cellHtml += ' <span class="compact-cell-bonus">+' + bonusUses + '</span>';
                }
                cellHtml += '</div>';
                cellHtml += '</div>';
                cellHtml += '</div>';

                // Progress bar
                cellHtml += '<div class="compact-progress-bar">';
                cellHtml += '<div class="compact-progress-fill ' + progressColor + '" style="width:' + percent + '%"></div>';
                cellHtml += '</div>';

                // Footer: remaining or countdown
                if (isExhausted) {
                    var now = Date.now();
                    if (!nextResetMs || nextResetMs <= now) {
                        var resetIntervalMs = (state.resetTimeMinutes || 1440) * 60 * 1000;
                        nextResetMs = now + resetIntervalMs;
                    }
                    var remainingMs = Math.max(0, nextResetMs - now);
                    cellHtml += '<div class="compact-cell-footer exhausted">';
                    cellHtml += ' <span class="compact-cell-countdown quota-countdown" data-reset-at="' + nextResetMs + '">' + formatCountdown(remainingMs) + '</span>';
                    cellHtml += '</div>';
                } else {
                    cellHtml += '<div class="compact-cell-footer">' + remainingUses + ' remaining</div>';
                }

                cellHtml += '</div>';
                return cellHtml;
            }

            // Desktop Carousel (hidden on mobile) - compact horizontal strip
            html += '<div class="desktop-usage-carousel ' + fadeClass() + '" id="desktopUsageCarousel">';
            for (var i = 0; i < tools.length; i++) {
                html += generateCompactUsageCell(tools[i]);
            }
            html += '</div>';

            // Desktop Grid - kept for fallback but hidden by CSS
            html += '<div class="desktop-usage-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 dashboard-grid-4 gap-5 lg:gap-6 mb-10 ' + fadeClass() + '">';
            for (var i = 0; i < tools.length; i++) {
                html += generateUsageCard(tools[i], '');
            }
            html += '</div>';

            // Mobile Swipeable Container (hidden on desktop)
            html += '<div class="mobile-swipe-container mb-2 ' + fadeClass() + '" id="usageSwipeContainer">';
            for (var i = 0; i < tools.length; i++) {
                html += generateUsageCard(tools[i], 'mobile-swipe-card');
            }
            html += '</div>';

            // Mobile Swipe Dots
            html += '<div class="mobile-swipe-dots mb-8" id="usageSwipeDots">';
            for (var i = 0; i < tools.length; i++) {
                html += '<div class="mobile-swipe-dot' + (i === 0 ? ' active' : '') + '" data-index="' + i + '" onclick="app.scrollToUsageCard(' + i + ')"></div>';
            }
            html += '</div>';

            // Check if user has any bonus uses to show history link
            var hasBonusUses = false;
            var toolKeys = ['warpOptimizer', 'competitorAnalysis', 'trendPredictor', 'thumbnailGenerator'];
            for (var j = 0; j < toolKeys.length; j++) {
                var qd = state.quotaInfo && state.quotaInfo[toolKeys[j]] ? state.quotaInfo[toolKeys[j]] : null;
                if (qd && qd.bonusUses > 0) {
                    hasBonusUses = true;
                    break;
                }
            }

            // Show bonus history link if user has bonus uses
            if (hasBonusUses) {
                html += '<div class="flex justify-end mb-4 fade-in">';
                html += '<button onclick="app.openBonusHistory()" class="text-sm text-green-400 hover:text-green-300 transition-colors flex items-center gap-1">';
                html += '<span></span> View Bonus History';
                html += '</button>';
                html += '</div>';
            }

            // My Campaign Reports & Enterprise Suite Cards - Side by Side
            html += '<div class="grid grid-cols-2 gap-4 lg:gap-6 mb-8 ' + fadeClass() + ' dashboard-cards-grid">';

            // My Campaign Reports Card - with Living Aurora effect
            html += '<div class="living-aurora aurora-emerald rounded-2xl shadow-xl p-5 lg:p-8 dashboard-card cursor-pointer transition-all hover:shadow-2xl hover:scale-[1.02] relative overflow-hidden" onclick="app.goToClientReports()">';
            // Aurora orbs layer
            html += '<div class="aurora-orbs">';
            html += '<div class="aurora-orb aurora-orb-1"></div>';
            html += '<div class="aurora-orb aurora-orb-2"></div>';
            html += '<div class="aurora-orb aurora-orb-3"></div>';
            html += '<div class="aurora-orb aurora-orb-4"></div>';
            html += '</div>';
            // Glass overlay for readability
            html += '<div class="aurora-glass"></div>';
            // Shimmer effect
            html += '<div class="aurora-shimmer"></div>';
            if (state.unreadCount > 0) {
                html += '<div class="absolute top-2 right-2 lg:top-4 lg:right-4 flex items-center gap-1 lg:gap-2 z-10">';
                html += '<span class="notification-dot"></span>';
                html += '<span class="bg-white/20 text-white text-xs lg:text-sm font-bold px-2 lg:px-3 py-0.5 lg:py-1 rounded-full">' + state.unreadCount + '</span>';
                html += '</div>';
            }
            html += '<div class="aurora-content flex items-center gap-3 lg:gap-5">';
            html += '<div class="dashboard-card-icon w-12 h-12 lg:w-16 lg:h-16 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center text-2xl lg:text-4xl"></div>';
            html += '<div class="flex-1 min-w-0">';
            html += '<h3 class="dashboard-card-title text-base lg:text-2xl font-bold text-white mb-0.5 lg:mb-1 drop-shadow-sm">My Campaign Reports</h3>';
            html += '<p class="dashboard-card-subtitle text-white/90 text-xs lg:text-base truncate drop-shadow-sm">View your Google Ads performance reports</p>';
            html += '</div>';
            html += '<div class="dashboard-card-arrow text-white text-xl lg:text-3xl hidden sm:block drop-shadow-sm"></div>';
            html += '</div></div>';

            // Enterprise Suite Card - with Living Aurora effect
            html += '<a href="https://ytseo.siteuo.com/enterprise-suite" class="block">';
            html += '<div class="living-aurora aurora-gold rounded-2xl shadow-xl p-5 lg:p-8 dashboard-card cursor-pointer transition-all hover:shadow-2xl hover:scale-[1.02] relative overflow-hidden border-2 border-yellow-300/50 h-full">';
            // Aurora orbs layer
            html += '<div class="aurora-orbs">';
            html += '<div class="aurora-orb aurora-orb-1"></div>';
            html += '<div class="aurora-orb aurora-orb-2"></div>';
            html += '<div class="aurora-orb aurora-orb-3"></div>';
            html += '<div class="aurora-orb aurora-orb-4"></div>';
            html += '</div>';
            // Glass overlay for readability
            html += '<div class="aurora-glass"></div>';
            // Shimmer effect
            html += '<div class="aurora-shimmer"></div>';
            html += '<div class="aurora-content flex items-center gap-3 lg:gap-5">';
            html += '<div class="dashboard-card-icon w-12 h-12 lg:w-16 lg:h-16 bg-gradient-to-br from-yellow-200/90 to-amber-300/90 backdrop-blur-sm rounded-xl flex items-center justify-center text-2xl lg:text-4xl shadow-lg"></div>';
            html += '<div class="flex-1 min-w-0">';
            html += '<div class="flex items-center gap-1 lg:gap-2 mb-0.5 lg:mb-1">';
            html += '<h3 class="dashboard-card-title text-base lg:text-2xl font-bold text-gray-900 drop-shadow-sm">Enterprise Suite</h3>';
            html += '<span class="bg-gray-900/80 text-yellow-400 text-[10px] lg:text-xs font-bold px-1.5 lg:px-2 py-0.5 lg:py-1 rounded-full backdrop-blur-sm">PRO</span>';
            html += '</div>';
            html += '<p class="dashboard-card-subtitle text-gray-800/90 text-xs lg:text-base truncate drop-shadow-sm">Bulk Optimizer, Placement Finder, Viral Predictor, Monetization & Script Writer</p>';
            html += '</div>';
            html += '<div class="dashboard-card-arrow text-gray-900 text-xl lg:text-3xl font-bold hidden sm:block drop-shadow-sm"></div>';
            html += '</div>';
            html += '</div>';
            html += '</a>';

            html += '</div>'; // End grid

            // Main Tools Section Title
            html += '<h2 class="text-2xl lg:text-3xl font-bold text-white mb-6 ' + fadeClass() + '"> AI Tools</h2>';

            // Featured Tools Row - Video Wizard & Creative Studio side by side
            html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4 lg:gap-6 mb-6 ' + fadeClass() + '">';

            // Video-to-Shorts Wizard - Compact Card
            html += '<a href="https://ytseo.siteuo.com/video-wizard" class="block group">';
            html += '<div class="rounded-2xl p-4 lg:p-5 cursor-pointer relative overflow-hidden transition-all duration-300 hover:scale-[1.02] hover:shadow-xl flex items-center gap-4" style="background: linear-gradient(135deg, rgba(236, 72, 153, 0.12) 0%, rgba(249, 115, 22, 0.12) 100%); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(236, 72, 153, 0.25);">';
            html += '<div class="w-12 h-12 lg:w-14 lg:h-14 bg-gradient-to-br from-pink-500 to-orange-500 rounded-xl flex items-center justify-center text-2xl lg:text-3xl shadow-lg flex-shrink-0"></div>';
            html += '<div class="flex-1 min-w-0">';
            html += '<div class="flex items-center gap-2 mb-0.5">';
            html += '<h3 class="text-base lg:text-lg font-bold text-white truncate">Video-to-Shorts Wizard</h3>';
            html += '<span class="bg-gradient-to-r from-pink-500 to-orange-500 text-white text-[9px] lg:text-[10px] font-bold px-1.5 py-0.5 rounded-full flex-shrink-0">NEW</span>';
            html += '</div>';
            html += '<p class="text-white/60 text-xs lg:text-sm truncate">AI clipping, captions & thumbnails</p>';
            html += '</div>';
            html += '<div class="text-white/40 text-xl group-hover:text-pink-400 group-hover:translate-x-1 transition-all flex-shrink-0"></div>';
            html += '</div>';
            html += '</a>';

            // Creative Studio - Compact Card
            html += '<a href="https://ytseo.siteuo.com/creative-studio" class="block group">';
            html += '<div class="rounded-2xl p-4 lg:p-5 cursor-pointer relative overflow-hidden transition-all duration-300 hover:scale-[1.02] hover:shadow-xl flex items-center gap-4" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.12) 0%, rgba(236, 72, 153, 0.12) 100%); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(168, 85, 247, 0.25);">';
            html += '<div class="w-12 h-12 lg:w-14 lg:h-14 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center text-2xl lg:text-3xl shadow-lg flex-shrink-0"></div>';
            html += '<div class="flex-1 min-w-0">';
            html += '<div class="flex items-center gap-2 mb-0.5">';
            html += '<h3 class="text-base lg:text-lg font-bold text-white truncate">Creative Studio</h3>';
            html += '<span class="bg-gradient-to-r from-purple-500 to-pink-500 text-white text-[9px] lg:text-[10px] font-bold px-1.5 py-0.5 rounded-full flex-shrink-0">NEW</span>';
            html += '</div>';
            html += '<p class="text-white/60 text-xs lg:text-sm truncate">AI images, motion & canvas editor</p>';
            html += '</div>';
            html += '<div class="text-white/40 text-xl group-hover:text-purple-400 group-hover:translate-x-1 transition-all flex-shrink-0"></div>';
            html += '</div>';
            html += '</a>';

            html += '</div>'; // End featured tools row

            // Action Cards - 5 tools in responsive grid
            html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8 ' + fadeClass() + '">';

            // Optimizer Card
            html += '<div class="rounded-3xl shadow-xl p-6 lg:p-8 tool-card cursor-pointer" style="background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08);" onclick="app.goToOptimizer()">';
            html += '<div class="w-16 h-16 lg:w-20 lg:h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center text-4xl lg:text-5xl shadow-xl mb-5"></div>';
            html += '<h3 class="text-xl lg:text-2xl font-bold text-white mb-2">Video Optimizer</h3>';
            html += '<p class="text-white/70 mb-4 text-sm lg:text-base">AI-powered SEO optimization for your videos</p>';
            html += '<div class="flex items-center text-blue-400 font-bold group">';
            html += '<span>Optimize</span><span class="ml-2 group-hover:translate-x-2 transition-transform"></span>';
            html += '</div></div>';

            // Competitor Analysis Card (NEW)
            html += '<div class="rounded-3xl shadow-xl p-6 lg:p-8 tool-card cursor-pointer relative overflow-hidden" style="background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08);" onclick="app.goToCompetitor()">';
            html += '<div class="absolute top-3 right-3 bg-gradient-to-r from-green-400 to-emerald-500 text-white text-xs font-bold px-2 py-1 rounded-full">NEW</div>';
            html += '<div class="w-16 h-16 lg:w-20 lg:h-20 bg-gradient-to-br from-red-500 to-orange-600 rounded-2xl flex items-center justify-center text-4xl lg:text-5xl shadow-xl mb-5"></div>';
            html += '<h3 class="text-xl lg:text-2xl font-bold text-white mb-2">Competitor Analysis</h3>';
            html += '<p class="text-white/70 mb-4 text-sm lg:text-base">Analyze competitors and find ways to beat them</p>';
            html += '<div class="flex items-center text-red-400 font-bold group">';
            html += '<span>Analyze</span><span class="ml-2 group-hover:translate-x-2 transition-transform"></span>';
            html += '</div></div>';

            // Trend Predictor Card (NEW)
            html += '<div class="rounded-3xl shadow-xl p-6 lg:p-8 tool-card cursor-pointer relative overflow-hidden" style="background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08);" onclick="app.goToTrends()">';
            html += '<div class="absolute top-3 right-3 bg-gradient-to-r from-green-400 to-emerald-500 text-white text-xs font-bold px-2 py-1 rounded-full">NEW</div>';
            html += '<div class="w-16 h-16 lg:w-20 lg:h-20 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-2xl flex items-center justify-center text-4xl lg:text-5xl shadow-xl mb-5"></div>';
            html += '<h3 class="text-xl lg:text-2xl font-bold text-white mb-2">Trend Predictor</h3>';
            html += '<p class="text-white/70 mb-4 text-sm lg:text-base">Predict viral trends before they happen</p>';
            html += '<div class="flex items-center text-cyan-400 font-bold group">';
            html += '<span>Predict</span><span class="ml-2 group-hover:translate-x-2 transition-transform"></span>';
            html += '</div></div>';

            // Thumbnail Generator Card (NEW)
            html += '<div class="rounded-3xl shadow-xl p-6 lg:p-8 tool-card cursor-pointer relative overflow-hidden" style="background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08);" onclick="app.goToThumbnail()">';
            html += '<div class="absolute top-3 right-3 bg-gradient-to-r from-green-400 to-emerald-500 text-white text-xs font-bold px-2 py-1 rounded-full">NEW</div>';
            html += '<div class="w-16 h-16 lg:w-20 lg:h-20 bg-gradient-to-br from-pink-500 to-rose-600 rounded-2xl flex items-center justify-center text-4xl lg:text-5xl shadow-xl mb-5"></div>';
            html += '<h3 class="text-xl lg:text-2xl font-bold text-white mb-2">AI Thumbnails</h3>';
            html += '<p class="text-white/70 mb-4 text-sm lg:text-base">Generate click-worthy thumbnails with AI</p>';
            html += '<div class="flex items-center text-pink-400 font-bold group">';
            html += '<span>Generate</span><span class="ml-2 group-hover:translate-x-2 transition-transform"></span>';
            html += '</div></div>';

            // Channel Audit Pro Card (NEW - replaces Placement Finder)
            html += '<div class="rounded-3xl shadow-xl p-6 lg:p-8 tool-card cursor-pointer relative overflow-hidden" style="background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08);" onclick="app.goToChannelAudit()">';
            html += '<div class="absolute top-3 right-3 bg-gradient-to-r from-green-400 to-emerald-500 text-white text-xs font-bold px-2 py-1 rounded-full">NEW</div>';
            html += '<div class="w-16 h-16 lg:w-20 lg:h-20 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl flex items-center justify-center text-4xl lg:text-5xl shadow-xl mb-5"></div>';
            html += '<h3 class="text-xl lg:text-2xl font-bold text-white mb-2">Channel Audit Pro</h3>';
            html += '<p class="text-white/70 mb-4 text-sm lg:text-base">Complete channel analysis with growth recommendations</p>';
            html += '<div class="flex items-center text-emerald-400 font-bold group">';
            html += '<span>Audit Channel</span><span class="ml-2 group-hover:translate-x-2 transition-transform"></span>';
            html += '</div></div>';

            // More AI Tools Card - Links to expanded tools page
            html += '<div class="rounded-3xl shadow-xl p-6 lg:p-8 tool-card cursor-pointer relative overflow-hidden" style="background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08);" onclick="app.goToMoreTools()">';
            html += '<div class="absolute top-3 right-3 bg-gradient-to-r from-purple-400 to-indigo-500 text-white text-xs font-bold px-2 py-1 rounded-full">EXPLORE</div>';
            html += '<div class="w-16 h-16 lg:w-20 lg:h-20 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl flex items-center justify-center text-4xl lg:text-5xl shadow-xl mb-5"></div>';
            html += '<h3 class="text-xl lg:text-2xl font-bold text-white mb-2">More AI Tools</h3>';
            html += '<p class="text-white/70 mb-4 text-sm lg:text-base">Discover additional AI-powered tools</p>';
            html += '<div class="flex items-center text-purple-400 font-bold group">';
            html += '<span>Explore</span><span class="ml-2 group-hover:translate-x-2 transition-transform"></span>';
            html += '</div></div>';

            html += '</div>';

            // ========== RECENT ACTIVITY SECTION ==========
            html += '<div class="mt-8 ' + fadeClass() + '">';
            html += '<div class="flex items-center justify-between mb-4">';
            html += '<h2 class="text-xl lg:text-2xl font-bold text-white"> Recent Activity</h2>';
            html += '<button onclick="app.goToHistory()" class="text-white/80 hover:text-white font-medium flex items-center gap-1 transition-colors">';
            html += '<span>View All</span><span></span>';
            html += '</button>';
            html += '</div>';

            html += '<div class="bg-white/10 backdrop-blur-sm rounded-2xl border border-white/20 overflow-hidden">';

            if (state.dashboardActivityLoading) {
                // Loading state
                html += '<div class="p-6 text-center">';
                html += '<div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto"></div>';
                html += '<p class="text-white/60 mt-2 text-sm">Loading activity...</p>';
                html += '</div>';
            } else if (!state.dashboardRecentActivity || state.dashboardRecentActivity.length === 0) {
                // Empty state
                html += '<div class="p-6 text-center">';
                html += '<p class="text-white/60">No recent activity yet. Start using the tools above!</p>';
                html += '</div>';
            } else {
                // Activity items
                html += '<div class="divide-y divide-white/10">';
                var typeIcons = {
                    optimization: '',
                    competitor: '',
                    trend: '',
                    thumbnail: '',
                    channelAudit: '',
                    placement: ''
                };
                var typeColors = {
                    optimization: 'from-blue-500 to-purple-600',
                    competitor: 'from-red-500 to-orange-600',
                    trend: 'from-cyan-500 to-blue-600',
                    thumbnail: 'from-pink-500 to-rose-600',
                    channelAudit: 'from-emerald-500 to-teal-600',
                    placement: 'from-purple-500 to-violet-600'
                };
                var typeLabels = {
                    optimization: 'Video Optimization',
                    competitor: 'Competitor Analysis',
                    trend: 'Trend Prediction',
                    thumbnail: 'Thumbnail Generated',
                    channelAudit: 'Channel Audit',
                    placement: 'Placement Search'
                };

                for (var ai = 0; ai < state.dashboardRecentActivity.length; ai++) {
                    var activity = state.dashboardRecentActivity[ai];
                    var icon = typeIcons[activity.type] || '';
                    var color = typeColors[activity.type] || 'from-gray-500 to-gray-600';
                    var label = typeLabels[activity.type] || activity.type;
                    var title = activity.title || activity.videoTitle || activity.niche || activity.channelName || 'Untitled';
                    var timeAgo = utils.formatTimeAgo ? utils.formatTimeAgo(activity.timestamp) : 'Recently';

                    html += '<div class="flex items-center gap-4 p-4 hover:bg-white/5 transition-colors cursor-pointer" onclick="app.goToHistory(\'' + activity.type + '\')">';
                    html += '<div class="w-10 h-10 bg-gradient-to-br ' + color + ' rounded-xl flex items-center justify-center text-lg flex-shrink-0">' + icon + '</div>';
                    html += '<div class="flex-1 min-w-0">';
                    html += '<p class="text-white font-medium truncate">' + utils.escapeHtml(title) + '</p>';
                    html += '<p class="text-white/50 text-sm">' + label + '</p>';
                    html += '</div>';
                    html += '<div class="text-white/40 text-sm flex-shrink-0">' + timeAgo + '</div>';
                    html += '</div>';
                }
                html += '</div>';
            }

            html += '</div>';
            html += '</div>';

            // Admin Section (only for admins)
            if (state.isAdmin) {
                html += '<div class="mt-8 ' + fadeClass() + '">';
                html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">';

                // Admin Dashboard Card
                html += '<div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl shadow-xl p-8 mobile-padding cursor-pointer hover:from-purple-700 hover:to-indigo-700 transition-all hover:shadow-2xl hover:scale-[1.02]" onclick="app.goToAdmin()">';
                html += '<div class="flex items-center gap-5">';
                html += '<div class="text-5xl"></div>';
                html += '<div class="flex-1">';
                html += '<h3 class="text-2xl font-bold text-white mb-1">Admin Dashboard</h3>';
                html += '<p class="text-white/80">Manage users, subscriptions & analytics</p>';
                html += '</div>';
                html += '<div class="text-white text-3xl"></div>';
                html += '</div></div>';

                // Campaign Reports Card (Admin)
                html += '<div class="bg-gradient-to-r from-amber-500 to-orange-600 rounded-2xl shadow-xl p-8 mobile-padding cursor-pointer hover:from-amber-600 hover:to-orange-700 transition-all hover:shadow-2xl hover:scale-[1.02]" onclick="app.goToAdminReports()">';
                html += '<div class="flex items-center gap-5">';
                html += '<div class="text-5xl"></div>';
                html += '<div class="flex-1">';
                html += '<h3 class="text-2xl font-bold text-white mb-1">Campaign Reports</h3>';
                html += '<p class="text-white/80">Create & send client reports</p>';
                html += '</div>';
                html += '<div class="text-white text-3xl"></div>';
                html += '</div></div>';

                html += '</div></div>';
            }

            html += '</div></div>';

            // Version Footer
            html += '<div class="text-center py-6 mt-8">';
            html += '<p class="text-white/40 text-sm">YouTubeHub v' + PLATFORM_VERSION + '</p>';
            html += '</div>';

            // Bonus History Modal
            if (state.showBonusHistory) {
                html += '<div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" onclick="app.closeBonusHistory()">';
                html += '<div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[80vh] overflow-hidden" onclick="event.stopPropagation()">';
                html += '<div class="bg-gradient-to-r from-green-500 to-emerald-600 p-6">';
                html += '<div class="flex justify-between items-center">';
                html += '<h3 class="text-xl font-bold text-white flex items-center gap-2"><span></span> Bonus History</h3>';
                html += '<button onclick="app.closeBonusHistory()" class="text-white/80 hover:text-white text-2xl">&times;</button>';
                html += '</div>';
                html += '</div>';
                html += '<div class="p-6 overflow-y-auto max-h-[60vh]">';

                if (state.bonusHistory === null) {
                    // Loading
                    html += '<div class="flex items-center justify-center py-8">';
                    html += '<div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-500"></div>';
                    html += '</div>';
                } else if (state.bonusHistory.length === 0) {
                    // No history
                    html += '<div class="text-center py-8 text-gray-500">';
                    html += '<p>No bonus history found.</p>';
                    html += '</div>';
                } else {
                    // History list
                    html += '<div class="space-y-3">';
                    var toolNames = {
                        warpOptimizer: 'Warp Optimizer',
                        competitorAnalysis: 'Competitor Analysis',
                        trendPredictor: 'Trend Predictor',
                        thumbnailGenerator: 'AI Thumbnails',
                        channelAudit: 'Channel Audit Pro'
                    };
                    var toolEmojis = {
                        warpOptimizer: '',
                        competitorAnalysis: '',
                        trendPredictor: '',
                        thumbnailGenerator: '',
                        channelAudit: ''
                    };
                    for (var h = 0; h < state.bonusHistory.length; h++) {
                        var bonus = state.bonusHistory[h];
                        var toolDisplayName = toolNames[bonus.tool] || bonus.tool;
                        var toolEmoji = toolEmojis[bonus.tool] || '';
                        var bonusDate = new Date(bonus.timestamp);
                        var dateStr = bonusDate.toLocaleDateString() + ' ' + bonusDate.toLocaleTimeString();

                        html += '<div class="bg-gray-50 rounded-lg p-4 flex items-center justify-between">';
                        html += '<div class="flex items-center gap-3">';
                        html += '<span class="text-2xl">' + toolEmoji + '</span>';
                        html += '<div>';
                        html += '<p class="font-semibold text-gray-800">' + toolDisplayName + '</p>';
                        html += '<p class="text-sm text-gray-500">' + dateStr + '</p>';
                        html += '</div>';
                        html += '</div>';
                        html += '<span class="text-xl font-bold text-green-600">+' + bonus.amount + '</span>';
                        html += '</div>';
                    }
                    html += '</div>';
                }

                html += '</div>';
                html += '</div>';
                html += '</div>';
            }

            return html;
        }

        /* ------------------------------------------
           4.6.5 Optimizer View
           ------------------------------------------ */
        function renderOptimizer() {
            var html = '';

            // Container
            html += '<div class="min-h-screen mobile-full-screen py-12 px-4 mobile-wide-container">';
            html += '<div class="max-w-4xl mx-auto">';

            // Navigation buttons
            html += '<div class="flex flex-wrap gap-3 mb-6">';
            html += '<button onclick="app.goToDashboard()" class="px-6 py-3 bg-white/20 text-white rounded-xl hover:bg-white/30"> Back</button>';
            html += '<button onclick="app.goToHistory(\'optimization\')" class="px-6 py-3 bg-white/20 text-white rounded-xl hover:bg-white/30"> View History</button>';
            html += '</div>';

            // Card
            html += '<div class="bg-white rounded-2xl shadow-xl p-8 mobile-padding fade-in">';
            html += '<h2 class="text-3xl mobile-text-xl font-bold text-gray-800 mb-4"> Video Optimizer</h2>';

            // Feature Description Section - Collapsible on mobile
            html += '<div class="mb-6">';
            html += '<div class="bg-gradient-to-r from-blue-50 via-indigo-50 to-purple-50 rounded-xl overflow-hidden border border-blue-100">';

            // Mobile: Collapsible header - NOW VISIBLE ON ALL SCREENS
            html += '<button type="button" onclick="this.parentElement.classList.toggle(\'expanded\'); this.querySelector(\'.chevron\').classList.toggle(\'rotate-180\')" class="w-full p-4 flex items-center justify-between text-left">';
            html += '<span class="flex items-center gap-2 font-semibold text-gray-800"><span class="text-lg"></span> What can this tool do?</span>';
            html += '<svg class="chevron w-5 h-5 text-gray-500 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>';
            html += '</button>';

            // Content area - removed hidden class, CSS handles visibility
            html += '<div class="feature-info-content">';
            html += '<p class="text-gray-700 mb-3 leading-relaxed">Transform your video\'s discoverability with AI-powered SEO optimization. Our advanced algorithms analyze your content and generate optimized metadata to help you rank higher and get more views.</p>';
            html += '<div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">';
            html += '<div class="flex items-start gap-2"><span class="text-green-500 mt-0.5"></span><span class="text-gray-600"><strong>SEO-Optimized Titles</strong>  5 click-worthy title suggestions</span></div>';
            html += '<div class="flex items-start gap-2"><span class="text-green-500 mt-0.5"></span><span class="text-gray-600"><strong>Rich Descriptions</strong>  Keyword-rich, engaging descriptions</span></div>';
            html += '<div class="flex items-start gap-2"><span class="text-green-500 mt-0.5"></span><span class="text-gray-600"><strong>Strategic Tags</strong>  High-ranking keyword tags</span></div>';
            html += '<div class="flex items-start gap-2"><span class="text-green-500 mt-0.5"></span><span class="text-gray-600"><strong>SEO Score</strong>  Before & after optimization rating</span></div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';

            // Error message (supports both string and object format)
            if (state.error) {
                var errorMsg = typeof state.error === 'string' ? state.error : state.error.message;
                var errorDetails = typeof state.error === 'object' ? state.error.details : null;
                var errorCode = typeof state.error === 'object' ? state.error.code : null;
                var errorRaw = typeof state.error === 'object' ? state.error.raw : null;

                html += '<div class="mb-6 p-4 bg-red-50 border-2 border-red-300 rounded-lg">';
                html += '<div class="flex items-start gap-3">';
                html += '<span class="text-2xl"></span>';
                html += '<div class="flex-1">';
                html += '<p class="font-bold text-red-800">' + utils.escapeHtml(errorMsg) + '</p>';

                if (errorDetails) {
                    html += '<p class="mt-2 text-sm text-red-600">' + utils.escapeHtml(errorDetails) + '</p>';
                }

                if (errorCode) {
                    html += '<div class="mt-3 pt-3 border-t border-red-200">';
                    html += '<button onclick="app.toggleErrorDetails()" class="text-xs text-red-500 hover:text-red-700 underline">Show Technical Details</button>';
                    html += '<div id="error-details" class="hidden mt-2 p-2 bg-red-100 rounded text-xs font-mono text-red-700">';
                    html += '<p><strong>Code:</strong> ' + utils.escapeHtml(errorCode) + '</p>';
                    if (errorRaw) {
                        html += '<p class="mt-1"><strong>Raw:</strong> ' + utils.escapeHtml(errorRaw) + '</p>';
                    }
                    html += '</div></div>';
                }

                html += '</div></div></div>';
            }

            // Form
            html += '<form onsubmit="app.optimize(event)">';
            html += '<div class="mb-6">';
            html += '<label class="block text-gray-700 font-semibold mb-2">YouTube Video URL</label>';
            html += '<input type="text" id="video-url" placeholder="https://www.youtube.com/watch?v=..." class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" required />';
            html += '</div>';

            html += '<button type="submit" class="btn-primary"';
            if (state.loading) html += ' disabled';
            html += '>';
            html += state.loading ? ' Optimizing...' : ' Optimize Video';
            html += '</button>';
            html += '</form>';

            // Professional Loading Animation
            if (state.loading) {
                var progress = Math.round(state.loadingProgress);
                var currentStep = state.loadingStep;
                var tips = [
                    ' Tip: Titles with numbers get 36% more clicks!',
                    ' Did you know? Descriptions over 200 words rank higher.',
                    ' Pro tip: Use 8-15 relevant tags for best results.',
                    ' Fun fact: Question-based titles increase engagement by 23%.'
                ];
                var randomTip = tips[Math.floor(progress / 25) % tips.length];

                html += '<div class="mt-8 loading-container fade-in">';

                // Header with emoji and percentage
                html += '<div class="flex flex-col md:flex-row items-center justify-between gap-6 mb-8">';
                html += '<div class="flex items-center gap-4">';
                html += '<div class="loading-emoji"></div>';
                html += '<div>';
                html += '<h3 class="text-2xl font-bold text-gray-800">Optimizing Your Video</h3>';
                html += '<p class="text-gray-500">AI magic in progress...</p>';
                html += '</div></div>';
                html += '<div class="progress-percentage">' + progress + '%</div>';
                html += '</div>';

                // Progress Bar
                html += '<div class="mb-8">';
                html += '<div class="progress-bar-container">';
                html += '<div class="progress-bar-fill" style="width: ' + progress + '%"></div>';
                html += '</div>';
                html += '</div>';

                // Steps Grid
                html += '<div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6">';
                for (var s = 0; s < state.loadingSteps.length; s++) {
                    var step = state.loadingSteps[s];
                    var stepStatus = s < currentStep ? 'completed' : (s === currentStep ? 'active' : 'pending');
                    var iconStatus = stepStatus;

                    html += '<div class="loading-step ' + stepStatus + '">';
                    html += '<div class="step-icon ' + iconStatus + '">';
                    if (stepStatus === 'completed') {
                        html += '';
                    } else {
                        html += step.icon;
                    }
                    html += '</div>';
                    html += '<span class="text-sm font-medium ' + (stepStatus === 'pending' ? 'text-gray-400' : 'text-gray-700') + '">' + step.name + '</span>';
                    html += '</div>';
                }
                html += '</div>';

                // Tip
                html += '<div class="loading-tip">';
                html += '<p class="text-sm text-indigo-700">' + randomTip + '</p>';
                html += '</div>';

                html += '</div>';
            }

            html += '</div></div></div>';

            return html;
        }

        /* ------------------------------------------
           4.6.6 Results View (Tabbed Interface)
           ------------------------------------------ */
        function renderResults() {
            if (!state.currentResults) {
                return '<div class="text-white text-center py-12">No results available. <button onclick="app.goToOptimizer()" class="underline">Optimize a video</button></div>';
            }

            const r = state.currentResults;
            const tab = state.resultsTab || 'titles';
            var html = '';

            // Container - mobile-wide-container for expanded width on mobile
            html += '<div class="min-h-screen mobile-full-screen py-6 px-4 mobile-wide-container">';
            html += '<div class="max-w-4xl mx-auto">';

            // Header with navigation
            html += '<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4 fade-in">';
            html += '<h1 class="text-2xl sm:text-3xl font-bold text-white"> Optimization Results</h1>';
            html += '<div class="flex gap-2 w-full sm:w-auto">';
            html += '<button onclick="app.goToDashboard()" class="flex-1 sm:flex-none btn-secondary text-sm sm:text-base"> Dashboard</button>';
            html += '<button onclick="app.goToOptimizer()" class="flex-1 sm:flex-none btn-secondary text-sm sm:text-base"> New</button>';
            html += '</div></div>';

            // SEO Score Card (Before/After) - improved mobile layout
            html += '<div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 mb-6 fade-in">';

            // Before Score (estimated based on video metadata)
            var beforeScore = Math.min(45, Math.round((r.videoInfo?.viewCount || 0) / 100000 * 10) + 25);
            var afterScore = r.seoAnalysis?.score || 85;
            var improvement = afterScore - beforeScore;

            // Scores container - horizontal on all screens with responsive sizing
            html += '<div class="flex flex-row items-center justify-center gap-2 sm:gap-6 md:gap-8 flex-wrap">';

            // Before Score
            html += '<div class="text-center">';
            html += '<p class="text-xs sm:text-sm font-medium text-gray-500 mb-2">Current SEO</p>';
            html += '<div class="score-gauge">';
            html += '<svg class="score-circle w-24 h-24 sm:w-32 sm:h-32 md:w-[140px] md:h-[140px]" viewBox="0 0 140 140">';
            html += '<circle class="score-circle-bg" cx="70" cy="70" r="58"></circle>';
            var beforeDash = (beforeScore / 100) * 364;
            html += '<circle class="score-circle-fill" cx="70" cy="70" r="58" stroke="#ef4444" stroke-dasharray="' + beforeDash + ' 364"></circle>';
            html += '</svg>';
            html += '<div class="score-value text-red-500 text-2xl sm:text-3xl md:text-4xl">' + beforeScore + '</div>';
            html += '</div>';
            html += '</div>';

            // Arrow - always horizontal
            html += '<div class="text-2xl sm:text-4xl md:text-5xl text-gray-300"></div>';

            // After Score
            html += '<div class="text-center">';
            html += '<p class="text-xs sm:text-sm font-medium text-gray-500 mb-2">After Optimization</p>';
            html += '<div class="score-gauge">';
            html += '<svg class="score-circle w-24 h-24 sm:w-32 sm:h-32 md:w-[140px] md:h-[140px]" viewBox="0 0 140 140">';
            html += '<circle class="score-circle-bg" cx="70" cy="70" r="58"></circle>';
            var afterDash = (afterScore / 100) * 364;
            var afterColor = afterScore >= 80 ? '#22c55e' : afterScore >= 60 ? '#eab308' : '#ef4444';
            html += '<circle class="score-circle-fill" cx="70" cy="70" r="58" stroke="' + afterColor + '" stroke-dasharray="' + afterDash + ' 364"></circle>';
            html += '</svg>';
            html += '<div class="score-value text-2xl sm:text-3xl md:text-4xl" style="color:' + afterColor + '">' + afterScore + '</div>';
            html += '</div>';
            html += '</div>';

            // Improvement badge - inline on larger screens, below on mobile
            html += '<div class="text-center bg-gradient-to-br from-green-50 to-emerald-100 px-4 sm:px-8 py-3 sm:py-5 rounded-2xl border border-green-200 w-full sm:w-auto mt-4 sm:mt-0">';
            html += '<p class="text-2xl sm:text-3xl md:text-4xl font-bold text-green-600">+' + improvement + '%</p>';
            html += '<p class="text-xs sm:text-sm font-medium text-green-700 mt-1">SEO Improvement</p>';
            html += '</div>';

            html += '</div></div>';

            // Video Info (Compact)
            if (r.videoInfo) {
                html += '<div class="bg-white/10 rounded-xl p-4 mb-4 fade-in">';
                html += '<div class="flex items-center gap-4">';
                if (r.videoInfo.thumbnail) {
                    html += '<img src="' + utils.escapeHtml(r.videoInfo.thumbnail) + '" class="w-24 h-14 object-cover rounded-lg" alt="Thumbnail" />';
                }
                html += '<div class="flex-1 min-w-0">';
                html += '<p class="text-white font-semibold truncate">' + utils.escapeHtml(r.videoInfo.title || 'N/A') + '</p>';
                html += '<p class="text-white/70 text-sm">' + utils.escapeHtml(r.videoInfo.channelTitle || '') + '  ' + utils.formatNumber(r.videoInfo.viewCount || 0) + ' views</p>';
                html += '</div></div></div>';
            }

            // Main Content Card with Tabs - reduced padding on mobile
            html += '<div class="bg-white rounded-2xl shadow-xl p-3 sm:p-6 fade-in">';

            // Tabs
            html += '<div class="tabs-container">';
            html += '<button onclick="app.setResultsTab(\'titles\')" class="tab-btn ' + (tab === 'titles' ? 'active' : '') + '"> Titles</button>';
            html += '<button onclick="app.setResultsTab(\'description\')" class="tab-btn ' + (tab === 'description' ? 'active' : '') + '"> Description</button>';
            html += '<button onclick="app.setResultsTab(\'tags\')" class="tab-btn ' + (tab === 'tags' ? 'active' : '') + '"> Tags</button>';
            html += '</div>';

            // Tab Content
            html += '<div class="tab-content">';

            if (tab === 'titles') {
                // Titles Tab
                if (r.titles && r.titles.length > 0) {
                    html += '<div class="space-y-3">';
                    var titleLabels = [' Clickbait Style', ' SEO Optimized', ' Question Format'];
                    for (var i = 0; i < r.titles.length; i++) {
                        var titleId = 'title-' + i;
                        var escapedTitle = utils.escapeJs(r.titles[i]);
                        html += '<div class="p-4 bg-gradient-to-r from-gray-50 to-white rounded-xl border-2 border-gray-100 hover:border-purple-300 transition-all">';
                        html += '<p class="text-xs text-purple-600 font-semibold mb-1">' + (titleLabels[i] || 'Title ' + (i+1)) + '</p>';
                        html += '<div class="flex justify-between items-start gap-3">';
                        html += '<p class="flex-1 text-lg font-medium text-gray-800">' + utils.escapeHtml(r.titles[i]) + '</p>';
                        html += '<button id="' + titleId + '-btn" onclick="app.copyToClipboard(\'' + escapedTitle + '\', \'' + titleId + '-btn\')" class="px-4 py-2 bg-purple-500 text-white text-sm rounded-lg hover:bg-purple-600 whitespace-nowrap transition-all"> Copy</button>';
                        html += '</div></div>';
                    }
                    html += '</div>';
                } else {
                    html += '<p class="text-gray-500 text-center py-8">No titles generated</p>';
                }
            } else if (tab === 'description') {
                // Description Tab
                if (r.description) {
                    var escapedDesc = utils.escapeJs(r.description);
                    html += '<div class="relative">';
                    html += '<div class="p-4 bg-gray-50 rounded-xl border-2 border-gray-200 max-h-96 overflow-y-auto">';
                    html += '<pre class="text-gray-800 whitespace-pre-wrap font-sans text-sm leading-relaxed">' + utils.escapeHtml(r.description) + '</pre>';
                    html += '</div>';
                    html += '<button id="desc-btn" onclick="app.copyToClipboard(\'' + escapedDesc + '\', \'desc-btn\')" class="mt-4 w-full py-3 bg-purple-500 text-white font-semibold rounded-lg hover:bg-purple-600 transition-all"> Copy Full Description</button>';
                    html += '</div>';
                } else {
                    html += '<p class="text-gray-500 text-center py-8">No description generated</p>';
                }
            } else if (tab === 'tags') {
                // Tags Tab
                if (r.tags && r.tags.length > 0) {
                    var escapedTags = utils.escapeJs(r.tags.join(', '));
                    html += '<div class="mb-4">';
                    html += '<p class="text-sm text-gray-500 mb-3">' + r.tags.length + ' tags generated</p>';
                    html += '<div class="flex flex-wrap gap-2 max-h-64 overflow-y-auto p-2">';
                    for (var j = 0; j < r.tags.length; j++) {
                        html += '<span class="inline-block px-3 py-1.5 bg-gradient-to-r from-purple-100 to-blue-100 text-purple-700 rounded-full text-sm font-medium hover:from-purple-200 hover:to-blue-200 transition-all cursor-default">' + utils.escapeHtml(r.tags[j]) + '</span>';
                    }
                    html += '</div></div>';
                    html += '<button id="tags-btn" onclick="app.copyToClipboard(\'' + escapedTags + '\', \'tags-btn\')" class="w-full py-3 bg-purple-500 text-white font-semibold rounded-lg hover:bg-purple-600 transition-all"> Copy All Tags</button>';
                } else {
                    html += '<p class="text-gray-500 text-center py-8">No tags generated</p>';
                }
            }

            html += '</div>'; // End tab-content
            html += '</div>'; // End main card

            // Recommendations (if any)
            if (r.seoAnalysis?.recommendations && r.seoAnalysis.recommendations.length > 0) {
                html += '<div class="mt-4 p-4 bg-white/10 rounded-xl fade-in">';
                html += '<p class="text-white font-semibold mb-2"> Tips to improve further:</p>';
                html += '<ul class="text-white/80 text-sm space-y-1">';
                for (var k = 0; k < r.seoAnalysis.recommendations.length; k++) {
                    html += '<li> ' + utils.escapeHtml(r.seoAnalysis.recommendations[k]) + '</li>';
                }
                html += '</ul></div>';
            }

            // Thumbnail Generator CTA
            html += '<div class="mt-6 p-6 bg-gradient-to-r from-pink-500/20 to-purple-500/20 rounded-2xl border border-white/20 fade-in">';
            html += '<div class="flex flex-col sm:flex-row items-center justify-between gap-4">';
            html += '<div class="text-center sm:text-left">';
            html += '<h3 class="text-xl font-bold text-white mb-1"> Create an Eye-Catching Thumbnail</h3>';
            html += '<p class="text-white/70 text-sm">Use AI to generate a professional thumbnail based on your optimized video content</p>';
            html += '</div>';
            html += '<button onclick="app.goToThumbnail(true)" class="whitespace-nowrap px-6 py-3 bg-gradient-to-r from-pink-500 to-purple-600 text-white font-bold rounded-xl hover:from-pink-600 hover:to-purple-700 transition-all shadow-lg hover:shadow-xl transform hover:scale-105">';
            html += ' Generate Thumbnail';
            html += '</button>';
            html += '</div></div>';

            html += '</div></div>';

            return html;
        }

        /* ------------------------------------------
           4.6.7 History View
           ------------------------------------------ */
        function renderHistory() {
            var html = '';
            var counts = state.historyCounts || {};

            // Container
            html += '<div class="min-h-screen mobile-full-screen py-6 px-4 mobile-wide-container">';
            html += '<div class="max-w-6xl mx-auto">';

            // Header
            html += '<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4 fade-in">';
            html += '<h1 class="text-3xl mobile-text-xl font-bold text-white"> Activity History</h1>';
            html += '<button onclick="app.goToDashboard()" class="btn-secondary w-full sm:w-auto"> Back to Dashboard</button>';
            html += '</div>';

            // Success message
            if (state.success) {
                html += '<div class="mb-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg fade-in">';
                html += '<p>' + utils.escapeHtml(state.success) + '</p>';
                html += '</div>';
            }

            // Loading state
            if (state.loading) {
                html += '<div class="text-center py-12">';
                html += '<div class="spinner mx-auto mb-4"></div>';
                html += '<p class="text-white">Loading history...</p>';
                html += '</div>';
            }
            // Error state
            else if (state.error) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-8 mobile-padding text-center">';
                html += '<p class="text-red-600 font-semibold"> ' + utils.escapeHtml(state.error) + '</p>';
                html += '<button onclick="app.goToHistory()" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Try Again</button>';
                html += '</div>';
            }
            else {
                // Tab Navigation - Horizontally scrollable for mobile
                html += '<div class="bg-white rounded-xl shadow-lg mb-6 fade-in overflow-hidden">';
                html += '<div class="history-tabs-container flex flex-nowrap overflow-x-auto border-b border-gray-200 scrollbar-hide">';

                var tabs = [
                    { id: 'all', label: 'All', icon: '', count: (counts.optimizations || 0) + (counts.competitor || 0) + (counts.trends || 0) + (counts.thumbnails || 0) + (counts.placements || 0) + (counts.channelAudit || 0) },
                    { id: 'optimization', label: 'Video', icon: '', count: counts.optimizations || 0 },
                    { id: 'competitor', label: 'Competitor', icon: '', count: counts.competitor || 0 },
                    { id: 'trend', label: 'Trends', icon: '', count: counts.trends || 0 },
                    { id: 'thumbnail', label: 'Thumbnails', icon: '', count: counts.thumbnails || 0 },
                    { id: 'placement', label: 'Placements', icon: '', count: counts.placements || 0 },
                    { id: 'channelAudit', label: 'Audit', icon: '', count: counts.channelAudit || 0 }
                ];

                for (var t = 0; t < tabs.length; t++) {
                    var tab = tabs[t];
                    var isActive = state.historyTab === tab.id;
                    var tabClass = isActive
                        ? 'border-b-2 border-blue-500 text-blue-600 bg-blue-50'
                        : 'text-gray-600 hover:text-gray-800 hover:bg-gray-50';
                    html += '<button onclick="app.setHistoryTab(\'' + tab.id + '\')" class="history-tab-btn flex-shrink-0 whitespace-nowrap px-4 py-3 text-sm font-medium ' + tabClass + ' transition-colors">';
                    html += '<span class="hidden sm:inline">' + tab.icon + ' </span>' + tab.label;
                    if (tab.count > 0) {
                        html += ' <span class="inline-flex items-center justify-center px-2 py-0.5 text-xs font-bold rounded-full ' + (isActive ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700') + '">' + tab.count + '</span>';
                    }
                    html += '</button>';
                }
                html += '</div></div>';

                // Get items based on current tab
                var items = [];
                var itemType = state.historyTab;

                if (state.historyTab === 'all') {
                    items = state.allHistory || [];
                } else if (state.historyTab === 'optimization') {
                    items = state.historyData || [];
                } else if (state.historyTab === 'competitor') {
                    items = state.competitorHistory || [];
                } else if (state.historyTab === 'trend') {
                    items = state.trendHistory || [];
                } else if (state.historyTab === 'thumbnail') {
                    items = state.thumbnailHistory || [];
                } else if (state.historyTab === 'placement') {
                    items = state.placementHistory || [];
                } else if (state.historyTab === 'channelAudit') {
                    items = state.channelAuditHistory || [];
                }

                // Empty state for current tab
                if (!items || items.length === 0) {
                    html += '<div class="bg-white rounded-2xl shadow-xl p-12 mobile-padding text-center fade-in">';
                    html += '<div class="text-6xl mb-4"></div>';
                    html += '<h2 class="text-2xl mobile-text-lg font-bold text-gray-800 mb-2">No History Yet</h2>';
                    html += '<p class="text-gray-600 mb-6">Start using tools to see your history here!</p>';
                    html += '<button onclick="app.goToDashboard()" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold rounded-lg hover:from-blue-700 hover:to-purple-700"> Go to Dashboard</button>';
                    html += '</div>';
                }
                // History list
                else {
                    html += '<div class="space-y-4 fade-in">';

                    for (var i = 0; i < items.length; i++) {
                        var item = items[i];
                        var type = state.historyTab === 'all' ? item.type : state.historyTab;
                        var timestamp = item.timestamp || item.createdAt;
                        var dateInfo = utils.formatDate(timestamp);

                        html += '<div class="bg-white rounded-xl shadow-lg p-6 mobile-padding hover:shadow-xl transition-all">';
                        html += '<div class="flex flex-col sm:flex-row justify-between items-start gap-4">';

                        // Type badge
                        var typeBadge = '';
                        var typeIcon = '';
                        var typeColor = '';
                        switch(type) {
                            case 'optimization':
                                typeIcon = '';
                                typeBadge = 'Video Optimization';
                                typeColor = 'bg-blue-100 text-blue-800';
                                break;
                            case 'competitor':
                                typeIcon = '';
                                typeBadge = 'Competitor Analysis';
                                typeColor = 'bg-purple-100 text-purple-800';
                                break;
                            case 'trend':
                                typeIcon = '';
                                typeBadge = 'Trend Prediction';
                                typeColor = 'bg-green-100 text-green-800';
                                break;
                            case 'thumbnail':
                                typeIcon = '';
                                typeBadge = 'Thumbnail';
                                typeColor = 'bg-orange-100 text-orange-800';
                                break;
                            case 'placement':
                                typeIcon = '';
                                typeBadge = 'Placement Finder';
                                typeColor = 'bg-violet-100 text-violet-800';
                                break;
                            case 'channelAudit':
                                typeIcon = '';
                                typeBadge = 'Channel Audit';
                                typeColor = 'bg-teal-100 text-teal-800';
                                break;
                        }

                        // Info section
                        html += '<div class="flex-1">';

                        // Type badge (only show in "all" tab)
                        if (state.historyTab === 'all') {
                            html += '<span class="inline-block px-2 py-1 text-xs font-semibold rounded-full ' + typeColor + ' mb-2">' + typeIcon + ' ' + typeBadge + '</span>';
                        }

                        // Title based on type
                        var title = '';
                        var subtitle = '';
                        switch(type) {
                            case 'optimization':
                                title = (item.videoInfo && item.videoInfo.title) ? item.videoInfo.title : 'Video Optimization';
                                if (item.titles && item.titles.length > 0) {
                                    subtitle = '<strong>Best Title:</strong> ' + utils.escapeHtml(item.titles[0]);
                                }
                                break;
                            case 'competitor':
                                title = (item.competitor && item.competitor.title) ? item.competitor.title : 'Competitor Analysis';
                                if (item.competitor && item.competitor.channelTitle) {
                                    subtitle = '<strong>Channel:</strong> ' + utils.escapeHtml(item.competitor.channelTitle);
                                }
                                break;
                            case 'trend':
                                title = item.niche ? 'Trends: ' + item.niche : 'Trend Analysis';
                                subtitle = '<strong>Country:</strong> ' + (item.country || 'US') + ' | <strong>Videos Analyzed:</strong> ' + (item.analyzedVideos || 0);
                                break;
                            case 'thumbnail':
                                title = item.title || 'AI Thumbnail';
                                subtitle = '<strong>Style:</strong> ' + (item.style || 'Default');
                                break;
                            case 'placement':
                                title = (item.channelInfo && item.channelInfo.name) ? item.channelInfo.name : 'Placement Search';
                                subtitle = '<strong>Channels Found:</strong> ' + (item.totalFound || 0) + ' | <strong>Niche:</strong> ' + ((item.analysis && item.analysis.niche) || 'N/A');
                                break;
                            case 'channelAudit':
                                title = (item.channelInfo && item.channelInfo.name) ? item.channelInfo.name : 'Channel Audit';
                                var overallScore = (item.scores && item.scores.overall) || 0;
                                subtitle = '<strong>Overall Score:</strong> ' + overallScore + '/100 | <strong>Subscribers:</strong> ' + utils.formatNumber((item.channelInfo && item.channelInfo.subscribers) || 0);
                                break;
                        }

                        html += '<h3 class="font-bold text-lg text-gray-800 mb-2">' + utils.escapeHtml(title) + '</h3>';
                        html += '<div class="flex flex-wrap gap-4 text-sm text-gray-600 mb-2">';
                        html += '<span> ' + dateInfo.date + '</span>';
                        html += '<span> ' + dateInfo.time + '</span>';
                        html += '</div>';

                        if (subtitle) {
                            html += '<p class="text-sm text-gray-700">' + subtitle + '</p>';
                        }

                        // Show thumbnail preview for thumbnail items
                        if (type === 'thumbnail' && item.imageUrl) {
                            html += '<div class="mt-3"><img src="' + utils.escapeHtml(item.imageUrl) + '" alt="Thumbnail" class="h-20 rounded-lg shadow-sm"></div>';
                        }

                        html += '</div>';

                        // Action buttons
                        html += '<div class="flex gap-2 flex-shrink-0">';

                        // View button based on type
                        switch(type) {
                            case 'optimization':
                                html += '<button onclick="app.viewHistoryItem(' + (state.historyTab === 'all' ? 'null, \'' + item.id + '\'' : i) + ')" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 whitespace-nowrap text-sm"> View</button>';
                                break;
                            case 'competitor':
                                html += '<button onclick="app.viewCompetitorHistory(' + (state.historyTab === 'all' ? 'null, \'' + item.id + '\'' : i) + ')" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 whitespace-nowrap text-sm"> View</button>';
                                break;
                            case 'trend':
                                html += '<button onclick="app.viewTrendHistory(' + (state.historyTab === 'all' ? 'null, \'' + item.id + '\'' : i) + ')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 whitespace-nowrap text-sm"> View</button>';
                                break;
                            case 'thumbnail':
                                html += '<button onclick="app.viewThumbnailHistory(' + (state.historyTab === 'all' ? 'null, \'' + item.id + '\'' : i) + ')" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 whitespace-nowrap text-sm"> View</button>';
                                break;
                            case 'placement':
                                html += '<button onclick="app.viewPlacementHistory(\'' + item.id + '\')" class="px-4 py-2 bg-violet-500 text-white rounded-lg hover:bg-violet-600 whitespace-nowrap text-sm"> View</button>';
                                break;
                            case 'channelAudit':
                                html += '<button onclick="app.viewChannelAuditHistory(\'' + item.id + '\')" class="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 whitespace-nowrap text-sm"> View</button>';
                                break;
                        }

                        // Delete button
                        html += '<button onclick="app.deleteHistoryItem(\'' + type + '\', \'' + item.id + '\', ' + i + ')" class="px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 whitespace-nowrap text-sm"></button>';

                        html += '</div>';

                        html += '</div></div>';
                    }

                    html += '</div>';
                }
            }

            html += '</div></div>';

            return html;
        }

        /* ------------------------------------------
           4.6.8 Admin Dashboard View
           ------------------------------------------ */
        function renderAdmin() {
            var html = '';

            // Container
            html += '<div class="min-h-screen mobile-full-screen py-6 px-4 mobile-wide-container">';
            html += '<div class="max-w-6xl mx-auto">';

            // Header
            html += '<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4 fade-in">';
            html += '<h1 class="text-3xl mobile-text-xl font-bold text-white"> Admin Dashboard</h1>';
            html += '<button onclick="app.goToDashboard()" class="btn-secondary w-full sm:w-auto"> Back to Dashboard</button>';
            html += '</div>';

            // Success message
            if (state.success) {
                html += '<div class="mb-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg fade-in">';
                html += '<p>' + utils.escapeHtml(state.success) + '</p>';
                html += '</div>';
            }

            // Error message
            if (state.error) {
                var errorMsg = typeof state.error === 'string' ? state.error : state.error.message;
                html += '<div class="mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg fade-in">';
                html += '<p>' + utils.escapeHtml(errorMsg) + '</p>';
                html += '</div>';
            }

            // Stats Cards
            html += '<div class="grid grid-cols-1 sm:grid-cols-3 gap-5 mb-8 fade-in">';
            var totalUsers = state.adminUsers ? state.adminUsers.length : 0;
            var proUsers = state.adminUsers ? state.adminUsers.filter(function(u) { return u.subscription && u.subscription.plan === 'pro'; }).length : 0;
            var freeUsers = state.adminUsers ? state.adminUsers.filter(function(u) { return !u.subscription || u.subscription.plan === 'free'; }).length : 0;

            html += '<div class="bg-white rounded-2xl p-8 text-center shadow-lg border border-gray-100">';
            html += '<div class="text-5xl mb-3"></div>';
            html += '<p class="text-5xl font-bold text-gray-800 mb-2">' + totalUsers + '</p>';
            html += '<p class="text-gray-600 font-medium text-lg">Total Users</p>';
            html += '</div>';

            html += '<div class="bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl p-8 text-center shadow-lg">';
            html += '<div class="text-5xl mb-3"></div>';
            html += '<p class="text-5xl font-bold text-white mb-2">' + proUsers + '</p>';
            html += '<p class="text-white/90 font-medium text-lg">Pro Users</p>';
            html += '</div>';

            html += '<div class="bg-white rounded-2xl p-8 text-center shadow-lg border border-gray-100">';
            html += '<div class="text-5xl mb-3"></div>';
            html += '<p class="text-5xl font-bold text-gray-500 mb-2">' + freeUsers + '</p>';
            html += '<p class="text-gray-600 font-medium text-lg">Free Users</p>';
            html += '</div>';
            html += '</div>';

            // Users Table
            html += '<div class="bg-white rounded-2xl shadow-xl p-8 mobile-padding fade-in">';
            html += '<h2 class="text-2xl font-bold text-gray-800 mb-6"> User Management</h2>';

            if (state.adminLoading) {
                html += '<div class="text-center py-8">';
                html += '<div class="spinner spinner-dark mx-auto mb-4"></div>';
                html += '<p class="text-gray-600">Loading users...</p>';
                html += '</div>';
            } else if (!state.adminUsers || state.adminUsers.length === 0) {
                html += '<p class="text-gray-500 text-center py-8">No users found</p>';
            } else {
                html += '<div class="overflow-x-auto">';
                html += '<table class="w-full text-left">';
                html += '<thead class="bg-gray-50 rounded-lg">';
                html += '<tr>';
                html += '<th class="px-6 py-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">User</th>';
                html += '<th class="px-6 py-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Plan</th>';
                html += '<th class="px-6 py-4 text-sm font-semibold text-gray-600 uppercase tracking-wider hidden sm:table-cell">Usage</th>';
                html += '<th class="px-6 py-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Actions</th>';
                html += '</tr></thead>';
                html += '<tbody class="divide-y divide-gray-100">';

                for (var i = 0; i < state.adminUsers.length; i++) {
                    var user = state.adminUsers[i];
                    var plan = user.subscription ? user.subscription.plan : 'free';
                    var planColor = plan === 'pro' ? 'bg-purple-100 text-purple-800' : plan === 'lite' ? 'bg-blue-100 text-blue-800' : plan === 'enterprise' ? 'bg-amber-100 text-amber-800' : 'bg-gray-100 text-gray-800';

                    // Calculate total limit including bonus uses
                    var baseLimit = user.usage && user.usage.warpOptimizer ? user.usage.warpOptimizer.limit : 0;
                    var bonusUses = user.bonusUses && user.bonusUses.warpOptimizer ? user.bonusUses.warpOptimizer : 0;
                    var totalLimit = baseLimit + bonusUses;
                    var usedToday = user.usage && user.usage.warpOptimizer ? user.usage.warpOptimizer.usedToday : 0;
                    var usageInfo = usedToday + '/' + totalLimit;
                    var bonusIndicator = bonusUses > 0 ? ' <span class="text-green-600 text-xs">(+' + bonusUses + ')</span>' : '';

                    html += '<tr class="hover:bg-gray-50 transition-colors">';
                    html += '<td class="px-6 py-5">';
                    html += '<p class="font-semibold text-gray-800 text-base">' + utils.escapeHtml(user.email || 'No email') + '</p>';
                    html += '<p class="text-sm text-gray-500 mt-1">ID: ' + utils.escapeHtml(user.uid ? user.uid.substring(0, 12) + '...' : '') + '</p>';
                    html += '</td>';
                    html += '<td class="px-6 py-5">';
                    html += '<span class="px-3 py-1.5 text-sm font-semibold rounded-full ' + planColor + '">' + plan.toUpperCase() + '</span>';
                    html += '</td>';
                    html += '<td class="px-6 py-5 hidden sm:table-cell">';
                    html += '<span class="text-base text-gray-700 font-medium">' + usageInfo + '</span>' + bonusIndicator;
                    html += '<span class="text-sm text-gray-500 ml-1">today</span>';
                    html += '</td>';
                    html += '<td class="px-6 py-5">';
                    html += '<select onchange="app.updateUserPlan(\'' + user.uid + '\', this.value)" class="text-base border-2 border-gray-200 rounded-lg px-3 py-2 focus:border-purple-500 focus:outline-none transition-colors">';
                    html += '<option value="free"' + (plan === 'free' ? ' selected' : '') + '>Free</option>';
                    html += '<option value="lite"' + (plan === 'lite' ? ' selected' : '') + '>Lite</option>';
                    html += '<option value="pro"' + (plan === 'pro' ? ' selected' : '') + '>Pro</option>';
                    html += '<option value="enterprise"' + (plan === 'enterprise' ? ' selected' : '') + '>Enterprise</option>';
                    html += '</select>';
                    html += '</td>';
                    html += '</tr>';
                }

                html += '</tbody></table></div>';
            }

            html += '</div>';

            // Quota Settings Section
            html += '<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">';

            // Reset Time Settings
            html += '<div class="bg-white rounded-2xl shadow-xl p-8 mobile-padding fade-in">';
            html += '<h2 class="text-2xl font-bold text-gray-800 mb-4"> Quota Reset Time</h2>';
            html += '<p class="text-gray-600 mb-6">Set how often user quotas reset (in minutes). Default is 1440 minutes (24 hours).</p>';
            html += '<div class="flex gap-4 items-end">';
            html += '<div class="flex-1">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Reset Interval (minutes)</label>';
            html += '<input type="number" id="reset-time-input" value="' + (state.resetTimeMinutes || 1440) + '" min="1" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-lg" />';
            html += '<p class="text-sm text-gray-500 mt-2">Examples: 60 = 1 hour, 240 = 4 hours, 1440 = 24 hours</p>';
            html += '</div>';
            html += '<button onclick="app.setQuotaResetTime()" class="px-6 py-3 bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold rounded-xl hover:from-purple-600 hover:to-indigo-700 transition-all">Save</button>';
            html += '</div>';
            html += '</div>';

            // Grant Bonus Uses
            html += '<div class="bg-white rounded-2xl shadow-xl p-8 mobile-padding fade-in">';
            html += '<h2 class="text-2xl font-bold text-gray-800 mb-4"> Grant Bonus Uses</h2>';
            html += '<p class="text-gray-600 mb-6">Give extra uses to a specific user as a gift or bonus.</p>';

            // User selector
            html += '<div class="mb-4">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Select User</label>';
            html += '<select id="bonus-user-select" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-lg">';
            html += '<option value="">-- Select a user --</option>';
            if (state.adminUsers) {
                for (var j = 0; j < state.adminUsers.length; j++) {
                    var u = state.adminUsers[j];
                    html += '<option value="' + u.uid + '">' + utils.escapeHtml(u.email || u.uid) + '</option>';
                }
            }
            html += '</select>';
            html += '</div>';

            // Tool selector
            html += '<div class="mb-4">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Select Tool</label>';
            html += '<select id="bonus-tool-select" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-lg">';
            html += '<option value="warpOptimizer">Warp Optimizer</option>';
            html += '<option value="competitorAnalysis">Competitor Analysis</option>';
            html += '<option value="trendPredictor">Trend Predictor</option>';
            html += '<option value="thumbnailGenerator">AI Thumbnails</option>';
            html += '<option value="placementFinder">Placement Finder</option>';
            html += '</select>';
            html += '</div>';

            // Amount
            html += '<div class="mb-4">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Bonus Amount</label>';
            html += '<input type="number" id="bonus-amount-input" value="5" min="1" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-lg" />';
            html += '</div>';

            html += '<button onclick="app.grantBonusUses()" class="w-full px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold rounded-xl hover:from-green-600 hover:to-emerald-700 transition-all"> Grant Bonus Uses</button>';
            html += '</div>';

            html += '</div>'; // End grid

            html += '</div></div>';

            return html;
        }

        /* ------------------------------------------
           4.6.9 Competitor Analysis View
           ------------------------------------------ */
        function renderCompetitor() {
            var html = '';

            html += '<div class="min-h-screen mobile-full-screen py-12 px-4 mobile-wide-container">';
            html += '<div class="max-w-4xl mx-auto">';

            // Navigation buttons
            html += '<div class="flex flex-wrap gap-3 mb-6">';
            html += '<button onclick="app.goToDashboard()" class="px-6 py-3 bg-white/20 text-white rounded-xl hover:bg-white/30"> Back</button>';
            html += '<button onclick="app.goToHistory(\'competitor\')" class="px-6 py-3 bg-white/20 text-white rounded-xl hover:bg-white/30"> View History</button>';
            html += '</div>';

            // Form Card
            if (!state.competitorResults) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-8 mobile-padding fade-in">';
                html += '<h2 class="text-3xl mobile-text-xl font-bold text-gray-800 mb-4"> Competitor Analysis</h2>';

                // Feature Description Section - Collapsible on mobile
                html += '<div class="mb-6">';
                html += '<div class="bg-gradient-to-r from-red-50 via-orange-50 to-amber-50 rounded-xl overflow-hidden border border-red-100">';

                // Collapsible header - VISIBLE ON ALL SCREENS
                html += '<button type="button" onclick="this.parentElement.classList.toggle(\'expanded\'); this.querySelector(\'.chevron\').classList.toggle(\'rotate-180\')" class="w-full p-4 flex items-center justify-between text-left">';
                html += '<span class="flex items-center gap-2 font-semibold text-gray-800"><span class="text-lg"></span> How does this help?</span>';
                html += '<svg class="chevron w-5 h-5 text-gray-500 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>';
                html += '</button>';

                // Content area - CSS handles visibility
                html += '<div class="feature-info-content">';
                html += '<p class="text-gray-700 mb-3 leading-relaxed">Reverse-engineer the success of any YouTube video. Our AI analyzes competitor content to reveal their SEO strategies, strengths, and weaknesses  giving you the blueprint to outperform them.</p>';
                html += '<div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">';
                html += '<div class="flex items-start gap-2"><span class="text-red-500 mt-0.5"></span><span class="text-gray-600"><strong>SEO Breakdown</strong>  Competitor\'s optimization score</span></div>';
                html += '<div class="flex items-start gap-2"><span class="text-red-500 mt-0.5"></span><span class="text-gray-600"><strong>Strengths Analysis</strong>  What they\'re doing right</span></div>';
                html += '<div class="flex items-start gap-2"><span class="text-red-500 mt-0.5"></span><span class="text-gray-600"><strong>Weaknesses Found</strong>  Gaps you can exploit</span></div>';
                html += '<div class="flex items-start gap-2"><span class="text-red-500 mt-0.5"></span><span class="text-gray-600"><strong>Better Titles</strong>  Outrank them with superior titles</span></div>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
                html += '</div>';

                if (state.error) {
                    html += '<div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-xl text-red-700">' + utils.escapeHtml(state.error.message) + '</div>';
                }

                html += '<form onsubmit="app.analyzeCompetitor(event)">';
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-2">Competitor Video URL</label>';
                html += '<input type="text" id="competitor-url" placeholder="https://www.youtube.com/watch?v=..." class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" required />';
                html += '</div>';
                html += '<button type="submit" class="btn-primary" ' + (state.loading ? 'disabled' : '') + '>';
                html += state.loading ? ' Analyzing...' : ' Analyze Competitor';
                html += '</button>';
                html += '</form>';

                // Loading Animation
                if (state.loading) {
                    html += '<div class="mt-8 loading-container">';
                    html += '<div class="flex items-center justify-between mb-6">';
                    html += '<div class="flex items-center gap-4"><div class="loading-emoji"></div><div><h3 class="text-xl font-bold text-gray-800">Analyzing Competitor</h3></div></div>';
                    html += '<div class="progress-percentage">' + Math.round(state.loadingProgress) + '%</div>';
                    html += '</div>';
                    html += '<div class="progress-bar-container mb-4"><div class="progress-bar-fill" style="width:' + state.loadingProgress + '%"></div></div>';
                    html += '</div>';
                }

                html += '</div>';
            } else {
                // Results Display
                var r = state.competitorResults;
                var c = r.competitor;
                var a = r.analysis;

                // Competitor Info Card
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 mb-6 fade-in">';
                html += '<div class="flex flex-col md:flex-row gap-6">';
                if (c.thumbnail) {
                    html += '<img src="' + utils.escapeHtml(c.thumbnail) + '" class="w-full md:w-64 h-36 object-cover rounded-xl" />';
                }
                html += '<div class="flex-1">';
                html += '<h2 class="text-xl font-bold text-gray-800 mb-2">' + utils.escapeHtml(c.title) + '</h2>';
                html += '<p class="text-gray-600 mb-3">' + utils.escapeHtml(c.channelTitle) + '</p>';
                html += '<div class="flex flex-wrap gap-4 text-sm">';
                html += '<span class="bg-gray-100 px-3 py-1 rounded-full"> ' + utils.formatNumber(c.viewCount) + ' views</span>';
                html += '<span class="bg-gray-100 px-3 py-1 rounded-full"> ' + utils.formatNumber(c.likeCount) + ' likes</span>';
                html += '<span class="bg-gray-100 px-3 py-1 rounded-full"> ' + utils.formatNumber(c.commentCount) + ' comments</span>';
                html += '</div></div></div></div>';

                // SEO Score & Difficulty
                html += '<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 fade-in">';
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 text-center">';
                html += '<p class="text-5xl font-bold ' + (a.seoScore >= 70 ? 'text-green-500' : a.seoScore >= 50 ? 'text-yellow-500' : 'text-red-500') + '">' + a.seoScore + '</p>';
                html += '<p class="text-gray-600 font-medium">Competitor SEO Score</p>';
                html += '</div>';
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 text-center">';
                var diffColor = a.estimatedDifficulty === 'easy' ? 'text-green-500' : a.estimatedDifficulty === 'medium' ? 'text-yellow-500' : 'text-red-500';
                html += '<p class="text-4xl font-bold ' + diffColor + '">' + (a.estimatedDifficulty || 'medium').toUpperCase() + '</p>';
                html += '<p class="text-gray-600 font-medium">Difficulty to Beat</p>';
                html += '</div>';
                html += '<div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl shadow-xl p-6 text-center text-white">';
                html += '<p class="text-4xl font-bold"></p>';
                html += '<p class="font-medium">Ready to Beat!</p>';
                html += '</div></div>';

                // Analysis Sections
                html += '<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 fade-in">';

                // Strengths
                html += '<div class="bg-white rounded-2xl shadow-xl p-6">';
                html += '<h3 class="text-xl font-bold text-gray-800 mb-4"> Their Strengths</h3>';
                html += '<ul class="space-y-2">';
                (a.strengths || []).forEach(function(s) { html += '<li class="flex items-start gap-2"><span class="text-green-500"></span><span>' + utils.escapeHtml(s) + '</span></li>'; });
                html += '</ul></div>';

                // Weaknesses
                html += '<div class="bg-white rounded-2xl shadow-xl p-6">';
                html += '<h3 class="text-xl font-bold text-gray-800 mb-4"> Their Weaknesses</h3>';
                html += '<ul class="space-y-2">';
                (a.weaknesses || []).forEach(function(w) { html += '<li class="flex items-start gap-2"><span class="text-red-500"></span><span>' + utils.escapeHtml(w) + '</span></li>'; });
                html += '</ul></div>';

                // Better Titles
                html += '<div class="bg-white rounded-2xl shadow-xl p-6">';
                html += '<h3 class="text-xl font-bold text-gray-800 mb-4"> Better Titles to Use</h3>';
                html += '<ul class="space-y-2">';
                (a.betterTitles || []).forEach(function(t) { html += '<li class="p-3 bg-blue-50 rounded-lg text-blue-800 font-medium">' + utils.escapeHtml(t) + '</li>'; });
                html += '</ul></div>';

                // Opportunities
                html += '<div class="bg-white rounded-2xl shadow-xl p-6">';
                html += '<h3 class="text-xl font-bold text-gray-800 mb-4"> Opportunities</h3>';
                html += '<ul class="space-y-2">';
                (a.opportunities || []).forEach(function(o) { html += '<li class="flex items-start gap-2"><span class="text-purple-500"></span><span>' + utils.escapeHtml(o) + '</span></li>'; });
                html += '</ul></div>';
                html += '</div>';

                // Summary
                html += '<div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl shadow-xl p-6 mt-6 fade-in">';
                html += '<h3 class="text-xl font-bold text-white mb-3"> Strategy Summary</h3>';
                html += '<p class="text-white/90 text-lg">' + utils.escapeHtml(a.summary || '') + '</p>';
                html += '</div>';

                // New Analysis Button
                html += '<div class="text-center mt-8">';
                html += '<button onclick="state.competitorResults=null;render();" class="btn-secondary">Analyze Another Competitor</button>';
                html += '</div>';
            }

            html += '</div></div>';
            return html;
        }

        /* ------------------------------------------
           4.6.10 Trend Predictor View
           ------------------------------------------ */
        function renderTrends() {
            var html = '';

            html += '<div class="min-h-screen mobile-full-screen py-12 px-4 mobile-wide-container">';
            html += '<div class="max-w-4xl mx-auto">';

            // Navigation buttons
            html += '<div class="flex flex-wrap gap-3 mb-6">';
            html += '<button onclick="app.goToDashboard()" class="px-6 py-3 bg-white/20 text-white rounded-xl hover:bg-white/30"> Back</button>';
            html += '<button onclick="app.goToHistory(\'trend\')" class="px-6 py-3 bg-white/20 text-white rounded-xl hover:bg-white/30"> View History</button>';
            html += '</div>';

            if (!state.trendResults) {
                // Card
                html += '<div class="bg-white rounded-2xl shadow-xl p-8 mobile-padding fade-in">';
                html += '<h2 class="text-3xl mobile-text-xl font-bold text-gray-800 mb-4"> Trend Predictor</h2>';

                // Feature Description Section - Collapsible on mobile
                html += '<div class="mb-6">';
                html += '<div class="bg-gradient-to-r from-cyan-50 via-blue-50 to-indigo-50 rounded-xl overflow-hidden border border-cyan-100">';

                // Collapsible header - VISIBLE ON ALL SCREENS
                html += '<button type="button" onclick="this.parentElement.classList.toggle(\'expanded\'); this.querySelector(\'.chevron\').classList.toggle(\'rotate-180\')" class="w-full p-4 flex items-center justify-between text-left">';
                html += '<span class="flex items-center gap-2 font-semibold text-gray-800"><span class="text-lg"></span> What will you discover?</span>';
                html += '<svg class="chevron w-5 h-5 text-gray-500 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>';
                html += '</button>';

                // Content area - CSS handles visibility
                html += '<div class="feature-info-content">';
                html += '<p class="text-gray-700 mb-3 leading-relaxed">Stay ahead of the curve with AI-powered trend forecasting. Discover what\'s hot right now and predict future viral topics in your niche before your competitors catch on.</p>';
                html += '<div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">';
                html += '<div class="flex items-start gap-2"><span class="text-cyan-500 mt-0.5"></span><span class="text-gray-600"><strong>Current Trends</strong>  What\'s trending now in your niche</span></div>';
                html += '<div class="flex items-start gap-2"><span class="text-cyan-500 mt-0.5"></span><span class="text-gray-600"><strong>Future Predictions</strong>  Topics about to explode</span></div>';
                html += '<div class="flex items-start gap-2"><span class="text-cyan-500 mt-0.5"></span><span class="text-gray-600"><strong>Video Ideas</strong>  Ready-to-use content concepts</span></div>';
                html += '<div class="flex items-start gap-2"><span class="text-cyan-500 mt-0.5"></span><span class="text-gray-600"><strong>Trending Hashtags</strong>  Boost your discoverability</span></div>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
                html += '</div>';

                if (state.error) {
                    html += '<div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-xl text-red-700">' + utils.escapeHtml(state.error.message) + '</div>';
                }

                html += '<form onsubmit="app.predictTrends(event)">';
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-2">Your Niche / Topic</label>';
                html += '<input type="text" id="trend-niche" placeholder="e.g., Gaming, Cooking, Tech Reviews..." class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" required />';
                html += '</div>';
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-2">Country/Region</label>';
                html += '<select id="trend-country" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">';
                html += '<option value="US">United States</option><option value="GB">United Kingdom</option><option value="CA">Canada</option>';
                html += '<option value="AU">Australia</option><option value="DE">Germany</option><option value="FR">France</option>';
                html += '<option value="IN">India</option><option value="BR">Brazil</option><option value="JP">Japan</option>';
                html += '</select></div>';
                html += '<button type="submit" class="btn-primary" ' + (state.loading ? 'disabled' : '') + '>';
                html += state.loading ? ' Predicting...' : ' Predict Trends';
                html += '</button>';
                html += '</form>';

                if (state.loading) {
                    html += '<div class="mt-8 loading-container">';
                    html += '<div class="flex items-center justify-between mb-6">';
                    html += '<div class="flex items-center gap-4"><div class="loading-emoji"></div><div><h3 class="text-xl font-bold text-gray-800">Predicting Trends</h3></div></div>';
                    html += '<div class="progress-percentage">' + Math.round(state.loadingProgress) + '%</div>';
                    html += '</div>';
                    html += '<div class="progress-bar-container mb-4"><div class="progress-bar-fill" style="width:' + state.loadingProgress + '%"></div></div>';
                    html += '</div>';
                }

                html += '</div>';
            } else {
                var r = state.trendResults;
                var p = r.predictions;

                // Current Trends
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 mb-6 fade-in">';
                html += '<h3 class="text-2xl font-bold text-gray-800 mb-4"> Current Trends in "' + utils.escapeHtml(r.niche) + '"</h3>';
                html += '<div class="grid grid-cols-1 md:grid-cols-3 gap-4">';
                (p.currentTrends || []).forEach(function(t) {
                    var gColor = t.growthRate === 'rising' ? 'text-green-500' : t.growthRate === 'stable' ? 'text-yellow-500' : 'text-red-500';
                    html += '<div class="p-4 bg-gray-50 rounded-xl">';
                    html += '<div class="flex items-center justify-between mb-2">';
                    html += '<span class="font-bold text-gray-800">' + utils.escapeHtml(t.topic) + '</span>';
                    html += '<span class="' + gColor + ' font-medium">' + (t.growthRate === 'rising' ? '' : t.growthRate === 'declining' ? '' : '') + '</span>';
                    html += '</div>';
                    html += '<p class="text-sm text-gray-600">' + utils.escapeHtml(t.description) + '</p>';
                    html += '</div>';
                });
                html += '</div></div>';

                // Predicted Trends
                html += '<div class="bg-gradient-to-br from-purple-600 to-indigo-600 rounded-2xl shadow-xl p-6 mb-6 fade-in">';
                html += '<h3 class="text-2xl font-bold text-white mb-4"> Predicted Future Trends</h3>';
                html += '<div class="grid grid-cols-1 md:grid-cols-3 gap-4">';
                (p.predictedTrends || []).forEach(function(t) {
                    var confBadge = t.confidence === 'high' ? 'bg-green-500' : t.confidence === 'medium' ? 'bg-yellow-500' : 'bg-gray-500';
                    html += '<div class="p-4 bg-white/10 backdrop-blur rounded-xl">';
                    html += '<div class="flex items-center justify-between mb-2">';
                    html += '<span class="font-bold text-white">' + utils.escapeHtml(t.topic) + '</span>';
                    html += '<span class="' + confBadge + ' text-white text-xs px-2 py-1 rounded-full">' + (t.confidence || 'medium') + '</span>';
                    html += '</div>';
                    html += '<p class="text-sm text-white/80 mb-2">' + utils.escapeHtml(t.reasoning) + '</p>';
                    html += '<p class="text-xs text-white/60"> ' + utils.escapeHtml(t.timeframe || '2-4 weeks') + '</p>';
                    html += '</div>';
                });
                html += '</div></div>';

                // Video Ideas
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 mb-6 fade-in">';
                html += '<h3 class="text-2xl font-bold text-gray-800 mb-4"> Video Ideas for You</h3>';
                html += '<div class="space-y-4">';
                (p.videoIdeas || []).forEach(function(v, i) {
                    html += '<div class="p-4 border-2 border-gray-100 rounded-xl hover:border-blue-200 transition-all">';
                    html += '<div class="flex items-start justify-between">';
                    html += '<div><span class="text-2xl mr-3">' + (i+1) + '.</span><span class="font-bold text-gray-800 text-lg">' + utils.escapeHtml(v.title) + '</span></div>';
                    html += '<span class="bg-green-100 text-green-700 text-sm px-3 py-1 rounded-full font-medium">' + utils.escapeHtml(v.estimatedViews || '50K+') + '</span>';
                    html += '</div>';
                    html += '<p class="text-gray-600 mt-2 ml-8">' + utils.escapeHtml(v.description) + '</p>';
                    html += '</div>';
                });
                html += '</div></div>';

                // Hashtags
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 fade-in">';
                html += '<h3 class="text-xl font-bold text-gray-800 mb-4"># Trending Hashtags</h3>';
                html += '<div class="flex flex-wrap gap-2">';
                (p.hashtagsToUse || []).forEach(function(h) {
                    html += '<span class="bg-blue-100 text-blue-700 px-4 py-2 rounded-full font-medium">' + utils.escapeHtml(h) + '</span>';
                });
                html += '</div></div>';

                html += '<div class="text-center mt-8">';
                html += '<button onclick="state.trendResults=null;render();" class="btn-secondary">Predict for Another Niche</button>';
                html += '</div>';
            }

            html += '</div></div>';
            return html;
        }

        /* ------------------------------------------
           4.6.11 Thumbnail Generator Pro View
           Multi-model support with reference images
           ------------------------------------------ */
        function renderThumbnail() {
            var html = '';
            var hasVideoContext = state.lastOptimization && state.thumbnailFromOptimizer;
            var videoInfo = hasVideoContext ? (state.lastOptimization.videoInfo || {}) : {};
            var optimizedTitles = hasVideoContext ? (state.lastOptimization.titles || []) : [];
            var suggestedTitle = optimizedTitles[0] || videoInfo.title || '';

            // Calculate cost
            var modeCosts = { quick: 2, reference: 4, premium: 6 };
            var currentCost = (modeCosts[state.thumbnailMode] || 2) * state.thumbnailVariations;

            html += '<div class="min-h-screen mobile-full-screen py-12 px-4 mobile-wide-container">';
            html += '<div class="max-w-4xl mx-auto">';

            // Navigation buttons with token balance
            html += '<div class="flex flex-wrap items-center justify-between gap-3 mb-6">';
            html += '<div class="flex flex-wrap gap-3">';
            if (hasVideoContext) {
                html += '<button onclick="app.goToResults()" class="px-6 py-3 bg-white/20 text-white rounded-xl hover:bg-white/30"> Back to Results</button>';
            } else {
                html += '<button onclick="app.goToDashboard()" class="px-6 py-3 bg-white/20 text-white rounded-xl hover:bg-white/30"> Back</button>';
            }
            html += '<button onclick="app.goToHistory(\'thumbnail\')" class="px-6 py-3 bg-white/20 text-white rounded-xl hover:bg-white/30"> History</button>';
            html += '</div>';
            // Token Balance Display (Clickable)
            html += '<button onclick="app.showTokenUsageModal()" class="flex items-center gap-2 bg-white/20 backdrop-blur px-4 py-2 rounded-full hover:bg-white/30 transition-all cursor-pointer">';
            html += '<span class="text-2xl"></span>';
            html += '<span class="text-white font-bold">' + state.thumbnailTokenBalance + ' tokens</span>';
            html += '<svg class="w-4 h-4 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>';
            html += '</button>';
            html += '</div>';

            // Token Usage Modal
            if (state.showTokenModal) {
                html += '<div class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4" onclick="app.hideTokenUsageModal()">';
                html += '<div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 relative" onclick="event.stopPropagation()">';
                html += '<button onclick="app.hideTokenUsageModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>';
                html += '<div class="text-center mb-6">';
                html += '<div class="w-16 h-16 bg-gradient-to-br from-amber-400 to-orange-500 rounded-2xl flex items-center justify-center text-3xl mx-auto mb-3 shadow-lg"></div>';
                html += '<h3 class="text-2xl font-bold text-gray-800">Your Creative Tokens</h3>';
                html += '<p class="text-gray-500">Used for AI Thumbnails & Creative Studio</p>';
                html += '</div>';

                // Token Stats
                html += '<div class="bg-gray-50 rounded-xl p-4 mb-4">';
                html += '<div class="flex justify-between items-center mb-3">';
                html += '<span class="text-gray-600">Current Balance</span>';
                html += '<span class="text-2xl font-bold text-gray-800"> ' + state.thumbnailTokenBalance + '</span>';
                html += '</div>';
                html += '<div class="flex justify-between items-center mb-3">';
                html += '<span class="text-gray-600">Subscription Plan</span>';
                html += '<span class="font-semibold text-gray-800 capitalize">' + state.thumbnailTokenPlan + '</span>';
                html += '</div>';
                if (state.thumbnailTokenRollover > 0) {
                    html += '<div class="flex justify-between items-center">';
                    html += '<span class="text-gray-600">Rollover from last month</span>';
                    html += '<span class="font-semibold text-green-600">+' + state.thumbnailTokenRollover + '</span>';
                    html += '</div>';
                }
                html += '</div>';

                // Token Costs Info
                html += '<div class="border border-gray-200 rounded-xl p-4 mb-4">';
                html += '<h4 class="font-semibold text-gray-800 mb-3">Token Costs</h4>';
                html += '<div class="space-y-2 text-sm">';
                html += '<div class="flex justify-between"><span class="text-gray-600">Quick Mode (Imagen 4)</span><span class="font-semibold">2 tokens/image</span></div>';
                html += '<div class="flex justify-between"><span class="text-gray-600">Reference Mode</span><span class="font-semibold">4 tokens/image</span></div>';
                html += '<div class="flex justify-between"><span class="text-gray-600">Premium Mode (DALL-E 3)</span><span class="font-semibold">6 tokens/image</span></div>';
                html += '</div>';
                html += '</div>';

                // Go to Creative Studio button
                html += '<a href="/creative-studio" class="block w-full py-3 bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-semibold rounded-xl text-center hover:from-purple-600 hover:to-indigo-700 transition-all">';
                html += ' Open Creative Studio';
                html += '</a>';
                html += '<p class="text-center text-gray-500 text-sm mt-3">More token options & advanced features</p>';

                html += '</div></div>';
            }

            // Quota Bypass Modal (use tokens to skip wait time)
            if (state.showQuotaBypassModal && state.quotaBypassData) {
                var qd = state.quotaBypassData;
                html += '<div class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4" onclick="app.hideQuotaBypassModal()">';
                html += '<div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl shadow-2xl max-w-md w-full p-6 relative border border-white/10" onclick="event.stopPropagation()">';
                html += '<button onclick="app.hideQuotaBypassModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl transition-colors">&times;</button>';

                // Header
                html += '<div class="text-center mb-6">';
                html += '<div class="w-16 h-16 bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl flex items-center justify-center text-3xl mx-auto mb-3 shadow-lg"></div>';
                html += '<h3 class="text-2xl font-bold text-white">Limit Reached</h3>';
                html += '<p class="text-gray-400 mt-1">You\'ve used all your free ' + qd.toolName + ' slots</p>';
                html += '</div>';

                // Options
                html += '<div class="space-y-3">';

                // Option 1: Wait
                html += '<div class="bg-white/5 rounded-xl p-4 border border-white/10">';
                html += '<div class="flex items-center justify-between">';
                html += '<div>';
                html += '<h4 class="font-semibold text-white flex items-center gap-2"><span></span> Wait for free refresh</h4>';
                html += '<p class="text-sm text-gray-400 mt-1">Your slots will reset in <span class="text-amber-400 font-semibold">' + app.formatBypassCountdown(qd.remainingMs) + '</span></p>';
                html += '</div>';
                html += '<button onclick="app.hideQuotaBypassModal()" class="px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition-colors text-sm font-medium">Wait</button>';
                html += '</div>';
                html += '</div>';

                // Option 2: Use Tokens
                html += '<div class="bg-gradient-to-r from-amber-500/20 to-orange-500/20 rounded-xl p-4 border border-amber-500/30">';
                html += '<div class="flex items-center justify-between">';
                html += '<div>';
                html += '<h4 class="font-semibold text-white flex items-center gap-2"><span></span> Skip wait with tokens</h4>';
                html += '<p class="text-sm text-gray-300 mt-1">Use <span class="text-amber-400 font-bold">' + qd.tokenCost + ' tokens</span> to proceed now</p>';
                html += '<p class="text-xs text-gray-500 mt-1">Your balance: ' + qd.tokenBalance + ' tokens</p>';
                html += '</div>';

                if (qd.canBypass) {
                    if (qd.processing) {
                        html += '<button disabled class="px-4 py-2 bg-amber-500/50 text-white rounded-lg text-sm font-medium cursor-wait">';
                        html += '<span class="animate-pulse">Processing...</span>';
                        html += '</button>';
                    } else {
                        html += '<button onclick="app.useTokensForBypass()" class="px-4 py-2 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-lg hover:from-amber-600 hover:to-orange-600 transition-all text-sm font-medium shadow-lg">';
                        html += ' Use ' + qd.tokenCost + ' Tokens';
                        html += '</button>';
                    }
                } else {
                    html += '<div class="text-right">';
                    html += '<span class="text-xs text-red-400 block">Insufficient tokens</span>';
                    html += '<button onclick="app.showTokenUsageModal(); app.hideQuotaBypassModal();" class="text-xs text-amber-400 hover:text-amber-300 mt-1">Get more </button>';
                    html += '</div>';
                }
                html += '</div>';

                if (qd.error) {
                    html += '<p class="text-red-400 text-sm mt-2">' + qd.error + '</p>';
                }
                html += '</div>';

                html += '</div>';

                // Tip
                html += '<p class="text-center text-gray-500 text-xs mt-4"> Upgrade your plan for more daily uses</p>';

                html += '</div></div>';
            }

            // Token Info Modal
            if (state.showTokenModal) {
                var tokenCosts = state.tokenBypassCosts || {};
                var toolLabels = {
                    warpOptimizer: 'WARP Optimizer',
                    competitorAnalysis: 'Competitor Analysis',
                    trendPredictor: 'Trend Predictor',
                    thumbnailGenerator: 'Thumbnail Generator',
                    channelAudit: 'Channel Audit',
                    scriptGenerator: 'Script Generator',
                    titleGenerator: 'Title Generator',
                    placementFinder: 'Placement Finder'
                };

                html += '<div class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4" onclick="app.hideTokenModal()">';
                html += '<div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl shadow-2xl max-w-lg w-full p-6 relative border border-white/10" onclick="event.stopPropagation()">';
                html += '<button onclick="app.hideTokenModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl transition-colors">&times;</button>';

                // Header with balance
                html += '<div class="text-center mb-6">';
                html += '<div class="w-20 h-20 bg-gradient-to-br from-amber-400 to-yellow-600 rounded-2xl flex items-center justify-center text-4xl mx-auto mb-4 shadow-lg shadow-amber-500/30"></div>';
                html += '<h3 class="text-2xl font-bold text-white">Your Token Balance</h3>';
                html += '<div class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-amber-400 to-yellow-500 mt-2">' + (state.thumbnailTokenBalance || 0) + '</div>';
                html += '<p class="text-gray-400 mt-1">Creative Tokens Available</p>';
                html += '</div>';

                // Plan info
                if (state.profile && state.profile.plan) {
                    html += '<div class="bg-white/5 rounded-xl p-4 mb-4 border border-white/10">';
                    html += '<div class="flex items-center justify-between">';
                    html += '<div class="flex items-center gap-3">';
                    html += '<span class="text-2xl"></span>';
                    html += '<div>';
                    html += '<p class="text-white font-semibold">Current Plan</p>';
                    html += '<p class="text-amber-400 font-bold capitalize">' + (state.profile.plan || 'Free') + '</p>';
                    html += '</div>';
                    html += '</div>';
                    html += '<a href="pricing.html" class="text-sm text-purple-400 hover:text-purple-300">Upgrade </a>';
                    html += '</div>';
                    html += '</div>';
                }

                // Token bypass costs info
                html += '<div class="bg-white/5 rounded-xl p-4 mb-4 border border-white/10">';
                html += '<h4 class="text-white font-semibold mb-3 flex items-center gap-2"><span></span> Quota Bypass Costs</h4>';
                html += '<p class="text-gray-400 text-sm mb-3">When you run out of free uses, tokens can skip the wait time:</p>';
                html += '<div class="grid grid-cols-2 gap-2">';

                var toolKeys = Object.keys(toolLabels);
                for (var ti = 0; ti < toolKeys.length; ti++) {
                    var toolKey = toolKeys[ti];
                    var cost = tokenCosts[toolKey] || '?';
                    html += '<div class="flex items-center justify-between bg-white/5 rounded-lg px-3 py-2">';
                    html += '<span class="text-gray-300 text-xs">' + toolLabels[toolKey] + '</span>';
                    html += '<span class="text-amber-400 font-bold text-sm">' + cost + ' </span>';
                    html += '</div>';
                }

                html += '</div>';
                html += '</div>';

                // TopUp button
                html += '<button onclick="app.topUpTokens()" class="w-full py-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold rounded-xl hover:from-amber-600 hover:to-orange-600 transition-all shadow-lg shadow-amber-500/30 flex items-center justify-center gap-2">';
                html += '<span class="text-xl"></span> TopUp Tokens';
                html += '</button>';

                html += '<p class="text-center text-gray-500 text-xs mt-3">Contact support for custom token packages</p>';

                html += '</div></div>';
            }

            // Loading Section
            if (state.loading && state.generatedThumbnails.length === 0) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-8 mobile-padding mb-6 fade-in">';
                html += '<div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">';
                html += '<div class="flex items-center gap-4"><div class="loading-emoji"></div><div><h3 class="text-xl font-bold text-gray-800">Creating Your Thumbnail' + (state.thumbnailVariations > 1 ? 's' : '') + '</h3><p class="text-gray-500">AI is generating ' + state.thumbnailVariations + ' image' + (state.thumbnailVariations > 1 ? 's' : '') + '...</p></div></div>';
                html += '<div class="progress-percentage">' + Math.round(state.loadingProgress) + '%</div>';
                html += '</div>';
                html += '<div class="progress-bar-container mb-6"><div class="progress-bar-fill" style="width:' + state.loadingProgress + '%"></div></div>';
                html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-3">';
                for (var li = 0; li < state.loadingSteps.length; li++) {
                    var lstep = state.loadingSteps[li];
                    var lstepClass = li < state.loadingStep ? 'completed' : li === state.loadingStep ? 'active' : 'pending';
                    html += '<div class="loading-step ' + lstepClass + '">';
                    html += '<div class="step-icon ' + lstepClass + '">' + (lstepClass === 'completed' ? '' : lstep.icon) + '</div>';
                    html += '<span class="text-sm font-medium">' + lstep.name + '</span>';
                    html += '</div>';
                }
                html += '</div></div>';
            }

            // Video Context Card
            if (hasVideoContext && videoInfo.thumbnail && !state.loading) {
                html += '<div class="bg-white/10 backdrop-blur rounded-2xl p-4 mb-6 fade-in">';
                html += '<div class="flex items-center gap-4">';
                html += '<img src="' + utils.escapeHtml(videoInfo.thumbnail) + '" class="w-32 h-18 object-cover rounded-lg" />';
                html += '<div>';
                html += '<p class="text-white font-semibold">' + utils.escapeHtml(videoInfo.title || 'Your Video') + '</p>';
                html += '<p class="text-white/70 text-sm">' + utils.escapeHtml(videoInfo.channelTitle || '') + '</p>';
                html += '<span class="inline-block mt-2 bg-green-500 text-white text-xs px-2 py-1 rounded-full"> Video context loaded</span>';
                html += '</div></div></div>';
            }

            // Main Form Card
            html += '<div class="bg-white rounded-2xl shadow-xl p-8 mobile-padding fade-in">';
            html += '<h2 class="text-3xl mobile-text-xl font-bold text-gray-800 mb-4"> AI Thumbnail Generator Pro</h2>';

            if (state.error) {
                html += '<div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-xl text-red-700">' + utils.escapeHtml(state.error.message) + '</div>';
            }

            // Show results if we have generated thumbnails
            if (state.generatedThumbnails && state.generatedThumbnails.length > 0) {
                // Results Section
                html += '<div class="text-center mb-6">';
                html += '<div class="inline-block bg-gradient-to-r from-green-400 to-emerald-500 text-white px-4 py-2 rounded-full mb-4 font-semibold"> ' + state.generatedThumbnails.length + ' Thumbnail' + (state.generatedThumbnails.length > 1 ? 's' : '') + ' Generated!</div>';
                html += '</div>';

                // Main selected thumbnail
                var selectedImg = state.generatedThumbnails[state.selectedThumbnailIndex];
                if (selectedImg) {
                    html += '<div class="relative mb-6">';
                    html += '<img src="' + utils.escapeHtml(selectedImg.url) + '" class="w-full max-w-3xl mx-auto rounded-xl shadow-2xl" alt="Generated Thumbnail" />';
                    html += '<div class="absolute bottom-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded">1280  720</div>';
                    html += '<div class="absolute top-2 left-2 bg-black/70 text-white text-xs px-2 py-1 rounded">' + (selectedImg.model || 'AI Generated') + '</div>';
                    html += '</div>';
                }

                // Thumbnail variations grid (if multiple)
                if (state.generatedThumbnails.length > 1) {
                    html += '<div class="mb-6">';
                    html += '<p class="text-gray-600 text-sm mb-3 text-center">Click to select a variation:</p>';
                    html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-3">';
                    for (var ti = 0; ti < state.generatedThumbnails.length; ti++) {
                        var thumb = state.generatedThumbnails[ti];
                        var isSelected = ti === state.selectedThumbnailIndex;
                        html += '<div onclick="app.selectThumbnail(' + ti + ')" class="cursor-pointer relative rounded-lg overflow-hidden border-2 ' + (isSelected ? 'border-pink-500 ring-2 ring-pink-300' : 'border-gray-200 hover:border-pink-300') + ' transition-all">';
                        html += '<img src="' + utils.escapeHtml(thumb.url) + '" class="w-full aspect-video object-cover" />';
                        if (isSelected) {
                            html += '<div class="absolute top-1 right-1 bg-pink-500 text-white text-xs px-2 py-0.5 rounded-full"></div>';
                        }
                        html += '<div class="absolute bottom-1 left-1 bg-black/60 text-white text-xs px-1.5 py-0.5 rounded">#' + (ti + 1) + '</div>';
                        html += '</div>';
                    }
                    html += '</div>';
                    html += '</div>';
                }

                // Action buttons
                html += '<div class="flex flex-col sm:flex-row justify-center gap-4 flex-wrap">';
                if (selectedImg) {
                    html += '<button data-download-btn="' + state.selectedThumbnailIndex + '" onclick="app.downloadThumbnail(\'' + utils.escapeHtml(selectedImg.url) + '\', ' + state.selectedThumbnailIndex + ')" class="btn-primary bg-gradient-to-r from-green-500 to-emerald-600 inline-flex items-center justify-center gap-2"><span></span> Download</button>';

                    // HD Upscale/Download buttons
                    if (selectedImg.hdUrl) {
                        html += '<button data-hd-download-btn="' + state.selectedThumbnailIndex + '" onclick="app.downloadHdThumbnail(\'' + utils.escapeHtml(selectedImg.hdUrl) + '\', ' + state.selectedThumbnailIndex + ')" class="btn-primary bg-gradient-to-r from-blue-500 to-indigo-600 inline-flex items-center justify-center gap-2"><span></span> Download HD</button>';
                    } else {
                        html += '<button onclick="app.upscaleThumbnail(\'' + utils.escapeHtml(selectedImg.url) + '\', ' + state.selectedThumbnailIndex + ', \'single\')" ' + (state.hdUpscaleLoading ? 'disabled' : '') + ' class="px-4 py-2 bg-gray-100 text-gray-700 font-medium rounded-lg border border-gray-300 hover:bg-gray-200 inline-flex items-center justify-center gap-2 transition-all ' + (state.hdUpscaleLoading ? 'opacity-50 cursor-not-allowed' : '') + '"><span>' + (state.hdUpscaleLoading ? '' : '') + '</span> ' + (state.hdUpscaleLoading ? 'Upscaling...' : 'Upscale HD (1 credit)') + '</button>';
                    }

                    html += '<button onclick="app.previewThumbnail(\'' + utils.escapeHtml(selectedImg.url) + '\')" class="px-4 py-2 bg-gray-100 text-gray-700 font-medium rounded-lg border border-gray-300 hover:bg-gray-200 inline-flex items-center justify-center gap-2 transition-all"><span></span> Preview</button>';

                    // Edit with AI button
                    html += '<button onclick="app.openThumbnailEditor(\'' + utils.escapeHtml(selectedImg.url) + '\', ' + state.selectedThumbnailIndex + ', \'single\')" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-medium rounded-lg hover:from-purple-600 hover:to-pink-600 shadow-md inline-flex items-center justify-center gap-2 transition-all"><span></span> Edit with AI</button>';
                }
                html += '<button onclick="app.toggleYouTubePreview()" class="px-4 py-2 bg-gray-100 text-gray-700 font-medium rounded-lg border border-gray-300 hover:bg-gray-200 inline-flex items-center justify-center gap-2 transition-all"><span></span> YouTube Preview</button>';
                html += '<button onclick="app.resetThumbnailGenerator()" class="px-4 py-2 bg-gray-100 text-gray-700 font-medium rounded-lg border border-gray-300 hover:bg-gray-200 inline-flex items-center justify-center gap-2 transition-all"> Create New</button>';
                html += '</div>';

            } else if (!state.loading) {
                // Form Section
                html += '<form onsubmit="app.generateThumbnailPro(event)">';

                // ========== MODE SELECTOR ==========
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-3">Generation Mode</label>';
                html += '<div class="grid grid-cols-1 md:grid-cols-3 gap-4">';

                var modes = [
                    { id: 'quick', name: 'Quick Mode', icon: '', desc: 'Imagen 4 - Fast & crisp', cost: 2, badge: '', features: ['~5 seconds', 'No reference'] },
                    { id: 'reference', name: 'Reference Mode', icon: '', desc: 'Include your image', cost: 4, badge: 'Popular', features: ['~10 seconds', 'Upload your face/product'] },
                    { id: 'upgrade', name: 'Thumbnail Upgrade', icon: '', desc: 'Upgrade existing thumbnail', cost: 4, badge: 'NEW', features: ['~10 seconds', 'Upload or paste URL'] }
                ];

                modes.forEach(function(m) {
                    var isActive = state.thumbnailMode === m.id;
                    var borderClass = isActive ? 'border-pink-500 bg-pink-50 shadow-lg' : 'border-gray-200 hover:border-pink-300';
                    html += '<div data-mode-card="' + m.id + '" onclick="app.setThumbnailMode(\'' + m.id + '\')" class="cursor-pointer p-4 border-2 ' + borderClass + ' rounded-xl transition-all relative">';
                    if (m.badge) {
                        html += '<div class="absolute -top-2 -right-2 bg-gradient-to-r from-pink-500 to-rose-500 text-white text-xs px-2 py-0.5 rounded-full">' + m.badge + '</div>';
                    }
                    html += '<div class="flex items-start gap-3">';
                    html += '<div class="text-3xl">' + m.icon + '</div>';
                    html += '<div class="flex-1">';
                    html += '<p class="font-bold text-gray-800">' + m.name + '</p>';
                    html += '<p class="text-sm text-gray-500 mb-2">' + m.desc + '</p>';
                    html += '<div class="flex flex-wrap gap-1">';
                    m.features.forEach(function(f) {
                        html += '<span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded">' + f + '</span>';
                    });
                    html += '</div>';
                    html += '<p class="text-pink-600 font-bold mt-2">' + m.cost + ' tokens/image</p>';
                    html += '</div>';
                    html += '<div class="mode-check text-pink-500 text-xl ' + (isActive ? '' : 'hidden') + '"></div>';
                    html += '</div></div>';
                });
                html += '</div></div>';

                // ========== REFERENCE IMAGE UPLOAD (only for reference mode) ==========
                if (state.thumbnailMode === 'reference') {
                    html += '<div class="mb-6 p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl border border-purple-200">';
                    html += '<label class="block text-gray-700 font-semibold mb-3"> Reference Image</label>';

                    if (state.thumbnailReference) {
                        // Show uploaded image preview
                        html += '<div class="flex items-center gap-4">';
                        html += '<div class="relative">';
                        html += '<img src="' + state.thumbnailReference.dataUrl + '" class="w-24 h-24 object-cover rounded-lg border-2 border-purple-300" />';
                        html += '<button type="button" onclick="app.removeReference()" class="absolute -top-2 -right-2 bg-red-500 text-white w-6 h-6 rounded-full text-sm hover:bg-red-600"></button>';
                        html += '</div>';
                        html += '<div>';
                        html += '<p class="font-medium text-gray-800">' + utils.escapeHtml(state.thumbnailReference.name) + '</p>';
                        html += '<p class="text-sm text-green-600"> Image ready - AI will incorporate this into your thumbnail</p>';
                        html += '</div>';
                        html += '</div>';
                    } else {
                        // Show upload zone
                        html += '<div class="border-2 border-dashed border-purple-300 rounded-xl p-6 text-center hover:border-purple-500 transition-all cursor-pointer" onclick="document.getElementById(\'reference-upload\').click()">';
                        html += '<input type="file" id="reference-upload" accept="image/jpeg,image/png,image/webp" class="hidden" onchange="app.handleReferenceUpload(event)" />';
                        html += '<div class="text-4xl mb-2"></div>';
                        html += '<p class="font-medium text-gray-700">Click to upload your reference image</p>';
                        html += '<p class="text-sm text-gray-500 mt-1">Your face, product, or any image to include in the thumbnail</p>';
                        html += '<p class="text-xs text-gray-400 mt-2">JPG, PNG, WebP  Max 5MB</p>';
                        html += '</div>';
                    }
                    html += '</div>';

                    // ========== REFERENCE TYPE SELECTOR (when reference uploaded) ==========
                    if (state.thumbnailReference) {
                        html += '<div class="mb-4 p-4 bg-white rounded-xl border border-gray-200">';
                        html += '<label class="block text-gray-700 font-semibold mb-3"> What should AI focus on from your reference?</label>';
                        html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-2">';

                        var refTypes = [
                            { id: 'auto', name: 'Auto Detect', icon: '', desc: 'AI decides' },
                            { id: 'face', name: 'My Face', icon: '', desc: 'Keep my likeness' },
                            { id: 'product', name: 'Product', icon: '', desc: 'Showcase item' },
                            { id: 'style', name: 'Style Only', icon: '', desc: 'Match colors/mood' }
                        ];

                        refTypes.forEach(function(rt) {
                            var isActive = state.thumbnailReferenceType === rt.id;
                            var btnClass = isActive ? 'border-purple-500 bg-purple-50' : 'border-gray-200 hover:border-purple-300';
                            html += '<div onclick="app.setThumbnailReferenceType(\'' + rt.id + '\')" class="cursor-pointer p-3 border-2 ' + btnClass + ' rounded-xl text-center transition-all">';
                            html += '<div class="text-xl">' + rt.icon + '</div>';
                            html += '<p class="font-semibold text-gray-800 text-sm">' + rt.name + '</p>';
                            html += '<p class="text-xs text-gray-500">' + rt.desc + '</p>';
                            html += '</div>';
                        });
                        html += '</div></div>';

                        // Face-specific options (expression, strength)
                        if (state.thumbnailReferenceType === 'face') {
                            html += '<div class="mb-4 p-4 bg-white rounded-xl border border-gray-200">';
                            html += '<label class="block text-gray-700 font-semibold mb-3"> Expression Style</label>';
                            html += '<div class="flex flex-wrap gap-2">';

                            var expressions = [
                                { id: 'keep', name: 'Keep Original', icon: '' },
                                { id: 'excited', name: 'Excited', icon: '' },
                                { id: 'serious', name: 'Serious', icon: '' },
                                { id: 'surprised', name: 'Surprised', icon: '' },
                                { id: 'confident', name: 'Confident', icon: '' }
                            ];

                            expressions.forEach(function(exp) {
                                var isActive = state.thumbnailExpression === exp.id;
                                var btnClass = isActive ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-purple-100';
                                html += '<button type="button" onclick="app.setThumbnailExpression(\'' + exp.id + '\')" class="px-3 py-2 rounded-full font-medium transition-all text-sm ' + btnClass + '">';
                                html += exp.icon + ' ' + exp.name;
                                html += '</button>';
                            });
                            html += '</div>';

                            // Face strength slider
                            html += '<div class="mt-4">';
                            html += '<label class="block text-gray-600 text-sm mb-2">Face Preservation Strength: <span class="font-bold text-purple-600">' + Math.round(state.thumbnailFaceStrength * 100) + '%</span></label>';
                            html += '<input type="range" min="50" max="100" value="' + Math.round(state.thumbnailFaceStrength * 100) + '" oninput="app.setThumbnailFaceStrength(this.value)" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-500" />';
                            html += '<div class="flex justify-between text-xs text-gray-400 mt-1"><span>More Creative</span><span>Exact Match</span></div>';
                            html += '</div></div>';
                        }

                        // Style-specific options (strength)
                        if (state.thumbnailReferenceType === 'style') {
                            html += '<div class="mb-4 p-4 bg-white rounded-xl border border-gray-200">';
                            html += '<label class="block text-gray-600 text-sm mb-2">Style Transfer Strength: <span class="font-bold text-purple-600">' + Math.round(state.thumbnailStyleStrength * 100) + '%</span></label>';
                            html += '<input type="range" min="50" max="100" value="' + Math.round(state.thumbnailStyleStrength * 100) + '" oninput="app.setThumbnailStyleStrength(this.value)" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-500" />';
                            html += '<div class="flex justify-between text-xs text-gray-400 mt-1"><span>Subtle Hints</span><span>Strong Match</span></div>';
                            html += '</div>';
                        }
                    }
                }

                // ========== THUMBNAIL UPGRADE MODE UI ==========
                if (state.thumbnailMode === 'upgrade') {
                    html += '<div class="mb-6 p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-200">';
                    html += '<label class="block text-gray-700 font-semibold mb-3"> Upgrade Existing Thumbnail</label>';

                    // Tab selector: Upload vs YouTube URL vs Bulk vs Playlist
                    html += '<div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mb-4">';
                    var uploadActive = state.thumbnailUpgradeMode === 'upload';
                    var youtubeActive = state.thumbnailUpgradeMode === 'youtube';
                    var bulkActive = state.thumbnailUpgradeMode === 'bulk';
                    var playlistActive = state.thumbnailUpgradeMode === 'playlist';
                    html += '<button type="button" onclick="app.setUpgradeMode(\'upload\')" class="px-3 py-2 rounded-lg font-medium transition-all text-sm ' + (uploadActive ? 'bg-green-500 text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200 hover:border-green-300') + '">';
                    html += ' Upload';
                    html += '</button>';
                    html += '<button type="button" onclick="app.setUpgradeMode(\'youtube\')" class="px-3 py-2 rounded-lg font-medium transition-all text-sm ' + (youtubeActive ? 'bg-red-500 text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200 hover:border-red-300') + '">';
                    html += ' Single URL';
                    html += '</button>';
                    html += '<button type="button" onclick="app.setUpgradeMode(\'bulk\')" class="px-3 py-2 rounded-lg font-medium transition-all text-sm ' + (bulkActive ? 'bg-purple-500 text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200 hover:border-purple-300') + '">';
                    html += ' Bulk';
                    html += '</button>';
                    html += '<button type="button" onclick="app.setUpgradeMode(\'playlist\')" class="px-3 py-2 rounded-lg font-medium transition-all text-sm ' + (playlistActive ? 'bg-indigo-500 text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200 hover:border-indigo-300') + '">';
                    html += ' Playlist';
                    html += '</button>';
                    html += '</div>';

                    // Upload mode
                    if (state.thumbnailUpgradeMode === 'upload') {
                        if (state.thumbnailReference && !state.thumbnailReference.isYoutubeThumbnail) {
                            // Show uploaded image preview
                            html += '<div class="flex items-center gap-4">';
                            html += '<div class="relative">';
                            html += '<img src="' + state.thumbnailReference.dataUrl + '" class="w-32 h-18 object-cover rounded-lg border-2 border-green-300" style="aspect-ratio: 16/9;" />';
                            html += '<button type="button" onclick="app.removeReference()" class="absolute -top-2 -right-2 bg-red-500 text-white w-6 h-6 rounded-full text-sm hover:bg-red-600"></button>';
                            html += '</div>';
                            html += '<div>';
                            html += '<p class="font-medium text-gray-800">' + utils.escapeHtml(state.thumbnailReference.name) + '</p>';
                            html += '<p class="text-sm text-green-600"> Thumbnail ready for upgrade</p>';
                            html += '</div>';
                            html += '</div>';
                        } else {
                            // Show upload zone
                            html += '<div class="border-2 border-dashed border-green-300 rounded-xl p-6 text-center hover:border-green-500 transition-all cursor-pointer" onclick="document.getElementById(\'upgrade-upload\').click()">';
                            html += '<input type="file" id="upgrade-upload" accept="image/jpeg,image/png,image/webp" class="hidden" onchange="app.handleReferenceUpload(event)" />';
                            html += '<div class="text-4xl mb-2"></div>';
                            html += '<p class="font-medium text-gray-700">Upload your existing thumbnail</p>';
                            html += '<p class="text-sm text-gray-500 mt-1">AI will analyze and create an upgraded version</p>';
                            html += '<p class="text-xs text-gray-400 mt-2">JPG, PNG, WebP  Max 5MB</p>';
                            html += '</div>';
                        }
                    }

                    // YouTube URL mode
                    if (state.thumbnailUpgradeMode === 'youtube') {
                        if (state.thumbnailYoutubeData && state.thumbnailReference) {
                            // Show fetched YouTube thumbnail preview
                            html += '<div class="bg-white rounded-xl p-4 border border-gray-200">';
                            html += '<div class="flex gap-4">';
                            html += '<div class="relative flex-shrink-0">';
                            html += '<img src="' + state.thumbnailYoutubeData.thumbnailUrl + '" class="w-40 rounded-lg border border-gray-200" style="aspect-ratio: 16/9; object-fit: cover;" />';
                            html += '<div class="absolute top-1 left-1 bg-red-600 text-white text-xs px-1.5 py-0.5 rounded flex items-center gap-1">';
                            html += '<span></span> YouTube';
                            html += '</div>';
                            html += '</div>';
                            html += '<div class="flex-1 min-w-0">';
                            if (state.thumbnailYoutubeData.title) {
                                html += '<p class="font-semibold text-gray-800 text-sm line-clamp-2">' + utils.escapeHtml(state.thumbnailYoutubeData.title) + '</p>';
                                html += '<p class="text-xs text-gray-500 mt-1">' + utils.escapeHtml(state.thumbnailYoutubeData.channelName || 'Unknown Channel') + '</p>';
                            } else {
                                html += '<p class="font-semibold text-gray-800 text-sm">Video ID: ' + state.thumbnailYoutubeData.videoId + '</p>';
                                html += '<p class="text-xs text-amber-600 mt-1"> Title unavailable (API key not configured)</p>';
                            }
                            html += '<p class="text-sm text-green-600 mt-2"> Thumbnail ready for upgrade</p>';
                            html += '<button type="button" onclick="app.clearYoutubeData()" class="mt-2 text-xs text-red-500 hover:text-red-700">Clear & try another</button>';
                            html += '</div>';
                            html += '</div>';
                            html += '</div>';
                        } else {
                            // Show YouTube URL input
                            html += '<div class="space-y-3">';
                            html += '<div class="flex gap-2">';
                            html += '<input type="text" id="youtube-url-input" placeholder="Paste YouTube video URL..." value="' + (state.thumbnailYoutubeUrl || '') + '" onchange="app.setYoutubeUrl(this.value)" oninput="app.setYoutubeUrl(this.value)" class="flex-1 px-4 py-3 bg-white border border-gray-200 rounded-lg focus:border-red-400 focus:ring-2 focus:ring-red-100 outline-none" />';
                            html += '<button type="button" onclick="app.fetchYoutubeThumbnail()" ' + (state.thumbnailYoutubeLoading ? 'disabled' : '') + ' class="px-5 py-3 bg-red-500 text-white rounded-lg font-medium hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all whitespace-nowrap">';
                            html += state.thumbnailYoutubeLoading ? ' Loading...' : ' Fetch';
                            html += '</button>';
                            html += '</div>';
                            html += '<p class="text-xs text-gray-500">Supports: youtube.com/watch?v=..., youtu.be/..., youtube.com/shorts/...</p>';
                            if (state.thumbnailYoutubeError) {
                                html += '<p class="text-sm text-red-500 bg-red-50 px-3 py-2 rounded-lg"> ' + utils.escapeHtml(state.thumbnailYoutubeError) + '</p>';
                            }
                            html += '</div>';
                        }
                    }

                    // ========== BULK MODE ==========
                    if (state.thumbnailUpgradeMode === 'bulk') {
                        // Check if we're showing results or the form
                        var hasCompletedItems = state.bulkUrls.some(function(item) { return item.status === 'complete'; });
                        var allComplete = state.bulkUrls.length > 0 && state.bulkUrls.every(function(item) {
                            return item.status === 'complete' || item.status === 'error';
                        });

                        if (allComplete && hasCompletedItems && !state.bulkProcessing) {
                            // Show bulk results
                            html += '<div class="space-y-4">';
                            var completedCount = state.bulkUrls.filter(function(i) { return i.status === 'complete'; }).length;
                            var errorCount = state.bulkUrls.filter(function(i) { return i.status === 'error'; }).length;

                            html += '<div class="text-center mb-4">';
                            html += '<div class="text-2xl mb-2"></div>';
                            html += '<p class="font-semibold text-gray-800">Bulk Generation Complete</p>';
                            html += '<p class="text-sm text-gray-500">' + completedCount + ' successful' + (errorCount > 0 ? ', ' + errorCount + ' failed' : '') + '</p>';
                            html += '</div>';

                            // Results grid
                            html += '<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">';
                            state.bulkUrls.forEach(function(item, idx) {
                                if (item.status === 'complete' && item.generatedThumbnail) {
                                    html += '<div class="relative group">';
                                    html += '<img src="' + item.generatedThumbnail + '" class="w-full rounded-lg border border-gray-200 shadow-sm" style="aspect-ratio: 16/9; object-fit: cover;" />';
                                    html += '<div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded-lg flex flex-col items-center justify-center gap-1">';
                                    html += '<div class="flex gap-2">';
                                    html += '<button onclick="app.downloadThumbnail(\'' + item.generatedThumbnail + '\', ' + idx + ')" class="bg-white text-gray-800 px-2 py-1 rounded text-xs font-medium hover:bg-gray-100"> SD</button>';
                                    if (item.hdUrl) {
                                        html += '<button onclick="app.downloadHdThumbnail(\'' + item.hdUrl + '\', ' + idx + ')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs font-medium hover:bg-blue-600"> HD</button>';
                                    } else {
                                        var isUpscaling = state.hdUpscalingMode === 'bulk' && state.hdUpscalingIndex === idx;
                                        html += '<button onclick="app.upscaleThumbnail(\'' + item.generatedThumbnail + '\', ' + idx + ', \'bulk\')" ' + (isUpscaling ? 'disabled' : '') + ' class="bg-indigo-500 text-white px-2 py-1 rounded text-xs font-medium hover:bg-indigo-600 ' + (isUpscaling ? 'opacity-70' : '') + '">' + (isUpscaling ? '<span class="animate-spin inline-block"></span>' : ' Upscale') + '</button>';
                                    }
                                    html += '</div>';
                                    html += '<div class="flex gap-2">';
                                    html += '<button onclick="app.previewThumbnail(\'' + item.generatedThumbnail + '\')" class="bg-white text-gray-800 px-2 py-1 rounded text-xs font-medium hover:bg-gray-100"> Preview</button>';
                                    html += '<button onclick="app.openThumbnailEditor(\'' + item.generatedThumbnail + '\', ' + idx + ', \'bulk\')" class="bg-purple-500 text-white px-2 py-1 rounded text-xs font-medium hover:bg-purple-600"> Edit</button>';
                                    html += '</div>';
                                    html += '</div>';
                                    html += '<div class="absolute bottom-1 left-1 bg-green-500 text-white text-xs px-1.5 py-0.5 rounded"></div>';
                                    if (item.hdUrl) {
                                        html += '<div class="absolute bottom-1 right-1 bg-blue-500 text-white text-xs px-1.5 py-0.5 rounded font-bold">HD</div>';
                                    }
                                    html += '</div>';
                                } else if (item.status === 'error') {
                                    html += '<div class="relative bg-red-50 border border-red-200 rounded-lg flex flex-col items-center justify-center" style="aspect-ratio: 16/9;">';
                                    html += '<div class="text-red-500 text-lg"></div>';
                                    html += '<p class="text-xs text-red-600 mt-1 px-1 text-center line-clamp-1">' + utils.escapeHtml(item.error || 'Failed') + '</p>';
                                    html += '<button onclick="app.regenerateBulkItem(' + idx + ')" class="mt-1 text-xs bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded transition-colors"> Retry</button>';
                                    html += '</div>';
                                } else if (item.status === 'regenerating') {
                                    html += '<div class="relative bg-yellow-50 border border-yellow-200 rounded-lg flex flex-col items-center justify-center" style="aspect-ratio: 16/9;">';
                                    html += '<div class="text-yellow-500 text-xl animate-spin"></div>';
                                    html += '<p class="text-xs text-yellow-600 mt-1">Retrying...</p>';
                                    html += '</div>';
                                }
                            });
                            html += '</div>';

                            // Action buttons
                            var hdCount = state.bulkUrls.filter(function(i) { return i.status === 'complete' && i.hdUrl; }).length;
                            var notHdCount = completedCount - hdCount;
                            html += '<div class="flex flex-col gap-3 mt-4">';

                            // First row - Download buttons
                            html += '<div class="flex flex-col sm:flex-row gap-3">';
                            if (completedCount > 0) {
                                html += '<button type="button" onclick="app.downloadAllAsZip(\'bulk\', false)" class="flex-1 btn-primary bg-gradient-to-r from-purple-500 to-indigo-600 inline-flex items-center justify-center gap-2">';
                                html += '<span></span> Download All (ZIP)';
                                html += '</button>';
                                if (hdCount > 0) {
                                    html += '<button type="button" onclick="app.downloadAllAsZip(\'bulk\', true)" class="flex-1 btn-primary bg-gradient-to-r from-blue-500 to-indigo-600 inline-flex items-center justify-center gap-2">';
                                    html += '<span></span> Download HD (ZIP)';
                                    html += '</button>';
                                }
                            }
                            html += '</div>';

                            // Second row - HD Upscale & other buttons
                            html += '<div class="flex flex-col sm:flex-row gap-3">';
                            if (notHdCount > 0) {
                                html += '<button type="button" onclick="app.upscaleAllThumbnails(\'bulk\')" ' + (state.hdUpscaleLoading ? 'disabled' : '') + ' class="flex-1 bg-gradient-to-r from-indigo-500 to-blue-600 hover:from-indigo-600 hover:to-blue-700 text-white font-medium py-2 px-4 rounded-lg inline-flex items-center justify-center gap-2 transition-all ' + (state.hdUpscaleLoading ? 'opacity-50 cursor-not-allowed' : '') + '">';
                                html += '<span>' + (state.hdUpscaleLoading ? '' : '') + '</span> ' + (state.hdUpscaleLoading ? 'Upscaling...' : 'Upscale All HD (' + notHdCount + ')');
                                html += '</button>';
                            }
                            if (errorCount > 0) {
                                html += '<button type="button" onclick="app.retryFailedBulkItems()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg inline-flex items-center justify-center gap-2 transition-colors">';
                                html += '<span></span> Retry Failed (' + errorCount + ')';
                                html += '</button>';
                            }
                            html += '<button type="button" onclick="app.resetBulkMode()" class="flex-1 btn-secondary inline-flex items-center justify-center gap-2">';
                            html += '<span></span> Start New Batch';
                            html += '</button>';
                            html += '</div>';

                            html += '</div>';

                            html += '</div>';
                        } else {
                            // Show bulk input form
                            html += '<div class="space-y-3">';

                            // Processing progress
                            if (state.bulkProcessing) {
                                var processingCount = state.bulkUrls.filter(function(i) { return i.status === 'generating'; }).length;
                                var doneCount = state.bulkUrls.filter(function(i) { return i.status === 'complete' || i.status === 'error'; }).length;
                                var totalCount = state.bulkUrls.filter(function(i) { return i.status === 'ready' || i.status === 'generating' || i.status === 'complete' || i.status === 'error'; }).length;

                                html += '<div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">';
                                html += '<div class="flex items-center gap-3">';
                                html += '<div class="animate-spin text-2xl"></div>';
                                html += '<div>';
                                html += '<p class="font-semibold text-purple-800">Processing Bulk Upgrade...</p>';
                                html += '<p class="text-sm text-purple-600">' + doneCount + ' of ' + totalCount + ' complete</p>';
                                html += '</div>';
                                html += '</div>';
                                html += '<div class="mt-3 bg-purple-200 rounded-full h-2 overflow-hidden">';
                                html += '<div class="bg-purple-500 h-full transition-all" style="width: ' + (totalCount > 0 ? (doneCount / totalCount * 100) : 0) + '%;"></div>';
                                html += '</div>';
                                html += '</div>';
                            }

                            // URL list
                            if (state.bulkUrls.length > 0) {
                                state.bulkUrls.forEach(function(item, idx) {
                                    html += '<div class="flex items-start gap-2 p-3 bg-white rounded-lg border border-gray-200">';

                                    // Status indicator
                                    html += '<div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-sm ';
                                    if (item.status === 'pending') html += 'bg-gray-100 text-gray-500">';
                                    else if (item.status === 'fetching') html += 'bg-blue-100 text-blue-500 animate-pulse">';
                                    else if (item.status === 'ready') html += 'bg-green-100 text-green-600">';
                                    else if (item.status === 'generating') html += 'bg-purple-100 text-purple-600 animate-pulse">';
                                    else if (item.status === 'complete') html += 'bg-green-500 text-white">';
                                    else if (item.status === 'error') html += 'bg-red-100 text-red-500">';
                                    html += '</div>';

                                    html += '<div class="flex-1 min-w-0">';

                                    // Show input or video info
                                    if (item.status === 'pending' || item.status === 'fetching') {
                                        html += '<div class="flex gap-2">';
                                        html += '<input type="text" placeholder="Paste YouTube URL..." value="' + (item.url || '') + '" ';
                                        html += 'onchange="app.updateBulkUrl(\'' + item.id + '\', this.value)" ';
                                        html += 'oninput="app.updateBulkUrl(\'' + item.id + '\', this.value)" ';
                                        html += 'class="flex-1 px-3 py-2 text-sm bg-gray-50 border border-gray-200 rounded-lg focus:border-purple-400 focus:ring-2 focus:ring-purple-100 outline-none" ';
                                        html += (item.status === 'fetching' || state.bulkProcessing ? 'disabled' : '') + ' />';
                                        html += '<button type="button" onclick="app.fetchBulkYoutubeData(\'' + item.id + '\')" ';
                                        html += (item.status === 'fetching' || !item.url.trim() || state.bulkProcessing ? 'disabled' : '') + ' ';
                                        html += 'class="px-3 py-2 bg-red-500 text-white text-sm rounded-lg font-medium hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all">';
                                        html += item.status === 'fetching' ? '' : '';
                                        html += '</button>';
                                        html += '</div>';
                                        if (item.error) {
                                            html += '<p class="text-xs text-red-500 mt-1">' + utils.escapeHtml(item.error) + '</p>';
                                        }
                                    } else if (item.youtubeData) {
                                        // Show fetched video info
                                        html += '<div class="flex items-center gap-2">';
                                        // Show generated thumbnail if complete, otherwise original
                                        var displayThumb = item.status === 'complete' && item.generatedThumbnail ? item.generatedThumbnail : item.youtubeData.thumbnailUrl;
                                        // Make thumbnail clickable for Face Lock select mode
                                        var isSelectMode = state.faceReferenceEnabled && state.faceReferenceSource === 'select';
                                        var isSelectedFace = state.faceReferenceVideoIndex === idx && state.faceReferenceImage;
                                        var thumbClasses = 'w-20 h-11 object-cover rounded transition-all ';
                                        if (item.status === 'complete') thumbClasses += 'ring-2 ring-green-500 ';
                                        if (isSelectMode) thumbClasses += 'cursor-pointer hover:ring-2 hover:ring-amber-400 ';
                                        if (isSelectedFace) thumbClasses += 'ring-2 ring-amber-500 ';
                                        html += '<img src="' + displayThumb + '" class="' + thumbClasses + '" ';
                                        if (isSelectMode) {
                                            html += 'onclick="app.setFaceFromVideo(' + idx + ', \'bulk\')" title="Click to use this face" ';
                                        }
                                        html += '/>';
                                        if (isSelectedFace) {
                                            html += '<span class="text-xs bg-amber-500 text-white px-1 rounded"></span>';
                                        }
                                        html += '<div class="flex-1 min-w-0">';
                                        html += '<p class="text-sm font-medium text-gray-800 truncate">' + utils.escapeHtml(item.youtubeData.title || 'Video ' + item.youtubeData.videoId) + '</p>';
                                        html += '<p class="text-xs text-gray-500">' + utils.escapeHtml(item.youtubeData.channelName || '') + '</p>';
                                        html += '</div>';
                                        html += '</div>';
                                        if (item.status === 'generating') {
                                            html += '<p class="text-xs text-purple-600 mt-1 animate-pulse">Generating thumbnail...</p>';
                                        } else if (item.status === 'complete' && item.generatedThumbnail) {
                                            html += '<div class="flex items-center flex-wrap gap-2 mt-2">';
                                            html += '<span class="text-xs text-green-600"> Complete</span>';
                                            if (item.hdUrl) {
                                                html += '<span class="text-xs bg-blue-500 text-white px-1.5 py-0.5 rounded font-bold">HD</span>';
                                            }
                                            html += '<button type="button" onclick="app.downloadThumbnail(\'' + item.generatedThumbnail + '\', ' + idx + ')" class="text-xs bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600 transition-colors"> SD</button>';
                                            if (item.hdUrl) {
                                                html += '<button type="button" onclick="app.downloadHdThumbnail(\'' + item.hdUrl + '\', ' + idx + ')" class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 transition-colors"> HD</button>';
                                            } else {
                                                var isUpscalingItem = state.hdUpscalingMode === 'bulk' && state.hdUpscalingIndex === idx;
                                                html += '<button type="button" onclick="app.upscaleThumbnail(\'' + item.generatedThumbnail + '\', ' + idx + ', \'bulk\')" ' + (isUpscalingItem ? 'disabled' : '') + ' class="text-xs bg-indigo-500 text-white px-2 py-1 rounded hover:bg-indigo-600 transition-colors ' + (isUpscalingItem ? 'opacity-70' : '') + '">' + (isUpscalingItem ? '<span class="animate-spin inline-block"></span>' : ' Upscale') + '</button>';
                                            }
                                            html += '<button type="button" onclick="app.previewThumbnail(\'' + item.generatedThumbnail + '\')" class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded hover:bg-gray-300 transition-colors"></button>';
                                            html += '</div>';
                                        } else if (item.status === 'complete') {
                                            html += '<p class="text-xs text-green-600 mt-1"> Complete</p>';
                                        } else if (item.status === 'error') {
                                            html += '<p class="text-xs text-red-500 mt-1">' + utils.escapeHtml(item.error || 'Failed') + '</p>';
                                        }
                                    }

                                    html += '</div>';

                                    // Remove button
                                    if (!state.bulkProcessing) {
                                        html += '<button type="button" onclick="app.removeBulkUrl(\'' + item.id + '\')" class="flex-shrink-0 text-gray-400 hover:text-red-500 transition-colors p-1">';
                                        html += '';
                                        html += '</button>';
                                    }

                                    html += '</div>';
                                });
                            }

                            // Add video button
                            if (state.bulkUrls.length < state.bulkMaxItems && !state.bulkProcessing) {
                                html += '<button type="button" onclick="app.addBulkUrl()" class="w-full py-3 border-2 border-dashed border-purple-300 rounded-lg text-purple-600 font-medium hover:border-purple-500 hover:bg-purple-50 transition-all flex items-center justify-center gap-2">';
                                html += '<span class="text-lg">+</span> Add YouTube Video';
                                html += '<span class="text-xs text-purple-400">(' + state.bulkUrls.length + '/' + state.bulkMaxItems + ')</span>';
                                html += '</button>';
                            }

                            // Download All as ZIP button (when there are completed items)
                            var completedBulkCount = state.bulkUrls.filter(function(i) { return i.status === 'complete' && i.generatedThumbnail; }).length;
                            if (completedBulkCount > 0 && !state.bulkProcessing) {
                                html += '<div class="mt-4 p-4 bg-green-50 rounded-lg border border-green-200">';
                                html += '<div class="flex items-center justify-between">';
                                html += '<div>';
                                html += '<p class="font-semibold text-green-800"> ' + completedBulkCount + ' thumbnail' + (completedBulkCount > 1 ? 's' : '') + ' ready</p>';
                                html += '<p class="text-sm text-green-600">Download individually above or all at once</p>';
                                html += '</div>';
                                html += '<button type="button" onclick="app.downloadAllAsZip()" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-4 py-2 rounded-lg font-medium hover:from-green-600 hover:to-emerald-700 transition-all flex items-center gap-2">';
                                html += '<span></span> Download ZIP';
                                html += '</button>';
                                html += '</div>';
                                html += '</div>';
                            }

                            // ========== BULK SETTINGS (Apply to All) ==========
                            var readyCount = state.bulkUrls.filter(function(i) { return i.status === 'ready'; }).length;
                            if (state.bulkUrls.length > 0 && !state.bulkProcessing) {
                                html += '<div class="mt-4 pt-4 border-t border-purple-200">';
                                html += '<p class="text-sm font-semibold text-purple-700 mb-3"> Settings (Apply to All Thumbnails)</p>';

                                // Visual Style
                                html += '<div class="mb-3">';
                                html += '<label class="block text-gray-600 text-sm font-medium mb-2">Visual Style</label>';
                                html += '<div class="flex flex-wrap gap-2">';
                                var bulkStyles = [
                                    { id: 'professional', name: 'Professional', icon: '' },
                                    { id: 'dramatic', name: 'Dramatic', icon: '' },
                                    { id: 'minimal', name: 'Minimal', icon: '' },
                                    { id: 'bold', name: 'Bold', icon: '' }
                                ];
                                bulkStyles.forEach(function(s) {
                                    var isActive = state.thumbnailStyle === s.id;
                                    var btnClass = isActive ? 'bg-purple-500 text-white' : 'bg-white text-gray-700 border border-gray-200 hover:border-purple-300';
                                    html += '<button type="button" onclick="app.setThumbnailStyle(\'' + s.id + '\')" class="px-3 py-1.5 rounded-lg text-sm font-medium transition-all ' + btnClass + '">';
                                    html += s.icon + ' ' + s.name;
                                    html += '</button>';
                                });
                                html += '</div></div>';

                                // Content Category
                                html += '<div class="mb-3">';
                                html += '<label class="block text-gray-600 text-sm font-medium mb-2">Content Category</label>';
                                html += '<div class="flex flex-wrap gap-2">';
                                var bulkCategories = [
                                    { id: 'general', name: 'General', icon: '' },
                                    { id: 'gaming', name: 'Gaming', icon: '' },
                                    { id: 'tutorial', name: 'Tutorial', icon: '' },
                                    { id: 'vlog', name: 'Vlog', icon: '' },
                                    { id: 'review', name: 'Review', icon: '' },
                                    { id: 'entertainment', name: 'Entertainment', icon: '' }
                                ];
                                bulkCategories.forEach(function(c) {
                                    var isActive = state.thumbnailCategory === c.id;
                                    var btnClass = isActive ? 'bg-purple-500 text-white' : 'bg-white text-gray-700 border border-gray-200 hover:border-purple-300';
                                    html += '<button type="button" onclick="app.setThumbnailCategory(\'' + c.id + '\')" class="px-3 py-1.5 rounded-lg text-sm font-medium transition-all ' + btnClass + '">';
                                    html += c.icon + ' ' + c.name;
                                    html += '</button>';
                                });
                                html += '</div></div>';

                                // ========== FACE LOCK FEATURE ==========
                                html += '<div class="mt-4 p-3 rounded-lg border-2 ' + (state.faceReferenceEnabled ? 'bg-amber-50 border-amber-300' : 'bg-gray-50 border-gray-200') + '">';
                                html += '<div class="flex items-center justify-between">';
                                html += '<div class="flex items-center gap-2">';
                                html += '<span class="text-lg">' + (state.faceReferenceEnabled ? '' : '') + '</span>';
                                html += '<div>';
                                html += '<p class="font-semibold text-sm ' + (state.faceReferenceEnabled ? 'text-amber-800' : 'text-gray-700') + '">Face Lock</p>';
                                html += '<p class="text-xs text-gray-500">Keep same person across all thumbnails</p>';
                                html += '</div>';
                                html += '</div>';
                                html += '<button type="button" onclick="app.toggleFaceReference()" class="px-3 py-1.5 rounded-lg text-sm font-medium transition-all ' + (state.faceReferenceEnabled ? 'bg-amber-500 text-white' : 'bg-gray-200 text-gray-600 hover:bg-gray-300') + '">';
                                html += state.faceReferenceEnabled ? 'ON' : 'OFF';
                                html += '</button>';
                                html += '</div>';

                                // Face Lock Options (when enabled)
                                if (state.faceReferenceEnabled) {
                                    html += '<div class="mt-3 pt-3 border-t border-amber-200">';

                                    // Source Selection
                                    html += '<p class="text-xs font-medium text-amber-700 mb-2">Face Source:</p>';
                                    html += '<div class="flex flex-wrap gap-2 mb-3">';
                                    var faceSourceBtns = [
                                        { id: 'first', name: 'First Video', icon: '1' },
                                        { id: 'upload', name: 'Upload', icon: '' },
                                        { id: 'select', name: 'Select', icon: '' }
                                    ];
                                    faceSourceBtns.forEach(function(s) {
                                        var isActive = state.faceReferenceSource === s.id;
                                        var btnClass = isActive ? 'bg-amber-500 text-white' : 'bg-white text-gray-600 border border-amber-200 hover:border-amber-400';
                                        html += '<button type="button" onclick="app.setFaceReferenceSource(\'' + s.id + '\')" class="px-2 py-1 rounded text-xs font-medium transition-all ' + btnClass + '">';
                                        html += s.icon + ' ' + s.name;
                                        html += '</button>';
                                    });
                                    html += '</div>';

                                    // Face Preview
                                    if (state.faceReferenceLoading) {
                                        html += '<div class="flex items-center gap-2 p-2 bg-white rounded-lg border border-amber-200">';
                                        html += '<div class="w-12 h-12 rounded-full bg-amber-100 flex items-center justify-center animate-pulse">';
                                        html += '<span class="text-amber-500"></span>';
                                        html += '</div>';
                                        html += '<p class="text-xs text-amber-600">Loading face reference...</p>';
                                        html += '</div>';
                                    } else if (state.faceReferenceImage) {
                                        html += '<div class="flex items-center gap-3 p-2 bg-white rounded-lg border border-amber-200">';
                                        html += '<img src="' + state.faceReferenceImage.dataUrl + '" class="w-12 h-12 rounded-full object-cover border-2 border-amber-400" />';
                                        html += '<div class="flex-1">';
                                        html += '<p class="text-xs font-medium text-amber-800"> Face reference set</p>';
                                        html += '<p class="text-xs text-amber-600">This face will appear in all thumbnails</p>';
                                        html += '</div>';
                                        html += '<button onclick="app.clearFaceReference()" class="text-xs text-red-500 hover:text-red-700"></button>';
                                        html += '</div>';
                                    } else {
                                        html += '<div class="flex items-center gap-2 p-2 bg-white rounded-lg border border-dashed border-amber-300">';
                                        html += '<div class="w-12 h-12 rounded-full bg-amber-50 flex items-center justify-center">';
                                        html += '<span class="text-amber-400 text-lg"></span>';
                                        html += '</div>';
                                        html += '<p class="text-xs text-amber-600">Select a face source above or click a video thumbnail</p>';
                                        html += '</div>';
                                    }

                                    // Select mode hint
                                    if (state.faceReferenceSource === 'select') {
                                        html += '<p class="text-xs text-amber-600 mt-2 text-center"> Click on any video thumbnail above to use that face</p>';
                                    }

                                    html += '</div>';
                                }

                                html += '</div>';

                                html += '</div>';
                            }

                            // Summary and action
                            if (readyCount > 0 && !state.bulkProcessing) {
                                var bulkCost = app.calculateBulkCost();
                                html += '<div class="mt-4 p-4 bg-purple-50 rounded-lg border border-purple-200">';
                                html += '<div class="flex items-center justify-between mb-3">';
                                html += '<div>';
                                html += '<p class="font-semibold text-gray-800">' + readyCount + ' video' + (readyCount > 1 ? 's' : '') + ' ready</p>';
                                html += '<p class="text-sm text-gray-500">Cost: ' + bulkCost + ' tokens (' + (bulkCost/readyCount) + ' each)</p>';
                                html += '</div>';
                                html += '<div class="text-right">';
                                html += '<p class="text-xs text-gray-500">Balance</p>';
                                html += '<p class="font-bold ' + (state.thumbnailTokenBalance >= bulkCost ? 'text-green-600' : 'text-red-500') + '">' + state.thumbnailTokenBalance + ' tokens</p>';
                                html += '</div>';
                                html += '</div>';
                                html += '<button type="button" onclick="app.processBulkUpgrade()" ' + (state.thumbnailTokenBalance < bulkCost ? 'disabled' : '') + ' class="w-full btn-primary bg-gradient-to-r from-purple-500 to-indigo-600 py-3 inline-flex items-center justify-center gap-2">';
                                html += '<span></span> Upgrade All Thumbnails (' + bulkCost + ' tokens)';
                                html += '</button>';
                                if (state.thumbnailTokenBalance < bulkCost) {
                                    html += '<p class="text-xs text-red-500 mt-2 text-center">Insufficient tokens. You need ' + (bulkCost - state.thumbnailTokenBalance) + ' more tokens.</p>';
                                }
                                html += '</div>';
                            }

                            html += '</div>';
                        }
                    }

                    // ========== PLAYLIST MODE ==========
                    if (state.thumbnailUpgradeMode === 'playlist') {
                        // Check if we're showing results
                        var hasPlaylistResults = state.playlistResults && state.playlistResults.length > 0;
                        var allPlaylistComplete = hasPlaylistResults && state.playlistResults.every(function(r) {
                            return r.status === 'complete' || r.status === 'error';
                        });

                        if (allPlaylistComplete && !state.playlistProcessing) {
                            // Show playlist results
                            html += '<div class="space-y-4">';
                            var completedCount = state.playlistResults.filter(function(r) { return r.status === 'complete'; }).length;
                            var errorCount = state.playlistResults.filter(function(r) { return r.status === 'error'; }).length;

                            html += '<div class="text-center mb-4">';
                            html += '<div class="text-2xl mb-2"></div>';
                            html += '<p class="font-semibold text-gray-800">Playlist Generation Complete</p>';
                            html += '<p class="text-sm text-gray-500">' + completedCount + ' successful' + (errorCount > 0 ? ', ' + errorCount + ' failed' : '') + '</p>';
                            html += '</div>';

                            // Results grid
                            html += '<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 max-h-96 overflow-y-auto">';
                            state.playlistResults.forEach(function(item, idx) {
                                if (item.status === 'complete' && item.thumbnailUrl) {
                                    html += '<div class="relative group">';
                                    html += '<img src="' + item.thumbnailUrl + '" class="w-full rounded-lg border border-gray-200 shadow-sm" style="aspect-ratio: 16/9; object-fit: cover;" />';
                                    html += '<div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded-lg flex flex-col items-center justify-center gap-1">';
                                    html += '<div class="flex gap-2">';
                                    html += '<button onclick="app.downloadThumbnail(\'' + item.thumbnailUrl + '\', ' + idx + ')" class="bg-white text-gray-800 px-2 py-1 rounded text-xs font-medium hover:bg-gray-100"> SD</button>';
                                    if (item.hdUrl) {
                                        html += '<button onclick="app.downloadHdThumbnail(\'' + item.hdUrl + '\', ' + idx + ')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs font-medium hover:bg-blue-600"> HD</button>';
                                    } else {
                                        var isUpscalingPlaylist = state.hdUpscalingMode === 'playlist' && state.hdUpscalingIndex === idx;
                                        html += '<button onclick="app.upscaleThumbnail(\'' + item.thumbnailUrl + '\', ' + idx + ', \'playlist\')" ' + (isUpscalingPlaylist ? 'disabled' : '') + ' class="bg-indigo-500 text-white px-2 py-1 rounded text-xs font-medium hover:bg-indigo-600 ' + (isUpscalingPlaylist ? 'opacity-70' : '') + '">' + (isUpscalingPlaylist ? '<span class="animate-spin inline-block"></span>' : ' Upscale') + '</button>';
                                    }
                                    html += '</div>';
                                    html += '<div class="flex gap-2">';
                                    html += '<button onclick="app.previewThumbnail(\'' + item.thumbnailUrl + '\')" class="bg-white text-gray-800 px-2 py-1 rounded text-xs font-medium hover:bg-gray-100"> Preview</button>';
                                    html += '<button onclick="app.openThumbnailEditor(\'' + item.thumbnailUrl + '\', ' + idx + ', \'playlist\')" class="bg-purple-500 text-white px-2 py-1 rounded text-xs font-medium hover:bg-purple-600"> Edit</button>';
                                    html += '</div>';
                                    html += '</div>';
                                    html += '<div class="absolute bottom-1 left-1 bg-green-500 text-white text-xs px-1.5 py-0.5 rounded"></div>';
                                    if (item.hdUrl) {
                                        html += '<div class="absolute bottom-1 right-1 bg-blue-500 text-white text-xs px-1.5 py-0.5 rounded font-bold">HD</div>';
                                    }
                                    html += '</div>';
                                } else if (item.status === 'error') {
                                    html += '<div class="relative bg-red-50 border border-red-200 rounded-lg flex flex-col items-center justify-center group" style="aspect-ratio: 16/9;">';
                                    html += '<div class="text-red-500 text-lg"></div>';
                                    html += '<p class="text-xs text-red-600 mt-1 px-1 text-center line-clamp-1">' + utils.escapeHtml(item.error || 'Failed') + '</p>';
                                    html += '<button onclick="app.regeneratePlaylistItem(' + idx + ')" class="mt-1 text-xs bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded transition-colors"> Retry</button>';
                                    html += '</div>';
                                } else if (item.status === 'regenerating') {
                                    html += '<div class="relative bg-yellow-50 border border-yellow-200 rounded-lg flex flex-col items-center justify-center" style="aspect-ratio: 16/9;">';
                                    html += '<div class="text-yellow-500 text-xl animate-spin"></div>';
                                    html += '<p class="text-xs text-yellow-600 mt-1">Retrying...</p>';
                                    html += '</div>';
                                }
                            });
                            html += '</div>';

                            // Action buttons
                            var hdCount = state.playlistResults.filter(function(r) { return r.status === 'complete' && r.hdUrl; }).length;
                            var notHdCount = completedCount - hdCount;
                            html += '<div class="flex flex-col gap-3 mt-4">';

                            // First row - Download buttons
                            html += '<div class="flex flex-col sm:flex-row gap-3">';
                            if (completedCount > 0) {
                                html += '<button type="button" onclick="app.downloadAllAsZip(\'playlist\', false)" class="flex-1 btn-primary bg-gradient-to-r from-indigo-500 to-purple-600 inline-flex items-center justify-center gap-2">';
                                html += '<span></span> Download All (ZIP)';
                                html += '</button>';
                                if (hdCount > 0) {
                                    html += '<button type="button" onclick="app.downloadAllAsZip(\'playlist\', true)" class="flex-1 btn-primary bg-gradient-to-r from-blue-500 to-indigo-600 inline-flex items-center justify-center gap-2">';
                                    html += '<span></span> Download HD (ZIP)';
                                    html += '</button>';
                                }
                            }
                            html += '</div>';

                            // Second row - HD Upscale & other buttons
                            html += '<div class="flex flex-col sm:flex-row gap-3">';
                            if (notHdCount > 0) {
                                html += '<button type="button" onclick="app.upscaleAllThumbnails(\'playlist\')" ' + (state.hdUpscaleLoading ? 'disabled' : '') + ' class="flex-1 bg-gradient-to-r from-indigo-500 to-blue-600 hover:from-indigo-600 hover:to-blue-700 text-white font-medium py-2 px-4 rounded-lg inline-flex items-center justify-center gap-2 transition-all ' + (state.hdUpscaleLoading ? 'opacity-50 cursor-not-allowed' : '') + '">';
                                html += '<span>' + (state.hdUpscaleLoading ? '' : '') + '</span> ' + (state.hdUpscaleLoading ? 'Upscaling...' : 'Upscale All HD (' + notHdCount + ')');
                                html += '</button>';
                            }
                            if (errorCount > 0) {
                                html += '<button type="button" onclick="app.retryFailedPlaylistItems()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg inline-flex items-center justify-center gap-2 transition-colors">';
                                html += '<span></span> Retry Failed (' + errorCount + ')';
                                html += '</button>';
                            }
                            html += '<button type="button" onclick="app.clearPlaylist()" class="flex-1 btn-secondary inline-flex items-center justify-center gap-2">';
                            html += '<span></span> New Playlist';
                            html += '</button>';
                            html += '</div>';

                            html += '</div>';

                            html += '</div>';
                        } else if (state.playlistData && !state.playlistProcessing) {
                            // Show playlist with video selection
                            html += '<div class="space-y-4">';

                            // Playlist info header
                            html += '<div class="flex items-center justify-between bg-white rounded-lg p-3 border border-gray-200">';
                            html += '<div>';
                            html += '<p class="font-semibold text-gray-800"> ' + utils.escapeHtml(state.playlistData.playlistTitle) + '</p>';
                            html += '<p class="text-sm text-gray-500">by ' + utils.escapeHtml(state.playlistData.channelName) + '  ' + state.playlistData.videoCount + ' videos</p>';
                            html += '</div>';
                            html += '<button type="button" onclick="app.clearPlaylist()" class="text-sm text-red-500 hover:text-red-700">Clear</button>';
                            html += '</div>';

                            // Select all toggle
                            var allSelected = state.playlistSelectedVideos.length === state.playlistData.videos.length;
                            html += '<div class="flex items-center justify-between">';
                            html += '<button type="button" onclick="app.toggleAllPlaylistVideos()" class="flex items-center gap-2 text-sm font-medium ' + (allSelected ? 'text-indigo-600' : 'text-gray-600') + '">';
                            html += '<span class="w-5 h-5 rounded border-2 flex items-center justify-center ' + (allSelected ? 'bg-indigo-500 border-indigo-500 text-white' : 'border-gray-300') + '">';
                            html += allSelected ? '' : '';
                            html += '</span>';
                            html += 'Select All (' + state.playlistSelectedVideos.length + '/' + state.playlistData.videos.length + ')';
                            html += '</button>';
                            html += '</div>';

                            // Video list
                            html += '<div class="max-h-64 overflow-y-auto space-y-2 border border-gray-200 rounded-lg p-2 bg-gray-50">';
                            state.playlistData.videos.forEach(function(video, vidIdx) {
                                var isSelected = state.playlistSelectedVideos.indexOf(video.videoId) !== -1;
                                var isSelectMode = state.faceReferenceEnabled && state.faceReferenceSource === 'select';
                                var isSelectedFace = state.faceReferenceVideoIndex === vidIdx && state.faceReferenceImage;

                                html += '<div onclick="app.togglePlaylistVideo(\'' + video.videoId + '\')" class="flex items-center gap-3 p-2 bg-white rounded-lg cursor-pointer hover:bg-indigo-50 transition-colors ' + (isSelected ? 'ring-2 ring-indigo-500' : '') + '">';
                                html += '<span class="w-5 h-5 rounded border-2 flex items-center justify-center flex-shrink-0 ' + (isSelected ? 'bg-indigo-500 border-indigo-500 text-white' : 'border-gray-300') + '">';
                                html += isSelected ? '' : '';
                                html += '</span>';

                                // Thumbnail with Face Lock select support
                                var thumbClasses = 'w-16 h-9 object-cover rounded flex-shrink-0 transition-all ';
                                if (isSelectMode) thumbClasses += 'hover:ring-2 hover:ring-amber-400 ';
                                if (isSelectedFace) thumbClasses += 'ring-2 ring-amber-500 ';
                                html += '<img src="' + video.thumbnailUrl + '" class="' + thumbClasses + '" ';
                                if (isSelectMode) {
                                    html += 'onclick="event.stopPropagation(); app.setFaceFromVideo(' + vidIdx + ', \'playlist\')" title="Click to use this face" ';
                                }
                                html += '/>';
                                if (isSelectedFace) {
                                    html += '<span class="text-xs bg-amber-500 text-white px-1 rounded flex-shrink-0"></span>';
                                }

                                html += '<div class="flex-1 min-w-0">';
                                html += '<p class="text-sm font-medium text-gray-800 truncate">' + utils.escapeHtml(video.title) + '</p>';
                                html += '</div>';
                                html += '</div>';
                            });
                            html += '</div>';

                            // Settings section
                            html += '<div class="pt-4 border-t border-indigo-200">';
                            html += '<p class="text-sm font-semibold text-indigo-700 mb-3"> Settings (Apply to All)</p>';

                            // Visual Style
                            html += '<div class="mb-3">';
                            html += '<label class="block text-gray-600 text-sm font-medium mb-2">Visual Style</label>';
                            html += '<div class="flex flex-wrap gap-2">';
                            var playlistStyles = [
                                { id: 'professional', name: 'Professional', icon: '' },
                                { id: 'dramatic', name: 'Dramatic', icon: '' },
                                { id: 'minimal', name: 'Minimal', icon: '' },
                                { id: 'bold', name: 'Bold', icon: '' }
                            ];
                            playlistStyles.forEach(function(s) {
                                var isActive = state.thumbnailStyle === s.id;
                                var btnClass = isActive ? 'bg-indigo-500 text-white' : 'bg-white text-gray-700 border border-gray-200 hover:border-indigo-300';
                                html += '<button type="button" onclick="app.setThumbnailStyle(\'' + s.id + '\')" class="px-3 py-1.5 rounded-lg text-sm font-medium transition-all ' + btnClass + '">';
                                html += s.icon + ' ' + s.name;
                                html += '</button>';
                            });
                            html += '</div></div>';

                            // Category
                            html += '<div class="mb-3">';
                            html += '<label class="block text-gray-600 text-sm font-medium mb-2">Content Category</label>';
                            html += '<div class="flex flex-wrap gap-2">';
                            var playlistCategories = [
                                { id: 'general', name: 'General', icon: '' },
                                { id: 'gaming', name: 'Gaming', icon: '' },
                                { id: 'tutorial', name: 'Tutorial', icon: '' },
                                { id: 'vlog', name: 'Vlog', icon: '' },
                                { id: 'entertainment', name: 'Entertainment', icon: '' }
                            ];
                            playlistCategories.forEach(function(c) {
                                var isActive = state.thumbnailCategory === c.id;
                                var btnClass = isActive ? 'bg-indigo-500 text-white' : 'bg-white text-gray-700 border border-gray-200 hover:border-indigo-300';
                                html += '<button type="button" onclick="app.setThumbnailCategory(\'' + c.id + '\')" class="px-3 py-1.5 rounded-lg text-sm font-medium transition-all ' + btnClass + '">';
                                html += c.icon + ' ' + c.name;
                                html += '</button>';
                            });
                            html += '</div></div>';

                            // ========== FACE LOCK FEATURE (PLAYLIST) ==========
                            html += '<div class="mt-3 p-3 rounded-lg border-2 ' + (state.faceReferenceEnabled ? 'bg-amber-50 border-amber-300' : 'bg-gray-50 border-gray-200') + '">';
                            html += '<div class="flex items-center justify-between">';
                            html += '<div class="flex items-center gap-2">';
                            html += '<span class="text-lg">' + (state.faceReferenceEnabled ? '' : '') + '</span>';
                            html += '<div>';
                            html += '<p class="font-semibold text-sm ' + (state.faceReferenceEnabled ? 'text-amber-800' : 'text-gray-700') + '">Face Lock</p>';
                            html += '<p class="text-xs text-gray-500">Keep same person across all thumbnails</p>';
                            html += '</div>';
                            html += '</div>';
                            html += '<button type="button" onclick="app.toggleFaceReference()" class="px-3 py-1.5 rounded-lg text-sm font-medium transition-all ' + (state.faceReferenceEnabled ? 'bg-amber-500 text-white' : 'bg-gray-200 text-gray-600 hover:bg-gray-300') + '">';
                            html += state.faceReferenceEnabled ? 'ON' : 'OFF';
                            html += '</button>';
                            html += '</div>';

                            if (state.faceReferenceEnabled) {
                                html += '<div class="mt-3 pt-3 border-t border-amber-200">';
                                html += '<p class="text-xs font-medium text-amber-700 mb-2">Face Source:</p>';
                                html += '<div class="flex flex-wrap gap-2 mb-3">';
                                var playlistFaceSourceBtns = [
                                    { id: 'first', name: 'First Video', icon: '1' },
                                    { id: 'upload', name: 'Upload', icon: '' },
                                    { id: 'select', name: 'Select', icon: '' }
                                ];
                                playlistFaceSourceBtns.forEach(function(s) {
                                    var isActive = state.faceReferenceSource === s.id;
                                    var btnClass = isActive ? 'bg-amber-500 text-white' : 'bg-white text-gray-600 border border-amber-200 hover:border-amber-400';
                                    html += '<button type="button" onclick="app.setFaceReferenceSource(\'' + s.id + '\')" class="px-2 py-1 rounded text-xs font-medium transition-all ' + btnClass + '">';
                                    html += s.icon + ' ' + s.name;
                                    html += '</button>';
                                });
                                html += '</div>';

                                if (state.faceReferenceLoading) {
                                    html += '<div class="flex items-center gap-2 p-2 bg-white rounded-lg border border-amber-200">';
                                    html += '<div class="w-12 h-12 rounded-full bg-amber-100 flex items-center justify-center animate-pulse"><span class="text-amber-500"></span></div>';
                                    html += '<p class="text-xs text-amber-600">Loading face reference...</p>';
                                    html += '</div>';
                                } else if (state.faceReferenceImage) {
                                    html += '<div class="flex items-center gap-3 p-2 bg-white rounded-lg border border-amber-200">';
                                    html += '<img src="' + state.faceReferenceImage.dataUrl + '" class="w-12 h-12 rounded-full object-cover border-2 border-amber-400" />';
                                    html += '<div class="flex-1">';
                                    html += '<p class="text-xs font-medium text-amber-800"> Face reference set</p>';
                                    html += '<p class="text-xs text-amber-600">This face will appear in all thumbnails</p>';
                                    html += '</div>';
                                    html += '<button onclick="app.clearFaceReference()" class="text-xs text-red-500 hover:text-red-700"></button>';
                                    html += '</div>';
                                } else {
                                    html += '<div class="flex items-center gap-2 p-2 bg-white rounded-lg border border-dashed border-amber-300">';
                                    html += '<div class="w-12 h-12 rounded-full bg-amber-50 flex items-center justify-center"><span class="text-amber-400 text-lg"></span></div>';
                                    html += '<p class="text-xs text-amber-600">Select a face source above</p>';
                                    html += '</div>';
                                }
                                html += '</div>';
                            }
                            html += '</div>';

                            html += '</div>';

                            // Cost and generate button
                            if (state.playlistSelectedVideos.length > 0) {
                                var playlistCost = app.calculatePlaylistCost();
                                html += '<div class="mt-4 p-4 bg-indigo-50 rounded-lg border border-indigo-200">';
                                html += '<div class="flex items-center justify-between mb-3">';
                                html += '<div>';
                                html += '<p class="font-semibold text-gray-800">' + state.playlistSelectedVideos.length + ' video' + (state.playlistSelectedVideos.length > 1 ? 's' : '') + ' selected</p>';
                                html += '<p class="text-sm text-gray-500">Cost: ' + playlistCost + ' tokens (4 each)</p>';
                                html += '</div>';
                                html += '<div class="text-right">';
                                html += '<p class="text-xs text-gray-500">Balance</p>';
                                html += '<p class="font-bold ' + (state.thumbnailTokenBalance >= playlistCost ? 'text-green-600' : 'text-red-500') + '">' + state.thumbnailTokenBalance + ' tokens</p>';
                                html += '</div>';
                                html += '</div>';
                                html += '<button type="button" onclick="app.processPlaylist()" ' + (state.thumbnailTokenBalance < playlistCost ? 'disabled' : '') + ' class="w-full btn-primary bg-gradient-to-r from-indigo-500 to-purple-600 py-3 inline-flex items-center justify-center gap-2">';
                                html += '<span></span> Generate All Thumbnails (' + playlistCost + ' tokens)';
                                html += '</button>';
                                if (state.thumbnailTokenBalance < playlistCost) {
                                    html += '<p class="text-xs text-red-500 mt-2 text-center">Insufficient tokens. You need ' + (playlistCost - state.thumbnailTokenBalance) + ' more tokens.</p>';
                                }
                                html += '</div>';
                            }

                            html += '</div>';
                        } else if (state.playlistProcessing) {
                            // Show processing progress
                            var doneCount = state.playlistResults.filter(function(r) { return r.status === 'complete' || r.status === 'error'; }).length;
                            var totalCount = state.playlistSelectedVideos.length;

                            html += '<div class="space-y-4">';
                            html += '<div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4">';
                            html += '<div class="flex items-center gap-3">';
                            html += '<div class="animate-spin text-2xl"></div>';
                            html += '<div>';
                            html += '<p class="font-semibold text-indigo-800">Processing Playlist...</p>';
                            html += '<p class="text-sm text-indigo-600">' + doneCount + ' of ' + totalCount + ' complete</p>';
                            html += '</div>';
                            html += '</div>';
                            html += '<div class="mt-3 bg-indigo-200 rounded-full h-2 overflow-hidden">';
                            html += '<div class="bg-indigo-500 h-full transition-all" style="width: ' + (totalCount > 0 ? (doneCount / totalCount * 100) : 0) + '%;"></div>';
                            html += '</div>';
                            html += '</div>';

                            // Show progress list
                            if (state.playlistResults.length > 0) {
                                html += '<div class="max-h-64 overflow-y-auto space-y-2">';
                                state.playlistResults.forEach(function(item, idx) {
                                    var statusIcon = item.status === 'generating' ? '' : (item.status === 'complete' ? '' : '');
                                    var statusColor = item.status === 'generating' ? 'text-blue-500' : (item.status === 'complete' ? 'text-green-500' : 'text-red-500');
                                    html += '<div class="flex items-center gap-2 p-2 bg-white rounded-lg border border-gray-200">';
                                    html += '<span class="' + statusColor + ' ' + (item.status === 'generating' ? 'animate-pulse' : '') + '">' + statusIcon + '</span>';
                                    // Show thumbnail preview if complete
                                    if (item.status === 'complete' && item.thumbnailUrl) {
                                        html += '<img src="' + item.thumbnailUrl + '" class="w-12 h-7 object-cover rounded" />';
                                    }
                                    html += '<span class="text-sm text-gray-700 truncate flex-1">' + utils.escapeHtml(item.title || 'Video') + '</span>';
                                    // Download buttons for completed items
                                    if (item.status === 'complete' && item.thumbnailUrl) {
                                        if (item.hdUrl) {
                                            html += '<span class="text-xs bg-blue-500 text-white px-1.5 py-0.5 rounded font-bold flex-shrink-0">HD</span>';
                                        }
                                        html += '<button type="button" onclick="event.stopPropagation(); app.downloadThumbnail(\'' + item.thumbnailUrl + '\', ' + idx + ')" class="text-xs bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600 flex-shrink-0"></button>';
                                        if (item.hdUrl) {
                                            html += '<button type="button" onclick="event.stopPropagation(); app.downloadHdThumbnail(\'' + item.hdUrl + '\', ' + idx + ')" class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 flex-shrink-0"></button>';
                                        }
                                        html += '<button type="button" onclick="event.stopPropagation(); app.previewThumbnail(\'' + item.thumbnailUrl + '\')" class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded hover:bg-gray-300 flex-shrink-0"></button>';
                                    }
                                    html += '</div>';
                                });
                                html += '</div>';

                                // Download All ZIP button during processing
                                var completedPlaylistCount = state.playlistResults.filter(function(r) { return r.status === 'complete' && r.thumbnailUrl; }).length;
                                if (completedPlaylistCount > 0) {
                                    html += '<div class="mt-3 p-3 bg-green-50 rounded-lg border border-green-200 flex items-center justify-between">';
                                    html += '<span class="text-sm text-green-700">' + completedPlaylistCount + ' ready for download</span>';
                                    html += '<button type="button" onclick="app.downloadAllAsZip(\'playlist\', false)" class="bg-green-500 text-white px-3 py-1.5 rounded-lg text-sm font-medium hover:bg-green-600 flex items-center gap-1">';
                                    html += '<span></span> Download ZIP';
                                    html += '</button>';
                                    html += '</div>';
                                }
                            }

                            html += '</div>';
                        } else {
                            // Show playlist URL input
                            html += '<div class="space-y-3">';
                            html += '<p class="text-sm text-gray-600">Paste a YouTube playlist URL to upgrade all thumbnails at once.</p>';
                            html += '<div class="flex gap-2">';
                            html += '<input type="text" placeholder="https://youtube.com/playlist?list=..." value="' + (state.playlistUrl || '') + '" onchange="app.setPlaylistUrl(this.value)" oninput="app.setPlaylistUrl(this.value)" class="flex-1 px-4 py-3 bg-white border border-gray-200 rounded-lg focus:border-indigo-400 focus:ring-2 focus:ring-indigo-100 outline-none" />';
                            html += '<button type="button" onclick="app.fetchPlaylist()" ' + (state.playlistLoading ? 'disabled' : '') + ' class="px-5 py-3 bg-indigo-500 text-white rounded-lg font-medium hover:bg-indigo-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all whitespace-nowrap">';
                            html += state.playlistLoading ? ' Loading...' : ' Fetch';
                            html += '</button>';
                            html += '</div>';
                            html += '<p class="text-xs text-gray-500">Supports: youtube.com/playlist?list=..., youtube.com/watch?v=...&list=...</p>';
                            if (state.playlistError) {
                                html += '<p class="text-sm text-red-500 bg-red-50 px-3 py-2 rounded-lg"> ' + utils.escapeHtml(state.playlistError) + '</p>';
                            }
                            html += '</div>';
                        }
                    }

                    html += '</div>';

                    // Info box about upgrade process
                    if (state.thumbnailReference && state.thumbnailUpgradeMode !== 'bulk' && state.thumbnailUpgradeMode !== 'playlist') {
                        html += '<div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">';
                        html += '<p class="text-sm text-blue-800">';
                        html += '<span class="font-semibold"> How Upgrade Works:</span> AI will analyze your existing thumbnail and create an enhanced version with better lighting, sharper details, improved colors, and professional composition while keeping the same subject and concept.';
                        html += '</p>';
                        html += '</div>';
                    }
                }

                // ========== ADVANCED OPTIONS TOGGLE ==========
                html += '<div class="mb-4">';
                html += '<button type="button" onclick="app.toggleAdvancedOptions()" class="flex items-center gap-2 text-gray-600 hover:text-pink-600 transition-colors">';
                html += '<span class="text-lg">' + (state.showAdvancedOptions ? '' : '') + '</span>';
                html += '<span class="font-medium">Advanced Options</span>';
                html += '<span class="text-xs bg-gray-100 px-2 py-0.5 rounded">Pro Tips</span>';
                html += '</button>';
                html += '</div>';

                // ========== ADVANCED OPTIONS PANEL ==========
                if (state.showAdvancedOptions) {
                    html += '<div class="mb-6 p-4 bg-gray-50 rounded-xl border border-gray-200 space-y-4">';

                    // Composition Template
                    html += '<div>';
                    html += '<label class="block text-gray-700 font-semibold mb-3"> Composition Template</label>';
                    html += '<div class="grid grid-cols-2 md:grid-cols-3 gap-2">';

                    var compositions = [
                        { id: 'auto', name: 'Auto', icon: '', desc: 'AI decides' },
                        { id: 'face-right', name: 'Face Right', icon: '', desc: 'Best for vloggers' },
                        { id: 'face-center', name: 'Face Center', icon: '', desc: 'Bold impact' },
                        { id: 'split-screen', name: 'Split Screen', icon: '', desc: 'Before/After' },
                        { id: 'product-hero', name: 'Product Hero', icon: '', desc: 'Clean spotlight' },
                        { id: 'action-shot', name: 'Action Shot', icon: '', desc: 'Dynamic energy' }
                    ];

                    compositions.forEach(function(comp) {
                        var isActive = state.thumbnailComposition === comp.id;
                        var btnClass = isActive ? 'border-pink-500 bg-pink-50' : 'border-gray-200 hover:border-pink-300';
                        html += '<div onclick="app.setThumbnailComposition(\'' + comp.id + '\')" class="cursor-pointer p-2 border-2 ' + btnClass + ' rounded-lg text-center transition-all">';
                        html += '<div class="text-lg">' + comp.icon + '</div>';
                        html += '<p class="font-medium text-gray-800 text-xs">' + comp.name + '</p>';
                        html += '<p class="text-xs text-gray-500">' + comp.desc + '</p>';
                        html += '</div>';
                    });
                    html += '</div></div>';

                    // Background Style
                    html += '<div>';
                    html += '<label class="block text-gray-700 font-semibold mb-3"> Background Style</label>';
                    html += '<div class="flex flex-wrap gap-2">';

                    var backgrounds = [
                        { id: 'auto', name: 'Auto' },
                        { id: 'studio', name: 'Studio' },
                        { id: 'blur', name: 'Blur/Bokeh' },
                        { id: 'gradient', name: 'Gradient' },
                        { id: 'dark', name: 'Dark' },
                        { id: 'vibrant', name: 'Vibrant' }
                    ];

                    backgrounds.forEach(function(bg) {
                        var isActive = state.thumbnailBackground === bg.id;
                        var btnClass = isActive ? 'bg-pink-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-pink-100';
                        html += '<button type="button" onclick="app.setThumbnailBackground(\'' + bg.id + '\')" class="px-3 py-1.5 rounded-full font-medium transition-all text-sm ' + btnClass + '">' + bg.name + '</button>';
                    });
                    html += '</div></div>';

                    html += '</div>';
                }

                // ========== TITLE INPUT ==========
                // Hide form elements when in bulk or playlist mode (they have their own UI)
                if (!(state.thumbnailMode === 'upgrade' && (state.thumbnailUpgradeMode === 'bulk' || state.thumbnailUpgradeMode === 'playlist'))) {
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-2">Video Title</label>';

                // Use state.thumbnailTitle (from YouTube) if available, otherwise suggestedTitle
                var titleValue = state.thumbnailTitle || suggestedTitle;
                var isYoutubeTitle = state.titleAutoFilled && state.thumbnailTitle;

                html += '<input type="text" id="thumbnail-title" value="' + utils.escapeHtml(titleValue) + '" placeholder="Enter your video title..." oninput="state.thumbnailTitle = this.value; state.titleAutoFilled = false;" class="w-full px-4 py-3 border-2 ' + (isYoutubeTitle ? 'border-green-300 bg-green-50' : 'border-gray-200') + ' rounded-xl focus:border-pink-500 focus:outline-none text-lg" ' + (state.thumbnailMode === 'upgrade' && state.thumbnailYoutubeData ? '' : 'required') + ' />';

                // Show indicator for YouTube auto-fill
                if (isYoutubeTitle) {
                    html += '<p class="text-sm text-green-600 mt-2 flex items-center gap-1"><span></span> Auto-filled from YouTube  Edit if needed for better SEO</p>';
                } else if (hasVideoContext && optimizedTitles.length > 1) {
                    html += '<p class="text-sm text-gray-500 mt-2"> Or try: <span class="text-pink-600 cursor-pointer hover:underline" onclick="document.getElementById(\'thumbnail-title\').value=\'' + utils.escapeHtml(optimizedTitles[1]).replace(/'/g, "\\'") + '\'">' + utils.escapeHtml(optimizedTitles[1]) + '</span></p>';
                } else if (state.thumbnailMode === 'upgrade' && state.thumbnailYoutubeData && !state.thumbnailTitle) {
                    html += '<p class="text-sm text-amber-600 mt-2"> Title unavailable from YouTube - please enter one for best results</p>';
                }
                html += '</div>';

                // ========== CONTENT CATEGORY ==========
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-3">Content Category</label>';
                html += '<div class="flex flex-wrap gap-2">';

                var categories = [
                    { id: 'general', name: 'General', icon: '' },
                    { id: 'gaming', name: 'Gaming', icon: '' },
                    { id: 'tutorial', name: 'Tutorial', icon: '' },
                    { id: 'vlog', name: 'Vlog', icon: '' },
                    { id: 'review', name: 'Review', icon: '' },
                    { id: 'news', name: 'News', icon: '' },
                    { id: 'entertainment', name: 'Entertainment', icon: '' }
                ];

                categories.forEach(function(c) {
                    var isActive = state.thumbnailCategory === c.id;
                    var btnClass = isActive ? 'bg-pink-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-pink-100';
                    html += '<button type="button" data-category-btn="' + c.id + '" onclick="app.setThumbnailCategory(\'' + c.id + '\')" class="px-4 py-2 rounded-full font-medium transition-all ' + btnClass + '">';
                    html += c.icon + ' ' + c.name;
                    html += '</button>';
                });
                html += '</div></div>';

                // ========== STYLE SELECTION ==========
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-3">Visual Style</label>';
                html += '<div class="grid grid-cols-2 lg:grid-cols-4 gap-3">';

                var styles = [
                    { id: 'professional', name: 'Professional', icon: '', desc: 'Clean & sharp' },
                    { id: 'dramatic', name: 'Dramatic', icon: '', desc: 'Bold & intense' },
                    { id: 'minimal', name: 'Minimal', icon: '', desc: 'Simple & elegant' },
                    { id: 'bold', name: 'Bold', icon: '', desc: 'Eye-catching' }
                ];

                styles.forEach(function(s) {
                    var isActive = state.thumbnailStyle === s.id;
                    var borderClass = isActive ? 'border-pink-500 bg-pink-50' : 'border-gray-200 hover:border-pink-300';
                    html += '<div data-style-card="' + s.id + '" onclick="app.setThumbnailStyle(\'' + s.id + '\')" class="cursor-pointer p-3 border-2 ' + borderClass + ' rounded-xl text-center transition-all">';
                    html += '<div class="text-2xl mb-1">' + s.icon + '</div>';
                    html += '<p class="font-semibold text-gray-800 text-sm">' + s.name + '</p>';
                    html += '<p class="text-xs text-gray-500">' + s.desc + '</p>';
                    html += '</div>';
                });
                html += '</div></div>';

                // ========== VARIATIONS SELECTOR ==========
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-3">Number of Variations</label>';
                html += '<div class="flex items-center gap-4">';
                html += '<div class="flex gap-2">';
                for (var v = 1; v <= 4; v++) {
                    var isActive = state.thumbnailVariations === v;
                    var btnClass = isActive ? 'bg-pink-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-pink-100';
                    html += '<button type="button" data-variation-btn="' + v + '" onclick="app.setThumbnailVariations(' + v + ')" class="w-12 h-12 rounded-xl font-bold text-lg transition-all ' + btnClass + '">' + v + '</button>';
                }
                html += '</div>';
                html += '<div class="text-sm text-gray-500">';
                html += '<span class="font-medium">Cost:</span> <span id="thumbnail-cost-calc">' + modeCosts[state.thumbnailMode] + '  ' + state.thumbnailVariations + ' = </span><span id="thumbnail-cost-display" class="font-bold text-pink-600">' + currentCost + '</span><span class="font-bold text-pink-600"> tokens</span>';
                html += '</div>';
                html += '</div></div>';

                // ========== CUSTOM PROMPT ==========
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-2">Additional Details <span class="text-gray-400 font-normal">(Optional)</span></label>';
                html += '<textarea id="thumbnail-prompt" placeholder="e.g., Include a person looking surprised, bright red arrow pointing right, space for text on the left side..." class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-500 focus:outline-none h-20"></textarea>';
                html += '</div>';

                // ========== COST SUMMARY & SUBMIT ==========
                html += '<div class="bg-gradient-to-r from-pink-50 to-purple-50 p-4 rounded-xl mb-6">';
                html += '<div class="flex items-center justify-between">';
                html += '<div>';
                html += '<p class="font-semibold text-gray-800">Generation Cost</p>';
                html += '<p class="text-sm text-gray-600"><span id="thumbnail-image-count">' + state.thumbnailVariations + ' image' + (state.thumbnailVariations > 1 ? 's' : '') + '</span>  ' + modeCosts[state.thumbnailMode] + ' tokens</p>';
                html += '</div>';
                html += '<div class="text-right">';
                html += '<p id="thumbnail-cost-total" class="text-3xl font-bold text-pink-600">' + currentCost + '</p>';
                html += '<p class="text-sm text-gray-500">tokens</p>';
                html += '</div>';
                html += '</div>';
                html += '<div id="thumbnail-token-warning" class="mt-3 p-2 bg-red-100 border border-red-200 rounded-lg text-red-700 text-sm ' + (state.thumbnailTokenBalance < currentCost ? '' : 'hidden') + '">';
                html += ' Insufficient tokens. You have ' + state.thumbnailTokenBalance + ' but need ' + currentCost + '.';
                html += '</div>';
                html += '</div>';

                // Submit Button
                var canSubmit = !state.loading && state.thumbnailTokenBalance >= currentCost;
                if (state.thumbnailMode === 'reference' && !state.thumbnailReference) {
                    canSubmit = false;
                }

                html += '<button type="submit" id="thumbnail-submit-btn" class="w-full btn-primary bg-gradient-to-r from-pink-500 to-rose-600 text-lg py-4 disabled:opacity-50 disabled:cursor-not-allowed" ' + (!canSubmit ? 'disabled' : '') + '>';
                if (state.loading) {
                    html += ' Generating...';
                } else if (state.thumbnailMode === 'reference' && !state.thumbnailReference) {
                    html += ' Upload Reference Image First';
                } else if (state.thumbnailTokenBalance < currentCost) {
                    html += ' Insufficient Tokens';
                } else {
                    html += ' Generate ' + state.thumbnailVariations + ' Thumbnail' + (state.thumbnailVariations > 1 ? 's' : '') + ' (' + currentCost + ' tokens)';
                }
                html += '</button>';
                } // End bulk mode check
                html += '</form>';
            }

            html += '</div>'; // End main card

            // YouTube Preview Modal
            if (state.showYouTubePreview && state.generatedThumbnails.length > 0) {
                var previewImg = state.generatedThumbnails[state.selectedThumbnailIndex];
                html += '<div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4" onclick="app.toggleYouTubePreview()">';
                html += '<div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-auto p-6" onclick="event.stopPropagation()">';
                html += '<div class="flex items-center justify-between mb-6">';
                html += '<h3 class="text-xl font-bold text-gray-800"> YouTube Preview</h3>';
                html += '<button onclick="app.toggleYouTubePreview()" class="text-gray-500 hover:text-gray-700 text-2xl"></button>';
                html += '</div>';

                // Search Results Preview
                html += '<div class="mb-6">';
                html += '<p class="text-sm text-gray-500 mb-2 font-medium">Search Results</p>';
                html += '<div class="flex gap-4 p-4 bg-gray-50 rounded-xl">';
                html += '<img src="' + utils.escapeHtml(previewImg.url) + '" class="w-40 h-24 object-cover rounded-lg flex-shrink-0" />';
                html += '<div>';
                html += '<p class="font-semibold text-gray-900 line-clamp-2">Your Video Title Here...</p>';
                html += '<p class="text-sm text-gray-600">Your Channel  1.2M views  2 days ago</p>';
                html += '</div>';
                html += '</div>';
                html += '</div>';

                // Suggested Sidebar Preview
                html += '<div class="mb-6">';
                html += '<p class="text-sm text-gray-500 mb-2 font-medium">Suggested Videos Sidebar</p>';
                html += '<div class="flex gap-3 p-3 bg-gray-50 rounded-xl">';
                html += '<img src="' + utils.escapeHtml(previewImg.url) + '" class="w-28 h-16 object-cover rounded flex-shrink-0" />';
                html += '<div class="text-sm">';
                html += '<p class="font-medium text-gray-900 line-clamp-2">Your Video Title...</p>';
                html += '<p class="text-xs text-gray-600">Your Channel</p>';
                html += '<p class="text-xs text-gray-500">500K views</p>';
                html += '</div>';
                html += '</div>';
                html += '</div>';

                // Mobile Preview
                html += '<div class="mb-6">';
                html += '<p class="text-sm text-gray-500 mb-2 font-medium"> Mobile Feed</p>';
                html += '<div class="max-w-xs mx-auto bg-gray-50 rounded-xl overflow-hidden">';
                html += '<img src="' + utils.escapeHtml(previewImg.url) + '" class="w-full aspect-video object-cover" />';
                html += '<div class="p-3">';
                html += '<p class="font-medium text-gray-900 text-sm">Your Video Title Here...</p>';
                html += '<p class="text-xs text-gray-600">Your Channel  500K views</p>';
                html += '</div>';
                html += '</div>';
                html += '</div>';

                html += '<button onclick="app.toggleYouTubePreview()" class="w-full btn-secondary">Close Preview</button>';
                html += '</div>';
                html += '</div>';
            }

            // ========== THUMBNAIL EDITING MODAL ==========
            if (state.thumbnailEditMode && state.thumbnailEditingImage) {
                html += '<div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">';
                html += '<div class="bg-white rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col" onclick="event.stopPropagation()">';

                // Header
                html += '<div class="p-4 border-b flex items-center justify-between bg-gradient-to-r from-purple-50 to-pink-50">';
                html += '<div class="flex items-center gap-3">';
                html += '<div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center text-xl"></div>';
                html += '<div>';
                html += '<h3 class="text-xl font-bold text-gray-800">Edit Thumbnail with AI</h3>';
                html += '<p class="text-sm text-gray-500">Describe your edit - painting is optional</p>';
                html += '</div>';
                html += '</div>';
                html += '<button onclick="app.closeThumbnailEditor()" class="text-gray-400 hover:text-gray-600 text-2xl p-2 hover:bg-gray-100 rounded-lg transition-colors">&times;</button>';
                html += '</div>';

                // Main content
                html += '<div class="flex-1 overflow-y-auto p-6">';

                // Error display
                if (state.thumbnailEditError) {
                    html += '<div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-xl text-red-700 text-sm flex items-center gap-2">';
                    html += '<span></span> ' + utils.escapeHtml(state.thumbnailEditError);
                    html += '</div>';
                }

                // Show comparison if we have a result
                if (state.thumbnailEditResult) {
                    html += '<div class="mb-6">';
                    html += '<div class="text-center mb-4">';
                    html += '<span class="inline-block bg-green-100 text-green-700 px-4 py-2 rounded-full font-semibold"> Edit Complete! Review the changes</span>';
                    html += '</div>';

                    // Before/After comparison
                    html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';

                    // Before
                    html += '<div class="text-center">';
                    html += '<p class="text-sm font-semibold text-gray-600 mb-2">Before</p>';
                    html += '<img src="' + utils.escapeHtml(state.thumbnailEditResult.originalUrl) + '" class="w-full rounded-xl shadow-lg border-2 border-gray-200" style="max-height: 350px; object-fit: contain;" />';
                    html += '</div>';

                    // After
                    html += '<div class="text-center">';
                    html += '<p class="text-sm font-semibold text-green-600 mb-2">After (Edited)</p>';
                    html += '<img src="' + utils.escapeHtml(state.thumbnailEditResult.editedUrl) + '" class="w-full rounded-xl shadow-lg border-2 border-green-400" style="max-height: 350px; object-fit: contain;" />';
                    html += '</div>';

                    html += '</div>';
                    html += '</div>';

                } else {
                    // Show canvas for painting
                    html += '<div class="mb-6">';
                    html += '<div class="relative bg-gray-100 rounded-xl p-4 flex justify-center">';
                    html += '<canvas id="thumbnail-edit-canvas" class="max-w-full rounded-xl shadow-lg cursor-crosshair" style="max-height: 400px;"></canvas>';
                    if (state.thumbnailEditLoading) {
                        html += '<div class="absolute inset-0 bg-white/80 flex flex-col items-center justify-center rounded-xl">';
                        html += '<div class="loading-emoji text-4xl mb-4"></div>';
                        html += '<p class="font-semibold text-gray-700">AI is editing your thumbnail...</p>';
                        html += '<p class="text-sm text-gray-500">This may take 10-20 seconds</p>';
                        html += '</div>';
                    }
                    html += '</div>';
                    html += '</div>';

                    // Brush controls
                    html += '<div class="mb-4 p-4 bg-gray-50 rounded-xl">';
                    html += '<div class="flex flex-wrap items-center justify-center gap-4">';

                    // Brush size slider
                    html += '<div class="flex items-center gap-2">';
                    html += '<label class="text-sm font-medium text-gray-600"> Brush Size:</label>';
                    html += '<input type="range" min="10" max="100" value="' + state.thumbnailEditBrushSize + '" oninput="app.setEditBrushSize(this.value); document.getElementById(\'brush-size-label\').textContent = this.value + \'px\'" class="w-32 accent-pink-500" />';
                    html += '<span id="brush-size-label" class="text-sm text-gray-500 w-12">' + state.thumbnailEditBrushSize + 'px</span>';
                    html += '</div>';

                    // Action buttons
                    html += '<button type="button" onclick="app.clearEditMask()" class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition-colors">';
                    html += ' Clear';
                    html += '</button>';

                    html += '<button type="button" onclick="app.undoEditMask()" class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-100 transition-colors">';
                    html += ' Undo';
                    html += '</button>';

                    html += '</div>';
                    html += '<p class="text-xs text-gray-400 text-center mt-2"> <strong>Optional:</strong> Paint to select specific areas, or skip to edit the entire image</p>';
                    html += '</div>';

                    // Edit prompt input
                    html += '<div class="mb-4">';
                    html += '<label class="block text-gray-700 font-semibold mb-2">What should AI change? <span class="text-pink-500">*</span></label>';
                    html += '<input type="text" id="thumbnail-edit-prompt" placeholder="e.g., Change \'dreams\' to \'dream\', remove the arrow, make text bigger, add a glow effect..." value="' + utils.escapeHtml(state.thumbnailEditPrompt) + '" oninput="app.setEditPrompt(this.value)" class="w-full p-3 border border-gray-200 rounded-xl focus:border-pink-500 focus:ring-2 focus:ring-pink-200 outline-none transition-all" />';
                    html += '<p class="text-xs text-gray-400 mt-1">Describe what you want to change. If you painted an area, the edit will focus there.</p>';
                    html += '</div>';

                    // Example prompts
                    html += '<div class="mb-4">';
                    html += '<p class="text-xs text-gray-500 mb-2">Quick examples:</p>';
                    html += '<div class="flex flex-wrap gap-2">';
                    var examples = ["Fix the typo", "Remove this text", "Change text to: ", "Make it brighter", "Add glow effect", "Remove the object"];
                    examples.forEach(function(ex) {
                        html += '<button type="button" onclick="app.setEditPrompt(\'' + ex + '\'); document.getElementById(\'thumbnail-edit-prompt\').value = \'' + ex + '\';" class="px-2 py-1 bg-gray-100 hover:bg-pink-100 text-gray-600 hover:text-pink-600 rounded text-xs transition-colors">' + ex + '</button>';
                    });
                    html += '</div>';
                    html += '</div>';
                }

                html += '</div>';

                // Footer
                html += '<div class="p-4 border-t flex items-center justify-between bg-gray-50">';
                html += '<div class="text-sm text-gray-500">Cost: <span class="font-semibold text-pink-600">2 tokens</span> per edit</div>';
                html += '<div class="flex gap-3">';

                if (state.thumbnailEditResult) {
                    // After edit - show accept/revert buttons
                    html += '<button type="button" onclick="app.revertEdit()" class="px-4 py-2 bg-white border border-gray-300 rounded-lg font-medium text-gray-600 hover:bg-gray-100 transition-colors">';
                    html += ' Try Again';
                    html += '</button>';
                    html += '<button type="button" onclick="app.acceptEdit()" class="px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-semibold rounded-lg shadow-lg transition-all">';
                    html += ' Accept Edit';
                    html += '</button>';
                } else {
                    // Before edit - show cancel/apply buttons
                    html += '<button type="button" onclick="app.closeThumbnailEditor()" class="px-4 py-2 bg-white border border-gray-300 rounded-lg font-medium text-gray-600 hover:bg-gray-100 transition-colors">';
                    html += 'Cancel';
                    html += '</button>';
                    html += '<button type="button" onclick="app.applyThumbnailEdit()" ' + (state.thumbnailEditLoading ? 'disabled' : '') + ' class="px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white font-semibold rounded-lg shadow-lg transition-all ' + (state.thumbnailEditLoading ? 'opacity-50 cursor-not-allowed' : '') + '">';
                    html += state.thumbnailEditLoading ? ' Processing...' : ' Apply Edit';
                    html += '</button>';
                }

                html += '</div>';
                html += '</div>';

                html += '</div>';
                html += '</div>';
            }

            html += '</div></div>';
            return html;
        }

        /* ------------------------------------------
           4.6.12 Placement Finder View
           ------------------------------------------ */
        function renderPlacement() {
            var html = '';
            var results = state.placementResults;

            html += '<div class="min-h-screen mobile-full-screen py-8 px-4 mobile-wide-container">';
            html += '<div class="max-w-6xl mx-auto">';

            // Navigation buttons
            html += '<div class="flex flex-wrap gap-3 mb-6">';
            html += '<button onclick="app.goToDashboard()" class="btn-secondary"> Back to Dashboard</button>';
            html += '</div>';

            // Header
            html += '<div class="text-center mb-8 fade-in">';
            html += '<div class="w-20 h-20 bg-gradient-to-br from-purple-500 to-violet-600 rounded-3xl flex items-center justify-center text-5xl mx-auto mb-4 shadow-xl"></div>';
            html += '<h1 class="text-3xl lg:text-4xl font-bold text-white mb-2">Placement Finder</h1>';
            html += '<p class="text-white/80 text-lg">Find successful YouTube channels for your Google Ads placements</p>';
            html += '</div>';

            // Copy Success Toast
            if (state.copySuccess) {
                html += '<div class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-xl shadow-xl z-50 fade-in">';
                html += ' ' + utils.escapeHtml(state.copySuccess);
                html += '</div>';
            }

            // Error Message
            if (state.error) {
                html += '<div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-xl text-red-700">' + utils.escapeHtml(state.error.message) + '</div>';
            }

            // Loading Section
            if (state.loading && !results) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 lg:p-8 mobile-padding mb-6 fade-in">';
                html += '<div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">';
                html += '<div class="flex items-center gap-4"><div class="loading-emoji"></div><div><h3 class="text-xl font-bold text-gray-800">Finding Placement Channels</h3><p class="text-gray-500">Analyzing your channel and finding matches...</p></div></div>';
                html += '<div class="progress-percentage">' + Math.round(state.loadingProgress) + '%</div>';
                html += '</div>';
                html += '<div class="progress-bar-container mb-6"><div class="progress-bar-fill" style="width:' + state.loadingProgress + '%"></div></div>';
                html += '<div class="grid grid-cols-2 md:grid-cols-3 gap-3">';
                for (var li = 0; li < state.loadingSteps.length; li++) {
                    var lstep = state.loadingSteps[li];
                    var lstepClass = li < state.loadingStep ? 'completed' : li === state.loadingStep ? 'active' : 'pending';
                    html += '<div class="loading-step ' + lstepClass + '">';
                    html += '<div class="step-icon ' + lstepClass + '">' + (lstepClass === 'completed' ? '' : lstep.icon) + '</div>';
                    html += '<span class="text-sm font-medium">' + lstep.name + '</span>';
                    html += '</div>';
                }
                html += '</div></div>';
            }

            // Input Form (show when no results)
            if (!results && !state.loading) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 lg:p-8 mobile-padding fade-in">';
                html += '<div class="max-w-xl mx-auto">';

                html += '<div class="text-center mb-6">';
                html += '<p class="text-gray-600 text-lg">Enter your YouTube channel link and we\'ll find successful channels whose audience may like your content.</p>';
                html += '</div>';

                html += '<form onsubmit="app.findPlacements(event)">';
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-2">Your YouTube Channel URL</label>';
                html += '<input type="text" id="placement-channel-url" placeholder="https://youtube.com/@yourchannel" class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-lg" required />';
                html += '<p class="text-sm text-gray-500 mt-2">Supports: youtube.com/@handle, youtube.com/channel/..., youtube.com/c/...</p>';
                html += '</div>';

                html += '<button type="submit" class="w-full py-4 bg-gradient-to-r from-purple-500 to-violet-600 text-white font-bold rounded-xl hover:from-purple-600 hover:to-violet-700 transition-all shadow-lg hover:shadow-xl text-lg">';
                html += ' Find Placement Channels';
                html += '</button>';
                html += '</form>';

                // Tips Section
                html += '<div class="mt-8 bg-gradient-to-r from-purple-50 to-violet-50 p-5 rounded-xl">';
                html += '<h4 class="font-semibold text-gray-800 mb-3"> What is Placement Targeting?</h4>';
                html += '<ul class="text-sm text-gray-600 space-y-2">';
                html += '<li> <strong>Google Ads Placements</strong> let you show ads on specific YouTube channels</li>';
                html += '<li> Find channels with audiences similar to your content</li>';
                html += '<li> Copy channel URLs directly into your Google Ads campaign</li>';
                html += '<li> Target viewers who are already interested in your niche</li>';
                html += '</ul>';
                html += '</div>';

                html += '</div></div>';
            }

            // Results Section
            if (results && results.placements) {
                var placements = results.placements;
                var channelInfo = results.channelInfo || {};
                var analysis = results.analysis || {};

                // Channel Info Card
                html += '<div class="bg-white/10 backdrop-blur rounded-2xl p-5 mb-6 fade-in">';
                html += '<div class="flex flex-wrap items-center gap-4">';
                if (channelInfo.thumbnail) {
                    html += '<img src="' + utils.escapeHtml(channelInfo.thumbnail) + '" class="w-16 h-16 object-cover rounded-full" />';
                }
                html += '<div class="flex-1 min-w-[200px]">';
                html += '<p class="text-white font-bold text-lg">' + utils.escapeHtml(channelInfo.name || 'Your Channel') + '</p>';
                html += '<p class="text-white/70">' + utils.escapeHtml(analysis.niche || '') + '</p>';
                if (analysis.audienceDescription) {
                    html += '<p class="text-white/60 text-sm mt-1"> ' + utils.escapeHtml(analysis.audienceDescription) + '</p>';
                }
                html += '</div>';
                html += '<div class="bg-green-500 text-white px-4 py-2 rounded-full font-bold">';
                html += ' ' + placements.length + ' Channels Found';
                html += '</div>';
                html += '</div></div>';

                // Action Buttons
                html += '<div class="flex flex-wrap gap-3 mb-6">';
                html += '<button onclick="app.copyAllPlacements()" class="btn-primary bg-gradient-to-r from-green-500 to-emerald-600 flex items-center gap-2">';
                html += '<span></span> Copy All ' + placements.length + ' Channels';
                html += '</button>';
                if (placements.length < 50) {
                    html += '<button onclick="app.findMorePlacements()" class="btn-secondary flex items-center gap-2" ' + (state.placementLoading ? 'disabled' : '') + '>';
                    if (state.placementLoading) {
                        html += '<span class="animate-spin"></span> Finding...';
                    } else {
                        html += '<span></span> Find 10 More (' + (50 - placements.length) + ' remaining)';
                    }
                    html += '</button>';
                }
                html += '<button onclick="app.goToPlacement()" class="btn-secondary flex items-center gap-2">';
                html += '<span></span> New Search';
                html += '</button>';
                html += '</div>';

                // Results Grid
                html += '<div class="bg-white rounded-2xl shadow-xl p-4 lg:p-6 fade-in">';
                html += '<div class="overflow-x-auto">';
                html += '<table class="w-full">';
                html += '<thead>';
                html += '<tr class="border-b-2 border-gray-100">';
                html += '<th class="text-left py-3 px-2 text-gray-600 font-semibold">#</th>';
                html += '<th class="text-left py-3 px-2 text-gray-600 font-semibold">Channel</th>';
                html += '<th class="text-left py-3 px-2 text-gray-600 font-semibold hidden md:table-cell">Subscribers</th>';
                html += '<th class="text-left py-3 px-2 text-gray-600 font-semibold hidden lg:table-cell">Score</th>';
                html += '<th class="text-right py-3 px-2 text-gray-600 font-semibold">Actions</th>';
                html += '</tr>';
                html += '</thead>';
                html += '<tbody>';

                for (var i = 0; i < placements.length; i++) {
                    var p = placements[i];
                    html += '<tr class="border-b border-gray-50 hover:bg-gray-50 transition-colors">';
                    html += '<td class="py-3 px-2 text-gray-400 font-medium">' + (i + 1) + '</td>';
                    html += '<td class="py-3 px-2">';
                    html += '<div class="flex items-center gap-3">';
                    if (p.thumbnail) {
                        html += '<img src="' + utils.escapeHtml(p.thumbnail) + '" class="w-10 h-10 rounded-full object-cover" />';
                    } else {
                        html += '<div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-400"></div>';
                    }
                    html += '<div>';
                    html += '<p class="font-semibold text-gray-800">' + utils.escapeHtml(p.channelName) + '</p>';
                    if (p.handle) {
                        html += '<p class="text-sm text-gray-500">' + utils.escapeHtml(p.handle) + '</p>';
                    }
                    html += '<p class="text-sm text-gray-500 md:hidden">' + utils.escapeHtml(p.subscribersFormatted) + ' subscribers</p>';
                    html += '</div>';
                    html += '</div>';
                    html += '</td>';
                    html += '<td class="py-3 px-2 hidden md:table-cell">';
                    html += '<span class="font-semibold text-gray-700">' + utils.escapeHtml(p.subscribersFormatted) + '</span>';
                    html += '</td>';
                    html += '<td class="py-3 px-2 hidden lg:table-cell">';
                    var scoreColor = p.relevanceScore >= 80 ? 'green' : p.relevanceScore >= 60 ? 'yellow' : 'gray';
                    html += '<span class="inline-block px-2 py-1 rounded-full text-xs font-bold bg-' + scoreColor + '-100 text-' + scoreColor + '-700">' + p.relevanceScore + '%</span>';
                    html += '</td>';
                    html += '<td class="py-3 px-2 text-right">';
                    html += '<div class="flex justify-end gap-2">';
                    html += '<a href="' + utils.escapeHtml(p.channelUrl) + '" target="_blank" class="p-2 text-gray-500 hover:text-purple-600 hover:bg-purple-50 rounded-lg transition-colors" title="Visit Channel"></a>';
                    html += '<button onclick="app.copySinglePlacement(\'' + utils.escapeHtml(p.channelUrl) + '\')" class="p-2 text-gray-500 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors" title="Copy URL"></button>';
                    html += '</div>';
                    html += '</td>';
                    html += '</tr>';
                }

                html += '</tbody>';
                html += '</table>';
                html += '</div>';

                // Footer info
                html += '<div class="mt-4 pt-4 border-t border-gray-100 flex flex-wrap justify-between items-center gap-4">';
                html += '<p class="text-sm text-gray-500">Showing ' + placements.length + ' of maximum 50 channels</p>';
                html += '<p class="text-sm text-gray-500"> Tip: Copy all and paste directly into Google Ads Placements</p>';
                html += '</div>';

                html += '</div>';
            }

            html += '</div></div>';
            return html;
        }

        /* ------------------------------------------
           4.6.13 Channel Audit Pro View
           ------------------------------------------ */
        function renderChannelAudit() {
            var html = '';
            var results = state.channelAuditResults;

            html += '<div class="min-h-screen mobile-full-screen py-12 px-4 mobile-wide-container">';
            html += '<div class="max-w-4xl mx-auto">';

            // Navigation buttons
            html += '<div class="flex flex-wrap gap-3 mb-6">';
            html += '<button onclick="app.goToDashboard()" class="px-6 py-3 bg-white/20 text-white rounded-xl hover:bg-white/30"> Back</button>';
            html += '<button onclick="app.goToHistory(\'channelAudit\')" class="px-6 py-3 bg-white/20 text-white rounded-xl hover:bg-white/30"> View History</button>';
            html += '</div>';

            // Loading Section
            if (state.loading && !results) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-8 mobile-padding mb-6 fade-in">';
                html += '<div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">';
                html += '<div class="flex items-center gap-4"><div class="loading-emoji"></div><div><h3 class="text-xl font-bold text-gray-800">Analyzing Channel</h3><p class="text-gray-500">Performing comprehensive audit...</p></div></div>';
                html += '<div class="progress-percentage">' + Math.round(state.loadingProgress) + '%</div>';
                html += '</div>';
                html += '<div class="progress-bar-container mb-6"><div class="progress-bar-fill" style="width:' + state.loadingProgress + '%"></div></div>';
                html += '<div class="grid grid-cols-2 md:grid-cols-3 gap-3">';
                for (var li = 0; li < state.loadingSteps.length; li++) {
                    var lstep = state.loadingSteps[li];
                    var lstepClass = li < state.loadingStep ? 'completed' : li === state.loadingStep ? 'active' : 'pending';
                    html += '<div class="loading-step ' + lstepClass + '">';
                    html += '<div class="step-icon ' + lstepClass + '">' + (lstepClass === 'completed' ? '' : lstep.icon) + '</div>';
                    html += '<span class="text-sm font-medium">' + lstep.name + '</span>';
                    html += '</div>';
                }
                html += '</div></div>';
            }

            // Input Form (show when no results)
            if (!results && !state.loading) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-8 mobile-padding fade-in">';
                html += '<h2 class="text-3xl mobile-text-xl font-bold text-gray-800 mb-4"> Channel Audit Pro</h2>';

                // Feature Description Section - Collapsible on mobile
                html += '<div class="mb-6">';
                html += '<div class="bg-gradient-to-r from-emerald-50 via-teal-50 to-cyan-50 rounded-xl overflow-hidden border border-emerald-100">';

                // Collapsible header - VISIBLE ON ALL SCREENS
                html += '<button type="button" onclick="this.parentElement.classList.toggle(\'expanded\'); this.querySelector(\'.chevron\').classList.toggle(\'rotate-180\')" class="w-full p-4 flex items-center justify-between text-left">';
                html += '<span class="flex items-center gap-2 font-semibold text-gray-800"><span class="text-lg"></span> What will you learn?</span>';
                html += '<svg class="chevron w-5 h-5 text-gray-500 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>';
                html += '</button>';

                // Content area - CSS handles visibility
                html += '<div class="feature-info-content">';
                html += '<p class="text-gray-700 mb-3 leading-relaxed">Get a complete health check for any YouTube channel. Our AI analyzes every aspect of channel performance and provides actionable recommendations for growth.</p>';
                html += '<div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">';
                html += '<div class="flex items-start gap-2"><span class="text-emerald-500 mt-0.5"></span><span class="text-gray-600"><strong>SEO Health Score</strong>  Overall optimization rating</span></div>';
                html += '<div class="flex items-start gap-2"><span class="text-emerald-500 mt-0.5"></span><span class="text-gray-600"><strong>Content Strategy</strong>  Upload frequency & topics</span></div>';
                html += '<div class="flex items-start gap-2"><span class="text-emerald-500 mt-0.5"></span><span class="text-gray-600"><strong>Engagement Analysis</strong>  Views, likes & comments</span></div>';
                html += '<div class="flex items-start gap-2"><span class="text-emerald-500 mt-0.5"></span><span class="text-gray-600"><strong>Growth Roadmap</strong>  Personalized recommendations</span></div>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
                html += '</div>';

                // Error message
                if (state.error) {
                    html += '<div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-xl text-red-700">' + utils.escapeHtml(state.error.message) + '</div>';
                }

                html += '<form onsubmit="app.runChannelAudit(event)">';
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-2">YouTube Channel URL</label>';
                html += '<input type="text" id="audit-channel-url" placeholder="https://youtube.com/@channel" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" required />';
                html += '<p class="text-sm text-gray-500 mt-2">Supports: youtube.com/@handle, youtube.com/channel/..., youtube.com/c/...</p>';
                html += '</div>';

                html += '<button type="submit" class="btn-primary">';
                html += ' Start Channel Audit';
                html += '</button>';
                html += '</form>';

                html += '</div>';
            }

            // Results Section
            if (results) {
                var channelInfo = results.channelInfo || {};
                var scores = results.scores || {};
                var analysis = results.analysis || {};
                var recommendations = results.recommendations || [];

                // Channel Info Card
                html += '<div class="bg-white/10 backdrop-blur rounded-2xl p-5 mb-6 fade-in">';
                html += '<div class="flex flex-wrap items-center gap-4">';
                if (channelInfo.thumbnail) {
                    html += '<img src="' + utils.escapeHtml(channelInfo.thumbnail) + '" class="w-16 h-16 object-cover rounded-full" />';
                }
                html += '<div class="flex-1 min-w-[200px]">';
                html += '<p class="text-white font-bold text-lg">' + utils.escapeHtml(channelInfo.name || 'Channel') + '</p>';
                html += '<p class="text-white/70">' + utils.formatNumber(channelInfo.subscribers || 0) + ' subscribers  ' + utils.formatNumber(channelInfo.videoCount || 0) + ' videos</p>';
                html += '</div>';
                var overallScore = scores.overall || 0;
                var scoreColor = overallScore >= 80 ? 'bg-green-500' : overallScore >= 60 ? 'bg-yellow-500' : 'bg-red-500';
                html += '<div class="' + scoreColor + ' text-white px-6 py-3 rounded-full font-bold text-2xl">';
                html += overallScore + '<span class="text-sm">/100</span>';
                html += '</div>';
                html += '</div></div>';

                // Score Breakdown
                html += '<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">';
                var scoreCategories = [
                    { key: 'seo', name: 'SEO Health', icon: '' },
                    { key: 'content', name: 'Content Strategy', icon: '' },
                    { key: 'engagement', name: 'Engagement', icon: '' },
                    { key: 'growth', name: 'Growth Potential', icon: '' }
                ];
                for (var i = 0; i < scoreCategories.length; i++) {
                    var cat = scoreCategories[i];
                    var catScore = scores[cat.key] || 0;
                    var catColor = catScore >= 80 ? 'text-green-400 border-green-400' : catScore >= 60 ? 'text-yellow-400 border-yellow-400' : 'text-red-400 border-red-400';
                    html += '<div class="bg-white rounded-2xl p-5 text-center shadow-lg">';
                    html += '<div class="text-3xl mb-2">' + cat.icon + '</div>';
                    html += '<div class="text-3xl font-bold ' + catColor + ' mb-1">' + catScore + '</div>';
                    html += '<div class="text-gray-600 text-sm font-medium">' + cat.name + '</div>';
                    html += '</div>';
                }
                html += '</div>';

                // Analysis Details
                if (analysis.summary) {
                    html += '<div class="bg-white rounded-2xl shadow-xl p-6 mb-6 fade-in">';
                    html += '<h3 class="text-xl font-bold text-gray-800 mb-4"> Analysis Summary</h3>';
                    html += '<p class="text-gray-600">' + utils.escapeHtml(analysis.summary) + '</p>';
                    html += '</div>';
                }

                // Strengths & Weaknesses
                html += '<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">';

                if (analysis.strengths && analysis.strengths.length > 0) {
                    html += '<div class="bg-white rounded-2xl shadow-xl p-6 fade-in">';
                    html += '<h3 class="text-xl font-bold text-green-600 mb-4"> Strengths</h3>';
                    html += '<ul class="space-y-2">';
                    for (var s = 0; s < analysis.strengths.length; s++) {
                        html += '<li class="flex items-start gap-2 text-gray-600"><span class="text-green-500"></span>' + utils.escapeHtml(analysis.strengths[s]) + '</li>';
                    }
                    html += '</ul></div>';
                }

                if (analysis.weaknesses && analysis.weaknesses.length > 0) {
                    html += '<div class="bg-white rounded-2xl shadow-xl p-6 fade-in">';
                    html += '<h3 class="text-xl font-bold text-red-600 mb-4"> Areas to Improve</h3>';
                    html += '<ul class="space-y-2">';
                    for (var w = 0; w < analysis.weaknesses.length; w++) {
                        html += '<li class="flex items-start gap-2 text-gray-600"><span class="text-red-500"></span>' + utils.escapeHtml(analysis.weaknesses[w]) + '</li>';
                    }
                    html += '</ul></div>';
                }

                html += '</div>';

                // Recommendations
                if (recommendations.length > 0) {
                    html += '<div class="bg-white rounded-2xl shadow-xl p-6 fade-in">';
                    html += '<h3 class="text-xl font-bold text-gray-800 mb-4"> Growth Recommendations</h3>';
                    html += '<div class="space-y-4">';
                    for (var r = 0; r < recommendations.length; r++) {
                        var rec = recommendations[r];
                        var priorityColor = rec.priority === 'high' ? 'bg-red-100 text-red-700' : rec.priority === 'medium' ? 'bg-yellow-100 text-yellow-700' : 'bg-blue-100 text-blue-700';
                        html += '<div class="p-4 bg-gray-50 rounded-xl">';
                        html += '<div class="flex items-center gap-3 mb-2">';
                        html += '<span class="px-2 py-1 text-xs font-bold rounded-full ' + priorityColor + '">' + (rec.priority || 'tip').toUpperCase() + '</span>';
                        html += '<span class="font-bold text-gray-800">' + utils.escapeHtml(rec.title || rec) + '</span>';
                        html += '</div>';
                        if (rec.description) {
                            html += '<p class="text-gray-600 text-sm">' + utils.escapeHtml(rec.description) + '</p>';
                        }
                        html += '</div>';
                    }
                    html += '</div></div>';
                }

                // New Audit Button
                html += '<div class="mt-6 text-center">';
                html += '<button onclick="app.goToChannelAudit()" class="btn-primary bg-gradient-to-r from-emerald-500 to-teal-600">';
                html += ' Audit Another Channel';
                html += '</button>';
                html += '</div>';
            }

            html += '</div></div>';
            return html;
        }

        /* ------------------------------------------
           4.6.14 Admin Reports View (Campaign Reports Manager)
           ------------------------------------------ */
        function renderAdminReports() {
            var html = '';

            html += '<div class="min-h-screen mobile-full-screen py-6 px-4 mobile-wide-container">';
            html += '<div class="max-w-6xl mx-auto">';

            // Header
            html += '<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4 fade-in">';
            html += '<h1 class="text-3xl mobile-text-xl font-bold text-white"> Campaign Reports</h1>';
            html += '<button onclick="app.goToAdmin()" class="btn-secondary w-full sm:w-auto"> Back to Admin</button>';
            html += '</div>';

            // Success/Error messages
            if (state.success) {
                html += '<div class="mb-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg fade-in">' + utils.escapeHtml(state.success) + '</div>';
            }
            if (state.error) {
                html += '<div class="mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg fade-in">' + utils.escapeHtml(state.error) + '</div>';
            }

            // Create New Report Section
            html += '<div class="bg-white rounded-2xl shadow-xl p-6 lg:p-8 mb-8 fade-in">';
            html += '<h2 class="text-2xl font-bold text-gray-800 mb-6"> Create New Report</h2>';

            // Upload Zone with drag-and-drop support
            html += '<div id="upload-zone" class="upload-zone' + (state.reportImages.length > 0 ? ' has-images' : '') + '" onclick="document.getElementById(\'image-input\').click()" ondragover="app.handleDragOver(event)" ondragleave="app.handleDragLeave(event)" ondrop="app.handleImageDrop(event)">';
            html += '<input type="file" id="image-input" accept="image/*" multiple style="display:none" onchange="app.handleImageUpload(event)" />';

            if (state.reportImages.length === 0) {
                html += '<div class="text-5xl mb-4"></div>';
                html += '<p class="text-xl font-bold text-gray-700 mb-2">Drop Google Ads Screenshots Here</p>';
                html += '<p class="text-gray-500">or click to browse (3-6 images recommended)</p>';
                html += '<p class="text-sm text-gray-400 mt-4">Supports: PNG, JPG, WebP (max 10MB each)</p>';
            } else {
                html += '<div class="text-green-600 font-bold text-lg mb-2"> ' + state.reportImages.length + ' images ready</div>';
                html += '<p class="text-gray-500 text-sm">Click to add more or use buttons below</p>';
            }
            html += '</div>';

            // Image Previews
            if (state.reportImages.length > 0) {
                html += '<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mt-6">';
                for (var i = 0; i < state.reportImages.length; i++) {
                    html += '<div class="image-preview">';
                    html += '<img src="' + state.reportImages[i].preview + '" alt="Screenshot ' + (i + 1) + '" />';
                    html += '<button class="remove-btn" onclick="event.stopPropagation(); app.removeReportImage(' + i + ')"></button>';
                    html += '<div class="absolute bottom-2 left-2 bg-black/60 text-white text-xs px-2 py-1 rounded">' + (i + 1) + '</div>';
                    html += '</div>';
                }
                html += '</div>';

                // Campaign Name Input
                html += '<div class="mt-6">';
                html += '<label class="block text-gray-700 font-semibold mb-2">Campaign Name</label>';
                html += '<input type="text" id="campaign-name" placeholder="e.g., Q4 Search Campaign" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none" />';
                html += '</div>';

                // Additional Context
                html += '<div class="mt-4">';
                html += '<label class="block text-gray-700 font-semibold mb-2">Additional Context (optional)</label>';
                html += '<textarea id="additional-context" rows="2" placeholder="Any specific details about the campaign..." class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none resize-none"></textarea>';
                html += '</div>';

                // Action Buttons
                html += '<div class="flex flex-wrap gap-4 mt-6">';
                html += '<button onclick="app.analyzeReportImages()" class="flex-1 px-6 py-4 bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold rounded-xl hover:from-purple-600 hover:to-indigo-700 transition-all flex items-center justify-center gap-2" ' + (state.reportLoading ? 'disabled' : '') + '>';
                if (state.reportLoading) {
                    html += '<span class="animate-spin"></span> Analyzing with AI...';
                } else {
                    html += '<span></span> Analyze with AI';
                }
                html += '</button>';
                html += '<button onclick="app.clearReportImages()" class="px-6 py-4 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition-all">Clear All</button>';
                html += '</div>';
            }

            html += '</div>';

            // AI Analysis Results
            if (state.reportAnalysis) {
                var analysis = state.reportAnalysis;

                // YouTube Performance Hero Section (beautiful version)
                if (analysis.youtubeMetrics) {
                    var ytMetrics = analysis.youtubeMetrics;
                    if (ytMetrics.publicViews || ytMetrics.impressions) {
                        html += '<div class="youtube-hero fade-in mb-8">';
                        html += '<div class="youtube-hero-title"><span></span> YouTube Campaign Performance</div>';

                        // Main Views Card
                        if (ytMetrics.publicViews) {
                            var viewRate = 0;
                            if (ytMetrics.publicViews && ytMetrics.impressions) {
                                viewRate = Math.round((parseInt(String(ytMetrics.publicViews).replace(/,/g, '')) / parseInt(String(ytMetrics.impressions).replace(/,/g, ''))) * 1000) / 10;
                            }
                            html += '<div class="youtube-hero-main">';
                            html += '<div class="youtube-views-label"><span></span> YouTube Public Views</div>';
                            html += '<div class="youtube-views-value">' + utils.escapeHtml(String(ytMetrics.publicViews)) + '</div>';
                            if (viewRate > 0) {
                                html += '<div class="youtube-view-rate">';
                                html += '<div class="view-rate-bar"><div class="view-rate-fill" style="width:' + Math.min(viewRate, 100) + '%"></div></div>';
                                html += '<span class="view-rate-text">' + viewRate + '% View Rate</span>';
                                html += '</div>';
                            }
                            html += '</div>';
                        }

                        // Supporting Metrics Grid
                        html += '<div class="youtube-metrics-grid">';
                        if (ytMetrics.impressions) {
                            html += '<div class="youtube-metric-card">';
                            html += '<div class="youtube-metric-icon"></div>';
                            html += '<div class="youtube-metric-value">' + utils.escapeHtml(String(ytMetrics.impressions)) + '</div>';
                            html += '<div class="youtube-metric-label">Impressions</div>';
                            html += '</div>';
                        }
                        if (ytMetrics.publicViews) {
                            var viewRateCalc = ytMetrics.impressions ? Math.round((parseInt(String(ytMetrics.publicViews).replace(/,/g, '')) / parseInt(String(ytMetrics.impressions).replace(/,/g, ''))) * 1000) / 10 : 0;
                            html += '<div class="youtube-metric-card">';
                            html += '<div class="youtube-metric-icon"></div>';
                            html += '<div class="youtube-metric-value">' + viewRateCalc + '%</div>';
                            html += '<div class="youtube-metric-label">View Rate</div>';
                            html += '</div>';
                        }
                        if (ytMetrics.status) {
                            html += '<div class="youtube-metric-card">';
                            html += '<div class="youtube-metric-icon"></div>';
                            html += '<div class="youtube-metric-value" style="font-size:1rem;">' + utils.escapeHtml(ytMetrics.status) + '</div>';
                            html += '<div class="youtube-metric-label">Status</div>';
                            html += '</div>';
                        }
                        html += '</div>';

                        // Video Info
                        if (ytMetrics.videoTitle || ytMetrics.adType) {
                            html += '<div class="youtube-video-info">';
                            if (ytMetrics.videoTitle) {
                                html += '<div class="youtube-video-title"><span></span> ' + utils.escapeHtml(ytMetrics.videoTitle) + '</div>';
                            }
                            html += '<div class="youtube-video-meta">';
                            if (ytMetrics.adType) {
                                html += '<span class="youtube-video-tag"><span></span> ' + utils.escapeHtml(ytMetrics.adType) + '</span>';
                            }
                            if (ytMetrics.adGroup) {
                                html += '<span class="youtube-video-tag"><span></span> ' + utils.escapeHtml(ytMetrics.adGroup) + '</span>';
                            }
                            if (ytMetrics.status) {
                                html += '<span class="youtube-video-tag status-eligible"><span></span> ' + utils.escapeHtml(ytMetrics.status) + '</span>';
                            }
                            html += '</div>';
                            html += '</div>';
                        }

                        html += '</div>';
                    }
                }

                // AI Analysis Card (summary and other analysis)
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 lg:p-8 mb-8 fade-in">';
                html += '<div class="flex justify-between items-center mb-6">';
                html += '<h2 class="text-2xl font-bold text-gray-800"> AI Analysis</h2>';
                html += '<span class="status-badge status-ready">Analysis Complete</span>';
                html += '</div>';

                // Summary
                if (analysis.summary) {
                    html += '<div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-4 mb-6">';
                    html += '<p class="text-gray-700">' + utils.escapeHtml(analysis.summary) + '</p>';
                    html += '</div>';
                }

                // Standard Metrics Grid (Google Ads metrics - only if no YouTube metrics shown)
                if (analysis.metrics && (!analysis.youtubeMetrics || !(analysis.youtubeMetrics.publicViews || analysis.youtubeMetrics.impressions))) {
                    html += '<h3 class="font-bold text-gray-800 mb-3"> Extracted Metrics</h3>';
                    html += '<div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 mb-6">';
                    var metricLabels = {
                        impressions: 'Impressions',
                        clicks: 'Clicks',
                        ctr: 'CTR',
                        avgCpc: 'Avg CPC',
                        cost: 'Cost',
                        conversions: 'Conversions',
                        conversionRate: 'Conv Rate',
                        costPerConversion: 'Cost/Conv'
                    };
                    for (var key in metricLabels) {
                        if (analysis.metrics[key] !== null && analysis.metrics[key] !== undefined) {
                            html += '<div class="metric-card">';
                            html += '<div class="metric-value">' + utils.escapeHtml(String(analysis.metrics[key])) + '</div>';
                            html += '<div class="metric-label">' + metricLabels[key] + '</div>';
                            html += '</div>';
                        }
                    }
                    html += '</div>';
                }

                // Performance
                if (analysis.performance) {
                    html += '<h3 class="font-bold text-gray-800 mb-3"> Performance Assessment</h3>';
                    html += '<div class="bg-gray-50 rounded-xl p-4 mb-6">';
                    var perfColor = analysis.performance.overall === 'Excellent' ? 'green' : analysis.performance.overall === 'Good' ? 'blue' : analysis.performance.overall === 'Average' ? 'yellow' : 'red';
                    html += '<div class="flex items-center gap-3 mb-3">';
                    html += '<span class="px-3 py-1 bg-' + perfColor + '-100 text-' + perfColor + '-700 rounded-full font-bold">' + utils.escapeHtml(analysis.performance.overall || 'N/A') + '</span>';
                    html += '<span class="text-gray-500">Trend: ' + utils.escapeHtml(analysis.performance.trend || 'N/A') + '</span>';
                    html += '</div>';
                    if (analysis.performance.highlights && analysis.performance.highlights.length > 0) {
                        html += '<div class="mb-2"><span class="font-semibold text-green-600"> Highlights:</span></div>';
                        html += '<ul class="list-disc list-inside text-gray-600 mb-3">';
                        for (var h = 0; h < analysis.performance.highlights.length; h++) {
                            html += '<li>' + utils.escapeHtml(analysis.performance.highlights[h]) + '</li>';
                        }
                        html += '</ul>';
                    }
                    if (analysis.performance.concerns && analysis.performance.concerns.length > 0) {
                        html += '<div class="mb-2"><span class="font-semibold text-orange-600"> Areas for Improvement:</span></div>';
                        html += '<ul class="list-disc list-inside text-gray-600">';
                        for (var c = 0; c < analysis.performance.concerns.length; c++) {
                            html += '<li>' + utils.escapeHtml(analysis.performance.concerns[c]) + '</li>';
                        }
                        html += '</ul>';
                    }
                    html += '</div>';
                }

                // Recommendations
                if (analysis.recommendations && analysis.recommendations.length > 0) {
                    html += '<h3 class="font-bold text-gray-800 mb-3"> Recommendations</h3>';
                    html += '<div class="space-y-3 mb-6">';
                    for (var r = 0; r < analysis.recommendations.length; r++) {
                        var rec = analysis.recommendations[r];
                        var priority = (rec.priority || 'medium').toLowerCase();
                        html += '<div class="recommendation-card priority-' + priority + '">';
                        html += '<div class="flex items-start justify-between mb-2">';
                        html += '<span class="font-bold text-gray-800">' + utils.escapeHtml(rec.title || 'Recommendation ' + (r + 1)) + '</span>';
                        html += '<span class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600">' + utils.escapeHtml(rec.category || 'General') + '</span>';
                        html += '</div>';
                        html += '<p class="text-gray-600 text-sm">' + utils.escapeHtml(rec.description || '') + '</p>';
                        if (rec.expectedImpact) {
                            html += '<p class="text-sm text-green-600 mt-2"> ' + utils.escapeHtml(rec.expectedImpact) + '</p>';
                        }
                        html += '</div>';
                    }
                    html += '</div>';
                }

                // CTA
                if (analysis.fiverCTA) {
                    html += '<div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl p-4 mb-6">';
                    html += '<h4 class="font-bold text-green-700 mb-2"> Client Call-to-Action</h4>';
                    html += '<p class="text-gray-700">' + utils.escapeHtml(analysis.fiverCTA) + '</p>';
                    html += '</div>';
                }

                // Save/Edit Actions
                html += '<div class="flex flex-wrap gap-4 mt-6 pt-6 border-t border-gray-200">';
                html += '<button onclick="app.saveReportAsDraft()" class="flex-1 px-6 py-4 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition-all flex items-center justify-center gap-2">';
                html += '<span></span> Save as Draft';
                html += '</button>';
                html += '<button onclick="app.goToReportEditor()" class="flex-1 px-6 py-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-bold rounded-xl hover:from-blue-600 hover:to-indigo-700 transition-all flex items-center justify-center gap-2">';
                html += '<span></span> Edit & Send to Client';
                html += '</button>';
                html += '</div>';

                html += '</div>';

                // ========== STRATEGIC GROWTH DASHBOARD (Admin Preview) ==========
                var adminHasMetrics = analysis.metrics && Object.keys(analysis.metrics).length > 0;
                var adminHasRecommendations = analysis.recommendations && analysis.recommendations.length > 0;

                if (adminHasMetrics || adminHasRecommendations) {
                    // Calculate health score based on recommendations
                    var adminHealthScore = 72;
                    var adminHighPriority = 0;
                    var adminMediumPriority = 0;
                    var adminLowPriority = 0;

                    if (adminHasRecommendations) {
                        for (var hs = 0; hs < analysis.recommendations.length; hs++) {
                            var hsRec = analysis.recommendations[hs];
                            var hsPriority = (hsRec.priority || 'medium').toLowerCase();
                            if (hsPriority === 'high') adminHighPriority++;
                            else if (hsPriority === 'medium') adminMediumPriority++;
                            else adminLowPriority++;
                        }
                        adminHealthScore = Math.max(45, Math.min(92, 85 - (adminHighPriority * 8) - (adminMediumPriority * 3) + (adminLowPriority * 2)));
                    }

                    var adminScoreColor = adminHealthScore >= 80 ? '#22c55e' : adminHealthScore >= 60 ? '#f59e0b' : '#ef4444';
                    var adminScoreGrade = adminHealthScore >= 85 ? 'Excellent' : adminHealthScore >= 70 ? 'Good' : adminHealthScore >= 55 ? 'Fair' : 'Needs Work';

                    // Category scores
                    var adminThumbScore = 75, adminTitleScore = 70, adminContentScore = 80, adminEngageScore = 65;
                    if (adminHasRecommendations) {
                        for (var ac = 0; ac < analysis.recommendations.length; ac++) {
                            var acRec = analysis.recommendations[ac];
                            var acCat = (acRec.category || '').toLowerCase();
                            var acPri = (acRec.priority || 'medium').toLowerCase();
                            var acPenalty = acPri === 'high' ? 15 : acPri === 'medium' ? 8 : 3;
                            if (acCat.includes('thumbnail')) adminThumbScore = Math.max(40, adminThumbScore - acPenalty);
                            else if (acCat.includes('title')) adminTitleScore = Math.max(40, adminTitleScore - acPenalty);
                            else if (acCat.includes('content')) adminContentScore = Math.max(40, adminContentScore - acPenalty);
                            else if (acCat.includes('engagement')) adminEngageScore = Math.max(40, adminEngageScore - acPenalty);
                        }
                    }

                    // Channel Health Score Section
                    html += '<div class="strategic-section mb-8">';
                    html += '<div class="strategic-section-header">';
                    html += '<div class="strategic-section-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);"></div>';
                    html += '<div>';
                    html += '<div class="strategic-section-title">Channel Health Score</div>';
                    html += '<div class="strategic-section-subtitle">Overall performance assessment based on analysis</div>';
                    html += '</div>';
                    html += '</div>';

                    html += '<div class="health-score-container">';
                    var adminCircum = 2 * Math.PI * 54;
                    var adminDashoff = adminCircum - (adminHealthScore / 100) * adminCircum;
                    html += '<div class="health-score-ring">';
                    html += '<svg width="140" height="140" viewBox="0 0 140 140">';
                    html += '<circle class="bg-ring" cx="70" cy="70" r="54"></circle>';
                    html += '<circle class="score-ring" cx="70" cy="70" r="54" stroke="' + adminScoreColor + '" stroke-dasharray="' + adminCircum + '" stroke-dashoffset="' + adminDashoff + '"></circle>';
                    html += '</svg>';
                    html += '<div class="health-score-value">';
                    html += '<div class="health-score-number">' + adminHealthScore + '</div>';
                    html += '<div class="health-score-label">' + adminScoreGrade + '</div>';
                    html += '</div>';
                    html += '</div>';

                    html += '<div class="health-score-breakdown">';
                    var adminCats = [
                        { name: 'Thumbnails', icon: '', score: adminThumbScore, color: '#f59e0b' },
                        { name: 'Titles & SEO', icon: '', score: adminTitleScore, color: '#8b5cf6' },
                        { name: 'Content Quality', icon: '', score: adminContentScore, color: '#22c55e' },
                        { name: 'Engagement', icon: '', score: adminEngageScore, color: '#3b82f6' }
                    ];
                    for (var acat = 0; acat < adminCats.length; acat++) {
                        var catItem = adminCats[acat];
                        html += '<div class="score-category">';
                        html += '<span class="score-category-name">' + catItem.icon + ' ' + catItem.name + '</span>';
                        html += '<div class="score-category-bar"><div class="score-category-fill" style="width:' + catItem.score + '%;background:' + catItem.color + ';"></div></div>';
                        html += '</div>';
                    }
                    html += '</div>';
                    html += '</div>';
                    html += '</div>';
                }

                // Campaign Performance Metrics Dashboard
                if (adminHasMetrics) {
                    html += '<div class="strategic-section mb-8">';
                    html += '<div class="strategic-section-header">';
                    html += '<div class="strategic-section-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);"></div>';
                    html += '<div>';
                    html += '<div class="strategic-section-title">Campaign Performance Metrics</div>';
                    html += '<div class="strategic-section-subtitle">Key performance indicators from your campaign</div>';
                    html += '</div>';
                    html += '</div>';

                    html += '<div class="metrics-dashboard">';
                    var adminMetricCfg = {
                        impressions: { label: 'Impressions', icon: '', color: '#8b5cf6' },
                        clicks: { label: 'Clicks', icon: '', color: '#3b82f6' },
                        ctr: { label: 'CTR', icon: '', color: '#22c55e' },
                        avgCpc: { label: 'Avg CPC', icon: '', color: '#f59e0b' },
                        cost: { label: 'Total Cost', icon: '', color: '#ef4444' },
                        conversions: { label: 'Conversions', icon: '', color: '#10b981' },
                        conversionRate: { label: 'Conv Rate', icon: '', color: '#6366f1' },
                        costPerConversion: { label: 'Cost/Conv', icon: '', color: '#ec4899' }
                    };
                    for (var amKey in adminMetricCfg) {
                        if (analysis.metrics[amKey] !== null && analysis.metrics[amKey] !== undefined) {
                            var amCfg = adminMetricCfg[amKey];
                            html += '<div class="metric-tile" style="--metric-color:' + amCfg.color + ';">';
                            html += '<div class="metric-tile-icon">' + amCfg.icon + '</div>';
                            html += '<div class="metric-tile-value">' + utils.escapeHtml(String(analysis.metrics[amKey])) + '</div>';
                            html += '<div class="metric-tile-label">' + amCfg.label + '</div>';
                            html += '<div class="metric-tile-trend neutral"></div>';
                            html += '</div>';
                        }
                    }
                    html += '</div>';
                    html += '</div>';
                }

                // Strategic Action Plan
                if (adminHasRecommendations) {
                    html += '<div class="strategic-section mb-8">';
                    html += '<div class="strategic-section-header">';
                    html += '<div class="strategic-section-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);"></div>';
                    html += '<div>';
                    html += '<div class="strategic-section-title">Strategic Action Plan</div>';
                    html += '<div class="strategic-section-subtitle">' + analysis.recommendations.length + ' recommendations to accelerate your channel growth</div>';
                    html += '</div>';
                    html += '</div>';

                    html += '<div class="action-cards-grid">';
                    for (var ar = 0; ar < analysis.recommendations.length; ar++) {
                        var arRec = analysis.recommendations[ar];
                        var arTitle = arRec.title || 'Recommendation ' + (ar + 1);
                        var arDesc = arRec.description || '';
                        var arPriority = (arRec.priority || 'medium').toLowerCase();
                        var arCategory = arRec.category || '';
                        var arImpact = arRec.expectedImpact || '';

                        var arCatIcon = '';
                        var arCatLabel = 'General';
                        if (arCategory.toLowerCase().includes('thumbnail')) { arCatIcon = ''; arCatLabel = 'Thumbnail'; }
                        else if (arCategory.toLowerCase().includes('title')) { arCatIcon = ''; arCatLabel = 'Title & SEO'; }
                        else if (arCategory.toLowerCase().includes('description')) { arCatIcon = ''; arCatLabel = 'Description'; }
                        else if (arCategory.toLowerCase().includes('content')) { arCatIcon = ''; arCatLabel = 'Content'; }
                        else if (arCategory.toLowerCase().includes('schedule') || arCategory.toLowerCase().includes('posting')) { arCatIcon = ''; arCatLabel = 'Schedule'; }
                        else if (arCategory.toLowerCase().includes('engagement')) { arCatIcon = ''; arCatLabel = 'Engagement'; }
                        else if (arCategory.toLowerCase().includes('seo') || arCategory.toLowerCase().includes('tag')) { arCatIcon = ''; arCatLabel = 'SEO'; }
                        else if (arCategory.toLowerCase().includes('brand')) { arCatIcon = ''; arCatLabel = 'Branding'; }

                        var arImpactPct = 0;
                        if (arImpact) {
                            var arImpactMatch = arImpact.match(/(\d+)/);
                            arImpactPct = arImpactMatch ? Math.min(parseInt(arImpactMatch[1]), 100) : (arPriority === 'high' ? 75 : arPriority === 'medium' ? 50 : 30);
                        } else {
                            arImpactPct = arPriority === 'high' ? 75 : arPriority === 'medium' ? 50 : 30;
                        }

                        html += '<div class="action-card">';
                        html += '<div class="action-card-header">';
                        html += '<div class="action-card-icon ' + arPriority + '">' + arCatIcon + '</div>';
                        html += '<div class="action-card-title-area">';
                        html += '<div class="action-card-title">' + utils.escapeHtml(arTitle) + '</div>';
                        html += '<div class="action-card-category">' + arCatLabel + '</div>';
                        html += '</div>';
                        html += '<div class="action-card-badges">';
                        html += '<span class="action-badge priority-' + arPriority + '">' + (arPriority === 'high' ? 'High Priority' : arPriority === 'medium' ? 'Medium' : 'Quick Win') + '</span>';
                        html += '</div>';
                        html += '</div>';

                        if (arDesc) {
                            html += '<div class="action-card-description">' + utils.escapeHtml(arDesc) + '</div>';
                        }

                        html += '<div class="action-card-impact">';
                        html += '<div class="impact-header">';
                        html += '<span class="impact-label"> Expected Impact</span>';
                        html += '<span class="impact-value">' + (arImpact ? utils.escapeHtml(arImpact) : (arImpactPct + '% improvement')) + '</span>';
                        html += '</div>';
                        html += '<div class="impact-bar"><div class="impact-bar-fill" style="width:' + arImpactPct + '%;"></div></div>';
                        html += '</div>';

                        html += '</div>';
                    }
                    html += '</div>';

                    // Growth Projection
                    var adminGrowth = Math.min(95, 15 + (adminHighPriority * 12) + (adminMediumPriority * 6) + (adminLowPriority * 3));
                    html += '<div class="growth-projection" style="margin-top: 1.5rem;">';
                    html += '<div class="growth-projection-content">';
                    html += '<div class="growth-projection-title"> Growth Projection</div>';
                    html += '<div class="growth-projection-text">Estimated improvement potential if all ' + analysis.recommendations.length + ' recommendations are implemented</div>';
                    html += '</div>';
                    html += '<div class="growth-projection-value">';
                    html += '<div class="growth-value-number">+' + adminGrowth + '%</div>';
                    html += '<div class="growth-value-label">Potential Growth</div>';
                    html += '</div>';
                    html += '</div>';

                    html += '</div>';
                }
            }

            // Existing Reports Table
            html += '<div class="bg-white rounded-2xl shadow-xl p-6 lg:p-8 fade-in">';
            html += '<h2 class="text-2xl font-bold text-gray-800 mb-6"> All Reports</h2>';

            if (state.campaignReports === null) {
                html += '<div class="text-center py-8">';
                html += '<div class="spinner spinner-dark mx-auto mb-4"></div>';
                html += '<p class="text-gray-600">Loading reports...</p>';
                html += '</div>';
            } else if (state.campaignReports.length === 0) {
                html += '<div class="text-center py-12">';
                html += '<div class="text-6xl mb-4"></div>';
                html += '<p class="text-gray-500 text-lg">No reports yet. Create your first one above!</p>';
                html += '</div>';
            } else {
                html += '<div class="overflow-x-auto">';
                html += '<table class="w-full">';
                html += '<thead class="bg-gray-50">';
                html += '<tr>';
                html += '<th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Campaign</th>';
                html += '<th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Status</th>';
                html += '<th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 hidden md:table-cell">Client</th>';
                html += '<th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 hidden lg:table-cell">Created</th>';
                html += '<th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">Actions</th>';
                html += '</tr>';
                html += '</thead>';
                html += '<tbody class="divide-y divide-gray-100">';

                for (var i = 0; i < state.campaignReports.length; i++) {
                    var report = state.campaignReports[i];
                    var statusClass = 'status-' + report.status;
                    var statusIcon = report.status === 'draft' ? '' : report.status === 'ready' ? '' : report.status === 'sent' ? '' : '';

                    html += '<tr class="hover:bg-gray-50">';
                    html += '<td class="px-4 py-4">';
                    html += '<p class="font-semibold text-gray-800">' + utils.escapeHtml(report.campaignName || 'Untitled Report') + '</p>';
                    html += '<p class="text-sm text-gray-500">' + (report.images ? report.images.length : 0) + ' images</p>';
                    html += '</td>';
                    html += '<td class="px-4 py-4">';
                    html += '<span class="status-badge ' + statusClass + '">' + statusIcon + ' ' + utils.escapeHtml(report.status) + '</span>';
                    html += '</td>';
                    html += '<td class="px-4 py-4 hidden md:table-cell">';
                    if (report.clientInfo) {
                        html += '<span class="text-gray-700">' + utils.escapeHtml(report.clientInfo.email) + '</span>';
                    } else {
                        html += '<span class="text-gray-400">Not assigned</span>';
                    }
                    html += '</td>';
                    html += '<td class="px-4 py-4 hidden lg:table-cell text-gray-500">';
                    html += report.createdAt ? new Date(report.createdAt).toLocaleDateString() : 'N/A';
                    html += '</td>';
                    html += '<td class="px-4 py-4 text-right">';
                    html += '<div class="flex justify-end gap-2">';
                    html += '<button onclick="app.editReport(\'' + report.id + '\')" class="p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-lg" title="Edit"></button>';
                    if (report.status === 'draft' || report.status === 'ready') {
                        html += '<button onclick="app.openSendModal(\'' + report.id + '\')" class="p-2 text-gray-500 hover:text-green-600 hover:bg-green-50 rounded-lg" title="Send to Client"></button>';
                    }
                    html += '<button onclick="app.deleteReport(\'' + report.id + '\')" class="p-2 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-lg" title="Delete"></button>';
                    html += '</div>';
                    html += '</td>';
                    html += '</tr>';
                }

                html += '</tbody></table></div>';
            }

            html += '</div>';

            html += '</div></div>';

            // Send to Client Modal
            if (state.sendModalReportId) {
                html += '<div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" onclick="app.closeSendModal()">';
                html += '<div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6" onclick="event.stopPropagation()">';
                html += '<h3 class="text-xl font-bold text-gray-800 mb-4"> Send Report to Client</h3>';
                html += '<p class="text-gray-600 mb-4">Select which client should receive this report:</p>';

                html += '<select id="send-client-select" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none mb-6">';
                html += '<option value="">-- Select a client --</option>';
                if (state.adminUsers) {
                    for (var u = 0; u < state.adminUsers.length; u++) {
                        var user = state.adminUsers[u];
                        html += '<option value="' + user.uid + '">' + utils.escapeHtml(user.email || user.uid) + '</option>';
                    }
                }
                html += '</select>';

                html += '<div class="flex gap-3">';
                html += '<button onclick="app.closeSendModal()" class="flex-1 px-4 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200">Cancel</button>';
                html += '<button onclick="app.sendReportToClient()" class="flex-1 px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold rounded-xl hover:from-green-600 hover:to-emerald-700">Send Report</button>';
                html += '</div>';
                html += '</div></div>';
            }

            return html;
        }

        /* ------------------------------------------
           4.6.15 Report Editor View
           ------------------------------------------ */
        function renderReportEditor() {
            var html = '';
            var report = state.editingReport || {};
            var content = report.editedContent || {};

            html += '<div class="min-h-screen mobile-full-screen py-6 px-4 mobile-wide-container">';
            html += '<div class="max-w-4xl mx-auto">';

            // Header
            html += '<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4 fade-in">';
            html += '<h1 class="text-3xl mobile-text-xl font-bold text-white"> Edit Report</h1>';
            html += '<button onclick="app.goToAdminReports()" class="btn-secondary w-full sm:w-auto"> Back to Reports</button>';
            html += '</div>';

            if (state.success) {
                html += '<div class="mb-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg fade-in">' + utils.escapeHtml(state.success) + '</div>';
            }
            if (state.error) {
                html += '<div class="mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg fade-in">' + utils.escapeHtml(state.error) + '</div>';
            }

            html += '<div class="bg-white rounded-2xl shadow-xl p-6 lg:p-8 fade-in">';

            // Campaign Name
            html += '<div class="mb-6">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Report Title</label>';
            html += '<input type="text" id="edit-title" value="' + utils.escapeHtml(content.title || report.campaignName || '') + '" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-lg" />';
            html += '</div>';

            // Summary
            html += '<div class="mb-6">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Executive Summary</label>';
            html += '<textarea id="edit-summary" rows="3" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none resize-none">' + utils.escapeHtml(content.summary || '') + '</textarea>';
            html += '</div>';

            // Recommendations (editable list)
            html += '<div class="mb-6">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Recommendations</label>';
            html += '<div id="recommendations-list" class="space-y-3">';
            var recs = content.recommendations || [];
            for (var i = 0; i < recs.length; i++) {
                html += '<div class="flex gap-2 items-start">';
                html += '<input type="text" class="rec-input flex-1 px-3 py-2 border border-gray-200 rounded-lg" value="' + utils.escapeHtml(recs[i].title || recs[i]) + '" data-index="' + i + '" />';
                html += '<button onclick="app.removeRecommendation(' + i + ')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg"></button>';
                html += '</div>';
            }
            html += '</div>';
            html += '<button onclick="app.addRecommendation()" class="mt-3 text-purple-600 font-semibold hover:underline">+ Add Recommendation</button>';
            html += '</div>';

            // Call to Action
            html += '<div class="mb-6">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Call to Action (Fiverr CTA)</label>';
            html += '<textarea id="edit-cta" rows="2" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none resize-none">' + utils.escapeHtml(content.callToAction || '') + '</textarea>';
            html += '</div>';

            // Images Preview
            if (report.images && report.images.length > 0) {
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-2">Report Images</label>';
                html += '<div class="grid grid-cols-3 md:grid-cols-4 gap-2">';
                for (var j = 0; j < report.images.length; j++) {
                    html += '<img src="' + utils.escapeHtml(report.images[j].url || report.images[j].preview) + '" class="rounded-lg aspect-video object-cover" />';
                }
                html += '</div>';
                html += '</div>';
            }

            // Actions
            html += '<div class="flex flex-wrap gap-4 pt-6 border-t border-gray-200">';
            html += '<button onclick="app.saveReportChanges()" class="flex-1 px-6 py-4 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition-all" ' + (state.reportLoading ? 'disabled' : '') + '> Save Changes</button>';
            html += '<button onclick="app.openSendModal(\'' + (report.id || '') + '\')" class="flex-1 px-6 py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold rounded-xl hover:from-green-600 hover:to-emerald-700 transition-all"> Send to Client</button>';
            html += '</div>';

            html += '</div>';
            html += '</div></div>';

            return html;
        }

        /* ------------------------------------------
           4.6.16 Client Reports View
           ------------------------------------------ */
        function renderClientReports() {
            var html = '';

            html += '<div class="min-h-screen mobile-full-screen py-8 px-4 mobile-wide-container">';
            html += '<div class="max-w-4xl mx-auto">';

            // Header
            html += '<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4 fade-in">';
            html += '<div>';
            html += '<h1 class="text-3xl lg:text-4xl font-bold text-white mb-2"> My Campaign Reports</h1>';
            html += '<p class="text-white/80">View your performance reports and recommendations</p>';
            html += '</div>';
            html += '<button onclick="app.goToDashboard()" class="btn-secondary w-full sm:w-auto"> Back to Dashboard</button>';
            html += '</div>';

            // Reports List
            if (state.clientReports === null) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-12 text-center fade-in">';
                html += '<div class="spinner spinner-dark mx-auto mb-4"></div>';
                html += '<p class="text-gray-600">Loading your reports...</p>';
                html += '</div>';
            } else if (state.clientReports.length === 0) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-12 text-center fade-in">';
                html += '<div class="text-6xl mb-4"></div>';
                html += '<h3 class="text-xl font-bold text-gray-800 mb-2">No Reports Yet</h3>';
                html += '<p class="text-gray-500">When your campaign reports are ready, they\'ll appear here.</p>';
                html += '</div>';
            } else {
                html += '<div class="grid gap-6 fade-in">';
                for (var i = 0; i < state.clientReports.length; i++) {
                    var report = state.clientReports[i];
                    var isNew = report.status === 'sent';

                    html += '<div class="client-report-card' + (isNew ? ' has-new' : '') + ' cursor-pointer" onclick="app.viewReport(\'' + report.id + '\')">';
                    html += '<div class="flex flex-col md:flex-row md:items-center justify-between gap-4">';
                    html += '<div class="flex-1">';
                    html += '<div class="flex items-center gap-3 mb-2">';
                    html += '<span class="text-3xl"></span>';
                    html += '<h3 class="text-xl font-bold text-gray-800">' + utils.escapeHtml(report.campaignName || 'Campaign Report') + '</h3>';
                    if (isNew) {
                        html += '<span class="notification-dot"></span>';
                    }
                    html += '</div>';
                    html += '<p class="text-gray-500">Delivered: ' + (report.sentAt ? new Date(report.sentAt).toLocaleDateString() : 'N/A') + '</p>';
                    html += '</div>';
                    html += '<div class="flex items-center gap-3">';
                    html += '<button class="px-6 py-3 bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold rounded-xl hover:from-purple-600 hover:to-indigo-700 transition-all">View Report </button>';
                    html += '</div>';
                    html += '</div>';
                    html += '</div>';
                }
                html += '</div>';
            }

            html += '</div></div>';

            return html;
        }

        /* ------------------------------------------
           4.6.17 View Report (Client View)
           ------------------------------------------ */
        function renderViewReport() {
            var html = '';
            var report = state.currentReport || {};
            var content = report.editedContent || {};

            html += '<div class="min-h-screen mobile-full-screen py-8 px-4 mobile-wide-container">';
            html += '<div class="max-w-4xl mx-auto">';

            // Header
            html += '<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4 fade-in">';
            html += '<h1 class="text-3xl lg:text-4xl font-bold text-white">' + utils.escapeHtml(content.title || report.campaignName || 'Campaign Report') + '</h1>';
            html += '<div class="flex gap-3 w-full sm:w-auto">';
            html += '<button onclick="app.downloadReportPDF()" class="btn-primary flex-1 sm:flex-none"> Download PDF</button>';
            html += '<button onclick="app.goToClientReports()" class="btn-secondary flex-1 sm:flex-none"> Back to Reports</button>';
            html += '</div>';
            html += '</div>';

            if (!report.id) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-12 text-center">';
                html += '<div class="spinner spinner-dark mx-auto mb-4"></div>';
                html += '<p class="text-gray-600">Loading report...</p>';
                html += '</div>';
            } else {
                // PDF Content Wrapper - everything inside this will be captured for PDF
                html += '<div id="pdf-report-content">';

                // YouTube Performance Hero Section
                var ytMetrics = content.youtubeMetrics || {};
                if (ytMetrics.publicViews || ytMetrics.impressions) {
                    html += '<div class="youtube-hero fade-in">';
                    html += '<div class="youtube-hero-title"><span></span> YouTube Campaign Performance</div>';

                    // Main Views Card
                    if (ytMetrics.publicViews) {
                        var viewRate = 0;
                        if (ytMetrics.publicViews && ytMetrics.impressions) {
                            viewRate = Math.round((parseInt(String(ytMetrics.publicViews).replace(/,/g, '')) / parseInt(String(ytMetrics.impressions).replace(/,/g, ''))) * 1000) / 10;
                        }
                        html += '<div class="youtube-hero-main">';
                        html += '<div class="youtube-views-label"><span></span> YouTube Public Views</div>';
                        html += '<div class="youtube-views-value">' + utils.escapeHtml(String(ytMetrics.publicViews)) + '</div>';
                        if (viewRate > 0) {
                            html += '<div class="youtube-view-rate">';
                            html += '<div class="view-rate-bar"><div class="view-rate-fill" style="width:' + Math.min(viewRate, 100) + '%"></div></div>';
                            html += '<span class="view-rate-text">' + viewRate + '% View Rate</span>';
                            html += '</div>';
                        }
                        html += '</div>';
                    }

                    // Supporting Metrics Grid
                    html += '<div class="youtube-metrics-grid">';
                    if (ytMetrics.impressions) {
                        html += '<div class="youtube-metric-card">';
                        html += '<div class="youtube-metric-icon"></div>';
                        html += '<div class="youtube-metric-value">' + utils.escapeHtml(String(ytMetrics.impressions)) + '</div>';
                        html += '<div class="youtube-metric-label">Impressions</div>';
                        html += '</div>';
                    }
                    if (ytMetrics.publicViews) {
                        var viewRateCalc = ytMetrics.impressions ? Math.round((parseInt(String(ytMetrics.publicViews).replace(/,/g, '')) / parseInt(String(ytMetrics.impressions).replace(/,/g, ''))) * 1000) / 10 : 0;
                        html += '<div class="youtube-metric-card">';
                        html += '<div class="youtube-metric-icon"></div>';
                        html += '<div class="youtube-metric-value">' + viewRateCalc + '%</div>';
                        html += '<div class="youtube-metric-label">View Rate</div>';
                        html += '</div>';
                    }
                    if (ytMetrics.status) {
                        html += '<div class="youtube-metric-card">';
                        html += '<div class="youtube-metric-icon"></div>';
                        html += '<div class="youtube-metric-value" style="font-size:1rem;">' + utils.escapeHtml(ytMetrics.status) + '</div>';
                        html += '<div class="youtube-metric-label">Status</div>';
                        html += '</div>';
                    }
                    html += '</div>';

                    // Video Info
                    if (ytMetrics.videoTitle || ytMetrics.adType) {
                        html += '<div class="youtube-video-info">';
                        if (ytMetrics.videoTitle) {
                            html += '<div class="youtube-video-title"><span></span> ' + utils.escapeHtml(ytMetrics.videoTitle) + '</div>';
                        }
                        html += '<div class="youtube-video-meta">';
                        if (ytMetrics.adType) {
                            html += '<span class="youtube-video-tag"><span></span> ' + utils.escapeHtml(ytMetrics.adType) + '</span>';
                        }
                        if (ytMetrics.adGroup) {
                            html += '<span class="youtube-video-tag"><span></span> ' + utils.escapeHtml(ytMetrics.adGroup) + '</span>';
                        }
                        if (ytMetrics.status) {
                            html += '<span class="youtube-video-tag status-eligible"><span></span> ' + utils.escapeHtml(ytMetrics.status) + '</span>';
                        }
                        html += '</div>';
                        html += '</div>';
                    }

                    html += '</div>';
                }

                // Report Content Card
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 lg:p-8 fade-in">';

                // Summary
                if (content.summary) {
                    html += '<div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-6 mb-8">';
                    html += '<h3 class="font-bold text-gray-800 mb-2">Executive Summary</h3>';
                    html += '<p class="text-gray-700 text-lg">' + utils.escapeHtml(content.summary) + '</p>';
                    html += '</div>';
                }

                // Narrative Summary (detailed visual analysis)
                if (content.narrativeSummary) {
                    html += '<div class="bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl p-6 mb-8 border border-blue-100">';
                    html += '<div class="flex items-start gap-3">';
                    html += '<span class="text-2xl"></span>';
                    html += '<div>';
                    html += '<h3 class="font-bold text-gray-800 mb-2">Detailed Analysis</h3>';
                    html += '<p class="text-gray-700 leading-relaxed">' + utils.escapeHtml(content.narrativeSummary) + '</p>';
                    html += '</div>';
                    html += '</div>';
                    html += '</div>';
                }

                // Images with Lightbox and Download
                if (report.images && report.images.length > 0) {
                    var imageUrls = report.images.map(function(img) { return img.url; });
                    html += '<div class="mb-8">';
                    html += '<div class="flex items-center justify-between mb-4">';
                    html += '<h3 class="font-bold text-gray-800"> Campaign Screenshots</h3>';
                    html += '<span class="text-sm text-gray-500">Click to enlarge</span>';
                    html += '</div>';
                    html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                    for (var i = 0; i < report.images.length; i++) {
                        var imgUrl = utils.escapeHtml(report.images[i].url);
                        html += '<div class="report-image-item" onclick="app.openLightbox(' + JSON.stringify(imageUrls).replace(/"/g, '&quot;') + ', ' + i + ')">';
                        html += '<img src="' + imgUrl + '" alt="Screenshot ' + (i + 1) + '" />';
                        html += '<div class="report-image-overlay">';
                        html += '<div class="report-image-actions">';
                        html += '<button class="report-image-btn" onclick="event.stopPropagation(); app.openLightbox(' + JSON.stringify(imageUrls).replace(/"/g, '&quot;') + ', ' + i + ')"><span></span> View</button>';
                        html += '<button class="report-image-btn" onclick="event.stopPropagation(); app.downloadImage(\'' + imgUrl + '\', \'screenshot-' + (i + 1) + '.png\')"><span></span> Download</button>';
                        html += '</div>';
                        html += '</div>';
                        html += '</div>';
                    }
                    html += '</div>';
                    html += '</div>';
                }

                // Screenshot Analysis (visual descriptions from AI)
                if (content.screenshotAnalysis && content.screenshotAnalysis.length > 0) {
                    html += '<div class="mb-8">';
                    html += '<div class="flex items-center gap-3 mb-4">';
                    html += '<div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center text-white text-xl"></div>';
                    html += '<div>';
                    html += '<h3 class="font-bold text-gray-800">Visual Analysis</h3>';
                    html += '<p class="text-sm text-gray-500">Detailed breakdown of each screenshot</p>';
                    html += '</div>';
                    html += '</div>';
                    html += '<div class="space-y-4">';
                    for (var sa = 0; sa < content.screenshotAnalysis.length; sa++) {
                        var analysis = content.screenshotAnalysis[sa];
                        html += '<div class="bg-gray-50 rounded-xl p-5 border border-gray-100">';
                        html += '<div class="flex items-center gap-2 mb-3">';
                        html += '<span class="w-7 h-7 bg-indigo-100 text-indigo-700 rounded-full flex items-center justify-center font-bold text-sm">' + (analysis.imageNumber || (sa + 1)) + '</span>';
                        html += '<span class="font-semibold text-gray-800">Screenshot ' + (analysis.imageNumber || (sa + 1)) + '</span>';
                        html += '</div>';
                        if (analysis.description) {
                            html += '<p class="text-gray-700 mb-3">' + utils.escapeHtml(analysis.description) + '</p>';
                        }
                        if (analysis.keyObservations && analysis.keyObservations.length > 0) {
                            html += '<div class="space-y-2">';
                            for (var ko = 0; ko < analysis.keyObservations.length; ko++) {
                                html += '<div class="flex items-start gap-2">';
                                html += '<span class="text-green-500 mt-0.5"></span>';
                                html += '<span class="text-gray-600 text-sm">' + utils.escapeHtml(analysis.keyObservations[ko]) + '</span>';
                                html += '</div>';
                            }
                            html += '</div>';
                        }
                        if (analysis.dataExtracted) {
                            html += '<div class="mt-3 pt-3 border-t border-gray-200">';
                            html += '<p class="text-sm text-gray-500"><span class="font-medium text-gray-700">Key Data:</span> ' + utils.escapeHtml(analysis.dataExtracted) + '</p>';
                            html += '</div>';
                        }
                        html += '</div>';
                    }
                    html += '</div>';
                    html += '</div>';
                }

                // ========== STRATEGIC GROWTH DASHBOARD ==========

                // Calculate Channel Health Score based on recommendations and metrics
                var hasMetrics = content.metrics && Object.keys(content.metrics).length > 0;
                var hasRecommendations = content.recommendations && content.recommendations.length > 0;

                if (hasMetrics || hasRecommendations) {
                    // Calculate health score (based on metrics performance and recommendation priorities)
                    var healthScore = 72; // Default base score
                    var highPriorityCount = 0;
                    var mediumPriorityCount = 0;
                    var lowPriorityCount = 0;

                    if (hasRecommendations) {
                        for (var s = 0; s < content.recommendations.length; s++) {
                            var recItem = content.recommendations[s];
                            var recPriority = typeof recItem === 'object' ? (recItem.priority || 'medium').toLowerCase() : 'medium';
                            if (recPriority === 'high') highPriorityCount++;
                            else if (recPriority === 'medium') mediumPriorityCount++;
                            else lowPriorityCount++;
                        }
                        // Adjust score based on recommendations (fewer high priority = better score)
                        healthScore = Math.max(45, Math.min(92, 85 - (highPriorityCount * 8) - (mediumPriorityCount * 3) + (lowPriorityCount * 2)));
                    }

                    // Determine score color and grade
                    var scoreColor = healthScore >= 80 ? '#22c55e' : healthScore >= 60 ? '#f59e0b' : '#ef4444';
                    var scoreGrade = healthScore >= 85 ? 'Excellent' : healthScore >= 70 ? 'Good' : healthScore >= 55 ? 'Fair' : 'Needs Work';

                    // Category scores (simulate based on recommendations)
                    var thumbnailScore = 75, titleScore = 70, contentScore = 80, engagementScore = 65;
                    if (hasRecommendations) {
                        for (var cs = 0; cs < content.recommendations.length; cs++) {
                            var csRec = content.recommendations[cs];
                            var csCategory = typeof csRec === 'object' ? (csRec.category || '').toLowerCase() : '';
                            var csPriority = typeof csRec === 'object' ? (csRec.priority || 'medium').toLowerCase() : 'medium';
                            var penalty = csPriority === 'high' ? 15 : csPriority === 'medium' ? 8 : 3;
                            if (csCategory.includes('thumbnail')) thumbnailScore = Math.max(40, thumbnailScore - penalty);
                            else if (csCategory.includes('title')) titleScore = Math.max(40, titleScore - penalty);
                            else if (csCategory.includes('content')) contentScore = Math.max(40, contentScore - penalty);
                            else if (csCategory.includes('engagement')) engagementScore = Math.max(40, engagementScore - penalty);
                        }
                    }

                    // Channel Health Score Section
                    html += '<div class="strategic-section">';
                    html += '<div class="strategic-section-header">';
                    html += '<div class="strategic-section-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);"></div>';
                    html += '<div>';
                    html += '<div class="strategic-section-title">Channel Health Score</div>';
                    html += '<div class="strategic-section-subtitle">Overall performance assessment based on analysis</div>';
                    html += '</div>';
                    html += '</div>';

                    html += '<div class="health-score-container">';
                    // SVG Ring Chart
                    var circumference = 2 * Math.PI * 54;
                    var dashoffset = circumference - (healthScore / 100) * circumference;
                    html += '<div class="health-score-ring">';
                    html += '<svg width="140" height="140" viewBox="0 0 140 140">';
                    html += '<circle class="bg-ring" cx="70" cy="70" r="54"></circle>';
                    html += '<circle class="score-ring" cx="70" cy="70" r="54" stroke="' + scoreColor + '" stroke-dasharray="' + circumference + '" stroke-dashoffset="' + dashoffset + '"></circle>';
                    html += '</svg>';
                    html += '<div class="health-score-value">';
                    html += '<div class="health-score-number">' + healthScore + '</div>';
                    html += '<div class="health-score-label">' + scoreGrade + '</div>';
                    html += '</div>';
                    html += '</div>';

                    // Score Breakdown
                    html += '<div class="health-score-breakdown">';
                    var categories = [
                        { name: 'Thumbnails', icon: '', score: thumbnailScore, color: '#f59e0b' },
                        { name: 'Titles & SEO', icon: '', score: titleScore, color: '#8b5cf6' },
                        { name: 'Content Quality', icon: '', score: contentScore, color: '#22c55e' },
                        { name: 'Engagement', icon: '', score: engagementScore, color: '#3b82f6' }
                    ];
                    for (var c = 0; c < categories.length; c++) {
                        var cat = categories[c];
                        html += '<div class="score-category">';
                        html += '<span class="score-category-name">' + cat.icon + ' ' + cat.name + '</span>';
                        html += '<div class="score-category-bar"><div class="score-category-fill" style="width:' + cat.score + '%;background:' + cat.color + ';"></div></div>';
                        html += '</div>';
                    }
                    html += '</div>';
                    html += '</div>';
                    html += '</div>';
                }

                // Enhanced Metrics Dashboard (Google Ads metrics)
                if (hasMetrics) {
                    html += '<div class="strategic-section">';
                    html += '<div class="strategic-section-header">';
                    html += '<div class="strategic-section-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);"></div>';
                    html += '<div>';
                    html += '<div class="strategic-section-title">Campaign Performance Metrics</div>';
                    html += '<div class="strategic-section-subtitle">Key performance indicators from your campaign</div>';
                    html += '</div>';
                    html += '</div>';

                    html += '<div class="metrics-dashboard">';
                    var metricConfig = {
                        impressions: { label: 'Impressions', icon: '', color: '#8b5cf6' },
                        clicks: { label: 'Clicks', icon: '', color: '#3b82f6' },
                        ctr: { label: 'CTR', icon: '', color: '#22c55e' },
                        avgCpc: { label: 'Avg CPC', icon: '', color: '#f59e0b' },
                        cost: { label: 'Total Cost', icon: '', color: '#ef4444' },
                        conversions: { label: 'Conversions', icon: '', color: '#10b981' },
                        conversionRate: { label: 'Conv Rate', icon: '', color: '#6366f1' },
                        costPerConversion: { label: 'Cost/Conv', icon: '', color: '#ec4899' }
                    };
                    for (var mKey in metricConfig) {
                        if (content.metrics[mKey] !== null && content.metrics[mKey] !== undefined) {
                            var mCfg = metricConfig[mKey];
                            html += '<div class="metric-tile" style="--metric-color:' + mCfg.color + ';">';
                            html += '<div class="metric-tile-icon">' + mCfg.icon + '</div>';
                            html += '<div class="metric-tile-value">' + utils.escapeHtml(String(content.metrics[mKey])) + '</div>';
                            html += '<div class="metric-tile-label">' + mCfg.label + '</div>';
                            html += '<div class="metric-tile-trend neutral"></div>';
                            html += '</div>';
                        }
                    }
                    html += '</div>';
                    html += '</div>';
                }

                // Strategic Action Cards (Recommendations)
                if (hasRecommendations) {
                    html += '<div class="strategic-section">';
                    html += '<div class="strategic-section-header">';
                    html += '<div class="strategic-section-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);"></div>';
                    html += '<div>';
                    html += '<div class="strategic-section-title">Strategic Action Plan</div>';
                    html += '<div class="strategic-section-subtitle">' + content.recommendations.length + ' recommendations to accelerate your channel growth</div>';
                    html += '</div>';
                    html += '</div>';

                    html += '<div class="action-cards-grid">';
                    for (var r = 0; r < content.recommendations.length; r++) {
                        var rec = content.recommendations[r];
                        var title = typeof rec === 'string' ? rec : rec.title;
                        var desc = typeof rec === 'object' ? rec.description : '';
                        var priority = typeof rec === 'object' ? (rec.priority || 'medium').toLowerCase() : 'medium';
                        var category = typeof rec === 'object' ? (rec.category || '') : '';
                        var impact = typeof rec === 'object' ? (rec.expectedImpact || '') : '';
                        var evidence = typeof rec === 'object' ? (rec.evidenceFromScreenshots || '') : '';

                        // Category icons
                        var categoryIcon = '';
                        var categoryLabel = 'General';
                        if (category.toLowerCase().includes('thumbnail')) { categoryIcon = ''; categoryLabel = 'Thumbnail'; }
                        else if (category.toLowerCase().includes('title')) { categoryIcon = ''; categoryLabel = 'Title & SEO'; }
                        else if (category.toLowerCase().includes('description')) { categoryIcon = ''; categoryLabel = 'Description'; }
                        else if (category.toLowerCase().includes('content')) { categoryIcon = ''; categoryLabel = 'Content'; }
                        else if (category.toLowerCase().includes('schedule') || category.toLowerCase().includes('posting')) { categoryIcon = ''; categoryLabel = 'Schedule'; }
                        else if (category.toLowerCase().includes('engagement')) { categoryIcon = ''; categoryLabel = 'Engagement'; }
                        else if (category.toLowerCase().includes('seo') || category.toLowerCase().includes('tag')) { categoryIcon = ''; categoryLabel = 'SEO'; }
                        else if (category.toLowerCase().includes('brand')) { categoryIcon = ''; categoryLabel = 'Branding'; }

                        // Impact percentage (extract or estimate)
                        var impactPercent = 0;
                        if (impact) {
                            var impactMatch = impact.match(/(\d+)/);
                            impactPercent = impactMatch ? Math.min(parseInt(impactMatch[1]), 100) : (priority === 'high' ? 75 : priority === 'medium' ? 50 : 30);
                        } else {
                            impactPercent = priority === 'high' ? 75 : priority === 'medium' ? 50 : 30;
                        }

                        html += '<div class="action-card">';
                        html += '<div class="action-card-header">';
                        html += '<div class="action-card-icon ' + priority + '">' + categoryIcon + '</div>';
                        html += '<div class="action-card-title-area">';
                        html += '<div class="action-card-title">' + utils.escapeHtml(title) + '</div>';
                        html += '<div class="action-card-category">' + categoryLabel + '</div>';
                        html += '</div>';
                        html += '<div class="action-card-badges">';
                        html += '<span class="action-badge priority-' + priority + '">' + (priority === 'high' ? 'High Priority' : priority === 'medium' ? 'Medium' : 'Quick Win') + '</span>';
                        html += '</div>';
                        html += '</div>';

                        if (desc) {
                            html += '<div class="action-card-description">' + utils.escapeHtml(desc) + '</div>';
                        }

                        // Impact Meter
                        html += '<div class="action-card-impact">';
                        html += '<div class="impact-header">';
                        html += '<span class="impact-label"> Expected Impact</span>';
                        html += '<span class="impact-value">' + (impact ? utils.escapeHtml(impact) : (impactPercent + '% improvement')) + '</span>';
                        html += '</div>';
                        html += '<div class="impact-bar"><div class="impact-bar-fill" style="width:' + impactPercent + '%;"></div></div>';
                        html += '</div>';

                        // Evidence if available
                        if (evidence) {
                            html += '<div class="action-card-evidence">';
                            html += '<div class="evidence-label"> Evidence from Analysis</div>';
                            html += '<div class="evidence-text">' + utils.escapeHtml(evidence) + '</div>';
                            html += '</div>';
                        }

                        html += '</div>';
                    }
                    html += '</div>';

                    // Growth Projection
                    var projectedGrowth = Math.min(95, 15 + (highPriorityCount * 12) + (mediumPriorityCount * 6) + (lowPriorityCount * 3));
                    html += '<div class="growth-projection" style="margin-top: 1.5rem;">';
                    html += '<div class="growth-projection-content">';
                    html += '<div class="growth-projection-title"> Growth Projection</div>';
                    html += '<div class="growth-projection-text">Estimated improvement potential if all ' + content.recommendations.length + ' recommendations are implemented</div>';
                    html += '</div>';
                    html += '<div class="growth-projection-value">';
                    html += '<div class="growth-value-number">+' + projectedGrowth + '%</div>';
                    html += '<div class="growth-value-label">Potential Growth</div>';
                    html += '</div>';
                    html += '</div>';

                    html += '</div>';
                }

                // Call to Action
                if (content.callToAction) {
                    html += '<div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl p-6 text-white">';
                    html += '<h3 class="font-bold text-xl mb-2"> Ready to Optimize Your Channel?</h3>';
                    html += '<p class="text-white/90 mb-4">' + utils.escapeHtml(content.callToAction) + '</p>';
                    html += '</div>';
                }

                // Report Date
                html += '<div class="mt-8 pt-6 border-t border-gray-200 text-center text-gray-500">';
                html += '<p>Report generated: ' + (report.createdAt ? new Date(report.createdAt).toLocaleDateString() : 'N/A') + '</p>';
                html += '</div>';

                html += '</div>'; // End white card
                html += '</div>'; // End pdf-report-content
            }

            html += '</div></div>';

            return html;
        }

        /* ==========================================
           4.7 GLOBAL HEADER (Unified Notification Bell)
           ========================================== */

        function renderGlobalHeader() {
            // Only show on authenticated views (not login, register, forgot-password, initializing)
            var authViews = ['login', 'register', 'forgot-password', 'initializing'];
            if (authViews.indexOf(state.currentView) !== -1) {
                return '';
            }

            // Don't show if no user
            if (!state.user) {
                return '';
            }

            var html = '';

            // Click-outside overlay (only when dropdown is open)
            if (state.showNotifications) {
                html += '<div class="notification-overlay" onclick="app.closeNotifications()"></div>';
            }

            // Calculate total unread count from both notification sources
            var reportUnread = state.unreadCount || 0;
            var alertUnread = (state.userNotifications && state.userNotifications.unreadCount) || 0;
            var totalUnread = reportUnread + alertUnread;

            // Global header
            html += '<div class="global-header">';
            html += '<div class="global-header-content">';

            // Token Balance Display (clickable)
            html += '<div class="token-display" onclick="event.stopPropagation(); app.showTokenModal()">';
            html += '<span class="token-icon"></span>';
            html += '<span class="token-amount">' + (state.thumbnailTokenBalance || 0) + '</span>';
            html += '</div>';

            // Unified Notification Bell
            html += '<div class="notification-bell relative" onclick="event.stopPropagation(); app.toggleNotifications()">';
            html += '<span class="text-2xl"></span>';
            // Always render badge element for real-time updates (hidden when count is 0)
            html += '<span class="notification-badge" style="' + (totalUnread > 0 ? '' : 'display:none') + '">' + (totalUnread > 99 ? '99+' : totalUnread) + '</span>';

            // Unified Notification Dropdown with Tabs
            if (state.showNotifications) {
                html += '<div class="notification-dropdown" onclick="event.stopPropagation()">';

                // Tabs
                html += '<div class="notification-tabs">';
                html += '<button onclick="app.setNotificationTab(\'reports\')" class="notification-tab ' + (state.notificationTab === 'reports' ? 'active' : '') + '">';
                html += '<span></span> Reports';
                if (reportUnread > 0) {
                    html += '<span class="notification-tab-badge">' + (reportUnread > 99 ? '99+' : reportUnread) + '</span>';
                }
                html += '</button>';
                html += '<button onclick="app.setNotificationTab(\'alerts\')" class="notification-tab ' + (state.notificationTab === 'alerts' ? 'active' : '') + '">';
                html += '<span></span> Alerts';
                if (alertUnread > 0) {
                    html += '<span class="notification-tab-badge">' + (alertUnread > 99 ? '99+' : alertUnread) + '</span>';
                }
                html += '</button>';
                html += '</div>';

                // Tab Content
                if (state.notificationTab === 'reports') {
                    html += renderReportNotifications();
                } else {
                    html += renderAlertNotifications();
                }

                html += '</div>'; // End dropdown
            }

            html += '</div>'; // End notification-bell

            html += '</div>'; // End global-header-content
            html += '</div>'; // End global-header

            return html;
        }

        // Render Report Notifications (Campaign Reports from Admin)
        function renderReportNotifications() {
            var html = '';
            var notifications = state.notifications || [];

            // Header with mark all read
            if (notifications.length > 0) {
                html += '<div class="notification-header">';
                html += '<span class="notification-header-title">Campaign Reports</span>';
                html += '<button onclick="app.markAllReportNotificationsRead()" class="notification-mark-read">Mark all read</button>';
                html += '</div>';
            }

            // Notification list
            html += '<div class="notification-list">';

            if (notifications.length > 0) {
                for (var n = 0; n < notifications.length; n++) {
                    var notif = notifications[n];
                    html += '<div class="notification-item" onclick="app.openNotificationReport(\'' + notif.reportId + '\', \'' + notif.id + '\')">';
                    html += '<div class="notification-item-content">';
                    html += '<span class="notification-item-icon"></span>';
                    html += '<div class="notification-item-text">';
                    html += '<div class="notification-item-title">' + utils.escapeHtml(notif.title || 'New Report') + '</div>';
                    html += '<div class="notification-item-message">' + utils.escapeHtml(notif.message || 'A new campaign report is available') + '</div>';
                    if (notif.createdAt) {
                        html += '<div class="notification-item-time">' + utils.formatTimeAgo(notif.createdAt) + '</div>';
                    }
                    html += '</div>';
                    html += '</div>';
                    html += '</div>';
                }
            } else {
                html += '<div class="notification-empty">';
                html += '<div class="notification-empty-icon"></div>';
                html += '<p class="notification-empty-text">No campaign reports</p>';
                html += '<p class="notification-empty-subtext">Reports from your admin will appear here</p>';
                html += '</div>';
            }

            html += '</div>';
            return html;
        }

        // Render Alert Notifications (Subscription, Renewal, System alerts)
        function renderAlertNotifications() {
            var html = '';
            var userNotifs = state.userNotifications;
            var notifications = (userNotifs && userNotifs.notifications) || [];
            var isLoading = state.userNotificationsLoading;

            // Header with mark all read
            if (notifications.length > 0) {
                html += '<div class="notification-header">';
                html += '<span class="notification-header-title">System Alerts</span>';
                html += '<button onclick="app.markAllAlertNotificationsRead()" class="notification-mark-read">Mark all read</button>';
                html += '</div>';
            }

            // Notification list
            html += '<div class="notification-list">';

            if (isLoading) {
                html += '<div class="notification-empty">';
                html += '<div class="spinner" style="width:24px;height:24px;margin:0 auto 0.5rem;"></div>';
                html += '<p class="notification-empty-text">Loading alerts...</p>';
                html += '</div>';
            } else if (notifications.length > 0) {
                for (var n = 0; n < notifications.length; n++) {
                    var notif = notifications[n];
                    var icon = '';
                    if (notif.type === 'request_submitted') icon = '';
                    else if (notif.type === 'request_approved') icon = '';
                    else if (notif.type === 'request_denied') icon = '';
                    else if (notif.type === 'subscription_expiring') icon = '';
                    else if (notif.type === 'subscription_expired') icon = '';
                    else if (notif.type === 'bonus_granted') icon = '';
                    else if (notif.type === 'plan_upgraded') icon = '';

                    var itemClass = notif.read ? 'notification-item' : 'notification-item unread';
                    html += '<div class="' + itemClass + '" onclick="app.handleAlertNotificationClick(\'' + notif.id + '\')">';
                    html += '<div class="notification-item-content">';
                    html += '<span class="notification-item-icon">' + icon + '</span>';
                    html += '<div class="notification-item-text">';
                    html += '<div class="notification-item-title">' + utils.escapeHtml(notif.title || 'Notification') + '</div>';
                    html += '<div class="notification-item-message">' + utils.escapeHtml(notif.message || '') + '</div>';
                    if (notif.createdAt) {
                        html += '<div class="notification-item-time">' + utils.formatTimeAgo(notif.createdAt) + '</div>';
                    }
                    html += '</div>';
                    html += '</div>';
                    html += '</div>';
                }
            } else {
                html += '<div class="notification-empty">';
                html += '<div class="notification-empty-icon"></div>';
                html += '<p class="notification-empty-text">No alerts</p>';
                html += '<p class="notification-empty-subtext">You\'re all caught up!</p>';
                html += '</div>';
            }

            html += '</div>';
            return html;
        }

        /* ==========================================
           4.8 MAIN RENDER FUNCTION
           ========================================== */

        // Track previous view for transitions
        var previousView = null;

        // ========== DEBOUNCED RENDER SYSTEM ==========
        // Prevents multiple rapid renders that cause flickering
        var renderPending = false;
        var renderScheduled = false;
        var lastRenderView = null;

        // Track if current render is a view change (for conditional animations)
        // This is set to true on view change, false on same-view re-renders
        var isViewChangeRender = false;

        // Helper function for templates - returns 'fade-in' only on view changes
        function fadeClass() {
            return isViewChangeRender ? 'fade-in' : '';
        }

        // The public render function - debounces multiple calls
        function render() {
            // Mark that a render is needed
            renderPending = true;

            // If already scheduled, the pending render will pick up changes
            if (renderScheduled) return;

            renderScheduled = true;

            // Use requestAnimationFrame to batch multiple state changes
            requestAnimationFrame(function() {
                // Double RAF ensures styles are applied before DOM changes
                requestAnimationFrame(function() {
                    renderScheduled = false;
                    if (renderPending) {
                        renderPending = false;
                        doRender();
                    }
                });
            });
        }

        // Force immediate render (use sparingly - for critical updates)
        function renderNow() {
            renderPending = false;
            renderScheduled = false;
            doRender();
        }

        // The actual render implementation
        function doRender() {
            const root = document.getElementById('app-root');
            if (!root) return;

            // Determine if this is a view change (for conditional animations)
            isViewChangeRender = (lastRenderView !== state.currentView);
            lastRenderView = state.currentView;

            var html = '';

            // Route to correct view
            switch (state.currentView) {
                case 'initializing':
                    html = renderInitializing();
                    break;
                case 'login':
                    html = renderLogin();
                    break;
                case 'register':
                    html = renderRegister();
                    break;
                case 'forgot-password':
                    html = renderForgotPassword();
                    break;
                case 'dashboard':
                    html = renderDashboard();
                    break;
                case 'optimizer':
                    html = renderOptimizer();
                    break;
                case 'results':
                    html = renderResults();
                    break;
                case 'history':
                    html = renderHistory();
                    break;
                case 'admin':
                    html = renderAdmin();
                    break;
                case 'competitor':
                    html = renderCompetitor();
                    break;
                case 'trends':
                    html = renderTrends();
                    break;
                case 'thumbnail':
                    html = renderThumbnail();
                    break;
                case 'placement':
                    html = renderPlacement();
                    break;
                case 'channelAudit':
                    html = renderChannelAudit();
                    break;
                case 'admin-reports':
                    html = renderAdminReports();
                    break;
                case 'report-editor':
                    html = renderReportEditor();
                    break;
                case 'client-reports':
                    html = renderClientReports();
                    break;
                case 'view-report':
                    html = renderViewReport();
                    break;
                default:
                    html = '<div class="view-container view-centered"><div class="spinner"></div></div>';
            }

            // Check if this is a view change (not just a re-render)
            var isViewChange = previousView !== null && previousView !== state.currentView;
            previousView = state.currentView;

            // Helper function to run post-render tasks
            function postRenderTasks() {
                // Render global header (notification bell) for authenticated views
                var existingHeader = document.getElementById('global-header-container');
                var headerHtml = renderGlobalHeader();
                if (headerHtml) {
                    if (!existingHeader) {
                        existingHeader = document.createElement('div');
                        existingHeader.id = 'global-header-container';
                        document.body.appendChild(existingHeader);
                    }
                    existingHeader.innerHTML = headerHtml;
                } else if (existingHeader) {
                    existingHeader.remove();
                }

                // Initialize mobile swipe dots and desktop carousel after DOM update (dashboard only)
                if (state.currentView === 'dashboard') {
                    var carouselEl = document.getElementById('desktopUsageCarousel');
                    var swipeEl = document.getElementById('usageSwipeContainer');

                    // Initialize without flash
                    app.initSwipeDots();
                    app.initDesktopCarousel();
                    updateAuroraTheme();

                    // Show carousel elements
                    if (carouselEl) carouselEl.classList.add('carousel-ready');
                    if (swipeEl) swipeEl.classList.add('carousel-ready');
                }
            }

            // Apply smooth transition for view changes
            if (isViewChange) {
                // OPTIMIZATION: Hide content FIRST, then replace DOM, then animate in
                // This prevents the flash/flicker by ensuring opacity:0 is applied before DOM change
                root.style.opacity = '0';
                root.style.transform = 'translateY(8px)';

                // Use double rAF to ensure the style is painted before DOM replacement
                requestAnimationFrame(function() {
                    requestAnimationFrame(function() {
                        // Now replace DOM while hidden
                        root.innerHTML = html;
                        // Invalidate cached DOM references after DOM change
                        cachedCountdownElements = null;

                        // Run post-render tasks while still hidden
                        postRenderTasks();

                        // Animate in after a micro-delay
                        requestAnimationFrame(function() {
                            root.style.transition = 'opacity 0.2s ease-out, transform 0.2s ease-out';
                            root.style.opacity = '1';
                            root.style.transform = 'translateY(0)';

                            // Clean up inline styles after animation
                            setTimeout(function() {
                                root.style.transition = '';
                                root.style.opacity = '';
                                root.style.transform = '';
                            }, 220);
                        });
                    });
                });
            } else {
                // OPTIMIZATION: For same-view updates, use a micro-fade to reduce perceived flicker
                // Only apply if not in rapid succession (debounce visual effect)
                var now = Date.now();
                var timeSinceLastRender = now - (window._lastRenderTime || 0);
                window._lastRenderTime = now;

                if (timeSinceLastRender > 50) {
                    // Apply subtle opacity change to mask DOM replacement
                    root.style.opacity = '0.97';
                    requestAnimationFrame(function() {
                        root.innerHTML = html;
                        cachedCountdownElements = null;
                        postRenderTasks();
                        requestAnimationFrame(function() {
                            root.style.opacity = '1';
                        });
                    });
                } else {
                    // Rapid updates - skip animation to prevent stacking
                    root.innerHTML = html;
                    cachedCountdownElements = null;
                    postRenderTasks();
                }
            }

            // Render lightbox overlay if open
            if (state.lightboxOpen && state.lightboxImages.length > 0) {
                var lightboxHtml = '<div class="lightbox-overlay" onclick="app.closeLightbox()">';
                lightboxHtml += '<div class="lightbox-content" onclick="event.stopPropagation()">';
                lightboxHtml += '<button class="lightbox-close" onclick="app.closeLightbox()"></button>';

                // Navigation arrows
                if (state.lightboxImages.length > 1) {
                    if (state.lightboxIndex > 0) {
                        lightboxHtml += '<button class="lightbox-nav prev" onclick="app.prevLightboxImage()"></button>';
                    }
                    if (state.lightboxIndex < state.lightboxImages.length - 1) {
                        lightboxHtml += '<button class="lightbox-nav next" onclick="app.nextLightboxImage()"></button>';
                    }
                }

                // Current image
                var currentImg = state.lightboxImages[state.lightboxIndex];
                lightboxHtml += '<img src="' + currentImg + '" class="lightbox-image" alt="Screenshot" />';

                // Actions
                lightboxHtml += '<div class="lightbox-actions">';
                lightboxHtml += '<button class="lightbox-download" onclick="app.downloadImage(\'' + currentImg + '\', \'screenshot-' + (state.lightboxIndex + 1) + '.png\')"> Download Image</button>';
                lightboxHtml += '</div>';

                // Counter
                if (state.lightboxImages.length > 1) {
                    lightboxHtml += '<div class="lightbox-counter">' + (state.lightboxIndex + 1) + ' / ' + state.lightboxImages.length + '</div>';
                }

                lightboxHtml += '</div></div>';

                // Append to body
                var lightboxDiv = document.createElement('div');
                lightboxDiv.id = 'lightbox-container';
                lightboxDiv.innerHTML = lightboxHtml;
                document.body.appendChild(lightboxDiv);

                // Keyboard navigation
                document.onkeydown = function(e) {
                    if (!state.lightboxOpen) return;
                    if (e.key === 'Escape') app.closeLightbox();
                    if (e.key === 'ArrowLeft') app.prevLightboxImage();
                    if (e.key === 'ArrowRight') app.nextLightboxImage();
                };
            } else {
                // Remove lightbox if closed
                var existingLightbox = document.getElementById('lightbox-container');
                if (existingLightbox) existingLightbox.remove();
                document.onkeydown = null;
            }

            // Render renewal modal if open
            if (state.showRenewalModal) {
                var renewalModalHtml = renderRenewalModal();
                var renewalDiv = document.getElementById('renewal-modal-container');
                if (!renewalDiv) {
                    renewalDiv = document.createElement('div');
                    renewalDiv.id = 'renewal-modal-container';
                    document.body.appendChild(renewalDiv);
                }
                renewalDiv.innerHTML = renewalModalHtml;
            } else {
                var existingRenewalModal = document.getElementById('renewal-modal-container');
                if (existingRenewalModal) existingRenewalModal.remove();
            }
        }

        /* ==========================================
           4.8 INITIALIZE APPLICATION
           ========================================== */

        // Pause animations when tab is not visible to save CPU/GPU
        document.addEventListener('visibilitychange', function() {
            var root = document.documentElement;
            if (document.hidden) {
                root.classList.add('animations-paused');
            } else {
                root.classList.remove('animations-paused');
            }
        });

        // Initial render
        render();

        } // end runApp()

    })();
    </script>

    <!-- ============================================
         PWA INSTALL BUTTON - Add to Home Screen
         Triggers native browser install dialog
         ============================================ -->
    <button class="a2hs-native-button" id="a2hsNativeBtn">
        <span class="a2hs-icon"></span>
        <span>Install App</span>
    </button>

    <script>
    // Service Worker Registration (Inline - no external file needed)
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            // Inline service worker code
            const swCode = `
                const CACHE_NAME = 'yt-optimizer-v1';

                self.addEventListener('install', (event) => {
                    console.log('Service Worker: Installing...');
                    self.skipWaiting();
                });

                self.addEventListener('activate', (event) => {
                    console.log('Service Worker: Activated');
                    event.waitUntil(
                        caches.keys().then((cacheNames) => {
                            return Promise.all(
                                cacheNames.map((cache) => {
                                    if (cache !== CACHE_NAME) {
                                        return caches.delete(cache);
                                    }
                                })
                            );
                        })
                    );
                    return self.clients.claim();
                });

                self.addEventListener('fetch', (event) => {
                    if (event.request.method !== 'GET' ||
                        event.request.url.startsWith('chrome-extension://')) {
                        return;
                    }
                    event.respondWith(
                        fetch(event.request)
                            .then((response) => {
                                const responseClone = response.clone();
                                caches.open(CACHE_NAME).then((cache) => {
                                    cache.put(event.request, responseClone);
                                });
                                return response;
                            })
                            .catch(() => caches.match(event.request))
                    );
                });
            `;

            // Create blob and register service worker
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);

            navigator.serviceWorker.register(swUrl, { scope: '/' })
                .then(function(registration) {
                    console.log('ServiceWorker registered:', registration.scope);
                })
                .catch(function(err) {
                    console.log('ServiceWorker registration failed:', err);
                    // Fallback: Try registering from /sw.js if blob fails
                    navigator.serviceWorker.register('/sw.js')
                        .then(function(reg) {
                            console.log('ServiceWorker fallback registered:', reg.scope);
                        })
                        .catch(function(e) {
                            console.log('ServiceWorker fallback also failed:', e);
                        });
                });
        });
    }

    // PWA Install Prompt Handler
    (function() {
        let deferredPrompt = null;
        const button = document.getElementById('a2hsNativeBtn');

        // Check if already installed
        const isInstalled = window.matchMedia('(display-mode: standalone)').matches ||
                           window.navigator.standalone === true;

        if (isInstalled) {
            console.log('App already installed - button will not show');
            return;
        }

        // Capture the beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Show button ONLY when prompt is available
            button.classList.add('show');
            console.log('Native install prompt ready - button now visible');
        });

        // Handle button click - trigger native prompt
        button.addEventListener('click', async () => {
            if (!deferredPrompt) {
                console.log('Install prompt not available');
                return;
            }

            try {
                await deferredPrompt.prompt();
                const result = await deferredPrompt.userChoice;

                if (result.outcome === 'accepted') {
                    console.log('User installed the app');
                    button.classList.remove('show');
                } else {
                    console.log('User dismissed install prompt');
                }

                deferredPrompt = null;
            } catch (err) {
                console.log('Error showing install prompt:', err);
            }
        });

        // Hide button after successful install
        window.addEventListener('appinstalled', () => {
            console.log('App successfully installed');
            button.classList.remove('show');
        });

        // Debug: Check PWA requirements
        console.log('=== PWA Status ===');
        console.log('HTTPS:', window.location.protocol === 'https:');
        console.log('Service Worker Support:', 'serviceWorker' in navigator);
        console.log('Already Installed:', isInstalled);
    })();
    </script>
</body>
</html>
