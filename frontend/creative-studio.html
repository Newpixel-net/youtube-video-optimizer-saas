<!-- ================================================================
     YOUTUBE VIDEO OPTIMIZER - CREATIVE STUDIO
     ================================================================

     Structure:
     - SECTION 1: External Dependencies (CDN)
     - SECTION 2: Styles (CSS)
     - SECTION 3: HTML Container
     - SECTION 4: Scripts (JavaScript)

     Tools: Realtime Canvas, Realtime Gen, Motion, Image Creation,
            Upscaler, Canvas Editor

     Access: All authenticated users (with usage limits)

     Main Dashboard URL: https://ytseo.siteuo.com/video-optimizer

     Last Updated: 2024
     ================================================================ -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Creative Studio - YouTube Video Optimizer</title>

    <!-- ============================================
         SECTION 1: EXTERNAL DEPENDENCIES
         ============================================ -->

    <!-- 1.1 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 1.2 Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-functions-compat.js"></script>

    <!-- ============================================
         SECTION 2: STYLES
         ============================================ -->
    <style>
        /* ------------------------------------------
           2.1 BASE & RESET
           ------------------------------------------ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }

        body {
            background: #0a0a0f;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 1rem;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            color: white;
        }

        #app-root {
            width: 100%;
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }

        /* ------------------------------------------
           2.2 ANIMATIONS
           ------------------------------------------ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes gradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes auroraMove {
            0% { transform: translateX(-20%) rotate(0deg); }
            50% { transform: translateX(20%) rotate(5deg); }
            100% { transform: translateX(-20%) rotate(0deg); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        .animate-pulse {
            animation: pulse 2s ease-in-out infinite;
        }

        .animate-float {
            animation: float 3s ease-in-out infinite;
        }

        /* ------------------------------------------
           2.3 HERO SECTION WITH AURORA
           ------------------------------------------ */
        .hero-section {
            position: relative;
            padding: 2.5rem 2rem 1.5rem;
            overflow: hidden;
            border-radius: 0 0 1.5rem 1.5rem;
            margin: 0 0 1rem 0;
        }

        @media (min-width: 1024px) {
            .hero-section {
                margin: 0 0 1.5rem 0;
                padding: 2.5rem 3rem 1.5rem;
            }
        }

        @media (min-width: 1440px) {
            .hero-section {
                margin: 0 0 1.5rem 0;
                padding: 2.5rem 4rem 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .hero-section {
                margin: 0;
                border-radius: 0 0 1rem 1rem;
                padding: 2rem 1rem 1.5rem;
            }
        }

        .hero-aurora {
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg,
                #1a0a2e 0%,
                #2d1b4e 20%,
                #1e3a5f 40%,
                #0d4f6e 60%,
                #2d1b4e 80%,
                #1a0a2e 100%);
            background-size: 400% 400%;
            animation: gradientFlow 15s ease infinite;
        }

        .hero-aurora::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(ellipse at center,
                rgba(139, 92, 246, 0.3) 0%,
                rgba(236, 72, 153, 0.2) 25%,
                rgba(59, 130, 246, 0.2) 50%,
                transparent 70%);
            animation: auroraMove 20s ease-in-out infinite;
        }

        .hero-aurora::after {
            content: '';
            position: absolute;
            top: 0;
            right: -25%;
            width: 150%;
            height: 150%;
            background: radial-gradient(ellipse at center,
                rgba(236, 72, 153, 0.25) 0%,
                rgba(139, 92, 246, 0.15) 30%,
                transparent 60%);
            animation: auroraMove 25s ease-in-out infinite reverse;
        }

        .hero-content {
            position: relative;
            z-index: 10;
            text-align: center;
        }

        .hero-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #fff 0%, #e0e7ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero-subtitle {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 2rem;
        }

        /* ------------------------------------------
           2.4 TOOL NAVIGATION TABS
           ------------------------------------------ */
        .tool-nav {
            display: flex;
            justify-content: center;
            gap: 0.25rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 9999px;
            padding: 0.5rem;
            max-width: fit-content;
            margin: 0 auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tool-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.75rem 1.25rem;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: rgba(255, 255, 255, 0.6);
            background: transparent;
            border: none;
            min-width: 90px;
        }

        .tool-nav-item:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .tool-nav-item.active {
            color: white;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Featured/Center tool item (Image Creation) */
        .tool-nav-item.featured {
            position: relative;
            min-width: 110px;
            padding: 1.25rem 1.5rem;
            margin: -1.5rem 0.5rem -0.5rem;
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(139, 92, 246, 0.3);
            z-index: 10;
        }

        .tool-nav-item.featured:hover {
            background: rgba(255, 255, 255, 0.18);
            box-shadow: 0 12px 40px rgba(139, 92, 246, 0.4);
        }

        .tool-nav-item.featured.active {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 12px 40px rgba(139, 92, 246, 0.5);
        }

        .tool-nav-item.featured .tool-nav-icon {
            font-size: 1.75rem;
            margin-bottom: 0.35rem;
        }

        .tool-nav-item.featured .tool-nav-icon svg {
            width: 32px;
            height: 32px;
        }

        .tool-nav-item.featured .tool-nav-name {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .tool-nav-icon {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }

        .tool-nav-icon svg {
            width: 24px;
            height: 24px;
        }

        .tool-nav-name {
            font-size: 0.7rem;
            font-weight: 500;
            white-space: nowrap;
        }

        /* Mobile tool nav */
        @media (max-width: 900px) {
            .tool-nav {
                max-width: 100%;
                overflow-x: auto;
                justify-content: flex-start;
                border-radius: 1rem;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }
            .tool-nav::-webkit-scrollbar {
                display: none;
            }
            .tool-nav-item {
                min-width: 80px;
                padding: 0.6rem 1rem;
            }
            .tool-nav-item.featured {
                min-width: 95px;
                padding: 1rem 1.25rem;
                margin: -1rem 0.35rem -0.25rem;
            }
            .tool-nav-item.featured .tool-nav-icon svg {
                width: 28px;
                height: 28px;
            }
            .tool-nav-item.featured .tool-nav-name {
                font-size: 0.75rem;
            }
        }

        /* ------------------------------------------
           2.5 SECTION HEADERS
           ------------------------------------------ */
        .section-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.25rem;
        }

        .section-header .gradient-text {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ------------------------------------------
           2.6 FEATURED CARDS
           ------------------------------------------ */
        .featured-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2.5rem;
        }

        @media (max-width: 1024px) {
            .featured-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .featured-grid {
                grid-template-columns: 1fr;
            }
        }

        .featured-card {
            position: relative;
            border-radius: 1rem;
            overflow: hidden;
            aspect-ratio: 16/10;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #1a1a2e;
        }

        .featured-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        .featured-card-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .featured-card-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 60%);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 1rem;
        }

        .featured-card-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: #ec4899;
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            border-radius: 0.25rem;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            width: fit-content;
        }

        .featured-card-badge.green {
            background: #22c55e;
        }

        .featured-card-badge.blue {
            background: #3b82f6;
        }

        .featured-card-badge.purple {
            background: #8b5cf6;
        }

        .featured-card-title {
            font-size: 0.8rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .featured-card-subtitle {
            font-size: 1rem;
            font-weight: 700;
            color: white;
            text-transform: uppercase;
        }

        /* ------------------------------------------
           2.7 FILTER TABS
           ------------------------------------------ */
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.7);
        }

        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            color: white;
            border-color: transparent;
        }

        .filter-btn.active-green {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }

        .filter-btn-icon {
            font-size: 1rem;
        }

        .filter-divider {
            width: 1px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            margin: 0 0.5rem;
        }

        /* Category pills */
        .category-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .category-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
        }

        .category-pill:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .category-pill.active {
            background: rgba(139, 92, 246, 0.2);
            border-color: #8b5cf6;
            color: white;
        }

        /* ------------------------------------------
           2.8 MASONRY GALLERY
           ------------------------------------------ */
        .gallery-grid {
            column-count: 4;
            column-gap: 1rem;
        }

        @media (max-width: 1280px) {
            .gallery-grid {
                column-count: 3;
            }
        }

        @media (max-width: 768px) {
            .gallery-grid {
                column-count: 2;
            }
        }

        @media (max-width: 480px) {
            .gallery-grid {
                column-count: 2;
                column-gap: 0.5rem;
            }
        }

        .gallery-item {
            break-inside: avoid;
            margin-bottom: 1rem;
            border-radius: 0.75rem;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .gallery-item:hover {
            transform: scale(1.02);
        }

        .gallery-item:hover .gallery-item-overlay {
            opacity: 1;
        }

        .gallery-item-image {
            width: 100%;
            display: block;
            background: #1a1a2e;
        }

        .gallery-item-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
            display: flex;
            align-items: flex-end;
            padding: 1rem;
        }

        .gallery-item-info {
            color: white;
        }

        .gallery-item-prompt {
            font-size: 0.8rem;
            opacity: 0.9;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* ------------------------------------------
           2.9 EMPTY STATE
           ------------------------------------------ */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 1.5rem;
            border: 1px dashed rgba(255, 255, 255, 0.1);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: white;
        }

        .empty-state-text {
            color: rgba(255, 255, 255, 0.6);
            max-width: 400px;
            margin: 0 auto 1.5rem;
        }

        /* ------------------------------------------
           2.10 BUTTONS
           ------------------------------------------ */
        .btn-primary {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.75rem;
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            color: white;
            font-weight: 600;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(139, 92, 246, 0.4);
        }

        .btn-secondary {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-weight: 600;
            border-radius: 9999px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* ------------------------------------------
           2.11 TOOL CONTENT PANELS
           ------------------------------------------ */
        .tool-panel {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tool-panel.active {
            display: block;
        }

        .tool-placeholder {
            text-align: center;
            padding: 4rem 2rem;
            background: linear-gradient(145deg, rgba(139, 92, 246, 0.1) 0%, rgba(236, 72, 153, 0.05) 100%);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 1.5rem;
            margin-bottom: 2rem;
        }

        .tool-placeholder-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .tool-placeholder-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tool-placeholder-text {
            color: rgba(255, 255, 255, 0.6);
            max-width: 500px;
            margin: 0 auto;
        }

        /* ------------------------------------------
           2.12 BACK BUTTON & HEADER
           ------------------------------------------ */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 20;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
            border-radius: 9999px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* ------------------------------------------
           2.13 LOADING STATES
           ------------------------------------------ */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #8b5cf6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .skeleton {
            background: linear-gradient(90deg,
                rgba(255,255,255,0.05) 25%,
                rgba(255,255,255,0.1) 50%,
                rgba(255,255,255,0.05) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 0.5rem;
        }

        /* ------------------------------------------
           2.14 TOAST NOTIFICATIONS
           ------------------------------------------ */
        .toast {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .toast-success {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }

        .toast-error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .toast-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .toast-info {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .toast {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toast-content {
            flex: 1;
        }

        .toast-retry-btn {
            padding: 0.375rem 0.75rem;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 0.375rem;
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .toast-retry-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .toast-dismiss-btn {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: 50%;
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .toast-dismiss-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            color: white;
        }

        /* ------------------------------------------
           2.15 SCROLLBAR
           ------------------------------------------ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* ------------------------------------------
           2.16 WIDE CONTENT CONTAINER
           ------------------------------------------ */
        .content-wide {
            width: 100%;
            max-width: 100%;
            margin-left: auto;
            margin-right: auto;
            padding-left: 2rem;
            padding-right: 2rem;
        }

        @media (min-width: 1440px) {
            .content-wide {
                padding-left: 3rem;
                padding-right: 3rem;
            }
        }

        @media (min-width: 1920px) {
            .content-wide {
                padding-left: 4rem;
                padding-right: 4rem;
            }
        }

        @media (max-width: 1024px) {
            .content-wide {
                padding-left: 1.5rem;
                padding-right: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .content-wide {
                padding-left: 1rem;
                padding-right: 1rem;
            }
        }

        @media (max-width: 480px) {
            .content-wide {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }
        }

        /* ------------------------------------------
           2.17 TOOL INTERFACE (PHASE 2)
           ------------------------------------------ */
        .tool-interface {
            display: flex;
            gap: 1.5rem;
            min-height: 600px;
            margin-bottom: 2rem;
            animation: fadeIn 0.3s ease;
            align-items: flex-start;
        }

        /* Left Sidebar */
        .tool-sidebar {
            width: 520px;
            min-width: 520px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .sidebar-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 0.75rem;
            padding: 1rem;
        }

        .sidebar-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .sidebar-section-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sidebar-section-badge {
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border-radius: 0.25rem;
            font-weight: 700;
        }

        /* Tool Info Accordion */
        .tool-info-accordion {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 0.75rem;
            padding: 0;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .tool-info-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.875rem 1rem;
            cursor: pointer;
            transition: background 0.2s ease;
            user-select: none;
        }

        .tool-info-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .tool-info-header-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tool-info-icon {
            font-size: 1rem;
        }

        .tool-info-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
        }

        .tool-info-arrow {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
            transition: transform 0.2s ease;
        }

        .tool-info-accordion.open .tool-info-arrow {
            transform: rotate(180deg);
        }

        .tool-info-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }

        .tool-info-accordion.open .tool-info-content {
            max-height: 500px;
            padding: 0 1rem 1rem 1rem;
        }

        .tool-info-description {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.5;
            margin-bottom: 0.75rem;
        }

        .tool-info-features {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .tool-info-feature {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .tool-info-feature-icon {
            color: #10b981;
            font-size: 0.7rem;
            margin-top: 0.1rem;
        }

        /* Model Selector */
        .model-selector {
            display: flex;
            gap: 0.5rem;
        }

        .model-btn {
            flex: 1;
            padding: 0.6rem 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .model-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .model-btn.active {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            border-color: #8b5cf6;
            color: white;
        }

        /* Reference Buttons */
        .reference-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .reference-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.35rem;
            padding: 0.75rem 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px dashed rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .reference-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
            color: white;
        }

        .reference-btn.premium {
            position: relative;
        }

        .reference-btn.premium::after {
            content: 'â˜…';
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 0.6rem;
            color: #f59e0b;
        }

        .reference-btn-icon {
            font-size: 1.25rem;
        }

        .reference-btn.ref-unsupported {
            opacity: 0.5;
            border-color: rgba(245, 158, 11, 0.3);
        }

        .reference-btn.ref-unsupported:hover {
            border-color: rgba(245, 158, 11, 0.5);
        }

        .reference-btn.ref-applied {
            background: rgba(139, 92, 246, 0.15);
            border-color: rgba(139, 92, 246, 0.4);
            border-style: solid;
            position: relative;
        }

        .reference-btn.ref-applied.ref-unsupported {
            border-color: rgba(245, 158, 11, 0.5);
            background: rgba(245, 158, 11, 0.1);
        }

        .reference-btn-preview {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.5rem;
            opacity: 0.3;
        }

        .reference-btn-check {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #22c55e;
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            font-size: 0.6rem;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .reference-btn.ref-unsupported .reference-btn-check {
            background: #f59e0b;
        }

        .references-model-warning {
            font-size: 0.7rem;
            color: #f59e0b;
            margin-left: auto;
        }

        .references-compat-notice {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.75rem;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 0.5rem;
            font-size: 0.75rem;
            color: #f59e0b;
        }

        .ref-switch-btn {
            padding: 0.35rem 0.75rem;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            border: none;
            border-radius: 0.25rem;
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }

        .ref-switch-btn:hover {
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4);
        }

        /* Prompt Textarea */
        .prompt-container {
            position: relative;
        }

        .prompt-textarea {
            width: 100%;
            min-height: 100px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            padding: 0.875rem;
            padding-bottom: 2.5rem;
            color: white;
            font-size: 0.9rem;
            line-height: 1.5;
            resize: none;
            font-family: inherit;
        }

        .prompt-textarea::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .prompt-textarea:focus {
            outline: none;
            border-color: #8b5cf6;
        }

        .prompt-textarea.has-unfilled-vars {
            border-color: #f59e0b;
            animation: pulseWarning 0.5s ease 3;
        }

        @keyframes pulseWarning {
            0%, 100% {
                border-color: #f59e0b;
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0);
            }
            50% {
                border-color: #f59e0b;
                box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.3);
            }
        }

        .prompt-actions {
            position: absolute;
            bottom: 0.5rem;
            left: 0.5rem;
            right: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .prompt-action-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 0.375rem;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
        }

        .prompt-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .prompt-char-count {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.4);
        }

        /* Settings Row */
        .settings-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .settings-group {
            flex: 1;
        }

        .settings-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 0.35rem;
            display: block;
        }

        .settings-select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .settings-select:focus {
            outline: none;
            border-color: #8b5cf6;
        }

        /* Quantity Buttons */
        .quantity-btns {
            display: flex;
            gap: 0.35rem;
        }

        .quantity-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quantity-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .quantity-btn.active {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            border-color: #8b5cf6;
            color: white;
        }

        /* Advanced Settings */
        .advanced-settings-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            margin-top: 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.2s ease;
        }

        .advanced-settings-toggle:hover {
            background: rgba(255, 255, 255, 0.06);
            color: white;
        }

        .advanced-settings-icon {
            font-size: 0.7rem;
            transition: transform 0.2s ease;
        }

        .advanced-settings-badge {
            margin-left: auto;
            padding: 0.15rem 0.5rem;
            background: rgba(139, 92, 246, 0.2);
            border-radius: 0.25rem;
            font-size: 0.7rem;
            color: #c4b5fd;
        }

        .advanced-settings-panel {
            margin-top: 0.75rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.5rem;
            animation: fadeIn 0.2s ease;
        }

        .advanced-setting-group {
            margin-bottom: 1rem;
        }

        .advanced-setting-group:last-child {
            margin-bottom: 0;
        }

        .advanced-setting-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.9);
        }

        .advanced-setting-hint {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .advanced-setting-textarea {
            width: 100%;
            min-height: 60px;
            padding: 0.6rem 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: white;
            font-size: 0.8rem;
            font-family: inherit;
            resize: vertical;
            transition: all 0.2s ease;
        }

        .advanced-setting-textarea:focus {
            outline: none;
            border-color: rgba(139, 92, 246, 0.5);
        }

        .advanced-setting-textarea::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .advanced-setting-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: white;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .advanced-setting-input:focus {
            outline: none;
            border-color: rgba(139, 92, 246, 0.5);
        }

        .advanced-setting-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .seed-input-row {
            display: flex;
            gap: 0.5rem;
        }

        .seed-input-row .advanced-setting-input {
            flex: 1;
        }

        .seed-random-btn,
        .seed-clear-btn {
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .seed-random-btn:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.3);
        }

        .seed-clear-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .advanced-settings-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding: 0.6rem 0.75rem;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: 0.5rem;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .info-icon {
            font-size: 0.9rem;
        }

        /* Generate Button */
        .generate-section {
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .generate-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            border: none;
            border-radius: 0.75rem;
            color: white;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(139, 92, 246, 0.5);
        }

        .generate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .generate-btn .token-cost {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .token-balance-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding: 0.6rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 0.5rem;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .token-balance-display .balance {
            font-weight: 700;
            color: #22c55e;
        }

        .token-balance-display .rollover {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
        }

        /* Main Area */
        .tool-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            overflow: hidden;
        }

        /* Main Area Tabs */
        .main-tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .main-tab {
            flex: 1;
            padding: 1rem;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .main-tab:hover {
            color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.03);
        }

        .main-tab.active {
            color: white;
            background: rgba(139, 92, 246, 0.1);
            border-bottom: 2px solid #8b5cf6;
        }

        .main-tab-count {
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
        }

        .main-tab.active .main-tab-count {
            background: #8b5cf6;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }

        /* Template Grid */
        .template-categories {
            margin-bottom: 1.5rem;
        }

        .template-category-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .template-category-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(236, 72, 153, 0.2) 100%);
            border-radius: 0.5rem;
            font-size: 1.1rem;
        }

        .template-category-title {
            font-size: 1rem;
            font-weight: 700;
            color: white;
        }

        .template-category-count {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            margin-left: auto;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .template-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.75rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .template-card:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(139, 92, 246, 0.3);
            transform: translateY(-2px);
        }

        .template-card-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.35rem;
        }

        .template-card-desc {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .template-card-cost {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0.5rem;
            padding: 0.2rem 0.5rem;
            background: rgba(139, 92, 246, 0.2);
            border-radius: 9999px;
            font-size: 0.7rem;
            color: #a78bfa;
        }

        /* History Stats */
        .history-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .history-count {
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
        }

        .history-showing {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
        }

        /* History Grid */
        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }

        .history-item {
            position: relative;
            border-radius: 0.75rem;
            overflow: hidden;
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .history-item:hover {
            transform: scale(1.02);
        }

        .history-item-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .history-item-image.loaded {
            opacity: 1;
        }

        .history-item .image-skeleton {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0.03) 25%,
                rgba(255, 255, 255, 0.08) 50%,
                rgba(255, 255, 255, 0.03) 75%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            z-index: 0;
        }

        .history-item-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 0.75rem;
        }

        .history-item:hover .history-item-overlay {
            opacity: 1;
        }

        .history-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .history-action-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 0.5rem;
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .history-action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .history-shared-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.25rem 0.5rem;
            background: rgba(34, 197, 94, 0.9);
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            border-radius: 0.375rem;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* Load More Button */
        .load-more-container {
            display: flex;
            justify-content: center;
            padding: 1.5rem 0;
            margin-top: 1rem;
        }

        .load-more-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 2rem;
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 0.75rem;
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .load-more-btn:hover {
            background: rgba(139, 92, 246, 0.25);
            border-color: rgba(139, 92, 246, 0.5);
            transform: translateY(-2px);
        }

        .load-more-count {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
        }

        /* Community Gallery (Enhanced) */
        .community-item {
            position: relative;
            border-radius: 0.75rem;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.03);
            break-inside: avoid;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .community-item:hover {
            transform: scale(1.02);
        }

        .community-item-image {
            width: 100%;
            display: block;
            opacity: 0;
            transition: opacity 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .community-item-image.loaded {
            opacity: 1;
        }

        /* Skeleton loading animation */
        .image-skeleton {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0.03) 25%,
                rgba(255, 255, 255, 0.08) 50%,
                rgba(255, 255, 255, 0.03) 75%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            z-index: 0;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .community-item-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.85) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 1rem;
        }

        .community-item:hover .community-item-overlay {
            opacity: 1;
        }

        .community-item-prompt {
            font-size: 0.8rem;
            color: white;
            margin-bottom: 0.5rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .community-item-prompt.locked {
            filter: blur(4px);
            user-select: none;
        }

        .community-item-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .community-item-user {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .community-item-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 700;
        }

        .community-item-actions {
            display: flex;
            gap: 0.35rem;
        }

        .community-action-btn {
            padding: 0.35rem 0.6rem;
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: 0.375rem;
            color: white;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .community-action-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .community-action-btn.buy-prompt {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .community-action-btn.buy-prompt:hover {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        }

        .community-action-btn.liked {
            background: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .community-action-btn.liked:hover {
            background: rgba(239, 68, 68, 0.4);
        }

        .private-badge {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.25rem 0.5rem;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 0.25rem;
            font-size: 0.65rem;
            color: #f59e0b;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* Close Tool Button */
        .close-tool-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
            color: white;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 50;
        }

        .close-tool-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* ==========================================
           SMART PROMPT BUILDER UI
           ========================================== */
        .smart-prompt-container {
            background: rgba(255, 255, 255, 0.04);
            border: 2px solid rgba(99, 102, 241, 0.4);
            border-radius: 1rem;
            padding: 1rem;
            position: relative;
        }

        .smart-prompt-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 0.75rem;
        }

        .smart-prompt-text {
            font-size: 0.95rem;
            line-height: 1.7;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 0.75rem;
        }

        .smart-prompt-editable {
            min-height: 80px;
            outline: none;
            word-wrap: break-word;
        }

        /* Inline dropdown chip in prompt */
        .prompt-dropdown-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.6rem;
            background: rgba(99, 102, 241, 0.3);
            border: 1px solid rgba(99, 102, 241, 0.5);
            border-radius: 0.375rem;
            color: white;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .prompt-dropdown-chip:hover {
            background: rgba(99, 102, 241, 0.5);
        }

        .prompt-dropdown-chip::after {
            content: 'â–¾';
            font-size: 0.65rem;
            margin-left: 0.15rem;
            opacity: 0.7;
        }

        /* Image reference chip */
        .prompt-image-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.2rem 0.5rem;
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.4);
            border-radius: 0.375rem;
            color: #10b981;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
        }

        .prompt-image-chip:hover {
            background: rgba(16, 185, 129, 0.3);
        }

        /* Prompt action icons row */
        .smart-prompt-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.25rem;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .smart-action-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.08);
            border: none;
            border-radius: 0.5rem;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1rem;
        }

        .smart-action-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .smart-action-btn.enhancing {
            background: rgba(139, 92, 246, 0.2);
            cursor: wait;
        }

        .smart-action-btn .btn-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #8b5cf6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Prompt Health Indicator */
        .prompt-health {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
        }

        .prompt-health-indicator {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.7rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .prompt-health-indicator.empty {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.4);
        }

        .prompt-health-indicator.short {
            background: rgba(255, 193, 7, 0.15);
            color: #ffc107;
        }

        .prompt-health-indicator.good {
            background: rgba(76, 175, 80, 0.15);
            color: #4caf50;
        }

        .prompt-health-indicator.long {
            background: rgba(255, 152, 0, 0.15);
            color: #ff9800;
        }

        .prompt-health-indicator.limit {
            background: rgba(244, 67, 54, 0.15);
            color: #f44336;
        }

        .prompt-char-count {
            color: rgba(255, 255, 255, 0.4);
            transition: color 0.3s ease;
        }

        .prompt-char-count.warning {
            color: #ff9800;
        }

        .prompt-char-count.danger {
            color: #f44336;
        }

        /* Template Variable Chips Bar */
        .template-vars-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            padding: 0.75rem;
            margin-top: 0.5rem;
            background: rgba(139, 92, 246, 0.1);
            border: 1px dashed rgba(139, 92, 246, 0.3);
            border-radius: 0.75rem;
        }

        .template-vars-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
            margin-right: 0.25rem;
        }

        .template-var-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.4rem 0.75rem;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.25) 0%, rgba(99, 102, 241, 0.25) 100%);
            border: 1px solid rgba(139, 92, 246, 0.4);
            border-radius: 9999px;
            color: #c4b5fd;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .template-var-chip:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.4) 0%, rgba(99, 102, 241, 0.4) 100%);
            border-color: rgba(139, 92, 246, 0.6);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .template-var-chip-icon {
            font-size: 0.7rem;
        }

        .template-var-chip-name {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.75rem;
        }

        /* Variable Input Popup */
        .variable-input-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease-out;
        }

        .variable-input-popup {
            background: linear-gradient(180deg, rgba(35, 35, 55, 0.98) 0%, rgba(25, 25, 45, 0.98) 100%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 1rem;
            width: 100%;
            max-width: 380px;
            padding: 1.5rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.2s ease-out;
        }

        .variable-input-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .variable-input-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .variable-input-title {
            font-size: 1rem;
            font-weight: 600;
            color: white;
        }

        .variable-input-subtitle {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
        }

        .variable-input-field {
            width: 100%;
            padding: 0.875rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.75rem;
            color: white;
            font-size: 0.95rem;
            outline: none;
            transition: all 0.2s ease;
            margin-bottom: 1rem;
        }

        .variable-input-field:focus {
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }

        .variable-input-field::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .variable-input-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        .variable-input-btn {
            padding: 0.6rem 1.25rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .variable-input-btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
        }

        .variable-input-btn-cancel:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .variable-input-btn-apply {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
        }

        .variable-input-btn-apply:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        .variable-input-btn-apply:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Dropdown menu for prompt chips */
        .prompt-dropdown-menu {
            position: absolute;
            top: calc(100% + 0.5rem);
            left: 0;
            background: rgba(30, 30, 60, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.75rem;
            padding: 0.5rem;
            min-width: 200px;
            z-index: 100;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .prompt-dropdown-option {
            display: block;
            width: 100%;
            padding: 0.6rem 0.875rem;
            background: transparent;
            border: none;
            border-radius: 0.5rem;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.875rem;
            text-align: left;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .prompt-dropdown-option:hover {
            background: rgba(99, 102, 241, 0.3);
            color: white;
        }

        .prompt-dropdown-option.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }

        .prompt-dropdown-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 0.35rem 0;
        }

        .prompt-dropdown-section {
            padding: 0.35rem 0.875rem;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: rgba(255, 255, 255, 0.4);
        }

        /* Scene quick selector */
        .scene-quick-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .scene-option {
            padding: 0.4rem 0.8rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .scene-option:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .scene-option.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-color: transparent;
            color: white;
        }

        .scene-option.all-random {
            background: rgba(245, 158, 11, 0.15);
            border-color: rgba(245, 158, 11, 0.3);
            color: #fbbf24;
        }

        .scene-option.all-random:hover,
        .scene-option.all-random.active {
            background: rgba(245, 158, 11, 0.3);
        }

        .scene-option.custom {
            background: rgba(16, 185, 129, 0.15);
            border-color: rgba(16, 185, 129, 0.3);
            color: #10b981;
        }

        .scene-option.custom:hover,
        .scene-option.custom.active {
            background: rgba(16, 185, 129, 0.3);
        }

        /* Quantity +/- selector */
        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 0.75rem;
        }

        .quantity-control {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 0.5rem;
            color: white;
            font-size: 1.25rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quantity-control:hover:not(:disabled) {
            background: rgba(99, 102, 241, 0.5);
        }

        .quantity-control:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .quantity-value {
            min-width: 40px;
            text-align: center;
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
        }

        /* Enhanced Generate Button */
        .generate-btn-enhanced {
            width: 100%;
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
            border: none;
            border-radius: 0.75rem;
            color: white;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
        }

        .generate-btn-enhanced:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(59, 130, 246, 0.4);
        }

        .generate-btn-enhanced:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .generate-btn-sparkle {
            display: inline-flex;
            font-size: 1.25rem;
        }

        /* Generation Progress UI */
        .generation-progress-container {
            padding: 1rem;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(236, 72, 153, 0.15) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 0.75rem;
        }

        .generation-stage {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .generation-stage-icon {
            font-size: 1.25rem;
        }

        .generation-stage-label {
            flex: 1;
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
        }

        .generation-stage-percent {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 600;
        }

        .generation-progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }

        .generation-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6 0%, #ec4899 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .generation-stages {
            display: flex;
            justify-content: space-between;
            gap: 0.5rem;
        }

        .generation-stage-step {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            font-size: 1rem;
            opacity: 0.4;
            transition: all 0.3s ease;
        }

        .generation-stage-step.completed {
            opacity: 0.7;
            background: rgba(76, 175, 80, 0.15);
        }

        .generation-stage-step.active {
            opacity: 1;
            background: rgba(139, 92, 246, 0.3);
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.4);
            animation: stagePulse 1.5s ease infinite;
        }

        @keyframes stagePulse {
            0%, 100% {
                box-shadow: 0 0 10px rgba(139, 92, 246, 0.4);
            }
            50% {
                box-shadow: 0 0 20px rgba(139, 92, 246, 0.6);
            }
        }

        @keyframes animate-pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .animate-pulse {
            animation: animate-pulse 1.5s ease infinite;
        }

        /* Cost Breakdown Component */
        .cost-breakdown {
            margin-top: 1rem;
            padding: 0.875rem;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
        }

        .cost-breakdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.625rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 0.625rem;
        }

        .cost-breakdown-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 500;
        }

        .cost-breakdown-total {
            font-size: 1.1rem;
            font-weight: 700;
            color: #fbbf24;
            transition: all 0.3s ease;
        }

        .cost-breakdown-total.insufficient {
            color: #f87171;
        }

        .cost-breakdown-details {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .cost-breakdown-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
        }

        .cost-detail-label {
            color: rgba(255, 255, 255, 0.5);
        }

        .cost-detail-value {
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }

        .cost-breakdown-balance {
            margin-top: 0.75rem;
            padding-top: 0.625rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .balance-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .balance-value {
            font-weight: 600;
            color: white;
        }

        .balance-value.insufficient {
            color: #f87171;
        }

        .balance-warning {
            font-size: 0.7rem;
            color: #f87171;
            margin-top: 0.375rem;
            text-align: right;
        }

        .rollover-info {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.4);
            text-align: right;
            margin-top: 0.25rem;
        }

        /* Selected template indicator */
        .selected-template-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(236, 72, 153, 0.2) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .selected-template-badge-icon {
            font-size: 1.1rem;
        }

        .selected-template-badge-name {
            flex: 1;
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
        }

        .selected-template-badge-cost {
            font-size: 0.75rem;
            color: #fbbf24;
        }

        .selected-template-badge-remove {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .selected-template-badge-remove:hover {
            background: rgba(239, 68, 68, 0.5);
            color: white;
        }

        /* Category Filter Pills (for templates) */
        .category-filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .category-filter-pill {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 9999px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .category-filter-pill:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .category-filter-pill.active {
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            border-color: transparent;
            color: white;
        }

        /* Responsive Tool Interface */

        /* Large screens - wider sidebar */
        @media (min-width: 1440px) {
            .tool-sidebar {
                width: 580px;
                min-width: 580px;
            }

            .tool-interface {
                gap: 2rem;
            }

            .template-grid {
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            }
        }

        /* Extra large screens - even wider */
        @media (min-width: 1800px) {
            .tool-sidebar {
                width: 620px;
                min-width: 620px;
            }

            .tool-interface {
                gap: 2.5rem;
            }

            .template-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }

        /* Medium-large screens */
        @media (max-width: 1280px) {
            .tool-sidebar {
                width: 480px;
                min-width: 480px;
            }
        }

        /* Medium screens - narrower sidebar */
        @media (max-width: 1180px) {
            .tool-sidebar {
                width: 420px;
                min-width: 420px;
            }
        }

        @media (max-width: 1024px) {
            .tool-interface {
                flex-direction: column;
                gap: 1rem;
            }

            .tool-sidebar {
                width: 100%;
                min-width: unset;
                max-width: 100%;
            }

            .template-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }

            .history-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .tool-interface {
                min-height: auto;
            }

            .tool-sidebar {
                padding: 1rem;
            }

            .main-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .main-tab {
                flex: 0 0 auto;
                padding: 0.75rem 1rem;
                font-size: 0.85rem;
            }

            .template-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 0.75rem;
            }

            .category-filter-row {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                flex-wrap: nowrap;
                padding-bottom: 0.75rem;
            }

            .category-filter-pill {
                flex: 0 0 auto;
                white-space: nowrap;
            }
        }

        @media (max-width: 640px) {
            .tool-sidebar {
                padding: 0.875rem;
            }

            .reference-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .settings-row {
                flex-direction: column;
                gap: 0.5rem;
            }

            .settings-group {
                width: 100%;
            }

            .template-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }

            .history-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }

            .template-card {
                padding: 0.75rem;
            }

            .template-card-title {
                font-size: 0.8rem;
            }

            .template-card-desc {
                font-size: 0.7rem;
                -webkit-line-clamp: 1;
            }
        }

        @media (max-width: 400px) {
            .template-grid {
                grid-template-columns: 1fr;
            }

            .quantity-btns {
                flex-wrap: wrap;
            }

            .quantity-btn {
                width: 40px;
                height: 40px;
            }
        }

        /* ==========================================
           PROMPT EDITOR MODAL
           ========================================== */
        .prompt-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            animation: fadeIn 0.2s ease;
        }

        .prompt-modal {
            background: linear-gradient(180deg, rgba(30, 30, 50, 0.98) 0%, rgba(20, 20, 40, 0.98) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 1.25rem;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 80px rgba(139, 92, 246, 0.2), 0 0 0 1px rgba(255, 255, 255, 0.05);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .prompt-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .prompt-modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .prompt-modal-close {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.08);
            border: none;
            border-radius: 0.5rem;
            color: rgba(255, 255, 255, 0.6);
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .prompt-modal-close:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .prompt-modal-body {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .prompt-modal-textarea {
            width: 100%;
            min-height: 280px;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.75rem;
            color: white;
            font-size: 1rem;
            line-height: 1.7;
            resize: vertical;
            font-family: inherit;
        }

        .prompt-modal-textarea:focus {
            outline: none;
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
        }

        .prompt-modal-textarea::placeholder {
            color: rgba(255, 255, 255, 0.35);
        }

        .prompt-modal-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .prompt-modal-actions-row {
            display: flex;
            gap: 0.5rem;
        }

        .prompt-modal-char-count {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .prompt-modal-char-count.warning {
            color: #f59e0b;
        }

        .prompt-modal-char-count.error {
            color: #ef4444;
        }

        /* Template variable chips in modal */
        .prompt-modal-variables {
            margin-top: 1rem;
        }

        .prompt-modal-variables-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 0.5rem;
        }

        .prompt-modal-variables-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .variable-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.4rem 0.75rem;
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.4);
            border-radius: 0.5rem;
            color: #a78bfa;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .variable-chip-icon {
            font-size: 0.7rem;
            opacity: 0.7;
        }

        .prompt-modal-footer {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }

        .prompt-modal-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.625rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .prompt-modal-btn-cancel {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.7);
        }

        .prompt-modal-btn-cancel:hover {
            background: rgba(255, 255, 255, 0.12);
            color: white;
        }

        .prompt-modal-btn-apply {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            border: none;
            color: white;
        }

        .prompt-modal-btn-apply:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        /* Expand button in prompt header */
        .prompt-expand-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.08);
            border: none;
            border-radius: 0.375rem;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .prompt-expand-btn:hover {
            background: rgba(139, 92, 246, 0.3);
            color: white;
        }

        /* ==========================================
           CONFIRMATION DIALOG
           ========================================== */
        .confirm-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 2500;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            animation: fadeIn 0.15s ease;
        }

        .confirm-dialog {
            background: linear-gradient(180deg, rgba(35, 35, 55, 0.98) 0%, rgba(25, 25, 45, 0.98) 100%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 1rem;
            width: 100%;
            max-width: 420px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.2s ease;
        }

        .confirm-dialog-header {
            padding: 1.25rem 1.5rem 0.75rem;
        }

        .confirm-dialog-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 193, 7, 0.15);
            border-radius: 0.75rem;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .confirm-dialog-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.5rem;
        }

        .confirm-dialog-message {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.5;
        }

        .confirm-dialog-preview {
            margin: 1rem 1.5rem;
            padding: 0.875rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .confirm-dialog-preview-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(255, 255, 255, 0.4);
            margin-bottom: 0.5rem;
        }

        .confirm-dialog-footer {
            display: flex;
            gap: 0.75rem;
            padding: 1rem 1.5rem 1.25rem;
        }

        .confirm-dialog-btn {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .confirm-dialog-btn-cancel {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.7);
        }

        .confirm-dialog-btn-cancel:hover {
            background: rgba(255, 255, 255, 0.12);
            color: white;
        }

        .confirm-dialog-btn-replace {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            border: none;
            color: white;
        }

        .confirm-dialog-btn-replace:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        .confirm-dialog-btn-append {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.4);
            color: #4caf50;
        }

        .confirm-dialog-btn-append:hover {
            background: rgba(76, 175, 80, 0.3);
        }

        /* ==========================================
           SHARE TO GALLERY DIALOG
           ========================================== */
        .share-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 2500;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            animation: fadeIn 0.2s ease;
        }

        .share-dialog {
            background: linear-gradient(180deg, rgba(35, 35, 55, 0.98) 0%, rgba(25, 25, 45, 0.98) 100%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 1rem;
            width: 100%;
            max-width: 440px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.2s ease;
        }

        .share-dialog-header {
            padding: 1.5rem 1.5rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .share-dialog-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .share-dialog-subtitle {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 0.5rem;
        }

        .share-dialog-body {
            padding: 1.5rem;
        }

        .share-dialog-preview {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .share-dialog-preview-image {
            width: 80px;
            height: 80px;
            border-radius: 0.5rem;
            object-fit: cover;
        }

        .share-dialog-preview-info {
            flex: 1;
            min-width: 0;
        }

        .share-dialog-preview-prompt {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .share-dialog-option {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .share-dialog-option:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .share-dialog-option.selected {
            border-color: rgba(139, 92, 246, 0.5);
            background: rgba(139, 92, 246, 0.1);
        }

        .share-dialog-option.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .share-dialog-option-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .share-dialog-option-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .share-dialog-option-badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            font-weight: 600;
        }

        .share-dialog-option-desc {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.4;
        }

        .share-dialog-price-input {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .share-dialog-price-label {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .share-dialog-price-field {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .share-dialog-price-field input {
            width: 70px;
            padding: 0.5rem 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            color: white;
            font-size: 0.9rem;
            text-align: center;
        }

        .share-dialog-price-field input:focus {
            outline: none;
            border-color: rgba(139, 92, 246, 0.5);
        }

        .share-dialog-footer {
            display: flex;
            gap: 0.75rem;
            padding: 1rem 1.5rem 1.5rem;
        }

        .share-dialog-btn {
            flex: 1;
            padding: 0.875rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .share-dialog-btn-cancel {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.7);
        }

        .share-dialog-btn-cancel:hover {
            background: rgba(255, 255, 255, 0.12);
            color: white;
        }

        .share-dialog-btn-share {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            border: none;
            color: white;
        }

        .share-dialog-btn-share:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        .share-dialog-btn-share:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .share-dialog-upgrade-hint {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 0.5rem;
            font-size: 0.8rem;
            color: #f59e0b;
            margin-top: 0.5rem;
        }

        .share-dialog-upgrade-hint a {
            color: #f59e0b;
            text-decoration: underline;
        }

        /* ==========================================
           TEMPLATE VARIABLES MODAL
           ========================================== */
        .template-vars-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 2600;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            animation: fadeIn 0.2s ease;
        }

        .template-vars-modal {
            background: linear-gradient(180deg, rgba(35, 35, 55, 0.98) 0%, rgba(25, 25, 45, 0.98) 100%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 1rem;
            width: 100%;
            max-width: 480px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.2s ease;
        }

        .template-vars-header {
            padding: 1.5rem 1.5rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .template-vars-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .template-vars-subtitle {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 0.5rem;
        }

        .template-vars-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .template-vars-preview {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .template-vars-preview-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .template-vars-preview-prompt {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
        }

        .template-vars-preview-prompt .var-highlight {
            background: rgba(139, 92, 246, 0.3);
            color: #c4b5fd;
            padding: 0.1rem 0.3rem;
            border-radius: 0.25rem;
            font-family: monospace;
        }

        .template-var-field {
            margin-bottom: 1rem;
        }

        .template-var-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 0.5rem;
        }

        .template-var-label code {
            background: rgba(139, 92, 246, 0.2);
            color: #c4b5fd;
            padding: 0.15rem 0.4rem;
            border-radius: 0.25rem;
            font-size: 0.8rem;
        }

        .template-var-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.5rem;
            color: white;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .template-var-input:focus {
            outline: none;
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .template-var-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .template-vars-footer {
            display: flex;
            gap: 0.75rem;
            padding: 1rem 1.5rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .template-vars-btn {
            flex: 1;
            padding: 0.875rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .template-vars-btn-cancel {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.7);
        }

        .template-vars-btn-cancel:hover {
            background: rgba(255, 255, 255, 0.12);
            color: white;
        }

        .template-vars-btn-apply {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            border: none;
            color: white;
        }

        .template-vars-btn-apply:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        /* ==========================================
           STYLE REFERENCE MODAL
           ========================================== */
        .style-ref-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
            padding: 1rem;
        }

        .style-ref-modal {
            background: linear-gradient(180deg, rgba(35, 35, 55, 0.98) 0%, rgba(25, 25, 45, 0.98) 100%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 1.25rem;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6);
            animation: fadeIn 0.2s ease;
        }

        .style-ref-modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .style-ref-modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .style-ref-modal-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 0.5rem;
            color: rgba(255, 255, 255, 0.6);
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .style-ref-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .style-ref-warning {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin: 0 1.5rem 1rem;
            padding: 0.875rem 1rem;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 0.5rem;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.4;
        }

        .style-ref-warning .warning-icon {
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .style-ref-warning .warning-content strong {
            color: #f59e0b;
        }

        .switch-model-btn {
            margin-top: 0.5rem;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            border: none;
            border-radius: 0.375rem;
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .switch-model-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .style-ref-modal-body {
            padding: 1.5rem;
        }

        .style-ref-upload-zone {
            border: 2px dashed rgba(139, 92, 246, 0.4);
            border-radius: 1rem;
            padding: 2.5rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(139, 92, 246, 0.05);
        }

        .style-ref-upload-zone:hover {
            border-color: rgba(139, 92, 246, 0.7);
            background: rgba(139, 92, 246, 0.1);
        }

        .style-ref-upload-zone.dragover {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.15);
            transform: scale(1.01);
        }

        .style-ref-upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.8;
        }

        .style-ref-upload-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.5rem;
        }

        .style-ref-upload-hint {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .style-ref-preview {
            position: relative;
            border-radius: 1rem;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.3);
        }

        .style-ref-preview img {
            width: 100%;
            height: auto;
            max-height: 300px;
            object-fit: contain;
            display: block;
        }

        .style-ref-preview-actions {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            display: flex;
            gap: 0.5rem;
        }

        .style-ref-preview-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-radius: 0.5rem;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .style-ref-preview-btn:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.05);
        }

        .style-ref-preview-btn.remove:hover {
            background: rgba(239, 68, 68, 0.8);
        }

        .style-ref-url-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .style-ref-url-label {
            font-size: 0.85rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.5rem;
            display: block;
        }

        .style-ref-url-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.625rem;
            color: white;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.2s ease;
        }

        .style-ref-url-input:focus {
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }

        .style-ref-url-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .style-ref-modal-footer {
            padding: 1.25rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .style-ref-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.625rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .style-ref-btn-cancel {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.7);
        }

        .style-ref-btn-cancel:hover {
            background: rgba(255, 255, 255, 0.12);
            color: white;
        }

        .style-ref-btn-apply {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            border: none;
            color: white;
        }

        .style-ref-btn-apply:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        .style-ref-btn-apply:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Style reference indicator in sidebar */
        .style-ref-indicator {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 0.625rem;
            margin-top: 0.75rem;
        }

        .style-ref-indicator-thumb {
            width: 48px;
            height: 48px;
            border-radius: 0.5rem;
            object-fit: cover;
        }

        .style-ref-indicator-info {
            flex: 1;
            min-width: 0;
        }

        .style-ref-indicator-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .style-ref-indicator-name {
            font-size: 0.85rem;
            font-weight: 500;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .style-ref-indicator-remove {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 0.375rem;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .style-ref-indicator-remove:hover {
            background: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        /* ==========================================
           PREMIUM FEATURE MODAL
           ========================================== */
        .premium-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
            padding: 1rem;
        }

        .premium-modal {
            background: linear-gradient(180deg, rgba(35, 35, 55, 0.98) 0%, rgba(25, 25, 45, 0.98) 100%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 1.25rem;
            width: 100%;
            max-width: 420px;
            text-align: center;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6);
            animation: fadeIn 0.2s ease;
            overflow: hidden;
        }

        .premium-modal-header {
            padding: 2rem 1.5rem 1rem;
            background: linear-gradient(180deg, rgba(139, 92, 246, 0.15) 0%, transparent 100%);
        }

        .premium-modal-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .premium-modal-title {
            font-size: 1.35rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
        }

        .premium-modal-subtitle {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .premium-modal-body {
            padding: 1.5rem;
        }

        .premium-modal-features {
            text-align: left;
            margin-bottom: 1.5rem;
        }

        .premium-modal-feature {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .premium-modal-feature:last-child {
            border-bottom: none;
        }

        .premium-modal-feature-icon {
            width: 32px;
            height: 32px;
            background: rgba(139, 92, 246, 0.2);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .premium-modal-feature-text {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .premium-modal-footer {
            padding: 0 1.5rem 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .premium-modal-btn-upgrade {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            border: none;
            border-radius: 0.75rem;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .premium-modal-btn-upgrade:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }

        .premium-modal-btn-close {
            width: 100%;
            padding: 0.75rem;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .premium-modal-btn-close:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        /* Hidden file input */
        .hidden-file-input {
            display: none;
        }

        /* ==========================================
           DRAFT NOTIFICATION BANNER
           ========================================== */
        .draft-notification {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.95) 0%, rgba(109, 40, 217, 0.95) 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.75rem;
            padding: 0.875rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 10px 40px rgba(139, 92, 246, 0.4);
            animation: slideDown 0.3s ease;
            max-width: 90%;
            width: auto;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .draft-notification-icon {
            font-size: 1.25rem;
        }

        .draft-notification-content {
            flex: 1;
        }

        .draft-notification-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.125rem;
        }

        .draft-notification-subtitle {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .draft-notification-actions {
            display: flex;
            gap: 0.5rem;
        }

        .draft-notification-btn {
            padding: 0.5rem 0.875rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .draft-notification-btn-restore {
            background: white;
            border: none;
            color: #7c3aed;
        }

        .draft-notification-btn-restore:hover {
            transform: scale(1.02);
        }

        .draft-notification-btn-dismiss {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
        }

        .draft-notification-btn-dismiss:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        @media (max-width: 640px) {
            .draft-notification {
                flex-direction: column;
                text-align: center;
                gap: 0.75rem;
            }

            .draft-notification-actions {
                width: 100%;
            }

            .draft-notification-btn {
                flex: 1;
            }
        }

        /* ==========================================
           FLOATING GENERATE BUTTON
           ========================================== */
        .floating-generate-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 1500;
            display: none;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.75rem;
            animation: floatIn 0.3s ease;
        }

        .floating-generate-container.visible {
            display: flex;
        }

        @keyframes floatIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Settings popover */
        .floating-settings-popover {
            background: linear-gradient(180deg, rgba(30, 30, 50, 0.98) 0%, rgba(20, 20, 40, 0.98) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 1rem;
            padding: 1rem;
            min-width: 220px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5);
            display: none;
            animation: popoverIn 0.2s ease;
        }

        .floating-settings-popover.visible {
            display: block;
        }

        @keyframes popoverIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .floating-settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .floating-settings-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .floating-settings-close {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            border-radius: 0.25rem;
        }

        .floating-settings-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .floating-settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.625rem;
        }

        .floating-settings-row:last-child {
            margin-bottom: 0;
        }

        .floating-settings-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .floating-settings-select {
            padding: 0.4rem 0.6rem;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.375rem;
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .floating-quantity-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .floating-quantity-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.375rem;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .floating-quantity-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.15);
        }

        .floating-quantity-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .floating-quantity-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
            min-width: 20px;
            text-align: center;
        }

        /* Main floating button */
        .floating-generate-btn {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            border: none;
            border-radius: 1rem;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 8px 30px rgba(139, 92, 246, 0.4);
            transition: all 0.2s ease;
        }

        .floating-generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(139, 92, 246, 0.5);
        }

        .floating-generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .floating-generate-btn .sparkle {
            font-size: 1.1rem;
        }

        .floating-btn-cost {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0.5rem;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .floating-settings-toggle {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(30, 30, 50, 0.95);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: absolute;
            top: -48px;
            right: 0;
        }

        .floating-settings-toggle:hover {
            background: rgba(139, 92, 246, 0.2);
            color: white;
        }

        .floating-settings-toggle.active {
            background: rgba(139, 92, 246, 0.3);
            border-color: rgba(139, 92, 246, 0.5);
            color: white;
        }

        /* Hide floating button on larger screens */
        @media (min-width: 1025px) {
            .floating-generate-container {
                display: none !important;
            }
        }

        /* Mobile adjustments for floating button */
        @media (max-width: 480px) {
            .floating-generate-container {
                bottom: 1rem;
                right: 1rem;
                left: 1rem;
            }

            .floating-generate-btn {
                width: 100%;
                justify-content: center;
            }

            .floating-settings-popover {
                width: 100%;
            }
        }

        /* ==========================================
           IMAGE DETAIL MODAL
           ========================================== */
        .image-detail-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.92);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            animation: fadeIn 0.2s ease;
        }

        .image-detail-modal {
            background: linear-gradient(180deg, rgba(30, 30, 50, 0.98) 0%, rgba(20, 20, 40, 0.98) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 1.25rem;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 80px rgba(139, 92, 246, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        .image-detail-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .image-detail-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .image-detail-close {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.08);
            border: none;
            border-radius: 0.5rem;
            color: rgba(255, 255, 255, 0.6);
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .image-detail-close:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .image-detail-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .image-detail-body {
                flex-direction: column;
            }
        }

        .image-detail-preview {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            background: rgba(0, 0, 0, 0.3);
            min-height: 300px;
        }

        .image-detail-preview img {
            max-width: 100%;
            max-height: 60vh;
            border-radius: 0.75rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .image-detail-info {
            width: 300px;
            padding: 1.5rem;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .image-detail-info {
                width: 100%;
                border-left: none;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                max-height: 40vh;
            }
        }

        .image-detail-section {
            margin-bottom: 1.25rem;
        }

        .image-detail-section:last-child {
            margin-bottom: 0;
        }

        .image-detail-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 0.4rem;
        }

        .image-detail-value {
            font-size: 0.9rem;
            color: white;
            line-height: 1.5;
        }

        .image-detail-prompt {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.85);
            line-height: 1.6;
            background: rgba(0, 0, 0, 0.2);
            padding: 0.75rem;
            border-radius: 0.5rem;
            max-height: 120px;
            overflow-y: auto;
        }

        .image-detail-meta-row {
            display: flex;
            gap: 1rem;
        }

        .image-detail-meta-item {
            flex: 1;
        }

        .image-detail-actions {
            display: flex;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }

        .image-detail-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border-radius: 0.625rem;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .image-detail-btn-primary {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            border: none;
            color: white;
        }

        .image-detail-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        .image-detail-btn-secondary {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.8);
        }

        .image-detail-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.12);
            color: white;
        }

        .image-detail-btn-danger {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
        }

        .image-detail-btn-danger:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        .image-detail-btn-liked {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
        }

        .image-detail-btn-liked:hover {
            background: rgba(239, 68, 68, 0.25);
        }

        /* Creator info in modal */
        .image-detail-creator {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
        }

        .image-detail-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
        }

        .image-detail-likes {
            margin-left: auto;
            color: #f87171;
            font-size: 0.85rem;
        }

        /* Locked prompt style */
        .image-detail-prompt.locked {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
            background: rgba(139, 92, 246, 0.1);
            border: 1px dashed rgba(139, 92, 246, 0.3);
            padding: 0.75rem;
            border-radius: 0.5rem;
        }

        .prompt-locked-icon {
            font-size: 1.2rem;
        }

        /* ==========================================
           MODEL SELECTOR DROPDOWN
           ========================================== */
        .model-dropdown-wrapper {
            position: relative;
        }

        .model-dropdown-trigger {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.625rem;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .model-dropdown-trigger:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(139, 92, 246, 0.4);
        }

        .model-dropdown-trigger-content {
            display: flex;
            align-items: center;
            gap: 0.625rem;
        }

        .model-dropdown-trigger-icon {
            font-size: 1.1rem;
        }

        .model-dropdown-trigger-name {
            font-weight: 500;
        }

        .model-dropdown-arrow {
            font-size: 0.75rem;
            opacity: 0.6;
            transition: transform 0.2s ease;
        }

        .model-dropdown-trigger.open .model-dropdown-arrow {
            transform: rotate(180deg);
        }

        .model-dropdown-menu {
            position: absolute;
            top: calc(100% + 0.5rem);
            left: 0;
            right: 0;
            background: rgba(25, 25, 45, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.75rem;
            padding: 0.5rem;
            z-index: 100;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5);
            display: none;
            animation: dropdownIn 0.2s ease;
        }

        .model-dropdown-menu.open {
            display: block;
        }

        @keyframes dropdownIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .model-dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
            padding: 0.75rem;
            background: transparent;
            border: none;
            border-radius: 0.5rem;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.875rem;
            text-align: left;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .model-dropdown-item:hover:not(:disabled) {
            background: rgba(139, 92, 246, 0.2);
            color: white;
        }

        .model-dropdown-item.active {
            background: rgba(139, 92, 246, 0.25);
            color: white;
        }

        .model-dropdown-item:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .model-dropdown-item-icon {
            font-size: 1.25rem;
            width: 28px;
            text-align: center;
        }

        .model-dropdown-item-content {
            flex: 1;
        }

        .model-dropdown-item-name {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .model-dropdown-item-desc {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 0.15rem;
        }

        .model-badge {
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            padding: 0.15rem 0.4rem;
            border-radius: 0.25rem;
        }

        .model-badge-suggested {
            background: rgba(59, 130, 246, 0.3);
            color: #60a5fa;
        }

        .model-badge-trending {
            background: rgba(249, 115, 22, 0.3);
            color: #fb923c;
        }

        .model-badge-new {
            background: rgba(34, 197, 94, 0.3);
            color: #4ade80;
        }

        .model-badge-coming {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.5);
        }

        .model-badge-premium {
            background: rgba(251, 191, 36, 0.3);
            color: #fbbf24;
        }

        .model-dropdown-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 0.5rem 0;
        }

        /* ==========================================
           REFERENCES SECTION IMPROVED
           ========================================== */
        .references-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .references-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
        }

        .references-add-btn {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.65rem;
            background: rgba(139, 92, 246, 0.2);
            border: none;
            border-radius: 0.375rem;
            color: #a78bfa;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .references-add-btn:hover {
            background: rgba(139, 92, 246, 0.3);
            color: white;
        }

        .reference-card {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem 0.5rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px dashed rgba(255, 255, 255, 0.15);
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 80px;
        }

        .reference-card:hover:not(.locked) {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(139, 92, 246, 0.4);
        }

        .reference-card.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .reference-card.has-content {
            border-style: solid;
            border-color: rgba(139, 92, 246, 0.4);
            background: rgba(139, 92, 246, 0.1);
        }

        .reference-card-icon {
            font-size: 1.5rem;
            margin-bottom: 0.35rem;
            opacity: 0.7;
        }

        .reference-card-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 500;
        }

        .reference-card-premium {
            position: absolute;
            top: 0.35rem;
            right: 0.35rem;
            font-size: 0.65rem;
            padding: 0.1rem 0.3rem;
            background: rgba(251, 191, 36, 0.3);
            color: #fbbf24;
            border-radius: 0.25rem;
            font-weight: 600;
        }

        .reference-card-preview {
            width: 100%;
            height: 60px;
            object-fit: cover;
            border-radius: 0.5rem;
            margin-bottom: 0.35rem;
        }

        .reference-card-remove {
            position: absolute;
            top: -0.35rem;
            right: -0.35rem;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #ef4444;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 0.7rem;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- ============================================
         SECTION 3: HTML CONTAINER
         ============================================ -->
    <div id="app-root"></div>

    <!-- ============================================
         SECTION 4: SCRIPTS
         ============================================ -->
    <script>
        /* ==========================================
           4.0 PLATFORM VERSION
           ========================================== */
        const PLATFORM_VERSION = '1.0.1';

        /* ==========================================
           4.1 FIREBASE CONFIGURATION
           ========================================== */
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAGczY5ZEIJdTq25BpQdia3lv2I556wOZo",
            authDomain: "ytseo-6d1b0.firebaseapp.com",
            projectId: "ytseo-6d1b0",
            storageBucket: "ytseo-6d1b0.firebasestorage.app",
            messagingSenderId: "382790048044",
            appId: "1:382790048044:web:cd427679ff72108c1f3489"
        };

        // Initialize Firebase
        firebase.initializeApp(FIREBASE_CONFIG);
        const auth = firebase.auth();
        const functions = firebase.functions();
        const db = firebase.firestore();

        /* ==========================================
           4.2 APPLICATION STATE
           ========================================== */
        const state = {
            // View state
            currentView: 'loading', // loading | studio

            // User data
            user: null,
            profile: null,
            hasPremiumAccess: false, // true if user has PRO or Enterprise plan

            // Active tool
            activeTool: 'imageCreation', // realtimeCanvas | realtimeGen | motion | imageCreation | upscaler | canvasEditor

            // Tool Interface State (Phase 2)
            toolInterfaceOpen: false, // true when user clicks "Start Creating"
            mainTab: 'templates', // history | templates | community

            // Generation Settings
            selectedModel: 'auto', // banana1 | banana2 | auto
            prompt: '',
            quantity: 1, // 1-4 images
            aspectRatio: '1:1', // 1:1 | 16:9 | 9:16 | 4:3
            quality: 'hd', // basic | hd | ultra
            negativePrompt: '', // Things to avoid in generation
            seed: '', // For reproducible results (empty = random)
            showAdvancedSettings: false, // Toggle for advanced options

            // References (for advanced features)
            styleReference: null,
            styleReferenceModalOpen: false,
            characterReference: null, // premium - PRO/Enterprise only
            characterReferenceModalOpen: false,
            uploadedImage: null, // premium - PRO/Enterprise only
            imageUploadModalOpen: false,
            premiumModalOpen: false,
            premiumModalFeature: null,

            // Template state
            selectedTemplateCategory: 'all', // all | photorealism | creative | etc
            selectedTemplate: null,
            selectedScene: null, // For product photography scene selection
            sceneMode: null, // 'all' for random, 'custom' for manual input

            // Token state
            tokens: {
                balance: 50,  // current balance
                rollover: 0,  // rolled over from last month
                plan: 'free', // free | lite | pro | business
                lastRefresh: null
            },

            // History (user's creations)
            history: [],
            historyLoading: false,
            historyDisplayCount: 12, // Start with 12, load more on demand

            // Gallery filters
            galleryFilter: 'all', // all | upscaler | motion
            galleryCategory: 'all', // all | animals | fashion | food | landscapes | scifi
            gallerySortBy: 'trending', // trending | newest | popular

            // Gallery data
            galleryItems: [],
            galleryLoading: false,

            // Generation state
            generating: false,
            enhancingPrompt: false,
            generationProgress: 0,
            generationStage: 'idle', // idle, queued, processing, generating, finalizing, complete, error

            // UI state
            loading: false,
            error: null,
            success: null,

            // Prompt Modal state
            promptModalOpen: false,
            promptModalText: '',

            // Floating Generate Button state
            floatingSettingsOpen: false,
            showFloatingButton: false,

            // Image Detail Modal state
            imageDetailModalOpen: false,
            selectedImageDetail: null,
            imageDetailSource: 'history', // 'history' or 'community'

            // Model Dropdown state
            modelDropdownOpen: false,

            // Template Confirmation Dialog state
            confirmDialogOpen: false,
            pendingTemplate: null,

            // Draft notification state
            showDraftNotification: false,

            // Variable input state (single variable - legacy)
            variableInputOpen: false,
            variableInputName: null,
            variableInputValue: '',

            // Template Variables Modal state (multi-variable form)
            templateVariablesModalOpen: false,
            pendingTemplateForVariables: null,
            templateVariables: {}, // { varName: value, ... }
            detectedVariables: [], // ['subject', 'mood', 'style', ...]

            // Tool info accordion state
            toolInfoOpen: false,

            // Community Gallery state
            communityItems: [],
            communityLoading: false,
            communityError: null,
            communityLoaded: false, // Track if we've loaded at least once
            communitySort: 'newest', // newest | popular
            userLikes: {}, // Track which items user has liked: { galleryId: true }

            // Share to Gallery dialog state
            shareDialogOpen: false,
            shareDialogItem: null, // history item to share
            shareDialogPrivate: false, // default is public
            shareDialogPrice: 5, // token price for private prompts
            shareDialogSharing: false // loading state during share
        };

        /* ==========================================
           4.3 TOOL CONFIGURATION
           ========================================== */
        const toolsConfig = [
            {
                key: 'realtimeCanvas',
                name: 'Realtime Canvas',
                icon: 'canvas',
                description: 'Draw and watch AI transform your sketches in real-time',
                features: [
                    'Real-time sketch-to-image transformation',
                    'Multiple brush sizes and colors',
                    'Style transfer from reference images',
                    'Export in high resolution'
                ]
            },
            {
                key: 'realtimeGen',
                name: 'Realtime Gen',
                icon: 'realtime',
                description: 'Generate images instantly as you type your prompts',
                features: [
                    'Live preview as you type',
                    'Fast iteration on ideas',
                    'Multiple style presets',
                    'Instant variations'
                ]
            },
            {
                key: 'motion',
                name: 'Motion',
                icon: 'motion',
                description: 'Bring your images to life with AI-powered animation',
                features: [
                    'Transform static images to video',
                    'Multiple motion styles',
                    'Camera movement effects',
                    'Export as MP4 or GIF'
                ]
            },
            {
                key: 'imageCreation',
                name: 'Image Creation',
                icon: 'image',
                description: 'Create stunning images from text descriptions',
                features: [
                    'Generate up to 4 images at once',
                    'Multiple aspect ratios (1:1, 16:9, 9:16, 4:3)',
                    'Style and character reference support',
                    'Quality settings (Standard, HD, Ultra HD)',
                    'Save to history and share to community'
                ]
            },
            {
                key: 'upscaler',
                name: 'Upscaler',
                icon: 'upscaler',
                description: 'Enhance and upscale your images with AI',
                features: [
                    'Upscale images up to 4x resolution',
                    'AI-powered detail enhancement',
                    'Noise reduction and sharpening',
                    'Face enhancement option'
                ]
            },
            {
                key: 'canvasEditor',
                name: 'Canvas Editor',
                icon: 'editor',
                description: 'Edit and refine your images with powerful AI tools',
                features: [
                    'Inpainting - edit specific areas',
                    'Outpainting - expand image boundaries',
                    'Object removal and replacement',
                    'Background removal and change'
                ]
            }
        ];

        const categoriesConfig = [
            { key: 'all', name: 'All', icon: '##' },
            { key: 'animals', name: 'Animals', icon: '##' },
            { key: 'fashion', name: 'Fashion', icon: '##' },
            { key: 'food', name: 'Food', icon: '##' },
            { key: 'landscapes', name: 'Landscapes', icon: '##' },
            { key: 'scifi', name: 'Sci-Fi', icon: '##' }
        ];

        // Model options for dropdown
        // Gemini models use generateContent() API with image output
        // DALL-E models use OpenAI API
        // Models are mapped to actual API model IDs in the backend (index.js)
        const modelsConfig = [
            {
                key: 'auto',
                name: 'Auto',
                icon: 'âš¡',
                description: 'Best quality model (Imagen 4)',
                badge: 'suggested',
                available: true,
                supportsNegativePrompt: true,
                supportsSeed: true,
                supportsReferenceImages: false
            },
            { divider: true, label: 'Google Imagen' },
            {
                key: 'imagen-4',
                name: 'Imagen 4',
                icon: 'ðŸŽ¨',
                description: 'Google Imagen 4 - Best quality',
                badge: 'recommended',
                available: true,
                supportsNegativePrompt: true,
                supportsSeed: true,
                supportsReferenceImages: false
            },
            {
                key: 'imagen-4-ultra',
                name: 'Imagen 4 Ultra',
                icon: 'ðŸ’Ž',
                description: 'Imagen 4 Ultra - Premium quality',
                badge: 'premium',
                available: true,
                supportsNegativePrompt: true,
                supportsSeed: true,
                supportsReferenceImages: false
            },
            { divider: true, label: 'Gemini Image (Experimental)' },
            {
                key: 'nano-banana-pro',
                name: 'Nano Banana Pro',
                icon: 'ðŸŒ',
                description: 'Gemini 3 Pro - Supports reference images',
                badge: 'beta',
                available: true,
                supportsNegativePrompt: true,
                supportsSeed: false,
                supportsReferenceImages: true
            },
            {
                key: 'nano-banana',
                name: 'Nano Banana',
                icon: 'ðŸ–¼ï¸',
                description: 'Gemini 2.5 Flash - Fast with reference support',
                badge: '',
                available: true,
                supportsNegativePrompt: true,
                supportsSeed: false,
                supportsReferenceImages: true
            },
            { divider: true, label: 'OpenAI DALL-E' },
            {
                key: 'dall-e-3',
                name: 'DALL-E 3',
                icon: 'ðŸŽ­',
                description: 'OpenAI - exceptional detail & accuracy',
                badge: '',
                available: true,
                supportsNegativePrompt: false,
                supportsSeed: false,
                supportsReferenceImages: false
            },
            {
                key: 'dall-e-2',
                name: 'DALL-E 2',
                icon: 'ðŸ–Œï¸',
                description: 'OpenAI - fast & budget-friendly',
                badge: '',
                available: true,
                supportsNegativePrompt: false,
                supportsSeed: false,
                supportsReferenceImages: false
            },
            { divider: true, label: 'Legacy Imagen (if available)' },
            {
                key: 'imagen-3',
                name: 'Imagen 3',
                icon: 'ðŸŒŸ',
                description: 'Google Imagen - if API access available',
                badge: '',
                available: true,
                supportsNegativePrompt: true,
                supportsSeed: true,
                supportsReferenceImages: false
            },
            { divider: true, label: 'Coming Soon' },
            {
                key: 'flux',
                name: 'Flux',
                icon: 'â–³',
                description: 'Most loved by the AI community',
                badge: 'coming',
                available: false,
                supportsNegativePrompt: true,
                supportsSeed: true,
                supportsReferenceImages: false
            },
            {
                key: 'runway',
                name: 'Runway',
                icon: 'â—ˆ',
                description: 'Professional video & image AI',
                badge: 'coming',
                available: false,
                supportsNegativePrompt: true,
                supportsSeed: true,
                supportsReferenceImages: false
            }
        ];

        // Helper function to get current model capabilities
        function getModelCapabilities(modelKey) {
            var model = modelsConfig.find(function(m) { return m.key === modelKey; });
            if (!model) {
                // Default to auto model capabilities
                model = modelsConfig[0];
            }
            return {
                supportsNegativePrompt: model.supportsNegativePrompt || false,
                supportsSeed: model.supportsSeed || false,
                supportsReferenceImages: model.supportsReferenceImages || false
            };
        }

        // Helper function to get model display name
        function getModelDisplayName(modelKey) {
            var model = modelsConfig.find(function(m) { return m.key === modelKey; });
            return model ? model.name : modelKey;
        }

        /* ==========================================
           4.4 FEATURED CONTENT
           ========================================== */
        const featuredCards = [
            {
                id: 1,
                badge: 'How to Use',
                badgeColor: 'pink',
                title: 'STYLE',
                subtitle: 'REFERENCE',
                image: 'https://images.unsplash.com/photo-1579783902614-a3fb3927b6a5?w=400&h=250&fit=crop',
                description: 'Learn how to use style reference to create consistent looks'
            },
            {
                id: 2,
                badge: 'Creating',
                badgeColor: 'green',
                title: 'STYLE',
                subtitle: 'REFERENCE',
                image: 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=400&h=250&fit=crop',
                description: 'Create stunning style references for your projects'
            },
            {
                id: 3,
                badge: 'Using',
                badgeColor: 'blue',
                title: 'CONTENT',
                subtitle: 'REFERENCE',
                image: 'https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=400&h=250&fit=crop',
                description: 'Master content reference for precise control'
            },
            {
                id: 4,
                badge: 'Enhancing',
                badgeColor: 'purple',
                title: 'IMAGES WITH',
                subtitle: 'UPSCALER',
                image: 'https://images.unsplash.com/photo-1518709268805-4e9042af9f23?w=400&h=250&fit=crop',
                description: 'Enhance your images to stunning quality'
            }
        ];

        /* ==========================================
           4.5 PLACEHOLDER GALLERY IMAGES
           ========================================== */
        const placeholderGallery = [
            { id: 1, image: 'https://images.unsplash.com/photo-1579783902614-a3fb3927b6a5?w=400&h=500&fit=crop', prompt: 'Abstract golden art portrait' },
            { id: 2, image: 'https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=400&h=350&fit=crop', prompt: 'Luxury fashion handbag' },
            { id: 3, image: 'https://images.unsplash.com/photo-1539109136881-3be0616acf4b?w=400&h=600&fit=crop', prompt: 'High fashion model in colorful dress' },
            { id: 4, image: 'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?w=400&h=400&fit=crop', prompt: 'Abstract 3D fluid art' },
            { id: 5, image: 'https://images.unsplash.com/photo-1567653418876-5bb0e566e1c2?w=400&h=450&fit=crop', prompt: 'Portrait with golden makeup' },
            { id: 6, image: 'https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=400&h=350&fit=crop', prompt: 'Gourmet food photography' },
            { id: 7, image: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=500&fit=crop', prompt: 'Majestic mountain landscape' },
            { id: 8, image: 'https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=400&h=400&fit=crop', prompt: 'Futuristic sci-fi cityscape' }
        ];

        /* ==========================================
           4.5.1 TEMPLATE LIBRARY DATA
           From Newimagemoduls.md - Organized by Category
           ========================================== */
        const templateCategories = [
            {
                key: 'photorealism',
                name: 'Photorealism & Aesthetics',
                icon: 'ðŸ“¸',
                templates: [
                    {
                        id: 'business-photo',
                        name: 'Business Photo',
                        description: 'Professional LinkedIn headshots and business portraits',
                        cost: 2,
                        prompt: 'Create a detailed {{business}} scene with professional elements for corporate use...'
                    },
                    {
                        id: 'film-style',
                        name: 'Film Style',
                        description: 'Cinematic shots with film grain and classic camera aesthetics',
                        cost: 2,
                        prompt: 'Generate an image in {{film style}} aesthetic, captured on vintage film camera...'
                    },
                    {
                        id: 'mirror-selfie',
                        name: 'Mirror Selfie',
                        description: 'Authentic mirror selfie style portraits',
                        cost: 2,
                        prompt: 'Create a realistic mirror selfie of {{subject}} in a {{setting}}...'
                    },
                    {
                        id: 'pet-store',
                        name: 'Pet Store Scene',
                        description: 'Detailed pet store scenes with vocabulary labels',
                        cost: 2,
                        prompt: 'Create a detailed {{pet store}} scene with English vocabulary labels for all objects...'
                    },
                    {
                        id: 'aesthetic-portrait',
                        name: 'Aesthetic Portrait',
                        description: 'Stylized portraits with artistic lighting and mood',
                        cost: 2,
                        prompt: 'Create an aesthetic portrait with {{mood}} lighting and {{style}} composition...'
                    },
                    {
                        id: 'product-lifestyle',
                        name: 'Product Lifestyle',
                        description: 'Products in lifestyle settings for marketing',
                        cost: 2,
                        prompt: 'Generate a lifestyle product shot of {{product}} in {{environment}}...'
                    }
                ]
            },
            {
                key: 'creative',
                name: 'Creative Experiments',
                icon: 'ðŸŽ¨',
                templates: [
                    {
                        id: 'aging-effect',
                        name: 'Aging Effect',
                        description: 'Show how a person might look at different ages',
                        cost: 3,
                        prompt: 'Transform {{subject}} to show how they would look at age {{age}}...'
                    },
                    {
                        id: 'recursive-image',
                        name: 'Recursive Image',
                        description: 'Images within images, Droste effect',
                        cost: 3,
                        prompt: 'Create a recursive image where {{subject}} holds a picture of themselves holding a picture...'
                    },
                    {
                        id: 'coordinates-art',
                        name: 'Coordinates Art',
                        description: 'Art based on geographic coordinates',
                        cost: 3,
                        prompt: 'Generate an artistic interpretation of location {{coordinates}}...'
                    },
                    {
                        id: 'style-fusion',
                        name: 'Style Fusion',
                        description: 'Combine multiple art styles into one',
                        cost: 3,
                        prompt: 'Fuse {{style1}} and {{style2}} art styles to create {{subject}}...'
                    },
                    {
                        id: 'dream-sequence',
                        name: 'Dream Sequence',
                        description: 'Surreal dreamlike imagery',
                        cost: 3,
                        prompt: 'Create a surreal dream sequence featuring {{elements}} in {{setting}}...'
                    },
                    {
                        id: 'glitch-art',
                        name: 'Glitch Art',
                        description: 'Digital glitch and databending effects',
                        cost: 2,
                        prompt: 'Apply glitch art effects to {{subject}} with {{intensity}} distortion...'
                    },
                    {
                        id: 'miniature-world',
                        name: 'Miniature World',
                        description: 'Tilt-shift miniature effect',
                        cost: 2,
                        prompt: 'Create a tilt-shift miniature world of {{scene}}...'
                    },
                    {
                        id: 'impossible-geometry',
                        name: 'Impossible Geometry',
                        description: 'Escher-style impossible structures',
                        cost: 3,
                        prompt: 'Generate an impossible geometric structure inspired by {{style}}...'
                    }
                ]
            },
            {
                key: 'scripts',
                name: 'Structured Scripts (JSON)',
                icon: 'ðŸ“œ',
                templates: [
                    {
                        id: 'script-2000s-selfie',
                        name: '2000s Mirror Selfie Script',
                        description: 'Detailed JSON-structured script for authentic 2000s selfie - precise control',
                        cost: 3,
                        prompt: 'Create a 2000s Mirror Selfie with detailed JSON specification for {{subject}}...'
                    },
                    {
                        id: 'script-fashion-shoot',
                        name: 'Fashion Photoshoot Script',
                        description: 'Structured script for professional fashion photography',
                        cost: 3,
                        prompt: 'Create a fashion photoshoot with detailed specification for {{model}}...'
                    },
                    {
                        id: 'script-product-hero',
                        name: 'Product Hero Shot Script',
                        description: 'Structured script for hero product photography',
                        cost: 3,
                        prompt: 'Create a product hero shot with detailed specification for {{product}}...'
                    },
                    {
                        id: 'script-character',
                        name: 'Character Portrait Script',
                        description: 'Detailed character specification for consistent portraits',
                        cost: 3,
                        prompt: 'Create a character portrait with detailed specification for {{character}}...'
                    }
                ]
            },
            {
                key: 'education',
                name: 'Education & Knowledge',
                icon: 'ðŸ“š',
                templates: [
                    {
                        id: 'infographic-edu',
                        name: 'Educational Infographic',
                        description: 'Visual explanations of complex topics',
                        cost: 3,
                        prompt: 'Create an educational infographic explaining {{topic}} with clear visual hierarchy...'
                    }
                ]
            },
            {
                key: 'ecommerce',
                name: 'E-commerce & Virtual Studio',
                icon: 'ðŸ›’',
                templates: [
                    {
                        id: 'virtual-tryon',
                        name: 'Virtual Try-On',
                        description: 'See how clothes or accessories look on you',
                        cost: 3,
                        prompt: 'Show {{person}} wearing {{item}} in a realistic try-on visualization...'
                    },
                    {
                        id: 'product-studio',
                        name: 'Product Studio Shot',
                        description: 'Professional product photography on white/colored backgrounds',
                        cost: 2,
                        prompt: 'Create a professional studio shot of {{product}} on {{background}} background...'
                    }
                ]
            },
            {
                key: 'workplace',
                name: 'Workplace & Productivity',
                icon: 'ðŸ’¼',
                templates: [
                    {
                        id: 'flowchart',
                        name: 'Flowchart Generator',
                        description: 'Visual flowcharts and process diagrams',
                        cost: 2,
                        prompt: 'Generate a clear flowchart showing {{process}} with proper symbols and connections...'
                    },
                    {
                        id: 'ui-sketch',
                        name: 'UI Sketch',
                        description: 'Hand-drawn style UI wireframes',
                        cost: 2,
                        prompt: 'Create a hand-drawn UI sketch for {{app type}} showing {{screens}}...'
                    },
                    {
                        id: 'magazine-layout',
                        name: 'Magazine Layout',
                        description: 'Professional magazine page designs',
                        cost: 3,
                        prompt: 'Design a magazine spread for {{topic}} in {{style}} magazine style...'
                    }
                ]
            },
            {
                key: 'photoediting',
                name: 'Photo Editing & Restoration',
                icon: 'âœ¨',
                templates: [
                    {
                        id: 'outpainting',
                        name: 'Outpainting Expand',
                        description: 'Extend images beyond their original borders',
                        cost: 2,
                        prompt: 'Expand this image by {{direction}} maintaining style consistency...'
                    },
                    {
                        id: 'crowd-removal',
                        name: 'Crowd Removal',
                        description: 'Remove people from tourist photos',
                        cost: 2,
                        prompt: 'Remove crowds from {{scene}} while preserving the background...'
                    }
                ]
            },
            {
                key: 'interior',
                name: 'Interior Design',
                icon: 'ðŸ ',
                templates: [
                    {
                        id: 'floor-plan-3d',
                        name: 'Floor Plan to 3D',
                        description: 'Convert 2D floor plans into 3D renders',
                        cost: 3,
                        prompt: 'Transform this floor plan into a 3D rendered visualization with {{style}} interior...'
                    }
                ]
            },
            {
                key: 'social',
                name: 'Social Media & Marketing',
                icon: 'ðŸ“±',
                templates: [
                    {
                        id: 'viral-thumbnail',
                        name: 'Viral Thumbnail',
                        description: 'Eye-catching YouTube/social media thumbnails',
                        cost: 2,
                        prompt: 'Create a viral thumbnail for {{topic}} with expressive face and bold text space...'
                    },
                    {
                        id: 'event-poster',
                        name: 'Event Poster',
                        description: 'Professional event and concert posters',
                        cost: 2,
                        prompt: 'Design an event poster for {{event}} in {{style}} aesthetic...'
                    }
                ]
            },
            {
                key: 'daily',
                name: 'Daily Life & Translation',
                icon: 'ðŸŒ',
                templates: [
                    {
                        id: 'menu-translation',
                        name: 'Menu Translation',
                        description: 'Translate and visualize foreign menus',
                        cost: 2,
                        prompt: 'Translate and visualize this {{language}} menu into {{target language}} with food images...'
                    },
                    {
                        id: 'comic-localization',
                        name: 'Comic Localization',
                        description: 'Translate comics while preserving art style',
                        cost: 3,
                        prompt: 'Localize this comic to {{language}} while maintaining the original art style...'
                    }
                ]
            },
            {
                key: 'avatars',
                name: 'Social Networking & Avatars',
                icon: 'ðŸ‘¤',
                templates: [
                    {
                        id: '3d-avatar',
                        name: '3D Avatar',
                        description: 'Create personalized 3D avatars',
                        cost: 3,
                        prompt: 'Generate a 3D avatar based on {{description}} in {{style}} style...'
                    },
                    {
                        id: 'pet-meme',
                        name: 'Pet Meme Generator',
                        description: 'Turn your pet photos into memes',
                        cost: 2,
                        prompt: 'Transform {{pet}} into a meme with {{expression}} and space for caption...'
                    }
                ]
            },
            {
                key: 'new',
                name: 'New Additions',
                icon: 'ðŸ†•',
                templates: [
                    {
                        id: 'memory-palace',
                        name: 'Memory Palace',
                        description: 'Visual memory aids and mnemonics',
                        cost: 3,
                        prompt: 'Create a memory palace visualization for memorizing {{items}}...'
                    },
                    {
                        id: 'googly-eyes',
                        name: 'Googly Eyes',
                        description: 'Add fun googly eyes to any image',
                        cost: 1,
                        prompt: 'Add googly eyes to {{subject}} in a humorous way...'
                    },
                    {
                        id: 'data-infographic',
                        name: 'Data Infographic',
                        description: 'Turn data into beautiful visualizations',
                        cost: 3,
                        prompt: 'Create a data visualization infographic for {{data}} in {{style}}...'
                    },
                    {
                        id: 'weather-card',
                        name: 'Weather Card',
                        description: 'Beautiful weather forecast cards',
                        cost: 2,
                        prompt: 'Generate a stylish weather card for {{location}} showing {{conditions}}...'
                    }
                ]
            }
        ];

        /* ==========================================
           4.5.2 COMMUNITY GALLERY DATA
           Note: Community gallery now loaded from Firestore via getCommunityGallery()
           See state.communityItems and app.loadCommunityGallery()
           ========================================== */

        /* ==========================================
           4.5.3 TOKEN SYSTEM CONFIGURATION
           ========================================== */
        const tokenConfig = {
            plans: {
                free: { monthly: 50, name: 'Free', color: '#6b7280' },
                lite: { monthly: 200, name: 'Lite', color: '#3b82f6' },
                pro: { monthly: 500, name: 'Pro', color: '#8b5cf6' },
                business: { monthly: 1500, name: 'Business', color: '#f59e0b' }
            },
            costs: {
                basic: 1,
                hd: 2,
                ultra: 4,
                template: 2,  // base cost, varies by template
                upscale: 2,
                motion: 3
            },
            rollover: true,  // tokens roll over to next month
            maxRollover: 500 // max tokens that can roll over
        };

        /* ==========================================
           4.6 UTILITY FUNCTIONS
           ========================================== */
        const utils = {
            escapeHtml: function(text) {
                if (!text) return '';
                var div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            // Draft storage key
            DRAFT_KEY: 'creative_studio_draft',

            // Save draft to localStorage
            saveDraft: function() {
                try {
                    var draft = {
                        prompt: state.prompt,
                        selectedModel: state.selectedModel,
                        quantity: state.quantity,
                        aspectRatio: state.aspectRatio,
                        quality: state.quality,
                        selectedTemplate: state.selectedTemplate ? { id: state.selectedTemplate.id, name: state.selectedTemplate.name } : null,
                        savedAt: new Date().toISOString()
                    };
                    localStorage.setItem(utils.DRAFT_KEY, JSON.stringify(draft));
                } catch (e) {
                    console.warn('Could not save draft:', e);
                }
            },

            // Load draft from localStorage
            loadDraft: function() {
                try {
                    var draftStr = localStorage.getItem(utils.DRAFT_KEY);
                    if (draftStr) {
                        return JSON.parse(draftStr);
                    }
                } catch (e) {
                    console.warn('Could not load draft:', e);
                }
                return null;
            },

            // Clear draft from localStorage
            clearDraft: function() {
                try {
                    localStorage.removeItem(utils.DRAFT_KEY);
                } catch (e) {
                    console.warn('Could not clear draft:', e);
                }
            },

            // Check if draft exists and is recent (within 24 hours)
            hasDraft: function() {
                var draft = utils.loadDraft();
                if (!draft || !draft.savedAt) return false;

                // Check if prompt has content
                if (!draft.prompt || draft.prompt.trim().length === 0) return false;

                // Check if draft is within 24 hours
                var savedTime = new Date(draft.savedAt).getTime();
                var now = Date.now();
                var hoursDiff = (now - savedTime) / (1000 * 60 * 60);
                return hoursDiff < 24;
            },

            // Format draft time for display
            formatDraftTime: function(dateStr) {
                if (!dateStr) return 'recently';
                try {
                    var date = new Date(dateStr);
                    var now = new Date();
                    var diffMs = now - date;
                    var diffMins = Math.floor(diffMs / 60000);
                    var diffHours = Math.floor(diffMs / 3600000);

                    if (diffMins < 1) return 'just now';
                    if (diffMins < 60) return diffMins + ' minute' + (diffMins > 1 ? 's' : '') + ' ago';
                    if (diffHours < 24) return diffHours + ' hour' + (diffHours > 1 ? 's' : '') + ' ago';
                    return date.toLocaleDateString();
                } catch (e) {
                    return 'recently';
                }
            },

            // Modal management utilities
            lockBodyScroll: function() {
                document.body.style.overflow = 'hidden';
                document.body.style.paddingRight = '15px'; // Prevent layout shift from scrollbar removal
            },

            unlockBodyScroll: function() {
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            },

            // Focus trap for modals - returns a cleanup function
            setupFocusTrap: function(modalSelector) {
                var modal = document.querySelector(modalSelector);
                if (!modal) return function() {};

                var focusableElements = modal.querySelectorAll(
                    'button:not([disabled]), textarea:not([disabled]), input:not([disabled]), select:not([disabled]), a[href], [tabindex]:not([tabindex="-1"])'
                );
                var firstFocusable = focusableElements[0];
                var lastFocusable = focusableElements[focusableElements.length - 1];

                function handleKeyDown(e) {
                    if (e.key !== 'Tab') return;

                    if (e.shiftKey) {
                        // Shift + Tab
                        if (document.activeElement === firstFocusable) {
                            e.preventDefault();
                            lastFocusable.focus();
                        }
                    } else {
                        // Tab
                        if (document.activeElement === lastFocusable) {
                            e.preventDefault();
                            firstFocusable.focus();
                        }
                    }
                }

                modal.addEventListener('keydown', handleKeyDown);

                // Focus first element
                if (firstFocusable) {
                    firstFocusable.focus();
                }

                // Return cleanup function
                return function() {
                    modal.removeEventListener('keydown', handleKeyDown);
                };
            }
        };

        /* ==========================================
           4.6.1 IMAGE CACHE SYSTEM
           Fast loading for community/history images
           ========================================== */
        const imageCache = {
            // In-memory cache for blob URLs
            cache: {},
            // Track loading promises to avoid duplicate requests
            loading: {},
            // Cache size limit (number of images)
            maxSize: 100,
            // Cache order for LRU eviction
            order: [],

            // Preload an image and cache it
            preload: function(url) {
                if (!url || imageCache.cache[url] || imageCache.loading[url]) {
                    return imageCache.loading[url] || Promise.resolve(imageCache.cache[url]);
                }

                imageCache.loading[url] = new Promise(function(resolve, reject) {
                    var img = new Image();
                    img.crossOrigin = 'anonymous';

                    img.onload = function() {
                        // Create canvas to convert to blob
                        try {
                            var canvas = document.createElement('canvas');
                            canvas.width = img.naturalWidth;
                            canvas.height = img.naturalHeight;
                            var ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);

                            canvas.toBlob(function(blob) {
                                if (blob) {
                                    var blobUrl = URL.createObjectURL(blob);
                                    imageCache.set(url, blobUrl);
                                    resolve(blobUrl);
                                } else {
                                    // Fallback to original URL
                                    imageCache.set(url, url);
                                    resolve(url);
                                }
                                delete imageCache.loading[url];
                            }, 'image/webp', 0.85);
                        } catch (e) {
                            // Canvas operations might fail due to CORS
                            imageCache.set(url, url);
                            resolve(url);
                            delete imageCache.loading[url];
                        }
                    };

                    img.onerror = function() {
                        delete imageCache.loading[url];
                        resolve(url); // Return original URL on error
                    };

                    img.src = url;
                });

                return imageCache.loading[url];
            },

            // Set cache entry with LRU eviction
            set: function(key, value) {
                // If cache is full, remove oldest entry
                if (imageCache.order.length >= imageCache.maxSize) {
                    var oldest = imageCache.order.shift();
                    if (imageCache.cache[oldest] && imageCache.cache[oldest].startsWith('blob:')) {
                        URL.revokeObjectURL(imageCache.cache[oldest]);
                    }
                    delete imageCache.cache[oldest];
                }

                // Add new entry
                imageCache.cache[key] = value;
                imageCache.order.push(key);
            },

            // Get cached URL or original
            get: function(url) {
                if (imageCache.cache[url]) {
                    // Move to end of order (most recently used)
                    var index = imageCache.order.indexOf(url);
                    if (index > -1) {
                        imageCache.order.splice(index, 1);
                        imageCache.order.push(url);
                    }
                    return imageCache.cache[url];
                }
                return url;
            },

            // Preload multiple images
            preloadBatch: function(urls) {
                var promises = [];
                for (var i = 0; i < Math.min(urls.length, 20); i++) {
                    if (urls[i]) {
                        promises.push(imageCache.preload(urls[i]));
                    }
                }
                return Promise.all(promises);
            },

            // Clear all cache
            clear: function() {
                for (var key in imageCache.cache) {
                    if (imageCache.cache[key] && imageCache.cache[key].startsWith('blob:')) {
                        URL.revokeObjectURL(imageCache.cache[key]);
                    }
                }
                imageCache.cache = {};
                imageCache.order = [];
                imageCache.loading = {};
            }
        };

        // Initialize lazy loading with intersection observer
        var imageObserver = null;
        function initImageObserver() {
            if ('IntersectionObserver' in window) {
                imageObserver = new IntersectionObserver(function(entries) {
                    entries.forEach(function(entry) {
                        if (entry.isIntersecting) {
                            var img = entry.target;
                            var src = img.dataset.src;
                            if (src) {
                                // Use cached version if available
                                var cachedSrc = imageCache.get(src);
                                img.src = cachedSrc;

                                // Preload if not cached
                                if (cachedSrc === src) {
                                    imageCache.preload(src).then(function(newSrc) {
                                        if (img.src === src) {
                                            img.src = newSrc;
                                        }
                                    });
                                }

                                img.classList.add('loaded');
                                imageObserver.unobserve(img);
                            }
                        }
                    });
                }, {
                    rootMargin: '100px', // Start loading 100px before visible
                    threshold: 0.01
                });
            }
        }

        // Apply lazy loading to an image element
        function lazyLoadImage(img) {
            if (imageObserver && img.dataset.src) {
                imageObserver.observe(img);
            } else if (img.dataset.src) {
                // Fallback for browsers without IntersectionObserver
                img.src = img.dataset.src;
            }
        }

        // Setup lazy loading after render
        function setupLazyImages() {
            var images = document.querySelectorAll('img[data-src]:not(.loaded)');
            images.forEach(function(img) {
                lazyLoadImage(img);
            });
        }

        /* ==========================================
           4.7 APPLICATION CONTROLLER
           ========================================== */

        // Debounce timer for prompt updates
        var promptUpdateTimer = null;

        const app = {
            // Navigation
            goToDashboard: function() {
                window.location.href = 'https://ytseo.siteuo.com/video-optimizer';
            },

            // Set active tool
            setActiveTool: function(toolKey) {
                state.activeTool = toolKey;
                state.toolInterfaceOpen = false; // Close interface when switching tools
                render();
            },

            // Gallery filters
            setGalleryFilter: function(filter) {
                state.galleryFilter = filter;
                render();
            },

            setGalleryCategory: function(category) {
                state.galleryCategory = category;
                render();
            },

            setGallerySortBy: function(sortBy) {
                state.gallerySortBy = sortBy;
                render();
            },

            // Open Tool Interface (Phase 2)
            openTool: function(toolKey) {
                state.activeTool = toolKey;
                state.toolInterfaceOpen = true;
                state.mainTab = 'templates'; // Start on templates tab
                render();
                // Update floating button visibility after opening
                setTimeout(function() {
                    app.updateFloatingButtonVisibility();
                }, 50);
            },

            // Close Tool Interface
            closeTool: function() {
                state.toolInterfaceOpen = false;
                render();
            },

            // Main Area Tab Switching
            setMainTab: function(tab) {
                state.mainTab = tab;

                // Auto-load community gallery when switching to community tab
                if (tab === 'community') {
                    app.loadCommunityGallery();
                }

                render();
                // Update floating button visibility after tab change
                setTimeout(function() {
                    app.updateFloatingButtonVisibility();
                }, 50);
            },

            // Model Selection
            setModel: function(model) {
                state.selectedModel = model;
                render();
            },

            // Switch to model with reference image support
            switchToImagen3: function() {
                state.selectedModel = 'nano-banana-pro';
                showToast('Switched to Nano Banana Pro - Reference images are now supported!', 'success');
                render();
            },

            // Quantity Selection
            setQuantity: function(qty) {
                state.quantity = qty;
                render();
            },

            // Aspect Ratio Selection
            setAspectRatio: function(ratio) {
                state.aspectRatio = ratio;
                render();
            },

            // Quality Selection
            setQuality: function(quality) {
                state.quality = quality;
                render();
            },

            // Toggle Advanced Settings
            toggleAdvancedSettings: function() {
                state.showAdvancedSettings = !state.showAdvancedSettings;
                render();
            },

            // Set Negative Prompt
            setNegativePrompt: function(value) {
                state.negativePrompt = value;
            },

            // Set Seed
            setSeed: function(value) {
                // Validate seed is a positive integer
                var seedValue = parseInt(value, 10);
                if (value === '' || value === null) {
                    state.seed = '';
                } else if (!isNaN(seedValue) && seedValue >= 0 && seedValue <= 2147483647) {
                    state.seed = seedValue.toString();
                }
                render();
            },

            // Generate Random Seed
            generateRandomSeed: function() {
                state.seed = Math.floor(Math.random() * 2147483647).toString();
                render();
            },

            // Clear Seed
            clearSeed: function() {
                state.seed = '';
                render();
            },

            // Prompt Update with debounced re-render for variable chips
            updatePrompt: function(text) {
                state.prompt = text;

                // Debounced re-render to update variable chips (300ms delay)
                if (promptUpdateTimer) {
                    clearTimeout(promptUpdateTimer);
                }
                promptUpdateTimer = setTimeout(function() {
                    // Only update the template vars bar, not full re-render
                    var varsBar = document.querySelector('.template-vars-bar');
                    var templateVars = app.getUnfilledVariables(state.prompt);

                    if (templateVars.length > 0) {
                        var html = '<span class="template-vars-label">Fill in:</span>';
                        for (var vi = 0; vi < templateVars.length; vi++) {
                            var varName = templateVars[vi];
                            html += '<button class="template-var-chip" onclick="app.showVariableInput(\'' + utils.escapeHtml(varName) + '\')">';
                            html += '<span class="template-var-chip-icon">âœï¸</span>';
                            html += '<span class="template-var-chip-name">{{' + utils.escapeHtml(varName) + '}}</span>';
                            html += '</button>';
                        }

                        if (varsBar) {
                            varsBar.innerHTML = html;
                        } else {
                            // Need to insert the bar - do a minimal render of just the prompt area
                            render();
                        }
                    } else if (varsBar) {
                        // Remove vars bar if no variables
                        varsBar.remove();
                    }
                }, 300);
            },

            // Template Category Filter
            setTemplateCategory: function(category) {
                state.selectedTemplateCategory = category;
                render();
            },

            // Select Template
            selectTemplate: function(templateId) {
                // Find template
                var foundTemplate = null;
                for (var i = 0; i < templateCategories.length; i++) {
                    var category = templateCategories[i];
                    for (var j = 0; j < category.templates.length; j++) {
                        var template = category.templates[j];
                        if (template.id === templateId) {
                            foundTemplate = template;
                            break;
                        }
                    }
                    if (foundTemplate) break;
                }

                if (!foundTemplate) return;

                // Check if user has existing prompt that would be replaced
                var hasExistingPrompt = state.prompt.trim().length > 10;
                var isNotSameTemplate = !state.selectedTemplate || state.selectedTemplate.id !== templateId;

                if (hasExistingPrompt && isNotSameTemplate) {
                    // Show confirmation dialog
                    state.pendingTemplate = foundTemplate;
                    state.confirmDialogOpen = true;
                    render();
                } else {
                    // Apply template directly
                    app.applyTemplate(foundTemplate, 'replace');
                }
            },

            // Detect all {{variable}} placeholders in a template
            detectTemplateVariables: function(templatePrompt) {
                var regex = /\{\{([^}]+)\}\}/g;
                var variables = [];
                var seenVars = {};
                var match;
                while ((match = regex.exec(templatePrompt)) !== null) {
                    var varName = match[1].trim();
                    if (!seenVars[varName]) {
                        seenVars[varName] = true;
                        variables.push(varName);
                    }
                }
                return variables;
            },

            // Apply template (called directly or after confirmation)
            applyTemplate: function(template, mode) {
                // Close confirm dialog if open
                state.confirmDialogOpen = false;
                state.pendingTemplate = null;

                // Detect variables in template
                var variables = app.detectTemplateVariables(template.prompt);

                if (variables.length > 0) {
                    // Has variables - show the variables modal
                    state.pendingTemplateForVariables = { template: template, mode: mode };
                    state.detectedVariables = variables;
                    state.templateVariables = {};
                    // Initialize with empty values
                    for (var i = 0; i < variables.length; i++) {
                        state.templateVariables[variables[i]] = '';
                    }
                    state.templateVariablesModalOpen = true;
                    render();
                    // Focus first input
                    setTimeout(function() {
                        var firstInput = document.querySelector('.template-var-input');
                        if (firstInput) firstInput.focus();
                    }, 100);
                } else {
                    // No variables - apply directly
                    app.applyTemplateWithVariables(template, mode, {});
                }
            },

            // Apply template after variables are filled
            applyTemplateWithVariables: function(template, mode, variables) {
                state.selectedTemplate = template;

                // Replace variables in prompt
                var processedPrompt = template.prompt;
                for (var varName in variables) {
                    if (variables.hasOwnProperty(varName)) {
                        var value = variables[varName] || varName; // fallback to var name if empty
                        var pattern = new RegExp('\\{\\{' + varName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\}\\}', 'g');
                        processedPrompt = processedPrompt.replace(pattern, value);
                    }
                }

                if (mode === 'replace') {
                    state.prompt = processedPrompt;
                } else if (mode === 'append') {
                    state.prompt = state.prompt.trim() + '\n\n' + processedPrompt;
                }

                // Store variables for backend
                state.templateVariables = variables;

                // Update the textarea
                var textarea = document.getElementById('prompt-textarea');
                if (textarea) textarea.value = state.prompt;

                render();
                showToast('Template applied: ' + template.name, 'success');
            },

            // Update a template variable value
            updateTemplateVariable: function(varName, value) {
                state.templateVariables[varName] = value;
            },

            // Confirm and apply template with filled variables
            confirmTemplateVariables: function() {
                if (!state.pendingTemplateForVariables) return;

                var template = state.pendingTemplateForVariables.template;
                var mode = state.pendingTemplateForVariables.mode;
                var variables = state.templateVariables;

                // Close modal
                state.templateVariablesModalOpen = false;
                state.pendingTemplateForVariables = null;
                state.detectedVariables = [];

                // Apply with variables
                app.applyTemplateWithVariables(template, mode, variables);
            },

            // Cancel template variables modal
            cancelTemplateVariables: function() {
                state.templateVariablesModalOpen = false;
                state.pendingTemplateForVariables = null;
                state.detectedVariables = [];
                state.templateVariables = {};
                render();
            },

            // Cancel template selection
            cancelTemplateConfirm: function() {
                state.confirmDialogOpen = false;
                state.pendingTemplate = null;
                render();
            },

            // Enhance Prompt using AI
            enhancePrompt: function() {
                if (!state.prompt || state.prompt.trim().length === 0) {
                    showToast('Enter a prompt first to enhance', 'warning');
                    return;
                }

                if (state.prompt.length > 500) {
                    showToast('Prompt too long for enhancement (max 500 chars)', 'warning');
                    return;
                }

                if (state.enhancingPrompt) {
                    return; // Already enhancing
                }

                state.enhancingPrompt = true;
                render();
                showToast('Enhancing prompt with AI...', 'info');

                var enhanceCreativePrompt = functions.httpsCallable('enhanceCreativePrompt');
                enhanceCreativePrompt({
                    prompt: state.prompt.trim(),
                    style: state.selectedTemplate ? state.selectedTemplate.id : 'default'
                })
                .then(function(result) {
                    state.enhancingPrompt = false;
                    if (result.data.success && result.data.wasEnhanced) {
                        state.prompt = result.data.enhancedPrompt;
                        var textarea = document.getElementById('prompt-textarea');
                        if (textarea) textarea.value = state.prompt;
                        showToast('Prompt enhanced!', 'success');
                    } else if (result.data.error) {
                        showToast('Enhancement unavailable: ' + result.data.error, 'warning');
                    } else {
                        showToast('Prompt already optimized', 'info');
                    }
                    render();
                })
                .catch(function(error) {
                    state.enhancingPrompt = false;
                    console.error('Enhance prompt error:', error);
                    showToast('Failed to enhance prompt', 'error');
                    render();
                });
            },

            // Clear selected template
            clearTemplate: function() {
                state.selectedTemplate = null;
                state.selectedScene = null;
                state.sceneMode = null;
                render();
            },

            // Increment quantity
            incrementQuantity: function() {
                if (state.quantity < 4) {
                    state.quantity++;
                    render();
                }
            },

            // Decrement quantity
            decrementQuantity: function() {
                if (state.quantity > 1) {
                    state.quantity--;
                    render();
                }
            },

            // Set scene mode (for product photography)
            setSceneMode: function(mode) {
                state.sceneMode = mode;
                if (mode === 'all') {
                    state.selectedScene = 'Random';
                } else if (mode === 'custom') {
                    state.selectedScene = 'Custom';
                }
                render();
            },

            // Select a specific scene
            selectScene: function(scene) {
                state.sceneMode = null;
                state.selectedScene = scene;
                // Update the prompt to include the scene
                if (state.selectedTemplate && state.selectedTemplate.id === 'product-studio') {
                    state.prompt = 'Create a professional product photo with ' + scene + ' background';
                    var textarea = document.getElementById('prompt-textarea');
                    if (textarea) textarea.value = state.prompt;
                }
                render();
            },

            // Random prompt generator
            randomPrompt: function() {
                var randomPrompts = [
                    'A majestic dragon soaring over a misty mountain range at sunrise',
                    'A cozy coffee shop interior with warm lighting and vintage decor',
                    'An astronaut floating in space with Earth in the background',
                    'A futuristic cityscape with flying cars and neon lights',
                    'A serene Japanese garden with cherry blossoms and a koi pond',
                    'A mystical forest with glowing mushrooms and fireflies',
                    'A steampunk airship flying through cloudy skies',
                    'A cute robot watering plants in a sunny greenhouse',
                    'A vintage car parked on a scenic coastal road at sunset',
                    'A magical library with floating books and spiral staircases'
                ];
                var randomIndex = Math.floor(Math.random() * randomPrompts.length);
                state.prompt = randomPrompts[randomIndex];
                var textarea = document.getElementById('prompt-textarea');
                if (textarea) textarea.value = state.prompt;
                render();
            },

            // Clear prompt
            clearPrompt: function() {
                state.prompt = '';
                state.selectedTemplate = null;
                state.selectedScene = null;
                state.sceneMode = null;
                var textarea = document.getElementById('prompt-textarea');
                if (textarea) textarea.value = '';
                utils.clearDraft(); // Also clear saved draft
                render();
            },

            // Restore draft from localStorage
            restoreDraft: function() {
                var draft = utils.loadDraft();
                if (draft) {
                    state.prompt = draft.prompt || '';
                    state.selectedModel = draft.selectedModel || 'auto';
                    state.quantity = draft.quantity || 1;
                    state.aspectRatio = draft.aspectRatio || '1:1';
                    state.quality = draft.quality || 'hd';

                    // Restore template reference if exists
                    if (draft.selectedTemplate && draft.selectedTemplate.id) {
                        // Find the template in categories
                        for (var i = 0; i < templateCategories.length; i++) {
                            var category = templateCategories[i];
                            for (var j = 0; j < category.templates.length; j++) {
                                if (category.templates[j].id === draft.selectedTemplate.id) {
                                    state.selectedTemplate = category.templates[j];
                                    break;
                                }
                            }
                            if (state.selectedTemplate) break;
                        }
                    }

                    render();
                    showToast('Draft restored from ' + utils.formatDraftTime(draft.savedAt), 'info');
                }
            },

            // Dismiss draft notification (just clear the draft, don't restore)
            dismissDraft: function() {
                utils.clearDraft();
                state.showDraftNotification = false;
                render();
            },

            // ========================================
            // PROMPT MODAL HANDLERS
            // ========================================

            // Open prompt modal
            openPromptModal: function() {
                state.promptModalText = state.prompt;
                state.promptModalOpen = true;
                utils.lockBodyScroll();
                render();
                // Focus the modal textarea and setup focus trap after render
                setTimeout(function() {
                    var modalTextarea = document.getElementById('prompt-modal-textarea');
                    if (modalTextarea) {
                        modalTextarea.focus();
                        // Move cursor to end
                        modalTextarea.setSelectionRange(modalTextarea.value.length, modalTextarea.value.length);
                    }
                    // Setup focus trap
                    state._promptModalFocusTrapCleanup = utils.setupFocusTrap('.prompt-modal');
                }, 100);
            },

            // Close prompt modal
            closePromptModal: function(event) {
                // If called from overlay click, only close if clicking the overlay itself
                if (event && event.target && !event.target.classList.contains('prompt-modal-overlay')) {
                    return;
                }
                // Cleanup focus trap
                if (state._promptModalFocusTrapCleanup) {
                    state._promptModalFocusTrapCleanup();
                    state._promptModalFocusTrapCleanup = null;
                }
                utils.unlockBodyScroll();
                state.promptModalOpen = false;
                state.promptModalText = '';
                render();
            },

            // Apply prompt modal changes
            applyPromptModal: function() {
                // Cleanup focus trap
                if (state._promptModalFocusTrapCleanup) {
                    state._promptModalFocusTrapCleanup();
                    state._promptModalFocusTrapCleanup = null;
                }
                utils.unlockBodyScroll();
                state.prompt = state.promptModalText;
                state.promptModalOpen = false;
                state.promptModalText = '';
                // Update the main textarea
                var textarea = document.getElementById('prompt-textarea');
                if (textarea) textarea.value = state.prompt;
                render();
                showToast('Prompt updated!', 'success');
            },

            // Update prompt modal text (without re-render)
            updatePromptModalText: function(text) {
                state.promptModalText = text;
                // Update character count without full re-render
                var charCountEl = document.querySelector('.prompt-modal-char-count');
                if (charCountEl) {
                    var charCount = text.length;
                    var charClass = charCount > 1900 ? 'error' : (charCount > 1500 ? 'warning' : '');
                    charCountEl.textContent = charCount + '/2000';
                    charCountEl.className = 'prompt-modal-char-count ' + charClass;
                }
            },

            // Enhance prompt in modal
            enhancePromptInModal: function() {
                if (!state.promptModalText || state.promptModalText.trim().length === 0) {
                    showToast('Enter a prompt first to enhance', 'warning');
                    return;
                }

                if (state.promptModalText.length > 500) {
                    showToast('Prompt too long for enhancement (max 500 chars)', 'warning');
                    return;
                }

                if (state.enhancingPrompt) {
                    return;
                }

                state.enhancingPrompt = true;
                render();
                showToast('Enhancing prompt with AI...', 'info');

                var enhanceCreativePrompt = functions.httpsCallable('enhanceCreativePrompt');
                enhanceCreativePrompt({
                    prompt: state.promptModalText.trim(),
                    style: state.selectedTemplate ? state.selectedTemplate.id : 'default'
                })
                .then(function(result) {
                    state.enhancingPrompt = false;
                    if (result.data.success && result.data.wasEnhanced) {
                        state.promptModalText = result.data.enhancedPrompt;
                        var textarea = document.getElementById('prompt-modal-textarea');
                        if (textarea) textarea.value = state.promptModalText;
                        showToast('Prompt enhanced!', 'success');
                    } else {
                        showToast('Prompt already optimized', 'info');
                    }
                    render();
                })
                .catch(function(error) {
                    state.enhancingPrompt = false;
                    console.error('Enhance prompt error:', error);
                    showToast('Failed to enhance prompt', 'error');
                    render();
                });
            },

            // Random prompt in modal
            randomPromptInModal: function() {
                var randomPrompts = [
                    'A majestic dragon soaring over a misty mountain range at sunrise',
                    'A cozy coffee shop interior with warm lighting and vintage decor',
                    'An astronaut floating in space with Earth in the background',
                    'A futuristic cityscape with flying cars and neon lights',
                    'A serene Japanese garden with cherry blossoms and a koi pond',
                    'A mystical forest with glowing mushrooms and fireflies',
                    'A steampunk airship flying through cloudy skies',
                    'A cute robot watering plants in a sunny greenhouse',
                    'A vintage car parked on a scenic coastal road at sunset',
                    'A magical library with floating books and spiral staircases'
                ];
                var randomIndex = Math.floor(Math.random() * randomPrompts.length);
                state.promptModalText = randomPrompts[randomIndex];
                var modalTextarea = document.getElementById('prompt-modal-textarea');
                if (modalTextarea) modalTextarea.value = state.promptModalText;
                app.updatePromptModalText(state.promptModalText);
            },

            // Clear prompt in modal
            clearPromptInModal: function() {
                state.promptModalText = '';
                var modalTextarea = document.getElementById('prompt-modal-textarea');
                if (modalTextarea) modalTextarea.value = '';
                app.updatePromptModalText('');
            },

            // ========================================
            // FLOATING GENERATE BUTTON HANDLERS
            // ========================================

            // Toggle floating settings popover
            toggleFloatingSettings: function() {
                state.floatingSettingsOpen = !state.floatingSettingsOpen;
                render();
            },

            // Update floating button visibility based on scroll
            updateFloatingButtonVisibility: function() {
                // Only show on screens <= 1024px
                if (window.innerWidth > 1024) {
                    state.showFloatingButton = false;
                    return;
                }

                // Must have tool interface open
                if (!state.toolInterfaceOpen) {
                    state.showFloatingButton = false;
                    return;
                }

                // Always show floating button when on Templates or Community tabs
                // because the main generate button is not visible in these views
                if (state.mainTab === 'templates' || state.mainTab === 'community') {
                    state.showFloatingButton = true;
                } else {
                    // For Generator tab, check if sidebar is scrolled out of view
                    var sidebar = document.querySelector('.tool-sidebar');
                    if (!sidebar) {
                        state.showFloatingButton = false;
                    } else {
                        var sidebarRect = sidebar.getBoundingClientRect();
                        // Show floating button when sidebar is mostly out of view
                        state.showFloatingButton = sidebarRect.bottom < 200;
                    }
                }

                // Update the container visibility directly without full re-render
                var container = document.getElementById('floating-generate-container');
                if (container) {
                    if (state.showFloatingButton) {
                        container.classList.add('visible');
                    } else {
                        container.classList.remove('visible');
                        // Also close settings when hiding
                        state.floatingSettingsOpen = false;
                    }
                }
            },

            // ========================================
            // IMAGE DETAIL MODAL HANDLERS
            // ========================================

            // Open image detail modal (for history items)
            openImageDetail: function(index) {
                if (state.history[index]) {
                    state.selectedImageDetail = state.history[index];
                    state.imageDetailSource = 'history'; // Track source
                    state.imageDetailModalOpen = true;
                    utils.lockBodyScroll();
                    render();
                    // Setup focus trap after render
                    setTimeout(function() {
                        state._imageDetailFocusTrapCleanup = utils.setupFocusTrap('.image-detail-modal');
                    }, 100);
                }
            },

            // Open image detail modal (for community items)
            openCommunityImageDetail: function(index) {
                if (state.communityItems[index]) {
                    var communityItem = state.communityItems[index];
                    // Convert community item format to match history item format for modal display
                    state.selectedImageDetail = {
                        id: communityItem.id,
                        imageUrl: communityItem.imageUrl,
                        prompt: communityItem.isPrivate ? '[Private Prompt - ' + (communityItem.promptPrice || 5) + ' tokens to unlock]' : communityItem.prompt,
                        model: communityItem.model || 'Unknown',
                        quality: communityItem.quality || 'HD',
                        aspectRatio: communityItem.aspectRatio || '1:1',
                        createdAt: communityItem.createdAt,
                        // Community-specific fields
                        userName: communityItem.userName,
                        userAvatar: communityItem.userAvatar,
                        likes: communityItem.likes || 0,
                        isPrivate: communityItem.isPrivate,
                        promptPrice: communityItem.promptPrice,
                        userId: communityItem.userId
                    };
                    state.imageDetailSource = 'community'; // Track source
                    state.imageDetailModalOpen = true;
                    utils.lockBodyScroll();
                    render();
                    // Setup focus trap after render
                    setTimeout(function() {
                        state._imageDetailFocusTrapCleanup = utils.setupFocusTrap('.image-detail-modal');
                    }, 100);
                }
            },

            // Close image detail modal
            closeImageDetail: function(event) {
                if (event && event.target && !event.target.classList.contains('image-detail-modal-overlay')) {
                    return;
                }
                // Cleanup focus trap
                if (state._imageDetailFocusTrapCleanup) {
                    state._imageDetailFocusTrapCleanup();
                    state._imageDetailFocusTrapCleanup = null;
                }
                utils.unlockBodyScroll();
                state.imageDetailModalOpen = false;
                state.selectedImageDetail = null;
                render();
            },

            // Use prompt from detail modal
            usePromptFromDetail: function() {
                if (state.selectedImageDetail && state.selectedImageDetail.prompt) {
                    // Cleanup focus trap
                    if (state._imageDetailFocusTrapCleanup) {
                        state._imageDetailFocusTrapCleanup();
                        state._imageDetailFocusTrapCleanup = null;
                    }
                    utils.unlockBodyScroll();
                    state.prompt = state.selectedImageDetail.prompt;
                    var textarea = document.getElementById('prompt-textarea');
                    if (textarea) textarea.value = state.prompt;
                    state.imageDetailModalOpen = false;
                    state.selectedImageDetail = null;
                    render();
                    showToast('Prompt loaded! Click Generate to create.', 'success');
                }
            },

            // Delete from history and close modal
            deleteFromHistoryAndClose: function(imageId) {
                if (!imageId) return;

                // Show confirmation
                if (!confirm('Are you sure you want to delete this image? This cannot be undone.')) {
                    return;
                }

                // Cleanup focus trap
                if (state._imageDetailFocusTrapCleanup) {
                    state._imageDetailFocusTrapCleanup();
                    state._imageDetailFocusTrapCleanup = null;
                }
                utils.unlockBodyScroll();

                // Close modal immediately for better UX
                state.imageDetailModalOpen = false;
                state.selectedImageDetail = null;

                // Optimistically remove from UI
                state.history = state.history.filter(function(item) { return item.id !== imageId; });
                render();

                // Call backend to actually delete
                var deleteCreativeHistory = functions.httpsCallable('deleteCreativeHistory');
                deleteCreativeHistory({ historyId: imageId })
                    .then(function(result) {
                        if (result.data.success) {
                            showToast('Image deleted successfully', 'success');
                            // Also refresh community gallery if open
                            if (state.mainTab === 'community') {
                                app.loadCommunityGallery(true);
                            }
                        }
                    })
                    .catch(function(error) {
                        console.error('Delete error:', error);
                        showToast('Failed to delete: ' + (error.message || 'Unknown error'), 'error');
                        // Reload history to restore if delete failed
                        app.loadHistory();
                    });
            },

            // ========================================
            // MODEL DROPDOWN HANDLERS
            // ========================================

            // Toggle model dropdown
            toggleModelDropdown: function() {
                state.modelDropdownOpen = !state.modelDropdownOpen;
                render();
            },

            // Close model dropdown
            closeModelDropdown: function() {
                state.modelDropdownOpen = false;
            },

            // Select model from dropdown
            selectModel: function(modelKey) {
                var model = modelsConfig.find(function(m) { return m.key === modelKey; });
                if (model && model.available) {
                    state.selectedModel = modelKey;
                    state.modelDropdownOpen = false;
                    render();
                } else if (model && !model.available) {
                    showToast(model.name + ' coming soon!', 'info');
                }
            },

            // ========================================
            // TOOL INFO ACCORDION HANDLERS
            // ========================================

            // Toggle tool info accordion
            toggleToolInfo: function() {
                state.toolInfoOpen = !state.toolInfoOpen;
                render();
            },

            // ========================================
            // REFERENCE HANDLERS
            // ========================================

            // Open style reference modal
            openStyleReference: function() {
                state.styleReferenceModalOpen = true;
                render();
            },

            // Close style reference modal
            closeStyleReference: function() {
                state.styleReferenceModalOpen = false;
                render();
            },

            // Handle style reference file selection
            handleStyleRefFile: function(file) {
                if (!file) return;

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    showToast('Please select an image file', 'error');
                    return;
                }

                // Validate file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showToast('Image must be less than 10MB', 'error');
                    return;
                }

                // Create preview URL
                var reader = new FileReader();
                reader.onload = function(e) {
                    state.styleReference = {
                        type: 'file',
                        dataUrl: e.target.result,
                        name: file.name,
                        file: file
                    };
                    render();
                };
                reader.readAsDataURL(file);
            },

            // Handle style reference URL input
            handleStyleRefUrl: function(url) {
                if (!url || !url.trim()) return;

                // Basic URL validation
                if (!url.match(/^https?:\/\/.+\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i)) {
                    showToast('Please enter a valid image URL', 'error');
                    return;
                }

                state.styleReference = {
                    type: 'url',
                    url: url.trim(),
                    name: 'Image from URL'
                };
                render();
            },

            // Remove style reference
            removeStyleReference: function() {
                state.styleReference = null;
                render();
            },

            // Apply style reference and close modal
            applyStyleReference: function() {
                if (state.styleReference) {
                    showToast('Style reference applied!', 'success');
                }
                state.styleReferenceModalOpen = false;
                render();
            },

            // Trigger file input click
            triggerStyleRefUpload: function() {
                var input = document.getElementById('style-ref-file-input');
                if (input) input.click();
            },

            // Show premium modal for locked features
            showPremiumModal: function(featureName) {
                state.premiumModalOpen = true;
                state.premiumModalFeature = featureName;
                render();
            },

            // Close premium modal
            closePremiumModal: function() {
                state.premiumModalOpen = false;
                state.premiumModalFeature = null;
                render();
            },

            // Upgrade action (redirect to pricing)
            upgradeToPremium: function() {
                window.location.href = 'https://ytseo.siteuo.com/pricing';
            },

            // ========================================
            // CHARACTER REFERENCE (PRO FEATURE)
            // ========================================

            // Open character reference modal
            openCharacterReference: function() {
                if (!state.hasPremiumAccess) {
                    app.showPremiumModal('Character Reference');
                    return;
                }
                state.characterReferenceModalOpen = true;
                render();
            },

            // Close character reference modal
            closeCharacterReference: function() {
                state.characterReferenceModalOpen = false;
                render();
            },

            // Handle character reference file selection
            handleCharacterRefFile: function(file) {
                if (!file) return;

                if (!file.type.startsWith('image/')) {
                    showToast('Please select an image file', 'error');
                    return;
                }

                if (file.size > 10 * 1024 * 1024) {
                    showToast('Image must be less than 10MB', 'error');
                    return;
                }

                var reader = new FileReader();
                reader.onload = function(e) {
                    state.characterReference = {
                        type: 'file',
                        dataUrl: e.target.result,
                        name: file.name,
                        file: file
                    };
                    render();
                };
                reader.readAsDataURL(file);
            },

            // Remove character reference
            removeCharacterReference: function() {
                state.characterReference = null;
                render();
            },

            // Apply character reference and close modal
            applyCharacterReference: function() {
                if (state.characterReference) {
                    showToast('Character reference applied!', 'success');
                }
                state.characterReferenceModalOpen = false;
                render();
            },

            // Trigger character ref file input
            triggerCharacterRefUpload: function() {
                var input = document.getElementById('character-ref-file-input');
                if (input) input.click();
            },

            // ========================================
            // IMAGE UPLOAD (PRO FEATURE)
            // ========================================

            // Open image upload modal
            openImageUpload: function() {
                if (!state.hasPremiumAccess) {
                    app.showPremiumModal('Image Upload');
                    return;
                }
                state.imageUploadModalOpen = true;
                render();
            },

            // Close image upload modal
            closeImageUpload: function() {
                state.imageUploadModalOpen = false;
                render();
            },

            // Handle uploaded image file selection
            handleUploadedImageFile: function(file) {
                if (!file) return;

                if (!file.type.startsWith('image/')) {
                    showToast('Please select an image file', 'error');
                    return;
                }

                if (file.size > 10 * 1024 * 1024) {
                    showToast('Image must be less than 10MB', 'error');
                    return;
                }

                var reader = new FileReader();
                reader.onload = function(e) {
                    state.uploadedImage = {
                        type: 'file',
                        dataUrl: e.target.result,
                        name: file.name,
                        file: file
                    };
                    render();
                };
                reader.readAsDataURL(file);
            },

            // Remove uploaded image
            removeUploadedImage: function() {
                state.uploadedImage = null;
                render();
            },

            // Apply uploaded image and close modal
            applyUploadedImage: function() {
                if (state.uploadedImage) {
                    showToast('Image uploaded successfully!', 'success');
                }
                state.imageUploadModalOpen = false;
                render();
            },

            // Trigger upload file input
            triggerImageUpload: function() {
                var input = document.getElementById('upload-image-file-input');
                if (input) input.click();
            },

            // ========================================
            // GENERATION PROGRESS UPDATES (No Flash)
            // ========================================

            // Update only the generation progress elements without full re-render
            updateGenerationProgress: function() {
                var stageLabels = {
                    'queued': 'Queued',
                    'processing': 'Processing',
                    'generating': 'Generating',
                    'finalizing': 'Finalizing'
                };
                var stageLabel = stageLabels[state.generationStage] || 'Preparing';

                // Update stage label
                var labelEl = document.getElementById('gen-stage-label');
                if (labelEl) labelEl.textContent = stageLabel + '...';

                // Update percentage
                var percentEl = document.getElementById('gen-stage-percent');
                if (percentEl) percentEl.textContent = state.generationProgress + '%';

                // Update progress bar fill
                var fillEl = document.getElementById('gen-progress-fill');
                if (fillEl) fillEl.style.width = state.generationProgress + '%';

                // Update stage step indicators
                var stages = ['queued', 'processing', 'generating', 'finalizing'];
                var currentStageIndex = stages.indexOf(state.generationStage);

                for (var si = 0; si < stages.length; si++) {
                    var stepEl = document.getElementById('gen-step-' + si);
                    if (stepEl) {
                        stepEl.classList.remove('completed', 'active');
                        if (si < currentStageIndex) stepEl.classList.add('completed');
                        if (si === currentStageIndex) stepEl.classList.add('active');
                    }
                }
            },

            // Update the generate section (button/progress swap) without full page re-render
            updateGenerateSection: function() {
                var section = document.querySelector('.generate-section');
                if (!section) {
                    // Fallback to full render if section not found
                    render();
                    return;
                }

                var cost = app.calculateCost();
                var canGenerate = state.prompt.trim().length > 0 && state.tokens.balance >= cost && !state.generating;
                var html = '';

                if (state.generating) {
                    // Generation in progress - show progress UI
                    html += '<div class="generation-progress-container">';

                    var stageLabels = {
                        'queued': 'Queued',
                        'processing': 'Processing',
                        'generating': 'Generating',
                        'finalizing': 'Finalizing'
                    };
                    var stageLabel = stageLabels[state.generationStage] || 'Preparing';

                    html += '<div class="generation-stage">';
                    html += '<span class="generation-stage-icon animate-pulse">âœ¨</span>';
                    html += '<span id="gen-stage-label" class="generation-stage-label">' + stageLabel + '...</span>';
                    html += '<span id="gen-stage-percent" class="generation-stage-percent">' + state.generationProgress + '%</span>';
                    html += '</div>';

                    html += '<div class="generation-progress-bar">';
                    html += '<div id="gen-progress-fill" class="generation-progress-fill" style="width: ' + state.generationProgress + '%;"></div>';
                    html += '</div>';

                    html += '<div class="generation-stages">';
                    var stages = ['queued', 'processing', 'generating', 'finalizing'];
                    var stageIcons = { queued: 'ðŸ“‹', processing: 'âš™ï¸', generating: 'ðŸŽ¨', finalizing: 'âœ…' };
                    var currentStageIndex = stages.indexOf(state.generationStage);

                    for (var si = 0; si < stages.length; si++) {
                        var stageClass = 'generation-stage-step';
                        if (si < currentStageIndex) stageClass += ' completed';
                        if (si === currentStageIndex) stageClass += ' active';
                        html += '<div id="gen-step-' + si + '" class="' + stageClass + '">' + stageIcons[stages[si]] + '</div>';
                    }
                    html += '</div>';

                    html += '</div>';
                } else {
                    // Normal generate button
                    html += '<button class="generate-btn-enhanced" onclick="app.generateImage()"' + (canGenerate ? '' : ' disabled') + '>';
                    html += '<span class="generate-btn-sparkle">âœ¨</span>';
                    html += '<span>Generate</span>';
                    html += '</button>';
                }

                // Keep cost breakdown - just update the section before it
                var costBreakdown = section.querySelector('.cost-breakdown');
                if (costBreakdown) {
                    // Insert new content before cost breakdown
                    var tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;

                    // Remove old progress container or button
                    var oldProgress = section.querySelector('.generation-progress-container');
                    var oldButton = section.querySelector('.generate-btn-enhanced');
                    if (oldProgress) oldProgress.remove();
                    if (oldButton) oldButton.remove();

                    // Insert new content at the beginning
                    section.insertBefore(tempDiv.firstChild, costBreakdown);
                } else {
                    // Fallback - update entire section
                    section.innerHTML = html;
                }
            },

            // Get unfilled template variables from prompt
            getUnfilledVariables: function(prompt) {
                if (!prompt) return [];
                var regex = /\{\{([^}]+)\}\}/g;
                var matches = [];
                var match;
                while ((match = regex.exec(prompt)) !== null) {
                    matches.push(match[1].trim());
                }
                return matches;
            },

            // Show variable input popup
            showVariableInput: function(varName) {
                state.variableInputOpen = true;
                state.variableInputName = varName;
                state.variableInputValue = '';
                render();
                // Focus the input after render
                setTimeout(function() {
                    var input = document.getElementById('variable-input-field');
                    if (input) input.focus();
                }, 100);
            },

            // Apply variable value to prompt
            applyVariableInput: function() {
                if (state.variableInputName && state.variableInputValue) {
                    var searchPattern = '{{' + state.variableInputName + '}}';
                    state.prompt = state.prompt.replace(searchPattern, state.variableInputValue);
                    // Update textarea
                    var textarea = document.getElementById('prompt-textarea');
                    if (textarea) textarea.value = state.prompt;
                }
                // Close popup
                state.variableInputOpen = false;
                state.variableInputName = null;
                state.variableInputValue = '';
                render();
            },

            // Cancel variable input
            cancelVariableInput: function() {
                state.variableInputOpen = false;
                state.variableInputName = null;
                state.variableInputValue = '';
                render();
            },

            // Update variable input value (without re-render)
            updateVariableInputValue: function(value) {
                state.variableInputValue = value;
            },

            // Generate Image using Gemini/Imagen API
            generateImage: function() {
                if (!state.prompt.trim()) {
                    showToast('Please enter a prompt', 'error');
                    return;
                }

                // Check for unfilled template variables
                var unfilledVars = app.getUnfilledVariables(state.prompt);
                if (unfilledVars.length > 0) {
                    var varNames = unfilledVars.map(function(v) { return '"' + v + '"'; }).join(', ');
                    showToast('Please fill in template variables: ' + varNames, 'warning');
                    // Highlight the prompt textarea
                    var textarea = document.getElementById('prompt-textarea');
                    if (textarea) {
                        textarea.classList.add('has-unfilled-vars');
                        setTimeout(function() {
                            textarea.classList.remove('has-unfilled-vars');
                        }, 3000);
                    }
                    return;
                }

                var cost = app.calculateCost();
                if (state.tokens.balance < cost) {
                    showToast('Not enough tokens. Please upgrade your plan.', 'error');
                    return;
                }

                state.generating = true;
                state.generationStage = 'queued';
                state.generationProgress = 5;
                // Use targeted update instead of full render to prevent page flash
                app.updateGenerateSection();

                // Progress simulation for better UX
                var progressInterval = setInterval(function() {
                    if (!state.generating) {
                        clearInterval(progressInterval);
                        return;
                    }

                    // Simulate progress through stages
                    if (state.generationStage === 'queued' && state.generationProgress >= 15) {
                        state.generationStage = 'processing';
                    } else if (state.generationStage === 'processing' && state.generationProgress >= 40) {
                        state.generationStage = 'generating';
                    } else if (state.generationStage === 'generating' && state.generationProgress >= 80) {
                        state.generationStage = 'finalizing';
                    }

                    // Slow down progress as it gets higher (asymptotic approach)
                    if (state.generationProgress < 90) {
                        var increment = state.generationProgress < 30 ? 3 :
                                        state.generationProgress < 60 ? 2 : 1;
                        state.generationProgress = Math.min(90, state.generationProgress + increment);
                        // Use targeted update instead of full render to prevent page flash
                        app.updateGenerationProgress();
                    }
                }, 500);

                // Call the Cloud Function
                var generateCreativeImage = functions.httpsCallable('generateCreativeImage');

                // Get model capabilities
                var modelCaps = getModelCapabilities(state.selectedModel);

                // Build request payload
                var requestPayload = {
                    prompt: state.prompt,
                    model: state.selectedModel,
                    quantity: state.quantity,
                    aspectRatio: state.aspectRatio,
                    quality: state.quality,
                    templateId: state.selectedTemplate ? state.selectedTemplate.id : null
                };

                // Add negative prompt if supported and provided
                if (modelCaps.supportsNegativePrompt && state.negativePrompt && state.negativePrompt.trim()) {
                    requestPayload.negativePrompt = state.negativePrompt.trim();
                }

                // Add seed if supported and provided
                if (modelCaps.supportsSeed && state.seed) {
                    requestPayload.seed = parseInt(state.seed, 10);
                }

                // Add style reference if supported and provided (base64 data)
                if (modelCaps.supportsReferenceImages && state.styleReference) {
                    if (state.styleReference.type === 'file' && state.styleReference.dataUrl) {
                        // Extract base64 data from data URL
                        var base64Data = state.styleReference.dataUrl.split(',')[1];
                        requestPayload.styleReference = {
                            base64: base64Data,
                            mimeType: state.styleReference.dataUrl.split(';')[0].split(':')[1] || 'image/png'
                        };
                    } else if (state.styleReference.type === 'url' && state.styleReference.url) {
                        requestPayload.styleReference = {
                            url: state.styleReference.url
                        };
                    }
                }

                // Add character reference if supported and provided
                if (modelCaps.supportsReferenceImages && state.characterReference) {
                    if (state.characterReference.type === 'file' && state.characterReference.dataUrl) {
                        var charBase64Data = state.characterReference.dataUrl.split(',')[1];
                        requestPayload.characterReference = {
                            base64: charBase64Data,
                            mimeType: state.characterReference.dataUrl.split(';')[0].split(':')[1] || 'image/png'
                        };
                    } else if (state.characterReference.type === 'url' && state.characterReference.url) {
                        requestPayload.characterReference = {
                            url: state.characterReference.url
                        };
                    }
                }

                generateCreativeImage(requestPayload)
                .then(function(result) {
                    clearInterval(progressInterval);
                    state.generationStage = 'complete';
                    state.generationProgress = 100;
                    state.generating = false;

                    if (result.data.success) {
                        // Update token balance
                        state.tokens.balance = result.data.remainingBalance;

                        // Add to history with auto-share info
                        var newHistoryItem = {
                            id: result.data.historyId,
                            prompt: state.prompt,
                            images: result.data.images,
                            imageUrl: result.data.images[0]?.url,
                            createdAt: new Date().toISOString(),
                            // Auto-share status for free users
                            sharedToGallery: result.data.autoSharedToGallery || false,
                            galleryId: result.data.galleryId || null,
                            autoShared: result.data.autoSharedToGallery || false
                        };
                        state.history.unshift(newHistoryItem);

                        // Show appropriate message based on auto-share status
                        if (result.data.autoSharedToGallery) {
                            showToast('Image generated and shared to community! (' + result.data.tokenCost + ' tokens)', 'success');
                        } else {
                            showToast('Image generated successfully! (' + result.data.tokenCost + ' tokens used)', 'success');
                        }

                        // Clear prompt after successful generation
                        state.prompt = '';
                        state.selectedTemplate = null;
                    } else {
                        showToast('Generation failed. Please try again.', 'error');
                    }
                    render();
                })
                .catch(function(error) {
                    clearInterval(progressInterval);
                    state.generating = false;
                    state.generationProgress = 0;
                    state.generationStage = 'error';
                    console.error('Generation error:', error);

                    // Parse error and show user-friendly message with appropriate actions
                    var errorCode = error.code || '';
                    var errorMessage = error.message || '';
                    var userMsg = 'Generation failed. Please try again.';
                    var canRetry = true;
                    var suggestion = '';

                    if (errorCode === 'resource-exhausted') {
                        userMsg = 'Service is busy right now.';
                        suggestion = 'Try again in a few moments.';
                    } else if (errorCode === 'invalid-argument') {
                        userMsg = 'Your prompt contains invalid content.';
                        suggestion = 'Try simplifying or rephrasing your prompt.';
                        canRetry = false;
                    } else if (errorCode === 'permission-denied') {
                        userMsg = 'Access denied.';
                        suggestion = 'Please check your account status.';
                        canRetry = false;
                    } else if (errorCode === 'unauthenticated') {
                        userMsg = 'Session expired.';
                        suggestion = 'Please refresh the page and sign in again.';
                        canRetry = false;
                    } else if (errorMessage.includes('timeout') || errorMessage.includes('DEADLINE')) {
                        userMsg = 'Request timed out.';
                        suggestion = 'The server is slow. Try again.';
                    } else if (errorMessage.includes('network') || errorMessage.includes('fetch')) {
                        userMsg = 'Network connection issue.';
                        suggestion = 'Check your internet connection.';
                    } else if (errorMessage.includes('quota') || errorMessage.includes('limit')) {
                        userMsg = 'Usage limit reached.';
                        suggestion = 'Please upgrade your plan or wait.';
                        canRetry = false;
                    } else if (errorMessage.includes('content') || errorMessage.includes('policy')) {
                        userMsg = 'Content policy violation.';
                        suggestion = 'Your prompt may contain restricted content.';
                        canRetry = false;
                    }

                    var fullMsg = userMsg + (suggestion ? ' ' + suggestion : '');

                    if (canRetry) {
                        showToast(fullMsg, 'error', {
                            retry: function() { app.generateImage(); },
                            retryText: 'Retry'
                        });
                    } else {
                        showToast(fullMsg, 'error');
                    }

                    render();
                });
            },

            // Calculate Token Cost
            calculateCost: function() {
                var baseCost = tokenConfig.costs[state.quality] || 2;
                var quantityMultiplier = state.quantity;
                var templateBonus = state.selectedTemplate ? (state.selectedTemplate.cost - 2) : 0;
                return (baseCost + templateBonus) * quantityMultiplier;
            },

            // Community Gallery Actions
            likeImage: function(imageId) {
                showToast('Like feature coming soon!', 'info');
            },

            // Purchase Private Prompt
            purchasePrompt: function(imageId, price) {
                if (state.tokens.balance < price) {
                    showToast('Not enough tokens to purchase this prompt.', 'error');
                    return;
                }
                // TODO: Implement actual purchase via Cloud Function
                showToast('Prompt purchased for ' + price + ' tokens!', 'success');
                state.tokens.balance -= price;
                render();
            },

            // Copy Prompt (for free prompts)
            copyPrompt: function(prompt) {
                navigator.clipboard.writeText(prompt).then(function() {
                    showToast('Prompt copied to clipboard!', 'success');
                }).catch(function() {
                    showToast('Failed to copy prompt', 'error');
                });
            },

            // Use Prompt from Community
            usePrompt: function(prompt) {
                state.prompt = prompt;
                var textarea = document.getElementById('prompt-textarea');
                if (textarea) textarea.value = prompt;
                showToast('Prompt loaded! Click Generate to create.', 'success');
            },

            // Share to Gallery
            shareToGallery: function(imageId, makePrivate) {
                // TODO: Implement sharing via Cloud Function
                var msg = makePrivate ? 'Shared as private (prompt protected)' : 'Shared to community gallery!';
                showToast(msg, 'success');
            },

            // ========================================
            // DIAGNOSTIC: Test API Configuration
            // Call from console: app.runDiagnostic()
            // ========================================
            runDiagnostic: function() {
                console.log('Running Imagen API diagnostic...');
                showToast('Running API diagnostic...', 'info');

                var testImagenApi = functions.httpsCallable('testImagenApi');
                testImagenApi({})
                    .then(function(result) {
                        console.log('=== IMAGEN API DIAGNOSTIC RESULTS ===');
                        console.log(JSON.stringify(result.data, null, 2));

                        if (result.data.imageGenerated) {
                            showToast('API Test PASSED! Imagen is working.', 'success');
                        } else {
                            showToast('API Test FAILED. Check browser console for details.', 'error');
                            console.error('Errors:', result.data.errors);
                        }

                        // Show summary in console
                        console.log('Summary:', result.data.summary);
                        if (result.data.errors && result.data.errors.length > 0) {
                            console.error('=== ERRORS ===');
                            result.data.errors.forEach(function(err) {
                                console.error('- ' + err);
                            });
                        }

                        return result.data;
                    })
                    .catch(function(error) {
                        console.error('Diagnostic failed:', error);
                        showToast('Diagnostic failed: ' + error.message, 'error');
                    });
            },

            // History Actions
            downloadImage: function(imageUrl) {
                window.open(imageUrl, '_blank');
            },

            deleteFromHistory: function(imageId) {
                if (!imageId) return;

                // Show confirmation
                if (!confirm('Are you sure you want to delete this image? This cannot be undone.')) {
                    return;
                }

                // Optimistically remove from UI
                state.history = state.history.filter(function(item) { return item.id !== imageId; });
                render();

                // Call backend to actually delete
                var deleteCreativeHistory = functions.httpsCallable('deleteCreativeHistory');
                deleteCreativeHistory({ historyId: imageId })
                    .then(function(result) {
                        if (result.data.success) {
                            showToast('Image deleted successfully', 'success');
                            // Refresh community gallery if shared images were affected
                            if (state.mainTab === 'community') {
                                app.loadCommunityGallery(true);
                            }
                        }
                    })
                    .catch(function(error) {
                        console.error('Delete error:', error);
                        showToast('Failed to delete: ' + (error.message || 'Unknown error'), 'error');
                        // Reload history to restore if delete failed
                        app.loadHistory();
                    });
            },

            // Load more history items
            loadMoreHistory: function() {
                state.historyDisplayCount += 12;
                render();
            },

            // Reset history pagination (e.g., when new item is added)
            resetHistoryPagination: function() {
                state.historyDisplayCount = 12;
            },

            // Load User Tokens (via Cloud Function for rollover handling)
            loadTokens: function() {
                if (!state.user) return;

                var getCreativeTokens = functions.httpsCallable('getCreativeTokens');
                getCreativeTokens({})
                    .then(function(result) {
                        if (result.data) {
                            state.tokens = {
                                balance: result.data.balance || 50,
                                rollover: result.data.rollover || 0,
                                plan: result.data.plan || 'free',
                                lastRefresh: result.data.lastRefresh
                            };
                            render();
                        }
                    })
                    .catch(function(e) {
                        console.error('Error loading tokens:', e);
                        // Fallback to direct Firestore read
                        db.collection('creativeTokens').doc(state.user.uid).get()
                            .then(function(doc) {
                                if (doc.exists) {
                                    var data = doc.data();
                                    state.tokens = {
                                        balance: data.balance || 50,
                                        rollover: data.rollover || 0,
                                        plan: data.plan || 'free',
                                        lastRefresh: data.lastRefresh
                                    };
                                    render();
                                }
                            });
                    });
            },

            // Load User History
            loadHistory: function() {
                if (!state.user) return;
                state.historyLoading = true;

                db.collection('creativeHistory')
                    .where('userId', '==', state.user.uid)
                    .orderBy('createdAt', 'desc')
                    .limit(50)
                    .get()
                    .then(function(snapshot) {
                        state.history = [];
                        snapshot.forEach(function(doc) {
                            state.history.push({ id: doc.id, ...doc.data() });
                        });
                        state.historyLoading = false;

                        // Preload history images for faster display
                        var imageUrls = state.history.map(function(item) {
                            return item.imageUrl || (item.images && item.images[0] ? item.images[0].url : null);
                        }).filter(Boolean);
                        imageCache.preloadBatch(imageUrls);

                        render();
                        // Setup lazy loading after render
                        setTimeout(setupLazyImages, 50);
                    })
                    .catch(function(e) {
                        console.error('Error loading history:', e);
                        state.historyLoading = false;
                    });
            },

            // ==========================================
            // COMMUNITY GALLERY FUNCTIONS
            // ==========================================

            // Load Community Gallery from backend
            loadCommunityGallery: function(forceRefresh) {
                // Skip if already loaded and not forcing refresh
                if (state.communityLoaded && !forceRefresh && state.communityItems.length > 0) {
                    return;
                }

                state.communityLoading = true;
                state.communityError = null;
                render();

                var getCommunityGallery = functions.httpsCallable('getCommunityGallery');
                getCommunityGallery({
                    sortBy: state.communitySort,
                    limit: 50
                })
                .then(function(result) {
                    if (result.data && result.data.success) {
                        state.communityItems = result.data.items || [];
                        state.communityLoaded = true;
                        state.communityError = null;

                        // Preload images for faster display
                        var imageUrls = state.communityItems.map(function(item) {
                            return item.imageUrl;
                        }).filter(Boolean);
                        imageCache.preloadBatch(imageUrls);
                    } else {
                        state.communityError = 'Failed to load community gallery';
                    }
                    state.communityLoading = false;
                    render();
                    // Setup lazy loading after render
                    setTimeout(setupLazyImages, 50);
                })
                .catch(function(error) {
                    console.error('Error loading community gallery:', error);
                    state.communityError = error.message || 'Failed to load community gallery';
                    state.communityLoading = false;
                    render();
                });
            },

            // Open share dialog for an image
            openShareDialog: function(historyId) {
                if (!state.user) {
                    showToast('Please sign in to share images', 'error');
                    return;
                }

                // Find the history item
                var item = null;
                for (var i = 0; i < state.history.length; i++) {
                    if (state.history[i].id === historyId) {
                        item = state.history[i];
                        break;
                    }
                }

                if (!item) {
                    showToast('Image not found', 'error');
                    return;
                }

                // Check if already shared
                if (item.sharedToGallery) {
                    showToast('This image is already shared to the community', 'info');
                    return;
                }

                // Open dialog with default settings (public)
                state.shareDialogOpen = true;
                state.shareDialogItem = item;
                state.shareDialogPrivate = false; // default is public
                state.shareDialogPrice = 5;
                state.shareDialogSharing = false;
                render();
            },

            // Close share dialog
            closeShareDialog: function() {
                state.shareDialogOpen = false;
                state.shareDialogItem = null;
                state.shareDialogSharing = false;
                render();
            },

            // Set share visibility option
            setSharePrivate: function(isPrivate) {
                // Check if user has premium access
                var userPlan = state.tokens.plan || 'free';
                var isPremium = ['lite', 'pro', 'business', 'enterprise'].includes(userPlan);

                if (isPrivate && !isPremium) {
                    // Show upgrade prompt instead
                    app.showPremiumModal('Private Prompts');
                    return;
                }

                state.shareDialogPrivate = isPrivate;
                render();
            },

            // Update share price
            setSharePrice: function(price) {
                var numPrice = parseInt(price) || 5;
                if (numPrice < 1) numPrice = 1;
                if (numPrice > 100) numPrice = 100;
                state.shareDialogPrice = numPrice;
            },

            // Confirm and execute share
            confirmShare: function() {
                if (!state.shareDialogItem || state.shareDialogSharing) return;

                state.shareDialogSharing = true;
                render();

                var shareToGalleryFn = functions.httpsCallable('shareToGallery');
                shareToGalleryFn({
                    historyId: state.shareDialogItem.id,
                    makePrivate: state.shareDialogPrivate,
                    promptPrice: state.shareDialogPrivate ? state.shareDialogPrice : 0
                })
                .then(function(result) {
                    if (result.data && result.data.success) {
                        var msg = state.shareDialogPrivate
                            ? 'Image shared with private prompt!'
                            : 'Image shared to community!';
                        showToast(msg, 'success');
                        // Refresh community gallery
                        app.loadCommunityGallery(true);
                        // Update history item to show it's shared
                        for (var i = 0; i < state.history.length; i++) {
                            if (state.history[i].id === state.shareDialogItem.id) {
                                state.history[i].sharedToGallery = true;
                                state.history[i].galleryId = result.data.galleryId;
                                state.history[i].isPrivate = state.shareDialogPrivate;
                                break;
                            }
                        }
                        // Close dialog
                        app.closeShareDialog();
                    }
                })
                .catch(function(error) {
                    console.error('Error sharing to gallery:', error);
                    showToast(error.message || 'Failed to share image', 'error');
                    state.shareDialogSharing = false;
                    render();
                });
            },

            // Legacy function for backwards compatibility
            shareToGallery: function(historyId, makePrivate, promptPrice) {
                // Now opens dialog instead of directly sharing
                app.openShareDialog(historyId);
            },

            // Purchase a private prompt
            purchasePrompt: function(galleryId, price) {
                if (!state.user) {
                    showToast('Please sign in to purchase prompts', 'error');
                    return;
                }

                if (state.tokens.balance < price) {
                    showToast('Insufficient tokens. You need ' + price + ' tokens.', 'error');
                    return;
                }

                // Confirm purchase
                if (!confirm('Purchase this prompt for ' + price + ' tokens?')) {
                    return;
                }

                var purchasePromptFn = functions.httpsCallable('purchasePrompt');
                purchasePromptFn({ galleryId: galleryId })
                .then(function(result) {
                    if (result.data && result.data.success) {
                        showToast('Prompt purchased! Check below.', 'success');
                        // Show the prompt in a modal or alert
                        if (result.data.prompt) {
                            app.showPurchasedPrompt(result.data.prompt);
                        }
                        // Refresh tokens
                        app.loadUserTokens();
                    }
                })
                .catch(function(error) {
                    console.error('Error purchasing prompt:', error);
                    showToast(error.message || 'Failed to purchase prompt', 'error');
                });
            },

            // Show purchased prompt in a modal
            showPurchasedPrompt: function(prompt) {
                state.promptModalOpen = true;
                state.promptModalText = prompt;
                render();
            },

            // Like/unlike a gallery item
            likeGalleryItem: function(galleryId) {
                if (!state.user) {
                    showToast('Please sign in to like images', 'error');
                    return;
                }

                var likeGalleryItem = functions.httpsCallable('likeGalleryItem');
                likeGalleryItem({ galleryId: galleryId })
                .then(function(result) {
                    if (result.data && result.data.success) {
                        // Update local state
                        if (result.data.liked) {
                            state.userLikes[galleryId] = true;
                        } else {
                            delete state.userLikes[galleryId];
                        }
                        // Update like count in community items
                        for (var i = 0; i < state.communityItems.length; i++) {
                            if (state.communityItems[i].id === galleryId) {
                                state.communityItems[i].likes += result.data.liked ? 1 : -1;
                                break;
                            }
                        }
                        render();
                    }
                })
                .catch(function(error) {
                    console.error('Error liking item:', error);
                });
            },

            // Refresh community gallery
            refreshCommunityGallery: function() {
                app.loadCommunityGallery(true);
            },

            // Change community sort order
            setCommunitySort: function(sortBy) {
                if (state.communitySort !== sortBy) {
                    state.communitySort = sortBy;
                    app.loadCommunityGallery(true);
                }
            }
        };

        // Toast notification helper with optional action button
        function showToast(message, type, options) {
            options = options || {};
            var toast = document.createElement('div');
            toast.className = 'toast toast-' + (type || 'success');

            // Create content wrapper
            var content = document.createElement('div');
            content.className = 'toast-content';
            content.textContent = message;
            toast.appendChild(content);

            // Add retry button if provided
            if (options.retry) {
                var retryBtn = document.createElement('button');
                retryBtn.className = 'toast-retry-btn';
                retryBtn.textContent = options.retryText || 'Retry';
                retryBtn.onclick = function() {
                    toast.remove();
                    if (typeof options.retry === 'function') {
                        options.retry();
                    }
                };
                toast.appendChild(retryBtn);
            }

            // Add dismiss button for longer toasts
            if (options.dismissible || type === 'error') {
                var dismissBtn = document.createElement('button');
                dismissBtn.className = 'toast-dismiss-btn';
                dismissBtn.innerHTML = 'Ã—';
                dismissBtn.onclick = function() {
                    toast.remove();
                };
                toast.appendChild(dismissBtn);
            }

            document.body.appendChild(toast);

            // Error toasts stay longer (5s), others 3s
            var duration = options.duration || (type === 'error' ? 5000 : 3000);
            setTimeout(function() {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, duration);

            return toast;
        }

        /* ==========================================
           4.8 RENDER FUNCTIONS
           ========================================== */

        // Main render dispatcher
        function render() {
            var root = document.getElementById('app-root');

            if (state.currentView === 'loading') {
                root.innerHTML = renderLoading();
            } else {
                root.innerHTML = renderStudio();
            }
        }

        // Loading view
        function renderLoading() {
            return '<div class="min-h-screen flex items-center justify-center">' +
                '<div class="text-center">' +
                '<div class="loading-spinner mx-auto mb-4"></div>' +
                '<p class="text-white/60">Loading Creative Studio...</p>' +
                '</div></div>';
        }

        // Main studio view
        function renderStudio() {
            var html = '';

            // Hero section with aurora background
            html += '<div class="hero-section">';
            html += '<div class="hero-aurora"></div>';

            // Top bar with back button
            html += '<div class="top-bar">';
            html += '<button onclick="app.goToDashboard()" class="back-btn">';
            html += '<span>â†</span> Dashboard';
            html += '</button>';
            html += '<div></div>'; // Spacer for flex
            html += '</div>';

            // Hero content
            html += '<div class="hero-content" style="padding-top: 2rem;">';
            html += '<h1 class="hero-title">Bring your ideas to life</h1>';
            html += '<p class="hero-subtitle">One platform, infinite possibilities <span style="opacity:0.4;font-size:0.75em;">v' + PLATFORM_VERSION + '</span></p>';

            // Tool navigation
            html += renderToolNav();

            html += '</div>'; // hero-content
            html += '</div>'; // hero-section

            // Main content
            html += '<div class="content-wide">';

            // Tool panels (show different content based on active tool)
            html += renderToolPanels();

            // Only show Featured and Gallery sections when interface is NOT open
            // (when user is on the landing/placeholder view)
            if (!state.toolInterfaceOpen) {
                // Featured section
                html += renderFeaturedSection();

                // Community Gallery section
                html += renderGallerySection();
            }

            html += '</div>'; // main content container

            // Prompt Editor Modal
            html += renderPromptModal();

            // Floating Generate Button (for mobile/tablet)
            html += renderFloatingGenerateButton();

            // Image Detail Modal
            html += renderImageDetailModal();

            // Template Confirmation Dialog
            html += renderConfirmDialog();

            // Variable Input Popup
            html += renderVariableInputPopup();

            // Style Reference Modal
            html += renderStyleReferenceModal();

            // Character Reference Modal (PRO Feature)
            html += renderCharacterReferenceModal();

            // Image Upload Modal (PRO Feature)
            html += renderImageUploadModal();

            // Share to Gallery Dialog
            html += renderShareDialog();

            // Template Variables Modal
            html += renderTemplateVariablesModal();

            // Premium Feature Modal
            html += renderPremiumModal();

            // Draft Notification Banner
            html += renderDraftNotification();

            return html;
        }

        // Tool navigation tabs
        function renderToolNav() {
            var html = '<div class="tool-nav">';

            for (var i = 0; i < toolsConfig.length; i++) {
                var tool = toolsConfig[i];
                var isActive = state.activeTool === tool.key;
                var isFeatured = tool.key === 'imageCreation';

                html += '<button class="tool-nav-item' + (isActive ? ' active' : '') + (isFeatured ? ' featured' : '') + '" onclick="app.setActiveTool(\'' + tool.key + '\')">';
                html += '<div class="tool-nav-icon">' + getToolIcon(tool.icon) + '</div>';
                html += '<div class="tool-nav-name">' + tool.name + '</div>';
                html += '</button>';
            }

            // More button
            html += '<button class="tool-nav-item">';
            html += '<div class="tool-nav-icon">' + getToolIcon('more') + '</div>';
            html += '<div class="tool-nav-name">More</div>';
            html += '</button>';

            html += '</div>';
            return html;
        }

        // Get SVG icon for tool
        function getToolIcon(iconName) {
            var icons = {
                'canvas': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path><circle cx="11" cy="11" r="2"></circle></svg>',
                'realtime': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>',
                'motion': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>',
                'image': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>',
                'upscaler': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>',
                'editor': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>',
                'more': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>'
            };
            return icons[iconName] || icons['image'];
        }

        // Tool panels - show placeholder or tool interface
        function renderToolPanels() {
            var html = '';
            var activeTool = toolsConfig.find(function(t) { return t.key === state.activeTool; });

            // If tool interface is open, render full interface
            if (state.toolInterfaceOpen && activeTool) {
                html += renderToolInterface(activeTool);
                return html;
            }

            // Otherwise show placeholder
            if (activeTool) {
                html += '<div class="tool-placeholder fade-in">';
                html += '<div class="tool-placeholder-icon">' + getToolEmoji(activeTool.key) + '</div>';
                html += '<h2 class="tool-placeholder-title">' + activeTool.name + '</h2>';
                html += '<p class="tool-placeholder-text">' + activeTool.description + '</p>';
                html += '<button class="btn-primary mt-6" onclick="app.openTool(\'' + activeTool.key + '\')">';
                html += '<span>Start Creating</span>';
                html += '<span>â†’</span>';
                html += '</button>';
                html += '</div>';
            }

            return html;
        }

        // Render full tool interface (Phase 2)
        function renderToolInterface(tool) {
            var html = '<div class="tool-interface">';

            // Left Sidebar
            html += renderToolSidebar(tool);

            // Main Area
            html += renderToolMainArea();

            html += '</div>';
            return html;
        }

        // Render Tool Sidebar
        function renderToolSidebar(tool) {
            var html = '<div class="tool-sidebar">';

            // Tool Info Accordion - "What can this tool do?"
            html += '<div class="tool-info-accordion' + (state.toolInfoOpen ? ' open' : '') + '">';
            html += '<div class="tool-info-header" onclick="app.toggleToolInfo()">';
            html += '<div class="tool-info-header-left">';
            html += '<span class="tool-info-icon">ðŸ’¡</span>';
            html += '<span class="tool-info-title">What can this tool do?</span>';
            html += '</div>';
            html += '<span class="tool-info-arrow">â–¼</span>';
            html += '</div>';
            html += '<div class="tool-info-content">';
            html += '<p class="tool-info-description">' + tool.description + '</p>';
            if (tool.features && tool.features.length > 0) {
                html += '<div class="tool-info-features">';
                for (var fi = 0; fi < tool.features.length; fi++) {
                    html += '<div class="tool-info-feature">';
                    html += '<span class="tool-info-feature-icon">âœ“</span>';
                    html += '<span>' + tool.features[fi] + '</span>';
                    html += '</div>';
                }
                html += '</div>';
            }
            html += '</div>';
            html += '</div>';

            // Model Selector with Dropdown
            html += '<div class="sidebar-section">';
            html += '<div class="sidebar-section-header">';
            html += '<span class="sidebar-section-title">Model</span>';
            html += '</div>';
            html += '<div class="model-dropdown-wrapper">';

            // Find current selected model
            var currentModel = null;
            for (var mi = 0; mi < modelsConfig.length; mi++) {
                if (!modelsConfig[mi].divider && modelsConfig[mi].key === state.selectedModel) {
                    currentModel = modelsConfig[mi];
                    break;
                }
            }
            if (!currentModel) currentModel = modelsConfig[0];

            // Model dropdown trigger button - stopPropagation prevents document click from closing it
            html += '<button class="model-dropdown-trigger" onclick="event.stopPropagation(); app.toggleModelDropdown()">';
            html += '<span class="model-dropdown-trigger-icon">' + currentModel.icon + '</span>';
            html += '<span class="model-dropdown-trigger-name">' + currentModel.name + '</span>';
            if (currentModel.badge && currentModel.badge !== 'coming') {
                html += '<span class="model-badge ' + currentModel.badge + '">' + currentModel.badge + '</span>';
            }
            html += '<span class="model-dropdown-arrow">' + (state.modelDropdownOpen ? 'â–²' : 'â–¼') + '</span>';
            html += '</button>';

            // Dropdown menu
            if (state.modelDropdownOpen) {
                html += '<div class="model-dropdown-menu open">';
                for (var mj = 0; mj < modelsConfig.length; mj++) {
                    var model = modelsConfig[mj];
                    if (model.divider) {
                        html += '<div class="model-dropdown-divider"></div>';
                        continue;
                    }
                    var isSelected = state.selectedModel === model.key;
                    var itemClass = 'model-dropdown-item';
                    if (isSelected) itemClass += ' selected';
                    if (!model.available) itemClass += ' disabled';

                    html += '<div class="' + itemClass + '" onclick="event.stopPropagation(); ' + (model.available ? 'app.selectModel(\'' + model.key + '\')' : '') + '">';
                    html += '<span class="model-dropdown-item-icon">' + model.icon + '</span>';
                    html += '<div class="model-dropdown-item-info">';
                    html += '<span class="model-dropdown-item-name">' + model.name + '</span>';
                    html += '<span class="model-dropdown-item-desc">' + model.description + '</span>';
                    html += '</div>';
                    if (model.badge) {
                        var badgeText = model.badge === 'coming' ? 'Coming Soon' : model.badge;
                        html += '<span class="model-badge ' + model.badge + '">' + badgeText + '</span>';
                    }
                    html += '</div>';
                }
                html += '</div>';
            }

            html += '</div>'; // model-dropdown-wrapper
            html += '</div>'; // sidebar-section

            // References Section with Premium Locks
            var refModelCaps = getModelCapabilities(state.selectedModel);
            var refSupported = refModelCaps.supportsReferenceImages;

            html += '<div class="sidebar-section references-section">';
            html += '<div class="sidebar-section-header">';
            html += '<span class="sidebar-section-title">References</span>';
            if (!refSupported) {
                html += '<span class="references-model-warning" title="Switch to Imagen 3 to use references">âš ï¸ Imagen 3 only</span>';
            } else {
                html += '<span class="references-hint">Add images to guide your creation</span>';
            }
            html += '</div>';

            // Compatibility notice when model doesn't support references
            if (!refSupported && (state.styleReference || state.characterReference || state.uploadedImage)) {
                html += '<div class="references-compat-notice">';
                html += '<span>âš ï¸ ' + getModelDisplayName(state.selectedModel) + ' ignores references.</span>';
                html += '<button class="ref-switch-btn" onclick="app.switchToImagen3()">Switch to Nano Banana Pro</button>';
                html += '</div>';
            }

            html += '<div class="reference-grid">';

            // Style Reference (Free) - show applied state
            var styleRefClass = 'reference-btn' + (!refSupported ? ' ref-unsupported' : '') + (state.styleReference ? ' ref-applied' : '');
            html += '<button class="' + styleRefClass + '" onclick="app.openStyleReference()" title="' + (refSupported ? 'Add a style reference image' : 'Style reference - requires Imagen 3') + '">';
            if (state.styleReference) {
                var styleImgSrc = state.styleReference.type === 'file' ? state.styleReference.dataUrl : state.styleReference.url;
                html += '<img src="' + styleImgSrc + '" class="reference-btn-preview" alt="Style ref">';
                html += '<span class="reference-btn-check">âœ“</span>';
            }
            html += '<div class="reference-btn-content">';
            html += '<span class="reference-btn-icon">ðŸŽ¨</span>';
            html += '<span class="reference-btn-label">Style</span>';
            html += '</div>';
            html += '<span class="reference-btn-hint">' + (state.styleReference ? 'Applied' : 'Set the visual style') + '</span>';
            html += '</button>';

            // Character Reference (Premium - unlocked for PRO/Enterprise)
            if (state.hasPremiumAccess) {
                var charRefClass = 'reference-btn' + (!refSupported ? ' ref-unsupported' : '') + (state.characterReference ? ' ref-applied' : '');
                html += '<button class="' + charRefClass + '" onclick="app.openCharacterReference()" title="' + (refSupported ? 'Add a character reference for consistent faces' : 'Character reference - requires Imagen 3') + '">';
                if (state.characterReference) {
                    var charImgSrc = state.characterReference.type === 'file' ? state.characterReference.dataUrl : state.characterReference.url;
                    html += '<img src="' + charImgSrc + '" class="reference-btn-preview" alt="Character ref">';
                    html += '<span class="reference-btn-check">âœ“</span>';
                }
                html += '<div class="reference-btn-content">';
                html += '<span class="reference-btn-icon">ðŸ‘¤</span>';
                html += '<span class="reference-btn-label">Character</span>';
                html += '</div>';
                html += '<span class="reference-btn-hint">' + (state.characterReference ? 'Applied' : 'Consistent faces') + '</span>';
                html += '</button>';
            } else {
                html += '<button class="reference-btn premium-locked" onclick="app.showPremiumModal(\'Character Reference\')" title="Character Reference - PRO Feature">';
                html += '<div class="premium-lock-overlay">';
                html += '<span class="premium-lock-icon">ðŸ”’</span>';
                html += '</div>';
                html += '<div class="reference-btn-content">';
                html += '<span class="reference-btn-icon">ðŸ‘¤</span>';
                html += '<span class="reference-btn-label">Character</span>';
                html += '</div>';
                html += '<span class="reference-btn-hint">Consistent faces</span>';
                html += '</button>';
            }

            // Upload Reference (Premium - unlocked for PRO/Enterprise)
            if (state.hasPremiumAccess) {
                var uploadRefClass = 'reference-btn' + (!refSupported ? ' ref-unsupported' : '') + (state.uploadedImage ? ' ref-applied' : '');
                html += '<button class="' + uploadRefClass + '" onclick="app.openImageUpload()" title="' + (refSupported ? 'Upload your own image as reference' : 'Image upload - requires Imagen 3') + '">';
                if (state.uploadedImage) {
                    var uploadImgSrc = state.uploadedImage.type === 'file' ? state.uploadedImage.dataUrl : state.uploadedImage.url;
                    html += '<img src="' + uploadImgSrc + '" class="reference-btn-preview" alt="Uploaded ref">';
                    html += '<span class="reference-btn-check">âœ“</span>';
                }
                html += '<div class="reference-btn-content">';
                html += '<span class="reference-btn-icon">ðŸ“¤</span>';
                html += '<span class="reference-btn-label">Upload</span>';
                html += '</div>';
                html += '<span class="reference-btn-hint">' + (state.uploadedImage ? 'Applied' : 'Use your images') + '</span>';
                html += '</button>';
            } else {
                html += '<button class="reference-btn premium-locked" onclick="app.showPremiumModal(\'Image Upload\')" title="Upload Image - PRO Feature">';
                html += '<div class="premium-lock-overlay">';
                html += '<span class="premium-lock-icon">ðŸ”’</span>';
                html += '</div>';
                html += '<div class="reference-btn-content">';
                html += '<span class="reference-btn-icon">ðŸ“¤</span>';
                html += '<span class="reference-btn-label">Upload</span>';
                html += '</div>';
                html += '<span class="reference-btn-hint">Use your images</span>';
                html += '</button>';
            }

            html += '</div>';

            // Style reference indicator (if applied)
            if (state.styleReference) {
                var imgSrc = state.styleReference.type === 'file' ? state.styleReference.dataUrl : state.styleReference.url;
                html += '<div class="style-ref-indicator">';
                html += '<img class="style-ref-indicator-thumb" src="' + imgSrc + '" alt="Style reference">';
                html += '<div class="style-ref-indicator-info">';
                html += '<div class="style-ref-indicator-label">Style Reference</div>';
                html += '<div class="style-ref-indicator-name">' + utils.escapeHtml(state.styleReference.name) + '</div>';
                html += '</div>';
                html += '<button class="style-ref-indicator-remove" onclick="app.removeStyleReference()" title="Remove">Ã—</button>';
                html += '</div>';
            }

            // Character reference indicator (if applied - PRO feature)
            if (state.characterReference) {
                var charImgSrc = state.characterReference.type === 'file' ? state.characterReference.dataUrl : state.characterReference.url;
                html += '<div class="style-ref-indicator">';
                html += '<img class="style-ref-indicator-thumb" src="' + charImgSrc + '" alt="Character reference">';
                html += '<div class="style-ref-indicator-info">';
                html += '<div class="style-ref-indicator-label">ðŸ‘¤ Character Reference</div>';
                html += '<div class="style-ref-indicator-name">' + utils.escapeHtml(state.characterReference.name) + '</div>';
                html += '</div>';
                html += '<button class="style-ref-indicator-remove" onclick="app.removeCharacterReference()" title="Remove">Ã—</button>';
                html += '</div>';
            }

            // Uploaded image indicator (if applied - PRO feature)
            if (state.uploadedImage) {
                var uploadImgSrc = state.uploadedImage.type === 'file' ? state.uploadedImage.dataUrl : state.uploadedImage.url;
                html += '<div class="style-ref-indicator">';
                html += '<img class="style-ref-indicator-thumb" src="' + uploadImgSrc + '" alt="Uploaded image">';
                html += '<div class="style-ref-indicator-info">';
                html += '<div class="style-ref-indicator-label">ðŸ“¤ Uploaded Image</div>';
                html += '<div class="style-ref-indicator-name">' + utils.escapeHtml(state.uploadedImage.name) + '</div>';
                html += '</div>';
                html += '<button class="style-ref-indicator-remove" onclick="app.removeUploadedImage()" title="Remove">Ã—</button>';
                html += '</div>';
            }

            html += '</div>';

            // Smart Prompt Builder Section
            html += '<div class="sidebar-section">';

            // Selected Template Badge (if any)
            if (state.selectedTemplate) {
                html += '<div class="selected-template-badge">';
                html += '<span class="selected-template-badge-icon">âœ¨</span>';
                html += '<span class="selected-template-badge-name">' + utils.escapeHtml(state.selectedTemplate.name) + '</span>';
                html += '<span class="selected-template-badge-cost">ðŸª™ ' + (state.selectedTemplate.tokenCost || 2) + '</span>';
                html += '<button class="selected-template-badge-remove" onclick="app.clearTemplate()" title="Remove template">âœ•</button>';
                html += '</div>';
            }

            // Smart Prompt Container
            html += '<div class="smart-prompt-container">';
            html += '<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">';
            html += '<div class="smart-prompt-label" style="margin-bottom: 0;">PROMPT</div>';
            html += '<button class="prompt-expand-btn" onclick="app.openPromptModal()" title="Expand editor">â¤¢</button>';
            html += '</div>';

            // Editable prompt area with textarea
            html += '<textarea id="prompt-textarea" class="prompt-textarea smart-prompt-editable" placeholder="Describe what you want to create... or select a template below" oninput="app.updatePrompt(this.value)">' + utils.escapeHtml(state.prompt) + '</textarea>';

            // Template Variable Chips (if prompt contains variables)
            var templateVars = app.getUnfilledVariables(state.prompt);
            if (templateVars.length > 0) {
                html += '<div class="template-vars-bar">';
                html += '<span class="template-vars-label">Fill in:</span>';
                for (var vi = 0; vi < templateVars.length; vi++) {
                    var varName = templateVars[vi];
                    html += '<button class="template-var-chip" onclick="app.showVariableInput(\'' + utils.escapeHtml(varName) + '\')">';
                    html += '<span class="template-var-chip-icon">âœï¸</span>';
                    html += '<span class="template-var-chip-name">{{' + utils.escapeHtml(varName) + '}}</span>';
                    html += '</button>';
                }
                html += '</div>';
            }

            // Scene Quick Selector (for product photography template)
            if (state.selectedTemplate && state.selectedTemplate.id === 'product-studio') {
                html += '<div class="scene-quick-selector">';
                var scenes = ['Studio gradient', 'Street display', 'Floating', 'Lifestyle', 'Nature'];
                var selectedScene = state.selectedScene || 'Studio gradient';
                html += '<button class="scene-option all-random' + (state.sceneMode === 'all' ? ' active' : '') + '" onclick="app.setSceneMode(\'all\')">ðŸ”€ All</button>';
                html += '<button class="scene-option custom' + (state.sceneMode === 'custom' ? ' active' : '') + '" onclick="app.setSceneMode(\'custom\')">âœï¸ Custom</button>';
                for (var si = 0; si < scenes.length; si++) {
                    var scene = scenes[si];
                    var isSceneActive = selectedScene === scene && state.sceneMode !== 'all' && state.sceneMode !== 'custom';
                    html += '<button class="scene-option' + (isSceneActive ? ' active' : '') + '" onclick="app.selectScene(\'' + scene + '\')">' + scene + '</button>';
                }
                html += '</div>';
            }

            // Smart Action Buttons with Prompt Health Indicator
            html += '<div class="smart-prompt-actions">';
            html += '<button class="smart-action-btn' + (state.enhancingPrompt ? ' enhancing' : '') + '" onclick="app.enhancePrompt()" title="Enhance with AI"' + (state.enhancingPrompt ? ' disabled' : '') + '>' + (state.enhancingPrompt ? '<span class="btn-spinner"></span>' : 'âœ¨') + '</button>';
            html += '<button class="smart-action-btn" onclick="app.randomPrompt()" title="Random prompt">ðŸŽ²</button>';
            html += '<button class="smart-action-btn" onclick="app.clearPrompt()" title="Clear prompt">ðŸ—‘ï¸</button>';
            html += '<span style="flex: 1;"></span>';
            html += '<div class="prompt-health">';
            // Prompt health indicator
            var promptLen = state.prompt.length;
            var healthClass = 'empty';
            var healthText = 'Enter a prompt';
            var healthIcon = 'â—‹';
            if (promptLen > 0 && promptLen < 20) {
                healthClass = 'short';
                healthText = 'Too short';
                healthIcon = 'â—”';
            } else if (promptLen >= 20 && promptLen < 50) {
                healthClass = 'short';
                healthText = 'Add more detail';
                healthIcon = 'â—‘';
            } else if (promptLen >= 50 && promptLen <= 500) {
                healthClass = 'good';
                healthText = 'Good prompt';
                healthIcon = 'â—';
            } else if (promptLen > 500 && promptLen <= 1500) {
                healthClass = 'good';
                healthText = 'Detailed';
                healthIcon = 'â—';
            } else if (promptLen > 1500 && promptLen < 1900) {
                healthClass = 'long';
                healthText = 'Very long';
                healthIcon = 'â—•';
            } else if (promptLen >= 1900) {
                healthClass = 'limit';
                healthText = 'Near limit';
                healthIcon = 'âš ';
            }
            html += '<span class="prompt-health-indicator ' + healthClass + '">' + healthIcon + ' ' + healthText + '</span>';
            // Character count
            var countClass = 'prompt-char-count';
            if (promptLen > 1800) countClass += ' danger';
            else if (promptLen > 1500) countClass += ' warning';
            html += '<span class="' + countClass + '">' + promptLen + '/2000</span>';
            html += '</div>';
            html += '</div>';

            html += '</div>'; // smart-prompt-container
            html += '</div>'; // sidebar-section

            // Settings Section (Quantity, Aspect Ratio, Quality)
            html += '<div class="sidebar-section">';

            // Quantity with +/- buttons
            html += '<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">';
            html += '<label class="settings-label" style="margin-bottom: 0;">Quantity</label>';
            html += '<div class="quantity-selector">';
            html += '<button class="quantity-control" onclick="app.decrementQuantity()"' + (state.quantity <= 1 ? ' disabled' : '') + '>âˆ’</button>';
            html += '<span class="quantity-value">' + state.quantity + '</span>';
            html += '<button class="quantity-control" onclick="app.incrementQuantity()"' + (state.quantity >= 4 ? ' disabled' : '') + '>+</button>';
            html += '</div>';
            html += '</div>';

            html += '<div class="settings-row">';
            // Aspect Ratio
            html += '<div class="settings-group">';
            html += '<label class="settings-label">Aspect Ratio</label>';
            html += '<select class="settings-select" onchange="app.setAspectRatio(this.value)">';
            var ratios = ['1:1', '16:9', '9:16', '4:3', '3:4'];
            for (var r = 0; r < ratios.length; r++) {
                var ratio = ratios[r];
                var selected = state.aspectRatio === ratio ? ' selected' : '';
                html += '<option value="' + ratio + '"' + selected + '>' + ratio + '</option>';
            }
            html += '</select>';
            html += '</div>';

            // Quality
            html += '<div class="settings-group">';
            html += '<label class="settings-label">Quality</label>';
            html += '<select class="settings-select" onchange="app.setQuality(this.value)">';
            var qualities = [
                { key: 'basic', name: 'Basic (1ðŸª™)', cost: 1 },
                { key: 'hd', name: 'HD (2ðŸª™)', cost: 2 },
                { key: 'ultra', name: 'Ultra (4ðŸª™)', cost: 4 }
            ];
            for (var qi = 0; qi < qualities.length; qi++) {
                var qual = qualities[qi];
                var selected = state.quality === qual.key ? ' selected' : '';
                html += '<option value="' + qual.key + '"' + selected + '>' + qual.name + '</option>';
            }
            html += '</select>';
            html += '</div>';
            html += '</div>'; // settings-row

            // Advanced Settings Section (model-specific)
            var modelCapabilities = getModelCapabilities(state.selectedModel);
            var hasAdvancedOptions = modelCapabilities.supportsNegativePrompt || modelCapabilities.supportsSeed;

            if (hasAdvancedOptions) {
                html += '<div class="advanced-settings-toggle" onclick="app.toggleAdvancedSettings()">';
                html += '<span class="advanced-settings-icon">' + (state.showAdvancedSettings ? 'â–¼' : 'â–¶') + '</span>';
                html += '<span>Advanced Settings</span>';
                if (!state.showAdvancedSettings && (state.negativePrompt || state.seed)) {
                    html += '<span class="advanced-settings-badge">Active</span>';
                }
                html += '</div>';

                if (state.showAdvancedSettings) {
                    html += '<div class="advanced-settings-panel">';

                    // Negative Prompt
                    if (modelCapabilities.supportsNegativePrompt) {
                        html += '<div class="advanced-setting-group">';
                        html += '<label class="advanced-setting-label">';
                        html += '<span>Negative Prompt</span>';
                        html += '<span class="advanced-setting-hint">Things to avoid</span>';
                        html += '</label>';
                        html += '<textarea class="advanced-setting-textarea" placeholder="e.g., blurry, low quality, distorted, watermark, text" onchange="app.setNegativePrompt(this.value)">' + utils.escapeHtml(state.negativePrompt) + '</textarea>';
                        html += '</div>';
                    }

                    // Seed Control
                    if (modelCapabilities.supportsSeed) {
                        html += '<div class="advanced-setting-group">';
                        html += '<label class="advanced-setting-label">';
                        html += '<span>Seed</span>';
                        html += '<span class="advanced-setting-hint">For reproducible results</span>';
                        html += '</label>';
                        html += '<div class="seed-input-row">';
                        html += '<input type="number" class="advanced-setting-input" placeholder="Random" value="' + (state.seed || '') + '" onchange="app.setSeed(this.value)" min="0" max="2147483647" />';
                        html += '<button class="seed-random-btn" onclick="app.generateRandomSeed()" title="Generate random seed">ðŸŽ²</button>';
                        if (state.seed) {
                            html += '<button class="seed-clear-btn" onclick="app.clearSeed()" title="Clear seed">âœ•</button>';
                        }
                        html += '</div>';
                        html += '</div>';
                    }

                    html += '</div>'; // advanced-settings-panel
                }
            } else if (state.selectedModel.includes('dall-e')) {
                // Show info for DALL-E models that don't support advanced settings
                html += '<div class="advanced-settings-info">';
                html += '<span class="info-icon">â„¹ï¸</span>';
                html += '<span>DALL-E models don\'t support negative prompts or seed control</span>';
                html += '</div>';
            }

            html += '</div>'; // sidebar-section

            // Enhanced Generate Button Section
            html += '<div class="generate-section">';
            var cost = app.calculateCost();
            var canGenerate = state.prompt.trim().length > 0 && state.tokens.balance >= cost && !state.generating;

            if (state.generating) {
                // Generation in progress - show progress UI
                html += '<div class="generation-progress-container">';

                // Stage indicator
                var stageLabels = {
                    'queued': 'Queued',
                    'processing': 'Processing',
                    'generating': 'Generating',
                    'finalizing': 'Finalizing'
                };
                var stageLabel = stageLabels[state.generationStage] || 'Preparing';

                html += '<div class="generation-stage">';
                html += '<span class="generation-stage-icon animate-pulse">âœ¨</span>';
                html += '<span class="generation-stage-label">' + stageLabel + '...</span>';
                html += '<span class="generation-stage-percent">' + state.generationProgress + '%</span>';
                html += '</div>';

                // Progress bar
                html += '<div class="generation-progress-bar">';
                html += '<div class="generation-progress-fill" style="width: ' + state.generationProgress + '%;"></div>';
                html += '</div>';

                // Stage steps
                html += '<div class="generation-stages">';
                var stages = ['queued', 'processing', 'generating', 'finalizing'];
                var stageIcons = { queued: 'ðŸ“‹', processing: 'âš™ï¸', generating: 'ðŸŽ¨', finalizing: 'âœ…' };
                var currentStageIndex = stages.indexOf(state.generationStage);

                for (var si = 0; si < stages.length; si++) {
                    var stageClass = 'generation-stage-step';
                    if (si < currentStageIndex) stageClass += ' completed';
                    if (si === currentStageIndex) stageClass += ' active';
                    html += '<div class="' + stageClass + '">' + stageIcons[stages[si]] + '</div>';
                }
                html += '</div>';

                html += '</div>'; // generation-progress-container
            } else {
                // Normal generate button
                html += '<button class="generate-btn-enhanced" onclick="app.generateImage()"' + (canGenerate ? '' : ' disabled') + '>';
                html += '<span class="generate-btn-sparkle">âœ¨</span>';
                html += '<span>Generate</span>';
                html += '</button>';
            }

            // Enhanced Cost Breakdown Display
            html += '<div class="cost-breakdown">';

            // Calculate cost components
            var baseCost = tokenConfig.costs[state.quality] || 2;
            var templateBonus = state.selectedTemplate ? Math.max(0, (state.selectedTemplate.cost || 2) - 2) : 0;
            var quantity = state.quantity;
            var totalCost = cost;
            var costPerImage = quantity > 1 ? Math.ceil(totalCost / quantity) : totalCost;
            var hasEnoughTokens = state.tokens.balance >= totalCost;

            // Cost breakdown header
            html += '<div class="cost-breakdown-header">';
            html += '<span class="cost-breakdown-label">Total Cost</span>';
            html += '<span class="cost-breakdown-total' + (hasEnoughTokens ? '' : ' insufficient') + '">ðŸª™ ' + totalCost + '</span>';
            html += '</div>';

            // Cost details (expandable)
            html += '<div class="cost-breakdown-details">';

            // Base quality cost
            html += '<div class="cost-breakdown-row">';
            html += '<span class="cost-detail-label">' + state.quality.charAt(0).toUpperCase() + state.quality.slice(1) + ' quality</span>';
            html += '<span class="cost-detail-value">ðŸª™ ' + baseCost + '</span>';
            html += '</div>';

            // Template bonus (if any)
            if (templateBonus > 0) {
                html += '<div class="cost-breakdown-row">';
                html += '<span class="cost-detail-label">Template bonus</span>';
                html += '<span class="cost-detail-value">+ðŸª™ ' + templateBonus + '</span>';
                html += '</div>';
            }

            // Quantity multiplier
            if (quantity > 1) {
                html += '<div class="cost-breakdown-row">';
                html += '<span class="cost-detail-label">Ã— ' + quantity + ' images</span>';
                html += '<span class="cost-detail-value">ðŸª™ ' + costPerImage + ' each</span>';
                html += '</div>';
            }

            html += '</div>'; // cost-breakdown-details

            // Balance display
            html += '<div class="cost-breakdown-balance">';
            html += '<div class="balance-row">';
            html += '<span>Your balance</span>';
            html += '<span class="balance-value' + (hasEnoughTokens ? '' : ' insufficient') + '">ðŸª™ ' + state.tokens.balance + '</span>';
            html += '</div>';
            if (!hasEnoughTokens) {
                html += '<div class="balance-warning">âš ï¸ Insufficient tokens</div>';
            }
            if (state.tokens.rollover > 0) {
                html += '<div class="rollover-info">+' + state.tokens.rollover + ' rollover available</div>';
            }
            html += '</div>';

            html += '</div>'; // cost-breakdown

            html += '</div>'; // generate-section

            html += '</div>'; // tool-sidebar
            return html;
        }

        // Render Tool Main Area (History, Templates, Community tabs)
        function renderToolMainArea() {
            var html = '<div class="tool-main">';

            // Tab Bar
            html += '<div class="main-tabs">';
            var tabs = [
                { key: 'history', name: 'History', count: state.history.length },
                { key: 'templates', name: 'Templates', count: getTotalTemplateCount() },
                { key: 'community', name: 'Community', count: state.communityItems.length }
            ];
            for (var t = 0; t < tabs.length; t++) {
                var tab = tabs[t];
                var isActive = state.mainTab === tab.key;
                html += '<button class="main-tab' + (isActive ? ' active' : '') + '" onclick="app.setMainTab(\'' + tab.key + '\')">';
                html += '<span>' + tab.name + '</span>';
                html += '<span class="main-tab-count">' + tab.count + '</span>';
                html += '</button>';
            }
            html += '</div>';

            // Tab Content
            html += '<div class="main-content">';
            if (state.mainTab === 'history') {
                html += renderHistoryTab();
            } else if (state.mainTab === 'templates') {
                html += renderTemplatesTab();
            } else if (state.mainTab === 'community') {
                html += renderCommunityTab();
            }
            html += '</div>';

            html += '</div>'; // tool-main
            return html;
        }

        // Get total template count
        function getTotalTemplateCount() {
            var count = 0;
            for (var i = 0; i < templateCategories.length; i++) {
                count += templateCategories[i].templates.length;
            }
            return count;
        }

        // Render History Tab
        function renderHistoryTab() {
            var html = '';

            if (state.historyLoading) {
                html += '<div class="text-center py-8">';
                html += '<div class="loading-spinner mx-auto"></div>';
                html += '<p class="text-white/60 mt-4">Loading your creations...</p>';
                html += '</div>';
                return html;
            }

            if (state.history.length === 0) {
                html += '<div class="empty-state">';
                html += '<div class="empty-state-icon">ðŸ–¼ï¸</div>';
                html += '<h3 class="empty-state-title">No creations yet</h3>';
                html += '<p class="empty-state-text">Your generated images will appear here. Start by selecting a template or writing a prompt!</p>';
                html += '</div>';
                return html;
            }

            // Determine how many items to show
            var itemsToShow = Math.min(state.historyDisplayCount, state.history.length);
            var hasMore = state.history.length > state.historyDisplayCount;

            // History stats
            html += '<div class="history-stats">';
            html += '<span class="history-count">' + state.history.length + ' creations</span>';
            if (hasMore) {
                html += '<span class="history-showing">Showing ' + itemsToShow + ' of ' + state.history.length + '</span>';
            }
            html += '</div>';

            // Check if user is premium (has share control)
            var userPlan = state.tokens.plan || 'free';
            var isPremiumUser = ['lite', 'pro', 'business', 'enterprise'].includes(userPlan);

            html += '<div class="history-grid">';
            for (var i = 0; i < itemsToShow; i++) {
                var item = state.history[i];
                // Get image URL - handle both old format (imageUrl) and new format (images array)
                var imageUrl = item.imageUrl || (item.images && item.images[0] ? item.images[0].url : '');
                var cachedUrl = imageCache.get(imageUrl);
                html += '<div class="history-item" onclick="app.openImageDetail(' + i + ')" style="cursor: pointer;">';

                // Show shared badge based on status and user type
                if (item.sharedToGallery) {
                    if (item.autoShared) {
                        // Auto-shared (free user)
                        html += '<div class="history-shared-badge" style="background: rgba(59, 130, 246, 0.9);">ðŸŒ Community</div>';
                    } else if (item.isPrivate) {
                        // Manually shared as private (premium user)
                        html += '<div class="history-shared-badge">ðŸ”’ Private</div>';
                    } else {
                        // Manually shared as public (premium user)
                        html += '<div class="history-shared-badge">âœ“ Shared</div>';
                    }
                }

                html += '<div class="image-skeleton"></div>';
                html += '<img src="' + cachedUrl + '" data-src="' + imageUrl + '" alt="Creation" class="history-item-image" loading="lazy" onload="this.classList.add(\'loaded\')" />';
                html += '<div class="history-item-overlay">';
                html += '<div class="history-item-actions" onclick="event.stopPropagation()">';
                html += '<button class="history-action-btn" onclick="event.stopPropagation(); app.downloadImage(\'' + imageUrl + '\')" title="Download">â¬‡ï¸</button>';
                html += '<button class="history-action-btn" onclick="event.stopPropagation(); app.usePrompt(\'' + utils.escapeHtml(item.prompt).replace(/'/g, "\\'") + '\')" title="Reuse Prompt">ðŸ”„</button>';

                // Share button logic based on user type and share status
                if (isPremiumUser) {
                    // Premium users can manually share
                    if (item.sharedToGallery) {
                        html += '<button class="history-action-btn" style="opacity: 0.5; cursor: default;" title="Already shared">âœ“</button>';
                    } else {
                        html += '<button class="history-action-btn" onclick="event.stopPropagation(); app.openShareDialog(\'' + item.id + '\')" title="Share to Community">ðŸ“¤</button>';
                    }
                } else {
                    // Free users - images auto-shared, no manual control
                    html += '<button class="history-action-btn" style="opacity: 0.5; cursor: default;" title="Auto-shared to community">ðŸŒ</button>';
                }

                html += '<button class="history-action-btn" onclick="event.stopPropagation(); app.deleteFromHistory(\'' + item.id + '\')" title="Delete">ðŸ—‘ï¸</button>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
            }
            html += '</div>';

            // Load More button
            if (hasMore) {
                var remaining = state.history.length - state.historyDisplayCount;
                html += '<div class="load-more-container">';
                html += '<button class="load-more-btn" onclick="app.loadMoreHistory()">';
                html += '<span>Load More</span>';
                html += '<span class="load-more-count">(' + remaining + ' more)</span>';
                html += '</button>';
                html += '</div>';
            }

            return html;
        }

        // Render Templates Tab
        function renderTemplatesTab() {
            var html = '';

            // Category Filter Pills
            html += '<div class="category-filter-row">';
            html += '<button class="category-filter-pill' + (state.selectedTemplateCategory === 'all' ? ' active' : '') + '" onclick="app.setTemplateCategory(\'all\')">All Templates</button>';
            for (var c = 0; c < templateCategories.length; c++) {
                var cat = templateCategories[c];
                var isActive = state.selectedTemplateCategory === cat.key;
                html += '<button class="category-filter-pill' + (isActive ? ' active' : '') + '" onclick="app.setTemplateCategory(\'' + cat.key + '\')">';
                html += cat.icon + ' ' + cat.name;
                html += '</button>';
            }
            html += '</div>';

            // Template Categories
            var categoriesToShow = state.selectedTemplateCategory === 'all'
                ? templateCategories
                : templateCategories.filter(function(c) { return c.key === state.selectedTemplateCategory; });

            for (var i = 0; i < categoriesToShow.length; i++) {
                var category = categoriesToShow[i];

                html += '<div class="template-categories">';
                html += '<div class="template-category-header">';
                html += '<div class="template-category-icon">' + category.icon + '</div>';
                html += '<h3 class="template-category-title">' + category.name + '</h3>';
                html += '<span class="template-category-count">' + category.templates.length + ' templates</span>';
                html += '</div>';

                html += '<div class="template-grid">';
                for (var j = 0; j < category.templates.length; j++) {
                    var template = category.templates[j];
                    var isSelected = state.selectedTemplate && state.selectedTemplate.id === template.id;

                    html += '<div class="template-card' + (isSelected ? ' active' : '') + '" onclick="app.selectTemplate(\'' + template.id + '\')">';
                    html += '<div class="template-card-title">' + utils.escapeHtml(template.name) + '</div>';
                    html += '<div class="template-card-desc">' + utils.escapeHtml(template.description) + '</div>';
                    html += '<div class="template-card-cost">ðŸª™ ' + template.cost + ' tokens</div>';
                    html += '</div>';
                }
                html += '</div>'; // template-grid
                html += '</div>'; // template-categories
            }

            return html;
        }

        // Render Community Tab
        function renderCommunityTab() {
            var html = '';

            // Header with sort options and refresh
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">';

            // Sort buttons
            html += '<div style="display: flex; gap: 0.5rem;">';
            html += '<button class="' + (state.communitySort === 'newest' ? 'template-category-pill active' : 'template-category-pill') + '" onclick="app.setCommunitySort(\'newest\')">';
            html += 'ðŸ• Newest';
            html += '</button>';
            html += '<button class="' + (state.communitySort === 'popular' ? 'template-category-pill active' : 'template-category-pill') + '" onclick="app.setCommunitySort(\'popular\')">';
            html += 'ðŸ”¥ Popular';
            html += '</button>';
            html += '</div>';

            // Refresh button
            html += '<button class="template-category-pill" onclick="app.refreshCommunityGallery()" style="display: flex; align-items: center; gap: 0.25rem;">';
            html += '<span>ðŸ”„</span> Refresh';
            html += '</button>';
            html += '</div>';

            // Info banner about sharing behavior
            var userPlan = state.tokens.plan || 'free';
            var isPremiumUser = ['lite', 'pro', 'business', 'enterprise'].includes(userPlan);

            html += '<div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 0.75rem; padding: 1rem; margin-bottom: 1.5rem;">';
            if (isPremiumUser) {
                html += '<p style="font-size: 0.85rem; color: rgba(255,255,255,0.8); margin: 0;">';
                html += 'ðŸ”’ <strong>Premium Control:</strong> You can choose to share images publicly, keep them private, or sell your prompts for tokens!';
                html += '</p>';
            } else {
                html += '<p style="font-size: 0.85rem; color: rgba(255,255,255,0.8); margin: 0;">';
                html += 'ðŸŒ <strong>Community Gallery:</strong> All free user creations are automatically shared here. ';
                html += '<a href="#" onclick="event.preventDefault(); app.upgradeToPremium();" style="color: #a78bfa; text-decoration: underline;">Upgrade to Pro</a> for privacy control!';
                html += '</p>';
            }
            html += '</div>';

            // Loading state
            if (state.communityLoading) {
                html += '<div class="text-center py-8">';
                html += '<div class="loading-spinner mx-auto"></div>';
                html += '<p class="text-white/60 mt-4">Loading community gallery...</p>';
                html += '</div>';
                return html;
            }

            // Error state
            if (state.communityError) {
                html += '<div class="empty-state">';
                html += '<div class="empty-state-icon">âš ï¸</div>';
                html += '<h3 class="empty-state-title">Failed to load</h3>';
                html += '<p class="empty-state-text">' + utils.escapeHtml(state.communityError) + '</p>';
                html += '<button class="btn-primary" onclick="app.refreshCommunityGallery()" style="margin-top: 1rem;">Try Again</button>';
                html += '</div>';
                return html;
            }

            // Empty state
            if (state.communityItems.length === 0) {
                html += '<div class="empty-state">';
                html += '<div class="empty-state-icon">ðŸŒŸ</div>';
                html += '<h3 class="empty-state-title">No community creations yet</h3>';
                html += '<p class="empty-state-text">Be the first to share! Create an image and click the share button in your History tab.</p>';
                html += '</div>';
                return html;
            }

            // Community Gallery Grid (Masonry)
            html += '<div class="gallery-grid">';

            for (var i = 0; i < state.communityItems.length; i++) {
                var item = state.communityItems[i];
                var isLiked = state.userLikes[item.id] || false;
                var cachedUrl = imageCache.get(item.imageUrl || '');

                html += '<div class="community-item" onclick="app.openCommunityImageDetail(' + i + ')" style="cursor: pointer;">';
                html += '<div class="image-skeleton"></div>';
                html += '<img src="' + cachedUrl + '" data-src="' + (item.imageUrl || '') + '" alt="Community creation" class="community-item-image" loading="lazy" onload="this.classList.add(\'loaded\')" onerror="this.src=\'https://via.placeholder.com/400x400?text=Image+Not+Found\'" />';

                // Private badge
                if (item.isPrivate) {
                    html += '<div class="private-badge">ðŸ”’ ' + (item.promptPrice || 5) + ' tokens</div>';
                }

                html += '<div class="community-item-overlay" onclick="event.stopPropagation()">';

                // Prompt (blurred if private)
                html += '<p class="community-item-prompt' + (item.isPrivate ? ' locked' : '') + '">' + utils.escapeHtml(item.prompt || '') + '</p>';

                html += '<div class="community-item-footer">';

                // User info
                html += '<div class="community-item-user">';
                html += '<div class="community-item-avatar">' + (item.userAvatar || (item.userName || 'A').substring(0, 2).toUpperCase()) + '</div>';
                html += '<span>' + utils.escapeHtml(item.userName || 'Anonymous') + '</span>';
                html += '</div>';

                // Actions
                html += '<div class="community-item-actions">';
                html += '<button class="community-action-btn' + (isLiked ? ' liked' : '') + '" onclick="event.stopPropagation(); app.likeGalleryItem(\'' + item.id + '\')" title="Like">';
                html += (isLiked ? 'â¤ï¸' : 'ðŸ¤') + ' ' + (item.likes || 0);
                html += '</button>';

                if (item.isPrivate) {
                    // Buy prompt button
                    html += '<button class="community-action-btn buy-prompt" onclick="event.stopPropagation(); app.purchasePrompt(\'' + item.id + '\', ' + (item.promptPrice || 5) + ')" title="Buy Prompt">';
                    html += 'ðŸª™ Buy';
                    html += '</button>';
                } else {
                    // Copy/Use prompt button
                    html += '<button class="community-action-btn" onclick="event.stopPropagation(); app.usePrompt(\'' + utils.escapeHtml(item.prompt || '').replace(/'/g, "\\'") + '\')" title="Use Prompt">';
                    html += 'ðŸ“‹ Use';
                    html += '</button>';
                }

                html += '</div>'; // actions
                html += '</div>'; // footer
                html += '</div>'; // overlay
                html += '</div>'; // community-item
            }

            html += '</div>'; // gallery-grid

            return html;
        }

        // Render Prompt Editor Modal
        function renderPromptModal() {
            if (!state.promptModalOpen) return '';

            var html = '<div class="prompt-modal-overlay" onclick="app.closePromptModal(event)">';
            html += '<div class="prompt-modal" onclick="event.stopPropagation()">';

            // Header
            html += '<div class="prompt-modal-header">';
            html += '<div class="prompt-modal-title">âœï¸ Edit Prompt</div>';
            html += '<button class="prompt-modal-close" onclick="app.closePromptModal()">âœ•</button>';
            html += '</div>';

            // Body
            html += '<div class="prompt-modal-body">';
            html += '<textarea id="prompt-modal-textarea" class="prompt-modal-textarea" placeholder="Describe what you want to create in detail..." oninput="app.updatePromptModalText(this.value)">' + utils.escapeHtml(state.promptModalText) + '</textarea>';

            // Extract and display template variables
            var variables = extractTemplateVariables(state.promptModalText);
            if (variables.length > 0) {
                html += '<div class="prompt-modal-variables">';
                html += '<div class="prompt-modal-variables-label">Template Variables</div>';
                html += '<div class="prompt-modal-variables-row">';
                for (var i = 0; i < variables.length; i++) {
                    html += '<span class="variable-chip"><span class="variable-chip-icon">{{</span>' + utils.escapeHtml(variables[i]) + '<span class="variable-chip-icon">}}</span></span>';
                }
                html += '</div>';
                html += '</div>';
            }

            // Actions row
            html += '<div class="prompt-modal-info">';
            html += '<div class="prompt-modal-actions-row">';
            html += '<button class="smart-action-btn" onclick="app.enhancePromptInModal()" title="Enhance with AI">âœ¨</button>';
            html += '<button class="smart-action-btn" onclick="app.randomPromptInModal()" title="Random prompt">ðŸŽ²</button>';
            html += '<button class="smart-action-btn" onclick="app.clearPromptInModal()" title="Clear prompt">ðŸ—‘ï¸</button>';
            html += '</div>';

            var charCount = state.promptModalText.length;
            var charClass = charCount > 1900 ? 'error' : (charCount > 1500 ? 'warning' : '');
            html += '<span class="prompt-modal-char-count ' + charClass + '">' + charCount + '/2000</span>';
            html += '</div>';

            html += '</div>'; // body

            // Footer
            html += '<div class="prompt-modal-footer">';
            html += '<button class="prompt-modal-btn prompt-modal-btn-cancel" onclick="app.closePromptModal()">Cancel</button>';
            html += '<button class="prompt-modal-btn prompt-modal-btn-apply" onclick="app.applyPromptModal()">âœ“ Apply Changes</button>';
            html += '</div>';

            html += '</div>'; // modal
            html += '</div>'; // overlay

            return html;
        }

        // Helper function to extract {{variables}} from text
        function extractTemplateVariables(text) {
            var regex = /\{\{([^}]+)\}\}/g;
            var matches = [];
            var match;
            while ((match = regex.exec(text)) !== null) {
                if (matches.indexOf(match[1]) === -1) {
                    matches.push(match[1]);
                }
            }
            return matches;
        }

        // Render Image Detail Modal
        function renderImageDetailModal() {
            if (!state.imageDetailModalOpen || !state.selectedImageDetail) return '';

            var item = state.selectedImageDetail;
            var isCommunity = state.imageDetailSource === 'community';
            // Get image URL - handle both old format (imageUrl) and new format (images array)
            var imageUrl = item.imageUrl || (item.images && item.images[0] ? item.images[0].url : '');
            var html = '<div class="image-detail-modal-overlay" onclick="app.closeImageDetail(event)">';
            html += '<div class="image-detail-modal" onclick="event.stopPropagation()">';

            // Header
            html += '<div class="image-detail-header">';
            html += '<div class="image-detail-title">ðŸ–¼ï¸ Image Details</div>';
            html += '<button class="image-detail-close" onclick="app.closeImageDetail()">âœ•</button>';
            html += '</div>';

            // Body
            html += '<div class="image-detail-body">';

            // Image preview
            html += '<div class="image-detail-preview">';
            html += '<img src="' + imageUrl + '" alt="Generated image" />';
            html += '</div>';

            // Info panel
            html += '<div class="image-detail-info">';

            // Creator info for community items
            if (isCommunity && item.userName) {
                html += '<div class="image-detail-section">';
                html += '<div class="image-detail-label">Created By</div>';
                html += '<div class="image-detail-creator">';
                html += '<div class="image-detail-avatar">' + (item.userAvatar || 'U') + '</div>';
                html += '<span>' + utils.escapeHtml(item.userName) + '</span>';
                if (item.likes > 0) {
                    html += '<span class="image-detail-likes">â¤ï¸ ' + item.likes + '</span>';
                }
                html += '</div>';
                html += '</div>';
            }

            // Prompt section
            html += '<div class="image-detail-section">';
            html += '<div class="image-detail-label">Prompt</div>';
            if (isCommunity && item.isPrivate) {
                html += '<div class="image-detail-prompt locked">';
                html += '<span class="prompt-locked-icon">ðŸ”’</span>';
                html += '<span>Private prompt - ' + (item.promptPrice || 5) + ' tokens to unlock</span>';
                html += '</div>';
            } else {
                html += '<div class="image-detail-prompt">' + utils.escapeHtml(item.prompt || 'No prompt available') + '</div>';
            }
            html += '</div>';

            // Model and Quality row
            html += '<div class="image-detail-meta-row">';
            html += '<div class="image-detail-meta-item">';
            html += '<div class="image-detail-label">Model</div>';
            html += '<div class="image-detail-value">' + getModelDisplayName(item.model) + '</div>';
            html += '</div>';
            html += '<div class="image-detail-meta-item">';
            html += '<div class="image-detail-label">Quality</div>';
            html += '<div class="image-detail-value">' + (item.quality || 'HD').toUpperCase() + '</div>';
            html += '</div>';
            html += '</div>';

            // Aspect Ratio and Date row
            html += '<div class="image-detail-meta-row">';
            html += '<div class="image-detail-meta-item">';
            html += '<div class="image-detail-label">Aspect Ratio</div>';
            html += '<div class="image-detail-value">' + (item.aspectRatio || '1:1') + '</div>';
            html += '</div>';
            html += '<div class="image-detail-meta-item">';
            html += '<div class="image-detail-label">Created</div>';
            html += '<div class="image-detail-value">' + formatDate(item.createdAt) + '</div>';
            html += '</div>';
            html += '</div>';

            // Cost (for history items)
            if (!isCommunity && item.tokenCost) {
                html += '<div class="image-detail-section">';
                html += '<div class="image-detail-label">Token Cost</div>';
                html += '<div class="image-detail-value">ðŸª™ ' + item.tokenCost + '</div>';
                html += '</div>';
            }

            html += '</div>'; // info
            html += '</div>'; // body

            // Actions - different for history vs community
            html += '<div class="image-detail-actions">';
            html += '<button class="image-detail-btn image-detail-btn-primary" onclick="app.downloadImage(\'' + imageUrl + '\')">';
            html += 'â¬‡ï¸ Download';
            html += '</button>';

            if (isCommunity) {
                // Community actions
                if (item.isPrivate) {
                    // Buy prompt button for private prompts
                    html += '<button class="image-detail-btn image-detail-btn-secondary" onclick="app.purchasePrompt(\'' + item.id + '\', ' + (item.promptPrice || 5) + ')">';
                    html += 'ðŸ”“ Unlock Prompt (' + (item.promptPrice || 5) + ' tokens)';
                    html += '</button>';
                } else {
                    // Reuse prompt for public prompts
                    html += '<button class="image-detail-btn image-detail-btn-secondary" onclick="app.usePromptFromDetail()">';
                    html += 'ðŸ”„ Reuse Prompt';
                    html += '</button>';
                }
                // Like button
                var isLiked = state.userLikes[item.id] || false;
                html += '<button class="image-detail-btn' + (isLiked ? ' image-detail-btn-liked' : ' image-detail-btn-secondary') + '" onclick="app.likeGalleryItem(\'' + item.id + '\')">';
                html += (isLiked ? 'â¤ï¸ Liked' : 'ðŸ¤ Like');
                html += '</button>';
            } else {
                // History actions
                html += '<button class="image-detail-btn image-detail-btn-secondary" onclick="app.usePromptFromDetail()">';
                html += 'ðŸ”„ Reuse Prompt';
                html += '</button>';
                html += '<button class="image-detail-btn image-detail-btn-danger" onclick="app.deleteFromHistoryAndClose(\'' + item.id + '\')">';
                html += 'ðŸ—‘ï¸ Delete';
                html += '</button>';
            }
            html += '</div>';

            html += '</div>'; // modal
            html += '</div>'; // overlay

            return html;
        }

        // Helper function to get model display name
        function getModelDisplayName(modelKey) {
            if (!modelKey) return 'Auto';
            var modelNames = {
                // Frontend keys
                'auto': 'Auto',
                'gemini-2-flash': 'Gemini 2.0 Flash',
                'gemini-2-flash-exp': 'Gemini 2.0 Flash Exp',
                'gemini-2-flash-thinking': 'Gemini 2.0 Flash Thinking',
                'gemini-pro-vision': 'Gemini Pro Vision',
                'gemini-flash-lite': 'Gemini Flash Lite',
                'imagen-4': 'Imagen 4',
                'imagen-4-ultra': 'Imagen 4 Ultra',
                'imagen-3': 'Imagen 3',
                // Gemini Image models (Nano Banana)
                'nano-banana-pro': 'Nano Banana Pro',
                'nano-banana': 'Nano Banana',
                'gemini-3-pro-image-preview': 'Nano Banana Pro',
                'gemini-2.5-flash-image': 'Nano Banana',
                // DALL-E models
                'dall-e-3': 'DALL-E 3',
                'dall-e-2': 'DALL-E 2',
                'dalle-3': 'DALL-E 3',
                'dalle-2': 'DALL-E 2',
                // Legacy keys
                'banana1': 'Imagen 4',
                'banana2': 'Imagen 4 Ultra',
                'gemini-flash': 'Gemini Flash',
                // Backend model IDs (for history display)
                'imagen-4.0-generate-001': 'Imagen 4',
                'imagen-4.0-ultra-generate-001': 'Imagen 4 Ultra',
                'imagen-3.0-generate-001': 'Imagen 3',
                'gemini-2.0-flash': 'Gemini 2.0 Flash',
                'gemini-2.0-flash-exp': 'Gemini 2.0 Flash Exp',
                'gemini-2.0-flash-thinking-exp': 'Gemini 2.0 Flash Thinking',
                'gemini-1.5-pro': 'Gemini Pro Vision',
                'gemini-1.5-flash': 'Gemini Flash Lite'
            };
            return modelNames[modelKey] || modelKey;
        }

        // Helper function to format date (handles Firestore Timestamps)
        function formatDate(dateValue) {
            if (!dateValue) return 'Unknown';
            try {
                var date;
                // Handle Firestore Timestamp object with toDate() method
                if (dateValue && typeof dateValue.toDate === 'function') {
                    date = dateValue.toDate();
                }
                // Handle Firestore Timestamp as plain object with _seconds
                else if (dateValue && dateValue._seconds) {
                    date = new Date(dateValue._seconds * 1000);
                }
                // Handle Firestore Timestamp as plain object with seconds
                else if (dateValue && dateValue.seconds) {
                    date = new Date(dateValue.seconds * 1000);
                }
                // Handle ISO string or timestamp number
                else {
                    date = new Date(dateValue);
                }

                // Check if date is valid
                if (isNaN(date.getTime())) {
                    return 'Unknown';
                }

                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } catch (e) {
                console.warn('Date formatting error:', e);
                return 'Unknown';
            }
        }

        // Render Template Confirmation Dialog
        function renderConfirmDialog() {
            if (!state.confirmDialogOpen || !state.pendingTemplate) return '';

            var template = state.pendingTemplate;
            var currentPrompt = state.prompt.trim();
            var previewText = currentPrompt.length > 100 ? currentPrompt.substring(0, 100) + '...' : currentPrompt;

            var html = '<div class="confirm-dialog-overlay" onclick="app.cancelTemplateConfirm()">';
            html += '<div class="confirm-dialog" onclick="event.stopPropagation()">';

            // Header
            html += '<div class="confirm-dialog-header">';
            html += '<div class="confirm-dialog-icon">âš ï¸</div>';
            html += '<div class="confirm-dialog-title">Replace current prompt?</div>';
            html += '<div class="confirm-dialog-message">You have an existing prompt that will be replaced by the "' + utils.escapeHtml(template.name) + '" template.</div>';
            html += '</div>';

            // Current prompt preview
            html += '<div class="confirm-dialog-preview">';
            html += '<div class="confirm-dialog-preview-label">Current prompt</div>';
            html += utils.escapeHtml(previewText);
            html += '</div>';

            // Footer with buttons
            html += '<div class="confirm-dialog-footer">';
            html += '<button class="confirm-dialog-btn confirm-dialog-btn-cancel" onclick="app.cancelTemplateConfirm()">Cancel</button>';
            html += '<button class="confirm-dialog-btn confirm-dialog-btn-append" onclick="app.applyTemplate(state.pendingTemplate, \'append\')">Append</button>';
            html += '<button class="confirm-dialog-btn confirm-dialog-btn-replace" onclick="app.applyTemplate(state.pendingTemplate, \'replace\')">Replace</button>';
            html += '</div>';

            html += '</div>'; // dialog
            html += '</div>'; // overlay

            return html;
        }

        // Render Variable Input Popup
        function renderVariableInputPopup() {
            if (!state.variableInputOpen || !state.variableInputName) return '';

            var varName = state.variableInputName;
            var escapedVarName = utils.escapeHtml(varName);

            var html = '<div class="variable-input-overlay" onclick="app.cancelVariableInput()">';
            html += '<div class="variable-input-popup" onclick="event.stopPropagation()">';

            // Header
            html += '<div class="variable-input-header">';
            html += '<div class="variable-input-icon">âœï¸</div>';
            html += '<div>';
            html += '<div class="variable-input-title">Fill in variable</div>';
            html += '<div class="variable-input-subtitle">{{' + escapedVarName + '}}</div>';
            html += '</div>';
            html += '</div>';

            // Input field
            html += '<input type="text" id="variable-input-field" class="variable-input-field" ';
            html += 'placeholder="Enter value for ' + escapedVarName + '..." ';
            html += 'value="' + utils.escapeHtml(state.variableInputValue) + '" ';
            html += 'oninput="app.updateVariableInputValue(this.value)" ';
            html += 'onkeydown="if(event.key===\'Enter\' && this.value.trim()) app.applyVariableInput(); else if(event.key===\'Escape\') app.cancelVariableInput();">';

            // Actions
            html += '<div class="variable-input-actions">';
            html += '<button class="variable-input-btn variable-input-btn-cancel" onclick="app.cancelVariableInput()">Cancel</button>';
            html += '<button class="variable-input-btn variable-input-btn-apply" onclick="app.applyVariableInput()" ' + (state.variableInputValue.trim() ? '' : 'disabled') + '>Apply</button>';
            html += '</div>';

            html += '</div>'; // popup
            html += '</div>'; // overlay

            return html;
        }

        // Render Style Reference Modal
        function renderStyleReferenceModal() {
            if (!state.styleReferenceModalOpen) return '';

            var modelCaps = getModelCapabilities(state.selectedModel);

            var html = '<div class="style-ref-modal-overlay" onclick="app.closeStyleReference()">';
            html += '<div class="style-ref-modal" onclick="event.stopPropagation()">';

            // Header
            html += '<div class="style-ref-modal-header">';
            html += '<div class="style-ref-modal-title"><span>ðŸŽ¨</span> Style Reference</div>';
            html += '<button class="style-ref-modal-close" onclick="app.closeStyleReference()">Ã—</button>';
            html += '</div>';

            // Model compatibility warning
            if (!modelCaps.supportsReferenceImages) {
                html += '<div class="style-ref-warning">';
                html += '<span class="warning-icon">âš ï¸</span>';
                html += '<div class="warning-content">';
                html += '<strong>' + getModelDisplayName(state.selectedModel) + '</strong> doesn\'t support style references.<br>';
                html += '<button class="switch-model-btn" onclick="app.switchToImagen3()">Switch to Nano Banana Pro</button>';
                html += '</div>';
                html += '</div>';
            }

            // Body
            html += '<div class="style-ref-modal-body">';

            // Hidden file input
            html += '<input type="file" id="style-ref-file-input" class="hidden-file-input" accept="image/*" onchange="app.handleStyleRefFile(this.files[0])">';

            if (state.styleReference) {
                // Show preview
                var imgSrc = state.styleReference.type === 'file' ? state.styleReference.dataUrl : state.styleReference.url;
                html += '<div class="style-ref-preview">';
                html += '<img src="' + imgSrc + '" alt="Style reference preview">';
                html += '<div class="style-ref-preview-actions">';
                html += '<button class="style-ref-preview-btn" onclick="app.triggerStyleRefUpload()" title="Change image">ðŸ”„</button>';
                html += '<button class="style-ref-preview-btn remove" onclick="app.removeStyleReference()" title="Remove">ðŸ—‘ï¸</button>';
                html += '</div>';
                html += '</div>';
            } else {
                // Show upload zone
                html += '<div class="style-ref-upload-zone" onclick="app.triggerStyleRefUpload()" ';
                html += 'ondragover="event.preventDefault(); this.classList.add(\'dragover\')" ';
                html += 'ondragleave="this.classList.remove(\'dragover\')" ';
                html += 'ondrop="event.preventDefault(); this.classList.remove(\'dragover\'); app.handleStyleRefFile(event.dataTransfer.files[0])">';
                html += '<div class="style-ref-upload-icon">ðŸ“¤</div>';
                html += '<div class="style-ref-upload-title">Drop an image here or click to upload</div>';
                html += '<div class="style-ref-upload-hint">PNG, JPG, GIF or WebP â€¢ Max 10MB</div>';
                html += '</div>';

                // URL input section
                html += '<div class="style-ref-url-section">';
                html += '<label class="style-ref-url-label">Or paste an image URL</label>';
                html += '<input type="text" class="style-ref-url-input" placeholder="https://example.com/image.jpg" ';
                html += 'onkeydown="if(event.key===\'Enter\') app.handleStyleRefUrl(this.value)">';
                html += '</div>';
            }

            html += '</div>'; // body

            // Footer
            html += '<div class="style-ref-modal-footer">';
            html += '<button class="style-ref-btn style-ref-btn-cancel" onclick="app.closeStyleReference()">Cancel</button>';
            html += '<button class="style-ref-btn style-ref-btn-apply" onclick="app.applyStyleReference()"' + (state.styleReference ? '' : ' disabled') + '>Apply</button>';
            html += '</div>';

            html += '</div>'; // modal
            html += '</div>'; // overlay

            return html;
        }

        // Render Character Reference Modal (PRO Feature)
        function renderCharacterReferenceModal() {
            if (!state.characterReferenceModalOpen) return '';

            var modelCaps = getModelCapabilities(state.selectedModel);

            var html = '<div class="style-ref-modal-overlay" onclick="app.closeCharacterReference()">';
            html += '<div class="style-ref-modal" onclick="event.stopPropagation()">';

            // Header
            html += '<div class="style-ref-modal-header">';
            html += '<div class="style-ref-modal-title"><span>ðŸ‘¤</span> Character Reference</div>';
            html += '<button class="style-ref-modal-close" onclick="app.closeCharacterReference()">Ã—</button>';
            html += '</div>';

            // Model compatibility warning
            if (!modelCaps.supportsReferenceImages) {
                html += '<div class="style-ref-warning">';
                html += '<span class="warning-icon">âš ï¸</span>';
                html += '<div class="warning-content">';
                html += '<strong>' + getModelDisplayName(state.selectedModel) + '</strong> doesn\'t support character references.<br>';
                html += '<button class="switch-model-btn" onclick="app.switchToImagen3()">Switch to Nano Banana Pro</button>';
                html += '</div>';
                html += '</div>';
            }

            // Body
            html += '<div class="style-ref-modal-body">';

            // Hidden file input
            html += '<input type="file" id="character-ref-file-input" class="hidden-file-input" accept="image/*" onchange="app.handleCharacterRefFile(this.files[0])">';

            if (state.characterReference) {
                // Show preview
                var imgSrc = state.characterReference.type === 'file' ? state.characterReference.dataUrl : state.characterReference.url;
                html += '<div class="style-ref-preview">';
                html += '<img src="' + imgSrc + '" alt="Character reference preview">';
                html += '<div class="style-ref-preview-actions">';
                html += '<button class="style-ref-preview-btn" onclick="app.triggerCharacterRefUpload()" title="Change image">ðŸ”„</button>';
                html += '<button class="style-ref-preview-btn remove" onclick="app.removeCharacterReference()" title="Remove">ðŸ—‘ï¸</button>';
                html += '</div>';
                html += '</div>';
            } else {
                // Show upload zone
                html += '<div class="style-ref-upload-zone" onclick="app.triggerCharacterRefUpload()" ';
                html += 'ondragover="event.preventDefault(); this.classList.add(\'dragover\')" ';
                html += 'ondragleave="this.classList.remove(\'dragover\')" ';
                html += 'ondrop="event.preventDefault(); this.classList.remove(\'dragover\'); app.handleCharacterRefFile(event.dataTransfer.files[0])">';
                html += '<div class="style-ref-upload-icon">ðŸ‘¤</div>';
                html += '<div class="style-ref-upload-title">Upload a face reference image</div>';
                html += '<div class="style-ref-upload-hint">Use a clear photo with visible face â€¢ PNG, JPG â€¢ Max 10MB</div>';
                html += '</div>';

                // Hint section
                html += '<div class="style-ref-url-section">';
                html += '<label class="style-ref-url-label">ðŸ’¡ Pro Tip</label>';
                html += '<p style="color: rgba(255,255,255,0.6); font-size: 0.85rem; margin: 0;">Use a high-quality photo with good lighting for best results. The face should be clearly visible and unobstructed.</p>';
                html += '</div>';
            }

            html += '</div>'; // body

            // Footer
            html += '<div class="style-ref-modal-footer">';
            html += '<button class="style-ref-btn style-ref-btn-cancel" onclick="app.closeCharacterReference()">Cancel</button>';
            html += '<button class="style-ref-btn style-ref-btn-apply" onclick="app.applyCharacterReference()"' + (state.characterReference ? '' : ' disabled') + '>Apply</button>';
            html += '</div>';

            html += '</div>'; // modal
            html += '</div>'; // overlay

            return html;
        }

        // Render Image Upload Modal (PRO Feature)
        function renderImageUploadModal() {
            if (!state.imageUploadModalOpen) return '';

            var html = '<div class="style-ref-modal-overlay" onclick="app.closeImageUpload()">';
            html += '<div class="style-ref-modal" onclick="event.stopPropagation()">';

            // Header
            html += '<div class="style-ref-modal-header">';
            html += '<div class="style-ref-modal-title"><span>ðŸ“¤</span> Upload Image</div>';
            html += '<button class="style-ref-modal-close" onclick="app.closeImageUpload()">Ã—</button>';
            html += '</div>';

            // Body
            html += '<div class="style-ref-modal-body">';

            // Hidden file input
            html += '<input type="file" id="upload-image-file-input" class="hidden-file-input" accept="image/*" onchange="app.handleUploadedImageFile(this.files[0])">';

            if (state.uploadedImage) {
                // Show preview
                var imgSrc = state.uploadedImage.type === 'file' ? state.uploadedImage.dataUrl : state.uploadedImage.url;
                html += '<div class="style-ref-preview">';
                html += '<img src="' + imgSrc + '" alt="Uploaded image preview">';
                html += '<div class="style-ref-preview-actions">';
                html += '<button class="style-ref-preview-btn" onclick="app.triggerImageUpload()" title="Change image">ðŸ”„</button>';
                html += '<button class="style-ref-preview-btn remove" onclick="app.removeUploadedImage()" title="Remove">ðŸ—‘ï¸</button>';
                html += '</div>';
                html += '</div>';
            } else {
                // Show upload zone
                html += '<div class="style-ref-upload-zone" onclick="app.triggerImageUpload()" ';
                html += 'ondragover="event.preventDefault(); this.classList.add(\'dragover\')" ';
                html += 'ondragleave="this.classList.remove(\'dragover\')" ';
                html += 'ondrop="event.preventDefault(); this.classList.remove(\'dragover\'); app.handleUploadedImageFile(event.dataTransfer.files[0])">';
                html += '<div class="style-ref-upload-icon">ðŸ“¤</div>';
                html += '<div class="style-ref-upload-title">Drop an image here or click to upload</div>';
                html += '<div class="style-ref-upload-hint">Use as a starting point for AI transformation â€¢ PNG, JPG â€¢ Max 10MB</div>';
                html += '</div>';

                // Hint section
                html += '<div class="style-ref-url-section">';
                html += '<label class="style-ref-url-label">ðŸŽ¨ Use Cases</label>';
                html += '<p style="color: rgba(255,255,255,0.6); font-size: 0.85rem; margin: 0;">Transform photos, create variations, enhance images, or use as composition reference.</p>';
                html += '</div>';
            }

            html += '</div>'; // body

            // Footer
            html += '<div class="style-ref-modal-footer">';
            html += '<button class="style-ref-btn style-ref-btn-cancel" onclick="app.closeImageUpload()">Cancel</button>';
            html += '<button class="style-ref-btn style-ref-btn-apply" onclick="app.applyUploadedImage()"' + (state.uploadedImage ? '' : ' disabled') + '>Apply</button>';
            html += '</div>';

            html += '</div>'; // modal
            html += '</div>'; // overlay

            return html;
        }

        // Render Share to Gallery Dialog
        function renderShareDialog() {
            if (!state.shareDialogOpen || !state.shareDialogItem) return '';

            var item = state.shareDialogItem;
            var imageUrl = item.imageUrl || (item.images && item.images[0] ? item.images[0].url : '');
            var promptPreview = item.prompt || 'No prompt';
            var userPlan = state.tokens.plan || 'free';
            var isPremium = ['lite', 'pro', 'business', 'enterprise'].includes(userPlan);

            var html = '<div class="share-dialog-overlay" onclick="app.closeShareDialog()">';
            html += '<div class="share-dialog" onclick="event.stopPropagation()">';

            // Header
            html += '<div class="share-dialog-header">';
            html += '<div class="share-dialog-title">ðŸ“¤ Share to Community</div>';
            html += '<div class="share-dialog-subtitle">Choose how you want to share your creation</div>';
            html += '</div>';

            // Body
            html += '<div class="share-dialog-body">';

            // Preview
            html += '<div class="share-dialog-preview">';
            html += '<img src="' + imageUrl + '" alt="Preview" class="share-dialog-preview-image" />';
            html += '<div class="share-dialog-preview-info">';
            html += '<div class="share-dialog-preview-prompt">' + utils.escapeHtml(promptPreview) + '</div>';
            html += '</div>';
            html += '</div>';

            // Public Option
            var publicSelected = !state.shareDialogPrivate;
            html += '<div class="share-dialog-option' + (publicSelected ? ' selected' : '') + '" onclick="app.setSharePrivate(false)">';
            html += '<div class="share-dialog-option-header">';
            html += '<div class="share-dialog-option-title">';
            html += '<span>ðŸŒ</span> Public';
            html += '</div>';
            if (publicSelected) {
                html += '<span style="color: #22c55e;">âœ“</span>';
            }
            html += '</div>';
            html += '<div class="share-dialog-option-desc">Everyone can see your image and copy your prompt for free. Great for sharing inspiration!</div>';
            html += '</div>';

            // Private Option
            var privateSelected = state.shareDialogPrivate;
            html += '<div class="share-dialog-option' + (privateSelected ? ' selected' : '') + (!isPremium ? ' locked' : '') + '" onclick="app.setSharePrivate(true)">';
            html += '<div class="share-dialog-option-header">';
            html += '<div class="share-dialog-option-title">';
            html += '<span>ðŸ”’</span> Private Prompt';
            if (!isPremium) {
                html += '<span class="share-dialog-option-badge">PRO</span>';
            }
            html += '</div>';
            if (privateSelected && isPremium) {
                html += '<span style="color: #22c55e;">âœ“</span>';
            }
            html += '</div>';
            html += '<div class="share-dialog-option-desc">Image is visible but prompt is hidden. Others must pay tokens to unlock your prompt.</div>';

            // Price input (only shown when private is selected and user is premium)
            if (privateSelected && isPremium) {
                html += '<div class="share-dialog-price-input">';
                html += '<div class="share-dialog-price-label">Prompt price:</div>';
                html += '<div class="share-dialog-price-field">';
                html += '<input type="number" min="1" max="100" value="' + state.shareDialogPrice + '" onchange="app.setSharePrice(this.value)" onclick="event.stopPropagation()" />';
                html += '<span style="color: rgba(255,255,255,0.5);">tokens</span>';
                html += '</div>';
                html += '</div>';
            }

            html += '</div>'; // private option

            // Upgrade hint for free users
            if (!isPremium) {
                html += '<div class="share-dialog-upgrade-hint">';
                html += '<span>ðŸ’¡</span> <a href="#" onclick="event.preventDefault(); app.upgradeToPremium();">Upgrade to Pro</a> to unlock private prompts and earn tokens from your creations!';
                html += '</div>';
            }

            html += '</div>'; // body

            // Footer
            html += '<div class="share-dialog-footer">';
            html += '<button class="share-dialog-btn share-dialog-btn-cancel" onclick="app.closeShareDialog()">Cancel</button>';
            html += '<button class="share-dialog-btn share-dialog-btn-share" onclick="app.confirmShare()"' + (state.shareDialogSharing ? ' disabled' : '') + '>';
            if (state.shareDialogSharing) {
                html += '<span class="loading-spinner" style="width: 16px; height: 16px;"></span> Sharing...';
            } else {
                html += '<span>ðŸ“¤</span> Share';
            }
            html += '</button>';
            html += '</div>';

            html += '</div>'; // dialog
            html += '</div>'; // overlay

            return html;
        }

        // Render Template Variables Modal
        function renderTemplateVariablesModal() {
            if (!state.templateVariablesModalOpen || !state.pendingTemplateForVariables) return '';

            var template = state.pendingTemplateForVariables.template;
            var variables = state.detectedVariables;

            var html = '<div class="template-vars-modal-overlay" onclick="app.cancelTemplateVariables()">';
            html += '<div class="template-vars-modal" onclick="event.stopPropagation()">';

            // Header
            html += '<div class="template-vars-header">';
            html += '<div class="template-vars-title">ðŸ“ Fill in Template Variables</div>';
            html += '<div class="template-vars-subtitle">Customize the template by providing values for each variable</div>';
            html += '</div>';

            // Body
            html += '<div class="template-vars-body">';

            // Preview with highlighted variables
            html += '<div class="template-vars-preview">';
            html += '<div class="template-vars-preview-label">Template Preview</div>';
            var highlightedPrompt = utils.escapeHtml(template.prompt);
            for (var v = 0; v < variables.length; v++) {
                var varPattern = new RegExp('\\{\\{' + variables[v].replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\}\\}', 'g');
                highlightedPrompt = highlightedPrompt.replace(varPattern, '<span class="var-highlight">{{' + variables[v] + '}}</span>');
            }
            html += '<div class="template-vars-preview-prompt">' + highlightedPrompt + '</div>';
            html += '</div>';

            // Variable input fields
            for (var i = 0; i < variables.length; i++) {
                var varName = variables[i];
                var currentValue = state.templateVariables[varName] || '';
                var placeholder = getVariablePlaceholder(varName);

                html += '<div class="template-var-field">';
                html += '<label class="template-var-label">';
                html += '<code>{{' + utils.escapeHtml(varName) + '}}</code>';
                html += '<span>' + formatVariableName(varName) + '</span>';
                html += '</label>';
                html += '<input type="text" class="template-var-input" placeholder="' + placeholder + '" value="' + utils.escapeHtml(currentValue) + '" onchange="app.updateTemplateVariable(\'' + utils.escapeHtml(varName) + '\', this.value)" onkeydown="if(event.key===\'Enter\'){event.preventDefault();app.confirmTemplateVariables();}else if(event.key===\'Escape\'){app.cancelTemplateVariables();}" />';
                html += '</div>';
            }

            html += '</div>'; // body

            // Footer
            html += '<div class="template-vars-footer">';
            html += '<button class="template-vars-btn template-vars-btn-cancel" onclick="app.cancelTemplateVariables()">Cancel</button>';
            html += '<button class="template-vars-btn template-vars-btn-apply" onclick="app.confirmTemplateVariables()">Apply Template</button>';
            html += '</div>';

            html += '</div>'; // modal
            html += '</div>'; // overlay

            return html;
        }

        // Helper function to format variable name for display
        function formatVariableName(varName) {
            // Convert snake_case or camelCase to Title Case
            return varName
                .replace(/_/g, ' ')
                .replace(/([A-Z])/g, ' $1')
                .replace(/\s+/g, ' ')
                .trim()
                .split(' ')
                .map(function(word) { return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase(); })
                .join(' ');
        }

        // Helper function to get placeholder suggestions based on variable name
        function getVariablePlaceholder(varName) {
            var lowerName = varName.toLowerCase();
            if (lowerName.includes('subject') || lowerName.includes('person') || lowerName.includes('character')) {
                return 'e.g., a young woman, a businessman, a superhero';
            }
            if (lowerName.includes('style') || lowerName.includes('art')) {
                return 'e.g., realistic, anime, watercolor, digital art';
            }
            if (lowerName.includes('mood') || lowerName.includes('emotion') || lowerName.includes('feeling')) {
                return 'e.g., happy, mysterious, dramatic, peaceful';
            }
            if (lowerName.includes('color') || lowerName.includes('colour')) {
                return 'e.g., blue, warm tones, vibrant, monochrome';
            }
            if (lowerName.includes('location') || lowerName.includes('place') || lowerName.includes('scene') || lowerName.includes('background')) {
                return 'e.g., forest, city street, beach at sunset';
            }
            if (lowerName.includes('action') || lowerName.includes('activity') || lowerName.includes('doing')) {
                return 'e.g., running, reading a book, looking at camera';
            }
            if (lowerName.includes('object') || lowerName.includes('item') || lowerName.includes('thing')) {
                return 'e.g., vintage camera, glowing orb, treasure chest';
            }
            if (lowerName.includes('time') || lowerName.includes('period')) {
                return 'e.g., sunset, nighttime, medieval era';
            }
            if (lowerName.includes('weather')) {
                return 'e.g., rainy, sunny, foggy, stormy';
            }
            if (lowerName.includes('lighting') || lowerName.includes('light')) {
                return 'e.g., dramatic lighting, soft diffused, golden hour';
            }
            return 'Enter a value...';
        }

        // Render Premium Feature Modal
        function renderPremiumModal() {
            if (!state.premiumModalOpen) return '';

            var featureName = state.premiumModalFeature || 'Premium Feature';

            // Feature-specific content
            var featureInfo = {
                'Character Reference': {
                    icon: 'ðŸ‘¤',
                    description: 'Generate images with consistent character faces',
                    features: [
                        { icon: 'ðŸŽ­', text: 'Maintain consistent faces across generations' },
                        { icon: 'ðŸ“¸', text: 'Upload reference photos of people' },
                        { icon: 'ðŸŽ¨', text: 'Perfect for character-based content' }
                    ]
                },
                'Image Upload': {
                    icon: 'ðŸ“¤',
                    description: 'Use your own images as generation input',
                    features: [
                        { icon: 'ðŸ–¼ï¸', text: 'Upload any image as a starting point' },
                        { icon: 'âœ¨', text: 'Transform and enhance your photos' },
                        { icon: 'ðŸ”„', text: 'Create variations of existing images' }
                    ]
                },
                'Private Prompts': {
                    icon: 'ðŸ”’',
                    description: 'Protect and monetize your prompts',
                    features: [
                        { icon: 'ðŸ’°', text: 'Earn tokens when others purchase your prompts' },
                        { icon: 'ðŸ”', text: 'Keep your creative prompts private' },
                        { icon: 'ðŸŒŸ', text: 'Share images while protecting your techniques' }
                    ]
                }
            };

            var info = featureInfo[featureName] || {
                icon: 'â­',
                description: 'Unlock advanced features',
                features: [
                    { icon: 'âœ¨', text: 'Access premium generation models' },
                    { icon: 'ðŸš€', text: 'Faster generation times' },
                    { icon: 'ðŸ’Ž', text: 'More tokens per month' }
                ]
            };

            var html = '<div class="premium-modal-overlay" onclick="app.closePremiumModal()">';
            html += '<div class="premium-modal" onclick="event.stopPropagation()">';

            // Header
            html += '<div class="premium-modal-header">';
            html += '<div class="premium-modal-icon">' + info.icon + '</div>';
            html += '<div class="premium-modal-title">' + utils.escapeHtml(featureName) + '</div>';
            html += '<div class="premium-modal-subtitle">' + info.description + '</div>';
            html += '</div>';

            // Body
            html += '<div class="premium-modal-body">';
            html += '<div class="premium-modal-features">';
            for (var i = 0; i < info.features.length; i++) {
                var feature = info.features[i];
                html += '<div class="premium-modal-feature">';
                html += '<div class="premium-modal-feature-icon">' + feature.icon + '</div>';
                html += '<div class="premium-modal-feature-text">' + feature.text + '</div>';
                html += '</div>';
            }
            html += '</div>';
            html += '</div>';

            // Footer
            html += '<div class="premium-modal-footer">';
            html += '<button class="premium-modal-btn-upgrade" onclick="app.upgradeToPremium()">Upgrade to Pro</button>';
            html += '<button class="premium-modal-btn-close" onclick="app.closePremiumModal()">Maybe Later</button>';
            html += '</div>';

            html += '</div>'; // modal
            html += '</div>'; // overlay

            return html;
        }

        // Render Draft Notification Banner
        function renderDraftNotification() {
            if (!state.showDraftNotification) return '';

            var draft = utils.loadDraft();
            if (!draft) return '';

            var timeAgo = utils.formatDraftTime(draft.savedAt);
            var promptPreview = draft.prompt.length > 50 ? draft.prompt.substring(0, 50) + '...' : draft.prompt;

            var html = '<div class="draft-notification">';
            html += '<span class="draft-notification-icon">ðŸ“</span>';
            html += '<div class="draft-notification-content">';
            html += '<div class="draft-notification-title">Unsaved draft found</div>';
            html += '<div class="draft-notification-subtitle">Saved ' + timeAgo + ': "' + utils.escapeHtml(promptPreview) + '"</div>';
            html += '</div>';
            html += '<div class="draft-notification-actions">';
            html += '<button class="draft-notification-btn draft-notification-btn-dismiss" onclick="app.dismissDraft()">Dismiss</button>';
            html += '<button class="draft-notification-btn draft-notification-btn-restore" onclick="app.restoreDraft(); state.showDraftNotification = false; render();">Restore</button>';
            html += '</div>';
            html += '</div>';

            return html;
        }

        // Render Floating Generate Button (for mobile/tablet when scrolled)
        function renderFloatingGenerateButton() {
            var cost = app.calculateCost();
            var canGenerate = state.prompt.trim().length > 0 && state.tokens.balance >= cost && !state.generating;

            var html = '<div class="floating-generate-container' + (state.showFloatingButton ? ' visible' : '') + '" id="floating-generate-container">';

            // Settings popover
            html += '<div class="floating-settings-popover' + (state.floatingSettingsOpen ? ' visible' : '') + '">';
            html += '<div class="floating-settings-header">';
            html += '<span class="floating-settings-title">âš™ï¸ Settings</span>';
            html += '<button class="floating-settings-close" onclick="app.toggleFloatingSettings()">âœ•</button>';
            html += '</div>';

            // Aspect Ratio
            html += '<div class="floating-settings-row">';
            html += '<span class="floating-settings-label">Aspect Ratio</span>';
            html += '<select class="floating-settings-select" onchange="app.setAspectRatio(this.value)">';
            var ratios = ['1:1', '16:9', '9:16', '4:3', '3:4'];
            for (var r = 0; r < ratios.length; r++) {
                var ratio = ratios[r];
                var selected = state.aspectRatio === ratio ? ' selected' : '';
                html += '<option value="' + ratio + '"' + selected + '>' + ratio + '</option>';
            }
            html += '</select>';
            html += '</div>';

            // Quality
            html += '<div class="floating-settings-row">';
            html += '<span class="floating-settings-label">Quality</span>';
            html += '<select class="floating-settings-select" onchange="app.setQuality(this.value)">';
            var qualities = [
                { key: 'basic', name: 'Basic (1ðŸª™)' },
                { key: 'hd', name: 'HD (2ðŸª™)' },
                { key: 'ultra', name: 'Ultra (4ðŸª™)' }
            ];
            for (var qi = 0; qi < qualities.length; qi++) {
                var qual = qualities[qi];
                var selected = state.quality === qual.key ? ' selected' : '';
                html += '<option value="' + qual.key + '"' + selected + '>' + qual.name + '</option>';
            }
            html += '</select>';
            html += '</div>';

            // Quantity
            html += '<div class="floating-settings-row">';
            html += '<span class="floating-settings-label">Quantity</span>';
            html += '<div class="floating-quantity-control">';
            html += '<button class="floating-quantity-btn" onclick="app.decrementQuantity()"' + (state.quantity <= 1 ? ' disabled' : '') + '>âˆ’</button>';
            html += '<span class="floating-quantity-value">' + state.quantity + '</span>';
            html += '<button class="floating-quantity-btn" onclick="app.incrementQuantity()"' + (state.quantity >= 4 ? ' disabled' : '') + '>+</button>';
            html += '</div>';
            html += '</div>';

            html += '</div>'; // popover

            // Settings toggle button
            html += '<button class="floating-settings-toggle' + (state.floatingSettingsOpen ? ' active' : '') + '" onclick="app.toggleFloatingSettings()" title="Settings">âš™ï¸</button>';

            // Main generate button
            html += '<button class="floating-generate-btn" onclick="app.generateImage()"' + (canGenerate ? '' : ' disabled') + '>';
            if (state.generating) {
                html += '<span class="animate-spin">â³</span>';
                html += '<span>Generating...</span>';
            } else {
                html += '<span class="sparkle">âœ¨</span>';
                html += '<span>Generate</span>';
                html += '<span class="floating-btn-cost">ðŸª™ ' + cost + '</span>';
            }
            html += '</button>';

            html += '</div>'; // container

            return html;
        }

        function getToolEmoji(toolKey) {
            var emojis = {
                'realtimeCanvas': '##',
                'realtimeGen': '##',
                'motion': '##',
                'imageCreation': '##',
                'upscaler': '##',
                'canvasEditor': '##'
            };
            return emojis[toolKey] || '##';
        }

        // Featured section
        function renderFeaturedSection() {
            var html = '<div class="mb-8 fade-in">';
            html += '<h2 class="section-header"><span class="gradient-text">Featured</span></h2>';

            html += '<div class="featured-grid">';

            for (var i = 0; i < featuredCards.length; i++) {
                var card = featuredCards[i];
                var badgeClass = card.badgeColor === 'green' ? 'green' :
                                 card.badgeColor === 'blue' ? 'blue' :
                                 card.badgeColor === 'purple' ? 'purple' : '';

                html += '<div class="featured-card">';
                html += '<img src="' + card.image + '" alt="' + utils.escapeHtml(card.title) + '" class="featured-card-image" loading="lazy" />';
                html += '<div class="featured-card-overlay">';
                html += '<span class="featured-card-badge ' + badgeClass + '">' + utils.escapeHtml(card.badge) + '</span>';
                html += '<div class="featured-card-title">' + utils.escapeHtml(card.title) + '</div>';
                html += '<div class="featured-card-subtitle">' + utils.escapeHtml(card.subtitle) + '</div>';
                html += '</div>';
                html += '</div>';
            }

            html += '</div>'; // featured-grid
            html += '</div>'; // section
            return html;
        }

        // Community gallery section
        function renderGallerySection() {
            var html = '<div class="mb-8 fade-in">';
            html += '<h2 class="section-header"><span class="gradient-text">Community</span> Creations</h2>';

            // Filter row
            html += '<div class="filter-row">';

            // Sort/type filters
            html += '<div class="filter-group">';
            html += '<button class="filter-btn active-green" onclick="app.setGallerySortBy(\'trending\')">';
            html += '<span>##</span> Trending <span>â–¼</span>';
            html += '</button>';

            var typeFilters = [
                { key: 'all', name: 'All', icon: '##' },
                { key: 'upscaler', name: 'Upscaler', icon: '##' },
                { key: 'motion', name: 'Motion', icon: '##' }
            ];

            for (var i = 0; i < typeFilters.length; i++) {
                var filter = typeFilters[i];
                var isActive = state.galleryFilter === filter.key;
                html += '<button class="filter-btn' + (isActive ? ' active' : '') + '" onclick="app.setGalleryFilter(\'' + filter.key + '\')">';
                html += '<span>' + filter.icon + '</span> ' + filter.name;
                html += '</button>';
            }
            html += '</div>';

            html += '<div class="filter-divider"></div>';

            // Category pills
            html += '<div class="category-pills">';
            for (var i = 0; i < categoriesConfig.length; i++) {
                var cat = categoriesConfig[i];
                var isActive = state.galleryCategory === cat.key;
                html += '<button class="category-pill' + (isActive ? ' active' : '') + '" onclick="app.setGalleryCategory(\'' + cat.key + '\')">';
                html += '<span>' + cat.icon + '</span> ' + cat.name;
                html += '</button>';
            }
            html += '</div>';

            html += '</div>'; // filter-row

            // Gallery grid
            html += '<div class="gallery-grid">';

            for (var i = 0; i < placeholderGallery.length; i++) {
                var item = placeholderGallery[i];
                html += '<div class="gallery-item">';
                html += '<img src="' + item.image + '" alt="' + utils.escapeHtml(item.prompt) + '" class="gallery-item-image" loading="lazy" />';
                html += '<div class="gallery-item-overlay">';
                html += '<div class="gallery-item-info">';
                html += '<p class="gallery-item-prompt">' + utils.escapeHtml(item.prompt) + '</p>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
            }

            html += '</div>'; // gallery-grid
            html += '</div>'; // section
            return html;
        }

        /* ==========================================
           4.9 AUTHENTICATION & INITIALIZATION
           ========================================== */

        // Check user access
        function checkAccess() {
            auth.onAuthStateChanged(function(user) {
                if (!user) {
                    // Not logged in - redirect to dashboard
                    window.location.href = 'https://ytseo.siteuo.com/video-optimizer';
                    return;
                }

                state.user = user;

                // Get user profile
                db.collection('users').doc(user.uid).get()
                    .then(function(doc) {
                        if (doc.exists) {
                            state.profile = doc.data();
                            // Check if user has PRO or Enterprise subscription for premium features
                            var userPlan = (state.profile.subscription && state.profile.subscription.plan) || 'free';
                            state.hasPremiumAccess = (userPlan === 'pro' || userPlan === 'enterprise');
                            // Update tokens plan to match subscription
                            state.tokens.plan = userPlan;
                            console.log('User plan:', userPlan, '| Premium access:', state.hasPremiumAccess);
                        }
                        state.currentView = 'studio';
                        render();

                        // Load creative tokens and history
                        app.loadTokens();
                        app.loadHistory();
                    })
                    .catch(function(e) {
                        console.error('Error fetching profile:', e);
                        state.currentView = 'studio';
                        render();
                    });
            });
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize image observer for lazy loading
            initImageObserver();

            render();
            checkAccess();

            // Check for saved draft on load
            if (utils.hasDraft()) {
                state.showDraftNotification = true;
                render();
            }

            // Auto-save draft every 5 seconds when prompt has content
            setInterval(function() {
                if (state.prompt && state.prompt.trim().length > 0) {
                    utils.saveDraft();
                }
            }, 5000);

            // Scroll listener for floating button visibility
            window.addEventListener('scroll', function() {
                app.updateFloatingButtonVisibility();
            }, { passive: true });

            // Resize listener for floating button visibility
            window.addEventListener('resize', function() {
                app.updateFloatingButtonVisibility();
            });

            // ESC key to close modals and dropdowns
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    if (state.promptModalOpen) {
                        app.closePromptModal();
                    }
                    if (state.floatingSettingsOpen) {
                        state.floatingSettingsOpen = false;
                        render();
                    }
                    if (state.confirmDialogOpen) {
                        app.cancelTemplateConfirm();
                    }
                    if (state.imageDetailModalOpen) {
                        app.closeImageDetail();
                    }
                    if (state.styleReferenceModalOpen) {
                        app.closeStyleReference();
                    }
                    if (state.characterReferenceModalOpen) {
                        app.closeCharacterReference();
                    }
                    if (state.imageUploadModalOpen) {
                        app.closeImageUpload();
                    }
                    if (state.premiumModalOpen) {
                        app.closePremiumModal();
                    }
                    if (state.variableInputOpen) {
                        app.cancelVariableInput();
                    }
                    if (state.modelDropdownOpen) {
                        state.modelDropdownOpen = false;
                        render();
                    }
                }
            });

            // Click outside to close dropdowns
            document.addEventListener('click', function(e) {
                // Close model dropdown if clicking outside
                if (state.modelDropdownOpen) {
                    var dropdownWrapper = document.querySelector('.model-dropdown-wrapper');
                    if (dropdownWrapper && !dropdownWrapper.contains(e.target)) {
                        state.modelDropdownOpen = false;
                        render();
                    }
                }
            });
        });
    </script>
</body>
</html>
