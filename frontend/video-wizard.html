<!-- ================================================================
     YOUTUBE VIDEO OPTIMIZER - VIDEO-TO-SHORTS WIZARD
     ================================================================

     Structure:
     - SECTION 1: External Dependencies (CDN)
     - SECTION 2: Styles (CSS)
     - SECTION 3: HTML Container
     - SECTION 4: Scripts (JavaScript)

     Wizard Steps:
     1. Video Input - URL paste or drag/drop upload
     2. AI Analysis - Processing with progress
     3. Clip Selection - Grid with virality scores
     4. Customization Studio - Captions, reframe, audio
     5. SEO & Thumbnails - Title, description, tags, 2 thumbnails
     6. Export & Download - Batch export options

     Access: All authenticated users (with token system)

     Main Dashboard URL: https://ytseo.siteuo.com/video-optimizer

     Last Updated: 2024
     ================================================================ -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Video-to-Shorts Wizard - YouTube Video Optimizer</title>

    <!-- PWA Manifest & Theme -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"YouTube Video Optimizer","short_name":"YT Optimizer","description":"AI-powered YouTube video optimization and campaign analysis platform","start_url":"/main-dashboard.html","display":"standalone","background_color":"#0f172a","theme_color":"#7c3aed","orientation":"portrait-primary","icons":[{"src":"https://ytseo.siteuo.com/icon-192.png","sizes":"192x192","type":"image/png","purpose":"any maskable"},{"src":"https://ytseo.siteuo.com/icon-512.png","sizes":"512x512","type":"image/png","purpose":"any maskable"}],"categories":["productivity","business","utilities"],"lang":"en","dir":"ltr"}'>
    <meta name="theme-color" content="#7c3aed">

    <!-- ============================================
         SECTION 1: EXTERNAL DEPENDENCIES
         ============================================ -->

    <!-- 1.1 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 1.2 Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-functions-compat.js"></script>

    <!-- 1.3 PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- ============================================
         SECTION 2: STYLES
         ============================================ -->
    <style>
        /* ------------------------------------------
           2.1 BASE & RESET
           ------------------------------------------ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }

        body {
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 1rem;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            color: white;
        }

        #app-root {
            width: 100%;
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }

        /* ------------------------------------------
           2.2 ANIMATIONS
           ------------------------------------------ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes gradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(236, 72, 153, 0.3); }
            50% { box-shadow: 0 0 40px rgba(236, 72, 153, 0.6); }
        }

        @keyframes borderGlow {
            0%, 100% { border-color: rgba(236, 72, 153, 0.3); }
            50% { border-color: rgba(236, 72, 153, 0.8); }
        }

        @keyframes progressPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        .animate-pulse {
            animation: pulse 2s ease-in-out infinite;
        }

        .animate-float {
            animation: float 3s ease-in-out infinite;
        }

        .animate-glow {
            animation: glow 2s ease-in-out infinite;
        }

        .animate-bounce {
            animation: bounce 1s ease-in-out infinite;
        }

        /* ------------------------------------------
           2.3 WIZARD LAYOUT
           ------------------------------------------ */
        .wizard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
            min-height: 100vh;
        }

        .wizard-header {
            text-align: center;
            padding: 1.5rem 1rem;
            margin-bottom: 1rem;
        }

        .wizard-title {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #ec4899 0%, #f97316 50%, #eab308 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .wizard-subtitle {
            color: rgba(255, 255, 255, 0.6);
            font-size: 1rem;
        }

        /* ------------------------------------------
           2.4 STEPPER
           ------------------------------------------ */
        .wizard-stepper {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            padding: 1.5rem 1rem;
            margin-bottom: 2rem;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .wizard-stepper::-webkit-scrollbar {
            display: none;
        }

        .wizard-step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .wizard-step:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .wizard-step.active {
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.2) 0%, rgba(249, 115, 22, 0.2) 100%);
            border-color: rgba(236, 72, 153, 0.5);
            box-shadow: 0 0 20px rgba(236, 72, 153, 0.2);
        }

        .wizard-step.completed {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .wizard-step.completed .step-number {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .wizard-step.active .step-number {
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
        }

        .step-label {
            font-size: 0.85rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
        }

        .wizard-step.active .step-label {
            color: white;
        }

        .wizard-step.completed .step-label {
            color: #10b981;
        }

        .step-connector {
            width: 30px;
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }

        .step-connector.completed {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
        }

        @media (max-width: 900px) {
            .wizard-step {
                padding: 0.5rem 0.75rem;
            }
            .step-label {
                display: none;
            }
            .step-connector {
                width: 20px;
            }
        }

        /* ------------------------------------------
           2.5 WIZARD CONTENT AREA
           ------------------------------------------ */
        .wizard-content {
            background: linear-gradient(145deg, rgba(30, 30, 50, 0.6) 0%, rgba(20, 20, 35, 0.8) 100%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1.5rem;
            padding: 2rem;
            min-height: 500px;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.4s ease-out;
        }

        @media (max-width: 768px) {
            .wizard-content {
                padding: 1.25rem;
                border-radius: 1rem;
            }
        }

        /* ------------------------------------------
           2.6 VIDEO DROPZONE (Step 1)
           ------------------------------------------ */
        .video-dropzone {
            border: 2px dashed rgba(236, 72, 153, 0.3);
            border-radius: 1.5rem;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(236, 72, 153, 0.03);
            position: relative;
            overflow: hidden;
        }

        .video-dropzone::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.1) 0%, rgba(249, 115, 22, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none; /* Allow clicks to pass through to input */
            z-index: 0;
        }

        .video-dropzone:hover {
            border-color: rgba(236, 72, 153, 0.6);
            background: rgba(236, 72, 153, 0.05);
        }

        .video-dropzone:hover::before {
            opacity: 1;
        }

        .video-dropzone.dragover {
            border-color: #ec4899;
            background: rgba(236, 72, 153, 0.1);
            transform: scale(1.01);
            animation: borderGlow 1s ease-in-out infinite;
        }

        .dropzone-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: float 3s ease-in-out infinite;
            position: relative;
            z-index: 1;
        }

        .dropzone-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }

        .dropzone-subtitle {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.95rem;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 1;
        }

        .url-input-container {
            display: flex;
            gap: 0.75rem;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            z-index: 10; /* Ensure input is above dropzone overlay */
        }

        .url-input {
            flex: 1;
            padding: 1rem 1.25rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.75rem;
            color: white;
            font-size: 1rem;
            outline: none;
            transition: all 0.2s ease;
        }

        .url-input:focus {
            border-color: rgba(236, 72, 153, 0.5);
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
        }

        .url-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        @media (max-width: 600px) {
            .url-input-container {
                flex-direction: column;
            }
        }

        /* Video Preview */
        .video-preview-container {
            margin-top: 2rem;
            padding: 1.5rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .video-preview-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .video-thumbnail {
            width: 160px;
            height: 90px;
            border-radius: 0.5rem;
            object-fit: cover;
            background: rgba(255, 255, 255, 0.05);
        }

        .video-details h4 {
            font-size: 1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.25rem;
        }

        .video-details p {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
        }

        /* Options Panel */
        .options-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .option-checkbox {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option-checkbox:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .option-checkbox.checked {
            background: rgba(236, 72, 153, 0.1);
            border-color: rgba(236, 72, 153, 0.3);
        }

        .option-checkbox input {
            width: 20px;
            height: 20px;
            accent-color: #ec4899;
        }

        .option-checkbox span {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        /* ------------------------------------------
           2.7 PROGRESS/ANALYSIS (Step 2)
           ------------------------------------------ */
        .analysis-container {
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
        }

        .analysis-video-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 1rem;
        }

        .analysis-video-info img {
            width: 120px;
            height: 68px;
            border-radius: 0.5rem;
            object-fit: cover;
        }

        .analysis-video-info .video-title {
            font-size: 1rem;
            font-weight: 600;
            color: white;
            text-align: left;
        }

        .analysis-video-info .video-duration {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
            text-align: left;
        }

        .progress-container {
            margin-bottom: 2.5rem;
        }

        .progress-bar-bg {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #ec4899 0%, #f97316 50%, #eab308 100%);
            background-size: 200% 100%;
            border-radius: 6px;
            transition: width 0.5s ease;
            animation: gradientFlow 2s ease infinite;
        }

        .progress-percentage {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
        }

        .analysis-steps {
            text-align: left;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 1rem;
        }

        .analysis-step {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.875rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .analysis-step:last-child {
            border-bottom: none;
        }

        .analysis-step-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .analysis-step.done .analysis-step-icon {
            background: rgba(16, 185, 129, 0.2);
        }

        .analysis-step.processing .analysis-step-icon {
            background: rgba(236, 72, 153, 0.2);
            animation: pulse 1.5s ease-in-out infinite;
        }

        .analysis-step.pending .analysis-step-icon {
            background: rgba(255, 255, 255, 0.05);
        }

        .analysis-step-text {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .analysis-step.done .analysis-step-text {
            color: #10b981;
        }

        .analysis-step.processing .analysis-step-text {
            color: white;
            font-weight: 500;
        }

        /* ------------------------------------------
           2.8 CLIP SELECTION GRID (Step 3)
           ------------------------------------------ */
        .clips-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .clips-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
        }

        .clips-header-actions {
            display: flex;
            gap: 0.75rem;
        }

        .clip-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1.25rem;
        }

        .clip-card {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .clip-card:hover {
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }

        .clip-card.selected {
            border-color: #ec4899;
            box-shadow: 0 0 20px rgba(236, 72, 153, 0.2);
        }

        .clip-card.selected::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.1) 0%, rgba(249, 115, 22, 0.1) 100%);
            pointer-events: none;
        }

        .clip-thumbnail {
            position: relative;
            aspect-ratio: 16/9;
            background: rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .clip-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .clip-duration {
            position: absolute;
            bottom: 0.5rem;
            right: 0.5rem;
            background: rgba(0, 0, 0, 0.8);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .clip-checkbox {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            width: 24px;
            height: 24px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .clip-card.selected .clip-checkbox {
            background: #ec4899;
            border-color: #ec4899;
        }

        .clip-info {
            padding: 1rem;
        }

        .clip-score {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .virality-score {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            font-weight: 700;
        }

        .virality-score.high {
            color: #10b981;
        }

        .virality-score.medium {
            color: #f59e0b;
        }

        .virality-score.low {
            color: #ef4444;
        }

        .score-bar {
            width: 60px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .score-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .virality-score.high .score-bar-fill {
            background: linear-gradient(90deg, #10b981, #059669);
        }

        .virality-score.medium .score-bar-fill {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        .virality-score.low .score-bar-fill {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .clip-transcript {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }

        .clip-platforms {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .platform-badge {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.375rem;
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .platform-badge:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .platform-badge.active {
            background: rgba(236, 72, 153, 0.2);
            color: #ec4899;
        }

        /* Platform Legend */
        .platform-legend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 0.75rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        /* ------------------------------------------
           2.9 CUSTOMIZATION STUDIO (Step 4)
           ------------------------------------------ */
        .customization-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 2rem;
            align-items: start;
        }

        @media (max-width: 1024px) {
            .customization-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Phone Preview */
        .phone-preview-container {
            position: sticky;
            top: 2rem;
        }

        .phone-frame {
            background: #000;
            border-radius: 2.5rem;
            padding: 0.75rem;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            max-width: 280px;
            margin: 0 auto;
        }

        .phone-screen {
            background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1a 100%);
            border-radius: 2rem;
            aspect-ratio: 9/16;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        .phone-video-area {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .phone-video-area img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .phone-caption-preview {
            position: absolute;
            bottom: 80px;
            left: 0;
            right: 0;
            text-align: center;
            padding: 0 1rem;
        }

        .caption-text {
            font-size: 1rem;
            font-weight: 700;
            line-height: 1.4;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        /* Caption Styles */
        .caption-karaoke .caption-text {
            color: white;
        }

        .caption-karaoke .highlight {
            color: #fbbf24;
            transform: scale(1.1);
            display: inline-block;
            animation: karaokeHighlight 0.3s ease-out;
        }

        @keyframes karaokeHighlight {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        .caption-beasty .caption-text {
            font-size: 1.2rem;
            text-transform: uppercase;
            color: #fbbf24;
            -webkit-text-stroke: 1px #000;
            animation: beastyPop 0.5s ease-out;
        }

        @keyframes beastyPop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .caption-deepdiver .caption-text {
            font-size: 0.9rem;
            font-weight: 400;
            text-transform: lowercase;
            color: rgba(255, 255, 255, 0.9);
        }

        .caption-podp .caption-text {
            font-size: 1rem;
            font-weight: 500;
            color: white;
            letter-spacing: 0.5px;
        }

        .caption-hormozi .caption-text {
            font-size: 1.1rem;
            color: white;
        }

        .caption-hormozi .highlight {
            background: linear-gradient(180deg, #22c55e 0%, #16a34a 100%);
            color: white;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            animation: hormoziSlide 0.3s ease-out;
        }

        @keyframes hormoziSlide {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .caption-ali .caption-text {
            font-size: 1rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 0 10px rgba(236, 72, 153, 0.8), 0 0 20px rgba(236, 72, 153, 0.4);
        }

        .clip-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .clip-nav-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .clip-nav-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .clip-nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .clip-counter {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Customization Panels */
        .customization-panels {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .customization-panel {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            padding: 1.25rem;
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .panel-icon {
            font-size: 1.25rem;
        }

        .panel-title {
            font-size: 1rem;
            font-weight: 600;
            color: white;
        }

        .panel-preset-label {
            margin-left: auto;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            padding: 0.25rem 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.375rem;
        }

        /* Caption Style Cards */
        .caption-styles-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
        }

        @media (max-width: 900px) {
            .caption-styles-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 600px) {
            .caption-styles-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .caption-style-card {
            padding: 0.875rem;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.25s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .caption-style-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.1) 0%, rgba(249, 115, 22, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.25s ease;
        }

        .caption-style-card:hover {
            border-color: rgba(255, 255, 255, 0.25);
            background: rgba(255, 255, 255, 0.05);
            transform: translateY(-2px);
        }

        .caption-style-card:hover::before {
            opacity: 1;
        }

        .caption-style-card.selected {
            border-color: #ec4899;
            background: rgba(236, 72, 153, 0.15);
            box-shadow: 0 0 20px rgba(236, 72, 153, 0.2);
        }

        .caption-style-card.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 18px;
            height: 18px;
            background: #ec4899;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            color: white;
        }

        .caption-style-preview {
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            position: relative;
            z-index: 1;
            padding: 0 0.5rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0.5rem;
        }

        .caption-style-name {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        .caption-style-card.custom-style {
            border-style: dashed;
        }

        .caption-style-card.custom-style .caption-style-preview {
            font-size: 1.5rem;
        }

        /* Reframe Layout Cards */
        .reframe-layouts-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.75rem;
        }

        @media (max-width: 768px) {
            .reframe-layouts-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .reframe-layout-card {
            padding: 0.625rem;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.25s ease;
            text-align: center;
        }

        .reframe-layout-card:hover {
            border-color: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .reframe-layout-card.selected {
            border-color: #ec4899;
            background: rgba(236, 72, 153, 0.1);
            box-shadow: 0 0 15px rgba(236, 72, 153, 0.2);
        }

        .reframe-layout-diagram {
            width: 100%;
            aspect-ratio: 9/16;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Layout Diagram Styles */
        .reframe-layout-diagram.auto-center .layout-face {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 50%;
            background: linear-gradient(180deg, rgba(236, 72, 153, 0.4) 0%, rgba(236, 72, 153, 0.2) 100%);
            border-radius: 50% 50% 40% 40%;
            border: 2px solid rgba(236, 72, 153, 0.6);
        }

        .reframe-layout-diagram.split-screen .layout-section {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        }

        .reframe-layout-diagram.split-screen .layout-section:last-child {
            border-bottom: none;
        }

        .reframe-layout-diagram.split-screen .layout-face-small {
            width: 40%;
            height: 60%;
            background: linear-gradient(180deg, rgba(236, 72, 153, 0.3) 0%, rgba(236, 72, 153, 0.15) 100%);
            border-radius: 50% 50% 40% 40%;
            border: 1px solid rgba(236, 72, 153, 0.5);
        }

        .reframe-layout-diagram.three-person .layout-section-top {
            flex: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        }

        .reframe-layout-diagram.three-person .layout-section-bottom {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-around;
        }

        .reframe-layout-diagram.three-person .layout-face-main {
            width: 50%;
            height: 60%;
            background: rgba(236, 72, 153, 0.3);
            border-radius: 50% 50% 40% 40%;
            border: 1px solid rgba(236, 72, 153, 0.5);
        }

        .reframe-layout-diagram.three-person .layout-face-small {
            width: 35%;
            height: 70%;
            background: rgba(249, 115, 22, 0.25);
            border-radius: 50% 50% 40% 40%;
            border: 1px solid rgba(249, 115, 22, 0.5);
        }

        .reframe-layout-diagram.gameplay .layout-game-area {
            flex: 2;
            background: rgba(34, 197, 94, 0.15);
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reframe-layout-diagram.gameplay .layout-game-icon {
            font-size: 1.5rem;
        }

        .reframe-layout-diagram.gameplay .layout-cam-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reframe-layout-diagram.gameplay .layout-face-cam {
            width: 40%;
            height: 70%;
            background: rgba(236, 72, 153, 0.25);
            border-radius: 50% 50% 40% 40%;
            border: 1px solid rgba(236, 72, 153, 0.4);
        }

        .reframe-layout-diagram.broll-split .layout-main-area {
            flex: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        }

        .reframe-layout-diagram.broll-split .layout-face-broll {
            width: 50%;
            height: 60%;
            background: rgba(236, 72, 153, 0.3);
            border-radius: 50% 50% 40% 40%;
            border: 1px solid rgba(236, 72, 153, 0.5);
        }

        .reframe-layout-diagram.broll-split .layout-broll-area {
            flex: 1;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(59, 130, 246, 0.2) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .reframe-layout-name {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        .reframe-layout-card.selected .reframe-layout-name {
            color: white;
        }

        /* Timeline Trimmer */
        .timeline-container {
            padding: 1.25rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0.75rem;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .timeline-duration {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .timeline-duration-value {
            color: #ec4899;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        .timeline-duration-label {
            color: rgba(255, 255, 255, 0.5);
        }

        .timeline-fine-tune {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .timeline-fine-btn {
            width: 28px;
            height: 28px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.375rem;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timeline-fine-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .timeline-waveform {
            height: 50px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            position: relative;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }

        .waveform-bars {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 2px;
            height: 100%;
            padding: 8px 10px;
        }

        .waveform-bar {
            flex: 1;
            max-width: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            transition: background 0.15s ease;
        }

        .waveform-bar.active {
            background: linear-gradient(180deg, #ec4899 0%, #f97316 100%);
        }

        .timeline-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            position: relative;
            overflow: visible;
            margin-bottom: 0.75rem;
            cursor: pointer;
        }

        .timeline-fill {
            position: absolute;
            top: 0;
            bottom: 0;
            background: linear-gradient(90deg, rgba(236, 72, 153, 0.6) 0%, rgba(249, 115, 22, 0.6) 100%);
            border-radius: 6px;
        }

        .timeline-playhead {
            position: absolute;
            top: -4px;
            bottom: -4px;
            width: 3px;
            background: white;
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            pointer-events: none;
        }

        .timeline-handle {
            position: absolute;
            top: -6px;
            bottom: -6px;
            width: 16px;
            background: transparent;
            cursor: ew-resize;
            z-index: 10;
            transform: translateX(-50%);
        }

        .timeline-handle::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 100%;
            background: #ec4899;
            border-radius: 2px;
        }

        .timeline-handle::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 14px;
            height: 20px;
            background: linear-gradient(180deg, #ec4899 0%, #db2777 100%);
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(236, 72, 153, 0.4);
        }

        .timeline-handle:hover::after {
            box-shadow: 0 2px 12px rgba(236, 72, 153, 0.6);
            transform: translate(-50%, -50%) scale(1.1);
        }

        .timeline-handle.dragging::after {
            background: linear-gradient(180deg, #f472b6 0%, #ec4899 100%);
            box-shadow: 0 2px 16px rgba(236, 72, 153, 0.8);
        }

        .timeline-times {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            font-variant-numeric: tabular-nums;
        }

        .timeline-times span {
            padding: 0.25rem 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.25rem;
        }

        /* Audio Options */
        .audio-section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.4);
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
            margin-top: 1rem;
        }

        .audio-section-title:first-child {
            margin-top: 0;
        }

        .audio-options {
            display: flex;
            flex-direction: column;
            gap: 0.625rem;
        }

        .audio-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.625rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .audio-option:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .audio-option.checked {
            border-color: rgba(236, 72, 153, 0.3);
            background: rgba(236, 72, 153, 0.05);
        }

        .audio-option input {
            width: 18px;
            height: 18px;
            accent-color: #ec4899;
        }

        .audio-option-text {
            flex: 1;
        }

        .audio-option-title {
            font-size: 0.85rem;
            color: white;
            margin-bottom: 0.125rem;
        }

        .audio-option-desc {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
        }

        /* Volume Slider */
        .audio-volume-control {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.875rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.625rem;
        }

        .volume-icon {
            font-size: 1.25rem;
            width: 28px;
            text-align: center;
        }

        .volume-slider-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .volume-slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .volume-slider-value {
            color: #ec4899;
            font-weight: 600;
        }

        .volume-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: linear-gradient(180deg, #ec4899 0%, #db2777 100%);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(236, 72, 153, 0.4);
            transition: transform 0.15s ease;
        }

        .volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.15);
        }

        .volume-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: linear-gradient(180deg, #ec4899 0%, #db2777 100%);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(236, 72, 153, 0.4);
        }

        /* Music Library */
        .music-library {
            margin-top: 0.75rem;
        }

        .music-tracks {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 180px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .music-tracks::-webkit-scrollbar {
            width: 4px;
        }

        .music-tracks::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        .music-track {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .music-track:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .music-track.selected {
            background: rgba(236, 72, 153, 0.1);
            border-color: rgba(236, 72, 153, 0.4);
        }

        .music-track-play {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            flex-shrink: 0;
        }

        .music-track.selected .music-track-play {
            background: #ec4899;
        }

        .music-track-info {
            flex: 1;
            min-width: 0;
        }

        .music-track-name {
            font-size: 0.8rem;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .music-track-meta {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .music-track-duration {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            flex-shrink: 0;
        }

        /* AI Features Bar */
        .ai-features-bar {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 0.75rem;
            overflow-x: auto;
            margin-top: 1.5rem;
        }

        .ai-feature-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.8rem;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ai-feature-btn:hover {
            background: rgba(236, 72, 153, 0.1);
            border-color: rgba(236, 72, 153, 0.3);
            color: white;
        }

        .ai-btn-icon {
            font-size: 1rem;
        }

        /* Transition Options */
        .transition-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .transition-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.625rem 0.875rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 60px;
        }

        .transition-btn:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .transition-btn.selected {
            background: rgba(236, 72, 153, 0.15);
            border-color: #ec4899;
            color: white;
        }

        .transition-icon {
            font-size: 1.1rem;
        }

        .effect-options {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        /* AI Modal Styles */
        .ai-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .ai-modal {
            background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1a 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .ai-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ai-modal-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: white;
            margin: 0;
        }

        .ai-modal-close {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ai-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .ai-modal-content {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        /* B-Roll Suggestions */
        .broll-suggestion {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .broll-number {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .broll-info {
            flex: 1;
        }

        .broll-desc {
            font-size: 0.95rem;
            color: white;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

        .broll-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 0.5rem;
        }

        .broll-keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
        }

        .broll-tag {
            padding: 0.25rem 0.5rem;
            background: rgba(236, 72, 153, 0.15);
            border-radius: 0.25rem;
            font-size: 0.7rem;
            color: #ec4899;
        }

        /* Hook Suggestions */
        .hook-suggestion {
            padding: 1.25rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
            position: relative;
        }

        .hook-suggestion.recommended {
            border-color: rgba(236, 72, 153, 0.4);
            background: rgba(236, 72, 153, 0.08);
        }

        .hook-badge {
            position: absolute;
            top: -0.5rem;
            right: 1rem;
            padding: 0.25rem 0.75rem;
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
            border-radius: 1rem;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .hook-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.75rem;
            line-height: 1.3;
        }

        .hook-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 1rem;
        }

        .hook-use-btn {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
            border: none;
            border-radius: 0.5rem;
            color: white;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .hook-use-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);
        }

        .hook-explanation {
            padding: 1rem;
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid #3b82f6;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 1rem;
        }

        /* Filler Analysis */
        .filler-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .filler-stat {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 0.75rem;
        }

        .filler-stat .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: #ec4899;
            margin-bottom: 0.25rem;
        }

        .filler-stat .stat-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .filler-types {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .filler-type-badge {
            padding: 0.375rem 0.75rem;
            background: rgba(249, 115, 22, 0.15);
            border-radius: 1rem;
            font-size: 0.75rem;
            color: #f97316;
        }

        .filler-transcript {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 0.75rem;
        }

        .transcript-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .transcript-text {
            font-size: 0.9rem;
            color: white;
            line-height: 1.6;
        }

        /* ------------------------------------------
           2.10 SEO & THUMBNAILS (Step 5)
           ------------------------------------------ */
        .seo-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 900px) {
            .seo-layout {
                grid-template-columns: 1fr;
            }
        }

        .seo-panel {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            padding: 1.5rem;
        }

        .seo-field {
            margin-bottom: 1.5rem;
        }

        .seo-field:last-child {
            margin-bottom: 0;
        }

        .seo-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.625rem;
        }

        .seo-label span {
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
        }

        .seo-label .char-count {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .seo-input {
            width: 100%;
            padding: 0.875rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.625rem;
            color: white;
            font-size: 0.95rem;
            outline: none;
            transition: all 0.2s ease;
        }

        .seo-input:focus {
            border-color: rgba(236, 72, 153, 0.5);
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
        }

        .seo-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .regenerate-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.375rem;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .regenerate-btn:hover {
            background: rgba(236, 72, 153, 0.1);
            border-color: rgba(236, 72, 153, 0.3);
            color: white;
        }

        /* Tags */
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .tag {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem 0.75rem;
            background: rgba(236, 72, 153, 0.1);
            border: 1px solid rgba(236, 72, 153, 0.2);
            border-radius: 9999px;
            font-size: 0.8rem;
            color: #ec4899;
        }

        .tag-remove {
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .tag-remove:hover {
            opacity: 1;
        }

        .add-tag-btn {
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px dashed rgba(255, 255, 255, 0.2);
            border-radius: 9999px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-tag-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.3);
            color: white;
        }

        /* Thumbnails */
        .thumbnails-panel h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 1rem;
        }

        .thumbnails-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        @media (max-width: 600px) {
            .thumbnails-grid {
                grid-template-columns: 1fr;
            }
        }

        .thumbnail-option {
            position: relative;
            aspect-ratio: 16/9;
            background: rgba(255, 255, 255, 0.05);
            border: 3px solid transparent;
            border-radius: 0.75rem;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .thumbnail-option:hover {
            border-color: rgba(255, 255, 255, 0.2);
        }

        .thumbnail-option.selected {
            border-color: #ec4899;
            box-shadow: 0 0 20px rgba(236, 72, 153, 0.3);
        }

        .thumbnail-option img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .thumbnail-placeholder {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.03);
            color: rgba(255, 255, 255, 0.6);
            gap: 0.25rem;
            overflow: hidden;
        }

        .thumbnail-placeholder::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 0;
        }

        .thumbnail-download-btn {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .thumbnail-download-btn:hover {
            background: #10b981;
            border-color: #10b981;
        }

        .thumbnail-label {
            position: absolute;
            bottom: 0.5rem;
            left: 0.5rem;
            padding: 0.25rem 0.5rem;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 0.25rem;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .thumbnail-radio {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .thumbnail-option.selected .thumbnail-radio {
            border-color: #ec4899;
            background: #ec4899;
        }

        .thumbnail-option.selected .thumbnail-radio::after {
            content: 'âœ“';
            color: white;
            font-size: 0.75rem;
        }

        .regenerate-thumbnails-btn {
            margin-top: 1rem;
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.625rem;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .regenerate-thumbnails-btn:hover {
            background: rgba(236, 72, 153, 0.1);
            border-color: rgba(236, 72, 153, 0.3);
            color: white;
        }

        .regenerate-thumbnails-btn.primary-action {
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
            border-color: transparent;
            color: white;
            font-weight: 600;
        }

        .regenerate-thumbnails-btn.primary-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
        }

        .regenerate-thumbnails-btn:disabled {
            opacity: 0.8;
            cursor: not-allowed;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-color: transparent;
            color: white;
        }

        .thumbnail-loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .thumbnail-loading-info {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 0.5rem;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
        }

        /* ------------------------------------------
           2.11 EXPORT (Step 6)
           ------------------------------------------ */
        .export-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .export-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
        }

        .export-ready-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 9999px;
            color: #10b981;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .export-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .export-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.25rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            transition: all 0.2s ease;
        }

        .export-item:hover {
            border-color: rgba(255, 255, 255, 0.15);
        }

        .export-item-thumbnail {
            width: 80px;
            height: 45px;
            border-radius: 0.375rem;
            object-fit: cover;
            background: rgba(255, 255, 255, 0.05);
            flex-shrink: 0;
        }

        .export-item-info {
            flex: 1;
            min-width: 0;
        }

        .export-item-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .export-item-platforms {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .export-item-status {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 9999px;
            color: #10b981;
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .export-item-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .export-action-btn {
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .export-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        @media (max-width: 768px) {
            .export-item {
                flex-wrap: wrap;
            }
            .export-item-actions {
                width: 100%;
                justify-content: flex-end;
                margin-top: 0.75rem;
            }
        }

        /* Batch Actions */
        .batch-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
        }

        .batch-action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.625rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .batch-action-btn:hover {
            background: rgba(236, 72, 153, 0.1);
            border-color: rgba(236, 72, 153, 0.3);
        }

        .batch-action-btn.primary {
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
            border: none;
        }

        .batch-action-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(236, 72, 153, 0.3);
        }

        /* ------------------------------------------
           2.12 BUTTONS
           ------------------------------------------ */
        .btn-primary {
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
            color: white;
            font-weight: 600;
            padding: 0.875rem 1.5rem;
            border-radius: 0.75rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(236, 72, 153, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-weight: 500;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Navigation Buttons */
        .wizard-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .wizard-nav-left,
        .wizard-nav-right {
            display: flex;
            gap: 0.75rem;
        }

        /* ------------------------------------------
           2.13 GLOBAL HEADER
           ------------------------------------------ */
        .global-header {
            position: fixed;
            top: 0;
            right: 1.5rem;
            padding: 1rem 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            pointer-events: none;
        }

        .global-header > * {
            pointer-events: auto;
        }

        .global-header-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-back-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.875rem;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.5rem;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            text-decoration: none;
        }

        .header-back-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .header-token-display {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 0.875rem;
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.15) 0%, rgba(249, 115, 22, 0.1) 100%);
            border: 1px solid rgba(236, 72, 153, 0.3);
            border-radius: 9999px;
            font-size: 0.8rem;
            backdrop-filter: blur(10px);
        }

        .header-token-display .token-value {
            font-weight: 700;
            color: white;
        }

        .header-token-display .token-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.75rem;
        }

        @media (max-width: 768px) {
            .global-header {
                right: 1rem;
            }
            .header-token-display .token-label {
                display: none;
            }
        }

        /* ------------------------------------------
           2.14 LOADING & MISC
           ------------------------------------------ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-card {
            background: linear-gradient(145deg, rgba(30, 30, 50, 0.95) 0%, rgba(20, 20, 35, 0.98) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            padding: 2.5rem;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #ec4899;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1.5rem;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            color: white;
            font-weight: 500;
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }

        .toast.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .toast.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .toast.info {
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
        }

        /* ------------------------------------------
           2.16 VIDEO PREVIEW MODAL
           ------------------------------------------ */
        .video-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 2rem;
        }

        .video-preview-content {
            background: rgba(30, 30, 40, 0.95);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 900px;
            width: 100%;
            overflow: hidden;
        }

        .video-preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .video-preview-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            margin: 0;
        }

        .video-preview-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .video-preview-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .video-preview-player {
            position: relative;
            width: 100%;
            aspect-ratio: 16 / 9;
            background: #000;
        }

        .video-preview-player iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        .video-preview-info {
            padding: 1.25rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .video-preview-meta {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .video-preview-meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .video-preview-transcript {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
            max-height: 100px;
            overflow-y: auto;
        }

        .video-preview-actions {
            display: flex;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .video-preview-actions button {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .video-preview-actions .btn-select {
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
            border: none;
            color: white;
        }

        .video-preview-actions .btn-select:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);
        }

        .video-preview-actions .btn-select.selected {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        /* Play button overlay on clip cards */
        .clip-play-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background: rgba(236, 72, 153, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s ease;
            cursor: pointer;
            z-index: 10;
        }

        .clip-play-btn::after {
            content: '';
            width: 0;
            height: 0;
            border-left: 14px solid white;
            border-top: 9px solid transparent;
            border-bottom: 9px solid transparent;
            margin-left: 3px;
        }

        .clip-thumbnail:hover .clip-play-btn {
            opacity: 1;
        }

        .clip-play-btn:hover {
            transform: translate(-50%, -50%) scale(1.1);
            background: rgba(236, 72, 153, 1);
        }

        /* ------------------------------------------
           2.17 DOWNLOAD MODAL
           ------------------------------------------ */
        .download-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 2rem;
        }

        .download-modal-content {
            background: rgba(30, 30, 40, 0.95);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 500px;
            width: 100%;
            overflow: hidden;
        }

        .download-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .download-modal-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            margin: 0;
        }

        .download-modal-body {
            padding: 1.5rem;
        }

        .download-quality-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .quality-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.25rem;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quality-option:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(236, 72, 153, 0.4);
        }

        .quality-option.selected {
            background: rgba(236, 72, 153, 0.1);
            border-color: #ec4899;
        }

        .quality-option-label {
            font-size: 1.1rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.25rem;
        }

        .quality-option-size {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .download-coming-soon {
            background: rgba(249, 115, 22, 0.1);
            border: 1px solid rgba(249, 115, 22, 0.3);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .download-coming-soon-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #f97316;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .download-coming-soon-text {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.5;
        }

        .download-alternative {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .download-alternative-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #10b981;
            margin-bottom: 0.5rem;
        }

        .download-modal-actions {
            display: flex;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .download-modal-actions button {
            flex: 1;
            padding: 0.875rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .download-modal-actions .btn-youtube {
            background: #ff0000;
            border: none;
            color: white;
        }

        .download-modal-actions .btn-youtube:hover {
            background: #cc0000;
        }

        .download-modal-actions .btn-primary {
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
            border: none;
            color: white;
        }

        .download-modal-actions .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
        }

        .download-processing-info {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .processing-info-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #10b981;
            margin-bottom: 0.75rem;
        }

        .processing-features {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .processing-features li {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.85rem;
            padding: 0.25rem 0;
        }

        /* ------------------------------------------
           2.18 MY PROJECTS SECTION (Step 1)
           ------------------------------------------ */
        .my-projects-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
        }

        .my-projects-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.25rem;
        }

        .my-projects-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .my-projects-header .refresh-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .my-projects-header .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .projects-loading {
            text-align: center;
            padding: 2rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .projects-empty {
            text-align: center;
            padding: 2rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .project-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.75rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .project-card:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(236, 72, 153, 0.3);
            transform: translateY(-2px);
        }

        .project-card-header {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .project-thumbnail {
            width: 80px;
            height: 45px;
            border-radius: 0.375rem;
            object-fit: cover;
            background: rgba(0, 0, 0, 0.3);
        }

        .project-info {
            flex: 1;
            min-width: 0;
        }

        .project-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.25rem;
        }

        .project-meta {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .project-status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .project-status-badge.draft {
            background: rgba(249, 115, 22, 0.15);
            color: #f97316;
        }

        .project-status-badge.complete {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }

        .project-status-badge.archived {
            background: rgba(107, 114, 128, 0.15);
            color: #9ca3af;
        }

        .project-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .project-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .project-action-btn {
            flex: 1;
            padding: 0.375rem 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.375rem;
            color: white;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .project-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .project-action-btn.primary {
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
            border: none;
        }

        .project-action-btn.primary:hover {
            transform: scale(1.02);
        }

        /* ------------------------------------------
           2.17 ENHANCED EXPORT UI (Step 6)
           ------------------------------------------ */
        .export-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 1000px) {
            .export-container {
                grid-template-columns: 1fr;
            }
        }

        .export-main {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            padding: 1.5rem;
        }

        .export-sidebar {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .export-panel {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            padding: 1.25rem;
        }

        .export-panel h3 {
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .export-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.625rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 0.5rem;
        }

        .export-option:last-child {
            margin-bottom: 0;
        }

        .export-option:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(236, 72, 153, 0.3);
        }

        .export-option.selected {
            background: rgba(236, 72, 153, 0.1);
            border-color: rgba(236, 72, 153, 0.4);
        }

        .export-option-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            font-size: 1.25rem;
        }

        .export-option-info {
            flex: 1;
        }

        .export-option-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
        }

        .export-option-desc {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .export-option-badge {
            padding: 0.25rem 0.5rem;
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
            border-radius: 0.375rem;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* YouTube Connection Panel */
        .youtube-connection-panel {
            margin-bottom: 1rem;
        }

        .youtube-connection-desc {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .youtube-connection-info {
            font-size: 0.75rem;
            color: rgba(16, 185, 129, 0.8);
            margin-top: 0.75rem;
            line-height: 1.4;
        }

        .youtube-connection-error {
            font-size: 0.8rem;
            color: #ef4444;
            padding: 0.75rem;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .youtube-connect-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.875rem 1rem;
            background: #ff0000;
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .youtube-connect-btn:hover {
            background: #cc0000;
            transform: translateY(-1px);
        }

        .youtube-connect-btn svg {
            flex-shrink: 0;
        }

        .youtube-connection-status {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.5rem;
        }

        .youtube-connection-status.connected {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.2);
        }

        .youtube-connection-status.loading {
            justify-content: center;
            color: rgba(255, 255, 255, 0.7);
        }

        .connection-loading-spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-top-color: #ec4899;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .youtube-channel-thumb {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }

        .youtube-channel-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border-radius: 50%;
            font-size: 1rem;
            font-weight: bold;
        }

        .youtube-channel-info {
            flex: 1;
            min-width: 0;
        }

        .youtube-channel-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .youtube-channel-label {
            font-size: 0.7rem;
            color: #10b981;
        }

        .youtube-disconnect-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 0.375rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .youtube-disconnect-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.4);
        }

        .quick-links {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .quick-link {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.625rem;
            color: white;
            text-decoration: none;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .quick-link:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(236, 72, 153, 0.3);
        }

        .quick-link-icon {
            font-size: 1.1rem;
        }

        .export-summary {
            padding: 1rem;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 0.625rem;
            margin-bottom: 1rem;
        }

        .export-summary-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #10b981;
            margin-bottom: 0.5rem;
        }

        .export-summary-list {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .export-summary-list li {
            margin-bottom: 0.25rem;
            list-style: none;
            padding-left: 1rem;
            position: relative;
        }

        .export-summary-list li::before {
            content: 'âœ“';
            position: absolute;
            left: 0;
            color: #10b981;
        }

        .export-actions-large {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .export-btn-large {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .export-btn-large:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateY(-2px);
        }

        .export-btn-large.primary {
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
            border: none;
        }

        .export-btn-large.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(236, 72, 153, 0.3);
        }

        .export-btn-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .export-btn-label {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .export-btn-sublabel {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 0.25rem;
        }
    </style>

    <!-- ============================================
         SECTION 3: HTML CONTAINER
         ============================================ -->
</head>
<body>
    <div id="app-root"></div>

    <!-- ============================================
         SECTION 4: SCRIPTS
         ============================================ -->
    <script>
    (function() {
        'use strict';

        /* ==========================================
           4.1 FIREBASE CONFIGURATION
           ========================================== */

        if (typeof firebase === 'undefined') {
            console.error('Firebase SDK not loaded');
            document.getElementById('app-root').innerHTML =
                '<div style="display:flex;align-items:center;justify-content:center;min-height:100vh;padding:2rem;">' +
                '<div style="text-align:center;color:white;">' +
                '<h2 style="color:#ef4444;margin-bottom:1rem;">Error Loading Page</h2>' +
                '<p style="color:#9ca3af;">Failed to load Firebase. Please refresh the page.</p></div></div>';
            return;
        }

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAGczY5ZEIJdTq25BpQdia3lv2I556wOZo",
            authDomain: "ytseo-6d1b0.firebaseapp.com",
            projectId: "ytseo-6d1b0",
            storageBucket: "ytseo-6d1b0.firebasestorage.app",
            messagingSenderId: "382790048044",
            appId: "1:382790048044:web:cd427679ff72108c1f3489"
        };

        firebase.initializeApp(FIREBASE_CONFIG);
        const auth = firebase.auth();
        const functions = firebase.functions();
        const db = firebase.firestore();

        /* ==========================================
           4.2 APPLICATION STATE
           ========================================== */

        const state = {
            currentStep: 1,
            user: null,
            profile: null,
            loading: false,
            projectId: null, // Firestore project ID

            // Token system
            tokens: {
                balance: 0,
                plan: 'free'
            },

            // Step 1: Video Input
            videoInput: {
                url: '',
                videoData: null, // { title, duration, thumbnail, videoId }
                options: {
                    generateCaptions: true,
                    generateThumbnails: true,
                    seoOptimization: true,
                    multiPlatform: true
                }
            },

            // Step 2: Analysis
            analysis: {
                status: 'idle', // idle | processing | done | error
                progress: 0,
                currentStep: 0,
                error: null,
                steps: [
                    { name: 'Fetching video info', status: 'pending' },
                    { name: 'Downloading video', status: 'pending' },
                    { name: 'Extracting audio', status: 'pending' },
                    { name: 'Generating transcript', status: 'pending' },
                    { name: 'Finding viral moments', status: 'pending' },
                    { name: 'Scoring clips', status: 'pending' }
                ]
            },

            // Step 3: Clips
            clips: [],
            selectedClipIds: [],

            // Step 4: Customization
            customization: {
                activeClipIndex: 0,
                batchMode: false
            },

            // Clip settings (per clip)
            clipSettings: {},

            // Step 5: SEO & Thumbnails
            clipSEO: {},
            clipThumbnails: {},
            selectedThumbnail: {},  // Track selected thumbnail index per clip
            thumbnailGenerating: false,  // Loading state for thumbnail generation
            downloadModal: null,     // Current download modal state

            // Phase 4: Advanced AI Features
            clipBRoll: {},      // AI B-Roll suggestions per clip
            clipHooks: {},      // AI viral hooks per clip
            clipFillers: {},    // Filler word analysis per clip
            clipSpeakers: {},   // Speaker detection per clip
            clipCaptions: {},   // Generated captions per clip

            // Step 6: Export
            exportStatus: {},

            // Phase 5: My Projects
            myProjects: [],           // List of user's saved projects
            projectsLoading: false,   // Loading state for projects list
            projectsLoaded: false,    // Whether projects have been loaded

            // YouTube OAuth Connection
            youtubeConnection: {
                connected: false,
                loading: false,
                channel: null,        // { id, title, thumbnail }
                error: null
            }
        };

        // Mock data for testing
        const MOCK_CLIPS = [
            { id: 'clip_001', startTime: 120, endTime: 165, duration: 45, score: 98, transcript: 'The biggest mistake entrepreneurs make is thinking they need to have everything figured out before they start...', thumbnail: 'https://picsum.photos/seed/clip1/320/180', platforms: ['youtube', 'instagram', 'tiktok'] },
            { id: 'clip_002', startTime: 340, endTime: 412, duration: 72, score: 95, transcript: 'When I started my first business, I had $500 in my bank account and zero connections...', thumbnail: 'https://picsum.photos/seed/clip2/320/180', platforms: ['youtube', 'tiktok'] },
            { id: 'clip_003', startTime: 560, endTime: 618, duration: 58, score: 92, transcript: 'The secret to scaling is not working harder, it\'s building systems that work without you...', thumbnail: 'https://picsum.photos/seed/clip3/320/180', platforms: ['youtube', 'instagram', 'linkedin'] },
            { id: 'clip_004', startTime: 780, endTime: 814, duration: 34, score: 89, transcript: 'Most people quit right before the breakthrough. That\'s why persistence is everything...', thumbnail: 'https://picsum.photos/seed/clip4/320/180', platforms: ['tiktok', 'facebook'] },
            { id: 'clip_005', startTime: 920, endTime: 985, duration: 65, score: 87, transcript: 'I failed seven times before I built something that worked. Each failure taught me something crucial...', thumbnail: 'https://picsum.photos/seed/clip5/320/180', platforms: ['youtube', 'instagram'] },
            { id: 'clip_006', startTime: 1100, endTime: 1142, duration: 42, score: 84, transcript: 'Your network is your net worth. The people you surround yourself with determine your success...', thumbnail: 'https://picsum.photos/seed/clip6/320/180', platforms: ['linkedin'] },
            { id: 'clip_007', startTime: 1280, endTime: 1338, duration: 58, score: 81, transcript: 'Stop waiting for permission. Start before you\'re ready because you\'ll never feel ready...', thumbnail: 'https://picsum.photos/seed/clip7/320/180', platforms: ['youtube', 'tiktok'] },
            { id: 'clip_008', startTime: 1450, endTime: 1498, duration: 48, score: 78, transcript: 'Revenue is vanity, profit is sanity, but cash flow is king. Remember that...', thumbnail: 'https://picsum.photos/seed/clip8/320/180', platforms: ['youtube', 'linkedin'] }
        ];

        // Default SEO template for clips without generated SEO
        function getDefaultSEO(clip) {
            return {
                title: clip ? (clip.transcript || '').substring(0, 60) + '...' : 'Untitled Clip',
                description: clip ? clip.transcript || '' : '',
                tags: ['shorts', 'viral', 'clips']
            };
        }

        /* ==========================================
           4.3 UTILITY FUNCTIONS
           ========================================== */

        const utils = {
            escapeHtml: function(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            formatDuration: function(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return mins + ':' + (secs < 10 ? '0' : '') + secs;
            },

            formatFullDuration: function(seconds) {
                const hours = Math.floor(seconds / 3600);
                const mins = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                if (hours > 0) {
                    return hours + ':' + (mins < 10 ? '0' : '') + mins + ':' + (secs < 10 ? '0' : '') + secs;
                }
                return mins + ':' + (secs < 10 ? '0' : '') + secs;
            },

            getScoreClass: function(score) {
                if (score >= 80) return 'high';
                if (score >= 50) return 'medium';
                return 'low';
            },

            showToast: function(message, type) {
                const toast = document.createElement('div');
                toast.className = 'toast ' + (type || 'info');
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(function() {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateY(10px)';
                    setTimeout(function() { toast.remove(); }, 300);
                }, 3000);
            },

            getPlatformIcon: function(platform) {
                const icons = {
                    youtube: 'ðŸ“º',
                    instagram: 'ðŸ“¸',
                    tiktok: 'ðŸŽµ',
                    linkedin: 'ðŸ’¼',
                    facebook: 'ðŸ“˜',
                    twitter: 'âœ•'
                };
                return icons[platform] || 'ðŸ“±';
            },

            getPlatformName: function(platform) {
                const names = {
                    youtube: 'YouTube',
                    instagram: 'Instagram',
                    tiktok: 'TikTok',
                    linkedin: 'LinkedIn',
                    facebook: 'Facebook',
                    twitter: 'X/Twitter'
                };
                return names[platform] || platform;
            },

            formatDate: function(dateInput) {
                if (!dateInput) return 'Unknown';
                var date;
                if (dateInput._seconds) {
                    // Firestore Timestamp
                    date = new Date(dateInput._seconds * 1000);
                } else if (dateInput.seconds) {
                    date = new Date(dateInput.seconds * 1000);
                } else if (typeof dateInput === 'string') {
                    date = new Date(dateInput);
                } else {
                    date = dateInput;
                }
                var now = new Date();
                var diff = now - date;
                var seconds = Math.floor(diff / 1000);
                var minutes = Math.floor(seconds / 60);
                var hours = Math.floor(minutes / 60);
                var days = Math.floor(hours / 24);

                if (days > 7) {
                    return date.toLocaleDateString();
                } else if (days > 0) {
                    return days + ' day' + (days > 1 ? 's' : '') + ' ago';
                } else if (hours > 0) {
                    return hours + ' hour' + (hours > 1 ? 's' : '') + ' ago';
                } else if (minutes > 0) {
                    return minutes + ' min' + (minutes > 1 ? 's' : '') + ' ago';
                } else {
                    return 'Just now';
                }
            }
        };

        /* ==========================================
           4.4 RENDER FUNCTIONS
           ========================================== */

        function render() {
            const root = document.getElementById('app-root');
            let html = '';

            // Loading overlay
            if (state.loading) {
                html += renderLoading();
            }

            // Main wizard
            html += '<div class="wizard-container">';
            html += renderGlobalHeader();
            html += renderWizardHeader();
            html += renderStepper();
            html += '<div class="wizard-content">';

            switch (state.currentStep) {
                case 1:
                    html += renderStep1VideoInput();
                    break;
                case 2:
                    html += renderStep2Analysis();
                    break;
                case 3:
                    html += renderStep3ClipSelection();
                    break;
                case 4:
                    html += renderStep4Customization();
                    break;
                case 5:
                    html += renderStep5SEO();
                    break;
                case 6:
                    html += renderStep6Export();
                    break;
            }

            html += '</div>'; // wizard-content
            html += '</div>'; // wizard-container

            root.innerHTML = html;
            attachEventListeners();
        }

        function renderLoading() {
            return '<div class="loading-overlay">' +
                '<div class="loading-card">' +
                '<div class="spinner"></div>' +
                '<h3 class="text-xl font-bold text-white mb-2">Processing...</h3>' +
                '<p class="text-gray-400">AI is working its magic</p>' +
                '</div></div>';
        }

        function renderGlobalHeader() {
            var html = '<div class="global-header">';
            html += '<div class="global-header-content">';

            // Back to dashboard
            html += '<a href="/video-optimizer" class="header-back-btn">';
            html += '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>';
            html += '<span>Dashboard</span>';
            html += '</a>';

            // Token display
            html += '<div class="header-token-display">';
            html += '<span>ðŸª™</span>';
            html += '<span class="token-value">' + state.tokens.balance + '</span>';
            html += '<span class="token-label">tokens</span>';
            html += '</div>';

            html += '</div></div>';
            return html;
        }

        function renderWizardHeader() {
            var html = '<div class="wizard-header">';
            html += '<h1 class="wizard-title">ðŸŽ¬ AI Video-to-Shorts Wizard</h1>';
            html += '<p class="wizard-subtitle">Transform long videos into viral short-form clips with AI</p>';
            html += '</div>';
            return html;
        }

        function renderStepper() {
            const steps = [
                { num: 1, label: 'Video Input' },
                { num: 2, label: 'AI Analysis' },
                { num: 3, label: 'Select Clips' },
                { num: 4, label: 'Customize' },
                { num: 5, label: 'SEO & Thumbnails' },
                { num: 6, label: 'Export' }
            ];

            var html = '<div class="wizard-stepper">';

            steps.forEach(function(step, index) {
                var stepClass = 'wizard-step';
                if (step.num === state.currentStep) stepClass += ' active';
                if (step.num < state.currentStep) stepClass += ' completed';

                html += '<div class="' + stepClass + '" onclick="app.goToStep(' + step.num + ')">';
                html += '<div class="step-number">';
                if (step.num < state.currentStep) {
                    html += 'âœ“';
                } else {
                    html += step.num;
                }
                html += '</div>';
                html += '<span class="step-label">' + step.label + '</span>';
                html += '</div>';

                if (index < steps.length - 1) {
                    var connectorClass = step.num < state.currentStep ? 'step-connector completed' : 'step-connector';
                    html += '<div class="' + connectorClass + '"></div>';
                }
            });

            html += '</div>';
            return html;
        }

        /* ==========================================
           STEP 1: VIDEO INPUT
           ========================================== */

        function renderStep1VideoInput() {
            var html = '';

            // Dropzone
            html += '<div class="video-dropzone" id="dropzone">';
            html += '<div class="dropzone-icon">ðŸŽ¬</div>';
            html += '<h3 class="dropzone-title">Drop a long video and get clips</h3>';
            html += '<p class="dropzone-subtitle">Paste a YouTube URL or drag & drop a video file</p>';

            // URL Input
            html += '<div class="url-input-container">';
            html += '<input type="text" class="url-input" id="video-url" placeholder="https://youtube.com/watch?v=..." value="' + utils.escapeHtml(state.videoInput.url) + '">';
            html += '<button class="btn-primary" onclick="app.analyzeVideo()">Get Clips</button>';
            html += '</div>';

            html += '</div>';

            // Video Preview (if URL entered)
            if (state.videoInput.videoData) {
                html += '<div class="video-preview-container">';
                html += '<div class="video-preview-info">';
                html += '<img src="' + state.videoInput.videoData.thumbnail + '" alt="Video thumbnail" class="video-thumbnail">';
                html += '<div class="video-details">';
                html += '<h4>' + utils.escapeHtml(state.videoInput.videoData.title) + '</h4>';
                html += '<p>Duration: ' + utils.formatFullDuration(state.videoInput.videoData.duration) + '</p>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
            }

            // Options Panel
            html += '<div class="options-panel">';

            var options = [
                { key: 'generateCaptions', label: 'Generate captions', icon: 'ðŸ’¬' },
                { key: 'generateThumbnails', label: 'Generate thumbnails (2 A/B)', icon: 'ðŸ–¼ï¸' },
                { key: 'seoOptimization', label: 'SEO optimization', icon: 'ðŸ”' },
                { key: 'multiPlatform', label: 'Multi-platform export', icon: 'ðŸ“±' }
            ];

            options.forEach(function(opt) {
                var checked = state.videoInput.options[opt.key];
                var checkedClass = checked ? ' checked' : '';
                html += '<label class="option-checkbox' + checkedClass + '">';
                html += '<input type="checkbox" ' + (checked ? 'checked' : '') + ' onchange="app.toggleOption(\'' + opt.key + '\')">';
                html += '<span>' + opt.icon + ' ' + opt.label + '</span>';
                html += '</label>';
            });

            html += '</div>';

            // My Projects Section
            html += '<div class="my-projects-section">';
            html += '<div class="my-projects-header">';
            html += '<h3>ðŸ“ My Projects</h3>';
            html += '<button class="refresh-btn" onclick="app.loadMyProjects()">ðŸ”„ Refresh</button>';
            html += '</div>';

            if (state.projectsLoading) {
                html += '<div class="projects-loading">Loading your projects...</div>';
            } else if (!state.projectsLoaded) {
                html += '<div class="projects-empty">';
                html += '<p>Click refresh to load your saved projects</p>';
                html += '</div>';
            } else if (state.myProjects.length === 0) {
                html += '<div class="projects-empty">';
                html += '<p>No saved projects yet. Create your first project above!</p>';
                html += '</div>';
            } else {
                html += '<div class="projects-grid">';
                state.myProjects.forEach(function(project) {
                    var statusClass = project.status || 'draft';
                    var lastUpdated = project.updatedAt ? utils.formatDate(project.updatedAt) : 'Unknown';

                    html += '<div class="project-card">';
                    html += '<div class="project-card-header">';
                    html += '<img src="' + (project.videoThumbnail || project.thumbnail || 'https://picsum.photos/seed/' + project.id + '/80/45') + '" alt="Project" class="project-thumbnail">';
                    html += '<div class="project-info">';
                    html += '<div class="project-title">' + utils.escapeHtml(project.videoTitle || 'Untitled Project') + '</div>';
                    html += '<div class="project-meta">' + lastUpdated + '</div>';
                    html += '</div>';
                    html += '</div>';

                    html += '<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">';
                    html += '<span class="project-status-badge ' + statusClass + '">' + statusClass + '</span>';
                    html += '<div class="project-stats">';
                    html += '<span>ðŸŽ¬ ' + (project.clipCount || 0) + ' clips</span>';
                    html += '</div>';
                    html += '</div>';

                    html += '<div class="project-actions">';
                    html += '<button class="project-action-btn primary" onclick="event.stopPropagation(); app.loadProject(\'' + project.id + '\')">ðŸ“‚ Open</button>';
                    html += '<button class="project-action-btn" onclick="event.stopPropagation(); app.duplicateProject(\'' + project.id + '\')">ðŸ“‹ Duplicate</button>';
                    html += '<button class="project-action-btn" onclick="event.stopPropagation(); app.archiveProject(\'' + project.id + '\')">ðŸ“¦ Archive</button>';
                    html += '</div>';
                    html += '</div>';
                });
                html += '</div>';
            }
            html += '</div>';

            // Navigation
            html += '<div class="wizard-nav">';
            html += '<div class="wizard-nav-left"></div>';
            html += '<div class="wizard-nav-right">';
            html += '<button class="btn-primary" onclick="app.analyzeVideo()" ' + (!state.videoInput.url ? 'disabled' : '') + '>';
            html += 'Analyze Video <span>â†’</span>';
            html += '</button>';
            html += '</div>';
            html += '</div>';

            return html;
        }

        /* ==========================================
           STEP 2: AI ANALYSIS
           ========================================== */

        function renderStep2Analysis() {
            var html = '<div class="analysis-container">';

            // Video info
            if (state.videoInput.videoData) {
                html += '<div class="analysis-video-info">';
                html += '<img src="' + state.videoInput.videoData.thumbnail + '" alt="Video">';
                html += '<div>';
                html += '<div class="video-title">' + utils.escapeHtml(state.videoInput.videoData.title) + '</div>';
                html += '<div class="video-duration">' + utils.formatFullDuration(state.videoInput.videoData.duration) + '</div>';
                html += '</div>';
                html += '</div>';
            }

            // Progress bar
            html += '<div class="progress-container">';
            html += '<div class="progress-bar-bg">';
            html += '<div class="progress-bar-fill" style="width: ' + state.analysis.progress + '%"></div>';
            html += '</div>';
            html += '<div class="progress-percentage">' + state.analysis.progress + '%</div>';
            html += '</div>';

            // Steps list
            html += '<div class="analysis-steps">';
            state.analysis.steps.forEach(function(step) {
                var stepClass = 'analysis-step ' + step.status;
                var icon = step.status === 'done' ? 'âœ…' : step.status === 'processing' ? 'ðŸ”„' : 'â³';
                html += '<div class="' + stepClass + '">';
                html += '<div class="analysis-step-icon">' + icon + '</div>';
                html += '<span class="analysis-step-text">' + step.name + '</span>';
                html += '</div>';
            });
            html += '</div>';

            html += '</div>';

            // Navigation (hidden during processing)
            if (state.analysis.status === 'done') {
                html += '<div class="wizard-nav">';
                html += '<div class="wizard-nav-left">';
                html += '<button class="btn-secondary" onclick="app.goToStep(1)">â† Back</button>';
                html += '</div>';
                html += '<div class="wizard-nav-right">';
                html += '<button class="btn-primary" onclick="app.goToStep(3)">View Clips â†’</button>';
                html += '</div>';
                html += '</div>';
            }

            return html;
        }

        /* ==========================================
           STEP 3: CLIP SELECTION
           ========================================== */

        function renderStep3ClipSelection() {
            var html = '';

            // Header
            html += '<div class="clips-header">';
            html += '<h2>Found ' + state.clips.length + ' Clips</h2>';
            html += '<div class="clips-header-actions">';
            html += '<button class="btn-secondary" onclick="app.selectAllClips()">Select All</button>';
            html += '<button class="btn-secondary" onclick="app.deselectAllClips()">Deselect All</button>';
            html += '</div>';
            html += '</div>';

            // Clip Grid
            html += '<div class="clip-grid">';
            state.clips.forEach(function(clip) {
                var isSelected = state.selectedClipIds.indexOf(clip.id) !== -1;
                var cardClass = isSelected ? 'clip-card selected' : 'clip-card';
                var scoreClass = utils.getScoreClass(clip.score);

                html += '<div class="' + cardClass + '" onclick="app.toggleClipSelection(\'' + clip.id + '\')">';

                // Thumbnail with play button
                html += '<div class="clip-thumbnail">';
                html += '<img src="' + clip.thumbnail + '" alt="Clip thumbnail">';
                html += '<span class="clip-duration">' + utils.formatDuration(clip.duration) + '</span>';
                html += '<div class="clip-checkbox">' + (isSelected ? 'âœ“' : '') + '</div>';
                html += '<div class="clip-play-btn" onclick="event.stopPropagation(); app.previewClip(\'' + clip.id + '\')" title="Preview clip"></div>';
                html += '</div>';

                // Info
                html += '<div class="clip-info">';

                // Score
                html += '<div class="clip-score">';
                html += '<div class="virality-score ' + scoreClass + '">';
                html += '<span>ðŸ”¥ ' + clip.score + '</span>';
                html += '<div class="score-bar"><div class="score-bar-fill" style="width: ' + clip.score + '%"></div></div>';
                html += '</div>';
                html += '</div>';

                // Transcript preview
                html += '<p class="clip-transcript">"' + utils.escapeHtml(clip.transcript) + '"</p>';

                // Platforms
                html += '<div class="clip-platforms">';
                clip.platforms.forEach(function(platform) {
                    html += '<span class="platform-badge active">' + utils.getPlatformIcon(platform) + '</span>';
                });
                html += '</div>';

                html += '</div>'; // clip-info
                html += '</div>'; // clip-card
            });
            html += '</div>';

            // Platform Legend
            html += '<div class="platform-legend">';
            ['youtube', 'instagram', 'tiktok', 'linkedin', 'facebook', 'twitter'].forEach(function(platform) {
                html += '<div class="legend-item">';
                html += '<span>' + utils.getPlatformIcon(platform) + '</span>';
                html += '<span>' + utils.getPlatformName(platform) + '</span>';
                html += '</div>';
            });
            html += '</div>';

            // Navigation
            html += '<div class="wizard-nav">';
            html += '<div class="wizard-nav-left">';
            html += '<button class="btn-secondary" onclick="app.goToStep(1)">â† Start Over</button>';
            html += '</div>';
            html += '<div class="wizard-nav-right">';
            html += '<button class="btn-primary" onclick="app.goToStep(4)" ' + (state.selectedClipIds.length === 0 ? 'disabled' : '') + '>';
            html += 'Customize Selected (' + state.selectedClipIds.length + ') â†’';
            html += '</button>';
            html += '</div>';
            html += '</div>';

            return html;
        }

        /* ==========================================
           STEP 4: CUSTOMIZATION STUDIO
           ========================================== */

        function renderStep4Customization() {
            var selectedClips = state.clips.filter(function(c) {
                return state.selectedClipIds.indexOf(c.id) !== -1;
            });
            var activeClip = selectedClips[state.customization.activeClipIndex] || selectedClips[0];
            var settings = state.clipSettings[activeClip.id] || getDefaultSettings();

            var html = '<div class="customization-layout">';

            // Left: Phone Preview
            html += '<div class="phone-preview-container">';
            html += '<div class="phone-frame">';
            html += '<div class="phone-screen">';
            html += '<div class="phone-video-area">';
            html += '<img src="' + activeClip.thumbnail + '" alt="Preview">';
            html += '</div>';

            // Caption preview with style-specific animations
            if (settings.captionStyle !== 'none') {
                html += '<div class="phone-caption-preview caption-' + settings.captionStyle + '">';
                html += '<p class="caption-text">';
                var captionPreviews = {
                    karaoke: 'The <span class="highlight">biggest</span> mistake...',
                    beasty: 'BIGGEST MISTAKE',
                    deepdiver: 'the biggest mistake entrepreneurs make',
                    podp: 'The biggest mistake...',
                    hormozi: 'The biggest <span class="highlight">MISTAKE</span>...',
                    ali: 'The biggest mistake...'
                };
                html += captionPreviews[settings.captionStyle] || 'The biggest mistake...';
                html += '</p>';
                html += '</div>';
            }

            html += '</div>'; // phone-screen
            html += '</div>'; // phone-frame

            // Clip navigation
            html += '<div class="clip-nav">';
            html += '<button class="clip-nav-btn" onclick="app.prevClip()" ' + (state.customization.activeClipIndex === 0 ? 'disabled' : '') + '>â† Prev</button>';
            html += '<span class="clip-counter">Clip ' + (state.customization.activeClipIndex + 1) + ' of ' + selectedClips.length + '</span>';
            html += '<button class="clip-nav-btn" onclick="app.nextClip()" ' + (state.customization.activeClipIndex >= selectedClips.length - 1 ? 'disabled' : '') + '>Next â†’</button>';
            html += '</div>';

            html += '</div>'; // phone-preview-container

            // Right: Customization Panels
            html += '<div class="customization-panels">';

            // Captions Panel with 7 styles + custom
            html += '<div class="customization-panel">';
            html += '<div class="panel-header">';
            html += '<span class="panel-icon">ðŸ’¬</span>';
            html += '<span class="panel-title">CAPTIONS</span>';
            html += '<span class="panel-preset-label">7 Styles</span>';
            html += '</div>';

            var captionStyles = [
                { id: 'none', name: 'None', preview: 'â€”' },
                { id: 'karaoke', name: 'Karaoke', preview: '<span style="color:white">The </span><span style="color:#fbbf24;font-weight:700">biggest</span>' },
                { id: 'beasty', name: 'MrBeast', preview: '<span style="color:#fbbf24;font-weight:900;text-transform:uppercase;font-size:0.9rem">BOLD</span>' },
                { id: 'deepdiver', name: 'Minimal', preview: '<span style="font-weight:400;font-size:0.75rem;opacity:0.9">minimal style</span>' },
                { id: 'podp', name: 'Podcast', preview: '<span style="font-weight:500;letter-spacing:0.3px">Clean Text</span>' },
                { id: 'hormozi', name: 'Hormozi', preview: '<span style="background:linear-gradient(180deg,#22c55e,#16a34a);padding:2px 6px;border-radius:3px;font-weight:600">KEY</span>' },
                { id: 'ali', name: 'Ali', preview: '<span style="text-shadow:0 0 8px rgba(236,72,153,0.8)">Glow</span>' },
                { id: 'custom', name: 'Custom', preview: 'âœ¨', isCustom: true }
            ];

            html += '<div class="caption-styles-grid">';
            captionStyles.forEach(function(style) {
                var selectedClass = settings.captionStyle === style.id ? ' selected' : '';
                var customClass = style.isCustom ? ' custom-style' : '';
                html += '<div class="caption-style-card' + selectedClass + customClass + '" onclick="app.setCaptionStyle(\'' + style.id + '\')">';
                html += '<div class="caption-style-preview">' + style.preview + '</div>';
                html += '<div class="caption-style-name">' + style.name + '</div>';
                html += '</div>';
            });
            html += '</div>';
            html += '</div>';

            // Reframe Panel with visual diagrams
            html += '<div class="customization-panel">';
            html += '<div class="panel-header">';
            html += '<span class="panel-icon">ðŸ”²</span>';
            html += '<span class="panel-title">REFRAME</span>';
            html += '</div>';

            html += '<div class="reframe-layouts-grid">';

            // Auto-center layout
            var autoSelected = settings.reframeMode === 'auto_center' ? ' selected' : '';
            html += '<div class="reframe-layout-card' + autoSelected + '" onclick="app.setReframeMode(\'auto_center\')">';
            html += '<div class="reframe-layout-diagram auto-center"><div class="layout-face"></div></div>';
            html += '<div class="reframe-layout-name">Auto-center</div>';
            html += '</div>';

            // Split screen layout
            var splitSelected = settings.reframeMode === 'split_screen' ? ' selected' : '';
            html += '<div class="reframe-layout-card' + splitSelected + '" onclick="app.setReframeMode(\'split_screen\')">';
            html += '<div class="reframe-layout-diagram split-screen">';
            html += '<div class="layout-section"><div class="layout-face-small"></div></div>';
            html += '<div class="layout-section"><div class="layout-face-small"></div></div>';
            html += '</div>';
            html += '<div class="reframe-layout-name">Split</div>';
            html += '</div>';

            // Three person layout
            var threeSelected = settings.reframeMode === 'three_person' ? ' selected' : '';
            html += '<div class="reframe-layout-card' + threeSelected + '" onclick="app.setReframeMode(\'three_person\')">';
            html += '<div class="reframe-layout-diagram three-person">';
            html += '<div class="layout-section-top"><div class="layout-face-main"></div></div>';
            html += '<div class="layout-section-bottom"><div class="layout-face-small"></div><div class="layout-face-small"></div></div>';
            html += '</div>';
            html += '<div class="reframe-layout-name">Three</div>';
            html += '</div>';

            // Gameplay layout
            var gameSelected = settings.reframeMode === 'gameplay' ? ' selected' : '';
            html += '<div class="reframe-layout-card' + gameSelected + '" onclick="app.setReframeMode(\'gameplay\')">';
            html += '<div class="reframe-layout-diagram gameplay">';
            html += '<div class="layout-game-area"><span class="layout-game-icon">ðŸŽ®</span></div>';
            html += '<div class="layout-cam-area"><div class="layout-face-cam"></div></div>';
            html += '</div>';
            html += '<div class="reframe-layout-name">Gameplay</div>';
            html += '</div>';

            // B-Roll split layout
            var brollSelected = settings.reframeMode === 'broll_split' ? ' selected' : '';
            html += '<div class="reframe-layout-card' + brollSelected + '" onclick="app.setReframeMode(\'broll_split\')">';
            html += '<div class="reframe-layout-diagram broll-split">';
            html += '<div class="layout-main-area"><div class="layout-face-broll"></div></div>';
            html += '<div class="layout-broll-area">B-Roll</div>';
            html += '</div>';
            html += '<div class="reframe-layout-name">B-Roll</div>';
            html += '</div>';

            html += '</div>';
            html += '</div>';

            // Timeline Panel with waveform and draggable handles
            html += '<div class="customization-panel">';
            html += '<div class="panel-header">';
            html += '<span class="panel-icon">âœ‚ï¸</span>';
            html += '<span class="panel-title">TRIM CLIP</span>';
            html += '</div>';

            var trimStart = settings.trimStart || 0;
            var trimEnd = settings.trimEnd || activeClip.duration;
            var trimDuration = trimEnd - trimStart;
            var startPercent = (trimStart / activeClip.duration) * 100;
            var widthPercent = (trimDuration / activeClip.duration) * 100;

            html += '<div class="timeline-container">';

            // Duration header
            html += '<div class="timeline-header">';
            html += '<div class="timeline-duration">';
            html += '<span class="timeline-duration-label">Duration:</span>';
            html += '<span class="timeline-duration-value">' + utils.formatDuration(trimDuration) + '</span>';
            html += '</div>';
            html += '<div class="timeline-fine-tune">';
            html += '<button class="timeline-fine-btn" onclick="app.adjustTrim(\'start\', -1)" title="Start -1s">â—€</button>';
            html += '<button class="timeline-fine-btn" onclick="app.adjustTrim(\'start\', 1)" title="Start +1s">â–¶</button>';
            html += '<span style="width:8px"></span>';
            html += '<button class="timeline-fine-btn" onclick="app.adjustTrim(\'end\', -1)" title="End -1s">â—€</button>';
            html += '<button class="timeline-fine-btn" onclick="app.adjustTrim(\'end\', 1)" title="End +1s">â–¶</button>';
            html += '</div>';
            html += '</div>';

            // Waveform visualization
            html += '<div class="timeline-waveform">';
            html += '<div class="waveform-bars">';
            for (var i = 0; i < 50; i++) {
                var barHeight = 20 + Math.random() * 60;
                var barPos = (i / 50) * 100;
                var isActive = barPos >= startPercent && barPos <= (startPercent + widthPercent);
                html += '<div class="waveform-bar' + (isActive ? ' active' : '') + '" style="height:' + barHeight + '%"></div>';
            }
            html += '</div>';
            html += '</div>';

            // Timeline bar with handles
            html += '<div class="timeline-bar" id="timeline-bar">';
            html += '<div class="timeline-fill" style="left:' + startPercent + '%; width:' + widthPercent + '%"></div>';
            html += '<div class="timeline-handle" id="handle-start" style="left:' + startPercent + '%" data-handle="start"></div>';
            html += '<div class="timeline-handle" id="handle-end" style="left:' + (startPercent + widthPercent) + '%" data-handle="end"></div>';
            html += '</div>';

            // Time display
            html += '<div class="timeline-times">';
            html += '<span>' + utils.formatDuration(trimStart) + '</span>';
            html += '<span>' + utils.formatDuration(trimEnd) + '</span>';
            html += '</div>';

            html += '</div>';
            html += '</div>';

            // Audio Panel with enhanced controls
            html += '<div class="customization-panel">';
            html += '<div class="panel-header">';
            html += '<span class="panel-icon">ðŸ”Š</span>';
            html += '<span class="panel-title">AUDIO</span>';
            html += '</div>';

            // Voice enhancement section
            html += '<div class="audio-section-title">Voice Enhancement</div>';
            html += '<div class="audio-options">';

            var audioCheckedFiller = settings.removeFiller ? ' checked' : '';
            html += '<label class="audio-option' + audioCheckedFiller + '">';
            html += '<input type="checkbox" ' + (settings.removeFiller ? 'checked' : '') + ' onchange="app.toggleAudioOption(\'removeFiller\')">';
            html += '<div class="audio-option-text">';
            html += '<div class="audio-option-title">Remove filler words</div>';
            html += '<div class="audio-option-desc">AI removes um, uh, like, you know</div>';
            html += '</div>';
            html += '</label>';

            var audioCheckedEnhance = settings.enhanceAudio ? ' checked' : '';
            html += '<label class="audio-option' + audioCheckedEnhance + '">';
            html += '<input type="checkbox" ' + (settings.enhanceAudio ? 'checked' : '') + ' onchange="app.toggleAudioOption(\'enhanceAudio\')">';
            html += '<div class="audio-option-text">';
            html += '<div class="audio-option-title">Enhance audio quality</div>';
            html += '<div class="audio-option-desc">Noise reduction & normalization</div>';
            html += '</div>';
            html += '</label>';

            var audioCheckedDucking = settings.audioDucking ? ' checked' : '';
            html += '<label class="audio-option' + audioCheckedDucking + '">';
            html += '<input type="checkbox" ' + (settings.audioDucking ? 'checked' : '') + ' onchange="app.toggleAudioOption(\'audioDucking\')">';
            html += '<div class="audio-option-text">';
            html += '<div class="audio-option-title">Smart audio ducking</div>';
            html += '<div class="audio-option-desc">Auto-lower music during speech</div>';
            html += '</div>';
            html += '</label>';

            html += '</div>';

            // Volume control
            html += '<div class="audio-section-title">Volume Control</div>';
            var voiceVolume = settings.voiceVolume || 100;
            html += '<div class="audio-volume-control">';
            html += '<span class="volume-icon">ðŸŽ™ï¸</span>';
            html += '<div class="volume-slider-container">';
            html += '<div class="volume-slider-label">';
            html += '<span>Voice Volume</span>';
            html += '<span class="volume-slider-value">' + voiceVolume + '%</span>';
            html += '</div>';
            html += '<input type="range" class="volume-slider" min="0" max="150" value="' + voiceVolume + '" oninput="app.setVolume(\'voice\', this.value)">';
            html += '</div>';
            html += '</div>';

            // Background music
            html += '<div class="audio-section-title">Background Music</div>';
            var musicChecked = settings.addMusic ? ' checked' : '';
            html += '<label class="audio-option' + musicChecked + '">';
            html += '<input type="checkbox" ' + (settings.addMusic ? 'checked' : '') + ' onchange="app.toggleAudioOption(\'addMusic\')">';
            html += '<div class="audio-option-text">';
            html += '<div class="audio-option-title">Add background music</div>';
            html += '<div class="audio-option-desc">Royalty-free trending tracks</div>';
            html += '</div>';
            html += '</label>';

            // Music library (shown when addMusic is enabled)
            if (settings.addMusic) {
                var musicVolume = settings.musicVolume || 30;
                html += '<div class="audio-volume-control" style="margin-top:0.75rem">';
                html += '<span class="volume-icon">ðŸŽµ</span>';
                html += '<div class="volume-slider-container">';
                html += '<div class="volume-slider-label">';
                html += '<span>Music Volume</span>';
                html += '<span class="volume-slider-value">' + musicVolume + '%</span>';
                html += '</div>';
                html += '<input type="range" class="volume-slider" min="0" max="100" value="' + musicVolume + '" oninput="app.setVolume(\'music\', this.value)">';
                html += '</div>';
                html += '</div>';

                html += '<div class="music-library">';
                html += '<div class="music-tracks">';

                var musicTracks = [
                    { id: 'upbeat1', name: 'Energetic Rise', genre: 'Upbeat', duration: '2:45' },
                    { id: 'chill1', name: 'Lofi Dreams', genre: 'Chill', duration: '3:12' },
                    { id: 'epic1', name: 'Cinematic Power', genre: 'Epic', duration: '2:30' },
                    { id: 'electronic1', name: 'Digital Future', genre: 'Electronic', duration: '2:58' },
                    { id: 'ambient1', name: 'Peaceful Flow', genre: 'Ambient', duration: '4:05' }
                ];

                musicTracks.forEach(function(track) {
                    var trackSelected = settings.selectedTrack === track.id ? ' selected' : '';
                    html += '<div class="music-track' + trackSelected + '" onclick="app.selectMusicTrack(\'' + track.id + '\')">';
                    html += '<div class="music-track-play">â–¶</div>';
                    html += '<div class="music-track-info">';
                    html += '<div class="music-track-name">' + track.name + '</div>';
                    html += '<div class="music-track-meta">' + track.genre + '</div>';
                    html += '</div>';
                    html += '<div class="music-track-duration">' + track.duration + '</div>';
                    html += '</div>';
                });

                html += '</div>';
                html += '</div>';
            }

            html += '</div>';

            // Transitions & Effects Panel
            html += '<div class="customization-panel">';
            html += '<div class="panel-header">';
            html += '<span class="panel-icon">âœ¨</span>';
            html += '<span class="panel-title">TRANSITIONS & EFFECTS</span>';
            html += '</div>';

            // Intro transitions
            html += '<div class="audio-section-title">Intro Transition</div>';
            html += '<div class="transition-options">';
            var introTransitions = [
                { id: 'none', name: 'None', icon: 'â€”' },
                { id: 'fade', name: 'Fade In', icon: 'â—' },
                { id: 'zoom', name: 'Zoom In', icon: 'âŠ•' },
                { id: 'slide', name: 'Slide In', icon: 'â†’' },
                { id: 'glitch', name: 'Glitch', icon: 'âš¡' }
            ];
            var currentIntro = settings.introTransition || 'none';
            introTransitions.forEach(function(t) {
                var selectedClass = currentIntro === t.id ? ' selected' : '';
                html += '<button class="transition-btn' + selectedClass + '" onclick="app.setTransition(\'intro\', \'' + t.id + '\')">';
                html += '<span class="transition-icon">' + t.icon + '</span>';
                html += '<span>' + t.name + '</span>';
                html += '</button>';
            });
            html += '</div>';

            // Outro transitions
            html += '<div class="audio-section-title">Outro Transition</div>';
            html += '<div class="transition-options">';
            var outroTransitions = [
                { id: 'none', name: 'None', icon: 'â€”' },
                { id: 'fade', name: 'Fade Out', icon: 'â—‘' },
                { id: 'zoom', name: 'Zoom Out', icon: 'âŠ–' },
                { id: 'slide', name: 'Slide Out', icon: 'â†' }
            ];
            var currentOutro = settings.outroTransition || 'none';
            outroTransitions.forEach(function(t) {
                var selectedClass = currentOutro === t.id ? ' selected' : '';
                html += '<button class="transition-btn' + selectedClass + '" onclick="app.setTransition(\'outro\', \'' + t.id + '\')">';
                html += '<span class="transition-icon">' + t.icon + '</span>';
                html += '<span>' + t.name + '</span>';
                html += '</button>';
            });
            html += '</div>';

            // Visual effects
            html += '<div class="audio-section-title">Visual Effects</div>';
            html += '<div class="effect-options">';

            var effectZoom = settings.autoZoom ? ' checked' : '';
            html += '<label class="audio-option' + effectZoom + '">';
            html += '<input type="checkbox" ' + (settings.autoZoom ? 'checked' : '') + ' onchange="app.toggleEffect(\'autoZoom\')">';
            html += '<div class="audio-option-text">';
            html += '<div class="audio-option-title">Auto Zoom on Key Moments</div>';
            html += '<div class="audio-option-desc">Subtle zoom on emphasis points</div>';
            html += '</div>';
            html += '</label>';

            var effectVignette = settings.vignette ? ' checked' : '';
            html += '<label class="audio-option' + effectVignette + '">';
            html += '<input type="checkbox" ' + (settings.vignette ? 'checked' : '') + ' onchange="app.toggleEffect(\'vignette\')">';
            html += '<div class="audio-option-text">';
            html += '<div class="audio-option-title">Cinematic Vignette</div>';
            html += '<div class="audio-option-desc">Dark edges for focus effect</div>';
            html += '</div>';
            html += '</label>';

            var effectCG = settings.colorGrade ? ' checked' : '';
            html += '<label class="audio-option' + effectCG + '">';
            html += '<input type="checkbox" ' + (settings.colorGrade ? 'checked' : '') + ' onchange="app.toggleEffect(\'colorGrade\')">';
            html += '<div class="audio-option-text">';
            html += '<div class="audio-option-title">Auto Color Grading</div>';
            html += '<div class="audio-option-desc">Enhance colors for social media</div>';
            html += '</div>';
            html += '</label>';

            html += '</div>';
            html += '</div>';

            // AI Features Bar
            html += '<div class="ai-features-bar">';
            html += '<button class="ai-feature-btn" onclick="app.applyAIFeature(\'clipping\')"><span class="ai-btn-icon">âœ‚ï¸</span> AI Clipping</button>';
            html += '<button class="ai-feature-btn" onclick="app.applyAIFeature(\'captioning\')"><span class="ai-btn-icon">ðŸ’¬</span> AI Captions</button>';
            html += '<button class="ai-feature-btn" onclick="app.applyAIFeature(\'reframe\')"><span class="ai-btn-icon">ðŸ”²</span> AI Reframe</button>';
            html += '<button class="ai-feature-btn" onclick="app.applyAIFeature(\'broll\')"><span class="ai-btn-icon">ðŸŽ¨</span> AI B-Roll</button>';
            html += '<button class="ai-feature-btn" onclick="app.applyAIFeature(\'audio\')"><span class="ai-btn-icon">ðŸ”Š</span> AI Audio</button>';
            html += '<button class="ai-feature-btn" onclick="app.applyAIFeature(\'hook\')"><span class="ai-btn-icon">ðŸª</span> AI Hook</button>';
            html += '</div>';

            html += '</div>'; // customization-panels
            html += '</div>'; // customization-layout

            // Navigation
            html += '<div class="wizard-nav">';
            html += '<div class="wizard-nav-left">';
            html += '<button class="btn-secondary" onclick="app.goToStep(3)">â† Back to Clips</button>';
            html += '</div>';
            html += '<div class="wizard-nav-right">';
            html += '<button class="btn-secondary" onclick="app.saveProject()" style="margin-right:0.75rem">ðŸ’¾ Save</button>';
            html += '<button class="btn-primary" onclick="app.goToStep(5)">SEO & Thumbnails â†’</button>';
            html += '</div>';
            html += '</div>';

            return html;
        }

        function getDefaultSettings() {
            return {
                // Caption settings
                captionStyle: 'karaoke',

                // Reframe settings
                reframeMode: 'auto_center',

                // Timeline/trim settings
                trimStart: 0,
                trimEnd: null,

                // Audio settings
                removeFiller: false,
                enhanceAudio: true,
                audioDucking: true,
                voiceVolume: 100,
                addMusic: false,
                musicVolume: 30,
                selectedTrack: null,

                // Transition settings
                introTransition: 'none',
                outroTransition: 'none',

                // Visual effects
                autoZoom: false,
                vignette: false,
                colorGrade: false
            };
        }

        /* ==========================================
           STEP 5: SEO & THUMBNAILS
           ========================================== */

        function renderStep5SEO() {
            var selectedClips = state.clips.filter(function(c) {
                return state.selectedClipIds.indexOf(c.id) !== -1;
            });
            var activeClip = selectedClips[state.customization.activeClipIndex] || selectedClips[0];
            var seo = state.clipSEO[activeClip.id] || getDefaultSEO(activeClip);

            var html = '';

            // Clip navigation
            html += '<div class="clips-header">';
            html += '<h2>SEO & Thumbnails: Clip ' + (state.customization.activeClipIndex + 1) + '</h2>';
            html += '<div class="clip-nav" style="margin-top:0">';
            html += '<button class="clip-nav-btn" onclick="app.prevClip()" ' + (state.customization.activeClipIndex === 0 ? 'disabled' : '') + '>â† Prev</button>';
            html += '<span class="clip-counter">' + (state.customization.activeClipIndex + 1) + ' / ' + selectedClips.length + '</span>';
            html += '<button class="clip-nav-btn" onclick="app.nextClip()" ' + (state.customization.activeClipIndex >= selectedClips.length - 1 ? 'disabled' : '') + '>Next â†’</button>';
            html += '</div>';
            html += '</div>';

            html += '<div class="seo-layout">';

            // Left: SEO Fields
            html += '<div class="seo-panel">';

            // Title
            html += '<div class="seo-field">';
            html += '<div class="seo-label">';
            html += '<span>TITLE (auto-generated)</span>';
            html += '<span class="char-count">' + (seo.title ? seo.title.length : 0) + '/100</span>';
            html += '</div>';
            html += '<div style="display:flex;gap:0.5rem">';
            html += '<input type="text" class="seo-input" id="seo-title" value="' + utils.escapeHtml(seo.title) + '" oninput="app.updateSEO(\'title\', this.value)">';
            html += '<button class="regenerate-btn" onclick="app.regenerateSEO(\'title\')">ðŸ”„</button>';
            html += '</div>';
            html += '</div>';

            // Description
            html += '<div class="seo-field">';
            html += '<div class="seo-label">';
            html += '<span>DESCRIPTION</span>';
            html += '<span class="char-count">' + (seo.description ? seo.description.length : 0) + '</span>';
            html += '</div>';
            html += '<textarea class="seo-input seo-textarea" id="seo-description" oninput="app.updateSEO(\'description\', this.value)">' + utils.escapeHtml(seo.description) + '</textarea>';
            html += '</div>';

            // Tags
            html += '<div class="seo-field">';
            html += '<div class="seo-label">';
            html += '<span>TAGS</span>';
            html += '</div>';
            html += '<div class="tags-container">';
            if (seo.tags) {
                seo.tags.forEach(function(tag, index) {
                    html += '<span class="tag">' + utils.escapeHtml(tag) + ' <span class="tag-remove" onclick="app.removeTag(' + index + ')">Ã—</span></span>';
                });
            }
            html += '<button class="add-tag-btn" onclick="app.addTag()">+ Add</button>';
            html += '</div>';
            html += '</div>';

            html += '</div>'; // seo-panel

            // Right: Thumbnails
            html += '<div class="seo-panel thumbnails-panel">';
            html += '<h3>AI THUMBNAILS (A/B Testing)</h3>';

            // Get generated thumbnails - check for nested structure from backend
            var thumbnailData = state.clipThumbnails[activeClip.id];
            var thumbnails = [];
            if (thumbnailData) {
                // Handle both array and object with thumbnails property
                thumbnails = Array.isArray(thumbnailData) ? thumbnailData :
                    (thumbnailData.thumbnails || []);
            }

            var selectedThumbnailIdx = state.selectedThumbnail && state.selectedThumbnail[activeClip.id] !== undefined
                ? state.selectedThumbnail[activeClip.id] : 0;

            var hasGeneratedThumbnails = thumbnails.length > 0 && thumbnails.some(function(t) {
                var url = t ? (t.previewUrl || t.url || t) : null;
                return url && typeof url === 'string' && !url.includes('picsum.photos');
            });

            html += '<div class="thumbnails-grid">';
            for (var i = 0; i < 2; i++) {
                var selectedClass = i === selectedThumbnailIdx ? ' selected' : '';
                var thumb = thumbnails[i];
                var thumbUrl = null;

                if (thumb) {
                    thumbUrl = thumb.previewUrl || thumb.url || (typeof thumb === 'string' ? thumb : null);
                }

                var isValidThumbnail = thumbUrl && typeof thumbUrl === 'string' &&
                    thumbUrl.startsWith('http') && !thumbUrl.includes('picsum.photos');

                html += '<div class="thumbnail-option' + selectedClass + '" onclick="app.selectThumbnail(' + i + ')">';

                if (isValidThumbnail) {
                    html += '<img src="' + utils.escapeHtml(thumbUrl) + '" alt="Thumbnail Option ' + String.fromCharCode(65 + i) + '">';
                    html += '<button class="thumbnail-download-btn" onclick="event.stopPropagation(); app.downloadThumbnail(\'' + activeClip.id + '\', ' + i + ')" title="Download">â†“</button>';
                } else {
                    // Show placeholder with clip frame
                    html += '<div class="thumbnail-placeholder">';
                    if (activeClip.thumbnail) {
                        html += '<img src="' + utils.escapeHtml(activeClip.thumbnail) + '" alt="Frame" style="opacity: 0.3; width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0;">';
                    }
                    html += '<div style="position: relative; z-index: 1; text-align: center;">';
                    html += '<span style="font-size: 1.5rem;">ðŸŽ¨</span>';
                    html += '<span style="display: block; font-size: 0.65rem; margin-top: 0.25rem;">Not Generated</span>';
                    html += '</div>';
                    html += '</div>';
                }

                html += '<span class="thumbnail-label">' + String.fromCharCode(65 + i) + '</span>';
                html += '<div class="thumbnail-radio"></div>';
                html += '</div>';
            }
            html += '</div>';

            // Generate button with status and loading indicator
            if (state.thumbnailGenerating) {
                html += '<button class="regenerate-thumbnails-btn" disabled>';
                html += '<span class="thumbnail-loading-spinner"></span>';
                html += ' Extracting frames & generating...';
                html += '</button>';
                html += '<div class="thumbnail-loading-info">This may take 30-60 seconds as we extract actual frames from your video clip for reference.</div>';
            } else if (hasGeneratedThumbnails) {
                html += '<button class="regenerate-thumbnails-btn" onclick="app.regenerateThumbnails()">ðŸ”„ Regenerate Thumbnails</button>';
            } else {
                html += '<button class="regenerate-thumbnails-btn primary-action" onclick="app.regenerateThumbnails()">ðŸŽ¨ Generate AI Thumbnails</button>';
            }

            html += '</div>'; // thumbnails-panel

            html += '</div>'; // seo-layout

            // Navigation
            html += '<div class="wizard-nav">';
            html += '<div class="wizard-nav-left">';
            html += '<button class="btn-secondary" onclick="app.goToStep(4)">â† Back</button>';
            html += '</div>';
            html += '<div class="wizard-nav-right">';
            html += '<button class="btn-primary" onclick="app.goToStep(6)">Export All â†’</button>';
            html += '</div>';
            html += '</div>';

            return html;
        }

        /* ==========================================
           STEP 6: EXPORT
           ========================================== */

        function renderStep6Export() {
            var selectedClips = state.clips.filter(function(c) {
                return state.selectedClipIds.indexOf(c.id) !== -1;
            });

            // Count AI enhancements applied
            var aiFeatureCount = 0;
            selectedClips.forEach(function(clip) {
                if (state.clipBRoll && state.clipBRoll[clip.id]) aiFeatureCount++;
                if (state.clipHooks && state.clipHooks[clip.id]) aiFeatureCount++;
                if (state.clipFillers && state.clipFillers[clip.id]) aiFeatureCount++;
            });

            var html = '';

            // Header
            html += '<div class="export-header">';
            html += '<h2>ðŸŽ‰ Export Ready: ' + selectedClips.length + ' Clips</h2>';
            html += '<div class="export-ready-badge"><span>âœ…</span> All clips processed</div>';
            html += '</div>';

            // Main Container with two columns
            html += '<div class="export-container">';

            // Left: Export Main Panel
            html += '<div class="export-main">';

            // Summary
            html += '<div class="export-summary">';
            html += '<div class="export-summary-title">ðŸ“¦ Export Package Includes:</div>';
            html += '<ul class="export-summary-list">';
            html += '<li>' + selectedClips.length + ' optimized video clips</li>';
            html += '<li>SEO metadata (titles, descriptions, tags)</li>';
            html += '<li>AI-generated thumbnails (3 A/B variants each)</li>';
            if (aiFeatureCount > 0) {
                html += '<li>' + aiFeatureCount + ' AI enhancements (B-Roll, Hooks, Filler removal)</li>';
            }
            html += '<li>Platform-specific export settings</li>';
            html += '</ul>';
            html += '</div>';

            // Export List
            html += '<div class="export-list">';
            selectedClips.forEach(function(clip, index) {
                var seo = state.clipSEO[clip.id] || getDefaultSEO(clip);
                html += '<div class="export-item">';
                html += '<img src="' + clip.thumbnail + '" alt="Clip" class="export-item-thumbnail">';
                html += '<div class="export-item-info">';
                html += '<div class="export-item-title">' + utils.escapeHtml(seo.title || 'Clip ' + (index + 1)) + '</div>';
                html += '<div class="export-item-platforms">â†’ ' + clip.platforms.map(utils.getPlatformName).join(', ') + '</div>';
                html += '</div>';
                html += '<div class="export-item-status"><span>âœ…</span> Ready</div>';
                html += '<div class="export-item-actions">';
                html += '<button class="export-action-btn" onclick="app.downloadClip(\'' + clip.id + '\')">ðŸ“¥ MP4</button>';
                html += '<button class="export-action-btn" onclick="app.downloadThumbnail(\'' + clip.id + '\')">ðŸ–¼ï¸ Thumb</button>';
                html += '<button class="export-action-btn" onclick="app.copySEO(\'' + clip.id + '\')">ðŸ“‹ SEO</button>';
                html += '</div>';
                html += '</div>';
            });
            html += '</div>';

            // Large Export Actions
            html += '<div class="export-actions-large">';
            html += '<button class="export-btn-large primary" onclick="app.exportFullProject(\'json\')">';
            html += '<span class="export-btn-icon">ðŸ“¥</span>';
            html += '<span class="export-btn-label">Download All (JSON)</span>';
            html += '<span class="export-btn-sublabel">Complete project with all AI data</span>';
            html += '</button>';
            html += '<button class="export-btn-large" onclick="app.exportFullProject(\'csv\')">';
            html += '<span class="export-btn-icon">ðŸ“‹</span>';
            html += '<span class="export-btn-label">Export SEO Sheet</span>';
            html += '<span class="export-btn-sublabel">CSV for spreadsheet apps</span>';
            html += '</button>';
            html += '<button class="export-btn-large" onclick="app.saveProject()">';
            html += '<span class="export-btn-icon">ðŸ’¾</span>';
            html += '<span class="export-btn-label">Save Project</span>';
            html += '<span class="export-btn-sublabel">Continue editing later</span>';
            html += '</button>';
            html += '<button class="export-btn-large" onclick="app.startNewProject()">';
            html += '<span class="export-btn-icon">ðŸ”„</span>';
            html += '<span class="export-btn-label">Start New</span>';
            html += '<span class="export-btn-sublabel">Begin a fresh project</span>';
            html += '</button>';
            html += '</div>';

            html += '</div>'; // export-main

            // Right: Sidebar
            html += '<div class="export-sidebar">';

            // Export Format Options
            html += '<div class="export-panel">';
            html += '<h3>ðŸ“ Export Formats</h3>';

            html += '<div class="export-option selected" onclick="app.selectExportFormat(\'full\')">';
            html += '<div class="export-option-icon">ðŸ“¦</div>';
            html += '<div class="export-option-info">';
            html += '<div class="export-option-title">Full Project (JSON)</div>';
            html += '<div class="export-option-desc">All data including AI features</div>';
            html += '</div>';
            html += '<span class="export-option-badge">Recommended</span>';
            html += '</div>';

            html += '<div class="export-option" onclick="app.selectExportFormat(\'seo\')">';
            html += '<div class="export-option-icon">ðŸ“‹</div>';
            html += '<div class="export-option-info">';
            html += '<div class="export-option-title">SEO Only (CSV)</div>';
            html += '<div class="export-option-desc">Titles, descriptions, tags</div>';
            html += '</div>';
            html += '</div>';

            html += '<div class="export-option" onclick="app.selectExportFormat(\'captions\')">';
            html += '<div class="export-option-icon">ðŸ’¬</div>';
            html += '<div class="export-option-info">';
            html += '<div class="export-option-title">Captions (SRT)</div>';
            html += '<div class="export-option-desc">Subtitle files for each clip</div>';
            html += '</div>';
            html += '</div>';

            html += '</div>'; // export-panel

            // YouTube Connection Panel
            html += '<div class="export-panel youtube-connection-panel">';
            html += '<h3>ðŸ”— YouTube Connection</h3>';

            if (state.youtubeConnection.loading) {
                html += '<div class="youtube-connection-status loading">';
                html += '<div class="connection-loading-spinner"></div>';
                html += '<span>Connecting to YouTube...</span>';
                html += '</div>';
            } else if (state.youtubeConnection.connected && state.youtubeConnection.channel) {
                html += '<div class="youtube-connection-status connected">';
                if (state.youtubeConnection.channel.thumbnail) {
                    html += '<img src="' + state.youtubeConnection.channel.thumbnail + '" alt="Channel" class="youtube-channel-thumb">';
                } else {
                    html += '<div class="youtube-channel-icon">âœ“</div>';
                }
                html += '<div class="youtube-channel-info">';
                html += '<div class="youtube-channel-name">' + utils.escapeHtml(state.youtubeConnection.channel.title || 'Connected') + '</div>';
                html += '<div class="youtube-channel-label">YouTube Connected</div>';
                html += '</div>';
                html += '<button class="youtube-disconnect-btn" onclick="app.disconnectYouTube()" title="Disconnect">âœ•</button>';
                html += '</div>';
                html += '<p class="youtube-connection-info">Video export will use your YouTube authentication for best compatibility.</p>';
            } else {
                html += '<p class="youtube-connection-desc">Connect your YouTube account to enable video export. This allows us to download videos on your behalf.</p>';
                if (state.youtubeConnection.error) {
                    html += '<div class="youtube-connection-error">' + utils.escapeHtml(state.youtubeConnection.error) + '</div>';
                }
                html += '<button class="youtube-connect-btn" onclick="app.connectYouTube()">';
                html += '<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>';
                html += ' Connect YouTube Account';
                html += '</button>';
            }
            html += '</div>'; // youtube-connection-panel

            // Quick Links
            html += '<div class="export-panel">';
            html += '<h3>ðŸ”— Quick Navigation</h3>';
            html += '<div class="quick-links">';
            html += '<a href="/video-optimizer" class="quick-link">';
            html += '<span class="quick-link-icon">ðŸ“Š</span> Video Optimizer Dashboard';
            html += '</a>';
            html += '<a href="/aitools.html" class="quick-link">';
            html += '<span class="quick-link-icon">ðŸ¤–</span> AI Tools Suite';
            html += '</a>';
            html += '<a href="/main-dashboard.html" class="quick-link">';
            html += '<span class="quick-link-icon">ðŸ </span> Main Dashboard';
            html += '</a>';
            html += '<a href="/placement-finder.html" class="quick-link">';
            html += '<span class="quick-link-icon">ðŸŽ¯</span> Placement Finder';
            html += '</a>';
            html += '<a href="/campaign.html" class="quick-link">';
            html += '<span class="quick-link-icon">ðŸ“ˆ</span> Campaign Analyzer';
            html += '</a>';
            html += '</div>';
            html += '</div>'; // export-panel

            html += '</div>'; // export-sidebar

            html += '</div>'; // export-container

            // Navigation
            html += '<div class="wizard-nav">';
            html += '<div class="wizard-nav-left">';
            html += '<button class="btn-secondary" onclick="app.goToStep(5)">â† Back to SEO</button>';
            html += '</div>';
            html += '<div class="wizard-nav-right">';
            html += '<a href="/video-optimizer" class="btn-primary">âœ… Done - Go to Dashboard</a>';
            html += '</div>';
            html += '</div>';

            return html;
        }

        /* ==========================================
           4.5 EVENT HANDLERS
           ========================================== */

        function attachEventListeners() {
            // Dropzone drag & drop
            var dropzone = document.getElementById('dropzone');
            if (dropzone) {
                dropzone.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    dropzone.classList.add('dragover');
                });
                dropzone.addEventListener('dragleave', function(e) {
                    dropzone.classList.remove('dragover');
                });
                dropzone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    dropzone.classList.remove('dragover');
                    // Handle file drop
                    if (e.dataTransfer.files.length > 0) {
                        utils.showToast('File upload coming soon!', 'info');
                    }
                });
            }

            // URL input
            var urlInput = document.getElementById('video-url');
            if (urlInput) {
                urlInput.addEventListener('input', function() {
                    state.videoInput.url = this.value;
                });
                urlInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        app.analyzeVideo();
                    }
                });
            }

            // Timeline draggable handles (Step 4)
            var timelineBar = document.getElementById('timeline-bar');
            var handleStart = document.getElementById('handle-start');
            var handleEnd = document.getElementById('handle-end');

            if (timelineBar && handleStart && handleEnd) {
                var isDragging = null;
                var barRect = null;

                function getActiveClipDuration() {
                    var selectedClips = state.clips.filter(function(c) {
                        return state.selectedClipIds.indexOf(c.id) !== -1;
                    });
                    var activeClip = selectedClips[state.customization.activeClipIndex];
                    return activeClip ? activeClip.duration : 60;
                }

                function handleMouseDown(e, handle) {
                    e.preventDefault();
                    isDragging = handle;
                    barRect = timelineBar.getBoundingClientRect();
                    handle.classList.add('dragging');
                    document.body.style.cursor = 'ew-resize';
                }

                function handleMouseMove(e) {
                    if (!isDragging || !barRect) return;

                    var x = e.clientX - barRect.left;
                    var percent = Math.max(0, Math.min(100, (x / barRect.width) * 100));
                    var duration = getActiveClipDuration();
                    var time = Math.round((percent / 100) * duration);

                    var selectedClips = state.clips.filter(function(c) {
                        return state.selectedClipIds.indexOf(c.id) !== -1;
                    });
                    var activeClip = selectedClips[state.customization.activeClipIndex];
                    if (!activeClip) return;

                    var settings = state.clipSettings[activeClip.id] || getDefaultSettings();
                    var trimStart = settings.trimStart || 0;
                    var trimEnd = settings.trimEnd || duration;

                    if (isDragging === handleStart) {
                        // Minimum 5 second clip
                        trimStart = Math.max(0, Math.min(time, trimEnd - 5));
                    } else {
                        // Minimum 5 second clip
                        trimEnd = Math.min(duration, Math.max(time, trimStart + 5));
                    }

                    // Update visually without full re-render
                    var startPercent = (trimStart / duration) * 100;
                    var widthPercent = ((trimEnd - trimStart) / duration) * 100;

                    var fill = timelineBar.querySelector('.timeline-fill');
                    if (fill) {
                        fill.style.left = startPercent + '%';
                        fill.style.width = widthPercent + '%';
                    }
                    handleStart.style.left = startPercent + '%';
                    handleEnd.style.left = (startPercent + widthPercent) + '%';

                    // Update state
                    if (!state.clipSettings[activeClip.id]) {
                        state.clipSettings[activeClip.id] = getDefaultSettings();
                    }
                    state.clipSettings[activeClip.id].trimStart = trimStart;
                    state.clipSettings[activeClip.id].trimEnd = trimEnd;

                    // Update time display
                    var times = document.querySelectorAll('.timeline-times span');
                    if (times.length >= 2) {
                        times[0].textContent = utils.formatDuration(trimStart);
                        times[1].textContent = utils.formatDuration(trimEnd);
                    }

                    // Update duration display
                    var durationValue = document.querySelector('.timeline-duration-value');
                    if (durationValue) {
                        durationValue.textContent = utils.formatDuration(trimEnd - trimStart);
                    }
                }

                function handleMouseUp() {
                    if (isDragging) {
                        isDragging.classList.remove('dragging');
                        isDragging = null;
                        barRect = null;
                        document.body.style.cursor = '';
                        // Update waveform colors
                        render();
                    }
                }

                handleStart.addEventListener('mousedown', function(e) { handleMouseDown(e, handleStart); });
                handleEnd.addEventListener('mousedown', function(e) { handleMouseDown(e, handleEnd); });
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);

                // Touch support
                handleStart.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    handleMouseDown({ clientX: e.touches[0].clientX, preventDefault: function(){} }, handleStart);
                });
                handleEnd.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    handleMouseDown({ clientX: e.touches[0].clientX, preventDefault: function(){} }, handleEnd);
                });
                document.addEventListener('touchmove', function(e) {
                    if (isDragging) {
                        handleMouseMove({ clientX: e.touches[0].clientX });
                    }
                });
                document.addEventListener('touchend', handleMouseUp);
            }
        }

        /* ==========================================
           4.6 APPLICATION METHODS
           ========================================== */

        const app = {
            goToStep: function(step) {
                if (step < 1 || step > 6) return;
                // Validate step transitions
                if (step > state.currentStep + 1) return;
                state.currentStep = step;
                render();
                window.scrollTo(0, 0);
            },

            toggleOption: function(key) {
                state.videoInput.options[key] = !state.videoInput.options[key];
                render();
            },

            analyzeVideo: async function() {
                var url = state.videoInput.url.trim();
                if (!url) {
                    utils.showToast('Please enter a video URL', 'error');
                    return;
                }

                if (!state.user) {
                    utils.showToast('Please sign in to analyze videos', 'error');
                    return;
                }

                // Reset analysis state
                state.currentStep = 2;
                state.analysis.status = 'processing';
                state.analysis.progress = 0;
                state.analysis.error = null;
                state.analysis.steps.forEach(function(step) {
                    step.status = 'pending';
                });
                render();

                // Call Cloud Function with progress simulation
                try {
                    // Simulate progress steps during API call
                    var progressInterval = setInterval(function() {
                        var pendingSteps = state.analysis.steps.filter(function(s) { return s.status === 'pending'; });
                        if (pendingSteps.length > 0 && state.analysis.status === 'processing') {
                            var currentIdx = state.analysis.steps.length - pendingSteps.length;
                            if (currentIdx < state.analysis.steps.length) {
                                state.analysis.steps[currentIdx].status = 'processing';
                                state.analysis.progress = Math.round((currentIdx / state.analysis.steps.length) * 80);
                                render();
                                setTimeout(function() {
                                    if (state.analysis.status === 'processing') {
                                        state.analysis.steps[currentIdx].status = 'done';
                                        render();
                                    }
                                }, 2000);
                            }
                        }
                    }, 3000);

                    var wizardAnalyzeVideo = functions.httpsCallable('wizardAnalyzeVideo');
                    var result = await wizardAnalyzeVideo({
                        videoUrl: url,
                        options: state.videoInput.options
                    });

                    clearInterval(progressInterval);

                    if (result.data.success) {
                        // Mark all steps as done
                        state.analysis.steps.forEach(function(step) {
                            step.status = 'done';
                        });
                        state.analysis.progress = 100;
                        state.analysis.status = 'done';

                        // Store project and video data
                        state.projectId = result.data.projectId;
                        // Backend returns videoData, not videoInfo
                        state.videoInput.videoData = result.data.videoData || result.data.videoInfo;
                        state.clips = result.data.clips || [];

                        // Auto-select top 5 clips
                        state.selectedClipIds = state.clips.slice(0, 5).map(function(c) { return c.id; });

                        render();

                        // Transition to clip selection after a moment
                        setTimeout(function() {
                            state.currentStep = 3;
                            render();
                        }, 1000);
                    } else {
                        throw new Error(result.data.error || 'Analysis failed');
                    }
                } catch (error) {
                    console.error('Analysis error:', error);
                    state.analysis.status = 'error';
                    state.analysis.error = error.message || 'Failed to analyze video';
                    utils.showToast('Error: ' + (error.message || 'Analysis failed'), 'error');
                    render();
                }
            },

            selectAllClips: function() {
                state.selectedClipIds = state.clips.map(function(c) { return c.id; });
                render();
            },

            deselectAllClips: function() {
                state.selectedClipIds = [];
                render();
            },

            toggleClipSelection: function(clipId) {
                var index = state.selectedClipIds.indexOf(clipId);
                if (index === -1) {
                    state.selectedClipIds.push(clipId);
                } else {
                    state.selectedClipIds.splice(index, 1);
                }
                render();
            },

            // Video Preview Functions
            previewClip: function(clipId) {
                var clip = state.clips.find(function(c) { return c.id === clipId; });
                if (!clip) {
                    utils.showToast('Clip not found', 'error');
                    return;
                }

                var videoId = state.videoInput.videoData ? state.videoInput.videoData.videoId : null;
                if (!videoId) {
                    // Try to extract from clip thumbnail URL
                    var match = clip.thumbnail.match(/\/vi\/([^\/]+)\//);
                    if (match) {
                        videoId = match[1];
                    }
                }

                if (!videoId) {
                    utils.showToast('Video ID not found', 'error');
                    return;
                }

                var isSelected = state.selectedClipIds.indexOf(clipId) !== -1;
                var startTime = Math.floor(clip.startTime || 0);
                var endTime = Math.floor(clip.endTime || (startTime + clip.duration));

                // Build YouTube embed URL with start and end times
                var embedUrl = 'https://www.youtube.com/embed/' + videoId +
                    '?start=' + startTime +
                    '&end=' + endTime +
                    '&autoplay=1&rel=0&modestbranding=1';

                var modalHtml = '<div class="video-preview-modal" onclick="app.closeVideoPreview(event)">';
                modalHtml += '<div class="video-preview-content" onclick="event.stopPropagation()">';

                // Header
                modalHtml += '<div class="video-preview-header">';
                modalHtml += '<h3>Preview Clip - ' + utils.formatDuration(clip.duration) + '</h3>';
                modalHtml += '<button class="video-preview-close" onclick="app.closeVideoPreview()">Ã—</button>';
                modalHtml += '</div>';

                // Player
                modalHtml += '<div class="video-preview-player">';
                modalHtml += '<iframe src="' + embedUrl + '" allow="autoplay; encrypted-media" allowfullscreen></iframe>';
                modalHtml += '</div>';

                // Info
                modalHtml += '<div class="video-preview-info">';
                modalHtml += '<div class="video-preview-meta">';
                modalHtml += '<div class="video-preview-meta-item"><span>â±ï¸</span> ' + utils.formatDuration(startTime) + ' - ' + utils.formatDuration(endTime) + '</div>';
                modalHtml += '<div class="video-preview-meta-item"><span>ðŸ”¥</span> Virality: ' + clip.score + '%</div>';
                modalHtml += '<div class="video-preview-meta-item"><span>ðŸ“±</span> ' + clip.platforms.map(utils.getPlatformName).join(', ') + '</div>';
                modalHtml += '</div>';
                modalHtml += '<div class="video-preview-transcript">"' + utils.escapeHtml(clip.transcript) + '"</div>';
                modalHtml += '</div>';

                // Actions
                modalHtml += '<div class="video-preview-actions">';
                modalHtml += '<button class="btn-secondary" onclick="app.closeVideoPreview()">Close</button>';
                if (isSelected) {
                    modalHtml += '<button class="btn-select selected" onclick="app.toggleClipFromPreview(\'' + clipId + '\')">âœ“ Selected</button>';
                } else {
                    modalHtml += '<button class="btn-select" onclick="app.toggleClipFromPreview(\'' + clipId + '\')">+ Select Clip</button>';
                }
                modalHtml += '</div>';

                modalHtml += '</div>'; // content
                modalHtml += '</div>'; // modal

                // Append modal to body
                var modalContainer = document.createElement('div');
                modalContainer.id = 'video-preview-container';
                modalContainer.innerHTML = modalHtml;
                document.body.appendChild(modalContainer);
            },

            closeVideoPreview: function(event) {
                if (event && event.target !== event.currentTarget) return;
                var container = document.getElementById('video-preview-container');
                if (container) {
                    container.remove();
                }
            },

            toggleClipFromPreview: function(clipId) {
                var index = state.selectedClipIds.indexOf(clipId);
                if (index === -1) {
                    state.selectedClipIds.push(clipId);
                } else {
                    state.selectedClipIds.splice(index, 1);
                }
                // Re-render the preview modal with updated button
                app.closeVideoPreview();
                app.previewClip(clipId);
                render();
            },

            prevClip: function() {
                if (state.customization.activeClipIndex > 0) {
                    state.customization.activeClipIndex--;
                    render();
                }
            },

            nextClip: function() {
                var selectedCount = state.selectedClipIds.length;
                if (state.customization.activeClipIndex < selectedCount - 1) {
                    state.customization.activeClipIndex++;
                    render();
                }
            },

            setCaptionStyle: function(style) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                state.clipSettings[activeClip.id].captionStyle = style;
                render();
            },

            setReframeMode: function(mode) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                state.clipSettings[activeClip.id].reframeMode = mode;
                render();
            },

            toggleAudioOption: function(option) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                state.clipSettings[activeClip.id][option] = !state.clipSettings[activeClip.id][option];
                render();
            },

            // Volume control
            setVolume: function(type, value) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                if (type === 'voice') {
                    state.clipSettings[activeClip.id].voiceVolume = parseInt(value);
                } else if (type === 'music') {
                    state.clipSettings[activeClip.id].musicVolume = parseInt(value);
                }
                // Update display without full re-render
                var valueSpan = document.querySelector('.volume-slider-container .volume-slider[value="' + value + '"]');
                if (valueSpan) {
                    var label = valueSpan.parentElement.querySelector('.volume-slider-value');
                    if (label) label.textContent = value + '%';
                }
            },

            // Music track selection
            selectMusicTrack: function(trackId) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                state.clipSettings[activeClip.id].selectedTrack = trackId;
                render();
                utils.showToast('Track selected', 'success');
            },

            // Transitions
            setTransition: function(type, transitionId) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                if (type === 'intro') {
                    state.clipSettings[activeClip.id].introTransition = transitionId;
                } else {
                    state.clipSettings[activeClip.id].outroTransition = transitionId;
                }
                render();
            },

            // Visual effects
            toggleEffect: function(effectName) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                state.clipSettings[activeClip.id][effectName] = !state.clipSettings[activeClip.id][effectName];
                render();
            },

            // Timeline trimming
            adjustTrim: function(handle, delta) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                var settings = state.clipSettings[activeClip.id];
                var trimStart = settings.trimStart || 0;
                var trimEnd = settings.trimEnd || activeClip.duration;

                if (handle === 'start') {
                    trimStart = Math.max(0, Math.min(trimStart + delta, trimEnd - 5));
                } else {
                    trimEnd = Math.min(activeClip.duration, Math.max(trimEnd + delta, trimStart + 5));
                }

                state.clipSettings[activeClip.id].trimStart = trimStart;
                state.clipSettings[activeClip.id].trimEnd = trimEnd;
                render();
            },

            setTrim: function(start, end) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                state.clipSettings[activeClip.id].trimStart = Math.max(0, start);
                state.clipSettings[activeClip.id].trimEnd = Math.min(activeClip.duration, end);
                render();
            },

            // AI feature application
            applyAIFeature: async function(feature) {
                if (!state.projectId) {
                    utils.showToast('No project loaded', 'error');
                    return;
                }

                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!activeClip) {
                    utils.showToast('No clip selected', 'error');
                    return;
                }

                var featureNames = {
                    clipping: 'AI Clipping',
                    captioning: 'AI Captioning',
                    reframe: 'AI Reframe',
                    broll: 'AI B-Roll',
                    audio: 'AI Audio Enhancement',
                    hook: 'AI Hook Generation'
                };

                utils.showToast('Applying ' + (featureNames[feature] || feature) + '...', 'info');

                try {
                    var result;
                    switch (feature) {
                        case 'broll':
                            var wizardGenerateBRoll = functions.httpsCallable('wizardGenerateBRoll');
                            result = await wizardGenerateBRoll({
                                projectId: state.projectId,
                                clipId: activeClip.id
                            });
                            if (result.data.success) {
                                state.clipBRoll = state.clipBRoll || {};
                                state.clipBRoll[activeClip.id] = result.data.brollSuggestions;
                                utils.showToast('Generated ' + result.data.brollSuggestions.length + ' B-Roll suggestions!', 'success');
                                app.showBRollModal(activeClip.id);
                            }
                            break;

                        case 'hook':
                            var wizardGenerateHook = functions.httpsCallable('wizardGenerateHook');
                            result = await wizardGenerateHook({
                                projectId: state.projectId,
                                clipId: activeClip.id,
                                hookStyle: 'curiosity'
                            });
                            if (result.data.success) {
                                state.clipHooks = state.clipHooks || {};
                                state.clipHooks[activeClip.id] = result.data;
                                utils.showToast('Generated ' + result.data.hooks.length + ' viral hooks!', 'success');
                                app.showHooksModal(activeClip.id);
                            }
                            break;

                        case 'captioning':
                            var wizardGenerateCaptions = functions.httpsCallable('wizardGenerateAICaptions');
                            var settings = state.clipSettings[activeClip.id] || getDefaultSettings();
                            result = await wizardGenerateCaptions({
                                projectId: state.projectId,
                                clipId: activeClip.id,
                                style: settings.captionStyle || 'karaoke'
                            });
                            if (result.data.success) {
                                state.clipCaptions = state.clipCaptions || {};
                                state.clipCaptions[activeClip.id] = result.data;
                                utils.showToast('Generated ' + result.data.captionCount + ' word captions!', 'success');
                            }
                            break;

                        case 'reframe':
                            var wizardDetectSpeakers = functions.httpsCallable('wizardDetectSpeakers');
                            result = await wizardDetectSpeakers({
                                projectId: state.projectId,
                                clipId: activeClip.id
                            });
                            if (result.data.success) {
                                state.clipSpeakers = state.clipSpeakers || {};
                                state.clipSpeakers[activeClip.id] = result.data;
                                // Auto-apply recommended reframe
                                if (result.data.recommendedReframe) {
                                    app.setReframeMode(result.data.recommendedReframe);
                                }
                                utils.showToast('Detected ' + result.data.speakerCount + ' speaker(s). Reframe set to: ' + result.data.recommendedReframe, 'success');
                            }
                            break;

                        case 'audio':
                            var wizardRemoveFillers = functions.httpsCallable('wizardRemoveFillers');
                            result = await wizardRemoveFillers({
                                projectId: state.projectId,
                                clipId: activeClip.id
                            });
                            if (result.data.success) {
                                state.clipFillers = state.clipFillers || {};
                                state.clipFillers[activeClip.id] = result.data;
                                utils.showToast('Found ' + result.data.stats.fillersRemoved + ' filler words. ~' + result.data.stats.estimatedTimeSaved + 's saved!', 'success');
                                app.showFillersModal(activeClip.id);
                            }
                            break;

                        default:
                            utils.showToast('Feature coming soon!', 'info');
                    }
                } catch (error) {
                    console.error('AI feature error:', error);
                    utils.showToast('Error: ' + (error.message || 'Failed to apply AI feature'), 'error');
                }
            },

            // Show B-Roll suggestions modal
            showBRollModal: function(clipId) {
                var suggestions = (state.clipBRoll || {})[clipId] || [];
                if (suggestions.length === 0) {
                    utils.showToast('No B-Roll suggestions available', 'info');
                    return;
                }

                var html = '<div class="ai-modal-overlay" onclick="app.closeAIModal()">';
                html += '<div class="ai-modal" onclick="event.stopPropagation()">';
                html += '<div class="ai-modal-header">';
                html += '<h3>ðŸŽ¬ AI B-Roll Suggestions</h3>';
                html += '<button class="ai-modal-close" onclick="app.closeAIModal()">Ã—</button>';
                html += '</div>';
                html += '<div class="ai-modal-content">';

                suggestions.forEach(function(s, i) {
                    html += '<div class="broll-suggestion">';
                    html += '<div class="broll-number">' + (i + 1) + '</div>';
                    html += '<div class="broll-info">';
                    html += '<div class="broll-desc">' + s.description + '</div>';
                    html += '<div class="broll-meta">';
                    html += '<span class="broll-duration">â±ï¸ ' + s.duration + 's</span>';
                    html += '<span class="broll-placement">ðŸ“ ' + s.placement + '</span>';
                    html += '</div>';
                    html += '<div class="broll-keywords">' + s.keywords.map(function(k) { return '<span class="broll-tag">' + k + '</span>'; }).join('') + '</div>';
                    html += '</div>';
                    html += '</div>';
                });

                html += '</div>';
                html += '</div>';
                html += '</div>';

                var modal = document.createElement('div');
                modal.id = 'ai-modal-container';
                modal.innerHTML = html;
                document.body.appendChild(modal);
            },

            // Show hooks modal
            showHooksModal: function(clipId) {
                var hookData = (state.clipHooks || {})[clipId];
                if (!hookData || !hookData.hooks) {
                    utils.showToast('No hooks available', 'info');
                    return;
                }

                var html = '<div class="ai-modal-overlay" onclick="app.closeAIModal()">';
                html += '<div class="ai-modal" onclick="event.stopPropagation()">';
                html += '<div class="ai-modal-header">';
                html += '<h3>ðŸª AI Viral Hooks</h3>';
                html += '<button class="ai-modal-close" onclick="app.closeAIModal()">Ã—</button>';
                html += '</div>';
                html += '<div class="ai-modal-content">';

                hookData.hooks.forEach(function(h, i) {
                    var isRecommended = h.id === hookData.recommendedHook;
                    html += '<div class="hook-suggestion' + (isRecommended ? ' recommended' : '') + '">';
                    if (isRecommended) html += '<span class="hook-badge">â­ Recommended</span>';
                    html += '<div class="hook-text">"' + h.text + '"</div>';
                    html += '<div class="hook-meta">';
                    html += '<span>â±ï¸ ' + h.speakingDuration + 's</span>';
                    html += '<span>ðŸ’¡ ' + h.emotionalTrigger + '</span>';
                    html += '<span>ðŸŽ­ ' + h.voiceDirection + '</span>';
                    html += '</div>';
                    html += '<button class="hook-use-btn" onclick="app.useHook(\'' + clipId + '\', ' + i + ')">Use This Hook</button>';
                    html += '</div>';
                });

                if (hookData.explanation) {
                    html += '<div class="hook-explanation">' + hookData.explanation + '</div>';
                }

                html += '</div>';
                html += '</div>';
                html += '</div>';

                var modal = document.createElement('div');
                modal.id = 'ai-modal-container';
                modal.innerHTML = html;
                document.body.appendChild(modal);
            },

            // Show fillers modal
            showFillersModal: function(clipId) {
                var fillerData = (state.clipFillers || {})[clipId];
                if (!fillerData) {
                    utils.showToast('No filler data available', 'info');
                    return;
                }

                var html = '<div class="ai-modal-overlay" onclick="app.closeAIModal()">';
                html += '<div class="ai-modal" onclick="event.stopPropagation()">';
                html += '<div class="ai-modal-header">';
                html += '<h3>ðŸ”Š Filler Word Analysis</h3>';
                html += '<button class="ai-modal-close" onclick="app.closeAIModal()">Ã—</button>';
                html += '</div>';
                html += '<div class="ai-modal-content">';

                html += '<div class="filler-stats">';
                html += '<div class="filler-stat"><span class="stat-value">' + fillerData.stats.fillersRemoved + '</span><span class="stat-label">Fillers Found</span></div>';
                html += '<div class="filler-stat"><span class="stat-value">~' + fillerData.stats.estimatedTimeSaved + 's</span><span class="stat-label">Time Saved</span></div>';
                html += '<div class="filler-stat"><span class="stat-value">' + fillerData.stats.originalWordCount + ' â†’ ' + fillerData.stats.cleanedWordCount + '</span><span class="stat-label">Words</span></div>';
                html += '</div>';

                html += '<div class="filler-types">';
                Object.keys(fillerData.stats.fillersByType || {}).forEach(function(type) {
                    html += '<span class="filler-type-badge">' + type + ': ' + fillerData.stats.fillersByType[type] + '</span>';
                });
                html += '</div>';

                html += '<div class="filler-transcript">';
                html += '<div class="transcript-label">Cleaned Transcript:</div>';
                html += '<div class="transcript-text">' + fillerData.cleanedTranscript + '</div>';
                html += '</div>';

                html += '</div>';
                html += '</div>';
                html += '</div>';

                var modal = document.createElement('div');
                modal.id = 'ai-modal-container';
                modal.innerHTML = html;
                document.body.appendChild(modal);
            },

            useHook: function(clipId, hookIndex) {
                var hookData = (state.clipHooks || {})[clipId];
                if (hookData && hookData.hooks && hookData.hooks[hookIndex]) {
                    var hook = hookData.hooks[hookIndex];
                    // Store selected hook
                    if (!state.clipSettings[clipId]) {
                        state.clipSettings[clipId] = getDefaultSettings();
                    }
                    state.clipSettings[clipId].selectedHook = hook;
                    utils.showToast('Hook selected: "' + hook.text + '"', 'success');
                    app.closeAIModal();
                }
            },

            closeAIModal: function() {
                var modal = document.getElementById('ai-modal-container');
                if (modal) {
                    modal.remove();
                }
            },

            updateSEO: function(field, value) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSEO[activeClip.id]) {
                    state.clipSEO[activeClip.id] = getDefaultSEO(activeClip);
                }
                state.clipSEO[activeClip.id][field] = value;
                // Don't re-render on every keystroke
            },

            regenerateSEO: async function(field) {
                if (!state.projectId) {
                    utils.showToast('No project loaded', 'error');
                    return;
                }

                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!activeClip) {
                    utils.showToast('No clip selected', 'error');
                    return;
                }

                utils.showToast('Regenerating ' + field + '...', 'info');

                try {
                    var wizardGenerateClipSEO = functions.httpsCallable('wizardGenerateClipSEO');
                    var result = await wizardGenerateClipSEO({
                        projectId: state.projectId,
                        clipId: activeClip.id,
                        transcript: activeClip.transcript,
                        videoTitle: state.videoInput.videoData ? state.videoInput.videoData.title : '',
                        platform: activeClip.platforms ? activeClip.platforms[0] : 'youtube'
                    });

                    if (result.data.success) {
                        // Update local SEO data - backend returns data directly, not nested
                        state.clipSEO[activeClip.id] = {
                            title: result.data.title,
                            description: result.data.description,
                            tags: result.data.tags || [],
                            hashtags: result.data.hashtags || []
                        };
                        render();
                        utils.showToast(field.charAt(0).toUpperCase() + field.slice(1) + ' regenerated!', 'success');
                    } else {
                        throw new Error(result.data.error || 'Failed to regenerate');
                    }
                } catch (error) {
                    console.error('SEO regeneration error:', error);
                    utils.showToast('Error: ' + (error.message || 'Failed to regenerate'), 'error');
                }
            },

            addTag: function() {
                var tag = prompt('Enter a new tag:');
                if (tag && tag.trim()) {
                    var selectedClips = state.clips.filter(function(c) {
                        return state.selectedClipIds.indexOf(c.id) !== -1;
                    });
                    var activeClip = selectedClips[state.customization.activeClipIndex];
                    if (!state.clipSEO[activeClip.id]) {
                        state.clipSEO[activeClip.id] = getDefaultSEO(activeClip);
                    }
                    state.clipSEO[activeClip.id].tags.push(tag.trim());
                    render();
                }
            },

            removeTag: function(index) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (state.clipSEO[activeClip.id]) {
                    state.clipSEO[activeClip.id].tags.splice(index, 1);
                    render();
                }
            },

            selectThumbnail: function(index) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!activeClip) return;

                if (!state.selectedThumbnail) {
                    state.selectedThumbnail = {};
                }
                state.selectedThumbnail[activeClip.id] = index;
                render();
                utils.showToast('Selected thumbnail ' + String.fromCharCode(65 + index), 'success');
            },

            regenerateThumbnails: async function() {
                if (!state.projectId) {
                    utils.showToast('No project loaded', 'error');
                    return;
                }

                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!activeClip) {
                    utils.showToast('No clip selected', 'error');
                    return;
                }

                // Show loading state
                state.thumbnailGenerating = true;
                render();
                utils.showToast('Generating AI thumbnails from video frames...', 'info');

                try {
                    // Use wizardGenerateThumbnails which extracts actual frames from the clip
                    var wizardGenerateThumbnails = functions.httpsCallable('wizardGenerateThumbnails');

                    var result = await wizardGenerateThumbnails({
                        clipId: activeClip.id,
                        transcript: activeClip.transcript || '',
                        projectId: state.projectId,
                        videoTitle: state.videoInput.videoData ? state.videoInput.videoData.title : ''
                    });

                    if (result.data.success && result.data.thumbnails) {
                        state.clipThumbnails[activeClip.id] = result.data.thumbnails;
                        state.thumbnailGenerating = false;
                        render();
                        utils.showToast('Generated ' + result.data.thumbnails.length + ' thumbnails!', 'success');
                    } else {
                        throw new Error(result.data.message || 'Failed to generate thumbnails');
                    }
                } catch (error) {
                    console.error('Thumbnail generation error:', error);
                    state.thumbnailGenerating = false;
                    render();
                    utils.showToast('Error: ' + (error.message || 'Failed to generate'), 'error');
                }
            },

            downloadClip: function(clipId) {
                var clip = state.clips.find(function(c) { return c.id === clipId; });
                if (!clip) {
                    utils.showToast('Clip not found', 'error');
                    return;
                }

                var videoId = state.videoInput.videoData ? state.videoInput.videoData.videoId : null;
                if (!videoId) {
                    // Try to extract from clip thumbnail URL
                    var match = clip.thumbnail.match(/\/vi\/([^\/]+)\//);
                    if (match) {
                        videoId = match[1];
                    }
                }

                var startTime = Math.floor(clip.startTime || 0);
                var endTime = Math.floor(clip.endTime || (startTime + clip.duration));

                // Store current download info for modal
                state.downloadModal = {
                    clipId: clipId,
                    clip: clip,
                    videoId: videoId,
                    startTime: startTime,
                    endTime: endTime,
                    quality: '720p'
                };

                var modalHtml = '<div class="download-modal" onclick="app.closeDownloadModal(event)">';
                modalHtml += '<div class="download-modal-content" onclick="event.stopPropagation()">';

                // Header
                modalHtml += '<div class="download-modal-header">';
                modalHtml += '<h3>Download Clip</h3>';
                modalHtml += '<button class="video-preview-close" onclick="app.closeDownloadModal()">Ã—</button>';
                modalHtml += '</div>';

                // Body
                modalHtml += '<div class="download-modal-body">';

                // Quality options
                modalHtml += '<p style="color: rgba(255,255,255,0.7); margin-bottom: 1rem;">Select video quality:</p>';
                modalHtml += '<div class="download-quality-options">';
                modalHtml += '<div class="quality-option selected" onclick="app.selectDownloadQuality(\'720p\')" id="quality-720p">';
                modalHtml += '<span class="quality-option-label">720p</span>';
                modalHtml += '<span class="quality-option-size">HD â€¢ ~' + Math.round(clip.duration * 1.5) + ' MB</span>';
                modalHtml += '</div>';
                modalHtml += '<div class="quality-option" onclick="app.selectDownloadQuality(\'1080p\')" id="quality-1080p">';
                modalHtml += '<span class="quality-option-label">1080p</span>';
                modalHtml += '<span class="quality-option-size">Full HD â€¢ ~' + Math.round(clip.duration * 3) + ' MB</span>';
                modalHtml += '</div>';
                modalHtml += '</div>';

                // Processing info
                modalHtml += '<div class="download-processing-info">';
                modalHtml += '<div class="processing-info-title">ðŸŽ¬ What you\'ll get:</div>';
                modalHtml += '<ul class="processing-features">';
                modalHtml += '<li>âœ“ Vertical 9:16 format (perfect for Shorts/Reels/TikTok)</li>';
                modalHtml += '<li>âœ“ AI-powered smart reframing</li>';
                modalHtml += '<li>âœ“ Enhanced audio quality</li>';
                modalHtml += '<li>âœ“ All your customizations applied</li>';
                modalHtml += '</ul>';
                modalHtml += '</div>';

                // Processing status notice
                modalHtml += '<div class="download-coming-soon">';
                modalHtml += '<div class="download-coming-soon-title">â³ Processing Queue</div>';
                modalHtml += '<div class="download-coming-soon-text">';
                modalHtml += 'Click "Start Processing" to queue your video for processing. ';
                modalHtml += 'You\'ll be notified when it\'s ready for download (usually 2-5 minutes).';
                modalHtml += '</div>';
                modalHtml += '</div>';

                // Alternative
                modalHtml += '<div class="download-alternative">';
                modalHtml += '<div class="download-alternative-title">ðŸ’¡ Quick Alternative</div>';
                modalHtml += '<div class="download-coming-soon-text">';
                modalHtml += 'Open this exact clip segment in YouTube and use your preferred downloader.';
                modalHtml += '</div>';
                modalHtml += '</div>';

                modalHtml += '</div>'; // body end

                // Actions
                modalHtml += '<div class="download-modal-actions">';
                modalHtml += '<button class="btn-secondary" onclick="app.openClipInYouTube()">Open in YouTube</button>';
                modalHtml += '<button class="btn-primary" onclick="app.startVideoProcessing()">ðŸš€ Start Processing</button>';
                modalHtml += '</div>';

                modalHtml += '</div>'; // content end
                modalHtml += '</div>'; // modal end

                // Append modal to body
                var modalContainer = document.createElement('div');
                modalContainer.id = 'download-modal-container';
                modalContainer.innerHTML = modalHtml;
                document.body.appendChild(modalContainer);
            },

            selectDownloadQuality: function(quality) {
                state.downloadModal.quality = quality;
                // Update UI
                document.querySelectorAll('.quality-option').forEach(function(opt) {
                    opt.classList.remove('selected');
                });
                var selected = document.getElementById('quality-' + quality);
                if (selected) {
                    selected.classList.add('selected');
                }
            },

            closeDownloadModal: function(event) {
                if (event && event.target !== event.currentTarget) return;
                var container = document.getElementById('download-modal-container');
                if (container) {
                    container.remove();
                }
                state.downloadModal = null;
            },

            openClipInYouTube: function() {
                if (!state.downloadModal) return;
                var info = state.downloadModal;

                if (!info.videoId) {
                    utils.showToast('Video ID not found', 'error');
                    return;
                }

                // Open YouTube at the specific timestamp
                var youtubeUrl = 'https://www.youtube.com/watch?v=' + info.videoId + '&t=' + info.startTime;
                window.open(youtubeUrl, '_blank');

                app.closeDownloadModal();
                utils.showToast('Opened in YouTube at ' + utils.formatDuration(info.startTime), 'success');
            },

            startVideoProcessing: async function() {
                if (!state.downloadModal) return;
                if (!state.projectId) {
                    utils.showToast('No project loaded', 'error');
                    return;
                }

                var info = state.downloadModal;
                var clipId = info.clipId;
                var quality = info.quality || '720p';

                utils.showToast('Starting video processing...', 'info');

                try {
                    var wizardProcessClip = functions.httpsCallable('wizardProcessClip');
                    var result = await wizardProcessClip({
                        projectId: state.projectId,
                        clipId: clipId,
                        quality: quality,
                        settings: state.clipSettings[clipId] || {}
                    });

                    if (result.data.success) {
                        // Store job info
                        if (!state.processingJobs) {
                            state.processingJobs = {};
                        }
                        state.processingJobs[clipId] = {
                            jobId: result.data.jobId,
                            status: 'queued',
                            quality: quality
                        };

                        app.closeDownloadModal();
                        utils.showToast('Processing started! ' + result.data.estimatedTime, 'success');

                        // Start polling for status
                        app.pollProcessingStatus(clipId, result.data.jobId);
                    } else {
                        throw new Error(result.data.error || 'Failed to start processing');
                    }
                } catch (error) {
                    console.error('Video processing error:', error);
                    utils.showToast('Error: ' + (error.message || 'Failed to start processing'), 'error');
                }
            },

            pollProcessingStatus: async function(clipId, jobId) {
                // Poll every 10 seconds for status updates
                var pollInterval = setInterval(async function() {
                    try {
                        var wizardGetProcessingStatus = functions.httpsCallable('wizardGetProcessingStatus');
                        var result = await wizardGetProcessingStatus({ jobId: jobId });

                        if (result.data.success) {
                            var job = result.data.job;

                            if (state.processingJobs && state.processingJobs[clipId]) {
                                state.processingJobs[clipId].status = job.status;
                                state.processingJobs[clipId].progress = job.progress;
                            }

                            if (job.status === 'completed') {
                                clearInterval(pollInterval);
                                if (job.outputUrl) {
                                    utils.showToast('Video ready! Click to download.', 'success');
                                    window.open(job.outputUrl, '_blank');
                                } else {
                                    utils.showToast('Video processed but download not available yet.', 'info');
                                }
                            } else if (job.status === 'failed') {
                                clearInterval(pollInterval);
                                utils.showToast('Processing failed: ' + (job.error || 'Unknown error'), 'error');
                            }
                        }
                    } catch (error) {
                        console.error('Poll status error:', error);
                    }
                }, 10000); // 10 second interval

                // Stop polling after 10 minutes
                setTimeout(function() {
                    clearInterval(pollInterval);
                }, 600000);
            },

            downloadThumbnail: function(clipId, index) {
                var thumbnails = state.clipThumbnails[clipId];
                if (!thumbnails || !thumbnails[index]) {
                    utils.showToast('No thumbnail available. Click "Regenerate" to generate thumbnails.', 'info');
                    return;
                }

                var thumbnail = thumbnails[index];
                var url = thumbnail.previewUrl || thumbnail.url || thumbnail;

                // If it's a Firebase Storage URL, download it directly
                if (url && url.startsWith('http')) {
                    var link = document.createElement('a');
                    link.href = url;
                    link.download = 'thumbnail-' + clipId + '-' + (index + 1) + '.png';
                    link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    utils.showToast('Downloading thumbnail...', 'success');
                } else {
                    utils.showToast('Thumbnail not ready for download', 'info');
                }
            },

            copySEO: function(clipId) {
                var clip = state.clips.find(function(c) { return c.id === clipId; });
                var seo = state.clipSEO[clipId] || getDefaultSEO(clip);
                var text = 'Title: ' + seo.title + '\n\nDescription:\n' + seo.description + '\n\nTags: ' + seo.tags.join(', ');
                navigator.clipboard.writeText(text);
                utils.showToast('SEO copied to clipboard!', 'success');
            },

            downloadAllZip: function() {
                // Export all project data as JSON (ZIP would require server-side generation)
                app.exportProject('json');
            },

            exportSEOSheet: function() {
                app.exportProject('csv');
            },

            saveProject: async function() {
                if (!state.projectId) {
                    utils.showToast('No project to save', 'error');
                    return;
                }

                utils.showToast('Saving project...', 'info');

                try {
                    // Save settings for all selected clips
                    var wizardSaveClipSettings = functions.httpsCallable('wizardSaveClipSettings');

                    for (var i = 0; i < state.selectedClipIds.length; i++) {
                        var clipId = state.selectedClipIds[i];
                        var settings = state.clipSettings[clipId] || getDefaultSettings();
                        var seo = state.clipSEO[clipId];

                        await wizardSaveClipSettings({
                            projectId: state.projectId,
                            clipId: clipId,
                            settings: settings,
                            seo: seo
                        });
                    }

                    utils.showToast('Project saved!', 'success');
                } catch (error) {
                    console.error('Save error:', error);
                    utils.showToast('Error: ' + (error.message || 'Failed to save'), 'error');
                }
            },

            startNewProject: function() {
                if (confirm('Start a new project? Current progress will be lost.')) {
                    state.currentStep = 1;
                    state.projectId = null;
                    state.videoInput.url = '';
                    state.videoInput.videoData = null;
                    state.clips = [];
                    state.selectedClipIds = [];
                    state.clipSettings = {};
                    state.clipSEO = {};
                    state.clipThumbnails = {};
                    state.analysis.status = 'idle';
                    state.analysis.progress = 0;
                    state.analysis.error = null;
                    state.analysis.steps.forEach(function(step) {
                        step.status = 'pending';
                    });
                    render();
                }
            },

            // Generate SEO for all selected clips at once
            generateAllSEO: async function() {
                if (!state.projectId) {
                    utils.showToast('No project loaded', 'error');
                    return;
                }

                utils.showToast('Generating SEO for all clips...', 'info');

                try {
                    var wizardGenerateAllSEO = functions.httpsCallable('wizardGenerateAllSEO');
                    var result = await wizardGenerateAllSEO({
                        projectId: state.projectId,
                        clipIds: state.selectedClipIds
                    });

                    if (result.data.success) {
                        // Update local SEO data for all clips
                        Object.keys(result.data.seoData).forEach(function(clipId) {
                            state.clipSEO[clipId] = result.data.seoData[clipId];
                        });
                        render();
                        utils.showToast('SEO generated for all clips!', 'success');
                    } else {
                        throw new Error(result.data.error || 'Failed to generate SEO');
                    }
                } catch (error) {
                    console.error('Batch SEO error:', error);
                    utils.showToast('Error: ' + (error.message || 'Failed to generate SEO'), 'error');
                }
            },

            // Export project with all data
            exportProject: async function(format) {
                if (!state.projectId) {
                    utils.showToast('No project to export', 'error');
                    return;
                }

                utils.showToast('Preparing export...', 'info');

                try {
                    var wizardExportProject = functions.httpsCallable('wizardExportProject');
                    var result = await wizardExportProject({
                        projectId: state.projectId,
                        format: format || 'json',
                        clipIds: state.selectedClipIds
                    });

                    if (result.data.success) {
                        // Handle download based on format
                        if (format === 'csv') {
                            app.downloadCSV(result.data.data.csv, 'project-seo.csv');
                        } else {
                            app.downloadJSON(result.data.data, 'project-export.json');
                        }
                        utils.showToast('Export ready!', 'success');
                    } else {
                        throw new Error(result.data.error || 'Failed to export');
                    }
                } catch (error) {
                    console.error('Export error:', error);
                    utils.showToast('Error: ' + (error.message || 'Failed to export'), 'error');
                }
            },

            downloadCSV: function(csvContent, filename) {
                var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                var link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
            },

            downloadJSON: function(jsonContent, filename) {
                var blob = new Blob([JSON.stringify(jsonContent, null, 2)], { type: 'application/json' });
                var link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
            },

            // Phase 5: Project Management Functions
            loadMyProjects: async function() {
                state.projectsLoading = true;
                render();

                try {
                    var wizardGetProjectsList = functions.httpsCallable('wizardGetProjectsList');
                    var result = await wizardGetProjectsList({
                        limit: 20,
                        status: null // Get all statuses except archived
                    });

                    if (result.data.success) {
                        state.myProjects = result.data.projects;
                        state.projectsLoaded = true;
                        utils.showToast('Loaded ' + result.data.projects.length + ' projects', 'success');
                    } else {
                        throw new Error(result.data.error || 'Failed to load projects');
                    }
                } catch (error) {
                    console.error('Load projects error:', error);
                    utils.showToast('Error: ' + (error.message || 'Failed to load projects'), 'error');
                    state.myProjects = [];
                    state.projectsLoaded = true;
                }

                state.projectsLoading = false;
                render();
            },

            loadProject: async function(projectId) {
                if (!projectId) {
                    utils.showToast('No project ID provided', 'error');
                    return;
                }

                state.loading = true;
                render();

                try {
                    var wizardLoadProject = functions.httpsCallable('wizardLoadProject');
                    var result = await wizardLoadProject({
                        projectId: projectId
                    });

                    if (result.data.success) {
                        var project = result.data.project;

                        // Restore state from loaded project
                        state.projectId = project.id;
                        state.videoInput.url = project.videoUrl || '';
                        // Backend returns videoData as nested object
                        if (project.videoData) {
                            state.videoInput.videoData = {
                                title: project.videoData.title,
                                duration: project.videoData.duration,
                                thumbnail: project.videoData.thumbnail,
                                videoId: project.videoData.videoId
                            };
                        }

                        // Load clips
                        if (project.clips && project.clips.length > 0) {
                            state.clips = project.clips;
                            state.selectedClipIds = project.clips.map(function(c) { return c.id; });
                        }

                        // Load settings and SEO
                        if (project.clipSettings) {
                            state.clipSettings = project.clipSettings;
                        }
                        if (project.clipSEO) {
                            state.clipSEO = project.clipSEO;
                        }

                        // Load AI data if available
                        if (project.clipBRoll) state.clipBRoll = project.clipBRoll;
                        if (project.clipHooks) state.clipHooks = project.clipHooks;
                        if (project.clipFillers) state.clipFillers = project.clipFillers;
                        if (project.clipSpeakers) state.clipSpeakers = project.clipSpeakers;
                        if (project.clipCaptions) state.clipCaptions = project.clipCaptions;

                        // Go to appropriate step based on progress
                        if (project.clips && project.clips.length > 0) {
                            state.currentStep = 3; // Start at clip selection
                            state.analysis.status = 'done';
                        }

                        utils.showToast('Project loaded successfully!', 'success');
                    } else {
                        throw new Error(result.data.error || 'Failed to load project');
                    }
                } catch (error) {
                    console.error('Load project error:', error);
                    utils.showToast('Error: ' + (error.message || 'Failed to load project'), 'error');
                }

                state.loading = false;
                render();
            },

            duplicateProject: async function(projectId) {
                if (!projectId) {
                    utils.showToast('No project ID provided', 'error');
                    return;
                }

                if (!confirm('Create a copy of this project?')) {
                    return;
                }

                utils.showToast('Duplicating project...', 'info');

                try {
                    var wizardDuplicateProject = functions.httpsCallable('wizardDuplicateProject');
                    var result = await wizardDuplicateProject({
                        projectId: projectId
                    });

                    if (result.data.success) {
                        utils.showToast('Project duplicated! New ID: ' + result.data.newProjectId, 'success');
                        // Reload projects list
                        app.loadMyProjects();
                    } else {
                        throw new Error(result.data.error || 'Failed to duplicate project');
                    }
                } catch (error) {
                    console.error('Duplicate project error:', error);
                    utils.showToast('Error: ' + (error.message || 'Failed to duplicate project'), 'error');
                }
            },

            archiveProject: async function(projectId) {
                if (!projectId) {
                    utils.showToast('No project ID provided', 'error');
                    return;
                }

                if (!confirm('Archive this project? You can restore it later.')) {
                    return;
                }

                utils.showToast('Archiving project...', 'info');

                try {
                    var wizardUpdateProjectStatus = functions.httpsCallable('wizardUpdateProjectStatus');
                    var result = await wizardUpdateProjectStatus({
                        projectId: projectId,
                        status: 'archived'
                    });

                    if (result.data.success) {
                        utils.showToast('Project archived!', 'success');
                        // Remove from current list
                        state.myProjects = state.myProjects.filter(function(p) {
                            return p.id !== projectId;
                        });
                        render();
                    } else {
                        throw new Error(result.data.error || 'Failed to archive project');
                    }
                } catch (error) {
                    console.error('Archive project error:', error);
                    utils.showToast('Error: ' + (error.message || 'Failed to archive project'), 'error');
                }
            },

            exportFullProject: async function(format) {
                if (!state.projectId) {
                    utils.showToast('No project to export', 'error');
                    return;
                }

                utils.showToast('Preparing full export...', 'info');

                try {
                    var wizardExportFullProject = functions.httpsCallable('wizardExportFullProject');
                    var result = await wizardExportFullProject({
                        projectId: state.projectId,
                        format: format || 'json',
                        clipIds: state.selectedClipIds,
                        includeAIData: true,
                        includeThumbnails: true
                    });

                    if (result.data.success) {
                        // Handle download based on format
                        if (format === 'csv') {
                            app.downloadCSV(result.data.data.csv, 'project-seo-export.csv');
                        } else {
                            app.downloadJSON(result.data.data, 'project-full-export.json');
                        }
                        utils.showToast('Export downloaded!', 'success');
                    } else {
                        throw new Error(result.data.error || 'Failed to export');
                    }
                } catch (error) {
                    console.error('Export error:', error);
                    utils.showToast('Error: ' + (error.message || 'Failed to export'), 'error');
                }
            },

            selectExportFormat: function(format) {
                // Update visual selection
                var options = document.querySelectorAll('.export-option');
                options.forEach(function(opt) {
                    opt.classList.remove('selected');
                });
                event.currentTarget.classList.add('selected');

                // Perform export based on format
                switch (format) {
                    case 'full':
                        app.exportFullProject('json');
                        break;
                    case 'seo':
                        app.exportFullProject('csv');
                        break;
                    case 'captions':
                        app.exportCaptions();
                        break;
                }
            },

            exportCaptions: async function() {
                if (!state.projectId) {
                    utils.showToast('No project to export', 'error');
                    return;
                }

                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });

                // Generate SRT content for each clip
                var srtContent = '';
                selectedClips.forEach(function(clip, clipIndex) {
                    var captions = (state.clipCaptions || {})[clip.id];
                    srtContent += '--- CLIP ' + (clipIndex + 1) + ': ' + (state.clipSEO[clip.id]?.title || clip.id) + ' ---\n\n';

                    if (captions && captions.words) {
                        captions.words.forEach(function(word, i) {
                            srtContent += (i + 1) + '\n';
                            srtContent += formatSRTTime(word.startTime) + ' --> ' + formatSRTTime(word.endTime) + '\n';
                            srtContent += word.word + '\n\n';
                        });
                    } else {
                        // Use transcript as fallback
                        srtContent += '1\n';
                        srtContent += '00:00:00,000 --> 00:00:' + clip.duration + ',000\n';
                        srtContent += clip.transcript + '\n\n';
                    }
                    srtContent += '\n';
                });

                function formatSRTTime(seconds) {
                    var h = Math.floor(seconds / 3600);
                    var m = Math.floor((seconds % 3600) / 60);
                    var s = Math.floor(seconds % 60);
                    var ms = Math.round((seconds % 1) * 1000);
                    return String(h).padStart(2, '0') + ':' +
                           String(m).padStart(2, '0') + ':' +
                           String(s).padStart(2, '0') + ',' +
                           String(ms).padStart(3, '0');
                }

                var blob = new Blob([srtContent], { type: 'text/plain;charset=utf-8;' });
                var link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'project-captions.srt';
                link.click();
                utils.showToast('Captions exported!', 'success');
            },

            // YouTube OAuth Connection Methods
            connectYouTube: async function() {
                if (!state.user) {
                    utils.showToast('Please sign in first to connect YouTube', 'error');
                    return;
                }

                state.youtubeConnection.loading = true;
                state.youtubeConnection.error = null;
                render();

                try {
                    var getYouTubeOAuthUrl = functions.httpsCallable('getYouTubeOAuthUrl');
                    var result = await getYouTubeOAuthUrl({
                        redirectUri: window.location.origin + window.location.pathname
                    });

                    if (result.data.success && result.data.authUrl) {
                        // Store state for verification when redirected back
                        sessionStorage.setItem('youtubeOAuthState', result.data.state);
                        // Redirect to Google OAuth
                        window.location.href = result.data.authUrl;
                    } else {
                        throw new Error('Failed to generate authorization URL');
                    }
                } catch (error) {
                    console.error('YouTube connect error:', error);
                    state.youtubeConnection.loading = false;
                    state.youtubeConnection.error = error.message || 'Failed to connect YouTube. Please try again.';
                    render();
                    utils.showToast('Failed to connect YouTube', 'error');
                }
            },

            disconnectYouTube: async function() {
                if (!confirm('Are you sure you want to disconnect your YouTube account?')) {
                    return;
                }

                state.youtubeConnection.loading = true;
                render();

                try {
                    var disconnectYouTube = functions.httpsCallable('disconnectYouTube');
                    await disconnectYouTube({});

                    state.youtubeConnection.connected = false;
                    state.youtubeConnection.channel = null;
                    state.youtubeConnection.loading = false;
                    render();
                    utils.showToast('YouTube account disconnected', 'success');
                } catch (error) {
                    console.error('YouTube disconnect error:', error);
                    state.youtubeConnection.loading = false;
                    render();
                    utils.showToast('Failed to disconnect YouTube', 'error');
                }
            },

            checkYouTubeConnection: async function() {
                if (!state.user) return;

                try {
                    var getYouTubeConnectionStatus = functions.httpsCallable('getYouTubeConnectionStatus');
                    var result = await getYouTubeConnectionStatus({});

                    state.youtubeConnection.connected = result.data.connected;
                    state.youtubeConnection.channel = result.data.channel;

                    if (result.data.needsRefresh) {
                        // Token needs refresh - try to refresh
                        try {
                            var refreshYouTubeToken = functions.httpsCallable('refreshYouTubeToken');
                            await refreshYouTubeToken({});
                        } catch (refreshError) {
                            console.log('Token refresh failed:', refreshError.message);
                        }
                    }

                    render();
                } catch (error) {
                    console.error('Check YouTube connection error:', error);
                }
            },

            handleYouTubeOAuthCallback: async function() {
                // Check if this is an OAuth callback
                var urlParams = new URLSearchParams(window.location.search);
                var code = urlParams.get('code');
                var returnedState = urlParams.get('state');
                var error = urlParams.get('error');

                if (error) {
                    console.log('YouTube OAuth error:', error);
                    state.youtubeConnection.error = 'Authorization was denied or cancelled.';
                    // Clean URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                    render();
                    return;
                }

                if (!code || !returnedState) {
                    return; // Not an OAuth callback
                }

                // Verify state matches what we stored
                var storedState = sessionStorage.getItem('youtubeOAuthState');
                if (storedState !== returnedState) {
                    console.error('OAuth state mismatch');
                    state.youtubeConnection.error = 'Security verification failed. Please try again.';
                    window.history.replaceState({}, document.title, window.location.pathname);
                    render();
                    return;
                }

                // Clear stored state
                sessionStorage.removeItem('youtubeOAuthState');

                // Process the OAuth callback
                state.youtubeConnection.loading = true;
                render();

                try {
                    var handleYouTubeOAuthCallback = functions.httpsCallable('handleYouTubeOAuthCallback');
                    var result = await handleYouTubeOAuthCallback({
                        code: code,
                        state: returnedState,
                        redirectUri: window.location.origin + window.location.pathname
                    });

                    if (result.data.success) {
                        state.youtubeConnection.connected = true;
                        state.youtubeConnection.channel = result.data.channel;
                        state.youtubeConnection.error = null;
                        utils.showToast('YouTube account connected successfully!', 'success');
                    } else {
                        throw new Error(result.data.error || 'Failed to connect');
                    }
                } catch (error) {
                    console.error('YouTube OAuth callback error:', error);
                    state.youtubeConnection.error = error.message || 'Failed to complete YouTube connection.';
                    utils.showToast('Failed to connect YouTube', 'error');
                }

                state.youtubeConnection.loading = false;
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
                render();
            }
        };

        // Make app globally accessible
        window.app = app;
        window.utils = utils;

        /* ==========================================
           4.7 HELPER FUNCTIONS
           ========================================== */

        // Note: getDefaultSettings is defined earlier in the code

        /* ==========================================
           4.8 INITIALIZATION
           ========================================== */

        // Auth state listener
        auth.onAuthStateChanged(function(user) {
            if (user) {
                state.user = user;
                state.tokens.balance = 100; // Mock balance
                render();

                // Check for YouTube OAuth callback
                app.handleYouTubeOAuthCallback();

                // Check YouTube connection status
                app.checkYouTubeConnection();
            } else {
                // For demo purposes, allow access without auth
                state.tokens.balance = 50;
                render();
            }
        });

        // Initial render
        render();

    })();
    </script>
</body>
</html>
