<!-- ================================================================
     YOUTUBE VIDEO OPTIMIZER - VIDEO-TO-SHORTS WIZARD
     ================================================================

     Structure:
     - SECTION 1: External Dependencies (CDN)
     - SECTION 2: Styles (CSS)
     - SECTION 3: HTML Container
     - SECTION 4: Scripts (JavaScript)

     Wizard Steps:
     1. Video Input - URL paste or drag/drop upload
     2. AI Analysis - Processing with progress
     3. Clip Selection - Grid with virality scores
     4. Customization Studio - Captions, reframe, audio
     5. SEO & Thumbnails - Title, description, tags, 2 thumbnails
     6. Export & Download - Batch export options

     Access: All authenticated users (with token system)

     Main Dashboard URL: https://ytseo.siteuo.com/video-optimizer

     Last Updated: 2024
     ================================================================ -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Video-to-Shorts Wizard - YouTube Video Optimizer</title>

    <!-- PWA Manifest & Theme -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"YouTube Video Optimizer","short_name":"YT Optimizer","description":"AI-powered YouTube video optimization and campaign analysis platform","start_url":"/main-dashboard.html","display":"standalone","background_color":"#0f172a","theme_color":"#7c3aed","orientation":"portrait-primary","icons":[{"src":"https://ytseo.siteuo.com/icon-192.png","sizes":"192x192","type":"image/png","purpose":"any maskable"},{"src":"https://ytseo.siteuo.com/icon-512.png","sizes":"512x512","type":"image/png","purpose":"any maskable"}],"categories":["productivity","business","utilities"],"lang":"en","dir":"ltr"}'>
    <meta name="theme-color" content="#7c3aed">

    <!-- ============================================
         SECTION 1: EXTERNAL DEPENDENCIES
         ============================================ -->

    <!-- 1.0 Performance: Preconnect & DNS Prefetch -->
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://firebasestorage.googleapis.com" crossorigin>
    <link rel="dns-prefetch" href="https://www.gstatic.com">
    <link rel="dns-prefetch" href="https://firestore.googleapis.com">

    <!-- 1.1 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 1.2 Firebase SDKs (with preload for critical path) -->
    <link rel="preload" href="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js" as="script">
    <link rel="preload" href="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js" as="script">
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>

    <!-- 1.3 PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- ============================================
         SECTION 2: STYLES
         ============================================ -->
    <style>
        /* ------------------------------------------
           2.1 BASE & RESET
           ------------------------------------------ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }

        body {
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 1rem;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            color: white;
        }

        #app-root {
            width: 100%;
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }

        /* ------------------------------------------
           2.2 ANIMATIONS
           ------------------------------------------ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes gradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(236, 72, 153, 0.3); }
            50% { box-shadow: 0 0 40px rgba(236, 72, 153, 0.6); }
        }

        @keyframes borderGlow {
            0%, 100% { border-color: rgba(236, 72, 153, 0.3); }
            50% { border-color: rgba(236, 72, 153, 0.8); }
        }

        @keyframes progressPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        .animate-pulse {
            animation: pulse 2s ease-in-out infinite;
        }

        .animate-float {
            animation: float 3s ease-in-out infinite;
        }

        .animate-glow {
            animation: glow 2s ease-in-out infinite;
        }

        .animate-bounce {
            animation: bounce 1s ease-in-out infinite;
        }

        /* ------------------------------------------
           2.3 WIZARD LAYOUT
           ------------------------------------------ */
        .wizard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
            min-height: 100vh;
        }

        .wizard-header {
            text-align: center;
            padding: 1.5rem 1rem;
            margin-bottom: 1rem;
        }

        .wizard-title {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #ec4899 0%, #f97316 50%, #eab308 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .wizard-subtitle {
            color: rgba(255, 255, 255, 0.6);
            font-size: 1rem;
        }

        /* ------------------------------------------
           2.4 STEPPER
           ------------------------------------------ */
        .wizard-stepper {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            padding: 1.5rem 1rem;
            margin-bottom: 2rem;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .wizard-stepper::-webkit-scrollbar {
            display: none;
        }

        .wizard-step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .wizard-step:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .wizard-step.active {
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.2) 0%, rgba(249, 115, 22, 0.2) 100%);
            border-color: rgba(236, 72, 153, 0.5);
            box-shadow: 0 0 20px rgba(236, 72, 153, 0.2);
        }

        .wizard-step.completed {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .wizard-step.completed .step-number {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .wizard-step.active .step-number {
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
        }

        .step-label {
            font-size: 0.85rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
        }

        .wizard-step.active .step-label {
            color: white;
        }

        .wizard-step.completed .step-label {
            color: #10b981;
        }

        .step-connector {
            width: 30px;
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }

        .step-connector.completed {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
        }

        @media (max-width: 900px) {
            .wizard-step {
                padding: 0.5rem 0.75rem;
            }
            .step-label {
                display: none;
            }
            .step-connector {
                width: 20px;
            }
        }

        /* ------------------------------------------
           2.5 WIZARD CONTENT AREA
           ------------------------------------------ */
        .wizard-content {
            background: linear-gradient(145deg, rgba(30, 30, 50, 0.6) 0%, rgba(20, 20, 35, 0.8) 100%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1.5rem;
            padding: 2rem;
            min-height: 500px;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.4s ease-out;
        }

        @media (max-width: 768px) {
            .wizard-content {
                padding: 1.25rem;
                border-radius: 1rem;
            }
        }

        /* ------------------------------------------
           2.6 VIDEO DROPZONE (Step 1)
           ------------------------------------------ */
        .video-dropzone {
            border: 2px dashed rgba(236, 72, 153, 0.3);
            border-radius: 1.5rem;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(236, 72, 153, 0.03);
            position: relative;
            overflow: hidden;
        }

        .video-dropzone::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.1) 0%, rgba(249, 115, 22, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none; /* Allow clicks to pass through to input */
            z-index: 0;
        }

        .video-dropzone:hover {
            border-color: rgba(236, 72, 153, 0.6);
            background: rgba(236, 72, 153, 0.05);
        }

        .video-dropzone:hover::before {
            opacity: 1;
        }

        .video-dropzone.dragover {
            border-color: #ec4899;
            background: rgba(236, 72, 153, 0.1);
            transform: scale(1.01);
            animation: borderGlow 1s ease-in-out infinite;
        }

        .dropzone-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: float 3s ease-in-out infinite;
            position: relative;
            z-index: 1;
        }

        .dropzone-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }

        .dropzone-subtitle {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.95rem;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 1;
        }

        .url-input-container {
            display: flex;
            gap: 0.75rem;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            z-index: 10; /* Ensure input is above dropzone overlay */
        }

        .url-input {
            flex: 1;
            padding: 1rem 1.25rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.75rem;
            color: white;
            font-size: 1rem;
            outline: none;
            transition: all 0.2s ease;
        }

        .url-input:focus {
            border-color: rgba(236, 72, 153, 0.5);
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
        }

        .url-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        @media (max-width: 600px) {
            .url-input-container {
                flex-direction: column;
            }
        }

        /* Upload Divider */
        .upload-divider {
            display: flex;
            align-items: center;
            margin: 1.5rem 0;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .upload-divider::before,
        .upload-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.2), transparent);
        }

        .upload-divider span {
            padding: 0 1rem;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.85rem;
            font-weight: 500;
        }

        /* Extension Status Indicator */
        .extension-status {
            text-align: center;
            margin-top: 0.75rem;
            font-size: 0.8rem;
        }

        .extension-status-checking,
        .extension-status-connected,
        .extension-status-info {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            border-radius: 1rem;
            background: rgba(255, 255, 255, 0.05);
        }

        .extension-status-connected {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .extension-status-info {
            color: rgba(255, 255, 255, 0.5);
        }

        .extension-status-checking {
            color: rgba(255, 255, 255, 0.5);
        }

        .extension-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .extension-dot.checking {
            background: #f59e0b;
            animation: pulse 1.5s infinite;
        }

        .extension-dot.connected {
            background: #10b981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
        }

        .extension-dot.disconnected {
            background: rgba(255, 255, 255, 0.3);
        }

        .extension-badge {
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            background: rgba(16, 185, 129, 0.2);
            border-radius: 0.25rem;
            margin-left: 0.25rem;
        }

        .extension-install-link {
            color: #8b5cf6;
            text-decoration: none;
            margin-left: 0.5rem;
            font-weight: 500;
        }

        .extension-install-link:hover {
            text-decoration: underline;
        }

        /* Extension Promotion Banner */
        .extension-promo-banner {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(16, 185, 129, 0.15) 100%);
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 1rem;
            padding: 1.25rem;
            margin: 1.5rem 0;
            text-align: center;
            animation: promo-glow 3s ease-in-out infinite;
        }

        @keyframes promo-glow {
            0%, 100% { box-shadow: 0 0 10px rgba(139, 92, 246, 0.2); }
            50% { box-shadow: 0 0 25px rgba(139, 92, 246, 0.4); }
        }

        .extension-promo-banner h4 {
            color: #10b981;
            margin: 0 0 0.75rem 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .extension-promo-banner p {
            color: rgba(255, 255, 255, 0.8);
            margin: 0 0 1rem 0;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .extension-promo-banner .savings-badge {
            display: inline-block;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .extension-promo-banner .btn-install-extension {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .extension-promo-banner .btn-install-extension:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        .extension-promo-banner .free-tag {
            background: #10b981;
            color: white;
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            border-radius: 0.25rem;
            font-weight: 700;
        }

        .extension-features {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .extension-feature {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .extension-feature-icon {
            color: #10b981;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* File Upload */
        .file-upload-container {
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .btn-upload {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.8), rgba(139, 92, 246, 0.8));
            border: none;
            border-radius: 0.75rem;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-upload:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .upload-icon {
            font-size: 1.2rem;
        }

        .upload-hint {
            margin-top: 0.75rem;
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.8rem;
        }

        /* Upload Progress */
        .upload-progress-container {
            max-width: 400px;
            margin: 1.5rem auto;
            text-align: center;
        }

        .upload-progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .upload-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ec4899, #8b5cf6);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .upload-progress-text {
            display: block;
            margin-top: 0.5rem;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
        }

        /* Uploaded File Info */
        .uploaded-file-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            max-width: 400px;
            margin: 1.5rem auto;
            padding: 1rem;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 0.75rem;
        }

        .uploaded-file-icon {
            font-size: 1.5rem;
        }

        .uploaded-file-details {
            flex: 1;
            text-align: left;
        }

        .uploaded-file-name {
            display: block;
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 250px;
        }

        .uploaded-file-size {
            display: block;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
        }

        .remove-file-btn {
            width: 28px;
            height: 28px;
            background: rgba(239, 68, 68, 0.2);
            border: none;
            border-radius: 50%;
            color: #ef4444;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .remove-file-btn:hover {
            background: rgba(239, 68, 68, 0.4);
        }

        /* Video Preview */
        .video-preview-container {
            margin-top: 2rem;
            padding: 1.5rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .video-preview-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .video-thumbnail {
            width: 160px;
            height: 90px;
            border-radius: 0.5rem;
            object-fit: cover;
            background: rgba(255, 255, 255, 0.05);
        }

        .video-details h4 {
            font-size: 1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.25rem;
        }

        .video-details p {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
        }

        /* Options Panel */
        .options-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .option-checkbox {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option-checkbox:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .option-checkbox.checked {
            background: rgba(236, 72, 153, 0.1);
            border-color: rgba(236, 72, 153, 0.3);
        }

        .option-checkbox input {
            width: 20px;
            height: 20px;
            accent-color: #ec4899;
        }

        .option-checkbox span {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        /* ------------------------------------------
           2.7 PROGRESS/ANALYSIS (Step 2)
           ------------------------------------------ */
        .analysis-container {
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
        }

        .analysis-video-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 1rem;
        }

        .analysis-video-info img {
            width: 120px;
            height: 68px;
            border-radius: 0.5rem;
            object-fit: cover;
        }

        .analysis-video-info .video-title {
            font-size: 1rem;
            font-weight: 600;
            color: white;
            text-align: left;
        }

        .analysis-video-info .video-duration {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
            text-align: left;
        }

        .progress-container {
            margin-bottom: 2.5rem;
        }

        .progress-bar-bg {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #ec4899 0%, #f97316 50%, #eab308 100%);
            background-size: 200% 100%;
            border-radius: 6px;
            transition: width 0.5s ease;
            animation: gradientFlow 2s ease infinite;
        }

        .progress-percentage {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
        }

        .analysis-steps {
            text-align: left;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 1rem;
        }

        .analysis-step {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.875rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .analysis-step:last-child {
            border-bottom: none;
        }

        .analysis-step-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .analysis-step.done .analysis-step-icon {
            background: rgba(16, 185, 129, 0.2);
        }

        .analysis-step.processing .analysis-step-icon {
            background: rgba(236, 72, 153, 0.2);
            animation: pulse 1.5s ease-in-out infinite;
        }

        .analysis-step.pending .analysis-step-icon {
            background: rgba(255, 255, 255, 0.05);
        }

        .analysis-step-text {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .analysis-step.done .analysis-step-text {
            color: #10b981;
        }

        .analysis-step.processing .analysis-step-text {
            color: white;
            font-weight: 500;
        }

        /* ------------------------------------------
           2.8 CLIP SELECTION GRID (Step 3)
           ------------------------------------------ */
        .clips-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .clips-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
        }

        .clips-header-actions {
            display: flex;
            gap: 0.75rem;
        }

        .clip-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1.25rem;
        }

        .clip-card {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .clip-card:hover {
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }

        .clip-card.selected {
            border-color: #ec4899;
            box-shadow: 0 0 20px rgba(236, 72, 153, 0.2);
        }

        .clip-card.selected::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.1) 0%, rgba(249, 115, 22, 0.1) 100%);
            pointer-events: none;
        }

        .clip-thumbnail {
            position: relative;
            aspect-ratio: 16/9;
            background: rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .clip-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .clip-duration {
            position: absolute;
            bottom: 0.5rem;
            right: 0.5rem;
            background: rgba(0, 0, 0, 0.8);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .clip-format-badge {
            position: absolute;
            bottom: 0.5rem;
            left: 0.5rem;
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.65rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .clip-checkbox {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            width: 24px;
            height: 24px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .clip-card.selected .clip-checkbox {
            background: #ec4899;
            border-color: #ec4899;
        }

        .clip-info {
            padding: 1rem;
        }

        .clip-score {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .virality-score {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            font-weight: 700;
        }

        .virality-score.high {
            color: #10b981;
        }

        .virality-score.medium {
            color: #f59e0b;
        }

        .virality-score.low {
            color: #ef4444;
        }

        .score-bar {
            width: 60px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .score-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .virality-score.high .score-bar-fill {
            background: linear-gradient(90deg, #10b981, #059669);
        }

        .virality-score.medium .score-bar-fill {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        .virality-score.low .score-bar-fill {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .clip-transcript {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }

        .clip-platforms {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .platform-badge {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.375rem;
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .platform-badge:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .platform-badge.active {
            background: rgba(236, 72, 153, 0.2);
            color: #ec4899;
        }

        /* Create More Section */
        .create-more-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1));
            border: 1px dashed rgba(139, 92, 246, 0.4);
            border-radius: 1rem;
        }

        .create-more-info {
            text-align: center;
        }

        .create-more-count {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .btn-create-more {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1.5rem;
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            color: white;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-create-more:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
        }

        .btn-create-more:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-create-more .token-cost {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }

        .btn-create-more .token-cost::before {
            content: '\1FA99';
            margin-right: 0.25rem;
        }

        .btn-create-more .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .create-more-warning {
            margin-top: 0.5rem;
            color: #ef4444;
            font-size: 0.875rem;
        }

        /* Platform Legend */
        .platform-legend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 0.75rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        /* ------------------------------------------
           2.9 CUSTOMIZATION STUDIO (Step 4)
           ------------------------------------------ */
        .customization-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 2rem;
            align-items: start;
        }

        @media (max-width: 1024px) {
            .customization-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Phone Preview */
        .phone-preview-container {
            position: sticky;
            top: 2rem;
        }

        .clip-info-header {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .clip-info-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

        .clip-info-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .clip-meta-item {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.05);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }

        .video-preview-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: rgba(236, 72, 153, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(236, 72, 153, 0.4);
            z-index: 20;
        }

        .video-preview-btn:hover {
            background: rgba(236, 72, 153, 1);
            transform: translate(-50%, -50%) scale(1.1);
        }

        /* YouTube-specific preview button with label */
        .video-preview-btn-youtube {
            flex-direction: column;
            gap: 2px;
            width: 70px;
            height: 70px;
        }

        .video-preview-btn-youtube .play-icon {
            font-size: 1.2rem;
        }

        .video-preview-btn-youtube .yt-label {
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* YouTube Preview Modal */
        .youtube-preview-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .youtube-preview-content {
            background: #1a1a2e;
            border-radius: 1rem;
            max-width: 900px;
            width: 100%;
            overflow: hidden;
            position: relative;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
        }

        .youtube-preview-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10;
            transition: background 0.2s;
        }

        .youtube-preview-close:hover {
            background: rgba(236, 72, 153, 0.8);
        }

        .youtube-preview-header {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .youtube-preview-header span:first-child {
            font-size: 1.25rem;
            font-weight: 600;
            color: white;
        }

        .youtube-preview-note {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .youtube-preview-video {
            aspect-ratio: 16/9;
            background: #000;
        }

        .youtube-preview-video iframe {
            width: 100%;
            height: 100%;
        }

        .youtube-preview-footer {
            padding: 1rem 1.5rem;
            background: rgba(236, 72, 153, 0.1);
            border-top: 1px solid rgba(236, 72, 153, 0.3);
        }

        .youtube-preview-footer p {
            margin: 0;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.8);
        }

        /* Source Preview with Crop Guides */
        .source-preview-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .source-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .source-preview-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }

        .source-preview-toggle {
            font-size: 0.7rem;
            padding: 0.25rem 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.2s;
        }

        .source-preview-toggle:hover {
            background: rgba(236, 72, 153, 0.3);
            border-color: rgba(236, 72, 153, 0.5);
        }

        .source-preview-video {
            position: relative;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .source-preview-video img,
        .source-preview-video video,
        .source-preview-video iframe {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* Crop guide overlay on source */
        .crop-guide-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        .crop-guide-zone {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 31.640625%; /* Correct: (9/16)² = 81/256 for 16:9→9:16 crop */
            border: 3px solid rgba(236, 72, 153, 0.9);
            background: transparent;
            box-shadow:
                inset 0 0 0 2px rgba(236, 72, 153, 0.3),
                0 0 0 9999px rgba(0, 0, 0, 0.5);
            transition: left 0.2s ease;
            cursor: grab;
            pointer-events: auto;
        }

        .crop-guide-zone:active {
            cursor: grabbing;
        }

        .crop-guide-zone.dragging {
            transition: none;
            box-shadow:
                inset 0 0 0 2px rgba(236, 72, 153, 0.5),
                0 0 0 9999px rgba(0, 0, 0, 0.6);
            border-color: rgba(236, 72, 153, 1);
        }

        .crop-guide-label {
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(236, 72, 153, 0.9);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .crop-drag-hint {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: rgba(255, 255, 255, 0.8);
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.65rem;
            white-space: nowrap;
            opacity: 0.8;
        }

        /* Crop Slider Controls */
        .crop-slider-container {
            margin-top: 0.75rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 0.5rem;
        }

        .crop-slider-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .crop-slider-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
            min-width: 45px;
        }

        .crop-slider-label:last-child {
            text-align: right;
        }

        .crop-slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, rgba(139, 92, 246, 0.3), rgba(236, 72, 153, 0.3));
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }

        .crop-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            border-radius: 50%;
            cursor: grab;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            transition: transform 0.15s ease;
        }

        .crop-slider::-webkit-slider-thumb:hover {
            transform: scale(1.15);
        }

        .crop-slider::-webkit-slider-thumb:active {
            cursor: grabbing;
            transform: scale(1.1);
        }

        .crop-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            border-radius: 50%;
            cursor: grab;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .crop-slider-value {
            text-align: center;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 0.25rem;
        }

        /* Crop Controls Row */
        .crop-controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            gap: 0.75rem;
        }

        .crop-quick-buttons {
            display: flex;
            gap: 0.375rem;
        }

        .crop-quick-btn {
            width: 32px;
            height: 32px;
            padding: 0;
            font-size: 0.8rem;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.375rem;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: all 0.2s;
        }

        .crop-quick-btn:hover {
            background: rgba(255, 255, 255, 0.12);
            color: white;
        }

        .crop-quick-btn.active {
            background: rgba(236, 72, 153, 0.3);
            border-color: rgba(236, 72, 153, 0.5);
            color: white;
        }

        /* AI Smart Crop Button */
        .btn-ai-smart-crop {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem 0.875rem;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(236, 72, 153, 0.2));
            border: 1px solid rgba(139, 92, 246, 0.4);
            border-radius: 0.5rem;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-ai-smart-crop:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(236, 72, 153, 0.3));
            border-color: rgba(139, 92, 246, 0.6);
            transform: translateY(-1px);
        }

        .btn-ai-smart-crop.active {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.4), rgba(236, 72, 153, 0.4));
            border-color: rgba(139, 92, 246, 0.8);
            box-shadow: 0 0 12px rgba(139, 92, 246, 0.3);
        }

        .btn-ai-smart-crop .ai-icon {
            font-size: 0.9rem;
        }

        .btn-ai-smart-crop.loading .ai-icon {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* AI Crop Badge */
        .ai-crop-badge {
            margin-left: 0.5rem;
            padding: 0.2rem 0.5rem;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(236, 72, 153, 0.3));
            border-radius: 0.25rem;
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.9);
        }

        .crop-position-buttons {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .crop-pos-btn {
            padding: 0.4rem 1rem;
            font-size: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.2s;
        }

        .crop-pos-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .crop-pos-btn.active {
            background: rgba(236, 72, 153, 0.3);
            border-color: rgba(236, 72, 153, 0.6);
            color: white;
        }

        .phone-frame {
            background: #000;
            border-radius: 2.5rem;
            padding: 0.75rem;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            max-width: 280px;
            margin: 0 auto;
        }

        .phone-screen {
            background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1a 100%);
            border-radius: 2rem;
            aspect-ratio: 9/16;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        .phone-video-area {
            position: absolute;
            inset: 0;
            background: #0a0a12;
            overflow: hidden;
        }

        /* Simple 9:16 crop using object-fit - MUCH more reliable than transforms */
        .phone-video-area .preview-media {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        /* Crop positions using CSS variable for percentage-based positioning */
        .phone-video-area {
            --crop-position: 50%; /* Default to center */
            --video-zoom: 1; /* Zoom level for single video mode */
        }

        .phone-video-area .preview-media {
            object-position: var(--crop-position) center;
            transform: scale(var(--video-zoom, 1));
            transform-origin: var(--crop-position) center;
        }

        /* YouTube iframe cropping - make it fill and overflow */
        .phone-video-area .preview-iframe-wrapper {
            position: absolute;
            inset: 0;
            overflow: hidden;
            z-index: 1;
            transform: scale(var(--video-zoom, 1));
            transform-origin: var(--crop-position) center;
        }

        .phone-video-area .preview-iframe-wrapper iframe {
            position: absolute;
            top: 0;
            height: 100%;
            /*
             * CRITICAL FIX: Use FIXED width of exactly 316% (16:9 in 9:16 container).
             * The previous approach used 177.78vh which varies with viewport,
             * causing translateX(-X%) to produce inconsistent results because
             * translateX is calculated as percentage of element's own width.
             *
             * For 16:9 source in 9:16 output: ratio = (16/9)² = 256/81 ≈ 3.16 = 316%
             * This matches the FFmpeg calculation exactly.
             */
            width: 316%;
            /* Position using left offset calculated the same way as FFmpeg:
             * FFmpeg: cropX = (percent/100) * (width - cropWidth)
             * CSS equivalent: left = -percent% * (316% - 100%) / 100% = -percent% * 2.16
             * Using CSS calc with the crop position variable
             */
            left: calc(-1 * var(--crop-position) * 2.16);
            border: none;
        }

        /* ==========================================
           REVOLUTIONARY REFRAME PREVIEW OVERLAY
           Shows users exactly what will be exported
           ========================================== */
        .reframe-preview-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 10;
            transition: all 0.3s ease;
        }

        /* Auto-center: 9:16 crop indicator */
        .reframe-overlay-auto_center .crop-zone {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 31.640625%; /* Correct: (9/16)² for 16:9→9:16 crop */
            border: 2px solid rgba(236, 72, 153, 0.8);
            background: transparent;
            box-shadow:
                -100vw 0 0 rgba(0, 0, 0, 0.6),
                100vw 0 0 rgba(0, 0, 0, 0.6);
        }

        .reframe-overlay-auto_center .crop-label {
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(236, 72, 153, 0.9);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .reframe-overlay-auto_center .focus-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 2px solid rgba(34, 197, 94, 0.8);
            border-radius: 50%;
            animation: focusPulse 2s ease-in-out infinite;
        }

        @keyframes focusPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.4; }
        }

        /* Split-screen: Two speakers stacked */
        .reframe-overlay-split_screen {
            display: flex;
            flex-direction: column;
        }

        .reframe-overlay-split_screen .speaker-zone {
            flex: 1;
            border: 2px dashed rgba(236, 72, 153, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .reframe-overlay-split_screen .speaker-zone:first-child {
            border-bottom: 1px solid rgba(236, 72, 153, 0.8);
            background: linear-gradient(180deg, rgba(236, 72, 153, 0.15) 0%, transparent 100%);
        }

        .reframe-overlay-split_screen .speaker-zone:last-child {
            border-top: 1px solid rgba(236, 72, 153, 0.8);
            background: linear-gradient(0deg, rgba(139, 92, 246, 0.15) 0%, transparent 100%);
        }

        .reframe-overlay-split_screen .speaker-label {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .reframe-overlay-split_screen .speaker-icon {
            width: 30px;
            height: 30px;
            background: rgba(236, 72, 153, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 6px;
            font-size: 1rem;
        }

        /* Three-person: Three zones */
        .reframe-overlay-three_person {
            display: grid;
            grid-template-rows: 1fr 1fr;
            grid-template-columns: 1fr 1fr;
        }

        .reframe-overlay-three_person .zone-top {
            grid-column: 1 / -1;
            border: 2px dashed rgba(236, 72, 153, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(180deg, rgba(236, 72, 153, 0.15) 0%, transparent 100%);
        }

        .reframe-overlay-three_person .zone-bottom-left,
        .reframe-overlay-three_person .zone-bottom-right {
            border: 2px dashed rgba(139, 92, 246, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reframe-overlay-three_person .zone-bottom-left {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, transparent 100%);
        }

        .reframe-overlay-three_person .zone-bottom-right {
            background: linear-gradient(225deg, rgba(59, 130, 246, 0.15) 0%, transparent 100%);
        }

        .reframe-overlay-three_person .zone-label {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.6rem;
            font-weight: 600;
        }

        /* Gameplay: Game area + facecam */
        .reframe-overlay-gameplay {
            position: relative;
        }

        .reframe-overlay-gameplay .game-zone {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 30%;
            border: 2px dashed rgba(34, 197, 94, 0.6);
            background: linear-gradient(180deg, rgba(34, 197, 94, 0.1) 0%, transparent 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reframe-overlay-gameplay .game-icon {
            font-size: 2rem;
            opacity: 0.5;
        }

        .reframe-overlay-gameplay .facecam-zone {
            position: absolute;
            bottom: 5%;
            right: 5%;
            width: 35%;
            height: 25%;
            border: 3px solid rgba(236, 72, 153, 0.8);
            border-radius: 8px;
            background: rgba(236, 72, 153, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reframe-overlay-gameplay .facecam-label {
            background: rgba(236, 72, 153, 0.9);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.6rem;
            font-weight: 600;
        }

        /* B-Roll: Ken Burns zoom effect */
        .reframe-overlay-broll_split {
            position: relative;
        }

        .reframe-overlay-broll_split .main-zone {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 35%;
            border: 2px dashed rgba(59, 130, 246, 0.6);
            background: linear-gradient(180deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .reframe-overlay-broll_split .ken-burns-indicator {
            position: absolute;
            inset: 10%;
            border: 1px dashed rgba(255, 255, 255, 0.3);
            animation: kenBurnsPreview 4s ease-in-out infinite;
        }

        @keyframes kenBurnsPreview {
            0%, 100% { transform: scale(1) translate(0, 0); }
            50% { transform: scale(1.1) translate(5%, 5%); }
        }

        .reframe-overlay-broll_split .broll-zone {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 35%;
            border: 2px dashed rgba(236, 72, 153, 0.6);
            background: rgba(236, 72, 153, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reframe-overlay-broll_split .zone-label {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.6rem;
            font-weight: 600;
        }

        /* Crop position indicators */
        .crop-position-indicator {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 4px;
            background: rgba(0, 0, 0, 0.7);
            padding: 4px 8px;
            border-radius: 6px;
            z-index: 20;
        }

        .crop-position-indicator .pos-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.2s ease;
            cursor: pointer;
            pointer-events: auto;
        }

        .crop-position-indicator .pos-dot:hover {
            background: rgba(255, 255, 255, 0.6);
        }

        .crop-position-indicator .pos-dot.active {
            background: rgba(236, 72, 153, 1);
            box-shadow: 0 0 8px rgba(236, 72, 153, 0.6);
        }

        /* Hide overlay when no reframe or auto-center with center position */
        .reframe-overlay-none {
            display: none;
        }

        /* ==========================================
           REVOLUTIONARY CSS TRANSFORM PREVIEW
           Actually transforms the video to show
           what the export will look like!
           ========================================== */

        /* Stop button for playing video */
        .video-stop-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 36px;
            height: 36px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            z-index: 25;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .video-stop-btn:hover {
            background: rgba(239, 68, 68, 0.9);
            border-color: rgba(239, 68, 68, 1);
        }

        /* Split-screen: Show two halves of the video */
        .phone-video-area.reframe-split_screen {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* CSS variables for dynamic speaker positions (set via JavaScript) */
            /* Scale factors calculated from aspect ratios: for 16:9 input to 9:16 output */
            /* Default 50-50 split: each half aspect = 9:8 = 1.125, scale = (16/9)/1.125 = 1.58 */
            --speaker1-scale: 1.58;
            --speaker2-scale: 1.58;
            /* Translate offset: (50 - position) * (scale - 1), default position = 50 (center) */
            --speaker1-translate-pct: 0;  /* Default: 50% position → center */
            --speaker2-translate-pct: 0;  /* Default: 50% position → center */
            --speaker1-zoom: 1;
            --speaker2-zoom: 1;
        }

        .phone-video-area.reframe-split_screen .split-preview-top,
        .phone-video-area.reframe-split_screen .split-preview-bottom {
            overflow: hidden;
            position: relative;
        }

        .phone-video-area.reframe-split_screen .split-preview-top {
            flex: var(--split-top-ratio, 1);
        }

        .phone-video-area.reframe-split_screen .split-preview-bottom {
            flex: var(--split-bottom-ratio, 1);
        }

        .phone-video-area.reframe-split_screen .split-border-line {
            height: var(--split-border-height, 0);
            background-color: var(--split-border-color, #ffffff);
            flex-shrink: 0;
        }

        .phone-video-area.reframe-split_screen .split-preview-top iframe,
        .phone-video-area.reframe-split_screen .split-preview-top img,
        .phone-video-area.reframe-split_screen .split-preview-top video {
            position: absolute;
            /* Override inset:0 from .preview-media - must explicitly reset all positioning */
            inset: auto;
            top: 0;
            left: 50%;
            right: auto;
            bottom: auto;
            /* Base width scales for 16:9 in half of 9:16 container */
            width: calc(var(--speaker1-scale, 1.58) * 100%);
            height: 100%;
            object-fit: cover;
            object-position: center center;
            /* Transform: translateX for position + scale for zoom */
            /* Zoom uses scale() which visually zooms the content */
            transform: translateX(calc(-50% + var(--speaker1-translate-pct, 0) * 1%)) scale(var(--speaker1-zoom, 1));
            transform-origin: center center;
        }

        .phone-video-area.reframe-split_screen .split-preview-bottom iframe,
        .phone-video-area.reframe-split_screen .split-preview-bottom img,
        .phone-video-area.reframe-split_screen .split-preview-bottom video {
            position: absolute;
            /* Override inset:0 from .preview-media - must explicitly reset all positioning */
            inset: auto;
            top: 0;
            left: 50%;
            right: auto;
            bottom: auto;
            /* Base width scales for 16:9 in half of 9:16 container */
            width: calc(var(--speaker2-scale, 1.58) * 100%);
            height: 100%;
            object-fit: cover;
            object-position: center center;
            /* Transform: translateX for position + scale for zoom */
            /* Zoom uses scale() which visually zooms the content */
            transform: translateX(calc(-50% + var(--speaker2-translate-pct, 0) * 1%)) scale(var(--speaker2-zoom, 1));
            transform-origin: center center;
        }

        .phone-video-area.reframe-split_screen .split-label {
            position: absolute;
            top: 4px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.6rem;
            font-weight: 600;
            z-index: 5;
        }

        /* Multi-source split screen - different videos need centered positioning with position/zoom support */
        .phone-video-area.reframe-split_screen.multi-source .split-preview-top iframe,
        .phone-video-area.reframe-split_screen.multi-source .split-preview-top img,
        .phone-video-area.reframe-split_screen.multi-source .split-preview-top video {
            position: absolute;
            /* Override inset:0 from .preview-media - must explicitly reset all positioning */
            inset: auto;
            top: 0;
            left: 50%;
            right: auto;
            bottom: auto;
            /* Base width scales for 16:9 in half of 9:16 container */
            width: calc(var(--speaker1-scale, 1.58) * 100%);
            height: 100%;
            object-fit: cover;
            object-position: center center;
            /* Transform: translateX for position + scale for zoom */
            transform: translateX(calc(-50% + var(--speaker1-translate-pct, 0) * 1%)) scale(var(--speaker1-zoom, 1));
            transform-origin: center center;
        }

        .phone-video-area.reframe-split_screen.multi-source .split-preview-bottom iframe,
        .phone-video-area.reframe-split_screen.multi-source .split-preview-bottom img,
        .phone-video-area.reframe-split_screen.multi-source .split-preview-bottom video {
            position: absolute;
            /* Override inset:0 from .preview-media - must explicitly reset all positioning */
            inset: auto;
            top: 0;
            left: 50%;
            right: auto;
            bottom: auto;
            /* Base width scales for 16:9 in half of 9:16 container */
            width: calc(var(--speaker2-scale, 1.58) * 100%);
            height: 100%;
            object-fit: cover;
            object-position: center center;
            /* Transform: translateX for position + scale for zoom */
            transform: translateX(calc(-50% + var(--speaker2-translate-pct, 0) * 1%)) scale(var(--speaker2-zoom, 1));
            transform-origin: center center;
        }

        /* Split screen preview play/stop buttons */
        .split-preview-play-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            width: 70px;
            height: 70px;
            background: rgba(236, 72, 153, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 20px rgba(236, 72, 153, 0.4);
        }

        .split-preview-play-btn:hover {
            background: rgba(236, 72, 153, 1);
            transform: translate(-50%, -50%) scale(1.1);
        }

        .split-preview-play-btn .play-icon {
            font-size: 1.2rem;
        }

        .split-preview-play-btn .play-label {
            font-size: 0.55rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .split-preview-stop-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            padding: 8px 16px;
            background: rgba(239, 68, 68, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .split-preview-stop-btn:hover {
            background: rgba(239, 68, 68, 1);
        }

        /* Three-person mode */
        .phone-video-area.reframe-three_person {
            display: grid;
            grid-template-rows: var(--three-top-ratio, 1fr) var(--three-bottom-ratio, 1fr);
            grid-template-columns: 1fr 1fr;
            overflow: hidden;
            /* CSS variables for dynamic positioning (set via JavaScript) */
            --main-scale: 1.58;
            --main-translate-pct: 0;
            --main-zoom: 1;
            --left-scale: 1.58;
            --left-translate-pct: 0;
            --left-zoom: 1;
            --right-scale: 1.58;
            --right-translate-pct: 0;
            --right-zoom: 1;
            --three-top-ratio: 1fr;
            --three-bottom-ratio: 1fr;
        }

        .phone-video-area.reframe-three_person .three-zone {
            overflow: hidden;
            position: relative;
        }

        .phone-video-area.reframe-three_person .three-zone-main {
            grid-column: 1 / -1;
        }

        /* Main (top) video - uses dynamic scale and position */
        .phone-video-area.reframe-three_person .three-zone-main iframe,
        .phone-video-area.reframe-three_person .three-zone-main img,
        .phone-video-area.reframe-three_person .three-zone-main video {
            position: absolute;
            /* Override inset:0 from .preview-media - must explicitly reset all positioning */
            inset: auto;
            top: 0;
            left: 50%;
            right: auto;
            bottom: auto;
            width: calc(var(--main-scale, 1.58) * 100%);
            height: 100%;
            object-fit: cover;
            object-position: center center;
            /* Transform: translateX for position + scale for zoom */
            transform: translateX(calc(-50% + var(--main-translate-pct, 0) * 1%)) scale(var(--main-zoom, 1));
            transform-origin: center center;
        }

        /* Left (bottom-left) video - uses dynamic scale and position */
        .phone-video-area.reframe-three_person .three-zone-left iframe,
        .phone-video-area.reframe-three_person .three-zone-left img,
        .phone-video-area.reframe-three_person .three-zone-left video {
            position: absolute;
            /* Override inset:0 from .preview-media - must explicitly reset all positioning */
            inset: auto;
            top: 0;
            left: 50%;
            right: auto;
            bottom: auto;
            width: calc(var(--left-scale, 1.58) * 100%);
            height: 100%;
            object-fit: cover;
            object-position: center center;
            /* Transform: translateX for position + scale for zoom */
            transform: translateX(calc(-50% + var(--left-translate-pct, 0) * 1%)) scale(var(--left-zoom, 1));
            transform-origin: center center;
        }

        /* Right (bottom-right) video - uses dynamic scale and position */
        .phone-video-area.reframe-three_person .three-zone-right iframe,
        .phone-video-area.reframe-three_person .three-zone-right img,
        .phone-video-area.reframe-three_person .three-zone-right video {
            position: absolute;
            /* Override inset:0 from .preview-media - must explicitly reset all positioning */
            inset: auto;
            top: 0;
            left: 50%;
            right: auto;
            bottom: auto;
            width: calc(var(--right-scale, 1.58) * 100%);
            height: 100%;
            object-fit: cover;
            object-position: center center;
            /* Transform: translateX for position + scale for zoom */
            transform: translateX(calc(-50% + var(--right-translate-pct, 0) * 1%)) scale(var(--right-zoom, 1));
            transform-origin: center center;
        }

        .phone-video-area.reframe-three_person .zone-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.55rem;
            font-weight: 600;
            z-index: 5;
        }

        /* Multi-source three person mode - same dynamic positioning */
        .phone-video-area.reframe-three_person.multi-source .three-zone-main iframe,
        .phone-video-area.reframe-three_person.multi-source .three-zone-main img,
        .phone-video-area.reframe-three_person.multi-source .three-zone-main video {
            position: absolute;
            /* Override inset:0 from .preview-media - must explicitly reset all positioning */
            inset: auto;
            top: 0;
            left: 50%;
            right: auto;
            bottom: auto;
            width: calc(var(--main-scale, 1.58) * 100%);
            height: 100%;
            object-fit: cover;
            object-position: center center;
            /* Transform: translateX for position + scale for zoom */
            transform: translateX(calc(-50% + var(--main-translate-pct, 0) * 1%)) scale(var(--main-zoom, 1));
            transform-origin: center center;
        }

        .phone-video-area.reframe-three_person.multi-source .three-zone-left iframe,
        .phone-video-area.reframe-three_person.multi-source .three-zone-left img,
        .phone-video-area.reframe-three_person.multi-source .three-zone-left video {
            position: absolute;
            /* Override inset:0 from .preview-media - must explicitly reset all positioning */
            inset: auto;
            top: 0;
            left: 50%;
            right: auto;
            bottom: auto;
            width: calc(var(--left-scale, 1.58) * 100%);
            height: 100%;
            object-fit: cover;
            object-position: center center;
            /* Transform: translateX for position + scale for zoom */
            transform: translateX(calc(-50% + var(--left-translate-pct, 0) * 1%)) scale(var(--left-zoom, 1));
            transform-origin: center center;
        }

        .phone-video-area.reframe-three_person.multi-source .three-zone-right iframe,
        .phone-video-area.reframe-three_person.multi-source .three-zone-right img,
        .phone-video-area.reframe-three_person.multi-source .three-zone-right video {
            position: absolute;
            /* Override inset:0 from .preview-media - must explicitly reset all positioning */
            inset: auto;
            top: 0;
            left: 50%;
            right: auto;
            bottom: auto;
            width: calc(var(--right-scale, 1.58) * 100%);
            height: 100%;
            object-fit: cover;
            object-position: center center;
            /* Transform: translateX for position + scale for zoom */
            transform: translateX(calc(-50% + var(--right-translate-pct, 0) * 1%)) scale(var(--right-zoom, 1));
            transform-origin: center center;
        }

        /* Gameplay mode */
        .phone-video-area.reframe-gameplay {
            overflow: hidden;
            /* position: absolute is inherited from base rule - don't override with relative */
        }

        .phone-video-area.reframe-gameplay .reframe-video,
        .phone-video-area.reframe-gameplay iframe,
        .phone-video-area.reframe-gameplay img,
        .phone-video-area.reframe-gameplay > video {
            position: absolute;
            width: 177.78%;
            height: 100%;
            left: 50%;
            top: 0;
            transform: translateX(-50%);
            transition: transform 0.3s ease;
            object-fit: cover;
        }

        /* Secondary video in facecam overlay */
        .phone-video-area.reframe-gameplay .facecam-preview video,
        .phone-video-area.reframe-gameplay .facecam-preview img,
        .phone-video-area.reframe-gameplay .facecam-preview iframe {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        .phone-video-area.reframe-gameplay .facecam-preview {
            position: absolute;
            bottom: 5%;
            right: 5%;
            width: 30%;
            height: 20%;
            border: 2px solid rgba(236, 72, 153, 0.8);
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.2), rgba(139, 92, 246, 0.2));
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            backdrop-filter: blur(2px);
        }

        .phone-video-area.reframe-gameplay .facecam-preview span {
            font-size: 0.55rem;
            color: white;
            font-weight: 600;
            background: rgba(236, 72, 153, 0.8);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Facecam position variants */
        .phone-video-area.reframe-gameplay .facecam-preview.facecam-bottom-right {
            bottom: 5%; right: 5%; top: auto; left: auto;
        }
        .phone-video-area.reframe-gameplay .facecam-preview.facecam-bottom-left {
            bottom: 5%; left: 5%; top: auto; right: auto;
        }
        .phone-video-area.reframe-gameplay .facecam-preview.facecam-top-right {
            top: 5%; right: 5%; bottom: auto; left: auto;
        }
        .phone-video-area.reframe-gameplay .facecam-preview.facecam-top-left {
            top: 5%; left: 5%; bottom: auto; right: auto;
        }

        /* B-Roll mode with Ken Burns effect */
        .phone-video-area.reframe-broll_split {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .phone-video-area.reframe-broll_split .broll-main {
            flex: 2;
            overflow: hidden;
            position: relative;
        }

        .phone-video-area.reframe-broll_split .broll-main iframe,
        .phone-video-area.reframe-broll_split .broll-main img,
        .phone-video-area.reframe-broll_split .broll-main video {
            width: 100%;
            height: 150%;
            object-fit: cover;
            animation: kenBurnsLive 8s ease-in-out infinite;
        }

        @keyframes kenBurnsLive {
            0%, 100% { transform: scale(1.1) translate(0, 0); }
            50% { transform: scale(1.2) translate(3%, 3%); }
        }

        .phone-video-area.reframe-broll_split .broll-speaker {
            flex: 1;
            overflow: hidden;
            position: relative;
            border-top: 2px solid rgba(236, 72, 153, 0.6);
        }

        .phone-video-area.reframe-broll_split .broll-speaker iframe,
        .phone-video-area.reframe-broll_split .broll-speaker img,
        .phone-video-area.reframe-broll_split .broll-speaker video {
            width: 300%;
            height: 200%;
            object-fit: cover;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .phone-video-area.reframe-broll_split .broll-label {
            position: absolute;
            top: 4px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.55rem;
            font-weight: 600;
            z-index: 5;
        }

        /* Multi-source broll mode - proper video positioning */
        .phone-video-area.reframe-broll_split.multi-source .broll-main iframe,
        .phone-video-area.reframe-broll_split.multi-source .broll-main img,
        .phone-video-area.reframe-broll_split.multi-source .broll-main video,
        .phone-video-area.reframe-broll_split.multi-source .broll-speaker iframe,
        .phone-video-area.reframe-broll_split.multi-source .broll-speaker img,
        .phone-video-area.reframe-broll_split.multi-source .broll-speaker video {
            width: 200%;
            height: 100%;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            object-fit: cover;
            animation: none;
        }

        /* Reframe mode indicator badge */
        .reframe-mode-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.9), rgba(139, 92, 246, 0.9));
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            z-index: 20;
            backdrop-filter: blur(4px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .phone-caption-preview {
            position: absolute;
            bottom: 60px;
            left: 0;
            right: 0;
            text-align: center;
            padding: 0 0.75rem;
            z-index: 15;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        /* Caption position variants */
        .phone-caption-preview.position-top {
            bottom: auto;
            top: 40px;
        }

        .phone-caption-preview.position-middle {
            bottom: auto;
            top: 50%;
            transform: translateY(-50%);
        }

        /* Caption style preview hint */
        .caption-style-hint {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.55rem;
            color: rgba(255, 255, 255, 0.6);
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 8px;
            border-radius: 3px;
            white-space: nowrap;
            z-index: 16;
        }

        .caption-source-indicator {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 4px;
            vertical-align: middle;
        }

        .caption-source-indicator.source-transcript {
            background: #22c55e;
        }

        .caption-source-indicator.source-ai {
            background: #f59e0b;
        }

        .caption-source-indicator.source-sample {
            background: #6b7280;
        }

        .caption-text {
            font-size: 1.1rem;
            font-weight: 700;
            line-height: 1.3;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.9), 0 0 8px rgba(0, 0, 0, 0.5);
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
        }

        /* Caption Styles - Enhanced to match actual export */
        .caption-karaoke .caption-text {
            color: white;
            font-size: 1.15rem;
        }

        .caption-karaoke .word {
            display: inline-block;
            transition: all 0.15s ease;
        }

        .caption-karaoke .highlight,
        .caption-karaoke .highlight-anim {
            color: #fbbf24;
            transform: scale(1.15);
            display: inline-block;
            animation: karaokeHighlight 1.5s ease-in-out infinite;
        }

        @keyframes karaokeHighlight {
            0%, 100% { color: #fbbf24; transform: scale(1.1); }
            50% { color: #f59e0b; transform: scale(1.18); }
        }

        .caption-beasty .caption-text {
            font-size: 1.35rem;
            text-transform: uppercase;
            color: #fbbf24;
            -webkit-text-stroke: 1.5px #000;
            font-family: Impact, 'Arial Black', sans-serif;
            letter-spacing: 1px;
        }

        .caption-beasty .beasty-word {
            display: inline-block;
            animation: beastyBounce 0.8s ease-out infinite;
        }

        .caption-beasty .beasty-word:nth-child(2) {
            animation-delay: 0.1s;
        }

        .caption-beasty .beasty-word:nth-child(3) {
            animation-delay: 0.2s;
        }

        @keyframes beastyBounce {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.08); }
            50% { transform: scale(0.98); }
        }

        .caption-deepdiver .caption-text {
            font-size: 0.85rem;
            font-weight: 400;
            text-transform: lowercase;
            color: rgba(255, 255, 255, 0.85);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            letter-spacing: 0.3px;
        }

        .caption-podp .caption-text {
            font-size: 1.05rem;
            font-weight: 500;
            color: white;
            letter-spacing: 0.5px;
            font-family: Arial, sans-serif;
        }

        .caption-podp .fade-word {
            display: inline-block;
            animation: fadeInWord 2.5s ease forwards infinite;
        }

        .caption-podp .fade-word.w1 { animation-delay: 0s; }
        .caption-podp .fade-word.w2 { animation-delay: 0.3s; }
        .caption-podp .fade-word.w3 { animation-delay: 0.6s; }

        @keyframes fadeInWord {
            0%, 20% { opacity: 0.4; }
            40%, 60% { opacity: 1; }
            80%, 100% { opacity: 0.4; }
        }

        .caption-hormozi .caption-text {
            font-size: 1.15rem;
            color: white;
        }

        .caption-hormozi .hormozi-highlight {
            background: linear-gradient(180deg, #22c55e 0%, #16a34a 100%);
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 700;
            display: inline-block;
            animation: hormoziPop 1.2s ease infinite;
        }

        @keyframes hormoziPop {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.06); }
        }

        @keyframes hormoziSlide {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .caption-ali .caption-text {
            font-size: 1rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 0 10px rgba(236, 72, 153, 0.8), 0 0 20px rgba(236, 72, 153, 0.4);
        }

        /* Animated Caption Previews */
        .caption-animated {
            display: inline;
            line-height: 1.4;
        }

        /* Karaoke style - words highlight sequentially */
        .caption-karaoke .word {
            color: rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
            display: inline-block;
            margin: 0 0.15rem;
        }

        /* Sequential karaoke highlight animation - each word takes turn */
        .caption-karaoke .word.w1 {
            animation: karaokeWord 4s ease-in-out infinite;
        }
        .caption-karaoke .word.w2 {
            animation: karaokeWord 4s ease-in-out infinite 0.7s;
        }
        .caption-karaoke .word.w3 {
            animation: karaokeWord 4s ease-in-out infinite 1.4s;
        }
        .caption-karaoke .word.w4 {
            animation: karaokeWord 4s ease-in-out infinite 2.1s;
        }
        .caption-karaoke .word.w5 {
            animation: karaokeWord 4s ease-in-out infinite 2.8s;
        }
        .caption-karaoke .word.w6 {
            animation: karaokeWord 4s ease-in-out infinite 3.5s;
        }

        @keyframes karaokeWord {
            0%, 10% { color: rgba(255, 255, 255, 0.5); transform: scale(1); }
            15%, 25% { color: #fbbf24; transform: scale(1.15); text-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
            30%, 100% { color: rgba(255, 255, 255, 0.5); transform: scale(1); }
        }

        .caption-karaoke .highlight-anim {
            color: #fbbf24;
            transform: scale(1.15);
            display: inline-block;
        }

        @keyframes karaokePulse {
            0%, 100% { color: #fbbf24; transform: scale(1.1); }
            50% { color: #f59e0b; transform: scale(1.15); }
        }

        /* MrBeast style - bold pop-in */
        .caption-beasty .beasty-word {
            display: inline-block;
            animation: beastyBounce 0.8s ease-out infinite;
            color: #fbbf24;
            -webkit-text-stroke: 1.5px #000;
            font-size: 1.3rem;
            margin: 0 0.2rem;
        }

        .caption-beasty .beasty-word:nth-child(1) {
            animation-delay: 0s;
        }
        .caption-beasty .beasty-word:nth-child(2) {
            animation-delay: 0.15s;
        }
        .caption-beasty .beasty-word:nth-child(3) {
            animation-delay: 0.3s;
        }

        @keyframes beastyBounce {
            0%, 100% { transform: scale(1) translateY(0); }
            25% { transform: scale(1.08) translateY(-2px); }
            50% { transform: scale(0.98) translateY(0); }
        }

        /* Podcast style - fade in sequence */
        .caption-podp .fade-word {
            display: inline-block;
            margin: 0 0.15rem;
            opacity: 0;
            animation: fadeInWord 2.5s ease forwards infinite;
        }

        .caption-podp .fade-word.w1 { animation-delay: 0s; }
        .caption-podp .fade-word.w2 { animation-delay: 0.4s; }
        .caption-podp .fade-word.w3 { animation-delay: 0.8s; }

        @keyframes fadeInWord {
            0%, 20% { opacity: 0.3; }
            40%, 60% { opacity: 1; }
            80%, 100% { opacity: 0.3; }
        }

        /* Hormozi style - green highlight box */
        .caption-hormozi .hormozi-highlight {
            background: linear-gradient(180deg, #22c55e 0%, #16a34a 100%);
            padding: 0.15rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 700;
            animation: hormoziPop 1.2s ease infinite;
        }

        @keyframes hormoziPop {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Ali style - neon glow pulse */
        .caption-ali .glow-word {
            animation: aliGlow 2s ease-in-out infinite;
        }

        @keyframes aliGlow {
            0%, 100% { text-shadow: 0 0 8px rgba(236, 72, 153, 0.6), 0 0 16px rgba(236, 72, 153, 0.3); }
            50% { text-shadow: 0 0 15px rgba(236, 72, 153, 0.9), 0 0 30px rgba(236, 72, 153, 0.5), 0 0 45px rgba(236, 72, 153, 0.3); }
        }

        /* Custom caption style panel */
        .custom-caption-panel {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
        }

        .custom-caption-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }

        .custom-caption-row:last-child {
            margin-bottom: 0;
        }

        .custom-caption-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            min-width: 70px;
        }

        .custom-caption-input {
            flex: 1;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.375rem;
            color: white;
            font-size: 0.85rem;
        }

        .custom-color-picker {
            width: 40px;
            height: 32px;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            background: transparent;
        }

        /* Caption Source Panel (for multi-source) */
        .caption-source-panel {
            margin-top: 1rem;
            padding: 0.75rem;
            background: rgba(59, 130, 246, 0.08);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 0.5rem;
        }

        .caption-source-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .caption-source-options {
            display: flex;
            gap: 0.5rem;
        }

        .caption-source-btn {
            flex: 1;
            padding: 0.5rem 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.375rem;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
        }

        .caption-source-btn:hover {
            background: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.4);
        }

        .caption-source-btn.active {
            background: rgba(59, 130, 246, 0.25);
            border-color: rgba(59, 130, 246, 0.6);
            color: #60a5fa;
        }

        .caption-source-btn .source-icon {
            font-size: 0.65rem;
        }

        /* Phase 2: Swap Button */
        .swap-button-row {
            display: flex;
            justify-content: center;
            margin: 1rem 0;
        }

        .swap-positions-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1.25rem;
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.4);
            border-radius: 0.5rem;
            color: #a78bfa;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .swap-positions-btn:hover {
            background: rgba(139, 92, 246, 0.25);
            border-color: rgba(139, 92, 246, 0.6);
            transform: scale(1.02);
        }

        .swap-positions-btn .swap-icon {
            font-size: 1rem;
            line-height: 1;
        }

        /* Phase 2: Layout Ratio */
        .split-layout-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .split-section-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .layout-ratio-options {
            display: flex;
            gap: 0.5rem;
        }

        .layout-ratio-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.35rem;
            padding: 0.6rem 0.5rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .layout-ratio-btn:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.3);
        }

        .layout-ratio-btn.active {
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.5);
        }

        .ratio-visual {
            display: flex;
            flex-direction: column;
            width: 24px;
            height: 32px;
            border-radius: 3px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .ratio-top {
            background: rgba(236, 72, 153, 0.6);
        }

        .ratio-bottom {
            background: rgba(59, 130, 246, 0.6);
        }

        .ratio-label {
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .layout-ratio-btn.active .ratio-label {
            color: #a78bfa;
        }

        /* Phase 2: Border/Divider Options */
        .border-options-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .border-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .border-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #8b5cf6;
            cursor: pointer;
        }

        .border-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .border-thickness-slider {
            width: 80px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            cursor: pointer;
        }

        .border-thickness-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            background: #8b5cf6;
            border-radius: 50%;
            cursor: pointer;
        }

        .border-thickness-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: #8b5cf6;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .border-color-picker {
            width: 28px;
            height: 28px;
            padding: 0;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            cursor: pointer;
            background: transparent;
        }

        .border-color-picker::-webkit-color-swatch-wrapper {
            padding: 2px;
        }

        .border-color-picker::-webkit-color-swatch {
            border: none;
            border-radius: 2px;
        }

        /* Phase 3: Zoom Controls */
        .zoom-controls-grid {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .zoom-control-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .zoom-clip-label {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
            min-width: 65px;
        }

        .zoom-clip-label .speaker-badge {
            width: 16px;
            height: 16px;
            font-size: 0.6rem;
        }

        .zoom-slider-wrap {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .zoom-slider {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, rgba(16, 185, 129, 0.3) 0%, rgba(249, 115, 22, 0.3) 100%);
            border-radius: 2px;
            cursor: pointer;
        }

        .zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            background: linear-gradient(135deg, #10b981 0%, #f97316 100%);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .zoom-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: linear-gradient(135deg, #10b981 0%, #f97316 100%);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .zoom-value {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
            min-width: 35px;
            text-align: right;
            font-family: monospace;
        }

        .zoom-reset-btn {
            width: 24px;
            height: 24px;
            padding: 0;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 4px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .zoom-reset-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.8);
        }

        .clip-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .clip-nav-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .clip-nav-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .clip-nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .clip-counter {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Customization Panels */
        .customization-panels {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .customization-panel {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            padding: 1.25rem;
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .panel-icon {
            font-size: 1.25rem;
        }

        .panel-title {
            font-size: 1rem;
            font-weight: 600;
            color: white;
        }

        .panel-preset-label {
            margin-left: auto;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            padding: 0.25rem 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.375rem;
        }

        /* Caption Style Cards */
        .caption-styles-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
        }

        @media (max-width: 900px) {
            .caption-styles-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 600px) {
            .caption-styles-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .caption-style-card {
            padding: 0.875rem;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.25s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .caption-style-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.1) 0%, rgba(249, 115, 22, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.25s ease;
        }

        .caption-style-card:hover {
            border-color: rgba(255, 255, 255, 0.25);
            background: rgba(255, 255, 255, 0.05);
            transform: translateY(-2px);
        }

        .caption-style-card:hover::before {
            opacity: 1;
        }

        .caption-style-card.selected {
            border-color: #ec4899;
            background: rgba(236, 72, 153, 0.15);
            box-shadow: 0 0 20px rgba(236, 72, 153, 0.2);
        }

        .caption-style-card.selected::after {
            content: '\2713';
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 18px;
            height: 18px;
            background: #ec4899;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: bold;
            color: white;
        }

        .caption-style-preview {
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            position: relative;
            z-index: 1;
            padding: 0 0.5rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0.5rem;
        }

        .caption-style-name {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        .caption-style-card.custom-style {
            border-style: dashed;
        }

        .caption-style-card.custom-style .caption-style-preview {
            font-size: 1.5rem;
        }

        /* Reframe Layout Cards */
        .reframe-layouts-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.75rem;
        }

        @media (max-width: 768px) {
            .reframe-layouts-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .reframe-layout-card {
            padding: 0.625rem;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.25s ease;
            text-align: center;
        }

        .reframe-layout-card:hover {
            border-color: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }

        .reframe-layout-card.selected {
            border-color: #ec4899;
            background: rgba(236, 72, 153, 0.1);
            box-shadow: 0 0 15px rgba(236, 72, 153, 0.2);
        }

        .reframe-layout-diagram {
            width: 100%;
            aspect-ratio: 9/16;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Layout Diagram Styles */
        .reframe-layout-diagram.auto-center .layout-face {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 50%;
            background: linear-gradient(180deg, rgba(236, 72, 153, 0.4) 0%, rgba(236, 72, 153, 0.2) 100%);
            border-radius: 50% 50% 40% 40%;
            border: 2px solid rgba(236, 72, 153, 0.6);
        }

        .reframe-layout-diagram.split-screen .layout-section {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        }

        .reframe-layout-diagram.split-screen .layout-section:last-child {
            border-bottom: none;
        }

        .reframe-layout-diagram.split-screen .layout-face-small {
            width: 40%;
            height: 60%;
            background: linear-gradient(180deg, rgba(236, 72, 153, 0.3) 0%, rgba(236, 72, 153, 0.15) 100%);
            border-radius: 50% 50% 40% 40%;
            border: 1px solid rgba(236, 72, 153, 0.5);
        }

        .reframe-layout-diagram.three-person .layout-section-top {
            flex: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        }

        .reframe-layout-diagram.three-person .layout-section-bottom {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-around;
        }

        .reframe-layout-diagram.three-person .layout-face-main {
            width: 50%;
            height: 60%;
            background: rgba(236, 72, 153, 0.3);
            border-radius: 50% 50% 40% 40%;
            border: 1px solid rgba(236, 72, 153, 0.5);
        }

        .reframe-layout-diagram.three-person .layout-face-small {
            width: 35%;
            height: 70%;
            background: rgba(249, 115, 22, 0.25);
            border-radius: 50% 50% 40% 40%;
            border: 1px solid rgba(249, 115, 22, 0.5);
        }

        .reframe-layout-diagram.gameplay .layout-game-area {
            flex: 2;
            background: rgba(34, 197, 94, 0.15);
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reframe-layout-diagram.gameplay .layout-game-icon {
            font-size: 1.5rem;
        }

        .reframe-layout-diagram.gameplay .layout-cam-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reframe-layout-diagram.gameplay .layout-face-cam {
            width: 40%;
            height: 70%;
            background: rgba(236, 72, 153, 0.25);
            border-radius: 50% 50% 40% 40%;
            border: 1px solid rgba(236, 72, 153, 0.4);
        }

        .reframe-layout-diagram.broll-split .layout-main-area {
            flex: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        }

        .reframe-layout-diagram.broll-split .layout-face-broll {
            width: 50%;
            height: 60%;
            background: rgba(236, 72, 153, 0.3);
            border-radius: 50% 50% 40% 40%;
            border: 1px solid rgba(236, 72, 153, 0.5);
        }

        .reframe-layout-diagram.broll-split .layout-broll-area {
            flex: 1;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(59, 130, 246, 0.2) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .reframe-layout-name {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        .reframe-layout-card.selected .reframe-layout-name {
            color: white;
        }

        /* Split Position Panel */
        .split-position-panel {
            margin-top: 0.75rem;
        }

        .split-presets-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .split-preset-btn {
            flex: 1;
            padding: 0.5rem 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.5rem;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
        }

        .split-preset-btn:hover {
            background: rgba(236, 72, 153, 0.15);
            border-color: rgba(236, 72, 153, 0.4);
        }

        .split-preset-btn.active {
            background: rgba(236, 72, 153, 0.25);
            border-color: rgba(236, 72, 153, 0.6);
            color: white;
        }

        .preset-icon {
            font-size: 0.9rem;
        }

        .speaker-position-controls {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 0;
        }

        .speaker-position-controls.expanded {
            max-height: 200px;
            opacity: 1;
        }

        .speaker-position-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .speaker-position-row:last-child {
            border-bottom: none;
        }

        .speaker-position-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .speaker-badge {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .speaker-badge.speaker-1 {
            background: rgba(236, 72, 153, 0.4);
            color: white;
        }

        .speaker-badge.speaker-2 {
            background: rgba(139, 92, 246, 0.4);
            color: white;
        }

        .speaker-position-slider {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            flex: 1;
            max-width: 180px;
        }

        .speaker-position-slider input[type="range"] {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 2px;
            -webkit-appearance: none;
            appearance: none;
        }

        .speaker-position-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #ec4899;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);
        }

        .slider-label-left,
        .slider-label-right {
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.4);
            font-weight: 600;
        }

        .speaker-position-value {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.6);
            min-width: 32px;
            text-align: right;
        }

        /* Secondary Source Panel */
        .secondary-source-panel {
            margin-top: 0.75rem;
            padding: 1rem;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 0.75rem;
        }

        .secondary-source-toggle {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .source-toggle-btn {
            flex: 1;
            padding: 0.6rem 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .source-toggle-btn:hover {
            background: rgba(139, 92, 246, 0.15);
            border-color: rgba(139, 92, 246, 0.4);
        }

        .source-toggle-btn.active {
            background: rgba(139, 92, 246, 0.25);
            border-color: rgba(139, 92, 246, 0.6);
            color: white;
        }

        .secondary-source-input {
            margin-bottom: 1rem;
        }

        .source-input-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .source-input-tab {
            flex: 1;
            padding: 0.5rem;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.375rem;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .source-input-tab:hover {
            border-color: rgba(139, 92, 246, 0.4);
        }

        .source-input-tab.active {
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.5);
            color: white;
        }

        .upload-dropzone {
            border: 2px dashed rgba(139, 92, 246, 0.4);
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(0, 0, 0, 0.2);
        }

        .upload-dropzone:hover {
            border-color: rgba(139, 92, 246, 0.7);
            background: rgba(139, 92, 246, 0.1);
        }

        .upload-dropzone.dragging {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.2);
        }

        .upload-dropzone-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .upload-dropzone-text {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .upload-dropzone-hint {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 0.25rem;
        }

        .youtube-url-input-container {
            display: flex;
            gap: 0.5rem;
        }

        .youtube-url-input {
            flex: 1;
            padding: 0.6rem 0.75rem;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.5rem;
            color: white;
            font-size: 0.8rem;
        }

        .youtube-url-input::placeholder {
            color: rgba(255, 255, 255, 0.35);
        }

        .youtube-url-input:focus {
            outline: none;
            border-color: rgba(139, 92, 246, 0.6);
        }

        .youtube-load-btn {
            padding: 0.6rem 1rem;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            border: none;
            border-radius: 0.5rem;
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .youtube-load-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        .youtube-load-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .secondary-source-preview {
            display: flex;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0.5rem;
            align-items: center;
        }

        .source-preview-thumb {
            width: 80px;
            height: 45px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 0.375rem;
            overflow: hidden;
            flex-shrink: 0;
        }

        .source-preview-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .source-preview-info {
            flex: 1;
            min-width: 0;
        }

        .source-preview-name {
            font-size: 0.8rem;
            font-weight: 500;
            color: white;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .source-preview-meta {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .source-preview-status {
            color: #22c55e;
        }

        .source-preview-remove {
            width: 28px;
            height: 28px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 0.375rem;
            color: #ef4444;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .source-preview-remove:hover {
            background: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.5);
        }

        .secondary-source-options {
            margin-top: 1rem;
            display: grid;
            gap: 0.75rem;
        }

        .source-option-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
        }

        .source-option-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .source-option-select {
            padding: 0.4rem 0.6rem;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.375rem;
            color: white;
            font-size: 0.75rem;
            min-width: 120px;
        }

        .source-offset-control {
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .source-offset-btn {
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.25rem;
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .source-offset-btn:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.4);
        }

        .source-offset-value {
            min-width: 45px;
            text-align: center;
            font-size: 0.75rem;
            color: white;
            font-variant-numeric: tabular-nums;
        }

        /* Audio Mix Panel */
        .audio-mix-panel {
            margin-top: 0.75rem;
            padding: 1rem;
            background: rgba(34, 197, 94, 0.08);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 0.75rem;
        }

        .audio-mix-track {
            margin-bottom: 1rem;
        }

        .audio-mix-track:last-child {
            margin-bottom: 0;
        }

        .audio-mix-track-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .audio-mix-track-name {
            font-size: 0.8rem;
            font-weight: 500;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .audio-mix-track-name .track-icon {
            font-size: 1rem;
        }

        .audio-mix-mute-btn {
            padding: 0.35rem 0.6rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.375rem;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .audio-mix-mute-btn:hover {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.4);
        }

        .audio-mix-mute-btn.muted {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
            color: #ef4444;
        }

        .audio-mix-slider-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .audio-mix-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            cursor: pointer;
        }

        .audio-mix-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #22c55e;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(34, 197, 94, 0.4);
        }

        .audio-mix-slider.secondary::-webkit-slider-thumb {
            background: #8b5cf6;
            box-shadow: 0 2px 6px rgba(139, 92, 246, 0.4);
        }

        .audio-mix-value {
            min-width: 40px;
            text-align: right;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
            font-variant-numeric: tabular-nums;
        }

        .audio-mix-presets {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .audio-mix-preset {
            padding: 0.4rem 0.6rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.375rem;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .audio-mix-preset:hover {
            background: rgba(34, 197, 94, 0.15);
            border-color: rgba(34, 197, 94, 0.4);
            color: white;
        }

        .audio-mix-preset.active {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.5);
            color: #22c55e;
        }

        /* Secondary source in phone preview */
        .phone-secondary-source-indicator {
            position: absolute;
            bottom: 8px;
            right: 8px;
            padding: 0.25rem 0.5rem;
            background: rgba(139, 92, 246, 0.9);
            border-radius: 0.25rem;
            font-size: 0.6rem;
            color: white;
            z-index: 10;
        }

        .phone-audio-indicators {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            z-index: 10;
        }

        .audio-indicator {
            padding: 0.2rem 0.4rem;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 0.25rem;
            font-size: 0.55rem;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .audio-indicator.muted {
            color: #ef4444;
            text-decoration: line-through;
        }

        /* Timeline Trimmer */
        .timeline-container {
            padding: 1.25rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0.75rem;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .timeline-duration {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .timeline-duration-value {
            color: #ec4899;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        .timeline-duration-label {
            color: rgba(255, 255, 255, 0.5);
        }

        .timeline-fine-tune {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .timeline-fine-btn {
            width: 28px;
            height: 28px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.375rem;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timeline-fine-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .timeline-waveform {
            height: 50px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            position: relative;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }

        .waveform-bars {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 2px;
            height: 100%;
            padding: 8px 10px;
        }

        .waveform-bar {
            flex: 1;
            max-width: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            transition: background 0.15s ease;
        }

        .waveform-bar.active {
            background: linear-gradient(180deg, #ec4899 0%, #f97316 100%);
        }

        .timeline-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            position: relative;
            overflow: visible;
            margin-bottom: 0.75rem;
            cursor: pointer;
        }

        .timeline-fill {
            position: absolute;
            top: 0;
            bottom: 0;
            background: linear-gradient(90deg, rgba(236, 72, 153, 0.6) 0%, rgba(249, 115, 22, 0.6) 100%);
            border-radius: 6px;
        }

        .timeline-playhead {
            position: absolute;
            top: -4px;
            bottom: -4px;
            width: 3px;
            background: white;
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            pointer-events: none;
        }

        .timeline-handle {
            position: absolute;
            top: -6px;
            bottom: -6px;
            width: 16px;
            background: transparent;
            cursor: ew-resize;
            z-index: 10;
            transform: translateX(-50%);
        }

        .timeline-handle::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 100%;
            background: #ec4899;
            border-radius: 2px;
        }

        .timeline-handle::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 14px;
            height: 20px;
            background: linear-gradient(180deg, #ec4899 0%, #db2777 100%);
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(236, 72, 153, 0.4);
        }

        .timeline-handle:hover::after {
            box-shadow: 0 2px 12px rgba(236, 72, 153, 0.6);
            transform: translate(-50%, -50%) scale(1.1);
        }

        .timeline-handle.dragging::after {
            background: linear-gradient(180deg, #f472b6 0%, #ec4899 100%);
            box-shadow: 0 2px 16px rgba(236, 72, 153, 0.8);
        }

        .timeline-times {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            font-variant-numeric: tabular-nums;
        }

        .timeline-times span {
            padding: 0.25rem 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.25rem;
        }

        /* Audio Options */
        .audio-section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.4);
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
            margin-top: 1rem;
        }

        .audio-section-title:first-child {
            margin-top: 0;
        }

        .audio-options {
            display: flex;
            flex-direction: column;
            gap: 0.625rem;
        }

        .audio-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.625rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .audio-option:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .audio-option.checked {
            border-color: rgba(236, 72, 153, 0.3);
            background: rgba(236, 72, 153, 0.05);
        }

        .audio-option input {
            width: 18px;
            height: 18px;
            accent-color: #ec4899;
        }

        .audio-option-text {
            flex: 1;
        }

        .audio-option-title {
            font-size: 0.85rem;
            color: white;
            margin-bottom: 0.125rem;
        }

        .audio-option-desc {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
        }

        /* Volume Slider */
        .audio-volume-control {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.875rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.625rem;
        }

        .volume-icon {
            font-size: 1.25rem;
            width: 28px;
            text-align: center;
        }

        .volume-slider-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .volume-slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .volume-slider-value {
            color: #ec4899;
            font-weight: 600;
        }

        .volume-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: linear-gradient(180deg, #ec4899 0%, #db2777 100%);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(236, 72, 153, 0.4);
            transition: transform 0.15s ease;
        }

        .volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.15);
        }

        .volume-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: linear-gradient(180deg, #ec4899 0%, #db2777 100%);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(236, 72, 153, 0.4);
        }

        /* Music Library */
        .music-library {
            margin-top: 0.75rem;
        }

        .music-tracks {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 180px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .music-tracks::-webkit-scrollbar {
            width: 4px;
        }

        .music-tracks::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        .music-track {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .music-track:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .music-track.selected {
            background: rgba(236, 72, 153, 0.1);
            border-color: rgba(236, 72, 153, 0.4);
        }

        .music-track-play {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            flex-shrink: 0;
        }

        .music-track.selected .music-track-play {
            background: #ec4899;
        }

        .music-track-info {
            flex: 1;
            min-width: 0;
        }

        .music-track-name {
            font-size: 0.8rem;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .music-track-meta {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .music-track-duration {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            flex-shrink: 0;
        }

        /* AI Features Bar */
        .ai-features-bar {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 0.75rem;
            overflow-x: auto;
            margin-top: 1.5rem;
        }

        .ai-feature-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.8rem;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ai-feature-btn:hover {
            background: rgba(236, 72, 153, 0.1);
            border-color: rgba(236, 72, 153, 0.3);
            color: white;
        }

        .ai-btn-icon {
            font-size: 1rem;
        }

        /* Apply to All Bar */
        .apply-all-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 0.75rem;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }

        .apply-all-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
        }

        .apply-all-icon {
            font-size: 1.25rem;
        }

        .apply-all-btn {
            padding: 0.625rem 1.25rem;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            border: none;
            border-radius: 0.5rem;
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .apply-all-btn:hover {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        /* Quick Presets Panel */
        .presets-panel {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.05) 0%, rgba(236, 72, 153, 0.05) 100%);
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .presets-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
        }

        @media (max-width: 1200px) {
            .presets-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .presets-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .preset-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.375rem;
            padding: 0.75rem 0.5rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.625rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .preset-card:hover {
            background: rgba(139, 92, 246, 0.15);
            border-color: rgba(139, 92, 246, 0.4);
            transform: translateY(-2px);
        }

        .preset-icon {
            font-size: 1.5rem;
            line-height: 1;
        }

        .preset-info {
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
        }

        .preset-name {
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
        }

        .preset-desc {
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.5);
        }

        /* Settings Summary Panel */
        .settings-summary-panel {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%);
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .settings-summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        @media (max-width: 1200px) {
            .settings-summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .summary-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 0.375rem;
        }

        .summary-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-value {
            font-size: 0.85rem;
            color: white;
            font-weight: 500;
            text-transform: capitalize;
        }

        /* Advanced Options Panel */
        .advanced-options-panel {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(147, 51, 234, 0.05) 100%);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .panel-toggle-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
            cursor: pointer;
            padding: 0.25rem;
            transition: transform 0.2s;
        }

        .panel-toggle-btn:hover {
            color: white;
        }

        .advanced-options-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .advanced-option-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .advanced-option-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .advanced-option-label {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .advanced-option-value {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.05);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }

        .advanced-option-select {
            flex: 1;
            max-width: 250px;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.375rem;
            color: white;
            font-size: 0.85rem;
        }

        .advanced-option-select option {
            background: #1a1a2e;
            color: white;
        }

        .crop-position-grid {
            display: flex;
            gap: 0.5rem;
        }

        .crop-position-btn {
            flex: 1;
            padding: 0.625rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.375rem;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .crop-position-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .crop-position-btn.selected {
            background: rgba(59, 130, 246, 0.3);
            border-color: rgba(59, 130, 246, 0.5);
            color: white;
        }

        .advanced-option-hint {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.4);
            margin: 0;
        }

        /* Transition Options */
        .transition-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .transition-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.625rem 0.875rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 60px;
        }

        .transition-btn:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .transition-btn.selected {
            background: rgba(236, 72, 153, 0.15);
            border-color: #ec4899;
            color: white;
        }

        .transition-icon {
            font-size: 1.1rem;
        }

        .effect-options {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        /* ==========================================
           VISUAL EFFECTS PREVIEW
           Live preview of effects in phone frame
           ========================================== */

        /* Vignette effect - dark edges */
        .phone-screen.effect-vignette::after {
            content: '';
            position: absolute;
            inset: 0;
            box-shadow: inset 0 0 80px 30px rgba(0, 0, 0, 0.6);
            pointer-events: none;
            z-index: 12;
            border-radius: inherit;
        }

        /* Auto Zoom effect - subtle pulse animation */
        .phone-screen.effect-zoom .phone-video-area {
            animation: effectZoomPulse 4s ease-in-out infinite;
        }

        @keyframes effectZoomPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }

        /* Color Grading effect - enhanced saturation */
        .phone-screen.effect-colorgrade .phone-video-area {
            filter: saturate(1.2) contrast(1.08) brightness(1.02);
        }

        .phone-screen.effect-colorgrade .phone-video-area img,
        .phone-screen.effect-colorgrade .phone-video-area video {
            filter: saturate(1.15) contrast(1.05);
        }

        /* Combined effects stacking */
        .phone-screen.effect-vignette.effect-colorgrade .phone-video-area {
            filter: saturate(1.2) contrast(1.08) brightness(1.02);
        }

        /* Transition preview animations */
        .transition-btn.preview-active {
            position: relative;
            overflow: hidden;
        }

        .transition-btn.preview-active::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(236, 72, 153, 0.3);
            animation: transitionPreviewFlash 0.5s ease-out;
        }

        @keyframes transitionPreviewFlash {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* Fade transition preview */
        .phone-screen.transition-fade-in .phone-video-area {
            animation: previewFadeIn 1s ease-out;
        }

        @keyframes previewFadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }

        /* Zoom transition preview */
        .phone-screen.transition-zoom-in .phone-video-area {
            animation: previewZoomIn 0.8s ease-out;
        }

        @keyframes previewZoomIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Slide transition preview */
        .phone-screen.transition-slide-in .phone-video-area {
            animation: previewSlideIn 0.6s ease-out;
        }

        @keyframes previewSlideIn {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(0); }
        }

        /* Glitch transition preview */
        .phone-screen.transition-glitch-in .phone-video-area {
            animation: previewGlitch 0.5s ease-out;
        }

        @keyframes previewGlitch {
            0%, 20% {
                transform: translateX(-2px);
                filter: hue-rotate(90deg);
            }
            40% {
                transform: translateX(2px);
                filter: hue-rotate(-90deg);
            }
            60% {
                transform: translateX(-1px);
                filter: hue-rotate(45deg);
            }
            80%, 100% {
                transform: translateX(0);
                filter: hue-rotate(0deg);
            }
        }

        /* Effects indicator badge */
        .effects-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
            z-index: 20;
        }

        .effects-badge .effect-indicator {
            background: rgba(0, 0, 0, 0.7);
            color: #ec4899;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.55rem;
            font-weight: 600;
            text-transform: uppercase;
            border: 1px solid rgba(236, 72, 153, 0.4);
        }

        /* AI Modal Styles */
        .ai-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .ai-modal {
            background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1a 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .ai-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ai-modal-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: white;
            margin: 0;
        }

        .ai-modal-close {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ai-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .ai-modal-content {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        /* B-Roll Suggestions */
        .broll-suggestion {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .broll-number {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .broll-info {
            flex: 1;
        }

        .broll-desc {
            font-size: 0.95rem;
            color: white;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

        .broll-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 0.5rem;
        }

        .broll-keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
        }

        .broll-tag {
            padding: 0.25rem 0.5rem;
            background: rgba(236, 72, 153, 0.15);
            border-radius: 0.25rem;
            font-size: 0.7rem;
            color: #ec4899;
        }

        /* Hook Suggestions */
        .hook-suggestion {
            padding: 1.25rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
            position: relative;
        }

        .hook-suggestion.recommended {
            border-color: rgba(236, 72, 153, 0.4);
            background: rgba(236, 72, 153, 0.08);
        }

        .hook-badge {
            position: absolute;
            top: -0.5rem;
            right: 1rem;
            padding: 0.25rem 0.75rem;
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
            border-radius: 1rem;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .hook-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.75rem;
            line-height: 1.3;
        }

        .hook-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 1rem;
        }

        .hook-use-btn {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
            border: none;
            border-radius: 0.5rem;
            color: white;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .hook-use-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);
        }

        .hook-explanation {
            padding: 1rem;
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid #3b82f6;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 1rem;
        }

        /* Filler Analysis */
        .filler-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .filler-stat {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 0.75rem;
        }

        .filler-stat .stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            color: #ec4899;
            margin-bottom: 0.25rem;
        }

        .filler-stat .stat-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .filler-types {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .filler-type-badge {
            padding: 0.375rem 0.75rem;
            background: rgba(249, 115, 22, 0.15);
            border-radius: 1rem;
            font-size: 0.75rem;
            color: #f97316;
        }

        .filler-transcript {
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 0.75rem;
        }

        .transcript-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .transcript-text {
            font-size: 0.9rem;
            color: white;
            line-height: 1.6;
        }

        /* ------------------------------------------
           2.10 SEO & THUMBNAILS (Step 5)
           ------------------------------------------ */
        .seo-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 900px) {
            .seo-layout {
                grid-template-columns: 1fr;
            }
        }

        .seo-panel {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            padding: 1.5rem;
        }

        .seo-field {
            margin-bottom: 1.5rem;
        }

        .seo-field:last-child {
            margin-bottom: 0;
        }

        .seo-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.625rem;
        }

        .seo-label span {
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
        }

        .seo-label .char-count {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .seo-input {
            width: 100%;
            padding: 0.875rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.625rem;
            color: white;
            font-size: 0.95rem;
            outline: none;
            transition: all 0.2s ease;
        }

        .seo-input:focus {
            border-color: rgba(236, 72, 153, 0.5);
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
        }

        .seo-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .regenerate-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.375rem;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .regenerate-btn:hover {
            background: rgba(236, 72, 153, 0.1);
            border-color: rgba(236, 72, 153, 0.3);
            color: white;
        }

        /* Tags */
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .tag {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem 0.75rem;
            background: rgba(236, 72, 153, 0.1);
            border: 1px solid rgba(236, 72, 153, 0.2);
            border-radius: 9999px;
            font-size: 0.8rem;
            color: #ec4899;
        }

        .tag-remove {
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .tag-remove:hover {
            opacity: 1;
        }

        .add-tag-btn {
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px dashed rgba(255, 255, 255, 0.2);
            border-radius: 9999px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-tag-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.3);
            color: white;
        }

        /* Thumbnails */
        .thumbnails-panel h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 1rem;
        }

        .thumbnails-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        @media (max-width: 600px) {
            .thumbnails-grid {
                grid-template-columns: 1fr;
            }
        }

        .thumbnail-option {
            position: relative;
            aspect-ratio: 9/16;
            background: rgba(255, 255, 255, 0.05);
            border: 3px solid transparent;
            border-radius: 0.75rem;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
            max-height: 280px;
        }

        .thumbnail-option:hover {
            border-color: rgba(255, 255, 255, 0.2);
        }

        .thumbnail-option.selected {
            border-color: #ec4899;
            box-shadow: 0 0 20px rgba(236, 72, 153, 0.3);
        }

        .thumbnail-option img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .thumbnail-placeholder {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.03);
            color: rgba(255, 255, 255, 0.6);
            gap: 0.25rem;
            overflow: hidden;
        }

        .thumbnail-placeholder::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 0;
        }

        .thumbnail-download-btn {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .thumbnail-download-btn:hover {
            background: #10b981;
            border-color: #10b981;
        }

        .thumbnail-label {
            position: absolute;
            bottom: 0.5rem;
            left: 0.5rem;
            padding: 0.25rem 0.5rem;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 0.25rem;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .thumbnail-radio {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .thumbnail-option.selected .thumbnail-radio {
            border-color: #ec4899;
            background: #ec4899;
        }

        .thumbnail-option.selected .thumbnail-radio::after {
            content: '\2713';
            color: white;
            font-size: 0.75rem;
        }

        .regenerate-thumbnails-btn {
            margin-top: 1rem;
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.625rem;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .regenerate-thumbnails-btn:hover {
            background: rgba(236, 72, 153, 0.1);
            border-color: rgba(236, 72, 153, 0.3);
            color: white;
        }

        .regenerate-thumbnails-btn.primary-action {
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
            border-color: transparent;
            color: white;
            font-weight: 600;
        }

        .regenerate-thumbnails-btn.primary-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
        }

        .regenerate-thumbnails-btn:disabled {
            opacity: 0.8;
            cursor: not-allowed;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-color: transparent;
            color: white;
        }

        .thumbnail-loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .thumbnail-loading-info {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 0.5rem;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
        }

        /* ------------------------------------------
           2.11 EXPORT (Step 6)
           ------------------------------------------ */
        .export-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .export-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
        }

        .export-ready-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 9999px;
            color: #10b981;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .export-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .export-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.25rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            transition: all 0.2s ease;
        }

        .export-item:hover {
            border-color: rgba(255, 255, 255, 0.15);
        }

        .export-item-thumbnail {
            width: 45px;
            height: 80px;
            border-radius: 0.375rem;
            object-fit: cover;
            background: rgba(255, 255, 255, 0.05);
            flex-shrink: 0;
        }

        .export-item-info {
            flex: 1;
            min-width: 0;
        }

        .export-item-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .export-item-platforms {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .export-item-status {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 9999px;
            color: #10b981;
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .export-item-status.processing {
            background: rgba(236, 72, 153, 0.15);
            color: #ec4899;
            animation: pulse-processing 2s ease-in-out infinite;
        }

        .export-item-status.failed {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        @keyframes pulse-processing {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .processing-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(236, 72, 153, 0.3);
            border-top-color: #ec4899;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Global processing toast - persistent notification */
        .processing-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.98) 0%, rgba(15, 15, 26, 0.98) 100%);
            border: 1px solid rgba(236, 72, 153, 0.3);
            border-radius: 1rem;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 10000;
            max-width: 350px;
        }

        .processing-toast-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(236, 72, 153, 0.3);
            border-top-color: #ec4899;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            flex-shrink: 0;
        }

        .processing-toast-content {
            flex: 1;
        }

        .processing-toast-title {
            font-weight: 600;
            color: white;
            margin-bottom: 0.25rem;
        }

        .processing-toast-progress {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .processing-toast-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0;
            line-height: 1;
        }

        .export-item-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .export-action-btn {
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .export-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        @media (max-width: 768px) {
            .export-item {
                flex-wrap: wrap;
            }
            .export-item-actions {
                width: 100%;
                justify-content: flex-end;
                margin-top: 0.75rem;
            }
        }

        /* Batch Actions */
        .batch-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
        }

        .batch-action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.625rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .batch-action-btn:hover {
            background: rgba(236, 72, 153, 0.1);
            border-color: rgba(236, 72, 153, 0.3);
        }

        .batch-action-btn.primary {
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
            border: none;
        }

        .batch-action-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(236, 72, 153, 0.3);
        }

        /* ------------------------------------------
           2.12 BUTTONS
           ------------------------------------------ */
        .btn-primary {
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
            color: white;
            font-weight: 600;
            padding: 0.875rem 1.5rem;
            border-radius: 0.75rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(236, 72, 153, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-weight: 500;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Navigation Buttons */
        .wizard-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .wizard-nav-left,
        .wizard-nav-right {
            display: flex;
            gap: 0.75rem;
        }

        /* ------------------------------------------
           2.13 GLOBAL HEADER
           ------------------------------------------ */
        .global-header {
            position: fixed;
            top: 0;
            right: 1.5rem;
            padding: 1rem 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            pointer-events: none;
        }

        .global-header > * {
            pointer-events: auto;
        }

        .global-header-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-back-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.875rem;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 0.5rem;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            text-decoration: none;
        }

        .header-back-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .header-token-display {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 0.875rem;
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.15) 0%, rgba(249, 115, 22, 0.1) 100%);
            border: 1px solid rgba(236, 72, 153, 0.3);
            border-radius: 9999px;
            font-size: 0.8rem;
            backdrop-filter: blur(10px);
        }

        .header-token-display .token-value {
            font-weight: 700;
            color: white;
        }

        .header-token-display .token-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.75rem;
        }

        @media (max-width: 768px) {
            .global-header {
                right: 1rem;
            }
            .header-token-display .token-label {
                display: none;
            }
        }

        /* ------------------------------------------
           2.14 LOADING & MISC
           ------------------------------------------ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-card {
            background: linear-gradient(145deg, rgba(30, 30, 50, 0.95) 0%, rgba(20, 20, 35, 0.98) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            padding: 2.5rem;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #ec4899;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1.5rem;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            color: white;
            font-weight: 500;
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }

        .toast.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .toast.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .toast.info {
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
        }

        /* ------------------------------------------
           2.16 VIDEO PREVIEW MODAL
           ------------------------------------------ */
        .video-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 2rem;
        }

        .video-preview-content {
            background: rgba(30, 30, 40, 0.95);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 900px;
            width: 100%;
            overflow: hidden;
        }

        .video-preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .video-preview-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            margin: 0;
        }

        .video-preview-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .video-preview-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .video-preview-player {
            position: relative;
            width: 100%;
            aspect-ratio: 16 / 9;
            background: #000;
        }

        .video-preview-player iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        .video-preview-info {
            padding: 1.25rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .video-preview-meta {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .video-preview-meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .video-preview-transcript {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
            max-height: 100px;
            overflow-y: auto;
        }

        .video-preview-actions {
            display: flex;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .video-preview-actions button {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .video-preview-actions .btn-select {
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
            border: none;
            color: white;
        }

        .video-preview-actions .btn-select:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);
        }

        .video-preview-actions .btn-select.selected {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        /* Play button overlay on clip cards */
        .clip-play-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background: rgba(236, 72, 153, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s ease;
            cursor: pointer;
            z-index: 10;
        }

        .clip-play-btn::after {
            content: '';
            width: 0;
            height: 0;
            border-left: 14px solid white;
            border-top: 9px solid transparent;
            border-bottom: 9px solid transparent;
            margin-left: 3px;
        }

        .clip-thumbnail:hover .clip-play-btn {
            opacity: 1;
        }

        .clip-play-btn:hover {
            transform: translate(-50%, -50%) scale(1.1);
            background: rgba(236, 72, 153, 1);
        }

        /* ------------------------------------------
           2.17 DOWNLOAD MODAL
           ------------------------------------------ */
        .download-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 2rem;
        }

        .download-modal-content {
            background: rgba(30, 30, 40, 0.95);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 500px;
            width: 100%;
            overflow: hidden;
        }

        .download-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .download-modal-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            margin: 0;
        }

        .download-modal-body {
            padding: 1.5rem;
        }

        .download-quality-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .quality-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.25rem;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quality-option:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(236, 72, 153, 0.4);
        }

        .quality-option.selected {
            background: rgba(236, 72, 153, 0.1);
            border-color: #ec4899;
        }

        .quality-option-label {
            font-size: 1.1rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.25rem;
        }

        .quality-option-size {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .download-coming-soon {
            background: rgba(249, 115, 22, 0.1);
            border: 1px solid rgba(249, 115, 22, 0.3);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .download-coming-soon-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #f97316;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .download-coming-soon-text {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.5;
        }

        .download-alternative {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .download-alternative-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #10b981;
            margin-bottom: 0.5rem;
        }

        .download-modal-actions {
            display: flex;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .download-modal-actions button {
            flex: 1;
            padding: 0.875rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .download-modal-actions .btn-youtube {
            background: #ff0000;
            border: none;
            color: white;
        }

        .download-modal-actions .btn-youtube:hover {
            background: #cc0000;
        }

        .download-modal-actions .btn-primary {
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
            border: none;
            color: white;
        }

        .download-modal-actions .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
        }

        .download-processing-info {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .processing-info-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #10b981;
            margin-bottom: 0.75rem;
        }

        .processing-features {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .processing-features li {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.85rem;
            padding: 0.25rem 0;
        }

        /* ------------------------------------------
           2.18 MY PROJECTS SECTION (Step 1)
           ------------------------------------------ */
        .my-projects-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
        }

        .my-projects-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.25rem;
        }

        /* Download Ready Modal */
        .download-ready-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 2rem;
        }

        .download-ready-content {
            background: rgba(30, 30, 40, 0.98);
            border-radius: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 400px;
            width: 100%;
            padding: 2rem;
            text-align: center;
            position: relative;
        }

        .download-ready-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .download-ready-close:hover {
            background: rgba(239, 68, 68, 0.5);
        }

        .download-ready-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .download-ready-content h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            margin: 0 0 0.5rem 0;
        }

        .download-ready-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .download-btn-primary,
        .download-btn-secondary {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .download-btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .download-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .download-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .download-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .download-btn-icon {
            font-size: 1.2rem;
        }

        .my-projects-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .my-projects-header .refresh-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .my-projects-header .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .projects-loading {
            text-align: center;
            padding: 2rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .projects-empty {
            text-align: center;
            padding: 2rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .project-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.75rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .project-card:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(236, 72, 153, 0.3);
            transform: translateY(-2px);
        }

        .project-card-header {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .project-thumbnail {
            width: 80px;
            height: 45px;
            border-radius: 0.375rem;
            object-fit: cover;
            background: rgba(0, 0, 0, 0.3);
        }

        .project-info {
            flex: 1;
            min-width: 0;
        }

        .project-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.25rem;
        }

        .project-meta {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .project-status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .project-status-badge.draft {
            background: rgba(249, 115, 22, 0.15);
            color: #f97316;
        }

        .project-status-badge.complete {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }

        .project-status-badge.archived {
            background: rgba(107, 114, 128, 0.15);
            color: #9ca3af;
        }

        .project-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .project-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .project-action-btn {
            flex: 1;
            padding: 0.375rem 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.375rem;
            color: white;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .project-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .project-action-btn.primary {
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
            border: none;
        }

        .project-action-btn.primary:hover {
            transform: scale(1.02);
        }

        /* ------------------------------------------
           2.17 ENHANCED EXPORT UI (Step 6)
           ------------------------------------------ */
        .export-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 1000px) {
            .export-container {
                grid-template-columns: 1fr;
            }
        }

        .export-main {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            padding: 1.5rem;
        }

        .export-sidebar {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .export-panel {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            padding: 1.25rem;
        }

        .export-panel h3 {
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .export-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.625rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 0.5rem;
        }

        .export-option:last-child {
            margin-bottom: 0;
        }

        .export-option:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(236, 72, 153, 0.3);
        }

        .export-option.selected {
            background: rgba(236, 72, 153, 0.1);
            border-color: rgba(236, 72, 153, 0.4);
        }

        .export-option-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            font-size: 1.25rem;
        }

        .export-option-info {
            flex: 1;
        }

        .export-option-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
        }

        .export-option-desc {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .export-option-badge {
            padding: 0.25rem 0.5rem;
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
            border-radius: 0.375rem;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* YouTube Connection Panel */
        .youtube-connection-panel {
            margin-bottom: 1rem;
        }

        .youtube-connection-desc {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .youtube-connection-info {
            font-size: 0.75rem;
            color: rgba(16, 185, 129, 0.8);
            margin-top: 0.75rem;
            line-height: 1.4;
        }

        .youtube-connection-error {
            font-size: 0.8rem;
            color: #ef4444;
            padding: 0.75rem;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .youtube-connect-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.875rem 1rem;
            background: #ff0000;
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .youtube-connect-btn:hover {
            background: #cc0000;
            transform: translateY(-1px);
        }

        .youtube-connect-btn svg {
            flex-shrink: 0;
        }

        .youtube-connection-status {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.5rem;
        }

        .youtube-connection-status.connected {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.2);
        }

        .youtube-connection-status.loading {
            justify-content: center;
            color: rgba(255, 255, 255, 0.7);
        }

        .connection-loading-spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-top-color: #ec4899;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .youtube-channel-thumb {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }

        .youtube-channel-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border-radius: 50%;
            font-size: 1rem;
            font-weight: bold;
        }

        .youtube-channel-info {
            flex: 1;
            min-width: 0;
        }

        .youtube-channel-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .youtube-channel-label {
            font-size: 0.7rem;
            color: #10b981;
        }

        .youtube-disconnect-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 0.375rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .youtube-disconnect-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.4);
        }

        /* Platform Selection - Step 1 (Compact single-row design) */
        .platform-selection-section {
            margin-bottom: 1.25rem;
        }

        .platform-selection-header {
            display: none; /* Hide header for cleaner look */
        }

        .platform-cards-grid {
            display: flex;
            gap: 0.625rem;
            justify-content: center;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding: 0.25rem 0;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .platform-cards-grid::-webkit-scrollbar {
            display: none;
        }

        .platform-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.625rem;
            padding: 0.875rem 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            min-width: 110px;
            flex: 1;
            max-width: 140px;
        }

        .platform-card:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .platform-card.selected {
            background: rgba(249, 115, 22, 0.08);
            border-color: #f97316;
        }

        .platform-card-icon {
            font-size: 1.375rem;
            margin-bottom: 0.5rem;
            display: block;
            line-height: 1;
        }

        .platform-card-name {
            font-size: 0.75rem;
            font-weight: 600;
            color: #fff;
            margin-bottom: 0.125rem;
            white-space: nowrap;
        }

        .platform-card-subtitle {
            font-size: 0.625rem;
            color: rgba(255, 255, 255, 0.45);
            margin-bottom: 0.5rem;
            white-space: nowrap;
        }

        .platform-card-duration {
            font-size: 0.625rem;
            color: #f97316;
            font-weight: 500;
            padding: 0.1875rem 0.5rem;
            background: rgba(249, 115, 22, 0.12);
            border-radius: 0.25rem;
            display: inline-block;
        }

        /* Mobile: scrollable row */
        @media (max-width: 700px) {
            .platform-cards-grid {
                justify-content: flex-start;
                padding: 0.25rem 0.5rem;
            }

            .platform-card {
                min-width: 95px;
                max-width: 110px;
                padding: 0.625rem 0.75rem;
            }

            .platform-card-icon {
                font-size: 1.125rem;
            }

            .platform-card-name {
                font-size: 0.6875rem;
            }

            .platform-card-subtitle {
                font-size: 0.5625rem;
            }

            .platform-card-duration {
                font-size: 0.5625rem;
            }
        }

        .platform-selection-tip {
            display: none;
        }

        /* YouTube Connection Panel - Step 1 */
        .youtube-connection-step1 {
            margin: 1.5rem 0;
            padding: 1.25rem;
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.05) 0%, rgba(255, 0, 0, 0.02) 100%);
            border: 1px solid rgba(255, 0, 0, 0.15);
            border-radius: 1rem;
        }

        .youtube-connection-step1-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .youtube-icon-large {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            background: rgba(255, 0, 0, 0.1);
            border-radius: 0.75rem;
        }

        .youtube-connection-step1-title h3 {
            font-size: 1rem;
            font-weight: 600;
            color: white;
            margin: 0;
        }

        .youtube-connection-step1-title p {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
            margin: 0.25rem 0 0 0;
        }

        .youtube-connect-btn-step1 {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.875rem 1rem;
            background: #ff0000;
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .youtube-connect-btn-step1:hover {
            background: #cc0000;
            transform: translateY(-1px);
        }

        .youtube-connection-step1-status {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.5rem;
        }

        .youtube-connection-step1-status.connected {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.25);
        }

        .youtube-connection-step1-status.loading {
            justify-content: center;
            color: rgba(255, 255, 255, 0.7);
        }

        .youtube-channel-thumb-small {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }

        .youtube-channel-icon-small {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border-radius: 50%;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .youtube-connection-step1-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }

        .youtube-connected-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .youtube-connected-label {
            font-size: 0.7rem;
            color: #10b981;
        }

        .youtube-disconnect-btn-small {
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 0.375rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .youtube-disconnect-btn-small:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .youtube-connection-error-small {
            font-size: 0.8rem;
            color: #ef4444;
            padding: 0.5rem 0.75rem;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 0.375rem;
            margin-bottom: 0.75rem;
        }

        .quick-links {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .quick-link {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 0.625rem;
            color: white;
            text-decoration: none;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .quick-link:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(236, 72, 153, 0.3);
        }

        .quick-link-icon {
            font-size: 1.1rem;
        }

        .export-summary {
            padding: 1rem;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 0.625rem;
            margin-bottom: 1rem;
        }

        .export-summary-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #10b981;
            margin-bottom: 0.5rem;
        }

        .export-summary-list {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .export-summary-list li {
            margin-bottom: 0.25rem;
            list-style: none;
            padding-left: 1rem;
            position: relative;
        }

        .export-summary-list li::before {
            content: '\2713';
            position: absolute;
            left: 0;
            color: #10b981;
        }

        .export-actions-large {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .export-btn-large {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .export-btn-large:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateY(-2px);
        }

        .export-btn-large.primary {
            background: linear-gradient(135deg, #ec4899 0%, #f97316 100%);
            border: none;
        }

        .export-btn-large.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(236, 72, 153, 0.3);
        }

        .export-btn-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .export-btn-label {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .export-btn-sublabel {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 0.25rem;
        }

        /* Parallel Export Banner Styles */
        .parallel-export-banner {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(16, 185, 129, 0.15) 100%);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .parallel-export-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .parallel-export-icon {
            font-size: 1.5rem;
        }

        .parallel-export-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #22c55e;
        }

        .parallel-export-badge {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .parallel-export-description {
            color: #9ca3af;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .parallel-export-btn {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }

        .parallel-export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(34, 197, 94, 0.4);
        }

        .parallel-export-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Parallel Export Progress Styles */
        .parallel-export-progress {
            background: rgba(17, 24, 39, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .parallel-progress-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .parallel-progress-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #22c55e;
        }

        .parallel-progress-stats {
            font-size: 0.9rem;
            color: #9ca3af;
        }

        .parallel-progress-items {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .parallel-progress-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }

        .parallel-progress-item.completed {
            background: rgba(34, 197, 94, 0.1);
        }

        .parallel-progress-item.error {
            background: rgba(239, 68, 68, 0.1);
        }

        .parallel-progress-item-icon {
            font-size: 1.25rem;
            width: 32px;
            text-align: center;
        }

        .parallel-progress-item-info {
            flex: 1;
        }

        .parallel-progress-item-title {
            font-size: 0.9rem;
            font-weight: 500;
            color: #f3f4f6;
        }

        .parallel-progress-item-status {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .parallel-progress-bar-container {
            width: 100px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .parallel-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .parallel-progress-complete-message {
            text-align: center;
            padding: 1rem;
            margin-top: 1rem;
            background: rgba(34, 197, 94, 0.1);
            border-radius: 8px;
        }

        .parallel-progress-complete-message h4 {
            color: #22c55e;
            margin-bottom: 0.5rem;
        }

        /* ========================================
           BATCH EXPORT MODAL - Enhanced UX
           ======================================== */
        .batch-export-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .batch-export-modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .batch-export-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .batch-export-modal-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 600;
            color: #f3f4f6;
        }

        .batch-export-modal-title .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(34, 197, 94, 0.3);
            border-top-color: #22c55e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .batch-export-modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #9ca3af;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.25rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .batch-export-modal-close:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .batch-export-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .batch-export-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .batch-export-stat {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
        }

        .batch-export-stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #22c55e;
        }

        .batch-export-stat-value.pending { color: #9ca3af; }
        .batch-export-stat-value.processing { color: #3b82f6; }
        .batch-export-stat-value.error { color: #ef4444; }

        .batch-export-stat-label {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Console-like log area */
        .batch-export-console {
            background: #0d1117;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .batch-export-console-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .batch-export-console-header span {
            font-size: 0.85rem;
            color: #9ca3af;
            font-family: monospace;
        }

        .console-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .console-dot.red { background: #ef4444; }
        .console-dot.yellow { background: #eab308; }
        .console-dot.green { background: #22c55e; }

        .batch-export-console-body {
            height: 200px;
            overflow-y: auto;
            padding: 1rem;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.8rem;
            line-height: 1.6;
        }

        .console-line {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .console-timestamp {
            color: #6b7280;
            flex-shrink: 0;
        }

        .console-message {
            color: #e5e7eb;
            word-break: break-word;
        }

        .console-message.info { color: #3b82f6; }
        .console-message.success { color: #22c55e; }
        .console-message.error { color: #ef4444; }
        .console-message.warning { color: #eab308; }

        /* Clip list in modal */
        .batch-export-clips {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .batch-export-clip {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            transition: all 0.2s;
        }

        .batch-export-clip.active {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .batch-export-clip.completed {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }

        .batch-export-clip.error {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .batch-export-clip-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            background: rgba(255, 255, 255, 0.05);
            flex-shrink: 0;
        }

        .batch-export-clip.active .batch-export-clip-icon {
            background: rgba(59, 130, 246, 0.2);
        }

        .batch-export-clip.completed .batch-export-clip-icon {
            background: rgba(34, 197, 94, 0.2);
        }

        .batch-export-clip-info {
            flex: 1;
            min-width: 0;
        }

        .batch-export-clip-title {
            font-weight: 500;
            color: #f3f4f6;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .batch-export-clip-status {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .batch-export-clip-progress {
            width: 120px;
            flex-shrink: 0;
        }

        .batch-export-clip-progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .batch-export-clip-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #22c55e 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .batch-export-clip-progress-text {
            font-size: 0.75rem;
            color: #9ca3af;
            text-align: center;
            margin-top: 0.25rem;
        }

        .batch-export-clip-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .batch-export-download-btn {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .batch-export-download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        /* Modal footer */
        .batch-export-modal-footer {
            padding: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .batch-export-footer-status {
            font-size: 0.9rem;
            color: #9ca3af;
        }

        .batch-export-footer-actions {
            display: flex;
            gap: 0.75rem;
        }

        .batch-export-cancel-btn {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .batch-export-cancel-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .batch-export-download-all-btn {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .batch-export-download-all-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
        }

        .batch-export-download-all-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Complete state */
        .batch-export-complete-banner {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(22, 163, 74, 0.1) 100%);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .batch-export-complete-banner h3 {
            font-size: 1.5rem;
            color: #22c55e;
            margin-bottom: 0.5rem;
        }

        .batch-export-complete-banner p {
            color: #9ca3af;
        }
    </style>

    <!-- ============================================
         SECTION 3: HTML CONTAINER
         ============================================ -->
</head>
<body>
    <div id="app-root">
        <!-- Static loading screen - shown immediately while Firebase loads -->
        <div class="min-h-screen flex items-center justify-center" style="background:linear-gradient(135deg,#0f172a 0%,#1e1b4b 50%,#0f172a 100%);">
            <div class="text-center">
                <div style="font-size:4.5rem;margin-bottom:1.5rem;">🎬</div>
                <div style="width:40px;height:40px;border:3px solid rgba(139,92,246,0.3);border-top-color:#8b5cf6;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 1rem;"></div>
                <p style="color:rgba(255,255,255,0.8);font-size:1.125rem;">Loading Video Wizard...</p>
            </div>
        </div>
        <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
    </div>

    <!-- ============================================
         SECTION 4: SCRIPTS
         ============================================ -->
    <script>
    (function() {
        'use strict';

        /* ==========================================
           4.1 FIREBASE CONFIGURATION
           ========================================== */

        // Ultra-patient Firebase loading for iframe/embed contexts
        var firebaseCheckStart = Date.now();
        var firebaseMaxWait = 15000; // 15 seconds

        function showConnectionError() {
            document.getElementById('app-root').innerHTML =
                '<div style="display:flex;align-items:center;justify-content:center;min-height:100vh;padding:2rem;background:linear-gradient(135deg,#0f172a 0%,#1e1b4b 50%,#0f172a 100%);">' +
                '<div style="background:rgba(30,41,59,0.95);border-radius:1rem;padding:3rem;text-align:center;max-width:400px;border:1px solid rgba(255,255,255,0.1);">' +
                '<h2 style="color:#ef4444;font-size:1.5rem;font-weight:bold;margin-bottom:1rem;">Connection Error</h2>' +
                '<p style="color:#9ca3af;margin-bottom:1.5rem;">Failed to load required resources. This may be due to a slow connection or ad blocker.</p>' +
                '<button onclick="location.reload()" style="padding:0.75rem 2rem;background:linear-gradient(135deg,#3b82f6,#8b5cf6);color:white;border:none;border-radius:0.5rem;cursor:pointer;font-weight:600;font-size:1rem;">Try Again</button></div></div>';
        }

        function waitForFirebase() {
            if (typeof firebase !== 'undefined') {
                runApp();
                return;
            }
            if (Date.now() - firebaseCheckStart > firebaseMaxWait) {
                showConnectionError();
                return;
            }
            setTimeout(waitForFirebase, 100);
        }

        if (typeof firebase !== 'undefined') {
            runApp();
        } else {
            waitForFirebase();
        }

        function runApp() {

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAGczY5ZEIJdTq25BpQdia3lv2I556wOZo",
            authDomain: "ytseo-6d1b0.firebaseapp.com",
            projectId: "ytseo-6d1b0",
            storageBucket: "ytseo-6d1b0.firebasestorage.app",
            messagingSenderId: "382790048044",
            appId: "1:382790048044:web:cd427679ff72108c1f3489"
        };

        firebase.initializeApp(FIREBASE_CONFIG);
        const auth = firebase.auth();
        const functions = firebase.functions();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Enable offline persistence for faster loading
        db.enablePersistence({ synchronizeTabs: true })
            .catch(function(err) {
                if (err.code === 'failed-precondition') {
                    console.log('Persistence failed: Multiple tabs open');
                } else if (err.code === 'unimplemented') {
                    console.log('Persistence not supported by browser');
                }
            });

        /* ==========================================
           4.1.1 PLATFORM PRESETS CONFIGURATION
           ========================================== */

        const PLATFORM_PRESETS = {
            'youtube-shorts': {
                id: 'youtube-shorts',
                name: 'YouTube Shorts',
                icon: '📺',
                subtitle: 'Platform optimized',
                minDuration: 45,
                maxDuration: 60,
                targetDuration: 55,
                aspectRatio: '9:16',
                description: 'Maximize the 60-second limit for better watch time',
                aiPrompt: 'Each clip should be 50-60 seconds to maximize YouTube Shorts watch time. Focus on complete story arcs with satisfying conclusions.',
                durationRange: '50-60'
            },
            'tiktok-viral': {
                id: 'tiktok-viral',
                name: 'TikTok Viral',
                icon: '🎵',
                subtitle: 'Trending style',
                minDuration: 20,
                maxDuration: 90,
                targetDuration: 45,
                aspectRatio: '9:16',
                description: 'Hook-driven content with trending formats',
                aiPrompt: 'Clips should be 30-60 seconds with extremely strong hooks in the first 2 seconds. Focus on trending, shareable moments.',
                durationRange: '30-60'
            },
            'instagram-reels': {
                id: 'instagram-reels',
                name: 'Instagram Reels',
                icon: '📷',
                subtitle: 'Visual focus',
                minDuration: 45,
                maxDuration: 90,
                targetDuration: 70,
                aspectRatio: '9:16',
                description: 'Visually striking moments for the gram',
                aiPrompt: 'Clips should be 60-90 seconds focusing on visual impact and aesthetic appeal. Instagram rewards longer watch time.',
                durationRange: '60-90'
            },
            'podcast-clip': {
                id: 'podcast-clip',
                name: 'Podcast Clip',
                icon: '🎙️',
                subtitle: 'Clean & clear',
                minDuration: 30,
                maxDuration: 120,
                targetDuration: 60,
                aspectRatio: '9:16',
                description: 'Quotable insights and clear dialogue',
                aiPrompt: 'Clips should be 45-90 seconds capturing complete thoughts and quotable insights. Focus on clear dialogue and valuable information.',
                durationRange: '45-90'
            },
            'gaming-highlight': {
                id: 'gaming-highlight',
                name: 'Gaming Highlight',
                icon: '🎮',
                subtitle: 'Action-packed',
                minDuration: 15,
                maxDuration: 90,
                targetDuration: 45,
                aspectRatio: '9:16',
                description: 'Peak action moments and reactions',
                aiPrompt: 'Clips should be 30-60 seconds of peak action, impressive plays, reactions, or funny moments.',
                durationRange: '30-60'
            },
            'multi-platform': {
                id: 'multi-platform',
                name: 'Multi-Platform',
                icon: '🌐',
                subtitle: 'Universal fit',
                minDuration: 30,
                maxDuration: 60,
                targetDuration: 50,
                aspectRatio: '9:16',
                description: 'Optimized for all platforms',
                aiPrompt: 'Clips should be 45-60 seconds to work well across all platforms. Focus on universal appeal with complete moments.',
                durationRange: '45-60'
            }
        };

        /* ==========================================
           4.2 APPLICATION STATE
           ========================================== */

        const state = {
            currentStep: 1,
            user: null,
            profile: null,
            loading: false,
            projectId: null, // Firestore project ID

            // Content Type / Platform Selection
            contentType: {
                selected: 'youtube-shorts', // Default to YouTube Shorts
                preset: PLATFORM_PRESETS['youtube-shorts']
            },

            // Token system (synced with backend)
            tokens: {
                balance: 0,
                plan: 'free',
                monthlyAllocation: 10,
                loading: false,
                costs: {
                    analyzeVideo: 5,
                    showMoreClips: 3,
                    generateSEO: 2,
                    generateBRoll: 4,
                    detectSpeakers: 3,
                    exportClip: 0
                }
            },

            // Token Modal
            showTokenModal: false,
            tokenBypassCosts: null,

            // Step 1: Video Input
            videoInput: {
                url: '',
                videoData: null, // { title, duration, thumbnail, videoId }
                options: {
                    generateCaptions: true,
                    generateThumbnails: true,
                    seoOptimization: true,
                    multiPlatform: true
                },
                // File upload state
                uploading: false,
                uploadProgress: 0,
                uploadedFile: null // { name, size, type, url, storagePath }
            },

            // Step 2: Analysis
            analysis: {
                status: 'idle', // idle | processing | done | error
                progress: 0,
                currentStep: 0,
                error: null,
                steps: [
                    { name: 'Fetching video info', status: 'pending' },
                    { name: 'Downloading video', status: 'pending' },
                    { name: 'Extracting audio', status: 'pending' },
                    { name: 'Generating transcript', status: 'pending' },
                    { name: 'Finding viral moments', status: 'pending' },
                    { name: 'Scoring clips', status: 'pending' }
                ]
            },

            // Step 3: Clips
            clips: [],
            selectedClipIds: [],
            displayedClipCount: 8, // Initial number of clips to show (more can be unlocked)
            createMoreLoading: false, // Loading state for "Create more" button

            // Step 4: Customization
            customization: {
                activeClipIndex: 0,
                batchMode: false,
                showVideoPreview: false,
                showSourcePreview: true, // Show source with crop guides by default
                showAdvancedOptions: false,
                playingInFrame: false // YouTube video playing inside phone frame with 9:16 crop
            },

            // Clip settings (per clip)
            clipSettings: {},

            // Step 5: SEO & Thumbnails
            clipSEO: {},
            clipThumbnails: {},
            selectedThumbnail: {},  // Track selected thumbnail index per clip
            thumbnailGenerating: false,  // Loading state for thumbnail generation
            downloadModal: null,     // Current download modal state

            // Phase 4: Advanced AI Features
            clipBRoll: {},      // AI B-Roll suggestions per clip
            clipHooks: {},      // AI viral hooks per clip
            clipFillers: {},    // Filler word analysis per clip
            clipSpeakers: {},   // Speaker detection per clip
            clipCaptions: {},   // Generated captions per clip

            // Step 6: Export
            exportStatus: {},

            // Phase 5: My Projects
            myProjects: [],           // List of user's saved projects
            projectsLoading: false,   // Loading state for projects list
            projectsLoaded: false,    // Whether projects have been loaded

            // YouTube OAuth Connection
            youtubeConnection: {
                connected: false,
                loading: false,
                channel: null,        // { id, title, thumbnail }
                error: null
            },

            // Browser Extension Integration
            extension: {
                installed: false,
                version: null,
                features: [],        // Extension capabilities (auto_capture, network_intercept, etc.)
                checking: true,      // Initially checking for extension
                capturedVideo: null  // Video data captured by extension
            },

            // Canonical Source Asset - stored video for reliable export
            // Captured during analysis and saved to Firebase Storage
            // Export uses this instead of re-capturing at export time
            sourceAsset: null  // { storageUrl, storagePath, duration, format, capturedAt, source }
        };

        // Track document event listeners for cleanup between renders
        // This prevents accumulating duplicate listeners that can cause state bugs
        var documentEventListeners = {
            timelineMouseMove: null,
            timelineMouseUp: null,
            timelineTouchMove: null,
            timelineTouchEnd: null,
            cropMouseMove: null,
            cropMouseUp: null,
            cropTouchMove: null,
            cropTouchEnd: null
        };

        // Mock data for testing
        const MOCK_CLIPS = [
            { id: 'clip_001', startTime: 120, endTime: 165, duration: 45, score: 98, transcript: 'The biggest mistake entrepreneurs make is thinking they need to have everything figured out before they start...', thumbnail: 'https://picsum.photos/seed/clip1/320/180', platforms: ['youtube', 'instagram', 'tiktok'] },
            { id: 'clip_002', startTime: 340, endTime: 412, duration: 72, score: 95, transcript: 'When I started my first business, I had $500 in my bank account and zero connections...', thumbnail: 'https://picsum.photos/seed/clip2/320/180', platforms: ['youtube', 'tiktok'] },
            { id: 'clip_003', startTime: 560, endTime: 618, duration: 58, score: 92, transcript: 'The secret to scaling is not working harder, it\'s building systems that work without you...', thumbnail: 'https://picsum.photos/seed/clip3/320/180', platforms: ['youtube', 'instagram', 'linkedin'] },
            { id: 'clip_004', startTime: 780, endTime: 814, duration: 34, score: 89, transcript: 'Most people quit right before the breakthrough. That\'s why persistence is everything...', thumbnail: 'https://picsum.photos/seed/clip4/320/180', platforms: ['tiktok', 'facebook'] },
            { id: 'clip_005', startTime: 920, endTime: 985, duration: 65, score: 87, transcript: 'I failed seven times before I built something that worked. Each failure taught me something crucial...', thumbnail: 'https://picsum.photos/seed/clip5/320/180', platforms: ['youtube', 'instagram'] },
            { id: 'clip_006', startTime: 1100, endTime: 1142, duration: 42, score: 84, transcript: 'Your network is your net worth. The people you surround yourself with determine your success...', thumbnail: 'https://picsum.photos/seed/clip6/320/180', platforms: ['linkedin'] },
            { id: 'clip_007', startTime: 1280, endTime: 1338, duration: 58, score: 81, transcript: 'Stop waiting for permission. Start before you\'re ready because you\'ll never feel ready...', thumbnail: 'https://picsum.photos/seed/clip7/320/180', platforms: ['youtube', 'tiktok'] },
            { id: 'clip_008', startTime: 1450, endTime: 1498, duration: 48, score: 78, transcript: 'Revenue is vanity, profit is sanity, but cash flow is king. Remember that...', thumbnail: 'https://picsum.photos/seed/clip8/320/180', platforms: ['youtube', 'linkedin'] }
        ];

        // Default SEO template for clips without generated SEO
        function getDefaultSEO(clip) {
            return {
                title: clip ? (clip.transcript || '').substring(0, 60) + '...' : 'Untitled Clip',
                description: clip ? clip.transcript || '' : '',
                tags: ['shorts', 'viral', 'clips']
            };
        }

        /* ==========================================
           4.3 UTILITY FUNCTIONS
           ========================================== */

        const utils = {
            escapeHtml: function(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            formatDuration: function(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return mins + ':' + (secs < 10 ? '0' : '') + secs;
            },

            formatFullDuration: function(seconds) {
                const hours = Math.floor(seconds / 3600);
                const mins = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                if (hours > 0) {
                    return hours + ':' + (mins < 10 ? '0' : '') + mins + ':' + (secs < 10 ? '0' : '') + secs;
                }
                return mins + ':' + (secs < 10 ? '0' : '') + secs;
            },

            formatFileSize: function(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            },

            getScoreClass: function(score) {
                if (score >= 80) return 'high';
                if (score >= 50) return 'medium';
                return 'low';
            },

            showToast: function(message, type) {
                const toast = document.createElement('div');
                toast.className = 'toast ' + (type || 'info');
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(function() {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateY(10px)';
                    setTimeout(function() { toast.remove(); }, 300);
                }, 3000);
            },

            getPlatformIcon: function(platform) {
                const icons = {
                    youtube: '📺',
                    instagram: '📸',
                    tiktok: '🎵',
                    linkedin: '💼',
                    facebook: '📘',
                    twitter: '✕'
                };
                return icons[platform] || '📱';
            },

            getPlatformName: function(platform) {
                const names = {
                    youtube: 'YouTube',
                    instagram: 'Instagram',
                    tiktok: 'TikTok',
                    linkedin: 'LinkedIn',
                    facebook: 'Facebook',
                    twitter: 'X/Twitter'
                };
                return names[platform] || platform;
            },

            formatDate: function(dateInput) {
                if (!dateInput) return 'Unknown';
                var date;
                if (dateInput._seconds) {
                    // Firestore Timestamp
                    date = new Date(dateInput._seconds * 1000);
                } else if (dateInput.seconds) {
                    date = new Date(dateInput.seconds * 1000);
                } else if (typeof dateInput === 'string') {
                    date = new Date(dateInput);
                } else {
                    date = dateInput;
                }
                var now = new Date();
                var diff = now - date;
                var seconds = Math.floor(diff / 1000);
                var minutes = Math.floor(seconds / 60);
                var hours = Math.floor(minutes / 60);
                var days = Math.floor(hours / 24);

                if (days > 7) {
                    return date.toLocaleDateString();
                } else if (days > 0) {
                    return days + ' day' + (days > 1 ? 's' : '') + ' ago';
                } else if (hours > 0) {
                    return hours + ' hour' + (hours > 1 ? 's' : '') + ' ago';
                } else if (minutes > 0) {
                    return minutes + ' min' + (minutes > 1 ? 's' : '') + ' ago';
                } else {
                    return 'Just now';
                }
            }
        };

        /* ==========================================
           4.4 RENDER FUNCTIONS
           ========================================== */

        function render() {
            const root = document.getElementById('app-root');
            let html = '';

            // Loading overlay
            if (state.loading) {
                html += renderLoading();
            }

            // Main wizard
            html += '<div class="wizard-container">';
            html += renderGlobalHeader();
            html += renderWizardHeader();
            html += renderStepper();
            html += '<div class="wizard-content">';

            switch (state.currentStep) {
                case 1:
                    html += renderStep1VideoInput();
                    break;
                case 2:
                    html += renderStep2Analysis();
                    break;
                case 3:
                    html += renderStep3ClipSelection();
                    break;
                case 4:
                    html += renderStep4Customization();
                    break;
                case 5:
                    html += renderStep5SEO();
                    break;
                case 6:
                    html += renderStep6Export();
                    break;
            }

            html += '</div>'; // wizard-content
            html += '</div>'; // wizard-container

            // Token Modal
            if (state.showTokenModal) {
                var tokenCosts = state.tokenBypassCosts || {};
                var toolLabels = {
                    warpOptimizer: 'WARP Optimizer', competitorAnalysis: 'Competitor Analysis',
                    trendPredictor: 'Trend Predictor', thumbnailGenerator: 'Thumbnail Generator',
                    channelAudit: 'Channel Audit', scriptGenerator: 'Script Generator',
                    titleGenerator: 'Title Generator', placementFinder: 'Placement Finder'
                };
                html += '<div class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4" onclick="app.hideTokenModal()">';
                html += '<div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl shadow-2xl max-w-lg w-full p-6 relative border border-white/10" onclick="event.stopPropagation()">';
                html += '<button onclick="app.hideTokenModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl transition-colors">&times;</button>';
                html += '<div class="text-center mb-6"><div class="w-20 h-20 bg-gradient-to-br from-amber-400 to-yellow-600 rounded-2xl flex items-center justify-center text-4xl mx-auto mb-4 shadow-lg shadow-amber-500/30">🪙</div>';
                html += '<h3 class="text-2xl font-bold text-white">Your Token Balance</h3>';
                html += '<div class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-amber-400 to-yellow-500 mt-2">' + (state.tokens.balance || 0) + '</div>';
                html += '<p class="text-gray-400 mt-1">Wizard Tokens Available</p></div>';
                var planName = (state.tokens.plan || 'free').charAt(0).toUpperCase() + (state.tokens.plan || 'free').slice(1);
                html += '<div class="bg-white/5 rounded-xl p-4 mb-4 border border-white/10"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><span class="text-2xl">📊</span><div><p class="text-white font-semibold">Current Plan</p><p class="text-amber-400 font-bold capitalize">' + planName + '</p></div></div><a href="pricing.html" class="text-sm text-purple-400 hover:text-purple-300">Upgrade →</a></div></div>';
                html += '<div class="bg-white/5 rounded-xl p-4 mb-4 border border-white/10"><h4 class="text-white font-semibold mb-3 flex items-center gap-2"><span>💡</span> Quota Bypass Costs</h4>';
                html += '<p class="text-gray-400 text-sm mb-3">When you run out of free uses, tokens can skip the wait time:</p><div class="grid grid-cols-2 gap-2">';
                Object.keys(toolLabels).forEach(function(toolKey) {
                    var cost = tokenCosts[toolKey] || '?';
                    html += '<div class="flex items-center justify-between bg-white/5 rounded-lg px-3 py-2"><span class="text-gray-300 text-xs">' + toolLabels[toolKey] + '</span><span class="text-amber-400 font-bold text-sm">' + cost + ' 🪙</span></div>';
                });
                html += '</div></div>';
                html += '<button onclick="app.topUpTokens()" class="w-full py-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold rounded-xl hover:from-amber-600 hover:to-orange-600 transition-all shadow-lg shadow-amber-500/30 flex items-center justify-center gap-2"><span class="text-xl">💳</span> TopUp Tokens</button>';
                html += '<p class="text-center text-gray-500 text-xs mt-3">Contact support for custom token packages</p></div></div>';
            }

            root.innerHTML = html;
            attachEventListeners();
        }

        function renderLoading() {
            return '<div class="loading-overlay">' +
                '<div class="loading-card">' +
                '<div class="spinner"></div>' +
                '<h3 class="text-xl font-bold text-white mb-2">Processing...</h3>' +
                '<p class="text-gray-400">AI is working its magic</p>' +
                '</div></div>';
        }

        function renderGlobalHeader() {
            var html = '<div class="global-header">';
            html += '<div class="global-header-content">';

            // Back to dashboard
            html += '<a href="/video-optimizer" class="header-back-btn">';
            html += '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>';
            html += '<span>Dashboard</span>';
            html += '</a>';

            // Token display (clickable)
            html += '<div class="header-token-display" onclick="app.showTokenModal()" style="cursor:pointer;">';
            html += '<span>🪙</span>';
            html += '<span class="token-value">' + state.tokens.balance + '</span>';
            html += '<span class="token-label">tokens</span>';
            html += '</div>';

            html += '</div></div>';
            return html;
        }

        function renderWizardHeader() {
            var html = '<div class="wizard-header">';
            html += '<h1 class="wizard-title">🎬 AI Video-to-Shorts Wizard</h1>';
            html += '<p class="wizard-subtitle">Transform long videos into viral short-form clips with AI</p>';
            html += '</div>';
            return html;
        }

        function renderStepper() {
            const steps = [
                { num: 1, label: 'Video Input' },
                { num: 2, label: 'AI Analysis' },
                { num: 3, label: 'Select Clips' },
                { num: 4, label: 'Customize' },
                { num: 5, label: 'SEO & Thumbnails' },
                { num: 6, label: 'Export' }
            ];

            var html = '<div class="wizard-stepper">';

            steps.forEach(function(step, index) {
                var stepClass = 'wizard-step';
                if (step.num === state.currentStep) stepClass += ' active';
                if (step.num < state.currentStep) stepClass += ' completed';

                html += '<div class="' + stepClass + '" onclick="app.goToStep(' + step.num + ')">';
                html += '<div class="step-number">';
                if (step.num < state.currentStep) {
                    html += '✓';
                } else {
                    html += step.num;
                }
                html += '</div>';
                html += '<span class="step-label">' + step.label + '</span>';
                html += '</div>';

                if (index < steps.length - 1) {
                    var connectorClass = step.num < state.currentStep ? 'step-connector completed' : 'step-connector';
                    html += '<div class="' + connectorClass + '"></div>';
                }
            });

            html += '</div>';
            return html;
        }

        /* ==========================================
           STEP 1: VIDEO INPUT
           ========================================== */

        function renderStep1VideoInput() {
            var html = '';

            // Platform Selection Section - Compact single row
            html += '<div class="platform-selection-section">';
            html += '<div class="platform-cards-grid">';

            // All platform cards in one row
            var allPlatforms = ['youtube-shorts', 'tiktok-viral', 'instagram-reels', 'podcast-clip', 'gaming-highlight', 'multi-platform'];
            allPlatforms.forEach(function(platformId) {
                var preset = PLATFORM_PRESETS[platformId];
                var isSelected = state.contentType.selected === platformId;
                html += '<div class="platform-card' + (isSelected ? ' selected' : '') + '" onclick="app.selectPlatform(\'' + platformId + '\')">';
                html += '<span class="platform-card-icon">' + preset.icon + '</span>';
                html += '<div class="platform-card-name">' + preset.name + '</div>';
                html += '<div class="platform-card-subtitle">' + preset.subtitle + '</div>';
                html += '<div class="platform-card-duration">' + preset.durationRange + 's</div>';
                html += '</div>';
            });

            html += '</div>'; // .platform-cards-grid
            html += '</div>'; // .platform-selection-section

            // Dropzone
            html += '<div class="video-dropzone" id="dropzone">';
            html += '<div class="dropzone-icon">🎬</div>';
            html += '<h3 class="dropzone-title">Drop a long video and get clips</h3>';
            html += '<p class="dropzone-subtitle">Paste a YouTube URL or upload a video file</p>';

            // URL Input
            html += '<div class="url-input-container">';
            html += '<input type="text" class="url-input" id="video-url" placeholder="https://youtube.com/watch?v=..." value="' + utils.escapeHtml(state.videoInput.url) + '">';
            html += '<button class="btn-primary" onclick="app.analyzeVideo()">Get Clips</button>';
            html += '</div>';

            // Extension Status Indicator
            html += '<div class="extension-status">';
            if (state.extension.checking) {
                html += '<span class="extension-status-checking">';
                html += '<span class="extension-dot checking"></span> Checking for extension...';
                html += '</span>';
            } else if (state.extension.installed) {
                html += '<span class="extension-status-connected">';
                html += '<span class="extension-dot connected"></span> Extension Connected';
                html += '<span class="extension-badge">v' + (state.extension.version || '1.0') + '</span>';
                html += '</span>';
            } else {
                html += '<span class="extension-status-info">';
                html += '<span class="extension-dot disconnected"></span> Extension not installed';
                html += '<a href="https://github.com/Newpixel-net/youtube-video-optimizer-saas/tree/main/browser-extension" target="_blank" class="extension-install-link">Install</a>';
                html += '</span>';
            }
            html += '</div>';

            // Extension Promotion Banner (shown when extension not installed)
            if (!state.extension.installed && !state.extension.checking) {
                html += '<div class="extension-promo-banner">';
                html += '<span class="savings-badge">RECOMMENDED FOR YOUTUBE</span>';
                html += '<h4><span>🚀</span> Install Extension for Reliable YouTube Export</h4>';
                html += '<p>YouTube blocks server-side downloads. The extension captures videos directly from your browser - <strong>100% reliable</strong>, no restrictions!</p>';
                html += '<a href="https://github.com/Newpixel-net/youtube-video-optimizer-saas/tree/main/browser-extension" target="_blank" class="btn-install-extension">';
                html += '<span>📦</span> Install Extension <span class="free-tag">FREE</span>';
                html += '</a>';
                html += '<div class="extension-features">';
                html += '<span class="extension-feature"><span class="extension-feature-icon">✓</span> Bypasses all YouTube restrictions</span>';
                html += '<span class="extension-feature"><span class="extension-feature-icon">✓</span> Captures any video segment</span>';
                html += '<span class="extension-feature"><span class="extension-feature-icon">✓</span> 100% free & reliable</span>';
                html += '</div>';
                html += '</div>';
            }

            // OR Divider
            html += '<div class="upload-divider"><span>OR</span></div>';

            // File Upload Button
            html += '<div class="file-upload-container">';
            html += '<input type="file" id="video-file-input" accept="video/*" style="display:none" onchange="app.handleVideoUpload(this)">';
            html += '<button class="btn-upload" onclick="document.getElementById(\'video-file-input\').click()">';
            html += '<span class="upload-icon">📤</span> Upload Video from Device';
            html += '</button>';
            html += '<p class="upload-hint">Supports MP4, MOV, AVI, WebM (max 500MB)</p>';
            html += '</div>';

            // Upload Progress (if uploading)
            if (state.videoInput.uploading) {
                html += '<div class="upload-progress-container">';
                html += '<div class="upload-progress-bar">';
                html += '<div class="upload-progress-fill" style="width: ' + (state.videoInput.uploadProgress || 0) + '%"></div>';
                html += '</div>';
                html += '<span class="upload-progress-text">Uploading... ' + (state.videoInput.uploadProgress || 0) + '%</span>';
                html += '</div>';
            }

            // Uploaded File Info (if uploaded)
            if (state.videoInput.uploadedFile) {
                html += '<div class="uploaded-file-info">';
                html += '<span class="uploaded-file-icon">✅</span>';
                html += '<div class="uploaded-file-details">';
                html += '<span class="uploaded-file-name">' + utils.escapeHtml(state.videoInput.uploadedFile.name) + '</span>';
                html += '<span class="uploaded-file-size">' + utils.formatFileSize(state.videoInput.uploadedFile.size) + '</span>';
                html += '</div>';
                html += '<button class="remove-file-btn" onclick="app.removeUploadedFile()">✕</button>';
                html += '</div>';
            }

            html += '</div>';

            // Video Preview (if URL entered)
            if (state.videoInput.videoData) {
                html += '<div class="video-preview-container">';
                html += '<div class="video-preview-info">';
                html += '<img src="' + state.videoInput.videoData.thumbnail + '" alt="Video thumbnail" class="video-thumbnail">';
                html += '<div class="video-details">';
                html += '<h4>' + utils.escapeHtml(state.videoInput.videoData.title) + '</h4>';
                html += '<p>Duration: ' + utils.formatFullDuration(state.videoInput.videoData.duration) + '</p>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
            }

            // Options Panel
            html += '<div class="options-panel">';

            var options = [
                { key: 'generateCaptions', label: 'Generate captions', icon: '💬' },
                { key: 'generateThumbnails', label: 'Generate thumbnails (2 A/B)', icon: '🖼️' },
                { key: 'seoOptimization', label: 'SEO optimization', icon: '🔍' },
                { key: 'multiPlatform', label: 'Multi-platform export', icon: '📱' }
            ];

            options.forEach(function(opt) {
                var checked = state.videoInput.options[opt.key];
                var checkedClass = checked ? ' checked' : '';
                html += '<label class="option-checkbox' + checkedClass + '">';
                html += '<input type="checkbox" ' + (checked ? 'checked' : '') + ' onchange="app.toggleOption(\'' + opt.key + '\')">';
                html += '<span>' + opt.icon + ' ' + opt.label + '</span>';
                html += '</label>';
            });

            html += '</div>';

            // YouTube Connection Panel (Required for Video Export)
            html += '<div class="youtube-connection-step1">';
            html += '<div class="youtube-connection-step1-header">';
            html += '<span class="youtube-icon-large">';
            html += '<svg viewBox="0 0 24 24" width="24" height="24" fill="#ff0000"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>';
            html += '</span>';
            html += '<div class="youtube-connection-step1-title">';
            html += '<h3>Connect YouTube Account</h3>';
            html += '<p>Required for video export functionality</p>';
            html += '</div>';
            html += '</div>';

            if (state.youtubeConnection.loading) {
                html += '<div class="youtube-connection-step1-status loading">';
                html += '<div class="connection-loading-spinner"></div>';
                html += '<span>Connecting...</span>';
                html += '</div>';
            } else if (state.youtubeConnection.connected && state.youtubeConnection.channel) {
                html += '<div class="youtube-connection-step1-status connected">';
                if (state.youtubeConnection.channel.thumbnail) {
                    html += '<img src="' + state.youtubeConnection.channel.thumbnail + '" alt="Channel" class="youtube-channel-thumb-small">';
                } else {
                    html += '<div class="youtube-channel-icon-small">✓</div>';
                }
                html += '<div class="youtube-connection-step1-info">';
                html += '<span class="youtube-connected-name">' + utils.escapeHtml(state.youtubeConnection.channel.title || 'Connected') + '</span>';
                html += '<span class="youtube-connected-label">YouTube Connected</span>';
                html += '</div>';
                html += '<button class="youtube-disconnect-btn-small" onclick="app.disconnectYouTube()" title="Disconnect">✕</button>';
                html += '</div>';
            } else {
                if (state.youtubeConnection.error) {
                    html += '<div class="youtube-connection-error-small">' + utils.escapeHtml(state.youtubeConnection.error) + '</div>';
                }
                html += '<button class="youtube-connect-btn-step1" onclick="app.connectYouTube()">';
                html += '<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>';
                html += ' Connect YouTube to Enable Export';
                html += '</button>';
            }
            html += '</div>';

            // My Projects Section
            html += '<div class="my-projects-section">';
            html += '<div class="my-projects-header">';
            html += '<h3>📁 My Projects</h3>';
            html += '<button class="refresh-btn" onclick="app.loadMyProjects()">🔄 Refresh</button>';
            html += '</div>';

            if (state.projectsLoading) {
                html += '<div class="projects-loading">Loading your projects...</div>';
            } else if (!state.projectsLoaded) {
                html += '<div class="projects-empty">';
                html += '<p>Click refresh to load your saved projects</p>';
                html += '</div>';
            } else if (state.myProjects.length === 0) {
                html += '<div class="projects-empty">';
                html += '<p>No saved projects yet. Create your first project above!</p>';
                html += '</div>';
            } else {
                html += '<div class="projects-grid">';
                state.myProjects.forEach(function(project) {
                    var statusClass = project.status || 'draft';
                    var lastUpdated = project.updatedAt ? utils.formatDate(project.updatedAt) : 'Unknown';

                    html += '<div class="project-card">';
                    html += '<div class="project-card-header">';
                    html += '<img src="' + (project.videoThumbnail || project.thumbnail || 'https://picsum.photos/seed/' + project.id + '/80/45') + '" alt="Project" class="project-thumbnail">';
                    html += '<div class="project-info">';
                    html += '<div class="project-title">' + utils.escapeHtml(project.videoTitle || 'Untitled Project') + '</div>';
                    html += '<div class="project-meta">' + lastUpdated + '</div>';
                    html += '</div>';
                    html += '</div>';

                    html += '<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">';
                    html += '<span class="project-status-badge ' + statusClass + '">' + statusClass + '</span>';
                    html += '<div class="project-stats">';
                    html += '<span>🎬 ' + (project.clipCount || 0) + ' clips</span>';
                    html += '</div>';
                    html += '</div>';

                    html += '<div class="project-actions">';
                    html += '<button class="project-action-btn primary" onclick="event.stopPropagation(); app.loadProject(\'' + project.id + '\')">📂 Open</button>';
                    html += '<button class="project-action-btn" onclick="event.stopPropagation(); app.duplicateProject(\'' + project.id + '\')">📋 Duplicate</button>';
                    html += '<button class="project-action-btn" onclick="event.stopPropagation(); app.archiveProject(\'' + project.id + '\')">📦 Archive</button>';
                    html += '</div>';
                    html += '</div>';
                });
                html += '</div>';
            }
            html += '</div>';

            // Navigation
            html += '<div class="wizard-nav">';
            html += '<div class="wizard-nav-left"></div>';
            html += '<div class="wizard-nav-right">';
            html += '<button class="btn-primary" onclick="app.analyzeVideo()" ' + (!state.videoInput.url ? 'disabled' : '') + '>';
            html += 'Analyze Video <span>→</span>';
            html += '</button>';
            html += '</div>';
            html += '</div>';

            return html;
        }

        /* ==========================================
           STEP 2: AI ANALYSIS
           ========================================== */

        function renderStep2Analysis() {
            var html = '<div class="analysis-container">';

            // Video info
            if (state.videoInput.videoData) {
                html += '<div class="analysis-video-info">';
                html += '<img src="' + state.videoInput.videoData.thumbnail + '" alt="Video">';
                html += '<div>';
                html += '<div class="video-title">' + utils.escapeHtml(state.videoInput.videoData.title) + '</div>';
                html += '<div class="video-duration">' + utils.formatFullDuration(state.videoInput.videoData.duration) + '</div>';
                html += '</div>';
                html += '</div>';
            }

            // Progress bar
            html += '<div class="progress-container">';
            html += '<div class="progress-bar-bg">';
            html += '<div class="progress-bar-fill" style="width: ' + state.analysis.progress + '%"></div>';
            html += '</div>';
            html += '<div class="progress-percentage">' + state.analysis.progress + '%</div>';
            html += '</div>';

            // Steps list
            html += '<div class="analysis-steps">';
            state.analysis.steps.forEach(function(step) {
                var stepClass = 'analysis-step ' + step.status;
                var icon = step.status === 'done' ? '✅' : step.status === 'processing' ? '🔄' : '⏳';
                html += '<div class="' + stepClass + '">';
                html += '<div class="analysis-step-icon">' + icon + '</div>';
                html += '<span class="analysis-step-text">' + step.name + '</span>';
                html += '</div>';
            });
            html += '</div>';

            html += '</div>';

            // Navigation (hidden during processing)
            if (state.analysis.status === 'done') {
                html += '<div class="wizard-nav">';
                html += '<div class="wizard-nav-left">';
                html += '<button class="btn-secondary" onclick="app.goToStep(1)">← Back</button>';
                html += '</div>';
                html += '<div class="wizard-nav-right">';
                html += '<button class="btn-primary" onclick="app.goToStep(3)">View Clips →</button>';
                html += '</div>';
                html += '</div>';
            }

            return html;
        }

        /* ==========================================
           STEP 3: CLIP SELECTION
           ========================================== */

        function renderStep3ClipSelection() {
            var html = '';
            var displayedClips = state.clips.slice(0, state.displayedClipCount);
            var hasMoreClips = state.clips.length > state.displayedClipCount;
            var remainingClips = state.clips.length - state.displayedClipCount;
            var createMoreCost = 5; // Token cost for creating more clips

            // Header
            html += '<div class="clips-header">';
            if (hasMoreClips) {
                html += '<h2>Showing ' + displayedClips.length + ' of ' + state.clips.length + ' Clips</h2>';
            } else {
                html += '<h2>Found ' + state.clips.length + ' Clips</h2>';
            }
            html += '<div class="clips-header-actions">';
            html += '<button class="btn-secondary" onclick="app.selectAllClips()">Select All</button>';
            html += '<button class="btn-secondary" onclick="app.deselectAllClips()">Deselect All</button>';
            html += '</div>';
            html += '</div>';

            // Clip Grid (only show displayed clips)
            html += '<div class="clip-grid">';
            displayedClips.forEach(function(clip, index) {
                var isSelected = state.selectedClipIds.indexOf(clip.id) !== -1;
                var cardClass = isSelected ? 'clip-card selected' : 'clip-card';
                var scoreClass = utils.getScoreClass(clip.score);

                html += '<div class="' + cardClass + '" onclick="app.toggleClipSelection(\'' + clip.id + '\')">';

                // Thumbnail with play button (use placeholder if missing)
                var thumbUrl = clip.thumbnail || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="320" height="180" viewBox="0 0 320 180"%3E%3Crect fill="%231a1a2e" width="320" height="180"/%3E%3Ctext x="160" y="85" fill="%23ec4899" font-family="sans-serif" font-size="24" text-anchor="middle"%3E🎬%3C/text%3E%3Ctext x="160" y="110" fill="%23888" font-family="sans-serif" font-size="12" text-anchor="middle"%3EClip ' + (index + 1) + '%3C/text%3E%3C/svg%3E';
                html += '<div class="clip-thumbnail">';
                html += '<img src="' + thumbUrl + '" alt="Clip thumbnail">';
                html += '<span class="clip-duration">' + utils.formatDuration(clip.duration) + '</span>';
                html += '<span class="clip-format-badge">→ 9:16</span>';
                html += '<div class="clip-checkbox">' + (isSelected ? '✓' : '') + '</div>';
                html += '<div class="clip-play-btn" onclick="event.stopPropagation(); app.previewClip(\'' + clip.id + '\')" title="Preview clip"></div>';
                html += '</div>';

                // Info
                html += '<div class="clip-info">';

                // Score
                html += '<div class="clip-score">';
                html += '<div class="virality-score ' + scoreClass + '">';
                html += '<span>🔥 ' + clip.score + '</span>';
                html += '<div class="score-bar"><div class="score-bar-fill" style="width: ' + clip.score + '%"></div></div>';
                html += '</div>';
                html += '</div>';

                // Transcript preview
                html += '<p class="clip-transcript">"' + utils.escapeHtml(clip.transcript) + '"</p>';

                // Platforms
                html += '<div class="clip-platforms">';
                clip.platforms.forEach(function(platform) {
                    html += '<span class="platform-badge active">' + utils.getPlatformIcon(platform) + '</span>';
                });
                html += '</div>';

                html += '</div>'; // clip-info
                html += '</div>'; // clip-card
            });
            html += '</div>';

            // "Create more" button when there are hidden clips
            if (hasMoreClips) {
                var nextBatch = Math.min(10, remainingClips);
                var canAfford = state.tokens.balance >= createMoreCost;
                html += '<div class="create-more-section">';
                html += '<div class="create-more-info">';
                html += '<span class="create-more-count">+' + remainingClips + ' more clips available</span>';
                html += '</div>';
                html += '<button class="btn-create-more' + (state.createMoreLoading ? ' loading' : '') + (!canAfford ? ' disabled' : '') + '" ';
                html += 'onclick="app.createMoreClips()" ' + (!canAfford || state.createMoreLoading ? 'disabled' : '') + '>';
                if (state.createMoreLoading) {
                    html += '<span class="spinner"></span> Loading...';
                } else {
                    html += 'Show ' + nextBatch + ' More Clips <span class="token-cost">' + createMoreCost + ' tokens</span>';
                }
                html += '</button>';
                if (!canAfford) {
                    html += '<p class="create-more-warning">Not enough tokens. You have ' + state.tokens.balance + ' tokens.</p>';
                }
                html += '</div>';
            }

            // Platform Legend
            html += '<div class="platform-legend">';
            ['youtube', 'instagram', 'tiktok', 'linkedin', 'facebook', 'twitter'].forEach(function(platform) {
                html += '<div class="legend-item">';
                html += '<span>' + utils.getPlatformIcon(platform) + '</span>';
                html += '<span>' + utils.getPlatformName(platform) + '</span>';
                html += '</div>';
            });
            html += '</div>';

            // Navigation
            html += '<div class="wizard-nav">';
            html += '<div class="wizard-nav-left">';
            html += '<button class="btn-secondary" onclick="app.goToStep(1)">← Start Over</button>';
            html += '</div>';
            html += '<div class="wizard-nav-right">';
            html += '<button class="btn-primary" onclick="app.goToStep(4)" ' + (state.selectedClipIds.length === 0 ? 'disabled' : '') + '>';
            html += 'Customize Selected (' + state.selectedClipIds.length + ') →';
            html += '</button>';
            html += '</div>';
            html += '</div>';

            return html;
        }

        /* ==========================================
           STEP 4: CUSTOMIZATION STUDIO
           ========================================== */

        function renderStep4Customization() {
            var selectedClips = state.clips.filter(function(c) {
                return state.selectedClipIds.indexOf(c.id) !== -1;
            });
            var activeClip = selectedClips[state.customization.activeClipIndex] || selectedClips[0];
            var settings = state.clipSettings[activeClip.id] || getDefaultSettings();

            var html = '<div class="customization-layout">';

            // Left: Phone Preview
            html += '<div class="phone-preview-container">';

            // Clip info header
            html += '<div class="clip-info-header">';
            html += '<div class="clip-info-title">' + utils.escapeHtml(activeClip.aiSummary || activeClip.transcript || 'Clip ' + (state.customization.activeClipIndex + 1)).substring(0, 60) + '</div>';
            html += '<div class="clip-info-meta">';
            html += '<span class="clip-meta-item">⏱️ ' + utils.formatDuration(activeClip.duration) + '</span>';
            html += '<span class="clip-meta-item">🔥 ' + activeClip.score + ' viral score</span>';
            html += '<span class="clip-meta-item">📍 ' + utils.formatDuration(activeClip.startTime) + ' - ' + utils.formatDuration(activeClip.endTime) + '</span>';
            html += '</div>';
            html += '</div>';

            // Source Video Preview with Crop Guides (shows 16:9 original with 9:16 crop overlay)
            var sourceVideoId = state.videoInput.videoData?.videoId || '';
            var sourceIsUpload = state.videoInput.isUpload || false;
            var sourceUploadUrl = state.videoInput.uploadedFile?.url || state.videoInput.videoData?.uploadedVideoUrl || '';
            var sourceThumbnail = activeClip.thumbnail || (sourceVideoId ? 'https://img.youtube.com/vi/' + sourceVideoId + '/maxresdefault.jpg' : '');
            // Convert legacy string values to percentage and validate
            var sourceCropPos = settings.cropPosition;
            if (sourceCropPos === 'left') sourceCropPos = 0;
            else if (sourceCropPos === 'center') sourceCropPos = 50;
            else if (sourceCropPos === 'right') sourceCropPos = 100;
            else if (typeof sourceCropPos !== 'number' || isNaN(sourceCropPos)) sourceCropPos = 50;
            // Clamp to valid range
            sourceCropPos = Math.max(0, Math.min(100, sourceCropPos));

            // Calculate crop zone position: 0% means left edge, 100% means right edge
            // The crop zone is 31.64% width (correct ratio for 16:9→9:16 = (9/16)²)
            // This matches the backend FFmpeg calculation: cropX = (percent/100) * (width - cropWidth)
            var cropZoneWidth = 31.640625; // (9/16)² × 100 = 81/256 × 100
            var cropZoneLeft = (sourceCropPos / 100) * (100 - cropZoneWidth); // Max left position is 68.36%

            html += '<div class="source-preview-container">';
            html += '<div class="source-preview-header">';
            html += '<span class="source-preview-label">📺 Source Video (16:9) → 9:16 Crop</span>';
            if (settings.aiSmartCrop) {
                html += '<span class="ai-crop-badge">✨ AI Detected</span>';
            }
            html += '</div>';
            html += '<div class="source-preview-video" id="cropPreviewArea">';

            // Show video based on source type
            if (sourceIsUpload && sourceUploadUrl) {
                // For uploaded videos, show the video element at clip start time
                html += '<video src="' + sourceUploadUrl + '#t=' + (activeClip.startTime || 0) + '" muted playsinline></video>';
            } else if (sourceVideoId) {
                // For YouTube videos, embed an iframe at the clip's start time
                var startSeconds = Math.floor(activeClip.startTime || 0);
                html += '<iframe ';
                html += 'src="https://www.youtube.com/embed/' + sourceVideoId + '?start=' + startSeconds + '&autoplay=0&mute=1&controls=0&modestbranding=1&rel=0&showinfo=0" ';
                html += 'frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" ';
                html += 'style="width: 100%; height: 100%; position: absolute; top: 0; left: 0;" ';
                html += 'allowfullscreen></iframe>';
            } else if (sourceThumbnail) {
                // Fallback to thumbnail if no video source
                html += '<img src="' + sourceThumbnail + '" alt="Source video" onerror="this.src=\'https://img.youtube.com/vi/' + sourceVideoId + '/hqdefault.jpg\'">';
            }

            // Crop guide overlay - draggable zone with percentage positioning
            html += '<div class="crop-guide-overlay">';
            html += '<div class="crop-guide-zone" id="cropGuideZone" style="left: ' + cropZoneLeft + '%;" data-position="' + sourceCropPos + '">';
            html += '<div class="crop-guide-label">' + (settings.aiSmartCrop ? '✨ AI Smart Crop' : '9:16 Output Area') + '</div>';
            html += '<div class="crop-drag-hint">← Drag to adjust →</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>'; // source-preview-video

            // Crop position slider control
            html += '<div class="crop-slider-container">';
            html += '<div class="crop-slider-row">';
            html += '<span class="crop-slider-label">◀ Left</span>';
            html += '<input type="range" class="crop-slider" id="cropSlider" min="0" max="100" value="' + sourceCropPos + '" oninput="app.onCropSliderChange(this.value)" onchange="app.setCropPosition(this.value)">';
            html += '<span class="crop-slider-label">Right ▶</span>';
            html += '</div>';
            html += '<div class="crop-slider-value">' + sourceCropPos + '%</div>';
            html += '</div>';

            // Quick position buttons + AI Smart Crop
            html += '<div class="crop-controls-row">';
            html += '<div class="crop-quick-buttons">';
            html += '<button class="crop-quick-btn' + (sourceCropPos === 0 ? ' active' : '') + '" onclick="app.setCropPosition(0)" title="Left edge">◀</button>';
            html += '<button class="crop-quick-btn' + (sourceCropPos === 50 ? ' active' : '') + '" onclick="app.setCropPosition(50)" title="Center">●</button>';
            html += '<button class="crop-quick-btn' + (sourceCropPos === 100 ? ' active' : '') + '" onclick="app.setCropPosition(100)" title="Right edge">▶</button>';
            html += '</div>';
            html += '<button class="btn-ai-smart-crop' + (settings.aiSmartCrop ? ' active' : '') + '" onclick="app.runAiSmartCrop()" title="AI detects the main subject and auto-positions the crop">';
            html += '<span class="ai-icon">✨</span> AI Smart Crop';
            html += '</button>';
            html += '</div>';
            html += '</div>'; // source-preview-container

            // Output Preview Label
            html += '<div style="text-align: center; margin-bottom: 0.5rem; font-size: 0.8rem; color: rgba(255,255,255,0.6);">📱 Output Preview (9:16)</div>';

            html += '<div class="phone-frame">';

            // Build phone-screen classes with visual effects
            var reframeMode = settings.reframeMode || 'auto_center';
            // Convert legacy string crop positions to percentage
            var cropPosRaw = settings.cropPosition;
            var cropPosPercent;
            if (cropPosRaw === 'left') cropPosPercent = 0;
            else if (cropPosRaw === 'center') cropPosPercent = 50;
            else if (cropPosRaw === 'right') cropPosPercent = 100;
            else if (typeof cropPosRaw === 'number') cropPosPercent = cropPosRaw;
            else cropPosPercent = 50;
            var phoneScreenClasses = 'phone-screen';
            if (settings.vignette) phoneScreenClasses += ' effect-vignette';
            if (settings.autoZoom) phoneScreenClasses += ' effect-zoom';
            if (settings.colorGrade) phoneScreenClasses += ' effect-colorgrade';

            html += '<div class="' + phoneScreenClasses + '">';

            // Video preview setup
            var embedStart = activeClip.startTime || 0;
            var videoId = state.videoInput.videoData?.videoId || '';
            var isUpload = state.videoInput.isUpload || false;
            var uploadedVideoUrl = state.videoInput.uploadedFile?.url || state.videoInput.videoData?.uploadedVideoUrl || '';

            // Get thumbnail URLs
            var ytThumbnail = videoId ? 'https://img.youtube.com/vi/' + videoId + '/maxresdefault.jpg' : '';
            var ytThumbnailFallback = videoId ? 'https://img.youtube.com/vi/' + videoId + '/hqdefault.jpg' : '';
            var imgErrorHandler = 'onerror="this.onerror=null; this.src=\'' + ytThumbnailFallback + '\';"';

            // Helper function to generate media element
            var getMediaElement = function(isPrimary) {
                var audioMix = settings.audioMix || { primaryMuted: false, secondaryMuted: true };
                var shouldMute = isPrimary ? audioMix.primaryMuted : audioMix.secondaryMuted;
                var mutedAttr = shouldMute ? ' muted' : '';
                var dataTrack = isPrimary ? 'data-track="primary"' : 'data-track="secondary"';

                if (isUpload && uploadedVideoUrl) {
                    return '<video class="preview-media" ' + dataTrack + ' src="' + uploadedVideoUrl + '#t=' + embedStart + '" controls' + mutedAttr + ' playsinline></video>';
                }
                if (videoId) {
                    if (state.customization.playingInFrame) {
                        var embedUrl = 'https://www.youtube.com/embed/' + videoId +
                            '?autoplay=1&start=' + Math.floor(embedStart) +
                            '&modestbranding=1&rel=0&playsinline=1' + (shouldMute ? '&mute=1' : '');
                        return '<div class="preview-iframe-wrapper">' +
                               '<iframe ' + dataTrack + ' src="' + embedUrl + '" ' +
                               'allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" ' +
                               'allowfullscreen></iframe>' +
                               '</div>';
                    }
                    return '<img class="preview-media" src="' + ytThumbnail + '" alt="Video Preview" ' + imgErrorHandler + '>';
                }
                return '<div class="preview-media" style="background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%); display:flex; align-items:center; justify-content:center; color:#666; font-size:0.8rem;">No video</div>';
            };

            // Helper function to generate secondary source media element
            var secondarySource = settings.secondarySource || { enabled: false };
            var hasSecondaryVideo = secondarySource.enabled && (secondarySource.youtubeVideoId || secondarySource.uploadedUrl);

            var getSecondaryMediaElement = function() {
                if (!hasSecondaryVideo) return null;

                var audioMix = settings.audioMix || { secondaryMuted: true };
                var shouldMute = audioMix.secondaryMuted;
                var mutedAttr = shouldMute ? ' muted' : '';

                if (secondarySource.type === 'youtube' && secondarySource.youtubeVideoId) {
                    var secThumbnail = 'https://img.youtube.com/vi/' + secondarySource.youtubeVideoId + '/mqdefault.jpg';
                    if (state.customization.playingInFrame) {
                        var secEmbedUrl = 'https://www.youtube.com/embed/' + secondarySource.youtubeVideoId +
                            '?autoplay=1&modestbranding=1&rel=0&playsinline=1' + (shouldMute ? '&mute=1' : '');
                        return '<div class="preview-iframe-wrapper">' +
                               '<iframe data-track="secondary" src="' + secEmbedUrl + '" ' +
                               'allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" ' +
                               'allowfullscreen></iframe>' +
                               '</div>';
                    }
                    return '<img class="preview-media secondary-preview" src="' + secThumbnail + '" alt="Secondary Video">';
                } else if (secondarySource.type === 'upload' && secondarySource.uploadedUrl) {
                    return '<video class="preview-media secondary-preview" data-track="secondary" src="' + secondarySource.uploadedUrl + '" controls' + mutedAttr + ' playsinline></video>';
                }
                return null;
            };

            // Helper function to generate tertiary source media element (for three_person mode)
            var tertiarySource = settings.tertiarySource || { enabled: false };
            var hasTertiaryVideo = tertiarySource.enabled && (tertiarySource.youtubeVideoId || tertiarySource.uploadedUrl);

            var getTertiaryMediaElement = function() {
                if (!hasTertiaryVideo) return null;

                var audioMix = settings.audioMix || { tertiaryMuted: true };
                var shouldMute = audioMix.tertiaryMuted;
                var mutedAttr = shouldMute ? ' muted' : '';

                if (tertiarySource.type === 'youtube' && tertiarySource.youtubeVideoId) {
                    var tertThumbnail = 'https://img.youtube.com/vi/' + tertiarySource.youtubeVideoId + '/mqdefault.jpg';
                    if (state.customization.playingInFrame) {
                        var tertEmbedUrl = 'https://www.youtube.com/embed/' + tertiarySource.youtubeVideoId +
                            '?autoplay=1&modestbranding=1&rel=0&playsinline=1' + (shouldMute ? '&mute=1' : '');
                        return '<div class="preview-iframe-wrapper">' +
                               '<iframe data-track="tertiary" src="' + tertEmbedUrl + '" ' +
                               'allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" ' +
                               'allowfullscreen></iframe>' +
                               '</div>';
                    }
                    return '<img class="preview-media tertiary-preview" src="' + tertThumbnail + '" alt="Third Video">';
                } else if (tertiarySource.type === 'upload' && tertiarySource.uploadedUrl) {
                    return '<video class="preview-media tertiary-preview" data-track="tertiary" src="' + tertiarySource.uploadedUrl + '" controls' + mutedAttr + ' playsinline></video>';
                }
                return null;
            };

            var mediaElement = getMediaElement(true);
            var secondaryMediaElement = getSecondaryMediaElement();
            var tertiaryMediaElement = getTertiaryMediaElement();

            // Build phone-video-area with reframe mode class
            // Use data attribute for percentage-based crop positioning
            var videoAreaClasses = 'phone-video-area reframe-' + reframeMode;
            // Add multi-source class when secondary video is present (for different CSS positioning)
            if (hasSecondaryVideo && secondaryMediaElement) {
                videoAreaClasses += ' multi-source';
            }
            // Calculate object-position for percentage-based cropping
            var objectPosX = cropPosPercent + '%';

            // Calculate zoom for single video mode
            var videoZoom = (settings.zoom || 100) / 100;
            var videoZoomVar = ' --video-zoom: ' + videoZoom + ';';

            // Calculate CSS variables for split screen speaker positions
            var splitCssVars = '';
            if (reframeMode === 'split_screen') {
                var splitSettings = settings.splitScreenSettings || {
                    speaker1: { cropPosition: 50 },
                    speaker2: { cropPosition: 50 },
                    layoutRatio: '50-50',
                    border: { enabled: false, thickness: 2, color: '#ffffff' }
                };
                var speaker1Pos = splitSettings.speaker1?.cropPosition ?? 50;
                var speaker2Pos = splitSettings.speaker2?.cropPosition ?? 50;

                // Calculate layout ratio (flex values for CSS)
                var layoutRatio = splitSettings.layoutRatio || '50-50';
                var topRatio = 1, bottomRatio = 1;
                var topHeightFraction = 0.5, bottomHeightFraction = 0.5;
                if (layoutRatio === '60-40') {
                    topRatio = 1.5; bottomRatio = 1;
                    topHeightFraction = 0.6; bottomHeightFraction = 0.4;
                } else if (layoutRatio === '70-30') {
                    topRatio = 2.33; bottomRatio = 1;
                    topHeightFraction = 0.7; bottomHeightFraction = 0.3;
                }

                // Calculate scale factors based on aspect ratios
                // Assume 16:9 input for YouTube videos, 9:16 output
                var inputAspect = 16 / 9;  // 1.778
                var outputAspect = 9 / 16; // 0.5625
                // Half container aspect = (output width) / (half height) = 1 / (heightFraction / outputAspect)
                // For 50-50: halfAspect = 1 / (0.5 / 0.5625) = 1 / 0.889 = 1.125
                var topHalfAspect = outputAspect / topHeightFraction;
                var bottomHalfAspect = outputAspect / bottomHeightFraction;
                // Scale factor = inputAspect / halfAspect (when input is wider)
                var speaker1Scale = inputAspect / topHalfAspect;
                var speaker2Scale = inputAspect / bottomHalfAspect;

                // Calculate translate values: offset = (50 - position) * (scale - 1)
                // This positions the crop region correctly based on the scale
                var speaker1Translate = (50 - speaker1Pos) * (speaker1Scale - 1);
                var speaker2Translate = (50 - speaker2Pos) * (speaker2Scale - 1);

                // Border settings
                var border = splitSettings.border || { enabled: false, thickness: 2, color: '#ffffff' };
                var borderHeight = border.enabled ? (border.thickness || 2) : 0;
                var borderColor = border.color || '#ffffff';

                // Zoom settings (100 = 1x, 200 = 2x)
                var speaker1Zoom = (splitSettings.speaker1?.zoom || 100) / 100;
                var speaker2Zoom = (splitSettings.speaker2?.zoom || 100) / 100;

                // Set CSS variables for scale, translate, zoom
                splitCssVars = ' --speaker1-scale: ' + speaker1Scale.toFixed(4) + ';';
                splitCssVars += ' --speaker2-scale: ' + speaker2Scale.toFixed(4) + ';';
                splitCssVars += ' --speaker1-translate-pct: ' + speaker1Translate.toFixed(2) + ';';
                splitCssVars += ' --speaker2-translate-pct: ' + speaker2Translate.toFixed(2) + ';';
                splitCssVars += ' --speaker1-zoom: ' + speaker1Zoom + ';';
                splitCssVars += ' --speaker2-zoom: ' + speaker2Zoom + ';';
                splitCssVars += ' --split-top-ratio: ' + topRatio + ';';
                splitCssVars += ' --split-bottom-ratio: ' + bottomRatio + ';';
                splitCssVars += ' --split-border-height: ' + borderHeight + 'px;';
                splitCssVars += ' --split-border-color: ' + borderColor + ';';
            }

            // Calculate CSS variables for three_person mode
            var threeCssVars = '';
            if (reframeMode === 'three_person') {
                var threeSettings = settings.threePersonSettings || {
                    main: { cropPosition: 50, zoom: 100 },
                    left: { cropPosition: 50, zoom: 100 },
                    right: { cropPosition: 50, zoom: 100 },
                    layoutRatio: '50-50',
                    preset: 'center'
                };
                var mainPos = threeSettings.main?.cropPosition ?? 50;
                var leftPos = threeSettings.left?.cropPosition ?? 50;
                var rightPos = threeSettings.right?.cropPosition ?? 50;

                // Calculate layout ratio
                var layoutRatio = threeSettings.layoutRatio || '50-50';
                var topHeightFraction = 0.5, bottomHeightFraction = 0.5;
                var topRatioFr = '1fr', bottomRatioFr = '1fr';
                if (layoutRatio === '60-40') {
                    topHeightFraction = 0.6; bottomHeightFraction = 0.4;
                    topRatioFr = '1.5fr'; bottomRatioFr = '1fr';
                } else if (layoutRatio === '70-30') {
                    topHeightFraction = 0.7; bottomHeightFraction = 0.3;
                    topRatioFr = '2.33fr'; bottomRatioFr = '1fr';
                }

                // Calculate scale factors based on aspect ratios
                // Assume 16:9 input for YouTube videos, 9:16 output
                var inputAspect = 16 / 9;  // 1.778
                var outputAspect = 9 / 16; // 0.5625

                // Main (top) takes full width, variable height
                var mainAspect = outputAspect / topHeightFraction;
                var mainScale = inputAspect / mainAspect;

                // Left and Right (bottom) each take half width, variable height
                // Bottom zone aspect = (outputWidth/2) / bottomHeight = (outputAspect/2) / bottomHeightFraction
                var bottomZoneAspect = (outputAspect / 2) / bottomHeightFraction;
                var bottomScale = inputAspect / bottomZoneAspect;

                // Calculate translate values: offset = (50 - position) * (scale - 1)
                var mainTranslate = (50 - mainPos) * (mainScale - 1);
                var leftTranslate = (50 - leftPos) * (bottomScale - 1);
                var rightTranslate = (50 - rightPos) * (bottomScale - 1);

                // Zoom settings (100 = 1x, 200 = 2x)
                var mainZoom = (threeSettings.main?.zoom || 100) / 100;
                var leftZoom = (threeSettings.left?.zoom || 100) / 100;
                var rightZoom = (threeSettings.right?.zoom || 100) / 100;

                // Set CSS variables
                threeCssVars = ' --main-scale: ' + mainScale.toFixed(4) + ';';
                threeCssVars += ' --main-translate-pct: ' + mainTranslate.toFixed(2) + ';';
                threeCssVars += ' --main-zoom: ' + mainZoom + ';';
                threeCssVars += ' --left-scale: ' + bottomScale.toFixed(4) + ';';
                threeCssVars += ' --left-translate-pct: ' + leftTranslate.toFixed(2) + ';';
                threeCssVars += ' --left-zoom: ' + leftZoom + ';';
                threeCssVars += ' --right-scale: ' + bottomScale.toFixed(4) + ';';
                threeCssVars += ' --right-translate-pct: ' + rightTranslate.toFixed(2) + ';';
                threeCssVars += ' --right-zoom: ' + rightZoom + ';';
                threeCssVars += ' --three-top-ratio: ' + topRatioFr + ';';
                threeCssVars += ' --three-bottom-ratio: ' + bottomRatioFr + ';';
            }

            html += '<div class="' + videoAreaClasses + '" data-crop-percent="' + cropPosPercent + '" style="--crop-position: ' + objectPosX + ';' + videoZoomVar + splitCssVars + threeCssVars + '">';

            // Generate reframe-specific content
            // Determine which media goes where based on secondary position
            var secPosition = secondarySource.position || 'bottom';

            if (reframeMode === 'split_screen') {
                // Split screen: Two videos stacked vertically
                var topMedia, bottomMedia, topLabel, bottomLabel;
                if (hasSecondaryVideo && secondaryMediaElement) {
                    if (secPosition === 'top') {
                        topMedia = secondaryMediaElement;
                        bottomMedia = mediaElement;
                        topLabel = 'Secondary';
                        bottomLabel = 'Primary';
                    } else {
                        topMedia = mediaElement;
                        bottomMedia = secondaryMediaElement;
                        topLabel = 'Primary';
                        bottomLabel = 'Secondary';
                    }
                } else {
                    // No secondary - split primary video
                    topMedia = mediaElement;
                    bottomMedia = mediaElement;
                    topLabel = 'Top';
                    bottomLabel = 'Bottom';
                }
                html += '<div class="split-preview-top">' + topMedia + '<span class="split-label">' + topLabel + '</span></div>';
                // Add border line between top and bottom (visible only when border is enabled via CSS var)
                html += '<div class="split-border-line"></div>';
                html += '<div class="split-preview-bottom">' + bottomMedia + '<span class="split-label">' + bottomLabel + '</span></div>';

                // Add preview play button for split screen
                if (!state.customization.playingInFrame) {
                    html += '<button class="split-preview-play-btn" onclick="app.playInFrameVideo()" title="Preview split screen">';
                    html += '<span class="play-icon">▶</span>';
                    html += '<span class="play-label">Preview</span>';
                    html += '</button>';
                } else {
                    html += '<button class="split-preview-stop-btn" onclick="app.stopInFrameVideo()" title="Stop preview">';
                    html += '✕ Stop';
                    html += '</button>';
                }
            } else if (reframeMode === 'three_person') {
                // Three person: Main top, two bottom (left=secondary, right=tertiary)
                var mainMedia = mediaElement, leftMedia = mediaElement, rightMedia = mediaElement;
                var mainLabel = 'Main', leftLabel = 'L', rightLabel = 'R';

                // Secondary source goes to bottom-left
                if (hasSecondaryVideo && secondaryMediaElement) {
                    leftMedia = secondaryMediaElement;
                    leftLabel = '2nd';
                }

                // Tertiary source goes to bottom-right
                if (hasTertiaryVideo && tertiaryMediaElement) {
                    rightMedia = tertiaryMediaElement;
                    rightLabel = '3rd';
                }

                html += '<div class="three-zone three-zone-main">' + mainMedia + '<span class="zone-label">' + mainLabel + '</span></div>';
                html += '<div class="three-zone three-zone-left">' + leftMedia + '<span class="zone-label">' + leftLabel + '</span></div>';
                html += '<div class="three-zone three-zone-right">' + rightMedia + '<span class="zone-label">' + rightLabel + '</span></div>';

                // Add preview play button for three person
                if (!state.customization.playingInFrame) {
                    html += '<button class="split-preview-play-btn" onclick="app.playInFrameVideo()" title="Preview three person">';
                    html += '<span class="play-icon">▶</span>';
                    html += '<span class="play-label">Preview</span>';
                    html += '</button>';
                } else {
                    html += '<button class="split-preview-stop-btn" onclick="app.stopInFrameVideo()" title="Stop preview">';
                    html += '✕ Stop';
                    html += '</button>';
                }
            } else if (reframeMode === 'gameplay') {
                // Gameplay: Main video (gameplay) with facecam overlay in corner
                // Primary video is always the gameplay, secondary is facecam
                html += mediaElement;
                // Facecam position class based on secPosition
                var facecamPosClass = 'facecam-' + (secPosition || 'bottom-right');
                var facecamContent = '<span>Facecam</span>';
                if (hasSecondaryVideo && secondaryMediaElement) {
                    facecamContent = secondaryMediaElement;
                }
                html += '<div class="facecam-preview ' + facecamPosClass + '">' + facecamContent + '</div>';
            } else if (reframeMode === 'broll_split') {
                // B-Roll: Main content + B-roll area
                var brollMainMedia = mediaElement, brollSpeakerMedia = mediaElement;
                var brollMainLabel = 'B-Roll', brollSpeakerLabel = 'Speaker';
                if (hasSecondaryVideo && secondaryMediaElement) {
                    if (secPosition === 'broll') {
                        brollMainMedia = secondaryMediaElement;
                        brollMainLabel = 'Secondary';
                    } else {
                        brollSpeakerMedia = secondaryMediaElement;
                        brollSpeakerLabel = 'Secondary';
                    }
                }
                html += '<div class="broll-main">' + brollMainMedia + '<span class="broll-label">' + brollMainLabel + '</span></div>';
                html += '<div class="broll-speaker">' + brollSpeakerMedia + '<span class="broll-label">' + brollSpeakerLabel + '</span></div>';
            } else {
                // Auto-center: Simple crop with play button
                html += mediaElement;
                if (videoId && !state.customization.playingInFrame) {
                    html += '<button class="video-preview-btn video-preview-btn-youtube" onclick="app.playInFrameVideo()" title="Play video">';
                    html += '<span class="play-icon">▶</span><span class="yt-label">Play</span></button>';
                } else if (state.customization.playingInFrame) {
                    html += '<button class="video-stop-btn" onclick="app.stopInFrameVideo()" title="Stop video">✕</button>';
                }
            }

            // Add audio indicator badges when multi-source is active
            if (hasSecondaryVideo) {
                html += '<div class="phone-audio-indicators">';
                var audioMix = settings.audioMix || { primaryMuted: false, secondaryMuted: true };
                html += '<div class="audio-indicator' + (audioMix.primaryMuted ? ' muted' : '') + '">🎙️ Primary ' + (audioMix.primaryMuted ? 'OFF' : (audioMix.primaryVolume || 100) + '%') + '</div>';
                html += '<div class="audio-indicator' + (audioMix.secondaryMuted ? ' muted' : '') + '">🎬 Secondary ' + (audioMix.secondaryMuted ? 'OFF' : (audioMix.secondaryVolume || 0) + '%') + '</div>';
                html += '</div>';
            }

            html += '</div>'; // phone-video-area

            // Reframe mode badge
            var reframeModeNames = {
                'auto_center': 'Center Crop',
                'split_screen': 'Split Screen',
                'three_person': 'Three Person',
                'gameplay': 'Gameplay',
                'broll_split': 'B-Roll'
            };
            html += '<div class="reframe-mode-badge">' + (reframeModeNames[reframeMode] || 'Crop') + '</div>';

            // Effects indicator badges
            var activeEffects = [];
            if (settings.autoZoom) activeEffects.push('Zoom');
            if (settings.vignette) activeEffects.push('Vignette');
            if (settings.colorGrade) activeEffects.push('Color');
            if (activeEffects.length > 0) {
                html += '<div class="effects-badge">';
                activeEffects.forEach(function(effect) {
                    html += '<span class="effect-indicator">' + effect + '</span>';
                });
                html += '</div>';
            }

            // Caption preview with actual transcript or styled fallback
            if (settings.captionStyle !== 'none') {
                // Add position class for custom captions
                var captionPosition = '';
                if (settings.captionStyle === 'custom' && settings.customCaptionStyle?.position) {
                    captionPosition = ' position-' + settings.customCaptionStyle.position;
                }
                html += '<div class="phone-caption-preview caption-' + settings.captionStyle + captionPosition + '">';
                html += '<p class="caption-text caption-animated">';

                // Get actual transcript words for preview (first 5-6 words)
                // Prioritize the actual transcript over AI summary
                var transcriptPreview = activeClip.transcript || activeClip.aiSummary || '';
                var previewWords = transcriptPreview.split(' ').slice(0, 6);
                var hasTranscript = previewWords.length > 2;

                // Determine caption source for indicator
                // Backend sets transcript = actualTranscript OR aiSummary (fallback)
                // If transcript === aiSummary, then no real YouTube captions were available
                var captionSource = 'sample';
                var captionSourceLabel = 'Style preview';
                var hasRealTranscript = activeClip.transcript &&
                    activeClip.transcript.length > 10 &&
                    activeClip.aiSummary &&
                    activeClip.transcript !== activeClip.aiSummary;

                if (hasRealTranscript) {
                    captionSource = 'transcript';
                    captionSourceLabel = 'YouTube captions';
                } else if (activeClip.transcript && activeClip.transcript.length > 10) {
                    // transcript exists but equals aiSummary - it's AI generated
                    captionSource = 'ai';
                    captionSourceLabel = 'AI description (not word-for-word)';
                } else if (activeClip.aiSummary && activeClip.aiSummary.length > 10) {
                    captionSource = 'ai';
                    captionSourceLabel = 'AI description (not word-for-word)';
                }

                if (settings.captionStyle === 'karaoke') {
                    if (hasTranscript) {
                        previewWords.forEach(function(word, i) {
                            var highlightClass = i === 1 ? ' highlight-anim' : '';
                            html += '<span class="word w' + (i+1) + highlightClass + '">' + utils.escapeHtml(word) + '</span> ';
                        });
                    } else {
                        html += '<span class="word w1">The</span> <span class="word w2 highlight-anim">biggest</span> <span class="word w3">mistake</span>';
                    }
                } else if (settings.captionStyle === 'beasty') {
                    if (hasTranscript) {
                        previewWords.slice(0, 3).forEach(function(word) {
                            html += '<span class="beasty-word">' + utils.escapeHtml(word.toUpperCase()) + '</span> ';
                        });
                    } else {
                        html += '<span class="beasty-word">BIGGEST</span> <span class="beasty-word">MISTAKE</span>';
                    }
                } else if (settings.captionStyle === 'deepdiver') {
                    html += hasTranscript ? utils.escapeHtml(previewWords.join(' ').toLowerCase()) : 'the biggest mistake entrepreneurs make';
                } else if (settings.captionStyle === 'podp') {
                    if (hasTranscript) {
                        previewWords.slice(0, 3).forEach(function(word, i) {
                            html += '<span class="fade-word w' + (i+1) + '">' + utils.escapeHtml(word) + '</span> ';
                        });
                    } else {
                        html += '<span class="fade-word w1">The</span> <span class="fade-word w2">biggest</span> <span class="fade-word w3">mistake...</span>';
                    }
                } else if (settings.captionStyle === 'hormozi') {
                    if (hasTranscript && previewWords.length >= 3) {
                        html += utils.escapeHtml(previewWords.slice(0, 2).join(' ')) + ' <span class="hormozi-highlight">' + utils.escapeHtml(previewWords[2].toUpperCase()) + '</span>...';
                    } else {
                        html += 'The biggest <span class="hormozi-highlight">MISTAKE</span>...';
                    }
                } else if (settings.captionStyle === 'ali') {
                    html += '<span class="glow-word">' + (hasTranscript ? utils.escapeHtml(previewWords.join(' ')) : 'The biggest mistake...') + '</span>';
                } else if (settings.captionStyle === 'custom') {
                    var customStyle = settings.customCaptionStyle || {};
                    var captionText = hasTranscript ? utils.escapeHtml(previewWords.join(' ')) : 'Your custom caption';
                    html += '<span style="color:' + (customStyle.color || '#ffffff') + ';font-size:' + (customStyle.fontSize || 1) + 'rem">' + captionText + '</span>';
                } else {
                    html += hasTranscript ? utils.escapeHtml(previewWords.join(' ') + '...') : 'The biggest mistake...';
                }
                html += '</p>';
                html += '</div>';

                // Add caption source indicator below phone-screen
                html += '<div class="caption-style-hint">';
                html += '<span class="caption-source-indicator source-' + captionSource + '"></span>';
                html += captionSourceLabel + ' • Final captions from audio';
                html += '</div>';
            }

            html += '</div>'; // phone-screen
            html += '</div>'; // phone-frame

            // Clip navigation
            html += '<div class="clip-nav">';
            html += '<button class="clip-nav-btn" onclick="app.prevClip()" ' + (state.customization.activeClipIndex === 0 ? 'disabled' : '') + '>← Prev</button>';
            html += '<span class="clip-counter">Clip ' + (state.customization.activeClipIndex + 1) + ' of ' + selectedClips.length + '</span>';
            html += '<button class="clip-nav-btn" onclick="app.nextClip()" ' + (state.customization.activeClipIndex >= selectedClips.length - 1 ? 'disabled' : '') + '>Next →</button>';
            html += '</div>';

            html += '</div>'; // phone-preview-container

            // Right: Customization Panels
            html += '<div class="customization-panels">';

            // Quick Presets Panel
            html += '<div class="customization-panel presets-panel">';
            html += '<div class="panel-header">';
            html += '<span class="panel-icon">⚡</span>';
            html += '<span class="panel-title">QUICK PRESETS</span>';
            html += '<span class="panel-preset-label">One-click setup</span>';
            html += '</div>';

            var presets = [
                { id: 'tiktok', name: 'TikTok Viral', icon: '🎵', desc: 'Trending style' },
                { id: 'youtube', name: 'YouTube Shorts', icon: '📺', desc: 'Platform optimized' },
                { id: 'instagram', name: 'Instagram Reels', icon: '📷', desc: 'Visual focus' },
                { id: 'podcast', name: 'Podcast Clip', icon: '🎙️', desc: 'Clean & clear' },
                { id: 'gaming', name: 'Gaming Highlight', icon: '🎮', desc: 'Action-packed' }
            ];

            html += '<div class="presets-grid">';
            presets.forEach(function(preset) {
                html += '<button class="preset-card" onclick="app.applyPreset(\'' + preset.id + '\')">';
                html += '<span class="preset-icon">' + preset.icon + '</span>';
                html += '<div class="preset-info">';
                html += '<div class="preset-name">' + preset.name + '</div>';
                html += '<div class="preset-desc">' + preset.desc + '</div>';
                html += '</div>';
                html += '</button>';
            });
            html += '</div>';
            html += '</div>';

            // Captions Panel with 7 styles + custom
            html += '<div class="customization-panel">';
            html += '<div class="panel-header">';
            html += '<span class="panel-icon">💬</span>';
            html += '<span class="panel-title">CAPTIONS</span>';
            html += '<span class="panel-preset-label">7 Styles</span>';
            html += '</div>';

            var captionStyles = [
                { id: 'none', name: 'None', preview: '—' },
                { id: 'karaoke', name: 'Karaoke', preview: '<span style="color:white">The </span><span style="color:#fbbf24;font-weight:700">biggest</span>' },
                { id: 'beasty', name: 'MrBeast', preview: '<span style="color:#fbbf24;font-weight:900;text-transform:uppercase;font-size:0.9rem">BOLD</span>' },
                { id: 'deepdiver', name: 'Minimal', preview: '<span style="font-weight:400;font-size:0.75rem;opacity:0.9">minimal style</span>' },
                { id: 'podp', name: 'Podcast', preview: '<span style="font-weight:500;letter-spacing:0.3px">Clean Text</span>' },
                { id: 'hormozi', name: 'Hormozi', preview: '<span style="background:linear-gradient(180deg,#22c55e,#16a34a);padding:2px 6px;border-radius:3px;font-weight:600">KEY</span>' },
                { id: 'ali', name: 'Ali', preview: '<span style="text-shadow:0 0 8px rgba(236,72,153,0.8)">Glow</span>' },
                { id: 'custom', name: 'Custom', preview: '✨', isCustom: true }
            ];

            html += '<div class="caption-styles-grid">';
            captionStyles.forEach(function(style) {
                var selectedClass = settings.captionStyle === style.id ? ' selected' : '';
                var customClass = style.isCustom ? ' custom-style' : '';
                html += '<div class="caption-style-card' + selectedClass + customClass + '" onclick="app.setCaptionStyle(\'' + style.id + '\')">';
                html += '<div class="caption-style-preview">' + style.preview + '</div>';
                html += '<div class="caption-style-name">' + style.name + '</div>';
                html += '</div>';
            });
            html += '</div>';

            // Custom caption configuration panel (shown when custom style is selected)
            if (settings.captionStyle === 'custom') {
                var customStyle = settings.customCaptionStyle || {};
                html += '<div class="custom-caption-panel">';
                html += '<div class="custom-caption-row">';
                html += '<span class="custom-caption-label">Color</span>';
                html += '<input type="color" class="custom-color-picker" value="' + (customStyle.color || '#ffffff') + '" onchange="app.setCustomCaptionStyle(\'color\', this.value)">';
                html += '<span class="custom-caption-label">Highlight</span>';
                html += '<input type="color" class="custom-color-picker" value="' + (customStyle.highlightColor || '#fbbf24') + '" onchange="app.setCustomCaptionStyle(\'highlightColor\', this.value)">';
                html += '</div>';
                html += '<div class="custom-caption-row">';
                html += '<span class="custom-caption-label">Size</span>';
                html += '<select class="custom-caption-input" style="flex:0.5" onchange="app.setCustomCaptionStyle(\'fontSize\', this.value)">';
                ['0.8', '0.9', '1', '1.1', '1.2', '1.3'].forEach(function(size) {
                    var selected = String(customStyle.fontSize || '1') === size ? ' selected' : '';
                    html += '<option value="' + size + '"' + selected + '>' + (parseFloat(size) * 100) + '%</option>';
                });
                html += '</select>';
                html += '<span class="custom-caption-label">Position</span>';
                html += '<select class="custom-caption-input" style="flex:0.5" onchange="app.setCustomCaptionStyle(\'position\', this.value)">';
                [['bottom', 'Bottom'], ['middle', 'Middle'], ['top', 'Top']].forEach(function(pos) {
                    var selected = (customStyle.position || 'bottom') === pos[0] ? ' selected' : '';
                    html += '<option value="' + pos[0] + '"' + selected + '>' + pos[1] + '</option>';
                });
                html += '</select>';
                html += '</div>';
                html += '<div class="custom-caption-row">';
                html += '<span class="custom-caption-label">Font</span>';
                html += '<select class="custom-caption-input" onchange="app.setCustomCaptionStyle(\'fontFamily\', this.value)">';
                [['sans-serif', 'Sans Serif'], ['serif', 'Serif'], ['monospace', 'Monospace'], ['cursive', 'Cursive']].forEach(function(font) {
                    var selected = (customStyle.fontFamily || 'sans-serif') === font[0] ? ' selected' : '';
                    html += '<option value="' + font[0] + '"' + selected + '>' + font[1] + '</option>';
                });
                html += '</select>';
                html += '</div>';
                html += '<div class="custom-caption-row">';
                html += '<label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;color:rgba(255,255,255,0.8)">';
                html += '<input type="checkbox" ' + (customStyle.outline ? 'checked' : '') + ' onchange="app.setCustomCaptionStyle(\'outline\', this.checked)">';
                html += 'Text outline';
                html += '</label>';
                html += '<label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;color:rgba(255,255,255,0.8);margin-left:1rem">';
                html += '<input type="checkbox" ' + (customStyle.shadow ? 'checked' : '') + ' onchange="app.setCustomCaptionStyle(\'shadow\', this.checked)">';
                html += 'Drop shadow';
                html += '</label>';
                html += '</div>';
                html += '</div>';
            }

            // Caption Source selector (only show when multi-source split is enabled)
            var secondarySource = settings.secondarySource || { enabled: false };
            var hasSecondaryForCaptions = secondarySource.enabled &&
                (secondarySource.youtubeVideoId || secondarySource.uploadedUrl) &&
                ['split_screen', 'three_person', 'broll_split'].indexOf(settings.reframeMode) !== -1;

            if (hasSecondaryForCaptions && settings.captionStyle !== 'none') {
                html += '<div class="caption-source-panel">';
                html += '<div class="caption-source-label">🎙️ Generate captions from:</div>';
                html += '<div class="caption-source-options">';

                var captionSource = settings.captionSource || 'primary';

                html += '<button class="caption-source-btn' + (captionSource === 'primary' ? ' active' : '') + '" onclick="app.setCaptionSource(\'primary\')">';
                html += '<span class="source-icon">▲</span> Top Video';
                html += '</button>';

                html += '<button class="caption-source-btn' + (captionSource === 'secondary' ? ' active' : '') + '" onclick="app.setCaptionSource(\'secondary\')">';
                html += '<span class="source-icon">▼</span> Bottom Video';
                html += '</button>';

                html += '</div>';
                html += '</div>';
            }

            html += '</div>';

            // Reframe Panel with visual diagrams
            html += '<div class="customization-panel">';
            html += '<div class="panel-header">';
            html += '<span class="panel-icon">🔲</span>';
            html += '<span class="panel-title">REFRAME</span>';
            html += '</div>';

            html += '<div class="reframe-layouts-grid">';

            // Auto-center layout
            var autoSelected = settings.reframeMode === 'auto_center' ? ' selected' : '';
            html += '<div class="reframe-layout-card' + autoSelected + '" onclick="app.setReframeMode(\'auto_center\')">';
            html += '<div class="reframe-layout-diagram auto-center"><div class="layout-face"></div></div>';
            html += '<div class="reframe-layout-name">Auto-center</div>';
            html += '</div>';

            // Split screen layout
            var splitSelected = settings.reframeMode === 'split_screen' ? ' selected' : '';
            html += '<div class="reframe-layout-card' + splitSelected + '" onclick="app.setReframeMode(\'split_screen\')">';
            html += '<div class="reframe-layout-diagram split-screen">';
            html += '<div class="layout-section"><div class="layout-face-small"></div></div>';
            html += '<div class="layout-section"><div class="layout-face-small"></div></div>';
            html += '</div>';
            html += '<div class="reframe-layout-name">Split</div>';
            html += '</div>';

            // Three person layout
            var threeSelected = settings.reframeMode === 'three_person' ? ' selected' : '';
            html += '<div class="reframe-layout-card' + threeSelected + '" onclick="app.setReframeMode(\'three_person\')">';
            html += '<div class="reframe-layout-diagram three-person">';
            html += '<div class="layout-section-top"><div class="layout-face-main"></div></div>';
            html += '<div class="layout-section-bottom"><div class="layout-face-small"></div><div class="layout-face-small"></div></div>';
            html += '</div>';
            html += '<div class="reframe-layout-name">Three</div>';
            html += '</div>';

            // Gameplay layout
            var gameSelected = settings.reframeMode === 'gameplay' ? ' selected' : '';
            html += '<div class="reframe-layout-card' + gameSelected + '" onclick="app.setReframeMode(\'gameplay\')">';
            html += '<div class="reframe-layout-diagram gameplay">';
            html += '<div class="layout-game-area"><span class="layout-game-icon">🎮</span></div>';
            html += '<div class="layout-cam-area"><div class="layout-face-cam"></div></div>';
            html += '</div>';
            html += '<div class="reframe-layout-name">Gameplay</div>';
            html += '</div>';

            // B-Roll split layout
            var brollSelected = settings.reframeMode === 'broll_split' ? ' selected' : '';
            html += '<div class="reframe-layout-card' + brollSelected + '" onclick="app.setReframeMode(\'broll_split\')">';
            html += '<div class="reframe-layout-diagram broll-split">';
            html += '<div class="layout-main-area"><div class="layout-face-broll"></div></div>';
            html += '<div class="layout-broll-area">B-Roll</div>';
            html += '</div>';
            html += '<div class="reframe-layout-name">B-Roll</div>';
            html += '</div>';

            html += '</div>';
            html += '</div>';

            // Split Screen Position Controls (only show when split_screen mode is selected)
            if (settings.reframeMode === 'split_screen') {
                var splitSettings = settings.splitScreenSettings || {
                    speaker1: { cropPosition: 50 },
                    speaker2: { cropPosition: 50 },
                    preset: 'interview'
                };

                html += '<div class="customization-panel split-position-panel">';
                html += '<div class="panel-header">';
                html += '<span class="panel-icon">⬛</span>';
                html += '<span class="panel-title">CLIP POSITIONS</span>';
                html += '</div>';

                // Preset buttons
                html += '<div class="split-presets-row">';
                html += '<button class="split-preset-btn' + (splitSettings.preset === 'interview' ? ' active' : '') + '" onclick="app.setSplitPreset(\'interview\')">';
                html += '<span class="preset-icon">◧</span> Left + Right';
                html += '</button>';
                html += '<button class="split-preset-btn' + (splitSettings.preset === 'center' ? ' active' : '') + '" onclick="app.setSplitPreset(\'center\')">';
                html += '<span class="preset-icon">⊡</span> Both Center';
                html += '</button>';
                html += '<button class="split-preset-btn' + (splitSettings.preset === 'custom' ? ' active' : '') + '" onclick="app.setSplitPreset(\'custom\')">';
                html += '<span class="preset-icon">✎</span> Custom';
                html += '</button>';
                html += '</div>';

                // Position sliders (show expanded when custom or always show)
                html += '<div class="speaker-position-controls' + (splitSettings.preset === 'custom' ? ' expanded' : '') + '">';

                // Top clip
                html += '<div class="speaker-position-row">';
                html += '<div class="speaker-position-label">';
                html += '<span class="speaker-badge speaker-1">▲</span>';
                html += '<span>Top</span>';
                html += '</div>';
                html += '<div class="speaker-position-slider">';
                html += '<span class="slider-label-left">L</span>';
                html += '<input type="range" min="0" max="100" value="' + (splitSettings.speaker1?.cropPosition ?? 50) + '" ';
                html += 'oninput="app.onSpeakerPositionChange(1, this.value)" onchange="app.setSpeakerPosition(1, this.value)">';
                html += '<span class="slider-label-right">R</span>';
                html += '<span class="speaker-position-value">' + (splitSettings.speaker1?.cropPosition ?? 50) + '%</span>';
                html += '</div>';
                html += '</div>';

                // Swap button
                html += '<div class="swap-button-row">';
                html += '<button class="swap-positions-btn" onclick="app.swapSplitPositions()" title="Swap top and bottom positions">';
                html += '<span class="swap-icon">⇅</span> Swap';
                html += '</button>';
                html += '</div>';

                // Bottom clip
                html += '<div class="speaker-position-row">';
                html += '<div class="speaker-position-label">';
                html += '<span class="speaker-badge speaker-2">▼</span>';
                html += '<span>Bottom</span>';
                html += '</div>';
                html += '<div class="speaker-position-slider">';
                html += '<span class="slider-label-left">L</span>';
                html += '<input type="range" min="0" max="100" value="' + (splitSettings.speaker2?.cropPosition ?? 50) + '" ';
                html += 'oninput="app.onSpeakerPositionChange(2, this.value)" onchange="app.setSpeakerPosition(2, this.value)">';
                html += '<span class="slider-label-right">R</span>';
                html += '<span class="speaker-position-value">' + (splitSettings.speaker2?.cropPosition ?? 50) + '%</span>';
                html += '</div>';
                html += '</div>';

                html += '</div>'; // speaker-position-controls

                // Zoom Controls Section
                html += '<div class="split-layout-section">';
                html += '<div class="split-section-label">Zoom Level</div>';
                html += '<div class="zoom-controls-grid">';

                // Top clip zoom
                var topZoom = splitSettings.speaker1?.zoom || 100;
                html += '<div class="zoom-control-row">';
                html += '<span class="zoom-clip-label"><span class="speaker-badge speaker-1">▲</span> Top</span>';
                html += '<div class="zoom-slider-wrap">';
                html += '<input type="range" class="zoom-slider" min="100" max="200" value="' + topZoom + '" ';
                html += 'oninput="app.onZoomChange(1, this.value)" onchange="app.setClipZoom(1, this.value)">';
                html += '<span class="zoom-value">' + topZoom + '%</span>';
                html += '</div>';
                html += '<button class="zoom-reset-btn" onclick="app.setClipZoom(1, 100)" title="Reset to 100%">↺</button>';
                html += '</div>';

                // Bottom clip zoom
                var bottomZoom = splitSettings.speaker2?.zoom || 100;
                html += '<div class="zoom-control-row">';
                html += '<span class="zoom-clip-label"><span class="speaker-badge speaker-2">▼</span> Bottom</span>';
                html += '<div class="zoom-slider-wrap">';
                html += '<input type="range" class="zoom-slider" min="100" max="200" value="' + bottomZoom + '" ';
                html += 'oninput="app.onZoomChange(2, this.value)" onchange="app.setClipZoom(2, this.value)">';
                html += '<span class="zoom-value">' + bottomZoom + '%</span>';
                html += '</div>';
                html += '<button class="zoom-reset-btn" onclick="app.setClipZoom(2, 100)" title="Reset to 100%">↺</button>';
                html += '</div>';

                html += '</div>'; // zoom-controls-grid
                html += '</div>'; // split-layout-section

                // Layout Ratio Section
                html += '<div class="split-layout-section">';
                html += '<div class="split-section-label">Layout Ratio</div>';
                html += '<div class="layout-ratio-options">';
                var layoutRatio = splitSettings.layoutRatio || '50-50';
                html += '<button class="layout-ratio-btn' + (layoutRatio === '50-50' ? ' active' : '') + '" onclick="app.setLayoutRatio(\'50-50\')">';
                html += '<span class="ratio-visual"><span class="ratio-top" style="flex:1"></span><span class="ratio-bottom" style="flex:1"></span></span>';
                html += '<span class="ratio-label">50/50</span>';
                html += '</button>';
                html += '<button class="layout-ratio-btn' + (layoutRatio === '60-40' ? ' active' : '') + '" onclick="app.setLayoutRatio(\'60-40\')">';
                html += '<span class="ratio-visual"><span class="ratio-top" style="flex:1.5"></span><span class="ratio-bottom" style="flex:1"></span></span>';
                html += '<span class="ratio-label">60/40</span>';
                html += '</button>';
                html += '<button class="layout-ratio-btn' + (layoutRatio === '70-30' ? ' active' : '') + '" onclick="app.setLayoutRatio(\'70-30\')">';
                html += '<span class="ratio-visual"><span class="ratio-top" style="flex:2.33"></span><span class="ratio-bottom" style="flex:1"></span></span>';
                html += '<span class="ratio-label">70/30</span>';
                html += '</button>';
                html += '</div>';
                html += '</div>';

                // Border/Divider Section
                html += '<div class="split-layout-section">';
                html += '<div class="split-section-label">Divider Line</div>';
                var border = splitSettings.border || { enabled: false, thickness: 2, color: '#ffffff' };
                html += '<div class="border-options-row">';
                html += '<label class="border-toggle">';
                html += '<input type="checkbox" ' + (border.enabled ? 'checked' : '') + ' onchange="app.toggleSplitBorder(this.checked)">';
                html += '<span>Show divider</span>';
                html += '</label>';
                if (border.enabled) {
                    html += '<div class="border-controls">';
                    html += '<input type="range" class="border-thickness-slider" min="1" max="10" value="' + (border.thickness || 2) + '" ';
                    html += 'onchange="app.setBorderThickness(this.value)" title="Thickness: ' + (border.thickness || 2) + 'px">';
                    html += '<input type="color" class="border-color-picker" value="' + (border.color || '#ffffff') + '" ';
                    html += 'onchange="app.setBorderColor(this.value)" title="Line color">';
                    html += '</div>';
                }
                html += '</div>';
                html += '</div>';

                html += '</div>'; // customization-panel
            }

            // Three Person Position Controls (only show when three_person mode is selected)
            if (settings.reframeMode === 'three_person') {
                var threeSettings = settings.threePersonSettings || {
                    main: { cropPosition: 50, zoom: 100 },
                    left: { cropPosition: 50, zoom: 100 },
                    right: { cropPosition: 50, zoom: 100 },
                    preset: 'center',
                    layoutRatio: '50-50'
                };

                html += '<div class="customization-panel split-position-panel">';
                html += '<div class="panel-header">';
                html += '<span class="panel-icon">⬛</span>';
                html += '<span class="panel-title">CLIP POSITIONS</span>';
                html += '</div>';

                // Preset buttons
                html += '<div class="split-presets-row">';
                html += '<button class="split-preset-btn' + (threeSettings.preset === 'center' ? ' active' : '') + '" onclick="app.setThreePersonPreset(\'center\')">';
                html += '<span class="preset-icon">⊡</span> All Center';
                html += '</button>';
                html += '<button class="split-preset-btn' + (threeSettings.preset === 'custom' ? ' active' : '') + '" onclick="app.setThreePersonPreset(\'custom\')">';
                html += '<span class="preset-icon">✎</span> Custom';
                html += '</button>';
                html += '</div>';

                // Position sliders
                html += '<div class="speaker-position-controls expanded">';

                // Main (top) clip
                html += '<div class="speaker-position-row">';
                html += '<div class="speaker-position-label">';
                html += '<span class="speaker-badge speaker-1">▲</span>';
                html += '<span>Main</span>';
                html += '</div>';
                html += '<div class="speaker-position-slider">';
                html += '<span class="slider-label-left">L</span>';
                html += '<input type="range" min="0" max="100" value="' + (threeSettings.main?.cropPosition ?? 50) + '" ';
                html += 'oninput="app.onThreePersonPositionChange(\'main\', this.value)" onchange="app.setThreePersonPosition(\'main\', this.value)">';
                html += '<span class="slider-label-right">R</span>';
                html += '<span class="speaker-position-value">' + (threeSettings.main?.cropPosition ?? 50) + '%</span>';
                html += '</div>';
                html += '</div>';

                // Left (bottom-left) clip
                html += '<div class="speaker-position-row">';
                html += '<div class="speaker-position-label">';
                html += '<span class="speaker-badge speaker-2">◀</span>';
                html += '<span>Left</span>';
                html += '</div>';
                html += '<div class="speaker-position-slider">';
                html += '<span class="slider-label-left">L</span>';
                html += '<input type="range" min="0" max="100" value="' + (threeSettings.left?.cropPosition ?? 50) + '" ';
                html += 'oninput="app.onThreePersonPositionChange(\'left\', this.value)" onchange="app.setThreePersonPosition(\'left\', this.value)">';
                html += '<span class="slider-label-right">R</span>';
                html += '<span class="speaker-position-value">' + (threeSettings.left?.cropPosition ?? 50) + '%</span>';
                html += '</div>';
                html += '</div>';

                // Right (bottom-right) clip
                html += '<div class="speaker-position-row">';
                html += '<div class="speaker-position-label">';
                html += '<span class="speaker-badge" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">▶</span>';
                html += '<span>Right</span>';
                html += '</div>';
                html += '<div class="speaker-position-slider">';
                html += '<span class="slider-label-left">L</span>';
                html += '<input type="range" min="0" max="100" value="' + (threeSettings.right?.cropPosition ?? 50) + '" ';
                html += 'oninput="app.onThreePersonPositionChange(\'right\', this.value)" onchange="app.setThreePersonPosition(\'right\', this.value)">';
                html += '<span class="slider-label-right">R</span>';
                html += '<span class="speaker-position-value">' + (threeSettings.right?.cropPosition ?? 50) + '%</span>';
                html += '</div>';
                html += '</div>';

                html += '</div>'; // speaker-position-controls

                // Zoom Controls Section
                html += '<div class="split-layout-section">';
                html += '<div class="split-section-label">Zoom Level</div>';
                html += '<div class="zoom-controls-grid">';

                // Main zoom
                var mainZoom = threeSettings.main?.zoom || 100;
                html += '<div class="zoom-control-row">';
                html += '<span class="zoom-clip-label"><span class="speaker-badge speaker-1">▲</span> Main</span>';
                html += '<div class="zoom-slider-wrap">';
                html += '<input type="range" class="zoom-slider" min="100" max="200" value="' + mainZoom + '" ';
                html += 'oninput="app.onThreePersonZoomChange(\'main\', this.value)" onchange="app.setThreePersonZoom(\'main\', this.value)">';
                html += '<span class="zoom-value">' + mainZoom + '%</span>';
                html += '</div>';
                html += '<button class="zoom-reset-btn" onclick="app.setThreePersonZoom(\'main\', 100)" title="Reset to 100%">↺</button>';
                html += '</div>';

                // Left zoom
                var leftZoom = threeSettings.left?.zoom || 100;
                html += '<div class="zoom-control-row">';
                html += '<span class="zoom-clip-label"><span class="speaker-badge speaker-2">◀</span> Left</span>';
                html += '<div class="zoom-slider-wrap">';
                html += '<input type="range" class="zoom-slider" min="100" max="200" value="' + leftZoom + '" ';
                html += 'oninput="app.onThreePersonZoomChange(\'left\', this.value)" onchange="app.setThreePersonZoom(\'left\', this.value)">';
                html += '<span class="zoom-value">' + leftZoom + '%</span>';
                html += '</div>';
                html += '<button class="zoom-reset-btn" onclick="app.setThreePersonZoom(\'left\', 100)" title="Reset to 100%">↺</button>';
                html += '</div>';

                // Right zoom
                var rightZoom = threeSettings.right?.zoom || 100;
                html += '<div class="zoom-control-row">';
                html += '<span class="zoom-clip-label"><span class="speaker-badge" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">▶</span> Right</span>';
                html += '<div class="zoom-slider-wrap">';
                html += '<input type="range" class="zoom-slider" min="100" max="200" value="' + rightZoom + '" ';
                html += 'oninput="app.onThreePersonZoomChange(\'right\', this.value)" onchange="app.setThreePersonZoom(\'right\', this.value)">';
                html += '<span class="zoom-value">' + rightZoom + '%</span>';
                html += '</div>';
                html += '<button class="zoom-reset-btn" onclick="app.setThreePersonZoom(\'right\', 100)" title="Reset to 100%">↺</button>';
                html += '</div>';

                html += '</div>'; // zoom-controls-grid
                html += '</div>'; // split-layout-section

                // Layout Ratio Section
                html += '<div class="split-layout-section">';
                html += '<div class="split-section-label">Layout Ratio</div>';
                html += '<div class="layout-ratio-options">';
                var layoutRatio = threeSettings.layoutRatio || '50-50';
                html += '<button class="layout-ratio-btn' + (layoutRatio === '50-50' ? ' active' : '') + '" onclick="app.setThreePersonLayoutRatio(\'50-50\')">';
                html += '<span class="ratio-visual"><span class="ratio-top" style="flex:1"></span><span class="ratio-bottom" style="flex:1"></span></span>';
                html += '<span class="ratio-label">50/50</span>';
                html += '</button>';
                html += '<button class="layout-ratio-btn' + (layoutRatio === '60-40' ? ' active' : '') + '" onclick="app.setThreePersonLayoutRatio(\'60-40\')">';
                html += '<span class="ratio-visual"><span class="ratio-top" style="flex:1.5"></span><span class="ratio-bottom" style="flex:1"></span></span>';
                html += '<span class="ratio-label">60/40</span>';
                html += '</button>';
                html += '<button class="layout-ratio-btn' + (layoutRatio === '70-30' ? ' active' : '') + '" onclick="app.setThreePersonLayoutRatio(\'70-30\')">';
                html += '<span class="ratio-visual"><span class="ratio-top" style="flex:2.33"></span><span class="ratio-bottom" style="flex:1"></span></span>';
                html += '<span class="ratio-label">70/30</span>';
                html += '</button>';
                html += '</div>';
                html += '</div>';

                html += '</div>'; // customization-panel
            }

            // Secondary Source Panel (only show for split-related modes)
            var showSecondarySource = ['split_screen', 'three_person', 'gameplay', 'broll_split'].indexOf(settings.reframeMode) !== -1;
            if (showSecondarySource) {
                var secondarySource = settings.secondarySource || { enabled: false, inputTab: 'upload' };
                var tertiarySource = settings.tertiarySource || { enabled: false, inputTab: 'upload' };
                var audioMix = settings.audioMix || { primaryVolume: 100, secondaryVolume: 0, tertiaryVolume: 0, primaryMuted: false, secondaryMuted: true, tertiaryMuted: true };

                // Determine panel title based on mode
                var sourcePanelTitle = settings.reframeMode === 'gameplay' ? 'FACECAM SOURCE' : 'SECONDARY SOURCE';
                var sourcePanelIcon = settings.reframeMode === 'gameplay' ? '📹' : '🎬';

                html += '<div class="customization-panel">';
                html += '<div class="panel-header">';
                html += '<span class="panel-icon">' + sourcePanelIcon + '</span>';
                html += '<span class="panel-title">' + sourcePanelTitle + '</span>';
                html += '</div>';

                html += '<div class="secondary-source-panel">';

                // Toggle: None vs Add second video
                html += '<div class="secondary-source-toggle">';
                if (settings.reframeMode === 'gameplay') {
                    // Gameplay mode: No facecam vs Add facecam
                    html += '<button class="source-toggle-btn' + (!secondarySource.enabled ? ' active' : '') + '" onclick="app.toggleSecondarySource(false)">';
                    html += '<span>○</span> No facecam';
                    html += '</button>';
                    html += '<button class="source-toggle-btn' + (secondarySource.enabled ? ' active' : '') + '" onclick="app.toggleSecondarySource(true)">';
                    html += '<span>●</span> Add facecam video';
                    html += '</button>';
                } else {
                    html += '<button class="source-toggle-btn' + (!secondarySource.enabled ? ' active' : '') + '" onclick="app.toggleSecondarySource(false)">';
                    html += '<span>○</span> Split primary video';
                    html += '</button>';
                    html += '<button class="source-toggle-btn' + (secondarySource.enabled ? ' active' : '') + '" onclick="app.toggleSecondarySource(true)">';
                    html += '<span>●</span> Add second video';
                    html += '</button>';
                }
                html += '</div>';

                if (secondarySource.enabled) {
                    // Check if source is already set
                    var hasSource = secondarySource.type && (secondarySource.fileName || secondarySource.youtubeVideoId);

                    if (!hasSource) {
                        // Input tabs
                        html += '<div class="secondary-source-input">';
                        html += '<div class="source-input-tabs">';
                        html += '<button class="source-input-tab' + (secondarySource.inputTab === 'upload' ? ' active' : '') + '" onclick="app.setSecondaryInputTab(\'upload\')">';
                        html += '📤 Upload File';
                        html += '</button>';
                        html += '<button class="source-input-tab' + (secondarySource.inputTab === 'youtube' ? ' active' : '') + '" onclick="app.setSecondaryInputTab(\'youtube\')">';
                        html += '🔗 YouTube URL';
                        html += '</button>';
                        html += '</div>';

                        if (secondarySource.inputTab === 'upload') {
                            // Upload dropzone
                            html += '<div class="upload-dropzone" id="secondary-upload-dropzone" onclick="document.getElementById(\'secondary-file-input\').click()">';
                            html += '<div class="upload-dropzone-icon">📁</div>';
                            html += '<div class="upload-dropzone-text">Click or drag video file here</div>';
                            html += '<div class="upload-dropzone-hint">MP4, MOV, WebM up to 500MB</div>';
                            html += '</div>';
                            html += '<input type="file" id="secondary-file-input" accept="video/*" style="display:none" onchange="app.handleSecondaryFileSelect(this.files)">';
                        } else {
                            // YouTube URL input
                            html += '<div class="youtube-url-input-container">';
                            html += '<input type="text" class="youtube-url-input" id="secondary-youtube-url" placeholder="https://www.youtube.com/watch?v=..." onkeypress="if(event.key===\'Enter\')app.loadSecondaryYouTube()">';
                            html += '<button class="youtube-load-btn" onclick="app.loadSecondaryYouTube()">Load</button>';
                            html += '</div>';
                        }
                        html += '</div>';
                    } else {
                        // Show source preview
                        html += '<div class="secondary-source-preview">';
                        html += '<div class="source-preview-thumb">';
                        if (secondarySource.type === 'youtube' && secondarySource.youtubeThumbnail) {
                            html += '<img src="' + secondarySource.youtubeThumbnail + '" alt="thumbnail">';
                        } else {
                            html += '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.3);font-size:1.5rem">📹</div>';
                        }
                        html += '</div>';
                        html += '<div class="source-preview-info">';
                        // Show AI-extracted title if available, otherwise fallback to filename
                        var sourceName = secondarySource.type === 'youtube'
                            ? (secondarySource.youtubeTitle || 'YouTube Video')
                            : (secondarySource.metadata?.title || secondarySource.fileName || 'Uploaded Video');
                        html += '<div class="source-preview-name">' + utils.escapeHtml(sourceName) + '</div>';
                        html += '<div class="source-preview-meta">';
                        if (secondarySource.type === 'upload' && secondarySource.fileSize) {
                            html += '<span>' + utils.formatFileSize(secondarySource.fileSize) + '</span>';
                        }
                        // Show upload progress, extracting status, or ready status
                        if (secondarySource.uploading) {
                            html += '<span class="source-preview-status" style="color:#f59e0b">⏳ Uploading ' + (secondarySource.uploadProgress || 0) + '%</span>';
                        } else if (secondarySource.extractingMetadata) {
                            html += '<span class="source-preview-status" style="color:#8b5cf6">🤖 Extracting metadata...</span>';
                        } else if (secondarySource.uploadedUrl || secondarySource.youtubeVideoId) {
                            html += '<span class="source-preview-status">✓ Ready</span>';
                            if (secondarySource.metadata) {
                                html += '<span style="color:#22c55e;margin-left:0.5rem">✨ AI Metadata</span>';
                            }
                        } else {
                            html += '<span class="source-preview-status" style="color:#f59e0b">⏳ Processing...</span>';
                        }
                        html += '</div>';
                        html += '</div>';
                        html += '<button class="source-preview-remove" onclick="app.removeSecondarySource()" title="Remove"' + (secondarySource.uploading || secondarySource.extractingMetadata ? ' disabled style="opacity:0.5"' : '') + '>×</button>';
                        html += '</div>';

                        // Show AI-extracted metadata if available (for uploaded videos)
                        if (secondarySource.type === 'upload' && secondarySource.metadata) {
                            html += '<div class="source-metadata-panel" style="margin-top:0.75rem;padding:0.75rem;background:rgba(139,92,246,0.1);border-radius:8px;border:1px solid rgba(139,92,246,0.3)">';
                            html += '<div style="font-size:0.7rem;color:rgba(139,92,246,0.8);margin-bottom:0.5rem;font-weight:600">🤖 AI-EXTRACTED METADATA</div>';

                            // Description preview
                            if (secondarySource.metadata.description) {
                                html += '<div style="font-size:0.75rem;color:rgba(255,255,255,0.7);margin-bottom:0.5rem;line-height:1.4">';
                                html += utils.escapeHtml(secondarySource.metadata.description.substring(0, 150));
                                if (secondarySource.metadata.description.length > 150) html += '...';
                                html += '</div>';
                            }

                            // Tags
                            if (secondarySource.metadata.tags && secondarySource.metadata.tags.length > 0) {
                                html += '<div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-bottom:0.5rem">';
                                secondarySource.metadata.tags.slice(0, 5).forEach(function(tag) {
                                    html += '<span style="font-size:0.65rem;background:rgba(139,92,246,0.2);color:#a78bfa;padding:0.15rem 0.4rem;border-radius:4px">' + utils.escapeHtml(tag) + '</span>';
                                });
                                if (secondarySource.metadata.tags.length > 5) {
                                    html += '<span style="font-size:0.65rem;color:rgba(255,255,255,0.4)">+' + (secondarySource.metadata.tags.length - 5) + ' more</span>';
                                }
                                html += '</div>';
                            }

                            // Category
                            if (secondarySource.metadata.category) {
                                html += '<div style="font-size:0.65rem;color:rgba(255,255,255,0.5)">';
                                html += '📁 Category: ' + utils.escapeHtml(secondarySource.metadata.category);
                                html += '</div>';
                            }

                            html += '</div>';
                        }

                        // Position and sync options
                        html += '<div class="secondary-source-options">';

                        // Position selection
                        html += '<div class="source-option-row">';
                        html += '<span class="source-option-label">📍 Position</span>';
                        html += '<select class="source-option-select" onchange="app.setSecondaryPosition(this.value)">';
                        var positionOptions = [];
                        if (settings.reframeMode === 'split_screen') {
                            positionOptions = [
                                { value: 'top', label: 'Top half' },
                                { value: 'bottom', label: 'Bottom half' }
                            ];
                        } else if (settings.reframeMode === 'three_person') {
                            positionOptions = [
                                { value: 'top', label: 'Top (main)' },
                                { value: 'bottom-left', label: 'Bottom left' },
                                { value: 'bottom-right', label: 'Bottom right' }
                            ];
                        } else if (settings.reframeMode === 'gameplay') {
                            positionOptions = [
                                { value: 'bottom-right', label: 'Bottom right' },
                                { value: 'bottom-left', label: 'Bottom left' },
                                { value: 'top-right', label: 'Top right' },
                                { value: 'top-left', label: 'Top left' }
                            ];
                        } else if (settings.reframeMode === 'broll_split') {
                            positionOptions = [
                                { value: 'main', label: 'Main speaker' },
                                { value: 'broll', label: 'B-Roll area' }
                            ];
                        }
                        positionOptions.forEach(function(opt) {
                            var selected = secondarySource.position === opt.value ? ' selected' : '';
                            html += '<option value="' + opt.value + '"' + selected + '>' + opt.label + '</option>';
                        });
                        html += '</select>';
                        html += '</div>';

                        // Time sync offset
                        html += '<div class="source-option-row">';
                        html += '<span class="source-option-label">⏱️ Sync offset</span>';
                        html += '<div class="source-offset-control">';
                        html += '<button class="source-offset-btn" onclick="app.adjustSecondaryOffset(-0.5)">−</button>';
                        var offsetSign = secondarySource.timeOffset >= 0 ? '+' : '';
                        html += '<span class="source-offset-value">' + offsetSign + secondarySource.timeOffset.toFixed(1) + 's</span>';
                        html += '<button class="source-offset-btn" onclick="app.adjustSecondaryOffset(0.5)">+</button>';
                        html += '</div>';
                        html += '</div>';

                        html += '</div>';
                    }

                    // Audio Mix Panel (only when source is set)
                    if (hasSource) {
                        html += '<div class="audio-mix-panel">';
                        html += '<div style="font-size:0.75rem;color:rgba(255,255,255,0.5);margin-bottom:0.75rem;font-weight:500">🔊 AUDIO MIX</div>';

                        // Primary audio track
                        html += '<div class="audio-mix-track">';
                        html += '<div class="audio-mix-track-header">';
                        html += '<div class="audio-mix-track-name"><span class="track-icon">🎙️</span> Primary Video</div>';
                        html += '<button class="audio-mix-mute-btn' + (audioMix.primaryMuted ? ' muted' : '') + '" onclick="app.toggleAudioMute(\'primary\')">';
                        html += (audioMix.primaryMuted ? '🔇 Muted' : '🔊 Active');
                        html += '</button>';
                        html += '</div>';
                        html += '<div class="audio-mix-slider-row">';
                        html += '<input type="range" class="audio-mix-slider" min="0" max="100" value="' + audioMix.primaryVolume + '" oninput="app.setAudioMixVolume(\'primary\', this.value)"' + (audioMix.primaryMuted ? ' disabled' : '') + '>';
                        html += '<span class="audio-mix-value">' + audioMix.primaryVolume + '%</span>';
                        html += '</div>';
                        html += '</div>';

                        // Secondary audio track
                        html += '<div class="audio-mix-track">';
                        html += '<div class="audio-mix-track-header">';
                        html += '<div class="audio-mix-track-name"><span class="track-icon">🎬</span> Secondary Video</div>';
                        html += '<button class="audio-mix-mute-btn' + (audioMix.secondaryMuted ? ' muted' : '') + '" onclick="app.toggleAudioMute(\'secondary\')">';
                        html += (audioMix.secondaryMuted ? '🔇 Muted' : '🔊 Active');
                        html += '</button>';
                        html += '</div>';
                        html += '<div class="audio-mix-slider-row">';
                        html += '<input type="range" class="audio-mix-slider secondary" min="0" max="100" value="' + audioMix.secondaryVolume + '" oninput="app.setAudioMixVolume(\'secondary\', this.value)"' + (audioMix.secondaryMuted ? ' disabled' : '') + '>';
                        html += '<span class="audio-mix-value">' + audioMix.secondaryVolume + '%</span>';
                        html += '</div>';
                        html += '</div>';

                        // Quick presets
                        html += '<div class="audio-mix-presets">';
                        html += '<button class="audio-mix-preset" onclick="app.applyAudioMixPreset(\'primary\')">Primary Only</button>';
                        html += '<button class="audio-mix-preset" onclick="app.applyAudioMixPreset(\'secondary\')">Secondary Only</button>';
                        html += '<button class="audio-mix-preset" onclick="app.applyAudioMixPreset(\'mix\')">50/50 Mix</button>';
                        html += '<button class="audio-mix-preset" onclick="app.applyAudioMixPreset(\'background\')">Primary + BG</button>';
                        html += '</div>';

                        html += '</div>';
                    }
                }

                html += '</div>'; // secondary-source-panel
                html += '</div>'; // customization-panel

                // ===== TERTIARY SOURCE PANEL (only for three_person mode) =====
                if (settings.reframeMode === 'three_person') {
                    html += '<div class="customization-panel">';
                    html += '<div class="panel-header">';
                    html += '<span class="panel-icon">🎥</span>';
                    html += '<span class="panel-title">THIRD SOURCE</span>';
                    html += '</div>';

                    html += '<div class="secondary-source-panel">';

                    // Toggle for third video
                    html += '<div class="secondary-source-toggle">';
                    html += '<button class="source-toggle-btn' + (!tertiarySource.enabled ? ' active' : '') + '" onclick="app.toggleTertiarySource(false)">';
                    html += '<span>○</span> No third video';
                    html += '</button>';
                    html += '<button class="source-toggle-btn' + (tertiarySource.enabled ? ' active' : '') + '" onclick="app.toggleTertiarySource(true)">';
                    html += '<span>●</span> Add third video';
                    html += '</button>';
                    html += '</div>';

                    if (tertiarySource.enabled) {
                        var hasTertiarySource = tertiarySource.type && (tertiarySource.fileName || tertiarySource.youtubeVideoId);

                        if (!hasTertiarySource) {
                            // Input tabs
                            html += '<div class="secondary-source-input">';
                            html += '<div class="source-input-tabs">';
                            html += '<button class="source-input-tab' + (tertiarySource.inputTab === 'upload' ? ' active' : '') + '" onclick="app.setTertiaryInputTab(\'upload\')">';
                            html += '📤 Upload File';
                            html += '</button>';
                            html += '<button class="source-input-tab' + (tertiarySource.inputTab === 'youtube' ? ' active' : '') + '" onclick="app.setTertiaryInputTab(\'youtube\')">';
                            html += '🔗 YouTube URL';
                            html += '</button>';
                            html += '</div>';

                            if (tertiarySource.inputTab === 'upload') {
                                html += '<div class="upload-dropzone" onclick="document.getElementById(\'tertiary-file-input\').click()">';
                                html += '<div class="upload-dropzone-icon">📁</div>';
                                html += '<div class="upload-dropzone-text">Click or drag video file here</div>';
                                html += '<div class="upload-dropzone-hint">MP4, MOV, WebM up to 500MB</div>';
                                html += '</div>';
                                html += '<input type="file" id="tertiary-file-input" accept="video/*" style="display:none" onchange="app.handleTertiaryFileSelect(this.files)">';
                            } else {
                                html += '<div class="youtube-url-input-container">';
                                html += '<input type="text" class="youtube-url-input" id="tertiary-youtube-url" placeholder="https://www.youtube.com/watch?v=..." onkeypress="if(event.key===\'Enter\')app.loadTertiaryYouTube()">';
                                html += '<button class="youtube-load-btn" onclick="app.loadTertiaryYouTube()">Load</button>';
                                html += '</div>';
                            }
                            html += '</div>';
                        } else {
                            // Show source preview
                            html += '<div class="secondary-source-preview">';
                            html += '<div class="source-preview-thumb">';
                            if (tertiarySource.type === 'youtube' && tertiarySource.youtubeThumbnail) {
                                html += '<img src="' + tertiarySource.youtubeThumbnail + '" alt="thumbnail">';
                            } else {
                                html += '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.3);font-size:1.5rem">📹</div>';
                            }
                            html += '</div>';
                            html += '<div class="source-preview-info">';
                            var tertiaryName = tertiarySource.type === 'youtube'
                                ? (tertiarySource.youtubeTitle || 'YouTube Video')
                                : (tertiarySource.fileName || 'Uploaded Video');
                            html += '<div class="source-preview-name">' + utils.escapeHtml(tertiaryName) + '</div>';
                            html += '<div class="source-preview-meta">';
                            if (tertiarySource.uploading) {
                                html += '<span class="source-preview-status" style="color:#f59e0b">⏳ Uploading ' + (tertiarySource.uploadProgress || 0) + '%</span>';
                            } else if (tertiarySource.uploadedUrl || tertiarySource.youtubeVideoId) {
                                html += '<span class="source-preview-status">✓ Ready</span>';
                            }
                            html += '</div>';
                            html += '</div>';
                            html += '<button class="source-preview-remove" onclick="app.removeTertiarySource()" title="Remove">×</button>';
                            html += '</div>';

                            // Position selection for tertiary (the remaining position)
                            html += '<div class="secondary-source-options">';
                            html += '<div class="source-option-row">';
                            html += '<span class="source-option-label">📍 Position</span>';
                            html += '<select class="source-option-select" onchange="app.setTertiaryPosition(this.value)">';
                            // Tertiary can only go in positions not taken by secondary
                            var tertiaryPositions = [
                                { value: 'bottom-left', label: 'Bottom left' },
                                { value: 'bottom-right', label: 'Bottom right' }
                            ];
                            tertiaryPositions.forEach(function(opt) {
                                var selected = tertiarySource.position === opt.value ? ' selected' : '';
                                html += '<option value="' + opt.value + '"' + selected + '>' + opt.label + '</option>';
                            });
                            html += '</select>';
                            html += '</div>';

                            // Time sync offset
                            html += '<div class="source-option-row">';
                            html += '<span class="source-option-label">⏱️ Sync offset</span>';
                            html += '<div class="source-offset-control">';
                            html += '<button class="source-offset-btn" onclick="app.adjustTertiaryOffset(-0.5)">−</button>';
                            var tertOffsetSign = tertiarySource.timeOffset >= 0 ? '+' : '';
                            html += '<span class="source-offset-value">' + tertOffsetSign + (tertiarySource.timeOffset || 0).toFixed(1) + 's</span>';
                            html += '<button class="source-offset-btn" onclick="app.adjustTertiaryOffset(0.5)">+</button>';
                            html += '</div>';
                            html += '</div>';
                            html += '</div>';
                        }
                    }

                    html += '</div>'; // secondary-source-panel (reused for tertiary)
                    html += '</div>'; // customization-panel
                }
                // ===== END TERTIARY SOURCE PANEL =====
            }

            // Advanced Reframe Options Panel
            html += '<div class="customization-panel advanced-options-panel">';
            html += '<div class="panel-header">';
            html += '<span class="panel-icon">⚙️</span>';
            html += '<span class="panel-title">ADVANCED REFRAME</span>';
            html += '<button class="panel-toggle-btn" onclick="app.toggleAdvancedOptions()">▼</button>';
            html += '</div>';

            if (state.customization.showAdvancedOptions) {
                html += '<div class="advanced-options-content">';

                // Source/Output aspect ratio
                html += '<div class="advanced-option-group">';
                html += '<div class="advanced-option-row">';
                html += '<span class="advanced-option-label">Source Video</span>';
                html += '<span class="advanced-option-value">16:9 (Landscape)</span>';
                html += '</div>';
                html += '<div class="advanced-option-row">';
                html += '<span class="advanced-option-label">Output Format</span>';
                html += '<select class="advanced-option-select" onchange="app.setOutputAspect(this.value)">';
                var aspectOptions = [
                    { value: '9:16', label: '9:16 Portrait (TikTok/Reels/Shorts)' },
                    { value: '1:1', label: '1:1 Square (Instagram Feed)' },
                    { value: '4:5', label: '4:5 Portrait (Instagram Post)' },
                    { value: '16:9', label: '16:9 Landscape (YouTube)' }
                ];
                aspectOptions.forEach(function(opt) {
                    var selected = (settings.outputAspect || '9:16') === opt.value ? ' selected' : '';
                    html += '<option value="' + opt.value + '"' + selected + '>' + opt.label + '</option>';
                });
                html += '</select>';
                html += '</div>';
                html += '</div>';

                // Crop position for auto_center
                html += '<div class="advanced-option-group">';
                html += '<div class="advanced-option-row">';
                html += '<span class="advanced-option-label">Crop Position</span>';
                html += '</div>';
                // Convert legacy string values to percentage
                var advCropPos = settings.cropPosition;
                if (advCropPos === 'left') advCropPos = 0;
                else if (advCropPos === 'center') advCropPos = 50;
                else if (advCropPos === 'right') advCropPos = 100;
                else if (typeof advCropPos !== 'number') advCropPos = 50;
                html += '<div class="crop-position-grid">';
                var positions = [
                    { value: 0, label: '◀ Left' },
                    { value: 50, label: '● Center' },
                    { value: 100, label: '▶ Right' }
                ];
                positions.forEach(function(pos) {
                    var selected = advCropPos === pos.value ? ' selected' : '';
                    html += '<button class="crop-position-btn' + selected + '" onclick="app.setCropPosition(' + pos.value + ')">' + pos.label + '</button>';
                });
                html += '</div>';
                html += '<p class="advanced-option-hint">Or use the slider in Source Preview for fine control</p>';
                html += '</div>';

                // Zoom level for single video
                html += '<div class="advanced-option-group">';
                html += '<div class="advanced-option-row">';
                html += '<span class="advanced-option-label">Zoom Level</span>';
                html += '</div>';
                var videoZoom = settings.zoom || 100;
                html += '<div class="zoom-controls-grid">';
                html += '<div class="zoom-control-row">';
                html += '<span class="zoom-clip-label">🔍 Zoom</span>';
                html += '<div class="zoom-slider-wrap">';
                html += '<input type="range" class="zoom-slider" id="single-video-zoom" min="100" max="200" value="' + videoZoom + '" ';
                html += 'oninput="app.onVideoZoomChange(this.value)" onchange="app.setVideoZoom(this.value)">';
                html += '<span class="zoom-value" id="single-zoom-value">' + videoZoom + '%</span>';
                html += '</div>';
                html += '<button class="zoom-reset-btn" onclick="app.setVideoZoom(100)" title="Reset to 100%">↺</button>';
                html += '</div>';
                html += '</div>';
                html += '</div>';

                // Output quality
                html += '<div class="advanced-option-group">';
                html += '<div class="advanced-option-row">';
                html += '<span class="advanced-option-label">Output Quality</span>';
                html += '<select class="advanced-option-select" onchange="app.setOutputQuality(this.value)">';
                var qualityOptions = [
                    { value: '720p', label: '720p HD (Faster)' },
                    { value: '1080p', label: '1080p Full HD (Recommended)' }
                ];
                qualityOptions.forEach(function(opt) {
                    var selected = (settings.outputQuality || '1080p') === opt.value ? ' selected' : '';
                    html += '<option value="' + opt.value + '"' + selected + '>' + opt.label + '</option>';
                });
                html += '</select>';
                html += '</div>';
                html += '</div>';

                // Frame rate
                html += '<div class="advanced-option-group">';
                html += '<div class="advanced-option-row">';
                html += '<span class="advanced-option-label">Frame Rate</span>';
                html += '<select class="advanced-option-select" onchange="app.setFrameRate(this.value)">';
                var fpsOptions = [
                    { value: '24', label: '24 fps (Cinematic)' },
                    { value: '30', label: '30 fps (Standard)' },
                    { value: '60', label: '60 fps (Smooth)' }
                ];
                fpsOptions.forEach(function(opt) {
                    var selected = (settings.frameRate || '30') === opt.value ? ' selected' : '';
                    html += '<option value="' + opt.value + '"' + selected + '>' + opt.label + '</option>';
                });
                html += '</select>';
                html += '</div>';
                html += '</div>';

                html += '</div>'; // advanced-options-content
            }

            html += '</div>';

            // Timeline Panel with waveform and draggable handles
            html += '<div class="customization-panel">';
            html += '<div class="panel-header">';
            html += '<span class="panel-icon">✂️</span>';
            html += '<span class="panel-title">TRIM CLIP</span>';
            html += '</div>';

            var trimStart = settings.trimStart || 0;
            var trimEnd = settings.trimEnd || activeClip.duration;
            var trimDuration = trimEnd - trimStart;
            var startPercent = (trimStart / activeClip.duration) * 100;
            var widthPercent = (trimDuration / activeClip.duration) * 100;

            html += '<div class="timeline-container">';

            // Duration header
            html += '<div class="timeline-header">';
            html += '<div class="timeline-duration">';
            html += '<span class="timeline-duration-label">Duration:</span>';
            html += '<span class="timeline-duration-value">' + utils.formatDuration(trimDuration) + '</span>';
            html += '</div>';
            html += '<div class="timeline-fine-tune">';
            html += '<button class="timeline-fine-btn" onclick="app.adjustTrim(\'start\', -1)" title="Start -1s">◀</button>';
            html += '<button class="timeline-fine-btn" onclick="app.adjustTrim(\'start\', 1)" title="Start +1s">▶</button>';
            html += '<span style="width:8px"></span>';
            html += '<button class="timeline-fine-btn" onclick="app.adjustTrim(\'end\', -1)" title="End -1s">◀</button>';
            html += '<button class="timeline-fine-btn" onclick="app.adjustTrim(\'end\', 1)" title="End +1s">▶</button>';
            html += '</div>';
            html += '</div>';

            // Waveform visualization - generate speech-like pattern based on clip ID for consistency
            html += '<div class="timeline-waveform">';
            html += '<div class="waveform-bars">';

            // Seeded random based on clip ID for consistent waveform per clip
            var clipSeed = activeClip.id.split('').reduce(function(a, c) { return a + c.charCodeAt(0); }, 0);
            var seededRandom = function(i) {
                var x = Math.sin(clipSeed + i * 9999) * 10000;
                return x - Math.floor(x);
            };

            // Generate speech-like waveform pattern with phrases and pauses
            var numBars = 60;
            for (var i = 0; i < numBars; i++) {
                // Create speech pattern with clusters (phrases) and gaps (pauses)
                var phraseProgress = (i % 8) / 8;
                var inPhrase = (i % 12) < 8; // 8 bars speech, 4 bars pause
                var baseHeight = inPhrase ? 35 + seededRandom(i) * 50 : 10 + seededRandom(i) * 15;

                // Add natural speech variation - words get louder in middle
                var phraseEnvelope = Math.sin(phraseProgress * Math.PI);
                var height = inPhrase ? baseHeight * (0.5 + phraseEnvelope * 0.5) : baseHeight;

                // Occasional loud peaks (emphasis)
                if (seededRandom(i + 100) > 0.85 && inPhrase) {
                    height = Math.min(95, height * 1.4);
                }

                var barPos = (i / numBars) * 100;
                var isActive = barPos >= startPercent && barPos <= (startPercent + widthPercent);
                html += '<div class="waveform-bar' + (isActive ? ' active' : '') + '" style="height:' + height.toFixed(1) + '%"></div>';
            }
            html += '</div>';
            html += '</div>';

            // Timeline bar with handles
            html += '<div class="timeline-bar" id="timeline-bar">';
            html += '<div class="timeline-fill" style="left:' + startPercent + '%; width:' + widthPercent + '%"></div>';
            html += '<div class="timeline-handle" id="handle-start" style="left:' + startPercent + '%" data-handle="start"></div>';
            html += '<div class="timeline-handle" id="handle-end" style="left:' + (startPercent + widthPercent) + '%" data-handle="end"></div>';
            html += '</div>';

            // Time display
            html += '<div class="timeline-times">';
            html += '<span>' + utils.formatDuration(trimStart) + '</span>';
            html += '<span>' + utils.formatDuration(trimEnd) + '</span>';
            html += '</div>';

            html += '</div>';
            html += '</div>';

            // Audio Panel with enhanced controls
            html += '<div class="customization-panel">';
            html += '<div class="panel-header">';
            html += '<span class="panel-icon">🔊</span>';
            html += '<span class="panel-title">AUDIO</span>';
            html += '</div>';

            // Voice enhancement section
            html += '<div class="audio-section-title">Voice Enhancement</div>';
            html += '<div class="audio-options">';

            var audioCheckedFiller = settings.removeFiller ? ' checked' : '';
            html += '<label class="audio-option' + audioCheckedFiller + '">';
            html += '<input type="checkbox" ' + (settings.removeFiller ? 'checked' : '') + ' onchange="app.toggleAudioOption(\'removeFiller\')">';
            html += '<div class="audio-option-text">';
            html += '<div class="audio-option-title">Remove filler words</div>';
            html += '<div class="audio-option-desc">AI removes um, uh, like, you know</div>';
            html += '</div>';
            html += '</label>';

            var audioCheckedEnhance = settings.enhanceAudio ? ' checked' : '';
            html += '<label class="audio-option' + audioCheckedEnhance + '">';
            html += '<input type="checkbox" ' + (settings.enhanceAudio ? 'checked' : '') + ' onchange="app.toggleAudioOption(\'enhanceAudio\')">';
            html += '<div class="audio-option-text">';
            html += '<div class="audio-option-title">Enhance audio quality</div>';
            html += '<div class="audio-option-desc">Noise reduction & normalization</div>';
            html += '</div>';
            html += '</label>';

            var audioCheckedDucking = settings.audioDucking ? ' checked' : '';
            html += '<label class="audio-option' + audioCheckedDucking + '">';
            html += '<input type="checkbox" ' + (settings.audioDucking ? 'checked' : '') + ' onchange="app.toggleAudioOption(\'audioDucking\')">';
            html += '<div class="audio-option-text">';
            html += '<div class="audio-option-title">Smart audio ducking</div>';
            html += '<div class="audio-option-desc">Auto-lower music during speech</div>';
            html += '</div>';
            html += '</label>';

            html += '</div>';

            // Volume control
            html += '<div class="audio-section-title">Volume Control</div>';
            var voiceVolume = settings.voiceVolume || 100;
            html += '<div class="audio-volume-control">';
            html += '<span class="volume-icon">🎙️</span>';
            html += '<div class="volume-slider-container">';
            html += '<div class="volume-slider-label">';
            html += '<span>Voice Volume</span>';
            html += '<span class="volume-slider-value">' + voiceVolume + '%</span>';
            html += '</div>';
            html += '<input type="range" class="volume-slider" min="0" max="150" value="' + voiceVolume + '" oninput="app.setVolume(\'voice\', this.value)">';
            html += '</div>';
            html += '</div>';

            // Background music
            html += '<div class="audio-section-title">Background Music</div>';
            var musicChecked = settings.addMusic ? ' checked' : '';
            html += '<label class="audio-option' + musicChecked + '">';
            html += '<input type="checkbox" ' + (settings.addMusic ? 'checked' : '') + ' onchange="app.toggleAudioOption(\'addMusic\')">';
            html += '<div class="audio-option-text">';
            html += '<div class="audio-option-title">Add background music</div>';
            html += '<div class="audio-option-desc">Royalty-free trending tracks</div>';
            html += '</div>';
            html += '</label>';

            // Music library (shown when addMusic is enabled)
            if (settings.addMusic) {
                var musicVolume = settings.musicVolume || 30;
                html += '<div class="audio-volume-control" style="margin-top:0.75rem">';
                html += '<span class="volume-icon">🎵</span>';
                html += '<div class="volume-slider-container">';
                html += '<div class="volume-slider-label">';
                html += '<span>Music Volume</span>';
                html += '<span class="volume-slider-value">' + musicVolume + '%</span>';
                html += '</div>';
                html += '<input type="range" class="volume-slider" min="0" max="100" value="' + musicVolume + '" oninput="app.setVolume(\'music\', this.value)">';
                html += '</div>';
                html += '</div>';

                html += '<div class="music-library">';
                html += '<div class="music-tracks">';

                var musicTracks = [
                    { id: 'upbeat1', name: 'Energetic Rise', genre: 'Upbeat', duration: '2:45' },
                    { id: 'chill1', name: 'Lofi Dreams', genre: 'Chill', duration: '3:12' },
                    { id: 'epic1', name: 'Cinematic Power', genre: 'Epic', duration: '2:30' },
                    { id: 'electronic1', name: 'Digital Future', genre: 'Electronic', duration: '2:58' },
                    { id: 'ambient1', name: 'Peaceful Flow', genre: 'Ambient', duration: '4:05' }
                ];

                musicTracks.forEach(function(track) {
                    var trackSelected = settings.selectedTrack === track.id ? ' selected' : '';
                    html += '<div class="music-track' + trackSelected + '" onclick="app.selectMusicTrack(\'' + track.id + '\')">';
                    html += '<div class="music-track-play">▶</div>';
                    html += '<div class="music-track-info">';
                    html += '<div class="music-track-name">' + track.name + '</div>';
                    html += '<div class="music-track-meta">' + track.genre + '</div>';
                    html += '</div>';
                    html += '<div class="music-track-duration">' + track.duration + '</div>';
                    html += '</div>';
                });

                html += '</div>';
                html += '</div>';
            }

            html += '</div>';

            // Transitions & Effects Panel
            html += '<div class="customization-panel">';
            html += '<div class="panel-header">';
            html += '<span class="panel-icon">✨</span>';
            html += '<span class="panel-title">TRANSITIONS & EFFECTS</span>';
            html += '</div>';

            // Intro transitions
            html += '<div class="audio-section-title">Intro Transition</div>';
            html += '<div class="transition-options">';
            var introTransitions = [
                { id: 'none', name: 'None', icon: '—' },
                { id: 'fade', name: 'Fade In', icon: '◐' },
                { id: 'zoom', name: 'Zoom In', icon: '⊕' },
                { id: 'slide', name: 'Slide In', icon: '→' },
                { id: 'glitch', name: 'Glitch', icon: '⚡' }
            ];
            var currentIntro = settings.introTransition || 'none';
            introTransitions.forEach(function(t) {
                var selectedClass = currentIntro === t.id ? ' selected' : '';
                html += '<button class="transition-btn' + selectedClass + '" onclick="app.setTransition(\'intro\', \'' + t.id + '\')">';
                html += '<span class="transition-icon">' + t.icon + '</span>';
                html += '<span>' + t.name + '</span>';
                html += '</button>';
            });
            html += '</div>';

            // Outro transitions
            html += '<div class="audio-section-title">Outro Transition</div>';
            html += '<div class="transition-options">';
            var outroTransitions = [
                { id: 'none', name: 'None', icon: '—' },
                { id: 'fade', name: 'Fade Out', icon: '◑' },
                { id: 'zoom', name: 'Zoom Out', icon: '⊖' },
                { id: 'slide', name: 'Slide Out', icon: '←' }
            ];
            var currentOutro = settings.outroTransition || 'none';
            outroTransitions.forEach(function(t) {
                var selectedClass = currentOutro === t.id ? ' selected' : '';
                html += '<button class="transition-btn' + selectedClass + '" onclick="app.setTransition(\'outro\', \'' + t.id + '\')">';
                html += '<span class="transition-icon">' + t.icon + '</span>';
                html += '<span>' + t.name + '</span>';
                html += '</button>';
            });
            html += '</div>';

            // Visual effects
            html += '<div class="audio-section-title">Visual Effects</div>';
            html += '<div class="effect-options">';

            var effectZoom = settings.autoZoom ? ' checked' : '';
            html += '<label class="audio-option' + effectZoom + '">';
            html += '<input type="checkbox" ' + (settings.autoZoom ? 'checked' : '') + ' onchange="app.toggleEffect(\'autoZoom\')">';
            html += '<div class="audio-option-text">';
            html += '<div class="audio-option-title">Auto Zoom on Key Moments</div>';
            html += '<div class="audio-option-desc">Subtle zoom on emphasis points</div>';
            html += '</div>';
            html += '</label>';

            var effectVignette = settings.vignette ? ' checked' : '';
            html += '<label class="audio-option' + effectVignette + '">';
            html += '<input type="checkbox" ' + (settings.vignette ? 'checked' : '') + ' onchange="app.toggleEffect(\'vignette\')">';
            html += '<div class="audio-option-text">';
            html += '<div class="audio-option-title">Cinematic Vignette</div>';
            html += '<div class="audio-option-desc">Dark edges for focus effect</div>';
            html += '</div>';
            html += '</label>';

            var effectCG = settings.colorGrade ? ' checked' : '';
            html += '<label class="audio-option' + effectCG + '">';
            html += '<input type="checkbox" ' + (settings.colorGrade ? 'checked' : '') + ' onchange="app.toggleEffect(\'colorGrade\')">';
            html += '<div class="audio-option-text">';
            html += '<div class="audio-option-title">Auto Color Grading</div>';
            html += '<div class="audio-option-desc">Enhance colors for social media</div>';
            html += '</div>';
            html += '</label>';

            html += '</div>';
            html += '</div>';

            // Settings Summary Panel
            html += '<div class="customization-panel settings-summary-panel">';
            html += '<div class="panel-header">';
            html += '<span class="panel-icon">📋</span>';
            html += '<span class="panel-title">CURRENT SETTINGS</span>';
            html += '</div>';
            html += '<div class="settings-summary-grid">';

            // Caption style display names
            var captionDisplayNames = {
                'none': 'Off',
                'karaoke': 'Karaoke',
                'beasty': 'MrBeast',
                'deepdiver': 'Minimal',
                'podp': 'Podcast',
                'hormozi': 'Hormozi',
                'ali': 'Ali Abdaal',
                'custom': 'Custom'
            };
            var captionDisplayName = captionDisplayNames[settings.captionStyle] || settings.captionStyle;

            // Reframe mode display names
            var reframeDisplayNames = {
                'auto_center': 'Center Crop',
                'split_screen': 'Split Screen',
                'three_person': 'Three Person',
                'gameplay': 'Gameplay',
                'broll_split': 'B-Roll'
            };
            var reframeDisplayName = reframeDisplayNames[settings.reframeMode] || (settings.reframeMode || 'auto_center').replace(/_/g, ' ');

            html += '<div class="summary-item"><span class="summary-label">Captions</span><span class="summary-value">' + captionDisplayName + '</span></div>';
            html += '<div class="summary-item"><span class="summary-label">Reframe</span><span class="summary-value">' + reframeDisplayName + '</span></div>';
            html += '<div class="summary-item"><span class="summary-label">Duration</span><span class="summary-value">' + utils.formatDuration((settings.trimEnd || activeClip.duration) - (settings.trimStart || 0)) + '</span></div>';
            html += '<div class="summary-item"><span class="summary-label">Audio</span><span class="summary-value">' + (settings.enhanceAudio ? 'Enhanced' : 'Original') + (settings.removeFiller ? ', Filler removed' : '') + '</span></div>';
            html += '<div class="summary-item"><span class="summary-label">Effects</span><span class="summary-value">' + [settings.autoZoom ? 'Zoom' : '', settings.vignette ? 'Vignette' : '', settings.colorGrade ? 'Color' : ''].filter(Boolean).join(', ') + (![settings.autoZoom, settings.vignette, settings.colorGrade].some(Boolean) ? 'None' : '') + '</span></div>';
            html += '<div class="summary-item"><span class="summary-label">Transitions</span><span class="summary-value">' + (settings.introTransition || 'none') + ' / ' + (settings.outroTransition || 'none') + '</span></div>';
            html += '</div>';
            html += '</div>';

            // AI Features Bar
            html += '<div class="ai-features-bar">';
            html += '<button class="ai-feature-btn" onclick="app.applyAIFeature(\'clipping\')"><span class="ai-btn-icon">✂️</span> AI Clipping</button>';
            html += '<button class="ai-feature-btn" onclick="app.applyAIFeature(\'captioning\')"><span class="ai-btn-icon">💬</span> AI Captions</button>';
            html += '<button class="ai-feature-btn" onclick="app.applyAIFeature(\'reframe\')"><span class="ai-btn-icon">🔲</span> AI Reframe</button>';
            html += '<button class="ai-feature-btn" onclick="app.applyAIFeature(\'broll\')"><span class="ai-btn-icon">🎨</span> AI B-Roll</button>';
            html += '<button class="ai-feature-btn" onclick="app.applyAIFeature(\'audio\')"><span class="ai-btn-icon">🔊</span> AI Audio</button>';
            html += '<button class="ai-feature-btn" onclick="app.applyAIFeature(\'hook\')"><span class="ai-btn-icon">🪝</span> AI Hook</button>';
            html += '</div>';

            html += '</div>'; // customization-panels
            html += '</div>'; // customization-layout

            // Apply to All bar (if multiple clips)
            if (selectedClips.length > 1) {
                html += '<div class="apply-all-bar">';
                html += '<div class="apply-all-info">';
                html += '<span class="apply-all-icon">⚡</span>';
                html += '<span>Apply captions, audio & effects to all clips (layout & videos stay separate)</span>';
                html += '</div>';
                html += '<button class="apply-all-btn" onclick="app.applySettingsToAllClips()">Apply Common Settings</button>';
                html += '</div>';
            }

            // Navigation
            html += '<div class="wizard-nav">';
            html += '<div class="wizard-nav-left">';
            html += '<button class="btn-secondary" onclick="app.goToStep(3)">← Back to Clips</button>';
            html += '</div>';
            html += '<div class="wizard-nav-right">';
            html += '<button class="btn-secondary" onclick="app.saveProject()" style="margin-right:0.75rem">💾 Save</button>';
            html += '<button class="btn-primary" onclick="app.goToStep(5)">SEO & Thumbnails →</button>';
            html += '</div>';
            html += '</div>';

            return html;
        }

        function getDefaultSettings() {
            return {
                // Caption settings
                captionStyle: 'karaoke',
                captionSource: 'primary',  // Which video's audio to use for captions: 'primary' or 'secondary'

                // Reframe settings
                reframeMode: 'auto_center',
                cropPosition: 50, // 0-100 percentage (0=left, 50=center, 100=right)
                zoom: 100, // Zoom level for single video mode: 100% = no zoom, 200% = 2x zoom
                aiSmartCrop: false, // Whether AI detected the position

                // Split screen specific settings (for split_screen mode)
                splitScreenSettings: {
                    speaker1: {
                        cropPosition: 50,  // Default: center (0-100%)
                        cropWidth: 33,     // Percentage of source width to crop (legacy, now calculated dynamically)
                        zoom: 100          // Zoom level: 100% = fit, >100 = zoom in
                    },
                    speaker2: {
                        cropPosition: 50,  // Default: center (0-100%)
                        cropWidth: 33,     // Percentage of source width to crop (legacy, now calculated dynamically)
                        zoom: 100          // Zoom level: 100% = fit, >100 = zoom in
                    },
                    preset: 'center',      // 'interview', 'center', 'custom'
                    layoutRatio: '50-50',  // '50-50', '60-40', '70-30' (top-bottom percentages)
                    border: {
                        enabled: false,
                        thickness: 2,      // 1-10 pixels
                        color: '#ffffff'   // Border color
                    }
                },

                // Three person specific settings (for three_person mode)
                threePersonSettings: {
                    main: {
                        cropPosition: 50,  // Default: center (0-100%)
                        zoom: 100          // Zoom level: 100% = fit, >100 = zoom in
                    },
                    left: {
                        cropPosition: 50,  // Default: center (0-100%)
                        zoom: 100
                    },
                    right: {
                        cropPosition: 50,  // Default: center (0-100%)
                        zoom: 100
                    },
                    preset: 'center',      // 'center', 'custom'
                    layoutRatio: '50-50'   // '50-50', '60-40', '70-30' (top-bottom percentages)
                },

                // Timeline/trim settings
                trimStart: 0,
                trimEnd: null,

                // Audio settings
                removeFiller: false,
                enhanceAudio: true,
                audioDucking: true,
                voiceVolume: 100,
                addMusic: false,
                musicVolume: 30,
                selectedTrack: null,

                // Transition settings
                introTransition: 'none',
                outroTransition: 'none',

                // Visual effects
                autoZoom: false,
                vignette: false,
                colorGrade: false,

                // Secondary source settings (multi-source split screen)
                secondarySource: {
                    enabled: false,
                    inputTab: 'upload',       // 'upload' or 'youtube'
                    type: null,               // 'upload' or 'youtube' when file/url is set
                    file: null,               // File object for uploads
                    fileName: null,           // File name for display
                    fileSize: null,           // File size for display
                    uploadedUrl: null,        // Storage URL after upload
                    youtubeUrl: null,         // YouTube URL
                    youtubeVideoId: null,     // Extracted video ID
                    youtubeThumbnail: null,   // YouTube thumbnail for preview
                    youtubeTitle: null,       // YouTube video title
                    position: 'bottom',       // 'top', 'bottom', 'left', 'right', 'corner'
                    timeOffset: 0             // Sync offset in seconds (-10 to +10)
                },

                // Tertiary source settings (for three_person mode - third video)
                tertiarySource: {
                    enabled: false,
                    inputTab: 'upload',
                    type: null,
                    file: null,
                    fileName: null,
                    fileSize: null,
                    uploadedUrl: null,
                    youtubeUrl: null,
                    youtubeVideoId: null,
                    youtubeThumbnail: null,
                    youtubeTitle: null,
                    position: 'bottom-right',  // For three_person: 'bottom-left' or 'bottom-right'
                    timeOffset: 0
                },

                // Audio mixing (when secondary source is enabled)
                audioMix: {
                    primaryVolume: 100,       // 0-100
                    secondaryVolume: 0,       // 0-100
                    tertiaryVolume: 0,        // 0-100 (for three_person mode)
                    primaryMuted: false,
                    secondaryMuted: true,     // Default: secondary audio muted
                    tertiaryMuted: true       // Default: tertiary audio muted
                }
            };
        }

        /* ==========================================
           STEP 5: SEO & THUMBNAILS
           ========================================== */

        function renderStep5SEO() {
            var selectedClips = state.clips.filter(function(c) {
                return state.selectedClipIds.indexOf(c.id) !== -1;
            });
            var activeClip = selectedClips[state.customization.activeClipIndex] || selectedClips[0];
            var seo = state.clipSEO[activeClip.id] || getDefaultSEO(activeClip);

            var html = '';

            // Clip navigation
            html += '<div class="clips-header">';
            html += '<h2>SEO & Thumbnails: Clip ' + (state.customization.activeClipIndex + 1) + '</h2>';
            html += '<div class="clip-nav" style="margin-top:0">';
            html += '<button class="clip-nav-btn" onclick="app.prevClip()" ' + (state.customization.activeClipIndex === 0 ? 'disabled' : '') + '>← Prev</button>';
            html += '<span class="clip-counter">' + (state.customization.activeClipIndex + 1) + ' / ' + selectedClips.length + '</span>';
            html += '<button class="clip-nav-btn" onclick="app.nextClip()" ' + (state.customization.activeClipIndex >= selectedClips.length - 1 ? 'disabled' : '') + '>Next →</button>';
            html += '</div>';
            html += '</div>';

            html += '<div class="seo-layout">';

            // Left: SEO Fields
            html += '<div class="seo-panel">';

            // Title
            html += '<div class="seo-field">';
            html += '<div class="seo-label">';
            html += '<span>TITLE (auto-generated)</span>';
            html += '<span class="char-count">' + (seo.title ? seo.title.length : 0) + '/100</span>';
            html += '</div>';
            html += '<div style="display:flex;gap:0.5rem">';
            html += '<input type="text" class="seo-input" id="seo-title" value="' + utils.escapeHtml(seo.title) + '" oninput="app.updateSEO(\'title\', this.value)">';
            html += '<button class="regenerate-btn" onclick="app.regenerateSEO(\'title\')">🔄</button>';
            html += '</div>';
            html += '</div>';

            // Description
            html += '<div class="seo-field">';
            html += '<div class="seo-label">';
            html += '<span>DESCRIPTION</span>';
            html += '<span class="char-count">' + (seo.description ? seo.description.length : 0) + '</span>';
            html += '</div>';
            html += '<textarea class="seo-input seo-textarea" id="seo-description" oninput="app.updateSEO(\'description\', this.value)">' + utils.escapeHtml(seo.description) + '</textarea>';
            html += '</div>';

            // Tags
            html += '<div class="seo-field">';
            html += '<div class="seo-label">';
            html += '<span>TAGS</span>';
            html += '</div>';
            html += '<div class="tags-container">';
            if (seo.tags) {
                seo.tags.forEach(function(tag, index) {
                    html += '<span class="tag">' + utils.escapeHtml(tag) + ' <span class="tag-remove" onclick="app.removeTag(' + index + ')">×</span></span>';
                });
            }
            html += '<button class="add-tag-btn" onclick="app.addTag()">+ Add</button>';
            html += '</div>';
            html += '</div>';

            html += '</div>'; // seo-panel

            // Right: Thumbnails
            html += '<div class="seo-panel thumbnails-panel">';
            html += '<h3>📱 SHORTS THUMBNAILS (9:16)</h3>';
            html += '<p style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin: -0.5rem 0 1rem 0;">Vertical format for YouTube Shorts, TikTok, Reels</p>';

            // Get generated thumbnails - check for nested structure from backend
            var thumbnailData = state.clipThumbnails[activeClip.id];
            var thumbnails = [];
            if (thumbnailData) {
                // Handle both array and object with thumbnails property
                thumbnails = Array.isArray(thumbnailData) ? thumbnailData :
                    (thumbnailData.thumbnails || []);
            }

            var selectedThumbnailIdx = state.selectedThumbnail && state.selectedThumbnail[activeClip.id] !== undefined
                ? state.selectedThumbnail[activeClip.id] : 0;

            var hasGeneratedThumbnails = thumbnails.length > 0 && thumbnails.some(function(t) {
                var url = t ? (t.previewUrl || t.url || t) : null;
                return url && typeof url === 'string' && !url.includes('picsum.photos');
            });

            html += '<div class="thumbnails-grid">';
            for (var i = 0; i < 2; i++) {
                var selectedClass = i === selectedThumbnailIdx ? ' selected' : '';
                var thumb = thumbnails[i];
                var thumbUrl = null;

                if (thumb) {
                    thumbUrl = thumb.previewUrl || thumb.url || (typeof thumb === 'string' ? thumb : null);
                }

                var isValidThumbnail = thumbUrl && typeof thumbUrl === 'string' &&
                    thumbUrl.startsWith('http') && !thumbUrl.includes('picsum.photos');

                html += '<div class="thumbnail-option' + selectedClass + '" onclick="app.selectThumbnail(' + i + ')">';

                if (isValidThumbnail) {
                    html += '<img src="' + utils.escapeHtml(thumbUrl) + '" alt="Thumbnail Option ' + String.fromCharCode(65 + i) + '">';
                    html += '<button class="thumbnail-download-btn" onclick="event.stopPropagation(); app.downloadThumbnail(\'' + activeClip.id + '\', ' + i + ')" title="Download">↓</button>';
                } else {
                    // Show placeholder with clip frame
                    html += '<div class="thumbnail-placeholder">';
                    if (activeClip.thumbnail) {
                        html += '<img src="' + utils.escapeHtml(activeClip.thumbnail) + '" alt="Frame" style="opacity: 0.3; width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0;">';
                    }
                    html += '<div style="position: relative; z-index: 1; text-align: center;">';
                    html += '<span style="font-size: 1.5rem;">🎨</span>';
                    html += '<span style="display: block; font-size: 0.65rem; margin-top: 0.25rem;">Not Generated</span>';
                    html += '</div>';
                    html += '</div>';
                }

                html += '<span class="thumbnail-label">' + String.fromCharCode(65 + i) + '</span>';
                html += '<div class="thumbnail-radio"></div>';
                html += '</div>';
            }
            html += '</div>';

            // Generate button with status and loading indicator
            if (state.thumbnailGenerating) {
                html += '<button class="regenerate-thumbnails-btn" disabled>';
                html += '<span class="thumbnail-loading-spinner"></span>';
                html += ' Extracting frames & generating...';
                html += '</button>';
                html += '<div class="thumbnail-loading-info">This may take 30-60 seconds as we extract actual frames from your video clip for reference.</div>';
            } else if (hasGeneratedThumbnails) {
                html += '<button class="regenerate-thumbnails-btn" onclick="app.regenerateThumbnails()">🔄 Regenerate Thumbnails</button>';
            } else {
                html += '<button class="regenerate-thumbnails-btn primary-action" onclick="app.regenerateThumbnails()">🎨 Generate AI Thumbnails</button>';
            }

            html += '</div>'; // thumbnails-panel

            html += '</div>'; // seo-layout

            // Navigation
            html += '<div class="wizard-nav">';
            html += '<div class="wizard-nav-left">';
            html += '<button class="btn-secondary" onclick="app.goToStep(4)">← Back</button>';
            html += '</div>';
            html += '<div class="wizard-nav-right">';
            html += '<button class="btn-primary" onclick="app.goToStep(6)">Export All →</button>';
            html += '</div>';
            html += '</div>';

            return html;
        }

        /* ==========================================
           STEP 6: EXPORT
           ========================================== */

        function renderStep6Export() {
            var selectedClips = state.clips.filter(function(c) {
                return state.selectedClipIds.indexOf(c.id) !== -1;
            });

            // Count AI enhancements applied
            var aiFeatureCount = 0;
            selectedClips.forEach(function(clip) {
                if (state.clipBRoll && state.clipBRoll[clip.id]) aiFeatureCount++;
                if (state.clipHooks && state.clipHooks[clip.id]) aiFeatureCount++;
                if (state.clipFillers && state.clipFillers[clip.id]) aiFeatureCount++;
            });

            var html = '';

            // Header
            html += '<div class="export-header">';
            html += '<h2>🎉 Export Ready: ' + selectedClips.length + ' Clips</h2>';
            html += '<div class="export-ready-badge"><span>✅</span> All clips processed</div>';
            html += '</div>';

            // Main Container with two columns
            html += '<div class="export-container">';

            // Left: Export Main Panel
            html += '<div class="export-main">';

            // Summary
            html += '<div class="export-summary">';
            html += '<div class="export-summary-title">📦 Export Package Includes:</div>';
            html += '<ul class="export-summary-list">';
            html += '<li>' + selectedClips.length + ' optimized video clips</li>';
            html += '<li>SEO metadata (titles, descriptions, tags)</li>';
            html += '<li>AI-generated thumbnails (3 A/B variants each)</li>';
            if (aiFeatureCount > 0) {
                html += '<li>' + aiFeatureCount + ' AI enhancements (B-Roll, Hooks, Filler removal)</li>';
            }
            html += '<li>Platform-specific export settings</li>';
            html += '</ul>';
            html += '</div>';

            // Export List
            html += '<div class="export-list">';
            selectedClips.forEach(function(clip, index) {
                var seo = state.clipSEO[clip.id] || getDefaultSEO(clip);

                // Use AI-generated thumbnail if user selected one, otherwise fall back to original
                var exportThumbUrl = null;
                var clipThumbs = state.clipThumbnails[clip.id];
                var selectedThumbIndex = state.selectedThumbnail[clip.id];
                if (clipThumbs && clipThumbs.length > 0 && selectedThumbIndex !== undefined) {
                    // User selected an AI-generated thumbnail
                    exportThumbUrl = clipThumbs[selectedThumbIndex]?.previewUrl;
                }
                // Fallback to original clip thumbnail or placeholder
                if (!exportThumbUrl) {
                    exportThumbUrl = clip.thumbnail || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="80" height="45" viewBox="0 0 80 45"%3E%3Crect fill="%231a1a2e" width="80" height="45"/%3E%3Ctext x="40" y="28" fill="%23ec4899" font-family="sans-serif" font-size="14" text-anchor="middle"%3E🎬%3C/text%3E%3C/svg%3E';
                }

                html += '<div class="export-item">';
                html += '<img src="' + exportThumbUrl + '" alt="Clip" class="export-item-thumbnail">';
                html += '<div class="export-item-info">';
                html += '<div class="export-item-title">' + utils.escapeHtml(seo.title || 'Clip ' + (index + 1)) + '</div>';
                html += '<div class="export-item-platforms">→ ' + clip.platforms.map(utils.getPlatformName).join(', ') + '</div>';
                html += '</div>';
                html += '<div class="export-item-status"><span>✅</span> Ready</div>';
                html += '<div class="export-item-actions">';
                html += '<button class="export-action-btn" onclick="app.downloadClip(\'' + clip.id + '\')">📥 MP4</button>';
                html += '<button class="export-action-btn" onclick="app.downloadThumbnail(\'' + clip.id + '\')">🖼️ Thumb</button>';
                html += '<button class="export-action-btn" onclick="app.copySEO(\'' + clip.id + '\')">📋 SEO</button>';
                html += '</div>';
                html += '</div>';
            });
            html += '</div>';

            // Batch Export Banner (Sequential capture, GPU processing)
            html += '<div class="parallel-export-banner">';
            html += '<div class="parallel-export-header">';
            html += '<span class="parallel-export-icon">🚀</span>';
            html += '<span class="parallel-export-title">Batch Export All Clips</span>';
            html += '<span class="parallel-export-badge">GPU Accelerated</span>';
            html += '</div>';
            html += '<div class="parallel-export-description">';
            html += 'Export all ' + selectedClips.length + ' clips one by one with GPU acceleration. ';
            html += 'Stops immediately if any error occurs. Click to cancel anytime.';
            html += '</div>';
            html += '<button class="parallel-export-btn" onclick="app.exportAllClipsParallel()">';
            html += '🎬 Export All ' + selectedClips.length + ' Clips';
            html += '</button>';
            html += '</div>';

            // Parallel export progress container (hidden by default)
            html += '<div id="parallelExportProgress" class="parallel-export-progress" style="display: none;">';
            html += '</div>';

            // Large Export Actions
            html += '<div class="export-actions-large">';
            html += '<button class="export-btn-large primary" onclick="app.exportFullProject(\'json\')">';
            html += '<span class="export-btn-icon">📥</span>';
            html += '<span class="export-btn-label">Download All (JSON)</span>';
            html += '<span class="export-btn-sublabel">Complete project with all AI data</span>';
            html += '</button>';
            html += '<button class="export-btn-large" onclick="app.exportFullProject(\'csv\')">';
            html += '<span class="export-btn-icon">📋</span>';
            html += '<span class="export-btn-label">Export SEO Sheet</span>';
            html += '<span class="export-btn-sublabel">CSV for spreadsheet apps</span>';
            html += '</button>';
            html += '<button class="export-btn-large" onclick="app.saveProject()">';
            html += '<span class="export-btn-icon">💾</span>';
            html += '<span class="export-btn-label">Save Project</span>';
            html += '<span class="export-btn-sublabel">Continue editing later</span>';
            html += '</button>';
            html += '<button class="export-btn-large" onclick="app.startNewProject()">';
            html += '<span class="export-btn-icon">🔄</span>';
            html += '<span class="export-btn-label">Start New</span>';
            html += '<span class="export-btn-sublabel">Begin a fresh project</span>';
            html += '</button>';
            html += '</div>';

            html += '</div>'; // export-main

            // Right: Sidebar
            html += '<div class="export-sidebar">';

            // Export Format Options
            html += '<div class="export-panel">';
            html += '<h3>📁 Export Formats</h3>';

            html += '<div class="export-option selected" onclick="app.selectExportFormat(\'full\')">';
            html += '<div class="export-option-icon">📦</div>';
            html += '<div class="export-option-info">';
            html += '<div class="export-option-title">Full Project (JSON)</div>';
            html += '<div class="export-option-desc">All data including AI features</div>';
            html += '</div>';
            html += '<span class="export-option-badge">Recommended</span>';
            html += '</div>';

            html += '<div class="export-option" onclick="app.selectExportFormat(\'seo\')">';
            html += '<div class="export-option-icon">📋</div>';
            html += '<div class="export-option-info">';
            html += '<div class="export-option-title">SEO Only (CSV)</div>';
            html += '<div class="export-option-desc">Titles, descriptions, tags</div>';
            html += '</div>';
            html += '</div>';

            html += '<div class="export-option" onclick="app.selectExportFormat(\'captions\')">';
            html += '<div class="export-option-icon">💬</div>';
            html += '<div class="export-option-info">';
            html += '<div class="export-option-title">Captions (SRT)</div>';
            html += '<div class="export-option-desc">Subtitle files for each clip</div>';
            html += '</div>';
            html += '</div>';

            html += '</div>'; // export-panel

            // YouTube Connection Panel
            html += '<div class="export-panel youtube-connection-panel">';
            html += '<h3>🔗 YouTube Connection</h3>';

            if (state.youtubeConnection.loading) {
                html += '<div class="youtube-connection-status loading">';
                html += '<div class="connection-loading-spinner"></div>';
                html += '<span>Connecting to YouTube...</span>';
                html += '</div>';
            } else if (state.youtubeConnection.connected && state.youtubeConnection.channel) {
                html += '<div class="youtube-connection-status connected">';
                if (state.youtubeConnection.channel.thumbnail) {
                    html += '<img src="' + state.youtubeConnection.channel.thumbnail + '" alt="Channel" class="youtube-channel-thumb">';
                } else {
                    html += '<div class="youtube-channel-icon">✓</div>';
                }
                html += '<div class="youtube-channel-info">';
                html += '<div class="youtube-channel-name">' + utils.escapeHtml(state.youtubeConnection.channel.title || 'Connected') + '</div>';
                html += '<div class="youtube-channel-label">YouTube Connected</div>';
                html += '</div>';
                html += '<button class="youtube-disconnect-btn" onclick="app.disconnectYouTube()" title="Disconnect">✕</button>';
                html += '</div>';
                html += '<p class="youtube-connection-info">Video export will use your YouTube authentication for best compatibility.</p>';
            } else {
                html += '<p class="youtube-connection-desc">Connect your YouTube account to enable video export. This allows us to download videos on your behalf.</p>';
                if (state.youtubeConnection.error) {
                    html += '<div class="youtube-connection-error">' + utils.escapeHtml(state.youtubeConnection.error) + '</div>';
                }
                html += '<button class="youtube-connect-btn" onclick="app.connectYouTube()">';
                html += '<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>';
                html += ' Connect YouTube Account';
                html += '</button>';
            }
            html += '</div>'; // youtube-connection-panel

            // Quick Links
            html += '<div class="export-panel">';
            html += '<h3>🔗 Quick Navigation</h3>';
            html += '<div class="quick-links">';
            html += '<a href="/video-optimizer" class="quick-link">';
            html += '<span class="quick-link-icon">📊</span> Video Optimizer Dashboard';
            html += '</a>';
            html += '<a href="/aitools.html" class="quick-link">';
            html += '<span class="quick-link-icon">🤖</span> AI Tools Suite';
            html += '</a>';
            html += '<a href="/main-dashboard.html" class="quick-link">';
            html += '<span class="quick-link-icon">🏠</span> Main Dashboard';
            html += '</a>';
            html += '<a href="/placement-finder.html" class="quick-link">';
            html += '<span class="quick-link-icon">🎯</span> Placement Finder';
            html += '</a>';
            html += '<a href="/campaign.html" class="quick-link">';
            html += '<span class="quick-link-icon">📈</span> Campaign Analyzer';
            html += '</a>';
            html += '</div>';
            html += '</div>'; // export-panel

            html += '</div>'; // export-sidebar

            html += '</div>'; // export-container

            // Navigation
            html += '<div class="wizard-nav">';
            html += '<div class="wizard-nav-left">';
            html += '<button class="btn-secondary" onclick="app.goToStep(5)">← Back to SEO</button>';
            html += '</div>';
            html += '<div class="wizard-nav-right">';
            html += '<a href="/video-optimizer" class="btn-primary">✅ Done - Go to Dashboard</a>';
            html += '</div>';
            html += '</div>';

            return html;
        }

        /* ==========================================
           4.5 EVENT HANDLERS
           ========================================== */

        function attachEventListeners() {
            // Dropzone drag & drop
            var dropzone = document.getElementById('dropzone');
            if (dropzone) {
                dropzone.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    dropzone.classList.add('dragover');
                });
                dropzone.addEventListener('dragleave', function(e) {
                    dropzone.classList.remove('dragover');
                });
                dropzone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    dropzone.classList.remove('dragover');
                    // Handle file drop
                    if (e.dataTransfer.files.length > 0) {
                        utils.showToast('File upload coming soon!', 'info');
                    }
                });
            }

            // URL input
            var urlInput = document.getElementById('video-url');
            if (urlInput) {
                urlInput.addEventListener('input', function() {
                    state.videoInput.url = this.value;
                });
                urlInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        app.analyzeVideo();
                    }
                });
            }

            // Timeline draggable handles (Step 4)
            var timelineBar = document.getElementById('timeline-bar');
            var handleStart = document.getElementById('handle-start');
            var handleEnd = document.getElementById('handle-end');

            // Clean up old timeline document event listeners to prevent accumulation
            if (documentEventListeners.timelineMouseMove) {
                document.removeEventListener('mousemove', documentEventListeners.timelineMouseMove);
                documentEventListeners.timelineMouseMove = null;
            }
            if (documentEventListeners.timelineMouseUp) {
                document.removeEventListener('mouseup', documentEventListeners.timelineMouseUp);
                documentEventListeners.timelineMouseUp = null;
            }
            if (documentEventListeners.timelineTouchMove) {
                document.removeEventListener('touchmove', documentEventListeners.timelineTouchMove);
                documentEventListeners.timelineTouchMove = null;
            }
            if (documentEventListeners.timelineTouchEnd) {
                document.removeEventListener('touchend', documentEventListeners.timelineTouchEnd);
                documentEventListeners.timelineTouchEnd = null;
            }

            if (timelineBar && handleStart && handleEnd) {
                var isDragging = null;
                var barRect = null;

                function getActiveClipDuration() {
                    var selectedClips = state.clips.filter(function(c) {
                        return state.selectedClipIds.indexOf(c.id) !== -1;
                    });
                    var activeClip = selectedClips[state.customization.activeClipIndex];
                    return activeClip ? activeClip.duration : 60;
                }

                function handleMouseDown(e, handle) {
                    e.preventDefault();
                    isDragging = handle;
                    barRect = timelineBar.getBoundingClientRect();
                    handle.classList.add('dragging');
                    document.body.style.cursor = 'ew-resize';
                }

                function handleMouseMove(e) {
                    if (!isDragging || !barRect) return;

                    var x = e.clientX - barRect.left;
                    var percent = Math.max(0, Math.min(100, (x / barRect.width) * 100));
                    var duration = getActiveClipDuration();
                    var time = Math.round((percent / 100) * duration);

                    var selectedClips = state.clips.filter(function(c) {
                        return state.selectedClipIds.indexOf(c.id) !== -1;
                    });
                    var activeClip = selectedClips[state.customization.activeClipIndex];
                    if (!activeClip) return;

                    var settings = state.clipSettings[activeClip.id] || getDefaultSettings();
                    var trimStart = settings.trimStart || 0;
                    var trimEnd = settings.trimEnd || duration;

                    if (isDragging === handleStart) {
                        // Minimum 5 second clip
                        trimStart = Math.max(0, Math.min(time, trimEnd - 5));
                    } else {
                        // Minimum 5 second clip
                        trimEnd = Math.min(duration, Math.max(time, trimStart + 5));
                    }

                    // Update visually without full re-render
                    var startPercent = (trimStart / duration) * 100;
                    var widthPercent = ((trimEnd - trimStart) / duration) * 100;

                    var fill = timelineBar.querySelector('.timeline-fill');
                    if (fill) {
                        fill.style.left = startPercent + '%';
                        fill.style.width = widthPercent + '%';
                    }
                    handleStart.style.left = startPercent + '%';
                    handleEnd.style.left = (startPercent + widthPercent) + '%';

                    // Update state
                    if (!state.clipSettings[activeClip.id]) {
                        state.clipSettings[activeClip.id] = getDefaultSettings();
                    }
                    state.clipSettings[activeClip.id].trimStart = trimStart;
                    state.clipSettings[activeClip.id].trimEnd = trimEnd;

                    // Update time display
                    var times = document.querySelectorAll('.timeline-times span');
                    if (times.length >= 2) {
                        times[0].textContent = utils.formatDuration(trimStart);
                        times[1].textContent = utils.formatDuration(trimEnd);
                    }

                    // Update duration display
                    var durationValue = document.querySelector('.timeline-duration-value');
                    if (durationValue) {
                        durationValue.textContent = utils.formatDuration(trimEnd - trimStart);
                    }
                }

                function handleMouseUp() {
                    if (isDragging) {
                        isDragging.classList.remove('dragging');
                        isDragging = null;
                        barRect = null;
                        document.body.style.cursor = '';
                        // Update waveform colors
                        render();
                    }
                }

                // Create touch move handler
                function handleTouchMove(e) {
                    if (isDragging) {
                        handleMouseMove({ clientX: e.touches[0].clientX });
                    }
                }

                handleStart.addEventListener('mousedown', function(e) { handleMouseDown(e, handleStart); });
                handleEnd.addEventListener('mousedown', function(e) { handleMouseDown(e, handleEnd); });

                // Store and add document listeners (to enable cleanup on next render)
                documentEventListeners.timelineMouseMove = handleMouseMove;
                documentEventListeners.timelineMouseUp = handleMouseUp;
                documentEventListeners.timelineTouchMove = handleTouchMove;
                documentEventListeners.timelineTouchEnd = handleMouseUp;

                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);

                // Touch support for mobile
                handleStart.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    handleMouseDown({ clientX: e.touches[0].clientX, preventDefault: function(){} }, handleStart);
                });
                handleEnd.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    handleMouseDown({ clientX: e.touches[0].clientX, preventDefault: function(){} }, handleEnd);
                });
                document.addEventListener('touchmove', handleTouchMove);
                document.addEventListener('touchend', handleMouseUp);
            }

            // Apply audio mute state to preview videos
            applyPreviewAudioMute();

            // Secondary source dropzone
            var secondaryDropzone = document.getElementById('secondary-upload-dropzone');
            if (secondaryDropzone) {
                secondaryDropzone.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    secondaryDropzone.classList.add('dragging');
                });
                secondaryDropzone.addEventListener('dragleave', function(e) {
                    secondaryDropzone.classList.remove('dragging');
                });
                secondaryDropzone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    secondaryDropzone.classList.remove('dragging');
                    if (e.dataTransfer.files.length > 0) {
                        app.handleSecondaryFileSelect(e.dataTransfer.files);
                    }
                });
            }

            // Crop zone drag functionality (Step 4)
            var cropPreviewArea = document.getElementById('cropPreviewArea');
            var cropGuideZone = document.getElementById('cropGuideZone');
            var cropSlider = document.getElementById('cropSlider');

            // Clean up old crop zone document event listeners to prevent accumulation
            if (documentEventListeners.cropMouseMove) {
                document.removeEventListener('mousemove', documentEventListeners.cropMouseMove);
                documentEventListeners.cropMouseMove = null;
            }
            if (documentEventListeners.cropMouseUp) {
                document.removeEventListener('mouseup', documentEventListeners.cropMouseUp);
                documentEventListeners.cropMouseUp = null;
            }
            if (documentEventListeners.cropTouchMove) {
                document.removeEventListener('touchmove', documentEventListeners.cropTouchMove);
                documentEventListeners.cropTouchMove = null;
            }
            if (documentEventListeners.cropTouchEnd) {
                document.removeEventListener('touchend', documentEventListeners.cropTouchEnd);
                documentEventListeners.cropTouchEnd = null;
            }

            if (cropPreviewArea && cropGuideZone) {
                var cropDragging = false;
                var cropAreaRect = null;
                var cropZoneWidth = 0.31640625; // Correct: (9/16)² for 16:9→9:16 crop

                function cropMouseDown(e) {
                    e.preventDefault();
                    cropDragging = true;
                    cropAreaRect = cropPreviewArea.getBoundingClientRect();
                    cropGuideZone.classList.add('dragging');
                    document.body.style.cursor = 'grabbing';
                }

                function cropMouseMove(e) {
                    if (!cropDragging || !cropAreaRect) return;

                    var clientX = e.clientX || (e.touches && e.touches[0].clientX);
                    var x = clientX - cropAreaRect.left;
                    var containerWidth = cropAreaRect.width;

                    // Calculate percentage (0-100)
                    // The crop zone center should follow the mouse
                    var zoneWidthPx = containerWidth * cropZoneWidth;
                    var maxLeftPx = containerWidth - zoneWidthPx;

                    // Calculate where the center of the crop zone should be
                    var centerX = x;
                    var leftPx = centerX - (zoneWidthPx / 2);
                    leftPx = Math.max(0, Math.min(maxLeftPx, leftPx));

                    // Convert to percentage (0-100 scale)
                    var percent = maxLeftPx > 0 ? Math.round((leftPx / maxLeftPx) * 100) : 50;

                    // IMPORTANT: Save to state immediately during dragging (not just on release)
                    // This ensures "Apply to All Clips" always reads the current value
                    var selectedClips = state.clips.filter(function(c) {
                        return state.selectedClipIds.indexOf(c.id) !== -1;
                    });
                    var activeClip = selectedClips[state.customization.activeClipIndex];
                    if (activeClip) {
                        if (!state.clipSettings[activeClip.id]) {
                            state.clipSettings[activeClip.id] = getDefaultSettings();
                        }
                        state.clipSettings[activeClip.id].cropPosition = percent;
                        state.clipSettings[activeClip.id].aiSmartCrop = false;
                    }

                    // Update crop zone position visually (must match CSS width)
                    var cropZoneLeftPercent = (percent / 100) * (100 - 31.640625);
                    cropGuideZone.style.left = cropZoneLeftPercent + '%';
                    cropGuideZone.dataset.position = percent;

                    // Update slider
                    if (cropSlider) {
                        cropSlider.value = percent;
                    }

                    // Update value display
                    var valueDisplay = document.querySelector('.crop-slider-value');
                    if (valueDisplay) {
                        valueDisplay.textContent = percent + '%';
                    }

                    // Update quick button states
                    document.querySelectorAll('.crop-quick-btn').forEach(function(btn, i) {
                        var btnVal = [0, 50, 100][i];
                        btn.classList.toggle('active', percent === btnVal);
                    });
                }

                function cropMouseUp() {
                    if (cropDragging) {
                        cropDragging = false;
                        cropGuideZone.classList.remove('dragging');
                        document.body.style.cursor = '';

                        // State was already saved during dragging (cropMouseMove)
                        // Just trigger a render to sync UI
                        // Read from state (more reliable than DOM attribute)
                        var selectedClips = state.clips.filter(function(c) {
                            return state.selectedClipIds.indexOf(c.id) !== -1;
                        });
                        var activeClip = selectedClips[state.customization.activeClipIndex];
                        if (activeClip && state.clipSettings[activeClip.id]) {
                            var statePosition = state.clipSettings[activeClip.id].cropPosition;
                            if (typeof statePosition === 'number') {
                                app.setCropPosition(statePosition);
                                return;
                            }
                        }
                        // Fallback: read from DOM, then slider, then default
                        var finalPercent = parseInt(cropGuideZone.dataset.position, 10);
                        if (isNaN(finalPercent)) {
                            finalPercent = parseInt(cropSlider?.value || '50', 10);
                        }
                        if (isNaN(finalPercent)) finalPercent = 50;
                        app.setCropPosition(finalPercent);
                    }
                }

                // Create touch move handler
                function cropTouchMove(e) {
                    if (cropDragging) {
                        cropMouseMove(e);
                    }
                }

                cropGuideZone.addEventListener('mousedown', cropMouseDown);

                // Store and add document listeners (to enable cleanup on next render)
                documentEventListeners.cropMouseMove = cropMouseMove;
                documentEventListeners.cropMouseUp = cropMouseUp;
                documentEventListeners.cropTouchMove = cropTouchMove;
                documentEventListeners.cropTouchEnd = cropMouseUp;

                document.addEventListener('mousemove', cropMouseMove);
                document.addEventListener('mouseup', cropMouseUp);

                // Touch support for mobile
                cropGuideZone.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    cropMouseDown(e);
                });
                document.addEventListener('touchmove', cropTouchMove);
                document.addEventListener('touchend', cropMouseUp);
            }
        }

        /**
         * Apply audio mute state to all preview video elements
         * Called after render to ensure mute state matches audioMix settings
         */
        function applyPreviewAudioMute() {
            // Get current clip settings
            var selectedClips = state.clips.filter(function(c) {
                return state.selectedClipIds.indexOf(c.id) !== -1;
            });
            if (!selectedClips.length) return;

            var activeClip = selectedClips[state.customization.activeClipIndex];
            if (!activeClip) return;

            var settings = state.clipSettings[activeClip.id] || {};
            var audioMix = settings.audioMix || { primaryMuted: false, secondaryMuted: true };

            // Find all video elements and apply mute state
            var videos = document.querySelectorAll('.phone-video-area video');
            videos.forEach(function(video) {
                var track = video.getAttribute('data-track');
                if (track === 'primary') {
                    video.muted = audioMix.primaryMuted;
                    video.volume = audioMix.primaryMuted ? 0 : (audioMix.primaryVolume || 100) / 100;
                } else if (track === 'secondary') {
                    video.muted = audioMix.secondaryMuted;
                    video.volume = audioMix.secondaryMuted ? 0 : (audioMix.secondaryVolume || 0) / 100;
                }
            });

            // For iframes, we can only control via URL param (handled in render)
            // But log for debugging
            var iframes = document.querySelectorAll('.phone-video-area iframe');
            iframes.forEach(function(iframe) {
                var track = iframe.getAttribute('data-track');
                console.log('Preview iframe track:', track, 'mute state applied via URL');
            });
        }

        /* ==========================================
           4.6 APPLICATION METHODS
           ========================================== */

        const app = {
            goToStep: function(step) {
                if (step < 1 || step > 6) return;
                // Validate step transitions
                if (step > state.currentStep + 1) return;
                state.currentStep = step;
                state.customization.playingInFrame = false; // Stop any playing video

                // When entering step 4 (customization), ensure all selected clips have initialized settings
                if (step === 4) {
                    var selectedClips = state.clips.filter(function(c) {
                        return state.selectedClipIds.indexOf(c.id) !== -1;
                    });
                    selectedClips.forEach(function(clip) {
                        if (!state.clipSettings[clip.id]) {
                            state.clipSettings[clip.id] = getDefaultSettings();
                            state.clipSettings[clip.id].trimEnd = clip.duration;
                        }
                    });
                }

                render();
                window.scrollTo(0, 0);
            },

            toggleOption: function(key) {
                state.videoInput.options[key] = !state.videoInput.options[key];
                render();
            },

            // Token Modal Functions
            showTokenModal: function() {
                if (!state.tokenBypassCosts) {
                    this.loadTokenBypassCosts();
                }
                state.showTokenModal = true;
                render();
            },

            hideTokenModal: function() {
                state.showTokenModal = false;
                render();
            },

            loadTokenBypassCosts: function() {
                functions.httpsCallable('getTokenBypassInfo')({ tool: 'all' })
                    .then(function(result) {
                        if (result.data) {
                            state.tokenBypassCosts = result.data.costs || {};
                            render();
                        }
                    })
                    .catch(function(error) {
                        console.error('Failed to load token bypass costs:', error);
                    });
            },

            topUpTokens: function() {
                utils.showToast('Token TopUp coming soon! Contact support for now.', 'info');
            },

            // Select platform/content type preset
            selectPlatform: function(platformId) {
                if (!PLATFORM_PRESETS[platformId]) return;
                state.contentType.selected = platformId;
                state.contentType.preset = PLATFORM_PRESETS[platformId];

                // Save selection to localStorage for persistence
                try {
                    localStorage.setItem('wizard_platform_preset', platformId);
                } catch (e) {
                    console.warn('Could not save platform preference');
                }

                render();
            },

            // Handle video file upload from device
            handleVideoUpload: async function(input) {
                var file = input.files[0];
                if (!file) return;

                // Validate file type
                var validTypes = ['video/mp4', 'video/quicktime', 'video/x-msvideo', 'video/webm', 'video/avi', 'video/mov'];
                if (!file.type.startsWith('video/') && !validTypes.includes(file.type)) {
                    utils.showToast('Please select a valid video file (MP4, MOV, AVI, WebM)', 'error');
                    input.value = '';
                    return;
                }

                // Validate file size (500MB max)
                var maxSize = 500 * 1024 * 1024; // 500MB
                if (file.size > maxSize) {
                    utils.showToast('File too large. Maximum size is 500MB.', 'error');
                    input.value = '';
                    return;
                }

                if (!state.user) {
                    utils.showToast('Please sign in to upload videos', 'error');
                    input.value = '';
                    return;
                }

                // Start upload
                state.videoInput.uploading = true;
                state.videoInput.uploadProgress = 0;
                state.videoInput.uploadedFile = null;
                render();

                try {
                    // Create a unique filename
                    var timestamp = Date.now();
                    var safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                    var storagePath = 'uploads/' + state.user.uid + '/' + timestamp + '_' + safeName;
                    var storageRef = storage.ref(storagePath);

                    // Upload with progress tracking
                    var uploadTask = storageRef.put(file);

                    uploadTask.on('state_changed',
                        function(snapshot) {
                            var progress = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
                            state.videoInput.uploadProgress = progress;
                            render();
                        },
                        function(error) {
                            console.error('Upload error:', error);
                            state.videoInput.uploading = false;
                            state.videoInput.uploadProgress = 0;
                            utils.showToast('Upload failed: ' + error.message, 'error');
                            render();
                        },
                        async function() {
                            // Upload completed
                            var downloadURL = await uploadTask.snapshot.ref.getDownloadURL();

                            state.videoInput.uploading = false;
                            state.videoInput.uploadProgress = 100;
                            state.videoInput.uploadedFile = {
                                name: file.name,
                                size: file.size,
                                type: file.type,
                                url: downloadURL,
                                storagePath: storagePath
                            };
                            state.videoInput.url = ''; // Clear YouTube URL if any

                            utils.showToast('Video uploaded successfully!', 'success');
                            render();
                        }
                    );
                } catch (error) {
                    console.error('Upload error:', error);
                    state.videoInput.uploading = false;
                    state.videoInput.uploadProgress = 0;
                    utils.showToast('Upload failed: ' + error.message, 'error');
                    render();
                }

                // Clear input for potential re-upload
                input.value = '';
            },

            // Remove uploaded file
            removeUploadedFile: async function() {
                if (!state.videoInput.uploadedFile) return;

                try {
                    // Delete from storage
                    var storageRef = storage.ref(state.videoInput.uploadedFile.storagePath);
                    await storageRef.delete();
                } catch (error) {
                    console.warn('Could not delete file from storage:', error);
                }

                state.videoInput.uploadedFile = null;
                state.videoInput.uploading = false;
                state.videoInput.uploadProgress = 0;
                render();
                utils.showToast('File removed', 'info');
            },

            analyzeVideo: async function() {
                var url = state.videoInput.url.trim();
                var uploadedFile = state.videoInput.uploadedFile;

                // Check if we have either a URL or an uploaded file
                if (!url && !uploadedFile) {
                    utils.showToast('Please enter a video URL or upload a video file', 'error');
                    return;
                }

                if (!state.user) {
                    utils.showToast('Please sign in to analyze videos', 'error');
                    return;
                }

                // Check if user has enough tokens
                var analysisCost = state.tokens.costs.analyzeVideo || 5;
                if (state.tokens.balance < analysisCost) {
                    utils.showModal(
                        'Insufficient Tokens',
                        '<div style="text-align: center; padding: 20px;">' +
                            '<div style="font-size: 48px; margin-bottom: 16px;">🎬</div>' +
                            '<p style="margin-bottom: 16px;">You need <strong>' + analysisCost + ' tokens</strong> to analyze a video.</p>' +
                            '<p style="margin-bottom: 16px;">Current balance: <strong>' + state.tokens.balance + ' tokens</strong></p>' +
                            '<p style="color: #9ca3af; font-size: 14px;">Upgrade your plan or wait for your monthly token refresh to continue.</p>' +
                        '</div>'
                    );
                    return;
                }

                // Reset analysis state
                state.currentStep = 2;
                state.analysis.status = 'processing';
                state.analysis.progress = 0;
                state.analysis.error = null;
                state.analysis.steps.forEach(function(step) {
                    step.status = 'pending';
                });
                render();

                // Call Cloud Function with progress simulation
                try {
                    // If extension is installed and we have a YouTube URL, request video info
                    // NOTE: During analysis, we only need video metadata - NOT full stream capture
                    // Stream capture is done later during export (startVideoProcessing)
                    // This prevents opening unnecessary browser tabs during analysis
                    var extensionData = null;
                    if (state.extension.installed && url && !uploadedFile) {
                        try {
                            console.log('[Video Wizard] Requesting video info from extension (analysis mode)...');
                            utils.showToast('Getting video info...', 'info');

                            // Extract video ID from URL
                            var videoId = null;
                            try {
                                var urlObj = new URL(url);
                                if (urlObj.hostname.includes('youtube.com')) {
                                    videoId = urlObj.searchParams.get('v');
                                    if (!videoId && urlObj.pathname.startsWith('/shorts/')) {
                                        videoId = urlObj.pathname.split('/shorts/')[1];
                                    }
                                } else if (urlObj.hostname === 'youtu.be') {
                                    videoId = urlObj.pathname.slice(1).split('/')[0];
                                }
                            } catch (e) {
                                console.warn('[Video Wizard] Could not parse URL:', e);
                            }

                            if (videoId) {
                                // CRITICAL FIX: autoCapture: false prevents opening new browser tabs
                                // We only need cached streams or basic video info for analysis
                                // Full capture happens during export (startVideoProcessing)
                                var captureResult = await sendExtensionRequest('getVideoFromYouTube', {
                                    youtubeUrl: url,
                                    videoId: videoId,
                                    autoCapture: false  // DISABLED - don't open new tabs during analysis
                                });

                                if (captureResult && captureResult.success) {
                                    extensionData = {
                                        videoInfo: captureResult.videoInfo,
                                        streamData: captureResult.streamData
                                    };
                                    var captureSource = captureResult.captureSource || 'cached';
                                    console.log('[Video Wizard] Extension returned video info (source: ' + captureSource + '):', extensionData);

                                    if (extensionData.streamData && extensionData.streamData.uploadedToStorage) {
                                        utils.showToast('Video streams ready!', 'success');
                                    } else if (extensionData.videoInfo) {
                                        utils.showToast('Video info retrieved', 'success');
                                    }
                                } else {
                                    console.warn('[Video Wizard] Extension info request failed:', captureResult?.error);
                                    // This is OK - backend will fetch from YouTube API
                                }
                            }
                        } catch (extError) {
                            console.warn('[Video Wizard] Extension request error (will try server):', extError);
                            // This is OK - backend will fetch from YouTube API
                        }
                    }

                    // Simulate progress steps during API call
                    var progressInterval = setInterval(function() {
                        var pendingSteps = state.analysis.steps.filter(function(s) { return s.status === 'pending'; });
                        if (pendingSteps.length > 0 && state.analysis.status === 'processing') {
                            var currentIdx = state.analysis.steps.length - pendingSteps.length;
                            if (currentIdx < state.analysis.steps.length) {
                                state.analysis.steps[currentIdx].status = 'processing';
                                state.analysis.progress = Math.round((currentIdx / state.analysis.steps.length) * 80);
                                render();
                                setTimeout(function() {
                                    if (state.analysis.status === 'processing') {
                                        state.analysis.steps[currentIdx].status = 'done';
                                        render();
                                    }
                                }, 2000);
                            }
                        }
                    }, 3000);

                    var wizardAnalyzeVideo = functions.httpsCallable('wizardAnalyzeVideo');

                    // Prepare request data based on input type
                    var requestData = {
                        options: state.videoInput.options,
                        contentType: state.contentType.selected,
                        platformPreset: state.contentType.preset
                    };

                    if (uploadedFile) {
                        // Use uploaded file
                        requestData.uploadedVideoUrl = uploadedFile.url;
                        requestData.uploadedVideoPath = uploadedFile.storagePath;
                        requestData.uploadedVideoName = uploadedFile.name;
                    } else {
                        // Use YouTube URL
                        requestData.videoUrl = url;

                        // Include extension-captured data ONLY if it has useful info
                        // Don't pass sparse data that would cause backend to skip YouTube API
                        var hasUsefulExtensionData = extensionData &&
                            extensionData.videoInfo &&
                            extensionData.videoInfo.title &&
                            extensionData.videoInfo.duration;

                        if (hasUsefulExtensionData) {
                            console.log('[Video Wizard] Passing useful extension data to backend:', {
                                title: extensionData.videoInfo.title,
                                duration: extensionData.videoInfo.duration,
                                hasStreamData: !!extensionData.streamData
                            });
                            requestData.extensionData = extensionData;
                            requestData.useExtension = true;
                        } else {
                            console.log('[Video Wizard] Extension data is sparse, backend will use YouTube API');
                            // Don't pass extensionData - let backend fetch from YouTube API
                        }
                    }

                    var result = await wizardAnalyzeVideo(requestData);

                    clearInterval(progressInterval);

                    if (result.data.success) {
                        // Mark all steps as done
                        state.analysis.steps.forEach(function(step) {
                            step.status = 'done';
                        });
                        state.analysis.progress = 100;
                        state.analysis.status = 'done';

                        // Store project and video data
                        state.projectId = result.data.projectId;
                        // Backend returns videoData, not videoInfo
                        state.videoInput.videoData = result.data.videoData || result.data.videoInfo;
                        state.clips = result.data.clips || [];

                        // Store isUpload flag for uploaded videos
                        state.videoInput.isUpload = result.data.isUpload || false;

                        // For uploaded videos, sourceAsset is created from the uploaded file
                        if (result.data.sourceAsset) {
                            state.sourceAsset = result.data.sourceAsset;
                            console.log('[Video Wizard] sourceAsset received from backend:', state.sourceAsset.source);
                        }

                        // Log analysis results for debugging
                        console.log('[Video Wizard] Analysis complete:', {
                            projectId: state.projectId,
                            clipCount: state.clips.length,
                            videoTitle: state.videoInput.videoData?.title,
                            hasVideoData: !!state.videoInput.videoData
                        });

                        // Refresh token balance after successful analysis (tokens were deducted on backend)
                        app.refreshTokenBalance();

                        // Warn if no clips were found
                        if (state.clips.length === 0) {
                            console.warn('[Video Wizard] WARNING: No clips returned from analysis');
                            utils.showToast('Analysis complete but no viral clips found. Try a different video.', 'warning');
                        }

                        // Set initial display count based on video duration
                        // Short videos (< 10 min): show all clips
                        // Longer videos: show max 8 initially, with option to unlock more
                        var videoDuration = state.videoInput.videoData?.duration || 0;
                        if (videoDuration < 600) { // < 10 minutes
                            state.displayedClipCount = state.clips.length;
                        } else {
                            state.displayedClipCount = Math.min(8, state.clips.length);
                        }

                        // Auto-select top 5 clips (from displayed clips only)
                        var displayedClips = state.clips.slice(0, state.displayedClipCount);
                        state.selectedClipIds = displayedClips.slice(0, 5).map(function(c) { return c.id; });

                        render();

                        // NOTE: Source asset capture was removed to eliminate duplicate capture process
                        // Video capture now happens only at export time, which:
                        // 1. Reduces unnecessary capture operations
                        // 2. Eliminates "message channel closed before response" errors
                        // 3. Improves user experience by removing the failed first capture

                        // Transition to clip selection after a moment
                        setTimeout(function() {
                            state.currentStep = 3;
                            render();
                        }, 1000);
                    } else {
                        throw new Error(result.data.error || 'Analysis failed');
                    }
                } catch (error) {
                    console.error('Analysis error:', error);
                    state.analysis.status = 'error';
                    state.analysis.error = error.message || 'Failed to analyze video';
                    utils.showToast('Error: ' + (error.message || 'Analysis failed'), 'error');
                    render();
                }
            },

            selectAllClips: function() {
                // Only select displayed clips, not all clips
                var displayedClips = state.clips.slice(0, state.displayedClipCount);
                state.selectedClipIds = displayedClips.map(function(c) { return c.id; });
                render();
            },

            deselectAllClips: function() {
                state.selectedClipIds = [];
                render();
            },

            createMoreClips: async function() {
                var createMoreCost = state.tokens.costs.showMoreClips || 3;
                var remainingClips = state.clips.length - state.displayedClipCount;

                if (remainingClips <= 0) {
                    utils.showToast('No more clips to show', 'info');
                    return;
                }

                if (state.tokens.balance < createMoreCost) {
                    utils.showModal(
                        'Insufficient Tokens',
                        '<div style="text-align: center; padding: 20px;">' +
                            '<div style="font-size: 48px; margin-bottom: 16px;">🎬</div>' +
                            '<p style="margin-bottom: 16px;">You need <strong>' + createMoreCost + ' tokens</strong> to unlock more clips.</p>' +
                            '<p style="margin-bottom: 16px;">Current balance: <strong>' + state.tokens.balance + ' tokens</strong></p>' +
                        '</div>'
                    );
                    return;
                }

                try {
                    // Deduct tokens via backend
                    var wizardDeductTokens = firebase.functions().httpsCallable('wizardDeductTokens');
                    await wizardDeductTokens({
                        amount: createMoreCost,
                        operation: 'showMoreClips',
                        metadata: { projectId: state.projectId }
                    });

                    // Show next batch of clips (8-10 more)
                    var nextBatch = Math.min(10, remainingClips);
                    state.displayedClipCount += nextBatch;

                    utils.showToast('Unlocked ' + nextBatch + ' more clips! (-' + createMoreCost + ' tokens)', 'success');

                    // Refresh token balance
                    app.refreshTokenBalance();
                    render();
                } catch (error) {
                    console.error('Error deducting tokens:', error);
                    utils.showToast('Failed to unlock clips: ' + (error.message || 'Unknown error'), 'error');
                }
            },

            toggleClipSelection: function(clipId) {
                var index = state.selectedClipIds.indexOf(clipId);
                if (index === -1) {
                    state.selectedClipIds.push(clipId);
                } else {
                    state.selectedClipIds.splice(index, 1);
                }
                render();
            },

            // Video Preview Functions
            previewClip: function(clipId) {
                var clip = state.clips.find(function(c) { return c.id === clipId; });
                if (!clip) {
                    utils.showToast('Clip not found', 'error');
                    return;
                }

                var videoId = state.videoInput.videoData ? state.videoInput.videoData.videoId : null;
                if (!videoId) {
                    // Try to extract from clip thumbnail URL
                    var match = clip.thumbnail.match(/\/vi\/([^\/]+)\//);
                    if (match) {
                        videoId = match[1];
                    }
                }

                if (!videoId) {
                    utils.showToast('Video ID not found', 'error');
                    return;
                }

                var isSelected = state.selectedClipIds.indexOf(clipId) !== -1;
                var startTime = Math.floor(clip.startTime || 0);
                var endTime = Math.floor(clip.endTime || (startTime + clip.duration));

                // Build YouTube embed URL with start and end times
                var embedUrl = 'https://www.youtube.com/embed/' + videoId +
                    '?start=' + startTime +
                    '&end=' + endTime +
                    '&autoplay=1&rel=0&modestbranding=1';

                var modalHtml = '<div class="video-preview-modal" onclick="app.closeVideoPreview(event)">';
                modalHtml += '<div class="video-preview-content" onclick="event.stopPropagation()">';

                // Header
                modalHtml += '<div class="video-preview-header">';
                modalHtml += '<h3>Preview Clip - ' + utils.formatDuration(clip.duration) + '</h3>';
                modalHtml += '<button class="video-preview-close" onclick="app.closeVideoPreview()">×</button>';
                modalHtml += '</div>';

                // Player
                modalHtml += '<div class="video-preview-player">';
                modalHtml += '<iframe src="' + embedUrl + '" allow="autoplay; encrypted-media" allowfullscreen></iframe>';
                modalHtml += '</div>';

                // Info
                modalHtml += '<div class="video-preview-info">';
                modalHtml += '<div class="video-preview-meta">';
                modalHtml += '<div class="video-preview-meta-item"><span>⏱️</span> ' + utils.formatDuration(startTime) + ' - ' + utils.formatDuration(endTime) + '</div>';
                modalHtml += '<div class="video-preview-meta-item"><span>🔥</span> Virality: ' + clip.score + '%</div>';
                modalHtml += '<div class="video-preview-meta-item"><span>📱</span> ' + clip.platforms.map(utils.getPlatformName).join(', ') + '</div>';
                modalHtml += '</div>';
                modalHtml += '<div class="video-preview-transcript">"' + utils.escapeHtml(clip.transcript) + '"</div>';
                modalHtml += '</div>';

                // Actions
                modalHtml += '<div class="video-preview-actions">';
                modalHtml += '<button class="btn-secondary" onclick="app.closeVideoPreview()">Close</button>';
                if (isSelected) {
                    modalHtml += '<button class="btn-select selected" onclick="app.toggleClipFromPreview(\'' + clipId + '\')">✓ Selected</button>';
                } else {
                    modalHtml += '<button class="btn-select" onclick="app.toggleClipFromPreview(\'' + clipId + '\')">+ Select Clip</button>';
                }
                modalHtml += '</div>';

                modalHtml += '</div>'; // content
                modalHtml += '</div>'; // modal

                // Append modal to body
                var modalContainer = document.createElement('div');
                modalContainer.id = 'video-preview-container';
                modalContainer.innerHTML = modalHtml;
                document.body.appendChild(modalContainer);
            },

            closeVideoPreview: function(event) {
                if (event && event.target !== event.currentTarget) return;
                var container = document.getElementById('video-preview-container');
                if (container) {
                    container.remove();
                }
            },

            toggleClipFromPreview: function(clipId) {
                var index = state.selectedClipIds.indexOf(clipId);
                if (index === -1) {
                    state.selectedClipIds.push(clipId);
                } else {
                    state.selectedClipIds.splice(index, 1);
                }
                // Re-render the preview modal with updated button
                app.closeVideoPreview();
                app.previewClip(clipId);
                render();
            },

            prevClip: function() {
                if (state.customization.activeClipIndex > 0) {
                    state.customization.activeClipIndex--;
                    state.customization.playingInFrame = false; // Stop video when changing clips
                    render();
                }
            },

            nextClip: function() {
                var selectedCount = state.selectedClipIds.length;
                if (state.customization.activeClipIndex < selectedCount - 1) {
                    state.customization.activeClipIndex++;
                    state.customization.showVideoPreview = false; // Reset preview when changing clips
                    state.customization.playingInFrame = false; // Stop video when changing clips
                    render();
                }
            },

            toggleVideoPreview: function() {
                state.customization.showVideoPreview = !state.customization.showVideoPreview;
                render();
            },

            // Open YouTube video preview in a modal at specific timestamp
            openYouTubePreview: function(videoId, startTime) {
                var modalHtml = '<div class="youtube-preview-modal" onclick="app.closeYouTubePreview(event)">';
                modalHtml += '<div class="youtube-preview-content" onclick="event.stopPropagation()">';
                modalHtml += '<button class="youtube-preview-close" onclick="app.closeYouTubePreview()">×</button>';
                modalHtml += '<div class="youtube-preview-header">';
                modalHtml += '<span>🎬 Video Preview</span>';
                modalHtml += '<span class="youtube-preview-note">This shows the original 16:9 video. The final export will be cropped to 9:16.</span>';
                modalHtml += '</div>';
                modalHtml += '<div class="youtube-preview-video">';
                modalHtml += '<iframe src="https://www.youtube.com/embed/' + videoId + '?start=' + Math.floor(startTime) + '&autoplay=1&modestbranding=1&rel=0" ';
                modalHtml += 'frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>';
                modalHtml += '</div>';
                modalHtml += '<div class="youtube-preview-footer">';
                modalHtml += '<p>💡 The phone preview shows how your video will look after 9:16 crop</p>';
                modalHtml += '</div>';
                modalHtml += '</div>';
                modalHtml += '</div>';

                document.body.insertAdjacentHTML('beforeend', modalHtml);
            },

            closeYouTubePreview: function(event) {
                var modal = document.querySelector('.youtube-preview-modal');
                if (modal) {
                    modal.remove();
                }
            },

            // Play YouTube video directly inside phone frame with 9:16 crop
            playInFrameVideo: function() {
                state.customization.playingInFrame = true;
                render();
            },

            // Stop in-frame video playback
            stopInFrameVideo: function() {
                state.customization.playingInFrame = false;
                render();
            },

            // Toggle source video view with crop guides
            toggleSourcePreview: function() {
                state.customization.showSourcePreview = !state.customization.showSourcePreview;
                render();
            },

            setCaptionStyle: function(style) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                state.clipSettings[activeClip.id].captionStyle = style;
                render();
            },

            setCaptionSource: function(source) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                state.clipSettings[activeClip.id].captionSource = source;
                utils.showToast('Captions will be generated from ' + (source === 'primary' ? 'Top' : 'Bottom') + ' video audio', 'info');
                render();
            },

            setCustomCaptionStyle: function(property, value) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                if (!state.clipSettings[activeClip.id].customCaptionStyle) {
                    state.clipSettings[activeClip.id].customCaptionStyle = {};
                }
                state.clipSettings[activeClip.id].customCaptionStyle[property] = value;
                render();
            },

            setReframeMode: function(mode) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                state.clipSettings[activeClip.id].reframeMode = mode;
                render();
            },

            // Split screen preset and position functions
            setSplitPreset: function(preset) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                if (!state.clipSettings[activeClip.id].splitScreenSettings) {
                    state.clipSettings[activeClip.id].splitScreenSettings = {
                        speaker1: { cropPosition: 50, cropWidth: 33, zoom: 100 },
                        speaker2: { cropPosition: 50, cropWidth: 33, zoom: 100 },
                        preset: 'center',
                        layoutRatio: '50-50',
                        border: { enabled: false, thickness: 2, color: '#ffffff' }
                    };
                }

                // Preserve existing settings (zoom, layoutRatio, border) when changing presets
                var currentSettings = state.clipSettings[activeClip.id].splitScreenSettings;
                var existingZoom1 = currentSettings.speaker1?.zoom || 100;
                var existingZoom2 = currentSettings.speaker2?.zoom || 100;
                var existingLayoutRatio = currentSettings.layoutRatio || '50-50';
                var existingBorder = currentSettings.border || { enabled: false, thickness: 2, color: '#ffffff' };

                switch(preset) {
                    case 'interview':
                        currentSettings.speaker1 = { cropPosition: 17, cropWidth: 33, zoom: existingZoom1 };
                        currentSettings.speaker2 = { cropPosition: 83, cropWidth: 33, zoom: existingZoom2 };
                        currentSettings.preset = 'interview';
                        break;
                    case 'center':
                        currentSettings.speaker1 = { cropPosition: 50, cropWidth: 33, zoom: existingZoom1 };
                        currentSettings.speaker2 = { cropPosition: 50, cropWidth: 33, zoom: existingZoom2 };
                        currentSettings.preset = 'center';
                        break;
                    case 'custom':
                        // Keep current positions but switch to custom mode
                        currentSettings.preset = 'custom';
                        break;
                    default:
                        currentSettings.speaker1 = { cropPosition: 50, cropWidth: 33, zoom: existingZoom1 };
                        currentSettings.speaker2 = { cropPosition: 50, cropWidth: 33, zoom: existingZoom2 };
                        currentSettings.preset = 'custom';
                }
                // Ensure layoutRatio and border are preserved
                currentSettings.layoutRatio = existingLayoutRatio;
                currentSettings.border = existingBorder;
                render();
            },

            setSpeakerPosition: function(speaker, position) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                if (!state.clipSettings[activeClip.id].splitScreenSettings) {
                    state.clipSettings[activeClip.id].splitScreenSettings = {
                        speaker1: { cropPosition: 50, cropWidth: 33, zoom: 100 },
                        speaker2: { cropPosition: 50, cropWidth: 33, zoom: 100 },
                        preset: 'center',
                        layoutRatio: '50-50',
                        border: { enabled: false, thickness: 2, color: '#ffffff' }
                    };
                }

                var posNum = parseInt(position, 10);
                if (isNaN(posNum)) posNum = 50;
                posNum = Math.max(0, Math.min(100, posNum));

                var speakerKey = 'speaker' + speaker;
                if (!state.clipSettings[activeClip.id].splitScreenSettings[speakerKey]) {
                    state.clipSettings[activeClip.id].splitScreenSettings[speakerKey] = { cropPosition: 50, cropWidth: 33, zoom: 100 };
                }
                state.clipSettings[activeClip.id].splitScreenSettings[speakerKey].cropPosition = posNum;
                state.clipSettings[activeClip.id].splitScreenSettings.preset = 'custom';
                render();
            },

            onSpeakerPositionChange: function(speaker, position) {
                // Real-time update of the UI without full render (for smooth slider interaction)
                var posNum = parseInt(position, 10);
                if (isNaN(posNum)) posNum = 50;
                posNum = Math.max(0, Math.min(100, posNum));

                // IMPORTANT: Save to state immediately during dragging (like onCropSliderChange)
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                var layoutRatio = '50-50';

                if (activeClip) {
                    if (!state.clipSettings[activeClip.id]) {
                        state.clipSettings[activeClip.id] = getDefaultSettings();
                    }
                    if (!state.clipSettings[activeClip.id].splitScreenSettings) {
                        state.clipSettings[activeClip.id].splitScreenSettings = {
                            speaker1: { cropPosition: 50, cropWidth: 33, zoom: 100 },
                            speaker2: { cropPosition: 50, cropWidth: 33, zoom: 100 },
                            preset: 'center',
                            layoutRatio: '50-50',
                            border: { enabled: false, thickness: 2, color: '#ffffff' }
                        };
                    }
                    var speakerKey = 'speaker' + speaker;
                    if (!state.clipSettings[activeClip.id].splitScreenSettings[speakerKey]) {
                        state.clipSettings[activeClip.id].splitScreenSettings[speakerKey] = { cropPosition: 50, cropWidth: 33, zoom: 100 };
                    }
                    state.clipSettings[activeClip.id].splitScreenSettings[speakerKey].cropPosition = posNum;
                    state.clipSettings[activeClip.id].splitScreenSettings.preset = 'custom';
                    layoutRatio = state.clipSettings[activeClip.id].splitScreenSettings.layoutRatio || '50-50';
                }

                // Update value display
                var sliderRows = document.querySelectorAll('.speaker-position-row');
                if (sliderRows[speaker - 1]) {
                    var valueDisplay = sliderRows[speaker - 1].querySelector('.speaker-position-value');
                    if (valueDisplay) {
                        valueDisplay.textContent = posNum + '%';
                    }
                }

                // Update preview in real-time
                var phoneVideoArea = document.querySelector('.phone-video-area');
                if (phoneVideoArea) {
                    // Calculate scale and translate
                    var translateValue = this.calculateSpeakerTranslate(speaker, posNum, layoutRatio);
                    phoneVideoArea.style.setProperty('--speaker' + speaker + '-translate-pct', translateValue);
                }
            },

            calculateSpeakerTranslate: function(speaker, position, layoutRatio) {
                // Calculate CSS translate value to match FFmpeg crop (aspect ratio based)
                // Same formula as in preview rendering: offset = (50 - position) * (scale - 1)
                var inputAspect = 16 / 9;  // 1.778
                var outputAspect = 9 / 16; // 0.5625

                var heightFraction = 0.5;
                if (layoutRatio === '60-40') {
                    heightFraction = (speaker === 1) ? 0.6 : 0.4;
                } else if (layoutRatio === '70-30') {
                    heightFraction = (speaker === 1) ? 0.7 : 0.3;
                }

                var halfAspect = outputAspect / heightFraction;
                var scale = inputAspect / halfAspect;

                // offset = (50 - position) * (scale - 1)
                return (50 - position) * (scale - 1);
            },

            // Phase 2: Swap top and bottom positions
            swapSplitPositions: function() {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                var splitSettings = state.clipSettings[activeClip.id].splitScreenSettings;
                if (!splitSettings) {
                    splitSettings = {
                        speaker1: { cropPosition: 50, cropWidth: 33, zoom: 100 },
                        speaker2: { cropPosition: 50, cropWidth: 33, zoom: 100 },
                        preset: 'center',
                        layoutRatio: '50-50',
                        border: { enabled: false, thickness: 2, color: '#ffffff' }
                    };
                    state.clipSettings[activeClip.id].splitScreenSettings = splitSettings;
                }
                // Swap speaker1 and speaker2 positions (includes cropPosition, cropWidth, zoom)
                var temp = Object.assign({}, splitSettings.speaker1);
                splitSettings.speaker1 = Object.assign({}, splitSettings.speaker2);
                splitSettings.speaker2 = temp;
                splitSettings.preset = 'custom';
                render();
            },

            // Phase 2: Set layout ratio (50-50, 60-40, 70-30)
            setLayoutRatio: function(ratio) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                if (!state.clipSettings[activeClip.id].splitScreenSettings) {
                    state.clipSettings[activeClip.id].splitScreenSettings = {
                        speaker1: { cropPosition: 50, cropWidth: 33, zoom: 100 },
                        speaker2: { cropPosition: 50, cropWidth: 33, zoom: 100 },
                        preset: 'center',
                        layoutRatio: '50-50',
                        border: { enabled: false, thickness: 2, color: '#ffffff' }
                    };
                }
                state.clipSettings[activeClip.id].splitScreenSettings.layoutRatio = ratio;
                render();
            },

            // Phase 2: Toggle split screen border/divider
            toggleSplitBorder: function(enabled) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                if (!state.clipSettings[activeClip.id].splitScreenSettings) {
                    state.clipSettings[activeClip.id].splitScreenSettings = {
                        speaker1: { cropPosition: 50, cropWidth: 33, zoom: 100 },
                        speaker2: { cropPosition: 50, cropWidth: 33, zoom: 100 },
                        preset: 'center',
                        layoutRatio: '50-50',
                        border: { enabled: false, thickness: 2, color: '#ffffff' }
                    };
                }
                if (!state.clipSettings[activeClip.id].splitScreenSettings.border) {
                    state.clipSettings[activeClip.id].splitScreenSettings.border = { enabled: false, thickness: 2, color: '#ffffff' };
                }
                state.clipSettings[activeClip.id].splitScreenSettings.border.enabled = enabled;
                render();
            },

            // Phase 2: Set border thickness
            setBorderThickness: function(thickness) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id] || !state.clipSettings[activeClip.id].splitScreenSettings) {
                    return;
                }
                var thicknessNum = parseInt(thickness, 10);
                if (isNaN(thicknessNum)) thicknessNum = 2;
                thicknessNum = Math.max(1, Math.min(10, thicknessNum));
                if (!state.clipSettings[activeClip.id].splitScreenSettings.border) {
                    state.clipSettings[activeClip.id].splitScreenSettings.border = { enabled: true, thickness: 2, color: '#ffffff' };
                }
                state.clipSettings[activeClip.id].splitScreenSettings.border.thickness = thicknessNum;
                // No full render needed for smooth slider interaction
            },

            // Phase 2: Set border color
            setBorderColor: function(color) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id] || !state.clipSettings[activeClip.id].splitScreenSettings) {
                    return;
                }
                if (!state.clipSettings[activeClip.id].splitScreenSettings.border) {
                    state.clipSettings[activeClip.id].splitScreenSettings.border = { enabled: true, thickness: 2, color: '#ffffff' };
                }
                state.clipSettings[activeClip.id].splitScreenSettings.border.color = color;
                // No full render needed
            },

            // Phase 3: Set zoom level for a clip (1 = top, 2 = bottom)
            setClipZoom: function(speaker, zoom) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                if (!state.clipSettings[activeClip.id].splitScreenSettings) {
                    state.clipSettings[activeClip.id].splitScreenSettings = {
                        speaker1: { cropPosition: 50, cropWidth: 33, zoom: 100 },
                        speaker2: { cropPosition: 50, cropWidth: 33, zoom: 100 },
                        preset: 'center',
                        layoutRatio: '50-50',
                        border: { enabled: false, thickness: 2, color: '#ffffff' }
                    };
                }
                var zoomNum = parseInt(zoom, 10);
                if (isNaN(zoomNum)) zoomNum = 100;
                zoomNum = Math.max(100, Math.min(200, zoomNum));

                var speakerKey = 'speaker' + speaker;
                if (!state.clipSettings[activeClip.id].splitScreenSettings[speakerKey]) {
                    state.clipSettings[activeClip.id].splitScreenSettings[speakerKey] = { cropPosition: 50, cropWidth: 33, zoom: 100 };
                }
                state.clipSettings[activeClip.id].splitScreenSettings[speakerKey].zoom = zoomNum;
                state.clipSettings[activeClip.id].splitScreenSettings.preset = 'custom';
                render();
            },

            // Phase 3: Real-time zoom change (updates UI without full render)
            onZoomChange: function(speaker, zoom) {
                var zoomNum = parseInt(zoom, 10);
                if (isNaN(zoomNum)) zoomNum = 100;
                zoomNum = Math.max(100, Math.min(200, zoomNum));

                // IMPORTANT: Save to state immediately during dragging (like onCropSliderChange)
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];

                if (activeClip) {
                    if (!state.clipSettings[activeClip.id]) {
                        state.clipSettings[activeClip.id] = getDefaultSettings();
                    }
                    if (!state.clipSettings[activeClip.id].splitScreenSettings) {
                        state.clipSettings[activeClip.id].splitScreenSettings = {
                            speaker1: { cropPosition: 50, cropWidth: 33, zoom: 100 },
                            speaker2: { cropPosition: 50, cropWidth: 33, zoom: 100 },
                            preset: 'center',
                            layoutRatio: '50-50',
                            border: { enabled: false, thickness: 2, color: '#ffffff' }
                        };
                    }
                    var speakerKey = 'speaker' + speaker;
                    if (!state.clipSettings[activeClip.id].splitScreenSettings[speakerKey]) {
                        state.clipSettings[activeClip.id].splitScreenSettings[speakerKey] = { cropPosition: 50, cropWidth: 33, zoom: 100 };
                    }
                    state.clipSettings[activeClip.id].splitScreenSettings[speakerKey].zoom = zoomNum;
                }

                // Update zoom value display
                var zoomRows = document.querySelectorAll('.zoom-control-row');
                if (zoomRows[speaker - 1]) {
                    var zoomValue = zoomRows[speaker - 1].querySelector('.zoom-value');
                    if (zoomValue) {
                        zoomValue.textContent = zoomNum + '%';
                    }
                }

                // Update preview in real-time
                var phoneVideoArea = document.querySelector('.phone-video-area');
                if (phoneVideoArea) {
                    phoneVideoArea.style.setProperty('--speaker' + speaker + '-zoom', (zoomNum / 100));
                }
            },

            // ===== SINGLE VIDEO ZOOM HANDLERS =====

            setVideoZoom: function(zoom) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }

                var zoomNum = parseInt(zoom, 10);
                if (isNaN(zoomNum)) zoomNum = 100;
                zoomNum = Math.max(100, Math.min(200, zoomNum));

                state.clipSettings[activeClip.id].zoom = zoomNum;
                render();
            },

            onVideoZoomChange: function(zoom) {
                var zoomNum = parseInt(zoom, 10);
                if (isNaN(zoomNum)) zoomNum = 100;
                zoomNum = Math.max(100, Math.min(200, zoomNum));

                // Save to state immediately during dragging
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];

                if (activeClip) {
                    if (!state.clipSettings[activeClip.id]) {
                        state.clipSettings[activeClip.id] = getDefaultSettings();
                    }
                    state.clipSettings[activeClip.id].zoom = zoomNum;
                }

                // Update zoom value display
                var zoomValue = document.getElementById('single-zoom-value');
                if (zoomValue) {
                    zoomValue.textContent = zoomNum + '%';
                }

                // Update preview in real-time
                var phoneVideoArea = document.querySelector('.phone-video-area');
                if (phoneVideoArea) {
                    phoneVideoArea.style.setProperty('--video-zoom', (zoomNum / 100));
                }
            },

            // ===== THREE PERSON MODE HANDLERS =====

            setThreePersonPreset: function(preset) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                if (!state.clipSettings[activeClip.id].threePersonSettings) {
                    state.clipSettings[activeClip.id].threePersonSettings = {
                        main: { cropPosition: 50, zoom: 100 },
                        left: { cropPosition: 50, zoom: 100 },
                        right: { cropPosition: 50, zoom: 100 },
                        preset: 'center',
                        layoutRatio: '50-50'
                    };
                }

                var currentSettings = state.clipSettings[activeClip.id].threePersonSettings;
                var existingZooms = {
                    main: currentSettings.main?.zoom || 100,
                    left: currentSettings.left?.zoom || 100,
                    right: currentSettings.right?.zoom || 100
                };
                var existingLayoutRatio = currentSettings.layoutRatio || '50-50';

                switch(preset) {
                    case 'center':
                        currentSettings.main = { cropPosition: 50, zoom: existingZooms.main };
                        currentSettings.left = { cropPosition: 50, zoom: existingZooms.left };
                        currentSettings.right = { cropPosition: 50, zoom: existingZooms.right };
                        currentSettings.preset = 'center';
                        break;
                    case 'custom':
                        currentSettings.preset = 'custom';
                        break;
                    default:
                        currentSettings.main = { cropPosition: 50, zoom: existingZooms.main };
                        currentSettings.left = { cropPosition: 50, zoom: existingZooms.left };
                        currentSettings.right = { cropPosition: 50, zoom: existingZooms.right };
                        currentSettings.preset = 'center';
                }
                currentSettings.layoutRatio = existingLayoutRatio;
                render();
            },

            setThreePersonPosition: function(zone, position) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                if (!state.clipSettings[activeClip.id].threePersonSettings) {
                    state.clipSettings[activeClip.id].threePersonSettings = {
                        main: { cropPosition: 50, zoom: 100 },
                        left: { cropPosition: 50, zoom: 100 },
                        right: { cropPosition: 50, zoom: 100 },
                        preset: 'center',
                        layoutRatio: '50-50'
                    };
                }

                var posNum = parseInt(position, 10);
                if (isNaN(posNum)) posNum = 50;
                posNum = Math.max(0, Math.min(100, posNum));

                if (!state.clipSettings[activeClip.id].threePersonSettings[zone]) {
                    state.clipSettings[activeClip.id].threePersonSettings[zone] = { cropPosition: 50, zoom: 100 };
                }
                state.clipSettings[activeClip.id].threePersonSettings[zone].cropPosition = posNum;
                state.clipSettings[activeClip.id].threePersonSettings.preset = 'custom';
                render();
            },

            onThreePersonPositionChange: function(zone, position) {
                var posNum = parseInt(position, 10);
                if (isNaN(posNum)) posNum = 50;
                posNum = Math.max(0, Math.min(100, posNum));

                // IMPORTANT: Save to state immediately during dragging
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];

                if (activeClip) {
                    if (!state.clipSettings[activeClip.id]) {
                        state.clipSettings[activeClip.id] = getDefaultSettings();
                    }
                    if (!state.clipSettings[activeClip.id].threePersonSettings) {
                        state.clipSettings[activeClip.id].threePersonSettings = {
                            main: { cropPosition: 50, zoom: 100 },
                            left: { cropPosition: 50, zoom: 100 },
                            right: { cropPosition: 50, zoom: 100 },
                            preset: 'center',
                            layoutRatio: '50-50'
                        };
                    }
                    if (!state.clipSettings[activeClip.id].threePersonSettings[zone]) {
                        state.clipSettings[activeClip.id].threePersonSettings[zone] = { cropPosition: 50, zoom: 100 };
                    }
                    state.clipSettings[activeClip.id].threePersonSettings[zone].cropPosition = posNum;
                    state.clipSettings[activeClip.id].threePersonSettings.preset = 'custom';
                }

                // Update value display
                var zoneIndex = { 'main': 0, 'left': 1, 'right': 2 }[zone];
                var sliderRows = document.querySelectorAll('.speaker-position-row');
                if (sliderRows[zoneIndex]) {
                    var valueDisplay = sliderRows[zoneIndex].querySelector('.speaker-position-value');
                    if (valueDisplay) {
                        valueDisplay.textContent = posNum + '%';
                    }
                }

                // Update preview in real-time
                var phoneVideoArea = document.querySelector('.phone-video-area');
                if (phoneVideoArea) {
                    var translateValue = this.calculateThreePersonTranslate(zone, posNum);
                    var cssVarName = '--' + zone + '-translate-pct';
                    phoneVideoArea.style.setProperty(cssVarName, translateValue);
                }
            },

            calculateThreePersonTranslate: function(zone, position) {
                // Get current layout ratio from state
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                var layoutRatio = '50-50';
                if (activeClip && state.clipSettings[activeClip.id]?.threePersonSettings?.layoutRatio) {
                    layoutRatio = state.clipSettings[activeClip.id].threePersonSettings.layoutRatio;
                }

                var inputAspect = 16 / 9;
                var outputAspect = 9 / 16;
                var topHeightFraction = 0.5, bottomHeightFraction = 0.5;
                if (layoutRatio === '60-40') {
                    topHeightFraction = 0.6; bottomHeightFraction = 0.4;
                } else if (layoutRatio === '70-30') {
                    topHeightFraction = 0.7; bottomHeightFraction = 0.3;
                }

                var scale;
                if (zone === 'main') {
                    var mainAspect = outputAspect / topHeightFraction;
                    scale = inputAspect / mainAspect;
                } else {
                    var bottomZoneAspect = (outputAspect / 2) / bottomHeightFraction;
                    scale = inputAspect / bottomZoneAspect;
                }

                return (50 - position) * (scale - 1);
            },

            setThreePersonZoom: function(zone, zoom) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                if (!state.clipSettings[activeClip.id].threePersonSettings) {
                    state.clipSettings[activeClip.id].threePersonSettings = {
                        main: { cropPosition: 50, zoom: 100 },
                        left: { cropPosition: 50, zoom: 100 },
                        right: { cropPosition: 50, zoom: 100 },
                        preset: 'center',
                        layoutRatio: '50-50'
                    };
                }

                var zoomNum = parseInt(zoom, 10);
                if (isNaN(zoomNum)) zoomNum = 100;
                zoomNum = Math.max(100, Math.min(200, zoomNum));

                if (!state.clipSettings[activeClip.id].threePersonSettings[zone]) {
                    state.clipSettings[activeClip.id].threePersonSettings[zone] = { cropPosition: 50, zoom: 100 };
                }
                state.clipSettings[activeClip.id].threePersonSettings[zone].zoom = zoomNum;
                render();
            },

            onThreePersonZoomChange: function(zone, zoom) {
                var zoomNum = parseInt(zoom, 10);
                if (isNaN(zoomNum)) zoomNum = 100;
                zoomNum = Math.max(100, Math.min(200, zoomNum));

                // IMPORTANT: Save to state immediately during dragging
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];

                if (activeClip) {
                    if (!state.clipSettings[activeClip.id]) {
                        state.clipSettings[activeClip.id] = getDefaultSettings();
                    }
                    if (!state.clipSettings[activeClip.id].threePersonSettings) {
                        state.clipSettings[activeClip.id].threePersonSettings = {
                            main: { cropPosition: 50, zoom: 100 },
                            left: { cropPosition: 50, zoom: 100 },
                            right: { cropPosition: 50, zoom: 100 },
                            preset: 'center',
                            layoutRatio: '50-50'
                        };
                    }
                    if (!state.clipSettings[activeClip.id].threePersonSettings[zone]) {
                        state.clipSettings[activeClip.id].threePersonSettings[zone] = { cropPosition: 50, zoom: 100 };
                    }
                    state.clipSettings[activeClip.id].threePersonSettings[zone].zoom = zoomNum;
                }

                // Update zoom value display
                var zoneIndex = { 'main': 0, 'left': 1, 'right': 2 }[zone];
                var zoomRows = document.querySelectorAll('.zoom-control-row');
                if (zoomRows[zoneIndex]) {
                    var zoomValue = zoomRows[zoneIndex].querySelector('.zoom-value');
                    if (zoomValue) {
                        zoomValue.textContent = zoomNum + '%';
                    }
                }

                // Update preview in real-time
                var phoneVideoArea = document.querySelector('.phone-video-area');
                if (phoneVideoArea) {
                    var cssVarName = '--' + zone + '-zoom';
                    phoneVideoArea.style.setProperty(cssVarName, (zoomNum / 100));
                }
            },

            setThreePersonLayoutRatio: function(ratio) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                if (!state.clipSettings[activeClip.id].threePersonSettings) {
                    state.clipSettings[activeClip.id].threePersonSettings = {
                        main: { cropPosition: 50, zoom: 100 },
                        left: { cropPosition: 50, zoom: 100 },
                        right: { cropPosition: 50, zoom: 100 },
                        preset: 'center',
                        layoutRatio: '50-50'
                    };
                }
                state.clipSettings[activeClip.id].threePersonSettings.layoutRatio = ratio;
                render();
            },

            toggleAdvancedOptions: function() {
                state.customization.showAdvancedOptions = !state.customization.showAdvancedOptions;
                render();
            },

            setOutputAspect: function(aspect) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                state.clipSettings[activeClip.id].outputAspect = aspect;
                render();
            },

            setCropPosition: function(position) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];

                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                // Convert to number if string
                var posNum = parseInt(position, 10);
                if (isNaN(posNum)) posNum = 50;
                posNum = Math.max(0, Math.min(100, posNum));
                state.clipSettings[activeClip.id].cropPosition = posNum;
                state.clipSettings[activeClip.id].aiSmartCrop = false; // Reset AI flag on manual change

                render();
            },

            // Real-time slider preview (updates UI without full re-render)
            onCropSliderChange: function(value) {
                var posNum = parseInt(value, 10);
                if (isNaN(posNum)) return;
                posNum = Math.max(0, Math.min(100, posNum));

                // IMPORTANT: Save to state immediately during dragging (not just on release)
                // This ensures "Apply to All Clips" always reads the current slider value
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (activeClip) {
                    if (!state.clipSettings[activeClip.id]) {
                        state.clipSettings[activeClip.id] = getDefaultSettings();
                    }
                    state.clipSettings[activeClip.id].cropPosition = posNum;
                    state.clipSettings[activeClip.id].aiSmartCrop = false;
                }

                // Update the crop guide zone position in real-time
                var cropZone = document.getElementById('cropGuideZone');
                var slider = document.getElementById('cropSlider');
                var valueDisplay = document.querySelector('.crop-slider-value');

                if (cropZone) {
                    var cropZoneLeft = (posNum / 100) * (100 - 31.640625); // Match CSS crop zone width
                    cropZone.style.left = cropZoneLeft + '%';
                    cropZone.dataset.position = posNum;
                }
                if (valueDisplay) {
                    valueDisplay.textContent = posNum + '%';
                }

                // Update quick button states
                document.querySelectorAll('.crop-quick-btn').forEach(function(btn, i) {
                    var btnVal = [0, 50, 100][i];
                    btn.classList.toggle('active', posNum === btnVal);
                });

                // Update the phone preview's crop position in real-time (CSS variable)
                var phoneVideoArea = document.querySelector('.phone-video-area');
                if (phoneVideoArea) {
                    phoneVideoArea.style.setProperty('--crop-position', posNum + '%');
                    phoneVideoArea.dataset.cropPercent = posNum;
                }
            },

            // AI Smart Crop - detects main subject and auto-positions crop
            runAiSmartCrop: async function() {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!activeClip) return;

                var btn = document.querySelector('.btn-ai-smart-crop');
                if (btn) {
                    btn.classList.add('loading');
                    btn.disabled = true;
                }

                utils.showToast('AI analyzing video for subject detection...', 'info');

                try {
                    // Get video thumbnail for analysis
                    var videoId = state.videoInput.videoData?.videoId;
                    var thumbnailUrl = activeClip.thumbnail || (videoId ? 'https://img.youtube.com/vi/' + videoId + '/maxresdefault.jpg' : null);

                    if (!thumbnailUrl) {
                        throw new Error('No image available for analysis');
                    }

                    // Call AI smart crop function
                    var result = await firebase.functions().httpsCallable('wizardSmartCrop')({
                        thumbnailUrl: thumbnailUrl,
                        videoId: videoId,
                        clipStartTime: activeClip.startTime
                    });

                    if (result.data.success) {
                        var suggestedPosition = result.data.cropPosition; // 0-100
                        var confidence = result.data.confidence;
                        var detectedSubject = result.data.subject;

                        // Apply the AI-suggested position
                        if (!state.clipSettings[activeClip.id]) {
                            state.clipSettings[activeClip.id] = getDefaultSettings();
                        }
                        state.clipSettings[activeClip.id].cropPosition = suggestedPosition;
                        state.clipSettings[activeClip.id].aiSmartCrop = true;

                        utils.showToast('AI detected ' + (detectedSubject || 'subject') + ' - crop position optimized!', 'success');
                        render();
                    } else {
                        throw new Error(result.data.error || 'AI analysis failed');
                    }
                } catch (error) {
                    console.error('AI Smart Crop error:', error);

                    // Fallback: Use simple heuristic based on clip content
                    // Default to slightly left of center (40%) as people are often positioned there
                    if (!state.clipSettings[activeClip.id]) {
                        state.clipSettings[activeClip.id] = getDefaultSettings();
                    }

                    // Simple fallback: analyze clip transcript for speaker positioning hints
                    var fallbackPosition = 50; // Default center
                    var transcript = (activeClip.transcript || '').toLowerCase();

                    // Heuristics based on content type
                    if (transcript.includes('interview') || transcript.includes('podcast')) {
                        fallbackPosition = 35; // Slightly left for interview format
                    } else if (transcript.includes('tutorial') || transcript.includes('screen')) {
                        fallbackPosition = 25; // Left side for screen recording with speaker
                    }

                    state.clipSettings[activeClip.id].cropPosition = fallbackPosition;
                    state.clipSettings[activeClip.id].aiSmartCrop = true;

                    utils.showToast('Smart crop applied (using content analysis)', 'success');
                    render();
                }

                if (btn) {
                    btn.classList.remove('loading');
                    btn.disabled = false;
                }
            },

            setOutputQuality: function(quality) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                state.clipSettings[activeClip.id].outputQuality = quality;
                render();
            },

            setFrameRate: function(fps) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                state.clipSettings[activeClip.id].frameRate = fps;
                render();
            },

            // =============================================
            // SECONDARY SOURCE (Multi-source split screen)
            // =============================================

            toggleSecondarySource: function(enabled) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                if (!state.clipSettings[activeClip.id].secondarySource) {
                    state.clipSettings[activeClip.id].secondarySource = getDefaultSettings().secondarySource;
                }
                state.clipSettings[activeClip.id].secondarySource.enabled = enabled;
                render();
            },

            setSecondaryInputTab: function(tab) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                if (!state.clipSettings[activeClip.id].secondarySource) {
                    state.clipSettings[activeClip.id].secondarySource = getDefaultSettings().secondarySource;
                }
                state.clipSettings[activeClip.id].secondarySource.inputTab = tab;
                render();
            },

            handleSecondaryFileSelect: async function(files) {
                if (!files || files.length === 0) return;
                var file = files[0];

                // Validate file type
                if (!file.type.startsWith('video/')) {
                    utils.showToast('Please select a video file', 'error');
                    return;
                }

                // Validate file size (500MB max)
                var maxSize = 500 * 1024 * 1024;
                if (file.size > maxSize) {
                    utils.showToast('File too large. Maximum size is 500MB', 'error');
                    return;
                }

                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                if (!state.clipSettings[activeClip.id].secondarySource) {
                    state.clipSettings[activeClip.id].secondarySource = getDefaultSettings().secondarySource;
                }

                // Store file info immediately for UI
                state.clipSettings[activeClip.id].secondarySource.type = 'upload';
                state.clipSettings[activeClip.id].secondarySource.file = file;
                state.clipSettings[activeClip.id].secondarySource.fileName = file.name;
                state.clipSettings[activeClip.id].secondarySource.fileSize = file.size;
                state.clipSettings[activeClip.id].secondarySource.uploading = true;
                state.clipSettings[activeClip.id].secondarySource.uploadProgress = 0;

                // Set default position based on reframe mode
                var reframeMode = state.clipSettings[activeClip.id].reframeMode;
                if (reframeMode === 'split_screen') {
                    state.clipSettings[activeClip.id].secondarySource.position = 'bottom';
                } else if (reframeMode === 'three_person') {
                    state.clipSettings[activeClip.id].secondarySource.position = 'bottom-left';
                } else if (reframeMode === 'gameplay') {
                    state.clipSettings[activeClip.id].secondarySource.position = 'facecam';
                } else if (reframeMode === 'broll_split') {
                    state.clipSettings[activeClip.id].secondarySource.position = 'broll';
                }

                render();
                utils.showToast('Uploading secondary video...', 'info');

                // Upload to Firebase Storage
                try {
                    var timestamp = Date.now();
                    var safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                    var storagePath = 'secondary_videos/' + state.user.uid + '/' + activeClip.id + '_' + timestamp + '_' + safeName;
                    var storageRef = storage.ref(storagePath);

                    var uploadTask = storageRef.put(file);

                    uploadTask.on('state_changed',
                        function(snapshot) {
                            // Progress updates
                            var progress = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
                            if (state.clipSettings[activeClip.id]?.secondarySource) {
                                state.clipSettings[activeClip.id].secondarySource.uploadProgress = progress;
                            }
                            // Update UI periodically
                            if (progress % 20 === 0 || progress === 100) {
                                render();
                            }
                        },
                        function(error) {
                            // Error handling
                            console.error('Secondary video upload error:', error);
                            utils.showToast('Upload failed: ' + error.message, 'error');
                            if (state.clipSettings[activeClip.id]?.secondarySource) {
                                state.clipSettings[activeClip.id].secondarySource.uploading = false;
                                state.clipSettings[activeClip.id].secondarySource.uploadProgress = 0;
                            }
                            render();
                        },
                        async function() {
                            // Upload completed - get download URL
                            var downloadURL = await uploadTask.snapshot.ref.getDownloadURL();

                            if (state.clipSettings[activeClip.id]?.secondarySource) {
                                state.clipSettings[activeClip.id].secondarySource.uploading = false;
                                state.clipSettings[activeClip.id].secondarySource.uploadProgress = 100;
                                state.clipSettings[activeClip.id].secondarySource.uploadedUrl = downloadURL;
                            }

                            console.log('Secondary video uploaded:', downloadURL);
                            utils.showToast('Upload complete! Extracting metadata...', 'success');
                            render();

                            // Extract AI-powered metadata from the uploaded video
                            try {
                                state.clipSettings[activeClip.id].secondarySource.extractingMetadata = true;
                                render();

                                var extractMetadata = functions.httpsCallable('wizardExtractVideoMetadata');
                                var result = await extractMetadata({
                                    videoUrl: downloadURL,
                                    fileName: file.name
                                });

                                if (result.data.success && result.data.metadata) {
                                    var meta = result.data.metadata;
                                    state.clipSettings[activeClip.id].secondarySource.metadata = {
                                        title: meta.title,
                                        description: meta.description,
                                        tags: meta.tags || [],
                                        category: meta.category,
                                        keyTopics: meta.keyTopics || [],
                                        suggestedHashtags: meta.suggestedHashtags || [],
                                        transcription: meta.transcription,
                                        hasTranscription: meta.hasFullTranscription
                                    };
                                    state.clipSettings[activeClip.id].secondarySource.extractingMetadata = false;
                                    console.log('Metadata extracted:', meta.title);
                                    utils.showToast('AI metadata extracted: "' + meta.title.substring(0, 30) + '..."', 'success');
                                    render();
                                }
                            } catch (metaError) {
                                console.error('Metadata extraction failed:', metaError);
                                state.clipSettings[activeClip.id].secondarySource.extractingMetadata = false;
                                utils.showToast('Video ready (metadata extraction failed)', 'info');
                                render();
                            }
                        }
                    );
                } catch (uploadError) {
                    console.error('Secondary video upload error:', uploadError);
                    utils.showToast('Upload failed: ' + uploadError.message, 'error');
                    if (state.clipSettings[activeClip.id]?.secondarySource) {
                        state.clipSettings[activeClip.id].secondarySource.uploading = false;
                    }
                    render();
                }
            },

            loadSecondaryYouTube: function() {
                var urlInput = document.getElementById('secondary-youtube-url');
                if (!urlInput) return;

                var url = urlInput.value.trim();
                if (!url) {
                    utils.showToast('Please enter a YouTube URL', 'error');
                    return;
                }

                // Extract video ID from URL
                var videoId = null;
                var patterns = [
                    /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
                    /^([a-zA-Z0-9_-]{11})$/
                ];
                for (var i = 0; i < patterns.length; i++) {
                    var match = url.match(patterns[i]);
                    if (match) {
                        videoId = match[1];
                        break;
                    }
                }

                if (!videoId) {
                    utils.showToast('Invalid YouTube URL', 'error');
                    return;
                }

                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                if (!state.clipSettings[activeClip.id].secondarySource) {
                    state.clipSettings[activeClip.id].secondarySource = getDefaultSettings().secondarySource;
                }

                // Store YouTube info
                state.clipSettings[activeClip.id].secondarySource.type = 'youtube';
                state.clipSettings[activeClip.id].secondarySource.youtubeUrl = url;
                state.clipSettings[activeClip.id].secondarySource.youtubeVideoId = videoId;
                state.clipSettings[activeClip.id].secondarySource.youtubeThumbnail = 'https://img.youtube.com/vi/' + videoId + '/mqdefault.jpg';
                state.clipSettings[activeClip.id].secondarySource.youtubeTitle = 'YouTube Video';

                // Set default position
                var reframeMode = state.clipSettings[activeClip.id].reframeMode;
                if (reframeMode === 'split_screen') {
                    state.clipSettings[activeClip.id].secondarySource.position = 'bottom';
                } else if (reframeMode === 'three_person') {
                    state.clipSettings[activeClip.id].secondarySource.position = 'bottom-left';
                } else if (reframeMode === 'gameplay') {
                    state.clipSettings[activeClip.id].secondarySource.position = 'facecam';
                } else if (reframeMode === 'broll_split') {
                    state.clipSettings[activeClip.id].secondarySource.position = 'broll';
                }

                utils.showToast('YouTube video loaded', 'success');
                render();
            },

            removeSecondarySource: function() {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (state.clipSettings[activeClip.id] && state.clipSettings[activeClip.id].secondarySource) {
                    // Reset secondary source to defaults
                    state.clipSettings[activeClip.id].secondarySource = getDefaultSettings().secondarySource;
                    state.clipSettings[activeClip.id].secondarySource.enabled = true; // Keep enabled state
                }
                utils.showToast('Secondary source removed', 'info');
                render();
            },

            setSecondaryPosition: function(position) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (state.clipSettings[activeClip.id] && state.clipSettings[activeClip.id].secondarySource) {
                    state.clipSettings[activeClip.id].secondarySource.position = position;
                }
                render();
            },

            adjustSecondaryOffset: function(delta) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (state.clipSettings[activeClip.id] && state.clipSettings[activeClip.id].secondarySource) {
                    var current = state.clipSettings[activeClip.id].secondarySource.timeOffset || 0;
                    var newOffset = Math.max(-10, Math.min(10, current + delta));
                    state.clipSettings[activeClip.id].secondarySource.timeOffset = newOffset;
                }
                render();
            },

            // =============================================
            // TERTIARY SOURCE (for three_person mode - third video)
            // =============================================

            toggleTertiarySource: function(enabled) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                if (!state.clipSettings[activeClip.id].tertiarySource) {
                    state.clipSettings[activeClip.id].tertiarySource = getDefaultSettings().tertiarySource;
                }
                state.clipSettings[activeClip.id].tertiarySource.enabled = enabled;
                render();
            },

            setTertiaryInputTab: function(tab) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                if (!state.clipSettings[activeClip.id].tertiarySource) {
                    state.clipSettings[activeClip.id].tertiarySource = getDefaultSettings().tertiarySource;
                }
                state.clipSettings[activeClip.id].tertiarySource.inputTab = tab;
                render();
            },

            handleTertiaryFileSelect: async function(files) {
                if (!files || files.length === 0) return;
                var file = files[0];

                // Validate file type
                if (!file.type.startsWith('video/')) {
                    utils.showToast('Please select a video file', 'error');
                    return;
                }

                // Validate file size (500MB max)
                var maxSize = 500 * 1024 * 1024;
                if (file.size > maxSize) {
                    utils.showToast('File too large. Maximum size is 500MB', 'error');
                    return;
                }

                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                if (!state.clipSettings[activeClip.id].tertiarySource) {
                    state.clipSettings[activeClip.id].tertiarySource = getDefaultSettings().tertiarySource;
                }

                // Store file info immediately for UI
                state.clipSettings[activeClip.id].tertiarySource.type = 'upload';
                state.clipSettings[activeClip.id].tertiarySource.file = file;
                state.clipSettings[activeClip.id].tertiarySource.fileName = file.name;
                state.clipSettings[activeClip.id].tertiarySource.fileSize = file.size;
                state.clipSettings[activeClip.id].tertiarySource.uploading = true;
                state.clipSettings[activeClip.id].tertiarySource.uploadProgress = 0;

                // Set default position for three_person mode
                state.clipSettings[activeClip.id].tertiarySource.position = 'bottom-right';

                render();
                utils.showToast('Uploading third video...', 'info');

                // Upload to Firebase Storage
                try {
                    var timestamp = Date.now();
                    var safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                    var storagePath = 'tertiary_videos/' + state.user.uid + '/' + activeClip.id + '_' + timestamp + '_' + safeName;
                    var storageRef = storage.ref(storagePath);

                    var uploadTask = storageRef.put(file);

                    uploadTask.on('state_changed',
                        function(snapshot) {
                            // Progress updates
                            var progress = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
                            if (state.clipSettings[activeClip.id]?.tertiarySource) {
                                state.clipSettings[activeClip.id].tertiarySource.uploadProgress = progress;
                            }
                            // Update UI periodically
                            if (progress % 20 === 0 || progress === 100) {
                                render();
                            }
                        },
                        function(error) {
                            // Error handling
                            console.error('Tertiary video upload error:', error);
                            utils.showToast('Upload failed: ' + error.message, 'error');
                            if (state.clipSettings[activeClip.id]?.tertiarySource) {
                                state.clipSettings[activeClip.id].tertiarySource.uploading = false;
                                state.clipSettings[activeClip.id].tertiarySource.uploadProgress = 0;
                            }
                            render();
                        },
                        async function() {
                            // Upload completed - get download URL
                            var downloadURL = await uploadTask.snapshot.ref.getDownloadURL();

                            if (state.clipSettings[activeClip.id]?.tertiarySource) {
                                state.clipSettings[activeClip.id].tertiarySource.uploading = false;
                                state.clipSettings[activeClip.id].tertiarySource.uploadProgress = 100;
                                state.clipSettings[activeClip.id].tertiarySource.uploadedUrl = downloadURL;
                            }

                            console.log('Tertiary video uploaded:', downloadURL);
                            utils.showToast('Third video upload complete!', 'success');
                            render();
                        }
                    );
                } catch (uploadError) {
                    console.error('Tertiary video upload error:', uploadError);
                    utils.showToast('Upload failed: ' + uploadError.message, 'error');
                    if (state.clipSettings[activeClip.id]?.tertiarySource) {
                        state.clipSettings[activeClip.id].tertiarySource.uploading = false;
                    }
                    render();
                }
            },

            loadTertiaryYouTube: function() {
                var urlInput = document.getElementById('tertiary-youtube-url');
                if (!urlInput) return;

                var url = urlInput.value.trim();
                if (!url) {
                    utils.showToast('Please enter a YouTube URL', 'error');
                    return;
                }

                // Extract video ID from URL
                var videoId = null;
                var patterns = [
                    /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
                    /^([a-zA-Z0-9_-]{11})$/
                ];
                for (var i = 0; i < patterns.length; i++) {
                    var match = url.match(patterns[i]);
                    if (match) {
                        videoId = match[1];
                        break;
                    }
                }

                if (!videoId) {
                    utils.showToast('Invalid YouTube URL', 'error');
                    return;
                }

                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                if (!state.clipSettings[activeClip.id].tertiarySource) {
                    state.clipSettings[activeClip.id].tertiarySource = getDefaultSettings().tertiarySource;
                }

                // Store YouTube info
                state.clipSettings[activeClip.id].tertiarySource.type = 'youtube';
                state.clipSettings[activeClip.id].tertiarySource.youtubeUrl = url;
                state.clipSettings[activeClip.id].tertiarySource.youtubeVideoId = videoId;
                state.clipSettings[activeClip.id].tertiarySource.youtubeThumbnail = 'https://img.youtube.com/vi/' + videoId + '/mqdefault.jpg';
                state.clipSettings[activeClip.id].tertiarySource.youtubeTitle = 'YouTube Video';
                state.clipSettings[activeClip.id].tertiarySource.position = 'bottom-right';

                utils.showToast('Third YouTube video loaded', 'success');
                render();
            },

            removeTertiarySource: function() {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (state.clipSettings[activeClip.id] && state.clipSettings[activeClip.id].tertiarySource) {
                    // Reset tertiary source to defaults
                    state.clipSettings[activeClip.id].tertiarySource = getDefaultSettings().tertiarySource;
                    state.clipSettings[activeClip.id].tertiarySource.enabled = true; // Keep enabled state
                }
                utils.showToast('Third video source removed', 'info');
                render();
            },

            setTertiaryPosition: function(position) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (state.clipSettings[activeClip.id] && state.clipSettings[activeClip.id].tertiarySource) {
                    state.clipSettings[activeClip.id].tertiarySource.position = position;
                }
                render();
            },

            adjustTertiaryOffset: function(delta) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (state.clipSettings[activeClip.id] && state.clipSettings[activeClip.id].tertiarySource) {
                    var current = state.clipSettings[activeClip.id].tertiarySource.timeOffset || 0;
                    var newOffset = Math.max(-10, Math.min(10, current + delta));
                    state.clipSettings[activeClip.id].tertiarySource.timeOffset = newOffset;
                }
                render();
            },

            // =============================================
            // AUDIO MIX (for multi-source)
            // =============================================

            toggleAudioMute: function(track) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                if (!state.clipSettings[activeClip.id].audioMix) {
                    state.clipSettings[activeClip.id].audioMix = getDefaultSettings().audioMix;
                }

                // Toggle mute state
                var audioMix = state.clipSettings[activeClip.id].audioMix;
                var newMuteState = false;
                if (track === 'primary') {
                    audioMix.primaryMuted = !audioMix.primaryMuted;
                    newMuteState = audioMix.primaryMuted;
                } else if (track === 'secondary') {
                    audioMix.secondaryMuted = !audioMix.secondaryMuted;
                    newMuteState = audioMix.secondaryMuted;
                }

                // Apply mute directly to video elements without full re-render
                var videos = document.querySelectorAll('.phone-video-area video');
                var appliedToVideo = false;
                videos.forEach(function(video) {
                    var videoTrack = video.getAttribute('data-track');
                    if (videoTrack === track) {
                        video.muted = newMuteState;
                        video.volume = newMuteState ? 0 : (track === 'primary' ? (audioMix.primaryVolume || 100) : (audioMix.secondaryVolume || 0)) / 100;
                        appliedToVideo = true;
                    }
                });

                // Update mute button UI without full re-render
                var muteBtn = document.querySelector('.audio-mix-mute-btn[onclick*="' + track + '"]');
                if (muteBtn) {
                    if (newMuteState) {
                        muteBtn.classList.add('muted');
                        muteBtn.innerHTML = '🔇 Muted';
                    } else {
                        muteBtn.classList.remove('muted');
                        muteBtn.innerHTML = '🔊 Active';
                    }
                }

                // Update volume slider state
                var volumeSlider = document.querySelector('.audio-mix-slider' + (track === 'secondary' ? '.secondary' : ':not(.secondary)'));
                if (volumeSlider) {
                    volumeSlider.disabled = newMuteState;
                }

                // Update audio indicator badges
                var indicator = document.querySelector('.audio-indicator:' + (track === 'primary' ? 'first-child' : 'last-child'));
                if (indicator) {
                    if (newMuteState) {
                        indicator.classList.add('muted');
                        indicator.innerHTML = (track === 'primary' ? '🎙️ Primary OFF' : '🎬 Secondary OFF');
                    } else {
                        indicator.classList.remove('muted');
                        var vol = track === 'primary' ? (audioMix.primaryVolume || 100) : (audioMix.secondaryVolume || 0);
                        indicator.innerHTML = (track === 'primary' ? '🎙️ Primary ' : '🎬 Secondary ') + vol + '%';
                    }
                }

                // For YouTube iframes, we need to reload to change mute - only do this if no video element was found
                var hasIframe = document.querySelector('.phone-video-area iframe[data-track="' + track + '"]');
                if (hasIframe && !appliedToVideo) {
                    // Full re-render needed for YouTube iframes to update mute parameter in URL
                    render();
                }
            },

            setAudioMixVolume: function(track, value) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                if (!state.clipSettings[activeClip.id].audioMix) {
                    state.clipSettings[activeClip.id].audioMix = getDefaultSettings().audioMix;
                }
                var audioMix = state.clipSettings[activeClip.id].audioMix;
                var volumeValue = parseInt(value);

                if (track === 'primary') {
                    audioMix.primaryVolume = volumeValue;
                } else if (track === 'secondary') {
                    audioMix.secondaryVolume = volumeValue;
                }

                // Apply volume directly to video elements without re-render
                var videos = document.querySelectorAll('.phone-video-area video');
                videos.forEach(function(video) {
                    var videoTrack = video.getAttribute('data-track');
                    if (videoTrack === track) {
                        var isMuted = track === 'primary' ? audioMix.primaryMuted : audioMix.secondaryMuted;
                        if (!isMuted) {
                            video.volume = volumeValue / 100;
                        }
                    }
                });

                // Update value display
                var sliders = document.querySelectorAll('.audio-mix-slider');
                sliders.forEach(function(slider) {
                    if ((track === 'secondary' && slider.classList.contains('secondary')) ||
                        (track === 'primary' && !slider.classList.contains('secondary'))) {
                        var row = slider.closest('.audio-mix-slider-row');
                        if (row) {
                            var valEl = row.querySelector('.audio-mix-value');
                            if (valEl) valEl.textContent = volumeValue + '%';
                        }
                    }
                });

                // Update audio indicator badges
                var indicator = document.querySelector('.audio-indicator:' + (track === 'primary' ? 'first-child' : 'last-child'));
                if (indicator && !indicator.classList.contains('muted')) {
                    indicator.innerHTML = (track === 'primary' ? '🎙️ Primary ' : '🎬 Secondary ') + volumeValue + '%';
                }
            },

            applyAudioMixPreset: function(preset) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                if (!state.clipSettings[activeClip.id].audioMix) {
                    state.clipSettings[activeClip.id].audioMix = getDefaultSettings().audioMix;
                }

                var presets = {
                    'primary': { primaryVolume: 100, secondaryVolume: 0, primaryMuted: false, secondaryMuted: true },
                    'secondary': { primaryVolume: 0, secondaryVolume: 100, primaryMuted: true, secondaryMuted: false },
                    'mix': { primaryVolume: 50, secondaryVolume: 50, primaryMuted: false, secondaryMuted: false },
                    'background': { primaryVolume: 100, secondaryVolume: 20, primaryMuted: false, secondaryMuted: false }
                };

                if (presets[preset]) {
                    state.clipSettings[activeClip.id].audioMix = presets[preset];
                    var presetNames = {
                        'primary': 'Primary Only',
                        'secondary': 'Secondary Only',
                        'mix': '50/50 Mix',
                        'background': 'Primary + Background'
                    };
                    utils.showToast('Audio preset applied: ' + presetNames[preset], 'success');
                }
                render();
            },

            toggleAudioOption: function(option) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                state.clipSettings[activeClip.id][option] = !state.clipSettings[activeClip.id][option];
                render();
            },

            // Volume control
            setVolume: function(type, value) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                if (type === 'voice') {
                    state.clipSettings[activeClip.id].voiceVolume = parseInt(value);
                } else if (type === 'music') {
                    state.clipSettings[activeClip.id].musicVolume = parseInt(value);
                }
                // Update display without full re-render
                var valueSpan = document.querySelector('.volume-slider-container .volume-slider[value="' + value + '"]');
                if (valueSpan) {
                    var label = valueSpan.parentElement.querySelector('.volume-slider-value');
                    if (label) label.textContent = value + '%';
                }
            },

            // Music track selection
            selectMusicTrack: function(trackId) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                state.clipSettings[activeClip.id].selectedTrack = trackId;
                render();
                utils.showToast('Track selected', 'success');
            },

            // Transitions with preview animation
            setTransition: function(type, transitionId) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                if (type === 'intro') {
                    state.clipSettings[activeClip.id].introTransition = transitionId;
                } else {
                    state.clipSettings[activeClip.id].outroTransition = transitionId;
                }

                // Trigger transition preview animation on phone screen
                if (transitionId !== 'none') {
                    var phoneScreen = document.querySelector('.phone-screen');
                    if (phoneScreen) {
                        // Remove any existing transition classes
                        phoneScreen.classList.remove('transition-fade-in', 'transition-zoom-in', 'transition-slide-in', 'transition-glitch-in');
                        // Force reflow to restart animation
                        void phoneScreen.offsetWidth;
                        // Add the transition preview class
                        phoneScreen.classList.add('transition-' + transitionId + '-in');
                        // Remove after animation completes
                        setTimeout(function() {
                            phoneScreen.classList.remove('transition-' + transitionId + '-in');
                        }, 1000);
                    }
                }

                render();
            },

            // Visual effects
            toggleEffect: function(effectName) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                state.clipSettings[activeClip.id][effectName] = !state.clipSettings[activeClip.id][effectName];
                render();
            },

            // Apply preset template
            applyPreset: function(presetId) {
                var presetSettings = {
                    tiktok: {
                        captionStyle: 'karaoke',
                        reframeMode: 'auto_center',
                        removeFiller: true,
                        enhanceAudio: true,
                        audioDucking: true,
                        addMusic: false,
                        introTransition: 'fade',
                        outroTransition: 'fade',
                        autoZoom: true,
                        vignette: false,
                        colorGrade: true
                    },
                    youtube: {
                        captionStyle: 'hormozi',
                        reframeMode: 'auto_center',
                        removeFiller: true,
                        enhanceAudio: true,
                        audioDucking: true,
                        addMusic: false,
                        introTransition: 'none',
                        outroTransition: 'fade',
                        autoZoom: false,
                        vignette: false,
                        colorGrade: true
                    },
                    instagram: {
                        captionStyle: 'ali',
                        reframeMode: 'auto_center',
                        removeFiller: false,
                        enhanceAudio: true,
                        audioDucking: true,
                        addMusic: false,
                        introTransition: 'zoom',
                        outroTransition: 'fade',
                        autoZoom: false,
                        vignette: true,
                        colorGrade: true
                    },
                    podcast: {
                        captionStyle: 'podp',
                        reframeMode: 'split_screen',
                        removeFiller: true,
                        enhanceAudio: true,
                        audioDucking: false,
                        addMusic: false,
                        introTransition: 'fade',
                        outroTransition: 'fade',
                        autoZoom: false,
                        vignette: false,
                        colorGrade: false
                    },
                    gaming: {
                        captionStyle: 'beasty',
                        reframeMode: 'gameplay',
                        removeFiller: false,
                        enhanceAudio: true,
                        audioDucking: true,
                        addMusic: false,
                        introTransition: 'glitch',
                        outroTransition: 'fade',
                        autoZoom: true,
                        vignette: false,
                        colorGrade: true
                    }
                };

                var preset = presetSettings[presetId];
                if (!preset) {
                    utils.showToast('Unknown preset', 'error');
                    return;
                }

                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!activeClip) {
                    utils.showToast('No clip selected', 'error');
                    return;
                }

                // Apply preset to current clip
                var currentSettings = state.clipSettings[activeClip.id] || getDefaultSettings();
                state.clipSettings[activeClip.id] = Object.assign({}, currentSettings, preset, {
                    trimStart: currentSettings.trimStart || 0,
                    trimEnd: currentSettings.trimEnd || activeClip.duration,
                    voiceVolume: currentSettings.voiceVolume || 100,
                    musicVolume: currentSettings.musicVolume || 30,
                    selectedTrack: currentSettings.selectedTrack
                });

                render();
                utils.showToast(presetId.charAt(0).toUpperCase() + presetId.slice(1) + ' preset applied!', 'success');
            },

            // Apply settings from current clip to all other clips
            applySettingsToAllClips: function() {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });

                if (selectedClips.length <= 1) {
                    utils.showToast('Only one clip selected', 'info');
                    return;
                }

                // Validate activeClipIndex is in bounds (with fallback)
                var activeClipIndex = state.customization.activeClipIndex;
                if (activeClipIndex < 0 || activeClipIndex >= selectedClips.length) {
                    activeClipIndex = 0;
                }
                var activeClip = selectedClips[activeClipIndex];
                if (!activeClip) {
                    utils.showToast('No active clip found', 'error');
                    return;
                }

                // Get source settings from the active clip
                var sourceSettings = state.clipSettings[activeClip.id];
                if (!sourceSettings) {
                    // If no settings exist for active clip, use defaults
                    sourceSettings = getDefaultSettings();
                }

                // Ensure cropPosition is always a valid number (critical fix)
                var sourceCropPosition = sourceSettings.cropPosition;
                if (typeof sourceCropPosition !== 'number' || isNaN(sourceCropPosition)) {
                    sourceCropPosition = 50;
                }
                sourceCropPosition = Math.max(0, Math.min(100, sourceCropPosition));

                // Apply STYLE settings to all clips
                // CLIP-SPECIFIC (preserved): reframeMode, cropPosition, splitScreenSettings, video sources, trim
                // APPLIED TO ALL: caption style, output settings, audio, effects, transitions
                var appliedCount = 0;
                selectedClips.forEach(function(clip) {
                    if (clip.id !== activeClip.id) {
                        var clipSettings = state.clipSettings[clip.id] || getDefaultSettings();

                        // PRESERVE all clip-specific settings
                        var existingReframeMode = clipSettings.reframeMode;
                        var existingCropPosition = clipSettings.cropPosition;
                        var existingSplitScreenSettings = clipSettings.splitScreenSettings;
                        var existingSecondary = clipSettings.secondarySource;
                        var existingTertiary = clipSettings.tertiarySource;

                        // Copy only COMMON STYLE settings (not layout/reframe which is clip-specific)
                        state.clipSettings[clip.id] = {
                            // Caption settings (APPLIED)
                            captionStyle: sourceSettings.captionStyle,
                            captionSource: sourceSettings.captionSource,
                            customCaptionStyle: sourceSettings.customCaptionStyle ? Object.assign({}, sourceSettings.customCaptionStyle) : undefined,

                            // PRESERVED: Reframe/layout settings are clip-specific
                            reframeMode: existingReframeMode || 'auto_center',
                            cropPosition: existingCropPosition ?? 50,
                            aiSmartCrop: clipSettings.aiSmartCrop || false,
                            splitScreenSettings: existingSplitScreenSettings,

                            // Output settings (APPLIED)
                            outputAspect: sourceSettings.outputAspect,
                            outputQuality: sourceSettings.outputQuality,
                            frameRate: sourceSettings.frameRate,

                            // Audio settings (APPLIED)
                            removeFiller: sourceSettings.removeFiller,
                            enhanceAudio: sourceSettings.enhanceAudio,
                            audioDucking: sourceSettings.audioDucking,
                            voiceVolume: sourceSettings.voiceVolume,
                            addMusic: sourceSettings.addMusic,
                            musicVolume: sourceSettings.musicVolume,
                            selectedTrack: sourceSettings.selectedTrack,

                            // Transition settings (APPLIED)
                            introTransition: sourceSettings.introTransition,
                            outroTransition: sourceSettings.outroTransition,

                            // Visual effects (APPLIED)
                            autoZoom: sourceSettings.autoZoom,
                            vignette: sourceSettings.vignette,
                            colorGrade: sourceSettings.colorGrade,
                            zoom: sourceSettings.zoom || 100, // Single video zoom level

                            // AI features (APPLIED)
                            selectedHook: sourceSettings.selectedHook,

                            // Audio mix (APPLIED - volume levels)
                            audioMix: sourceSettings.audioMix ? Object.assign({}, sourceSettings.audioMix) : undefined,

                            // PRESERVED: Clip-specific video sources
                            secondarySource: existingSecondary,
                            tertiarySource: existingTertiary,

                            // PRESERVED: Clip-specific trim values
                            trimStart: clipSettings.trimStart || 0,
                            trimEnd: clipSettings.trimEnd || clip.duration
                        };
                        appliedCount++;
                    }
                });

                // DEBUG: Show what was applied
                console.log('[applySettingsToAllClips] Applied common settings (captions, audio, effects) to', appliedCount, 'clips. Layout & videos preserved.');

                render();
                utils.showToast('Captions, audio & effects applied to ' + appliedCount + ' clips. Layout preserved.', 'success');
            },

            // Timeline trimming
            adjustTrim: function(handle, delta) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                var settings = state.clipSettings[activeClip.id];
                var trimStart = settings.trimStart || 0;
                var trimEnd = settings.trimEnd || activeClip.duration;

                if (handle === 'start') {
                    trimStart = Math.max(0, Math.min(trimStart + delta, trimEnd - 5));
                } else {
                    trimEnd = Math.min(activeClip.duration, Math.max(trimEnd + delta, trimStart + 5));
                }

                state.clipSettings[activeClip.id].trimStart = trimStart;
                state.clipSettings[activeClip.id].trimEnd = trimEnd;
                render();
            },

            setTrim: function(start, end) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSettings[activeClip.id]) {
                    state.clipSettings[activeClip.id] = getDefaultSettings();
                }
                state.clipSettings[activeClip.id].trimStart = Math.max(0, start);
                state.clipSettings[activeClip.id].trimEnd = Math.min(activeClip.duration, end);
                render();
            },

            // AI feature application
            applyAIFeature: async function(feature) {
                if (!state.projectId) {
                    utils.showToast('No project loaded', 'error');
                    return;
                }

                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!activeClip) {
                    utils.showToast('No clip selected', 'error');
                    return;
                }

                var featureNames = {
                    clipping: 'AI Clipping',
                    captioning: 'AI Captioning',
                    reframe: 'AI Reframe',
                    broll: 'AI B-Roll',
                    audio: 'AI Audio Enhancement',
                    hook: 'AI Hook Generation'
                };

                // Token cost mapping for AI features
                var featureTokenCosts = {
                    broll: state.tokens.costs.generateBRoll || 4,
                    reframe: state.tokens.costs.detectSpeakers || 3
                };

                // Check token balance for token-consuming features
                if (featureTokenCosts[feature]) {
                    var cost = featureTokenCosts[feature];
                    if (state.tokens.balance < cost) {
                        utils.showModal(
                            'Insufficient Tokens',
                            '<div style="text-align: center; padding: 20px;">' +
                                '<div style="font-size: 48px; margin-bottom: 16px;">🤖</div>' +
                                '<p style="margin-bottom: 16px;">You need <strong>' + cost + ' tokens</strong> to use ' + (featureNames[feature] || feature) + '.</p>' +
                                '<p style="margin-bottom: 16px;">Current balance: <strong>' + state.tokens.balance + ' tokens</strong></p>' +
                            '</div>'
                        );
                        return;
                    }
                }

                utils.showToast('Applying ' + (featureNames[feature] || feature) + '...', 'info');

                try {
                    var result;
                    switch (feature) {
                        case 'broll':
                            var wizardGenerateBRoll = functions.httpsCallable('wizardGenerateBRoll');
                            result = await wizardGenerateBRoll({
                                projectId: state.projectId,
                                clipId: activeClip.id
                            });
                            if (result.data.success) {
                                state.clipBRoll = state.clipBRoll || {};
                                state.clipBRoll[activeClip.id] = result.data.brollSuggestions;
                                app.refreshTokenBalance(); // Refresh tokens after successful operation
                                utils.showToast('Generated ' + result.data.brollSuggestions.length + ' B-Roll suggestions!', 'success');
                                app.showBRollModal(activeClip.id);
                            }
                            break;

                        case 'hook':
                            var wizardGenerateHook = functions.httpsCallable('wizardGenerateHook');
                            result = await wizardGenerateHook({
                                projectId: state.projectId,
                                clipId: activeClip.id,
                                hookStyle: 'curiosity'
                            });
                            if (result.data.success) {
                                state.clipHooks = state.clipHooks || {};
                                state.clipHooks[activeClip.id] = result.data;
                                utils.showToast('Generated ' + result.data.hooks.length + ' viral hooks!', 'success');
                                app.showHooksModal(activeClip.id);
                            }
                            break;

                        case 'captioning':
                            var wizardGenerateCaptions = functions.httpsCallable('wizardGenerateAICaptions');
                            var settings = state.clipSettings[activeClip.id] || getDefaultSettings();
                            result = await wizardGenerateCaptions({
                                projectId: state.projectId,
                                clipId: activeClip.id,
                                style: settings.captionStyle || 'karaoke'
                            });
                            if (result.data.success) {
                                state.clipCaptions = state.clipCaptions || {};
                                state.clipCaptions[activeClip.id] = result.data;
                                utils.showToast('Generated ' + result.data.captionCount + ' word captions!', 'success');
                            }
                            break;

                        case 'reframe':
                            var wizardDetectSpeakers = functions.httpsCallable('wizardDetectSpeakers');
                            result = await wizardDetectSpeakers({
                                projectId: state.projectId,
                                clipId: activeClip.id
                            });
                            if (result.data.success) {
                                state.clipSpeakers = state.clipSpeakers || {};
                                state.clipSpeakers[activeClip.id] = result.data;
                                // Auto-apply recommended reframe
                                if (result.data.recommendedReframe) {
                                    app.setReframeMode(result.data.recommendedReframe);
                                }
                                app.refreshTokenBalance(); // Refresh tokens after successful operation
                                utils.showToast('Detected ' + result.data.speakerCount + ' speaker(s). Reframe set to: ' + result.data.recommendedReframe, 'success');
                            }
                            break;

                        case 'audio':
                            var wizardRemoveFillers = functions.httpsCallable('wizardRemoveFillers');
                            result = await wizardRemoveFillers({
                                projectId: state.projectId,
                                clipId: activeClip.id
                            });
                            if (result.data.success) {
                                state.clipFillers = state.clipFillers || {};
                                state.clipFillers[activeClip.id] = result.data;
                                utils.showToast('Found ' + result.data.stats.fillersRemoved + ' filler words. ~' + result.data.stats.estimatedTimeSaved + 's saved!', 'success');
                                app.showFillersModal(activeClip.id);
                            }
                            break;

                        default:
                            utils.showToast('Feature coming soon!', 'info');
                    }
                } catch (error) {
                    console.error('AI feature error:', error);
                    utils.showToast('Error: ' + (error.message || 'Failed to apply AI feature'), 'error');
                }
            },

            // Show B-Roll suggestions modal
            showBRollModal: function(clipId) {
                var suggestions = (state.clipBRoll || {})[clipId] || [];
                if (suggestions.length === 0) {
                    utils.showToast('No B-Roll suggestions available', 'info');
                    return;
                }

                var html = '<div class="ai-modal-overlay" onclick="app.closeAIModal()">';
                html += '<div class="ai-modal" onclick="event.stopPropagation()">';
                html += '<div class="ai-modal-header">';
                html += '<h3>🎬 AI B-Roll Suggestions</h3>';
                html += '<button class="ai-modal-close" onclick="app.closeAIModal()">×</button>';
                html += '</div>';
                html += '<div class="ai-modal-content">';

                suggestions.forEach(function(s, i) {
                    html += '<div class="broll-suggestion">';
                    html += '<div class="broll-number">' + (i + 1) + '</div>';
                    html += '<div class="broll-info">';
                    html += '<div class="broll-desc">' + s.description + '</div>';
                    html += '<div class="broll-meta">';
                    html += '<span class="broll-duration">⏱️ ' + s.duration + 's</span>';
                    html += '<span class="broll-placement">📍 ' + s.placement + '</span>';
                    html += '</div>';
                    html += '<div class="broll-keywords">' + s.keywords.map(function(k) { return '<span class="broll-tag">' + k + '</span>'; }).join('') + '</div>';
                    html += '</div>';
                    html += '</div>';
                });

                html += '</div>';
                html += '</div>';
                html += '</div>';

                var modal = document.createElement('div');
                modal.id = 'ai-modal-container';
                modal.innerHTML = html;
                document.body.appendChild(modal);
            },

            // Show hooks modal
            showHooksModal: function(clipId) {
                var hookData = (state.clipHooks || {})[clipId];
                if (!hookData || !hookData.hooks) {
                    utils.showToast('No hooks available', 'info');
                    return;
                }

                var html = '<div class="ai-modal-overlay" onclick="app.closeAIModal()">';
                html += '<div class="ai-modal" onclick="event.stopPropagation()">';
                html += '<div class="ai-modal-header">';
                html += '<h3>🪝 AI Viral Hooks</h3>';
                html += '<button class="ai-modal-close" onclick="app.closeAIModal()">×</button>';
                html += '</div>';
                html += '<div class="ai-modal-content">';

                hookData.hooks.forEach(function(h, i) {
                    var isRecommended = h.id === hookData.recommendedHook;
                    html += '<div class="hook-suggestion' + (isRecommended ? ' recommended' : '') + '">';
                    if (isRecommended) html += '<span class="hook-badge">⭐ Recommended</span>';
                    html += '<div class="hook-text">"' + h.text + '"</div>';
                    html += '<div class="hook-meta">';
                    html += '<span>⏱️ ' + h.speakingDuration + 's</span>';
                    html += '<span>💡 ' + h.emotionalTrigger + '</span>';
                    html += '<span>🎭 ' + h.voiceDirection + '</span>';
                    html += '</div>';
                    html += '<button class="hook-use-btn" onclick="app.useHook(\'' + clipId + '\', ' + i + ')">Use This Hook</button>';
                    html += '</div>';
                });

                if (hookData.explanation) {
                    html += '<div class="hook-explanation">' + hookData.explanation + '</div>';
                }

                html += '</div>';
                html += '</div>';
                html += '</div>';

                var modal = document.createElement('div');
                modal.id = 'ai-modal-container';
                modal.innerHTML = html;
                document.body.appendChild(modal);
            },

            // Show fillers modal
            showFillersModal: function(clipId) {
                var fillerData = (state.clipFillers || {})[clipId];
                if (!fillerData) {
                    utils.showToast('No filler data available', 'info');
                    return;
                }

                var html = '<div class="ai-modal-overlay" onclick="app.closeAIModal()">';
                html += '<div class="ai-modal" onclick="event.stopPropagation()">';
                html += '<div class="ai-modal-header">';
                html += '<h3>🔊 Filler Word Analysis</h3>';
                html += '<button class="ai-modal-close" onclick="app.closeAIModal()">×</button>';
                html += '</div>';
                html += '<div class="ai-modal-content">';

                html += '<div class="filler-stats">';
                html += '<div class="filler-stat"><span class="stat-value">' + fillerData.stats.fillersRemoved + '</span><span class="stat-label">Fillers Found</span></div>';
                html += '<div class="filler-stat"><span class="stat-value">~' + fillerData.stats.estimatedTimeSaved + 's</span><span class="stat-label">Time Saved</span></div>';
                html += '<div class="filler-stat"><span class="stat-value">' + fillerData.stats.originalWordCount + ' → ' + fillerData.stats.cleanedWordCount + '</span><span class="stat-label">Words</span></div>';
                html += '</div>';

                html += '<div class="filler-types">';
                Object.keys(fillerData.stats.fillersByType || {}).forEach(function(type) {
                    html += '<span class="filler-type-badge">' + type + ': ' + fillerData.stats.fillersByType[type] + '</span>';
                });
                html += '</div>';

                html += '<div class="filler-transcript">';
                html += '<div class="transcript-label">Cleaned Transcript:</div>';
                html += '<div class="transcript-text">' + fillerData.cleanedTranscript + '</div>';
                html += '</div>';

                html += '</div>';
                html += '</div>';
                html += '</div>';

                var modal = document.createElement('div');
                modal.id = 'ai-modal-container';
                modal.innerHTML = html;
                document.body.appendChild(modal);
            },

            useHook: function(clipId, hookIndex) {
                var hookData = (state.clipHooks || {})[clipId];
                if (hookData && hookData.hooks && hookData.hooks[hookIndex]) {
                    var hook = hookData.hooks[hookIndex];
                    // Store selected hook
                    if (!state.clipSettings[clipId]) {
                        state.clipSettings[clipId] = getDefaultSettings();
                    }
                    state.clipSettings[clipId].selectedHook = hook;
                    utils.showToast('Hook selected: "' + hook.text + '"', 'success');
                    app.closeAIModal();
                }
            },

            closeAIModal: function() {
                var modal = document.getElementById('ai-modal-container');
                if (modal) {
                    modal.remove();
                }
            },

            updateSEO: function(field, value) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!state.clipSEO[activeClip.id]) {
                    state.clipSEO[activeClip.id] = getDefaultSEO(activeClip);
                }
                state.clipSEO[activeClip.id][field] = value;
                // Don't re-render on every keystroke
            },

            regenerateSEO: async function(field) {
                if (!state.projectId) {
                    utils.showToast('No project loaded', 'error');
                    return;
                }

                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!activeClip) {
                    utils.showToast('No clip selected', 'error');
                    return;
                }

                // Check token balance
                var seoCost = state.tokens.costs.generateSEO || 2;
                if (state.tokens.balance < seoCost) {
                    utils.showModal(
                        'Insufficient Tokens',
                        '<div style="text-align: center; padding: 20px;">' +
                            '<div style="font-size: 48px; margin-bottom: 16px;">✨</div>' +
                            '<p style="margin-bottom: 16px;">You need <strong>' + seoCost + ' tokens</strong> to regenerate SEO.</p>' +
                            '<p style="margin-bottom: 16px;">Current balance: <strong>' + state.tokens.balance + ' tokens</strong></p>' +
                        '</div>'
                    );
                    return;
                }

                utils.showToast('Regenerating ' + field + '...', 'info');

                try {
                    var wizardGenerateClipSEO = functions.httpsCallable('wizardGenerateClipSEO');
                    var result = await wizardGenerateClipSEO({
                        projectId: state.projectId,
                        clipId: activeClip.id,
                        transcript: activeClip.transcript,
                        videoTitle: state.videoInput.videoData ? state.videoInput.videoData.title : '',
                        platform: activeClip.platforms ? activeClip.platforms[0] : 'youtube'
                    });

                    if (result.data.success) {
                        // Update local SEO data - backend returns data directly, not nested
                        state.clipSEO[activeClip.id] = {
                            title: result.data.title,
                            description: result.data.description,
                            tags: result.data.tags || [],
                            hashtags: result.data.hashtags || []
                        };
                        // Refresh token balance after successful operation
                        app.refreshTokenBalance();
                        render();
                        utils.showToast(field.charAt(0).toUpperCase() + field.slice(1) + ' regenerated!', 'success');
                    } else {
                        throw new Error(result.data.error || 'Failed to regenerate');
                    }
                } catch (error) {
                    console.error('SEO regeneration error:', error);
                    utils.showToast('Error: ' + (error.message || 'Failed to regenerate'), 'error');
                }
            },

            addTag: function() {
                var tag = prompt('Enter a new tag:');
                if (tag && tag.trim()) {
                    var selectedClips = state.clips.filter(function(c) {
                        return state.selectedClipIds.indexOf(c.id) !== -1;
                    });
                    var activeClip = selectedClips[state.customization.activeClipIndex];
                    if (!state.clipSEO[activeClip.id]) {
                        state.clipSEO[activeClip.id] = getDefaultSEO(activeClip);
                    }
                    state.clipSEO[activeClip.id].tags.push(tag.trim());
                    render();
                }
            },

            removeTag: function(index) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (state.clipSEO[activeClip.id]) {
                    state.clipSEO[activeClip.id].tags.splice(index, 1);
                    render();
                }
            },

            selectThumbnail: function(index) {
                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!activeClip) return;

                if (!state.selectedThumbnail) {
                    state.selectedThumbnail = {};
                }
                state.selectedThumbnail[activeClip.id] = index;
                render();
                utils.showToast('Selected thumbnail ' + String.fromCharCode(65 + index), 'success');
            },

            regenerateThumbnails: async function() {
                if (!state.projectId) {
                    utils.showToast('No project loaded', 'error');
                    return;
                }

                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });
                var activeClip = selectedClips[state.customization.activeClipIndex];
                if (!activeClip) {
                    utils.showToast('No clip selected', 'error');
                    return;
                }

                // Show loading state
                state.thumbnailGenerating = true;
                render();
                utils.showToast('Generating AI thumbnails from video frames...', 'info');

                try {
                    // Use wizardGenerateThumbnails which extracts actual frames from the clip
                    var wizardGenerateThumbnails = functions.httpsCallable('wizardGenerateThumbnails');

                    var result = await wizardGenerateThumbnails({
                        clipId: activeClip.id,
                        transcript: activeClip.transcript || '',
                        projectId: state.projectId,
                        videoTitle: state.videoInput.videoData ? state.videoInput.videoData.title : ''
                    });

                    if (result.data.success && result.data.thumbnails) {
                        state.clipThumbnails[activeClip.id] = result.data.thumbnails;
                        state.thumbnailGenerating = false;
                        render();
                        utils.showToast('Generated ' + result.data.thumbnails.length + ' thumbnails!', 'success');
                    } else {
                        throw new Error(result.data.message || 'Failed to generate thumbnails');
                    }
                } catch (error) {
                    console.error('Thumbnail generation error:', error);
                    state.thumbnailGenerating = false;
                    render();
                    utils.showToast('Error: ' + (error.message || 'Failed to generate'), 'error');
                }
            },

            downloadClip: function(clipId) {
                // DEBUG: Log state at start of downloadClip
                console.log('[downloadClip] START - All clip settings:', JSON.parse(JSON.stringify(state.clipSettings)));

                var clip = state.clips.find(function(c) { return c.id === clipId; });
                if (!clip) {
                    utils.showToast('Clip not found', 'error');
                    return;
                }

                var videoId = state.videoInput.videoData ? state.videoInput.videoData.videoId : null;
                if (!videoId) {
                    // Try to extract from clip thumbnail URL
                    var match = clip.thumbnail.match(/\/vi\/([^\/]+)\//);
                    if (match) {
                        videoId = match[1];
                    }
                }

                var startTime = Math.floor(clip.startTime || 0);
                var endTime = Math.floor(clip.endTime || (startTime + clip.duration));

                // Store current download info for modal
                state.downloadModal = {
                    clipId: clipId,
                    clip: clip,
                    videoId: videoId,
                    startTime: startTime,
                    endTime: endTime,
                    quality: '720p'
                };

                var modalHtml = '<div class="download-modal" onclick="app.closeDownloadModal(event)">';
                modalHtml += '<div class="download-modal-content" onclick="event.stopPropagation()">';

                // Header
                modalHtml += '<div class="download-modal-header">';
                modalHtml += '<h3>Download Clip</h3>';
                modalHtml += '<button class="video-preview-close" onclick="app.closeDownloadModal()">×</button>';
                modalHtml += '</div>';

                // Body
                modalHtml += '<div class="download-modal-body">';

                // Quality options
                modalHtml += '<p style="color: rgba(255,255,255,0.7); margin-bottom: 1rem;">Select video quality:</p>';
                modalHtml += '<div class="download-quality-options">';
                modalHtml += '<div class="quality-option selected" onclick="app.selectDownloadQuality(\'720p\')" id="quality-720p">';
                modalHtml += '<span class="quality-option-label">720p</span>';
                modalHtml += '<span class="quality-option-size">HD • ~' + Math.round(clip.duration * 1.5) + ' MB</span>';
                modalHtml += '</div>';
                modalHtml += '<div class="quality-option" onclick="app.selectDownloadQuality(\'1080p\')" id="quality-1080p">';
                modalHtml += '<span class="quality-option-label">1080p</span>';
                modalHtml += '<span class="quality-option-size">Full HD • ~' + Math.round(clip.duration * 3) + ' MB</span>';
                modalHtml += '</div>';
                modalHtml += '</div>';

                // Processing info
                modalHtml += '<div class="download-processing-info">';
                modalHtml += '<div class="processing-info-title">🎬 What you\'ll get:</div>';
                modalHtml += '<ul class="processing-features">';
                modalHtml += '<li>✓ Vertical 9:16 format (perfect for Shorts/Reels/TikTok)</li>';
                modalHtml += '<li>✓ AI-powered smart reframing</li>';
                modalHtml += '<li>✓ Enhanced audio quality</li>';
                modalHtml += '<li>✓ All your customizations applied</li>';
                modalHtml += '</ul>';
                modalHtml += '</div>';

                // Processing status notice
                modalHtml += '<div class="download-coming-soon">';
                modalHtml += '<div class="download-coming-soon-title">⏳ Processing Queue</div>';
                modalHtml += '<div class="download-coming-soon-text">';
                modalHtml += 'Click "Start Processing" to queue your video for processing. ';
                modalHtml += 'You\'ll be notified when it\'s ready for download (usually 2-5 minutes).';
                modalHtml += '</div>';
                modalHtml += '</div>';

                // Alternative
                modalHtml += '<div class="download-alternative">';
                modalHtml += '<div class="download-alternative-title">💡 Quick Alternative</div>';
                modalHtml += '<div class="download-coming-soon-text">';
                modalHtml += 'Open this exact clip segment in YouTube and use your preferred downloader.';
                modalHtml += '</div>';
                modalHtml += '</div>';

                modalHtml += '</div>'; // body end

                // Actions
                modalHtml += '<div class="download-modal-actions">';
                modalHtml += '<button class="btn-secondary" onclick="app.openClipInYouTube()">Open in YouTube</button>';
                modalHtml += '<button class="btn-primary" onclick="app.startVideoProcessing()">🚀 Start Processing</button>';
                modalHtml += '</div>';

                modalHtml += '</div>'; // content end
                modalHtml += '</div>'; // modal end

                // Append modal to body
                var modalContainer = document.createElement('div');
                modalContainer.id = 'download-modal-container';
                modalContainer.innerHTML = modalHtml;
                document.body.appendChild(modalContainer);
            },

            selectDownloadQuality: function(quality) {
                state.downloadModal.quality = quality;
                // Update UI
                document.querySelectorAll('.quality-option').forEach(function(opt) {
                    opt.classList.remove('selected');
                });
                var selected = document.getElementById('quality-' + quality);
                if (selected) {
                    selected.classList.add('selected');
                }
            },

            closeDownloadModal: function(event) {
                // DEBUG: Log state when closing modal
                console.log('[closeDownloadModal] All clip settings:', JSON.parse(JSON.stringify(state.clipSettings)));

                if (event && event.target !== event.currentTarget) return;
                var container = document.getElementById('download-modal-container');
                if (container) {
                    container.remove();
                }
                state.downloadModal = null;
            },

            // Show capture error in the download modal (instead of closing it)
            showCaptureErrorInModal: function(errorMessage) {
                var modalBody = document.querySelector('.download-modal-body');
                if (!modalBody) return;

                // Hide all content and show error
                modalBody.innerHTML = `
                    <div class="capture-error-container" style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">❌</div>
                        <h3 style="color: #ff6b6b; margin-bottom: 1rem;">Video Capture Failed</h3>
                        <p style="color: rgba(255,255,255,0.8); margin-bottom: 1.5rem; line-height: 1.6; white-space: pre-line;">
                            ${errorMessage}
                        </p>
                        <button class="btn-primary" onclick="app.closeDownloadModal()" style="margin-right: 0.5rem;">Close</button>
                        <button class="btn-secondary" onclick="app.retryCapture()">🔄 Retry</button>
                    </div>
                `;
            },

            // Retry the capture after error
            retryCapture: function() {
                // Save clipId before closing modal
                var clipId = state.downloadModal ? state.downloadModal.clipId : null;
                app.closeDownloadModal();
                // Re-open the modal which will trigger fresh capture
                if (clipId) {
                    setTimeout(function() {
                        app.downloadClip(clipId);
                    }, 500);
                }
            },

            // Show capturing/processing state in the modal
            showCapturingStateInModal: function(message) {
                var modalBody = document.querySelector('.download-modal-body');
                var modalActions = document.querySelector('.download-modal-actions');
                if (!modalBody) return;

                // Replace body content with capturing state
                modalBody.innerHTML = `
                    <div class="capturing-state" style="text-align: center; padding: 2rem;">
                        <div class="capturing-spinner" style="width: 60px; height: 60px; border: 4px solid rgba(255,255,255,0.1); border-top-color: #8b5cf6; border-radius: 50%; margin: 0 auto 1.5rem; animation: spin 1s linear infinite;"></div>
                        <h3 style="color: white; margin-bottom: 0.5rem;">Capturing Video...</h3>
                        <p style="color: rgba(255,255,255,0.7); margin-bottom: 1rem;" id="capture-status-text">${message || 'Please wait while we capture your video segment'}</p>
                        <div style="background: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.3); border-radius: 8px; padding: 1rem;">
                            <p style="color: rgba(255,255,255,0.6); font-size: 0.85rem; margin: 0;">
                                This may take 15-30 seconds depending on clip length.<br>
                                The video is being captured at high speed and uploaded.
                            </p>
                        </div>
                    </div>
                `;

                // Hide action buttons during capture
                if (modalActions) {
                    modalActions.style.display = 'none';
                }
            },

            // Update capture status text
            updateCaptureStatus: function(message) {
                var statusText = document.getElementById('capture-status-text');
                if (statusText) {
                    statusText.textContent = message;
                }
            },

            // Show server unavailable modal with direct download option
            showServerUnavailableModal: function(streamData, clipId) {
                var modalBody = document.querySelector('.download-modal-body');
                if (!modalBody) return;

                var videoSize = streamData.videoSize ? (streamData.videoSize / 1024 / 1024).toFixed(2) + ' MB' : 'Unknown';

                modalBody.innerHTML = `
                    <div class="server-unavailable-container" style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">⚠️</div>
                        <h3 style="color: #fbbf24; margin-bottom: 1rem;">Video Captured - Server Temporarily Unavailable</h3>
                        <p style="color: rgba(255,255,255,0.8); margin-bottom: 1rem; line-height: 1.6;">
                            Your video clip was captured successfully (${videoSize}), but our processing server is temporarily unavailable.
                        </p>
                        <div style="background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                            <p style="color: rgba(255,255,255,0.7); font-size: 0.9rem; margin: 0;">
                                <strong>You can:</strong><br>
                                1. Download the captured video now<br>
                                2. Try again later when the server is back online<br>
                                3. Upload the downloaded video file directly
                            </p>
                        </div>
                        <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                            <button class="btn-primary" onclick="app.downloadCapturedVideo('${clipId}')" style="background: linear-gradient(135deg, #10b981, #059669);">
                                ⬇️ Download Video
                            </button>
                            <button class="btn-secondary" onclick="app.retryCapture()">🔄 Retry</button>
                            <button class="btn-secondary" onclick="app.closeDownloadModal()">Close</button>
                        </div>
                    </div>
                `;

                // Store the video data for download
                state.capturedVideoData = streamData;
            },

            // Download captured video directly to user's browser
            downloadCapturedVideo: function(clipId) {
                if (!state.capturedVideoData || !state.capturedVideoData.videoData) {
                    utils.showToast('No captured video data available', 'error');
                    return;
                }

                try {
                    // Convert base64 to blob
                    var base64 = state.capturedVideoData.videoData;
                    var mimeType = state.capturedVideoData.mimeType || 'video/webm';
                    var byteCharacters = atob(base64);
                    var byteArrays = [];

                    for (var i = 0; i < byteCharacters.length; i += 512) {
                        var slice = byteCharacters.slice(i, i + 512);
                        var byteNumbers = new Array(slice.length);
                        for (var j = 0; j < slice.length; j++) {
                            byteNumbers[j] = slice.charCodeAt(j);
                        }
                        byteArrays.push(new Uint8Array(byteNumbers));
                    }

                    var blob = new Blob(byteArrays, { type: mimeType });
                    var url = URL.createObjectURL(blob);

                    // Create download link
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = 'captured_clip_' + clipId + (mimeType.includes('webm') ? '.webm' : '.mp4');
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                    // Cleanup
                    setTimeout(function() {
                        URL.revokeObjectURL(url);
                    }, 1000);

                    utils.showToast('Video downloaded! You can upload it directly for processing.', 'success');

                } catch (error) {
                    console.error('[Video Wizard] Download failed:', error);
                    utils.showToast('Download failed: ' + error.message, 'error');
                }
            },

            openClipInYouTube: function() {
                if (!state.downloadModal) return;
                var info = state.downloadModal;

                if (!info.videoId) {
                    utils.showToast('Video ID not found', 'error');
                    return;
                }

                // Open YouTube at the specific timestamp
                var youtubeUrl = 'https://www.youtube.com/watch?v=' + info.videoId + '&t=' + info.startTime;
                window.open(youtubeUrl, '_blank');

                app.closeDownloadModal();
                utils.showToast('Opened in YouTube at ' + utils.formatDuration(info.startTime), 'success');
            },

            startVideoProcessing: async function() {
                if (!state.downloadModal) return;
                if (!state.projectId) {
                    utils.showToast('No project loaded', 'error');
                    return;
                }

                var info = state.downloadModal;
                var clipId = info.clipId;
                var quality = info.quality || '720p';
                var clipSettings = state.clipSettings[clipId] || {};

                // Pre-export validation for secondary source
                if (clipSettings.secondarySource && clipSettings.secondarySource.enabled) {
                    var sec = clipSettings.secondarySource;

                    // Check if source is properly configured
                    if (!sec.uploadedUrl && !sec.youtubeVideoId) {
                        utils.showToast('Secondary source is enabled but no video is configured. Please add a video or disable secondary source.', 'error');
                        return;
                    }

                    // Warn about YouTube secondary source reliability
                    if (sec.type === 'youtube' && sec.youtubeVideoId) {
                        var confirmed = confirm(
                            '⚠️ Secondary Source Warning\n\n' +
                            'Using a YouTube URL as secondary source may fail during export due to YouTube download restrictions.\n\n' +
                            'For more reliable results, consider uploading the video file directly instead.\n\n' +
                            'Do you want to continue anyway?'
                        );
                        if (!confirmed) {
                            return;
                        }
                    }

                    // Check if upload is still in progress
                    if (sec.uploading) {
                        utils.showToast('Please wait for the secondary video to finish uploading.', 'error');
                        return;
                    }

                    console.log('Secondary source validated:', sec.type, sec.uploadedUrl ? 'has URL' : sec.youtubeVideoId);
                }

                // Log settings being sent for debugging
                console.log('=== EXPORT SETTINGS DEBUG ===');
                console.log('Clip ID:', clipId);
                console.log('Quality:', quality);
                console.log('Reframe Mode:', clipSettings.reframeMode);
                console.log('CROP POSITION:', clipSettings.cropPosition, '(type:', typeof clipSettings.cropPosition, ')');
                console.log('Caption Style:', clipSettings.captionStyle);
                console.log('Secondary Source:', JSON.stringify(clipSettings.secondarySource, null, 2));
                console.log('Tertiary Source:', JSON.stringify(clipSettings.tertiarySource, null, 2));
                console.log('Audio Mix:', JSON.stringify(clipSettings.audioMix, null, 2));
                console.log('Full clipSettings (excluding large objects):', JSON.stringify({
                    reframeMode: clipSettings.reframeMode,
                    secondarySource: clipSettings.secondarySource ? {
                        enabled: clipSettings.secondarySource.enabled,
                        type: clipSettings.secondarySource.type,
                        youtubeVideoId: clipSettings.secondarySource.youtubeVideoId,
                        uploadedUrl: clipSettings.secondarySource.uploadedUrl ? 'HAS_URL' : null
                    } : null,
                    tertiarySource: clipSettings.tertiarySource ? {
                        enabled: clipSettings.tertiarySource.enabled,
                        type: clipSettings.tertiarySource.type,
                        youtubeVideoId: clipSettings.tertiarySource.youtubeVideoId,
                        uploadedUrl: clipSettings.tertiarySource.uploadedUrl ? 'HAS_URL' : null
                    } : null
                }, null, 2));
                console.log('=============================')

                // Get clip timing info
                var clip = state.clips.find(function(c) { return c.id === clipId; });
                var clipStartTime = clip ? clip.startTime : 0;
                var clipEndTime = clip ? clip.endTime : 60;

                // Check if this is an uploaded video
                var isUploadedVideo = state.videoInput.isUpload || false;

                // ===== EXTENSION-ONLY EXPORT =====
                // Export ONLY works via the browser extension capture/upload pipeline
                // No fallbacks, no server-side download, no alternative methods

                console.log('[EXPORT][EXT] extensionDetected=' + state.extension.installed);
                console.log('[EXPORT][EXT] isUploadedVideo=' + isUploadedVideo + ' clipStart=' + clipStartTime + ' clipEnd=' + clipEndTime);

                // For uploaded videos, proceed directly to backend (no extension capture needed)
                var extensionCaptureData = null;

                if (!isUploadedVideo) {
                    // HARD REQUIREMENT: Extension must be installed for YouTube video export
                    if (!state.extension.installed) {
                        console.error('[EXPORT][EXT] HARD FAIL: Extension not available');
                        app.showCaptureErrorInModal(
                            'Extension Not Available\n\n' +
                            'The YouTube Video Optimizer browser extension is required for exporting YouTube videos.\n\n' +
                            'Please install the extension and reload this page to continue.'
                        );
                        return;
                    }

                    // Get video ID
                    var videoId = state.videoInput.videoData?.videoId;
                    if (!videoId) {
                        console.error('[EXPORT][EXT] HARD FAIL: No video ID');
                        app.showCaptureErrorInModal(
                            'Video ID Not Found\n\n' +
                            'Could not determine the YouTube video ID.\n\n' +
                            'Please re-analyze the video and try again.'
                        );
                        return;
                    }

                    // Show capturing state
                    utils.showToast('Capturing video via extension...', 'info');
                    app.showCapturingStateInModal('Extension is capturing video...');

                    // Build capture request payload
                    var capturePayload = {
                        videoId: videoId,
                        youtubeUrl: state.videoInput.url || ('https://www.youtube.com/watch?v=' + videoId),
                        clipStart: clipStartTime,
                        clipEnd: clipEndTime,
                        quality: quality,
                        autoCapture: true
                    };

                    console.log('[EXPORT][EXT] sending captureVideoForWizard payload=' + JSON.stringify(capturePayload));

                    try {
                        // Call extension to capture video
                        var captureResult = await sendExtensionRequest('captureVideoForWizard', capturePayload);

                        console.log('[EXPORT][EXT] response received success=' + captureResult?.success + ' error=' + (captureResult?.error || 'none'));

                        // Check capture result
                        if (!captureResult || !captureResult.success) {
                            var errorMessage = captureResult?.error || 'Unknown capture error';
                            var errorCode = captureResult?.code || 'UNKNOWN';
                            console.error('[EXPORT][EXT] HARD FAIL: Capture failed - ' + errorMessage + ' (code: ' + errorCode + ')');

                            // Special handling for different error codes
                            if (errorCode === 'NO_YOUTUBE_TAB') {
                                var youtubeUrl = captureResult?.details?.youtubeUrl || ('https://www.youtube.com/watch?v=' + videoId);
                                var canAutoOpen = captureResult?.details?.canAutoOpen || false;

                                // Store capture params for auto-open retry
                                window.__pendingAutoCapture = {
                                    videoId: videoId,
                                    youtubeUrl: youtubeUrl,
                                    clipStart: clipStartTime,
                                    clipEnd: clipEndTime,
                                    quality: quality,
                                    sendExtensionRequest: sendExtensionRequest,
                                    handleCaptureSuccess: function(result) {
                                        // Continue with the export flow after auto-capture succeeds
                                        // This will be implemented below
                                    }
                                };

                                var autoOpenHtml = canAutoOpen
                                    ? '<button onclick="window.triggerAutoCapture()" style="display:block;width:100%;padding:14px 20px;background:linear-gradient(135deg,#22c55e,#16a34a);color:white;border:none;border-radius:8px;margin:15px 0;cursor:pointer;font-weight:bold;font-size:16px;box-shadow:0 2px 8px rgba(34,197,94,0.3);">✨ Auto-Capture Video</button><p style="font-size:12px;color:#888;margin:5px 0 15px;">Opens YouTube, captures video, and closes the tab automatically</p>'
                                    : '';

                                app.showCaptureErrorInModal(
                                    '<div style="text-align:center;">' +
                                    '<h3 style="margin:0 0 15px;color:#f59e0b;">⚠️ Video Tab Not Found</h3>' +
                                    '<p style="margin:0 0 20px;color:#666;">The YouTube video needs to be open for capture.</p>' +
                                    autoOpenHtml +
                                    '<div style="border-top:1px solid #e5e5e5;padding-top:15px;margin-top:10px;">' +
                                    '<p style="font-size:13px;color:#666;margin:0 0 10px;"><strong>Or open manually:</strong></p>' +
                                    '<a href="' + youtubeUrl + '" target="_blank" style="display:inline-block;padding:10px 20px;background:#ef4444;color:white;text-decoration:none;border-radius:5px;">Open on YouTube</a>' +
                                    '<p style="font-size:11px;color:#999;margin:10px 0 0;">Then return here and click Export again</p>' +
                                    '</div></div>'
                                );
                            } else if (errorCode === 'MEDIARECORDER_FAILED' || errorCode === 'CAPTURE_EXCEPTION') {
                                // MediaRecorder capture failed - usually DRM or playback issue
                                var youtubeUrl = 'https://www.youtube.com/watch?v=' + videoId;
                                app.showCaptureErrorInModal(
                                    'Video Capture Failed\n\n' +
                                    errorMessage + '\n\n' +
                                    'This can happen when:\n' +
                                    '• The video is not playing (click play first)\n' +
                                    '• The video has DRM protection\n' +
                                    '• The video tab is not active\n\n' +
                                    'Try this:\n' +
                                    '1. Open the video on YouTube\n' +
                                    '2. Make sure it\'s playing (even muted)\n' +
                                    '3. Come back here and try Export again\n\n' +
                                    '<a href="' + youtubeUrl + '" target="_blank" style="display:inline-block;padding:10px 20px;background:#ff0000;color:white;text-decoration:none;border-radius:5px;margin-top:10px;">Open on YouTube</a>'
                                );
                            } else {
                                app.showCaptureErrorInModal(
                                    'Extension Capture Failed\n\n' +
                                    errorMessage + '\n\n' +
                                    'Please ensure:\n' +
                                    '• The YouTube video is open and playing in another tab\n' +
                                    '• The video is not age-restricted or unavailable\n' +
                                    '• You have a stable internet connection'
                                );
                            }
                            return;
                        }

                        // Check for valid stream data
                        if (!captureResult.streamData) {
                            console.error('[EXPORT][EXT] HARD FAIL: No stream data returned');
                            app.showCaptureErrorInModal(
                                'Extension Capture Failed\n\n' +
                                'The extension captured the video but returned no data.\n\n' +
                                'Please try again or check extension logs for details.'
                            );
                            return;
                        }

                        // Check if uploaded to storage or has local data
                        var hasStorageUrl = captureResult.streamData.uploadedToStorage && captureResult.streamData.videoUrl;
                        var hasLocalData = captureResult.streamData.videoData;

                        console.log('[EXPORT][EXT] uploadedToStorage=' + !!hasStorageUrl + ' hasLocalData=' + !!hasLocalData);

                        if (!hasStorageUrl && !hasLocalData) {
                            console.error('[EXPORT][EXT] HARD FAIL: No video URL or data');
                            app.showCaptureErrorInModal(
                                'Extension Capture Failed\n\n' +
                                'Video was captured but could not be uploaded to storage.\n\n' +
                                'Upload error: ' + (captureResult.streamData.uploadError || 'Unknown')
                            );
                            return;
                        }

                        var storageUrl = captureResult.streamData.videoUrl;
                        var storagePath = captureResult.streamData.storagePath || null;

                        // If we have local data but no storage URL, upload to Firebase Storage from frontend
                        if (!hasStorageUrl && hasLocalData) {
                            console.log('[EXPORT][EXT] upload started - local data to Firebase Storage');
                            app.showCapturingStateInModal('Uploading captured video to storage...');

                            try {
                                // Convert base64 to blob
                                var base64Data = captureResult.streamData.videoData;
                                var mimeType = captureResult.streamData.mimeType || 'video/webm';
                                var byteCharacters = atob(base64Data);
                                var byteNumbers = new Array(byteCharacters.length);
                                for (var i = 0; i < byteCharacters.length; i++) {
                                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                                }
                                var byteArray = new Uint8Array(byteNumbers);
                                var videoBlob = new Blob([byteArray], { type: mimeType });

                                var blobSizeMB = videoBlob.size / 1024 / 1024;
                                console.log('[EXPORT][EXT] Created blob: ' + blobSizeMB.toFixed(2) + 'MB');

                                // Validate file size before upload (500MB limit)
                                var MAX_UPLOAD_SIZE = 500 * 1024 * 1024;
                                if (videoBlob.size > MAX_UPLOAD_SIZE) {
                                    throw new Error('Video too large (' + blobSizeMB.toFixed(1) + 'MB). Maximum size is 500MB. Try a shorter clip.');
                                }

                                // Check if user is authenticated
                                if (!auth.currentUser) {
                                    throw new Error('Please log in to upload videos.');
                                }

                                // Upload to Firebase Storage
                                // Use uploads/{userId}/ path which is guaranteed by storage rules
                                var timestamp = Date.now();
                                var ext = mimeType.includes('webm') ? 'webm' : 'mp4';
                                storagePath = 'uploads/' + auth.currentUser.uid + '/export_' + videoId + '_' + timestamp + '.' + ext;

                                var storageRef = storage.ref(storagePath);

                                // Upload with progress tracking
                                console.log('[EXPORT][EXT] Starting upload to:', storagePath);
                                var uploadTask = storageRef.put(videoBlob, {
                                    contentType: mimeType,
                                    customMetadata: {
                                        videoId: videoId,
                                        source: 'extension_export_upload',
                                        capturedAt: String(timestamp),
                                        userId: auth.currentUser.uid
                                    }
                                });

                                // Track upload progress
                                uploadTask.on('state_changed',
                                    function(snapshot) {
                                        var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                        console.log('[EXPORT][EXT] Upload progress: ' + progress.toFixed(1) + '%');
                                        app.showCapturingStateInModal('Uploading: ' + progress.toFixed(0) + '%');
                                    },
                                    function(error) {
                                        console.error('[EXPORT][EXT] Upload error:', error.code, error.message);
                                    }
                                );

                                await uploadTask;
                                storageUrl = await uploadTask.snapshot.ref.getDownloadURL();
                                console.log('[EXPORT][EXT] upload completed url=' + storageUrl);
                            } catch (uploadError) {
                                console.error('[EXPORT][EXT] HARD FAIL: Frontend upload failed - ' + uploadError.message);
                                // Provide specific error messages based on error type
                                var errorDetail = uploadError.message;
                                if (uploadError.code === 'storage/unauthorized') {
                                    errorDetail = 'Upload permission denied. Please ensure you are logged in and try again.';
                                } else if (uploadError.code === 'storage/canceled') {
                                    errorDetail = 'Upload was canceled.';
                                } else if (uploadError.code === 'storage/unknown') {
                                    errorDetail = 'Upload failed due to network error. Please check your connection and try again.';
                                }
                                app.showCaptureErrorInModal(
                                    'Upload Failed\n\n' +
                                    'Video was captured but could not be uploaded to storage.\n\n' +
                                    'Error: ' + errorDetail
                                );
                                return;
                            }
                        }

                        // Final validation
                        if (!storageUrl) {
                            console.error('[EXPORT][EXT] HARD FAIL: No storage URL after upload');
                            app.showCaptureErrorInModal(
                                'Upload Failed\n\n' +
                                'Could not obtain storage URL for the captured video.\n\n' +
                                'Please try again.'
                            );
                            return;
                        }

                        console.log('[EXPORT][EXT] Capture and upload successful, URL=' + storageUrl);

                        // Build extension capture data for backend
                        extensionCaptureData = captureResult;
                        extensionCaptureData.streamData.videoUrl = storageUrl;
                        extensionCaptureData.streamData.storagePath = storagePath;
                        extensionCaptureData.streamData.uploadedToStorage = true;

                    } catch (captureErr) {
                        console.error('[EXPORT][EXT] HARD FAIL: Exception - ' + captureErr.message);
                        app.showCaptureErrorInModal(
                            'Extension Capture Failed\n\n' +
                            captureErr.message + '\n\n' +
                            'Please check extension logs for more details.'
                        );
                        return;
                    }
                }
                // ===== END EXTENSION-ONLY EXPORT =====

                // ===== SECONDARY VIDEO CAPTURE (if YouTube URL) =====
                // Capture secondary YouTube videos via extension for reliable multi-source export
                // Server-side download (yt-dlp) often fails due to YouTube restrictions
                if (clipSettings.secondarySource &&
                    clipSettings.secondarySource.enabled &&
                    clipSettings.secondarySource.type === 'youtube' &&
                    clipSettings.secondarySource.youtubeVideoId &&
                    !clipSettings.secondarySource.uploadedUrl) {

                    console.log('[EXPORT][EXT] Secondary source is YouTube - capturing via extension');
                    var secVideoId = clipSettings.secondarySource.youtubeVideoId;
                    var secTimeOffset = clipSettings.secondarySource.timeOffset || 0;
                    var clipDuration = clipEndTime - clipStartTime;

                    utils.showToast('Capturing secondary video...', 'info');
                    app.showCapturingStateInModal('Capturing secondary video via extension...');

                    var secCapturePayload = {
                        videoId: secVideoId,
                        youtubeUrl: clipSettings.secondarySource.youtubeUrl || ('https://www.youtube.com/watch?v=' + secVideoId),
                        clipStart: secTimeOffset,
                        clipEnd: secTimeOffset + clipDuration,
                        quality: quality,
                        autoCapture: true,
                        autoOpenTab: true  // Auto-open YouTube tab for secondary video
                    };

                    console.log('[EXPORT][EXT] Secondary capture payload:', JSON.stringify(secCapturePayload));

                    try {
                        var secCaptureResult = await sendExtensionRequest('captureVideoForWizard', secCapturePayload);

                        console.log('[EXPORT][EXT] Secondary capture result: success=' + secCaptureResult?.success);

                        if (secCaptureResult && secCaptureResult.success && secCaptureResult.streamData) {
                            var secHasStorageUrl = secCaptureResult.streamData.uploadedToStorage && secCaptureResult.streamData.videoUrl;
                            var secHasLocalData = secCaptureResult.streamData.videoData;

                            var secStorageUrl = secCaptureResult.streamData.videoUrl;

                            // Upload local data to storage if needed
                            if (!secHasStorageUrl && secHasLocalData) {
                                console.log('[EXPORT][EXT] Uploading secondary video to storage...');
                                app.showCapturingStateInModal('Uploading secondary video...');

                                try {
                                    var secBase64Data = secCaptureResult.streamData.videoData;
                                    var secMimeType = secCaptureResult.streamData.mimeType || 'video/webm';
                                    var secByteCharacters = atob(secBase64Data);
                                    var secByteNumbers = new Array(secByteCharacters.length);
                                    for (var j = 0; j < secByteCharacters.length; j++) {
                                        secByteNumbers[j] = secByteCharacters.charCodeAt(j);
                                    }
                                    var secByteArray = new Uint8Array(secByteNumbers);
                                    var secVideoBlob = new Blob([secByteArray], { type: secMimeType });

                                    var secTimestamp = Date.now();
                                    var secExt = secMimeType.includes('webm') ? 'webm' : 'mp4';
                                    var secStoragePath = 'uploads/' + auth.currentUser.uid + '/secondary_' + secVideoId + '_' + secTimestamp + '.' + secExt;

                                    var secStorageRef = storage.ref(secStoragePath);
                                    var secUploadTask = secStorageRef.put(secVideoBlob, {
                                        contentType: secMimeType,
                                        customMetadata: {
                                            videoId: secVideoId,
                                            source: 'extension_secondary_upload',
                                            capturedAt: String(secTimestamp),
                                            userId: auth.currentUser.uid
                                        }
                                    });

                                    secUploadTask.on('state_changed', function(snapshot) {
                                        var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                        app.showCapturingStateInModal('Uploading secondary: ' + progress.toFixed(0) + '%');
                                    });

                                    await secUploadTask;
                                    secStorageUrl = await secUploadTask.snapshot.ref.getDownloadURL();
                                    console.log('[EXPORT][EXT] Secondary upload completed: ' + secStorageUrl);
                                } catch (secUploadErr) {
                                    console.error('[EXPORT][EXT] Secondary upload failed:', secUploadErr.message);
                                    // Continue without secondary - will fall back to server-side download
                                }
                            }

                            // Update clipSettings with the captured secondary video URL
                            if (secStorageUrl) {
                                console.log('[EXPORT][EXT] Secondary video captured successfully, updating settings');
                                clipSettings.secondarySource.uploadedUrl = secStorageUrl;
                                clipSettings.secondarySource.capturedViaExtension = true;
                            }
                        } else {
                            console.warn('[EXPORT][EXT] Secondary capture failed - will try server-side download');
                            console.warn('[EXPORT][EXT] Error:', secCaptureResult?.error || 'Unknown');
                            // Don't fail export - backend will try to download
                        }
                    } catch (secCaptureErr) {
                        console.error('[EXPORT][EXT] Secondary capture exception:', secCaptureErr.message);
                        // Don't fail export - backend will try to download
                    }
                }
                // ===== END SECONDARY VIDEO CAPTURE =====

                // ===== TERTIARY VIDEO CAPTURE (for three_person mode) =====
                // Capture tertiary YouTube videos via extension for reliable three-person export
                // Server-side download (yt-dlp) often fails due to YouTube restrictions
                if (clipSettings.tertiarySource &&
                    clipSettings.tertiarySource.enabled &&
                    clipSettings.tertiarySource.type === 'youtube' &&
                    clipSettings.tertiarySource.youtubeVideoId &&
                    !clipSettings.tertiarySource.uploadedUrl) {

                    console.log('[EXPORT][EXT] Tertiary source is YouTube - capturing via extension');
                    var tertVideoId = clipSettings.tertiarySource.youtubeVideoId;
                    var tertTimeOffset = clipSettings.tertiarySource.timeOffset || 0;
                    var clipDurationTert = clipEndTime - clipStartTime;

                    utils.showToast('Capturing third video...', 'info');
                    app.showCapturingStateInModal('Capturing third video via extension...');

                    var tertCapturePayload = {
                        videoId: tertVideoId,
                        youtubeUrl: clipSettings.tertiarySource.youtubeUrl || ('https://www.youtube.com/watch?v=' + tertVideoId),
                        clipStart: tertTimeOffset,
                        clipEnd: tertTimeOffset + clipDurationTert,
                        quality: quality,
                        autoCapture: true,
                        autoOpenTab: true
                    };

                    console.log('[EXPORT][EXT] Tertiary capture payload:', JSON.stringify(tertCapturePayload));

                    try {
                        var tertCaptureResult = await sendExtensionRequest('captureVideoForWizard', tertCapturePayload);

                        console.log('[EXPORT][EXT] Tertiary capture result: success=' + tertCaptureResult?.success);

                        if (tertCaptureResult && tertCaptureResult.success && tertCaptureResult.streamData) {
                            var tertHasStorageUrl = tertCaptureResult.streamData.uploadedToStorage && tertCaptureResult.streamData.videoUrl;
                            var tertHasLocalData = tertCaptureResult.streamData.videoData;

                            var tertStorageUrl = tertCaptureResult.streamData.videoUrl;

                            // Upload local data to storage if needed
                            if (!tertHasStorageUrl && tertHasLocalData) {
                                console.log('[EXPORT][EXT] Uploading tertiary video to storage...');
                                app.showCapturingStateInModal('Uploading third video...');

                                try {
                                    var tertBase64Data = tertCaptureResult.streamData.videoData;
                                    var tertMimeType = tertCaptureResult.streamData.mimeType || 'video/webm';
                                    var tertByteCharacters = atob(tertBase64Data);
                                    var tertByteNumbers = new Array(tertByteCharacters.length);
                                    for (var k = 0; k < tertByteCharacters.length; k++) {
                                        tertByteNumbers[k] = tertByteCharacters.charCodeAt(k);
                                    }
                                    var tertByteArray = new Uint8Array(tertByteNumbers);
                                    var tertVideoBlob = new Blob([tertByteArray], { type: tertMimeType });

                                    var tertTimestamp = Date.now();
                                    var tertExt = tertMimeType.includes('webm') ? 'webm' : 'mp4';
                                    var tertStoragePath = 'uploads/' + auth.currentUser.uid + '/tertiary_' + tertVideoId + '_' + tertTimestamp + '.' + tertExt;

                                    var tertStorageRef = storage.ref(tertStoragePath);
                                    var tertUploadTask = tertStorageRef.put(tertVideoBlob, {
                                        contentType: tertMimeType,
                                        customMetadata: {
                                            videoId: tertVideoId,
                                            source: 'extension_tertiary_upload',
                                            capturedAt: String(tertTimestamp),
                                            userId: auth.currentUser.uid
                                        }
                                    });

                                    tertUploadTask.on('state_changed', function(snapshot) {
                                        var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                        app.showCapturingStateInModal('Uploading third video: ' + progress.toFixed(0) + '%');
                                    });

                                    await tertUploadTask;
                                    tertStorageUrl = await tertUploadTask.snapshot.ref.getDownloadURL();
                                    console.log('[EXPORT][EXT] Tertiary upload completed: ' + tertStorageUrl);
                                } catch (tertUploadErr) {
                                    console.error('[EXPORT][EXT] Tertiary upload failed:', tertUploadErr.message);
                                }
                            }

                            // Update clipSettings with the captured tertiary video URL
                            if (tertStorageUrl) {
                                console.log('[EXPORT][EXT] Tertiary video captured successfully, updating settings');
                                console.log('[EXPORT][EXT] Tertiary URL:', tertStorageUrl.substring(0, 80) + '...');
                                clipSettings.tertiarySource.uploadedUrl = tertStorageUrl;
                                clipSettings.tertiarySource.capturedViaExtension = true;
                                console.log('[EXPORT][EXT] Tertiary state after update:', JSON.stringify({
                                    enabled: clipSettings.tertiarySource.enabled,
                                    type: clipSettings.tertiarySource.type,
                                    youtubeVideoId: clipSettings.tertiarySource.youtubeVideoId,
                                    uploadedUrl: clipSettings.tertiarySource.uploadedUrl ? 'SET' : 'NOT SET'
                                }));
                            } else {
                                console.error('[EXPORT][EXT] Tertiary capture succeeded but NO URL returned!');
                                console.error('[EXPORT][EXT] tertHasStorageUrl:', tertHasStorageUrl);
                                console.error('[EXPORT][EXT] tertHasLocalData:', tertHasLocalData);
                            }
                        } else {
                            console.warn('[EXPORT][EXT] Tertiary capture failed');
                            console.warn('[EXPORT][EXT] Error:', tertCaptureResult?.error || 'Unknown');
                            console.warn('[EXPORT][EXT] Full result:', JSON.stringify(tertCaptureResult, null, 2));
                        }
                    } catch (tertCaptureErr) {
                        console.error('[EXPORT][EXT] Tertiary capture exception:', tertCaptureErr.message);
                    }
                }
                // ===== END TERTIARY VIDEO CAPTURE =====

                // ===== POST-CAPTURE DEBUG LOGGING =====
                // Log the FINAL state of settings being sent to backend AFTER all captures
                console.log('=== POST-CAPTURE SETTINGS DEBUG ===');
                console.log('[POST-CAPTURE] reframeMode:', clipSettings.reframeMode);
                console.log('[POST-CAPTURE] PRIMARY source:', state.videoInput.isUpload ? 'upload' : 'youtube');
                console.log('[POST-CAPTURE] SECONDARY enabled:', clipSettings.secondarySource?.enabled);
                console.log('[POST-CAPTURE] SECONDARY type:', clipSettings.secondarySource?.type);
                console.log('[POST-CAPTURE] SECONDARY youtubeVideoId:', clipSettings.secondarySource?.youtubeVideoId);
                console.log('[POST-CAPTURE] SECONDARY uploadedUrl:', clipSettings.secondarySource?.uploadedUrl ? 'SET (' + clipSettings.secondarySource.uploadedUrl.substring(0, 60) + '...)' : 'NOT SET');
                console.log('[POST-CAPTURE] TERTIARY enabled:', clipSettings.tertiarySource?.enabled);
                console.log('[POST-CAPTURE] TERTIARY type:', clipSettings.tertiarySource?.type);
                console.log('[POST-CAPTURE] TERTIARY youtubeVideoId:', clipSettings.tertiarySource?.youtubeVideoId);
                console.log('[POST-CAPTURE] TERTIARY uploadedUrl:', clipSettings.tertiarySource?.uploadedUrl ? 'SET (' + clipSettings.tertiarySource.uploadedUrl.substring(0, 60) + '...)' : 'NOT SET');
                console.log('[POST-CAPTURE] All three sources for three_person?:',
                    (clipSettings.reframeMode === 'three_person') + ' && ' +
                    (!!clipSettings.secondarySource?.enabled && !!(clipSettings.secondarySource?.uploadedUrl || clipSettings.secondarySource?.youtubeVideoId)) + ' && ' +
                    (!!clipSettings.tertiarySource?.enabled && !!(clipSettings.tertiarySource?.uploadedUrl || clipSettings.tertiarySource?.youtubeVideoId))
                );
                console.log('===================================');
                // ===== END POST-CAPTURE DEBUG LOGGING =====

                // Show processing state
                utils.showToast('Starting video processing...', 'info');
                app.showCapturingStateInModal('Sending to processor...');

                try {
                    // Call backend - pass extensionCaptureData if we captured at export time
                    var wizardProcessClip = functions.httpsCallable('wizardProcessClip');
                    var requestData = {
                        projectId: state.projectId,
                        clipId: clipId,
                        quality: quality,
                        settings: clipSettings
                    };

                    // Include fallback capture data if we captured at export time
                    if (extensionCaptureData) {
                        requestData.extensionCaptureData = extensionCaptureData;
                    }

                    var result = await wizardProcessClip(requestData);

                    if (result.data.success) {
                        // Store job info
                        if (!state.processingJobs) {
                            state.processingJobs = {};
                        }
                        state.processingJobs[clipId] = {
                            jobId: result.data.jobId,
                            status: 'queued',
                            quality: quality
                        };

                        app.closeDownloadModal();

                        // Show persistent processing toast
                        app.showProcessingToast(clipId);

                        // Start polling for status
                        app.pollProcessingStatus(clipId, result.data.jobId);
                    } else {
                        throw new Error(result.data.error || 'Failed to start processing');
                    }
                } catch (error) {
                    console.error('Video processing error:', error);

                    // Handle specific error types with better messages
                    var errorMessage = error.message || 'Failed to start processing';

                    // Check for 'failed-precondition' error (sourceAsset missing)
                    if (error.code === 'failed-precondition' || errorMessage.includes('Video source not available')) {
                        app.showCaptureErrorInModal(
                            'Video source not available.\n\n' +
                            'The video capture may have failed. Please try:\n' +
                            '• Re-analyzing the video\n' +
                            '• Using an uploaded video file instead\n' +
                            '• Checking if the browser extension is installed'
                        );
                    } else {
                        // Generic error
                        app.closeDownloadModal();
                        utils.showToast('Export Error: ' + errorMessage, 'error');
                    }
                }
            },

            showProcessingToast: function(clipId) {
                // Remove any existing processing toast
                var existing = document.querySelector('.processing-toast');
                if (existing) existing.remove();

                var clip = state.clips.find(function(c) { return c.id === clipId; });
                var clipName = clip ? (clip.aiSummary || 'Clip').substring(0, 30) : 'Clip';

                var toastHtml = '<div class="processing-toast" id="processing-toast-' + clipId + '">';
                toastHtml += '<div class="processing-toast-spinner"></div>';
                toastHtml += '<div class="processing-toast-content">';
                toastHtml += '<div class="processing-toast-title">🎬 Processing Video</div>';
                toastHtml += '<div class="processing-toast-progress" id="processing-progress-' + clipId + '">Starting... 0%</div>';
                toastHtml += '</div>';
                toastHtml += '<button class="processing-toast-close" onclick="this.parentElement.remove()">×</button>';
                toastHtml += '</div>';

                document.body.insertAdjacentHTML('beforeend', toastHtml);
            },

            updateProcessingToast: function(clipId, progress, status) {
                var progressEl = document.getElementById('processing-progress-' + clipId);
                if (progressEl) {
                    var statusText = status === 'processing' ? 'Processing' : (status === 'queued' ? 'In queue' : status);
                    progressEl.textContent = statusText + '... ' + (progress || 0) + '%';
                }
            },

            removeProcessingToast: function(clipId) {
                var toast = document.getElementById('processing-toast-' + clipId);
                if (toast) toast.remove();
            },

            pollProcessingStatus: async function(clipId, jobId) {
                // Poll every 5 seconds for status updates (more frequent for better UX)
                var pollInterval = setInterval(async function() {
                    try {
                        var wizardGetProcessingStatus = functions.httpsCallable('wizardGetProcessingStatus');
                        var result = await wizardGetProcessingStatus({ jobId: jobId });

                        if (result.data.success) {
                            var job = result.data.job;

                            if (state.processingJobs && state.processingJobs[clipId]) {
                                state.processingJobs[clipId].status = job.status;
                                state.processingJobs[clipId].progress = job.progress;
                            }

                            // Update the processing toast
                            app.updateProcessingToast(clipId, job.progress, job.status);

                            if (job.status === 'completed') {
                                clearInterval(pollInterval);
                                app.removeProcessingToast(clipId);

                                // DEBUG: Log state when processing completes
                                console.log('[pollProcessingStatus] COMPLETED - All clip settings:', JSON.parse(JSON.stringify(state.clipSettings)));

                                if (job.outputUrl) {
                                    utils.showToast('🎉 Video ready!', 'success');
                                    // Show download options modal
                                    app.showDownloadReadyModal(clipId, job.outputUrl);
                                } else {
                                    utils.showToast('Video processed but download not available yet.', 'info');
                                }
                            } else if (job.status === 'failed') {
                                clearInterval(pollInterval);
                                app.removeProcessingToast(clipId);
                                utils.showToast('Processing failed: ' + (job.error || 'Unknown error'), 'error');
                            }
                        }
                    } catch (error) {
                        console.error('Poll status error:', error);
                    }
                }, 5000); // 5 second interval for better UX

                // Stop polling after 10 minutes
                setTimeout(function() {
                    clearInterval(pollInterval);
                }, 600000);
            },

            // Show modal with download options when video is ready
            showDownloadReadyModal: function(clipId, outputUrl) {
                var clip = state.clips.find(function(c) { return c.id === clipId; });
                var clipName = clip ? 'Clip ' + (state.clips.indexOf(clip) + 1) : 'Video';

                var modalHtml = '<div class="download-ready-modal" onclick="app.closeDownloadReadyModal(event)">';
                modalHtml += '<div class="download-ready-content" onclick="event.stopPropagation()">';
                modalHtml += '<button class="download-ready-close" onclick="app.closeDownloadReadyModal()">×</button>';
                modalHtml += '<div class="download-ready-icon">🎉</div>';
                modalHtml += '<h3>Video Ready!</h3>';
                modalHtml += '<p style="color: rgba(255,255,255,0.7); margin-bottom: 1.5rem;">' + clipName + ' has been processed successfully.</p>';
                modalHtml += '<div class="download-ready-actions">';
                modalHtml += '<button class="download-btn-primary" onclick="app.directDownloadVideo(\'' + outputUrl + '\', \'' + clipId + '\')">';
                modalHtml += '<span class="download-btn-icon">📥</span>';
                modalHtml += '<span>Download to Device</span>';
                modalHtml += '</button>';
                modalHtml += '<button class="download-btn-secondary" onclick="window.open(\'' + outputUrl + '\', \'_blank\'); app.closeDownloadReadyModal();">';
                modalHtml += '<span class="download-btn-icon">🔗</span>';
                modalHtml += '<span>Open in New Tab</span>';
                modalHtml += '</button>';
                modalHtml += '</div>';
                modalHtml += '</div>';
                modalHtml += '</div>';

                document.body.insertAdjacentHTML('beforeend', modalHtml);
            },

            closeDownloadReadyModal: function(event) {
                var modal = document.querySelector('.download-ready-modal');
                if (modal) modal.remove();
            },

            // Direct download video file to device
            directDownloadVideo: async function(url, clipId) {
                utils.showToast('Starting download...', 'info');

                try {
                    // Fetch the video as blob
                    var response = await fetch(url);
                    if (!response.ok) throw new Error('Failed to fetch video');

                    var blob = await response.blob();

                    // Create download link
                    var downloadUrl = URL.createObjectURL(blob);
                    var link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = 'video-clip-' + clipId + '.mp4';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // Cleanup
                    URL.revokeObjectURL(downloadUrl);

                    utils.showToast('Download started!', 'success');
                    app.closeDownloadReadyModal();
                } catch (error) {
                    console.error('Direct download error:', error);
                    // Fallback to opening in new tab
                    utils.showToast('Direct download failed, opening in new tab...', 'info');
                    window.open(url, '_blank');
                }
            },

            downloadThumbnail: function(clipId, index) {
                var thumbnails = state.clipThumbnails[clipId];

                // If index not provided, use the user's selected thumbnail
                if (index === undefined) {
                    index = state.selectedThumbnail[clipId];
                }

                var url = null;
                var filename = 'thumbnail-' + clipId + '.png';

                // Try to get AI-generated thumbnail
                if (thumbnails && thumbnails[index]) {
                    var thumbnail = thumbnails[index];
                    url = thumbnail.previewUrl || thumbnail.url || thumbnail;
                    filename = 'thumbnail-' + clipId + '-ai-' + (index + 1) + '.png';
                }

                // Fallback to original clip thumbnail
                if (!url) {
                    var clip = state.clips.find(function(c) { return c.id === clipId; });
                    if (clip && clip.thumbnail) {
                        url = clip.thumbnail;
                        filename = 'thumbnail-' + clipId + '-original.jpg';
                    }
                }

                if (!url) {
                    utils.showToast('No thumbnail available. Generate AI thumbnails in SEO & Thumbnails step.', 'info');
                    return;
                }

                // If it's a Firebase Storage URL or external URL, download it
                if (url.startsWith('http')) {
                    var link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    utils.showToast('Downloading thumbnail...', 'success');
                } else {
                    utils.showToast('Thumbnail not ready for download', 'info');
                }
            },

            copySEO: function(clipId) {
                var clip = state.clips.find(function(c) { return c.id === clipId; });
                var seo = state.clipSEO[clipId] || getDefaultSEO(clip);
                var text = 'Title: ' + seo.title + '\n\nDescription:\n' + seo.description + '\n\nTags: ' + seo.tags.join(', ');
                navigator.clipboard.writeText(text);
                utils.showToast('SEO copied to clipboard!', 'success');
            },

            /**
             * Export all selected clips with SEQUENTIAL capture and FAIL-FAST behavior
             * Captures one clip at a time (browser extension limitation)
             * Stops immediately if any error occurs to prevent server flooding
             */
            exportAllClipsParallel: async function() {
                if (!state.projectId) {
                    utils.showToast('No project loaded', 'error');
                    return;
                }

                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });

                if (selectedClips.length === 0) {
                    utils.showToast('No clips selected for export', 'error');
                    return;
                }

                console.log('[BatchExport] Starting sequential export for ' + selectedClips.length + ' clips');

                // Check for extension (required for YouTube videos)
                var isUploadedVideo = state.videoInput.isUpload || false;
                if (!isUploadedVideo && !state.extension.installed) {
                    utils.showToast('Browser extension required for YouTube video export', 'error');
                    return;
                }

                // Create batch export document in Firestore for persistence/resume
                var batchId = null;
                try {
                    var wizardCreateBatchExport = firebase.functions().httpsCallable('wizardCreateBatchExport');
                    var batchResult = await wizardCreateBatchExport({
                        projectId: state.projectId,
                        clips: selectedClips.map(function(c) {
                            return { clipId: c.id, title: c.title || c.summary || 'Clip' };
                        })
                    });
                    if (batchResult.data.success) {
                        batchId = batchResult.data.batchId;
                        console.log('[BatchExport] Created batch export document:', batchId);
                    }
                } catch (batchErr) {
                    console.warn('[BatchExport] Could not create batch document (export will continue):', batchErr);
                }

                // Initialize export state with abort capability
                state.parallelExport = {
                    active: true,
                    aborted: false,
                    batchId: batchId,  // Store batchId for persistence
                    startTime: Date.now(),
                    totalClips: selectedClips.length,
                    completedClips: 0,
                    failedClips: 0,
                    currentClipIndex: 0,
                    clips: {},
                    consoleLogs: []  // Console-like log messages
                };

                // Helper to add console log entries
                app.addBatchExportLog = function(message, type) {
                    if (!state.parallelExport) return;
                    var timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
                    state.parallelExport.consoleLogs.push({
                        timestamp: timestamp,
                        message: message,
                        type: type || 'info'  // info, success, error, warning
                    });
                    // Keep only last 100 logs
                    if (state.parallelExport.consoleLogs.length > 100) {
                        state.parallelExport.consoleLogs.shift();
                    }
                    app.updateBatchExportModal();
                };

                app.addBatchExportLog('Starting batch export for ' + selectedClips.length + ' clips...', 'info');

                // Initialize state for each clip
                selectedClips.forEach(function(clip) {
                    state.parallelExport.clips[clip.id] = {
                        status: 'pending',
                        progress: 0,
                        jobId: null,
                        outputUrl: null,
                        error: null
                    };
                });

                // Show progress UI
                app.showParallelExportProgress();

                // Disable the export button and show cancel option
                var exportBtn = document.querySelector('.parallel-export-btn');
                if (exportBtn) {
                    exportBtn.disabled = true;
                    exportBtn.textContent = '⏳ Processing... (Click to Cancel)';
                    exportBtn.onclick = function() {
                        state.parallelExport.aborted = true;
                        utils.showToast('Cancelling export...', 'warning');
                    };
                }

                // Process clips SEQUENTIALLY with FAIL-FAST
                var hasError = false;
                for (var i = 0; i < selectedClips.length; i++) {
                    // Check if aborted
                    if (state.parallelExport.aborted) {
                        console.log('[BatchExport] Export aborted by user');
                        utils.showToast('Export cancelled', 'warning');
                        break;
                    }

                    state.parallelExport.currentClipIndex = i;
                    var clip = selectedClips[i];

                    console.log('[BatchExport] Processing clip ' + (i + 1) + '/' + selectedClips.length + ': ' + clip.id);

                    try {
                        await app.exportSingleClipForParallel(clip.id);

                        // Check if this clip failed
                        if (state.parallelExport.clips[clip.id].status === 'error') {
                            hasError = true;
                            console.error('[BatchExport] FAIL-FAST: Clip ' + clip.id + ' failed, stopping export');
                            utils.showToast('Export stopped: ' + (state.parallelExport.clips[clip.id].error || 'Unknown error'), 'error');
                            break;
                        }
                    } catch (error) {
                        hasError = true;
                        console.error('[BatchExport] FAIL-FAST: Error on clip ' + clip.id + ':', error);
                        state.parallelExport.clips[clip.id].status = 'error';
                        state.parallelExport.clips[clip.id].error = error.message;
                        state.parallelExport.failedClips++;
                        utils.showToast('Export stopped: ' + error.message, 'error');
                        break;
                    }
                }

                // Final status
                var completedCount = state.parallelExport.completedClips;
                var failedCount = state.parallelExport.failedClips;
                var elapsedTime = ((Date.now() - state.parallelExport.startTime) / 1000).toFixed(1);

                if (!hasError && !state.parallelExport.aborted && completedCount > 0) {
                    console.log('[BatchExport] All exports completed successfully');
                    utils.showToast('All ' + completedCount + ' clips exported in ' + elapsedTime + 's!', 'success');
                } else if (completedCount > 0) {
                    console.log('[BatchExport] Partial completion: ' + completedCount + ' succeeded, ' + failedCount + ' failed');
                }

                // CRITICAL: Set active to false BEFORE updating UI so modal shows completion state
                state.parallelExport.active = false;

                // Update progress UI to show completion
                app.updateParallelExportComplete();

                // Re-enable the export button
                if (exportBtn) {
                    exportBtn.disabled = false;
                    exportBtn.textContent = '🎬 Export All ' + selectedClips.length + ' Clips Now';
                    exportBtn.onclick = function() { app.exportAllClipsParallel(); };
                }
            },

            /**
             * Export a single clip as part of parallel processing
             */
            exportSingleClipForParallel: async function(clipId) {
                console.log('[ParallelExport] Starting export for clip: ' + clipId);

                var clip = state.clips.find(function(c) { return c.id === clipId; });
                var seo = state.clipSEO[clipId] || {};
                var clipTitle = (seo.title || 'Clip ' + clipId).substring(0, 30);

                app.addBatchExportLog('Starting: ' + clipTitle, 'info');

                if (!clip) {
                    state.parallelExport.clips[clipId].status = 'error';
                    state.parallelExport.clips[clipId].error = 'Clip not found';
                    state.parallelExport.failedClips++;
                    app.addBatchExportLog('Error: Clip not found - ' + clipId, 'error');
                    app.updateParallelExportProgress();
                    return;
                }

                // Update status to capturing
                state.parallelExport.clips[clipId].status = 'capturing';
                app.addBatchExportLog('Capturing video segment (' + clip.startTime.toFixed(1) + 's - ' + clip.endTime.toFixed(1) + 's)...', 'info');
                app.updateParallelExportProgress();

                var clipSettings = state.clipSettings[clipId] || {};
                var isUploadedVideo = state.videoInput.isUpload || false;
                var videoId = state.videoInput.videoData?.videoId;
                var quality = '720p';

                try {
                    var capturedUrl = null;
                    var storagePath = null;

                    if (!isUploadedVideo) {
                        // Capture video via extension
                        var capturePayload = {
                            videoId: videoId,
                            youtubeUrl: state.videoInput.url || ('https://www.youtube.com/watch?v=' + videoId),
                            clipStart: clip.startTime,
                            clipEnd: clip.endTime,
                            quality: quality,
                            autoCapture: true
                        };

                        var captureResult = await sendExtensionRequest('captureVideoForWizard', capturePayload);

                        if (!captureResult || !captureResult.success) {
                            throw new Error(captureResult?.error || 'Capture failed');
                        }

                        if (captureResult.streamData && captureResult.streamData.videoUrl) {
                            capturedUrl = captureResult.streamData.videoUrl;
                            storagePath = captureResult.streamData.storagePath;
                        } else if (captureResult.streamData && captureResult.streamData.videoData) {
                            // Upload to Firebase Storage
                            var base64Data = captureResult.streamData.videoData;
                            var mimeType = captureResult.streamData.mimeType || 'video/webm';
                            var byteCharacters = atob(base64Data);
                            var byteNumbers = new Array(byteCharacters.length);
                            for (var i = 0; i < byteCharacters.length; i++) {
                                byteNumbers[i] = byteCharacters.charCodeAt(i);
                            }
                            var byteArray = new Uint8Array(byteNumbers);
                            var videoBlob = new Blob([byteArray], { type: mimeType });

                            var timestamp = Date.now();
                            var ext = mimeType.includes('webm') ? 'webm' : 'mp4';
                            storagePath = 'uploads/' + auth.currentUser.uid + '/parallel_' + clipId + '_' + timestamp + '.' + ext;

                            var storageRef = storage.ref(storagePath);
                            await storageRef.put(videoBlob, {
                                contentType: mimeType,
                                customMetadata: { source: 'parallel_export' }
                            });
                            capturedUrl = await storageRef.getDownloadURL();
                        } else {
                            throw new Error('No video data from capture');
                        }
                    } else {
                        // Use uploaded video URL
                        capturedUrl = state.videoInput.videoData?.uploadedUrl || state.videoInput.videoData?.sourceUrl;
                    }

                    // Update status to processing
                    state.parallelExport.clips[clipId].status = 'processing';
                    app.addBatchExportLog('Video captured, sending to server for processing...', 'info');
                    app.updateParallelExportProgress();

                    // Create processing job - use wizardProcessClip (correct function name)
                    var wizardProcessClip = functions.httpsCallable('wizardProcessClip');
                    var jobPayload = {
                        projectId: state.projectId,
                        clipId: clipId,
                        quality: quality,
                        settings: {
                            ...clipSettings,
                            startTime: clip.startTime,
                            endTime: clip.endTime,
                            cropPosition: clipSettings.cropPosition !== undefined ? clipSettings.cropPosition : 50
                        },
                        // Pass captured video as extensionCaptureData for fallback
                        extensionCaptureData: capturedUrl ? {
                            streamData: {
                                videoUrl: capturedUrl,
                                storagePath: storagePath,
                                uploadedToStorage: true
                            }
                        } : null
                    };

                    var result = await wizardProcessClip(jobPayload);

                    if (!result.data.success) {
                        throw new Error(result.data.message || 'Failed to start processing');
                    }

                    var jobId = result.data.jobId;
                    state.parallelExport.clips[clipId].jobId = jobId;
                    app.addBatchExportLog('Processing job started (Job ID: ' + jobId.substring(0, 8) + '...)', 'info');
                    // Update batch export document with job ID
                    app.updateBatchExportClip(clipId, { jobId: jobId, status: 'processing' });

                    // Poll for completion
                    await app.pollParallelExportJob(clipId, jobId, clipTitle);

                } catch (error) {
                    console.error('[BatchExport] Error exporting clip ' + clipId + ':', error);
                    state.parallelExport.clips[clipId].status = 'error';
                    state.parallelExport.clips[clipId].error = error.message;
                    state.parallelExport.failedClips++;
                    app.addBatchExportLog('Error: ' + error.message, 'error');
                    app.updateParallelExportProgress();
                    // Update batch export document
                    app.updateBatchExportClip(clipId, { status: 'error', error: error.message });
                    // Re-throw to trigger fail-fast in parent
                    throw error;
                }
            },

            /**
             * Poll for parallel export job completion
             */
            pollParallelExportJob: function(clipId, jobId, clipTitle) {
                return new Promise(function(resolve, reject) {
                    var pollCount = 0;
                    var maxPolls = 180; // 15 minutes max (5 second intervals)
                    var lastLoggedProgress = 0;

                    var pollInterval = setInterval(async function() {
                        pollCount++;

                        try {
                            var wizardGetProcessingStatus = functions.httpsCallable('wizardGetProcessingStatus');
                            var result = await wizardGetProcessingStatus({ jobId: jobId });

                            if (result.data.success) {
                                var job = result.data.job;
                                var currentProgress = job.progress || 0;
                                state.parallelExport.clips[clipId].progress = currentProgress;

                                // Log progress at 25%, 50%, 75% milestones
                                if (currentProgress >= 25 && lastLoggedProgress < 25) {
                                    app.addBatchExportLog('Progress: 25% - Downloading source video...', 'info');
                                    lastLoggedProgress = 25;
                                } else if (currentProgress >= 50 && lastLoggedProgress < 50) {
                                    app.addBatchExportLog('Progress: 50% - Transcoding video...', 'info');
                                    lastLoggedProgress = 50;
                                } else if (currentProgress >= 75 && lastLoggedProgress < 75) {
                                    app.addBatchExportLog('Progress: 75% - Applying filters & encoding...', 'info');
                                    lastLoggedProgress = 75;
                                }
                                app.updateParallelExportProgress();

                                if (job.status === 'completed') {
                                    clearInterval(pollInterval);
                                    state.parallelExport.clips[clipId].status = 'completed';
                                    state.parallelExport.clips[clipId].outputUrl = job.outputUrl;
                                    state.parallelExport.completedClips++;
                                    app.addBatchExportLog('✓ Completed: ' + (clipTitle || 'Clip') + ' - Ready for download!', 'success');
                                    app.updateParallelExportProgress();
                                    // Update batch export document
                                    app.updateBatchExportClip(clipId, { status: 'completed', outputUrl: job.outputUrl });
                                    resolve();
                                } else if (job.status === 'failed') {
                                    clearInterval(pollInterval);
                                    state.parallelExport.clips[clipId].status = 'error';
                                    state.parallelExport.clips[clipId].error = job.error || 'Processing failed';
                                    state.parallelExport.failedClips++;
                                    app.addBatchExportLog('✗ Failed: ' + (clipTitle || 'Clip') + ' - ' + (job.error || 'Processing failed'), 'error');
                                    app.updateParallelExportProgress();
                                    // Update batch export document
                                    app.updateBatchExportClip(clipId, { status: 'error', error: job.error || 'Processing failed' });
                                    resolve(); // Don't reject, allow other clips to continue
                                }
                            }
                        } catch (e) {
                            console.error('[ParallelExport] Poll error:', e);
                        }

                        if (pollCount >= maxPolls) {
                            clearInterval(pollInterval);
                            state.parallelExport.clips[clipId].status = 'error';
                            state.parallelExport.clips[clipId].error = 'Timeout';
                            state.parallelExport.failedClips++;
                            app.addBatchExportLog('✗ Timeout: ' + (clipTitle || 'Clip') + ' - Processing took too long', 'error');
                            app.updateParallelExportProgress();
                            // Update batch export document
                            app.updateBatchExportClip(clipId, { status: 'error', error: 'Timeout - processing took too long' });
                            resolve();
                        }
                    }, 5000); // Poll every 5 seconds
                });
            },

            /**
             * Show the batch export modal overlay
             */
            showParallelExportProgress: function() {
                // Remove any existing modal
                var existingModal = document.getElementById('batchExportModal');
                if (existingModal) existingModal.remove();

                // Create modal overlay
                var overlay = document.createElement('div');
                overlay.id = 'batchExportModal';
                overlay.className = 'batch-export-modal-overlay';
                overlay.innerHTML = app.buildBatchExportModalHTML();
                document.body.appendChild(overlay);

                // Scroll console to bottom
                var consoleBody = document.getElementById('batchExportConsole');
                if (consoleBody) consoleBody.scrollTop = consoleBody.scrollHeight;
            },

            /**
             * Build the batch export modal HTML
             */
            buildBatchExportModalHTML: function() {
                if (!state.parallelExport) return '';

                var clips = state.parallelExport.clips;
                var completed = state.parallelExport.completedClips;
                var failed = state.parallelExport.failedClips;
                var total = state.parallelExport.totalClips;
                var pending = total - completed - failed;
                var processing = 0;
                var elapsed = ((Date.now() - state.parallelExport.startTime) / 1000).toFixed(0);
                var isComplete = !state.parallelExport.active;

                // Count processing clips
                for (var cid in clips) {
                    if (clips[cid].status === 'capturing' || clips[cid].status === 'processing') {
                        processing++;
                        pending--;
                    }
                }

                var html = '<div class="batch-export-modal">';

                // Header
                html += '<div class="batch-export-modal-header">';
                html += '<div class="batch-export-modal-title">';
                if (!isComplete) {
                    html += '<div class="spinner"></div>';
                }
                html += isComplete ? '🎉 Export Complete' : '🎬 Batch Export in Progress';
                html += '</div>';
                if (isComplete) {
                    html += '<button class="batch-export-modal-close" onclick="app.closeBatchExportModal()">✕</button>';
                }
                html += '</div>';

                // Body
                html += '<div class="batch-export-modal-body">';

                // Complete banner (only show when done)
                if (isComplete && completed > 0) {
                    html += '<div class="batch-export-complete-banner">';
                    html += '<h3>🎉 All Done!</h3>';
                    html += '<p>' + completed + ' clip' + (completed !== 1 ? 's' : '') + ' exported successfully in ' + elapsed + ' seconds</p>';
                    if (failed > 0) {
                        html += '<p style="color: #ef4444;">' + failed + ' clip' + (failed !== 1 ? 's' : '') + ' failed</p>';
                    }
                    html += '</div>';
                }

                // Stats grid
                html += '<div class="batch-export-stats">';
                html += '<div class="batch-export-stat"><div class="batch-export-stat-value">' + completed + '</div><div class="batch-export-stat-label">Completed</div></div>';
                html += '<div class="batch-export-stat"><div class="batch-export-stat-value processing">' + processing + '</div><div class="batch-export-stat-label">Processing</div></div>';
                html += '<div class="batch-export-stat"><div class="batch-export-stat-value pending">' + pending + '</div><div class="batch-export-stat-label">Pending</div></div>';
                html += '<div class="batch-export-stat"><div class="batch-export-stat-value error">' + failed + '</div><div class="batch-export-stat-label">Failed</div></div>';
                html += '</div>';

                // Console log area
                html += '<div class="batch-export-console">';
                html += '<div class="batch-export-console-header">';
                html += '<div class="console-dot red"></div>';
                html += '<div class="console-dot yellow"></div>';
                html += '<div class="console-dot green"></div>';
                html += '<span>Export Log</span>';
                html += '</div>';
                html += '<div class="batch-export-console-body" id="batchExportConsole">';

                // Add log entries
                var logs = state.parallelExport.consoleLogs || [];
                for (var i = 0; i < logs.length; i++) {
                    var log = logs[i];
                    html += '<div class="console-line">';
                    html += '<span class="console-timestamp">[' + log.timestamp + ']</span>';
                    html += '<span class="console-message ' + log.type + '">' + utils.escapeHtml(log.message) + '</span>';
                    html += '</div>';
                }

                html += '</div></div>';

                // Clips list
                html += '<div class="batch-export-clips">';

                for (var clipId in clips) {
                    var clipData = clips[clipId];
                    var clip = state.clips.find(function(c) { return c.id === clipId; });
                    var seo = state.clipSEO[clipId] || getDefaultSEO(clip);
                    var title = (seo.title || 'Clip ' + clipId).substring(0, 40);

                    var clipClass = 'batch-export-clip';
                    if (clipData.status === 'capturing' || clipData.status === 'processing') clipClass += ' active';
                    if (clipData.status === 'completed') clipClass += ' completed';
                    if (clipData.status === 'error') clipClass += ' error';

                    var icon = '⏳';
                    var statusText = 'Waiting...';
                    if (clipData.status === 'capturing') { icon = '📹'; statusText = 'Capturing video...'; }
                    if (clipData.status === 'processing') { icon = '⚡'; statusText = 'Processing...'; }
                    if (clipData.status === 'completed') { icon = '✅'; statusText = 'Ready to download'; }
                    if (clipData.status === 'error') { icon = '❌'; statusText = clipData.error || 'Failed'; }

                    html += '<div class="' + clipClass + '">';
                    html += '<div class="batch-export-clip-icon">' + icon + '</div>';
                    html += '<div class="batch-export-clip-info">';
                    html += '<div class="batch-export-clip-title">' + utils.escapeHtml(title) + '</div>';
                    html += '<div class="batch-export-clip-status">' + statusText + '</div>';
                    html += '</div>';

                    // Progress bar for active clips
                    if (clipData.status === 'capturing' || clipData.status === 'processing') {
                        html += '<div class="batch-export-clip-progress">';
                        html += '<div class="batch-export-clip-progress-bar">';
                        html += '<div class="batch-export-clip-progress-fill" style="width: ' + (clipData.progress || 0) + '%"></div>';
                        html += '</div>';
                        html += '<div class="batch-export-clip-progress-text">' + (clipData.progress || 0) + '%</div>';
                        html += '</div>';
                    }

                    // Download button for completed clips
                    if (clipData.status === 'completed' && clipData.outputUrl) {
                        html += '<div class="batch-export-clip-actions">';
                        html += '<a href="' + clipData.outputUrl + '" target="_blank" download class="batch-export-download-btn">📥 Download</a>';
                        html += '</div>';
                    }

                    html += '</div>';
                }

                html += '</div>'; // clips

                html += '</div>'; // body

                // Footer
                html += '<div class="batch-export-modal-footer">';
                html += '<div class="batch-export-footer-status">';
                if (!isComplete) {
                    html += 'Processing clip ' + (state.parallelExport.currentClipIndex + 1) + ' of ' + total + ' • ' + elapsed + 's elapsed';
                } else {
                    html += 'Total time: ' + elapsed + ' seconds';
                }
                html += '</div>';
                html += '<div class="batch-export-footer-actions">';

                if (!isComplete) {
                    html += '<button class="batch-export-cancel-btn" onclick="app.cancelBatchExport()">Cancel Export</button>';
                } else {
                    if (completed > 0) {
                        html += '<button class="batch-export-download-all-btn" onclick="app.downloadAllExportedClips()">📥 Download All (' + completed + ')</button>';
                    }
                    html += '<button class="batch-export-cancel-btn" onclick="app.closeBatchExportModal()" style="background: rgba(255,255,255,0.1); color: #9ca3af; border-color: rgba(255,255,255,0.2);">Close</button>';
                }

                html += '</div></div>';
                html += '</div>'; // modal

                return html;
            },

            /**
             * Update the batch export modal (called frequently during export)
             */
            updateBatchExportModal: function() {
                var modal = document.getElementById('batchExportModal');
                if (!modal) return;

                modal.innerHTML = app.buildBatchExportModalHTML();

                // Scroll console to bottom
                var consoleBody = document.getElementById('batchExportConsole');
                if (consoleBody) {
                    consoleBody.scrollTop = consoleBody.scrollHeight;
                }
            },

            /**
             * Update parallel export progress UI (legacy compatibility + modal update)
             */
            updateParallelExportProgress: function() {
                // Update the modal
                app.updateBatchExportModal();

                // Also update the inline container for backwards compatibility
                var container = document.getElementById('parallelExportProgress');
                if (container) {
                    container.style.display = 'none'; // Hide inline, we use modal now
                }
            },

            /**
             * Update parallel export UI when all complete
             */
            updateParallelExportComplete: function() {
                // Add completion log
                if (state.parallelExport) {
                    var elapsed = ((Date.now() - state.parallelExport.startTime) / 1000).toFixed(1);
                    var completed = state.parallelExport.completedClips;
                    var failed = state.parallelExport.failedClips;

                    if (completed > 0) {
                        app.addBatchExportLog('✓ Export complete! ' + completed + ' clips in ' + elapsed + 's', 'success');
                    }
                    if (failed > 0) {
                        app.addBatchExportLog('✗ ' + failed + ' clip(s) failed', 'error');
                    }
                }

                // Update the modal one final time
                app.updateBatchExportModal();
            },

            /**
             * Close the batch export modal
             */
            closeBatchExportModal: function() {
                var modal = document.getElementById('batchExportModal');
                if (modal) {
                    modal.remove();
                }
            },

            /**
             * Cancel the batch export
             */
            cancelBatchExport: function() {
                if (state.parallelExport) {
                    state.parallelExport.aborted = true;
                    app.addBatchExportLog('Export cancelled by user', 'warning');
                }
            },

            /**
             * Download all exported clips sequentially
             */
            downloadAllExportedClips: function() {
                if (!state.parallelExport) return;

                var clips = state.parallelExport.clips;
                var downloadUrls = [];

                for (var clipId in clips) {
                    if (clips[clipId].status === 'completed' && clips[clipId].outputUrl) {
                        downloadUrls.push({
                            url: clips[clipId].outputUrl,
                            clipId: clipId
                        });
                    }
                }

                if (downloadUrls.length === 0) {
                    utils.showToast('No clips to download', 'warning');
                    return;
                }

                // Download each file with a small delay to prevent browser blocking
                app.addBatchExportLog('Starting download of ' + downloadUrls.length + ' clips...', 'info');

                downloadUrls.forEach(function(item, index) {
                    setTimeout(function() {
                        var link = document.createElement('a');
                        link.href = item.url;
                        link.download = 'clip_' + item.clipId + '.mp4';
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        app.addBatchExportLog('Downloaded: clip_' + item.clipId + '.mp4', 'success');
                    }, index * 500); // 500ms delay between downloads
                });

                utils.showToast('Downloading ' + downloadUrls.length + ' clips...', 'success');
            },

            /**
             * Update batch export clip status in Firestore (for persistence/resume)
             */
            updateBatchExportClip: function(clipId, updates) {
                if (!state.parallelExport || !state.parallelExport.batchId) return;

                var wizardUpdateBatchExportClip = firebase.functions().httpsCallable('wizardUpdateBatchExportClip');
                wizardUpdateBatchExportClip({
                    batchId: state.parallelExport.batchId,
                    clipId: clipId,
                    jobId: updates.jobId || null,
                    status: updates.status || null,
                    progress: updates.progress || null,
                    outputUrl: updates.outputUrl || null,
                    error: updates.error || null
                }).then(function(result) {
                    if (result.data.isComplete) {
                        console.log('[BatchExport] All clips done, showing notification');
                        app.showBatchExportNotification();
                    }
                }).catch(function(err) {
                    console.warn('[BatchExport] Could not update batch document:', err);
                });
            },

            /**
             * Check for pending batch export on page load
             */
            checkPendingBatchExport: async function() {
                if (!state.projectId || !state.user) return;

                try {
                    var wizardGetPendingBatchExport = firebase.functions().httpsCallable('wizardGetPendingBatchExport');
                    var result = await wizardGetPendingBatchExport({ projectId: state.projectId });

                    if (result.data.success && result.data.batch) {
                        var batch = result.data.batch;
                        console.log('[BatchExport] Found pending batch export:', batch.id, batch.status);

                        // Show resume modal
                        app.showResumeBatchExportModal(batch);
                    }
                } catch (err) {
                    console.warn('[BatchExport] Error checking for pending batch:', err);
                }
            },

            /**
             * Show modal to resume or dismiss pending batch export
             */
            showResumeBatchExportModal: function(batch) {
                var completedCount = batch.completedClips || 0;
                var failedCount = batch.failedClips || 0;
                var totalCount = batch.totalClips || 0;
                var processingCount = totalCount - completedCount - failedCount;
                var isComplete = batch.status === 'completed' || batch.status === 'partial' || batch.status === 'failed';

                // Remove any existing modal
                var existingModal = document.getElementById('resumeBatchModal');
                if (existingModal) existingModal.remove();

                var modalHtml = '<div class="batch-export-modal-overlay" id="resumeBatchModal">';
                modalHtml += '<div class="batch-export-modal" style="max-width: 500px;">';
                modalHtml += '<div class="batch-export-modal-header">';
                modalHtml += '<h2>' + (isComplete ? '📦 Previous Export Complete' : '🔄 Export In Progress') + '</h2>';
                modalHtml += '</div>';
                modalHtml += '<div class="batch-export-modal-body" style="padding: 1.5rem;">';

                if (isComplete) {
                    modalHtml += '<p style="margin-bottom: 1rem;">Your previous batch export has completed.</p>';
                    modalHtml += '<div style="display: flex; gap: 1rem; margin-bottom: 1rem;">';
                    modalHtml += '<div style="flex: 1; text-align: center; padding: 1rem; background: rgba(34, 197, 94, 0.2); border-radius: 8px;">';
                    modalHtml += '<div style="font-size: 1.5rem; font-weight: bold; color: #22c55e;">' + completedCount + '</div>';
                    modalHtml += '<div style="font-size: 0.8rem; color: #94a3b8;">Completed</div>';
                    modalHtml += '</div>';
                    if (failedCount > 0) {
                        modalHtml += '<div style="flex: 1; text-align: center; padding: 1rem; background: rgba(239, 68, 68, 0.2); border-radius: 8px;">';
                        modalHtml += '<div style="font-size: 1.5rem; font-weight: bold; color: #ef4444;">' + failedCount + '</div>';
                        modalHtml += '<div style="font-size: 0.8rem; color: #94a3b8;">Failed</div>';
                        modalHtml += '</div>';
                    }
                    modalHtml += '</div>';
                } else {
                    modalHtml += '<p style="margin-bottom: 1rem;">A batch export is still processing in the background.</p>';
                    modalHtml += '<div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">';
                    modalHtml += '<div style="flex: 1; text-align: center; padding: 0.75rem; background: rgba(34, 197, 94, 0.2); border-radius: 8px;">';
                    modalHtml += '<div style="font-size: 1.25rem; font-weight: bold; color: #22c55e;">' + completedCount + '</div>';
                    modalHtml += '<div style="font-size: 0.75rem; color: #94a3b8;">Done</div>';
                    modalHtml += '</div>';
                    modalHtml += '<div style="flex: 1; text-align: center; padding: 0.75rem; background: rgba(59, 130, 246, 0.2); border-radius: 8px;">';
                    modalHtml += '<div style="font-size: 1.25rem; font-weight: bold; color: #3b82f6;">' + processingCount + '</div>';
                    modalHtml += '<div style="font-size: 0.75rem; color: #94a3b8;">Processing</div>';
                    modalHtml += '</div>';
                    if (failedCount > 0) {
                        modalHtml += '<div style="flex: 1; text-align: center; padding: 0.75rem; background: rgba(239, 68, 68, 0.2); border-radius: 8px;">';
                        modalHtml += '<div style="font-size: 1.25rem; font-weight: bold; color: #ef4444;">' + failedCount + '</div>';
                        modalHtml += '<div style="font-size: 0.75rem; color: #94a3b8;">Failed</div>';
                        modalHtml += '</div>';
                    }
                    modalHtml += '</div>';
                }

                // Show clip list
                modalHtml += '<div style="max-height: 200px; overflow-y: auto; margin-bottom: 1rem;">';
                batch.clips.forEach(function(clip) {
                    var icon = clip.status === 'completed' ? '✅' : clip.status === 'error' ? '❌' : clip.status === 'processing' ? '⏳' : '⏸️';
                    modalHtml += '<div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 4px; margin-bottom: 0.25rem;">';
                    modalHtml += '<span>' + icon + '</span>';
                    modalHtml += '<span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">' + utils.escapeHtml(clip.title || clip.clipId) + '</span>';
                    if (clip.status === 'completed' && clip.outputUrl) {
                        modalHtml += '<a href="' + clip.outputUrl + '" target="_blank" download style="color: #22c55e; text-decoration: none;">📥</a>';
                    }
                    modalHtml += '</div>';
                });
                modalHtml += '</div>';

                modalHtml += '</div>';
                modalHtml += '<div class="batch-export-modal-footer" style="display: flex; gap: 0.5rem; justify-content: flex-end;">';
                modalHtml += '<button onclick="app.dismissResumeBatchModal()" class="btn-secondary" style="padding: 0.5rem 1rem;">Dismiss</button>';
                if (completedCount > 0) {
                    modalHtml += '<button onclick="app.downloadFromResumeBatch(\'' + batch.id + '\')" class="btn-primary" style="padding: 0.5rem 1rem;">📥 Download ' + completedCount + ' Clips</button>';
                }
                modalHtml += '</div>';
                modalHtml += '</div></div>';

                document.body.insertAdjacentHTML('beforeend', modalHtml);
            },

            dismissResumeBatchModal: function() {
                var modal = document.getElementById('resumeBatchModal');
                if (modal) modal.remove();
            },

            downloadFromResumeBatch: async function(batchId) {
                try {
                    var wizardGetBatchExport = firebase.functions().httpsCallable('wizardGetBatchExport');
                    var result = await wizardGetBatchExport({ batchId: batchId });

                    if (result.data.success) {
                        var clips = result.data.batch.clips;
                        var completedClips = clips.filter(function(c) { return c.status === 'completed' && c.outputUrl; });

                        if (completedClips.length === 0) {
                            utils.showToast('No completed clips to download', 'warning');
                            return;
                        }

                        utils.showToast('Downloading ' + completedClips.length + ' clips...', 'info');

                        completedClips.forEach(function(clip, index) {
                            setTimeout(function() {
                                var link = document.createElement('a');
                                link.href = clip.outputUrl;
                                link.download = 'clip_' + clip.clipId + '.mp4';
                                link.target = '_blank';
                                link.style.display = 'none';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                            }, index * 500);
                        });

                        app.dismissResumeBatchModal();
                    }
                } catch (err) {
                    console.error('Download error:', err);
                    utils.showToast('Download failed: ' + err.message, 'error');
                }
            },

            /**
             * Show browser notification when batch export completes
             */
            showBatchExportNotification: function() {
                // Request notification permission if not granted
                if ('Notification' in window) {
                    if (Notification.permission === 'granted') {
                        new Notification('🎬 Batch Export Complete!', {
                            body: 'Your clips are ready to download.',
                            icon: '/favicon.ico'
                        });
                    } else if (Notification.permission !== 'denied') {
                        Notification.requestPermission().then(function(permission) {
                            if (permission === 'granted') {
                                new Notification('🎬 Batch Export Complete!', {
                                    body: 'Your clips are ready to download.',
                                    icon: '/favicon.ico'
                                });
                            }
                        });
                    }
                }
            },

            downloadAllZip: function() {
                // Export all project data as JSON (ZIP would require server-side generation)
                app.exportProject('json');
            },

            exportSEOSheet: function() {
                app.exportProject('csv');
            },

            saveProject: async function() {
                if (!state.projectId) {
                    utils.showToast('No project to save', 'error');
                    return;
                }

                utils.showToast('Saving project...', 'info');

                try {
                    // Save settings for all selected clips
                    var wizardSaveClipSettings = functions.httpsCallable('wizardSaveClipSettings');

                    for (var i = 0; i < state.selectedClipIds.length; i++) {
                        var clipId = state.selectedClipIds[i];
                        var settings = state.clipSettings[clipId] || getDefaultSettings();
                        var seo = state.clipSEO[clipId];

                        await wizardSaveClipSettings({
                            projectId: state.projectId,
                            clipId: clipId,
                            settings: settings,
                            seo: seo
                        });
                    }

                    utils.showToast('Project saved!', 'success');
                } catch (error) {
                    console.error('Save error:', error);
                    utils.showToast('Error: ' + (error.message || 'Failed to save'), 'error');
                }
            },

            startNewProject: function() {
                if (confirm('Start a new project? Current progress will be lost.')) {
                    state.currentStep = 1;
                    state.projectId = null;
                    state.videoInput.url = '';
                    state.videoInput.videoData = null;
                    state.clips = [];
                    state.selectedClipIds = [];
                    state.clipSettings = {};
                    state.clipSEO = {};
                    state.clipThumbnails = {};
                    state.analysis.status = 'idle';
                    state.analysis.progress = 0;
                    state.analysis.error = null;
                    state.analysis.steps.forEach(function(step) {
                        step.status = 'pending';
                    });
                    render();
                }
            },

            // Generate SEO for all selected clips at once
            generateAllSEO: async function() {
                if (!state.projectId) {
                    utils.showToast('No project loaded', 'error');
                    return;
                }

                utils.showToast('Generating SEO for all clips...', 'info');

                try {
                    var wizardGenerateAllSEO = functions.httpsCallable('wizardGenerateAllSEO');
                    var result = await wizardGenerateAllSEO({
                        projectId: state.projectId,
                        clipIds: state.selectedClipIds
                    });

                    if (result.data.success) {
                        // Update local SEO data for all clips
                        Object.keys(result.data.seoData).forEach(function(clipId) {
                            state.clipSEO[clipId] = result.data.seoData[clipId];
                        });
                        render();
                        utils.showToast('SEO generated for all clips!', 'success');
                    } else {
                        throw new Error(result.data.error || 'Failed to generate SEO');
                    }
                } catch (error) {
                    console.error('Batch SEO error:', error);
                    utils.showToast('Error: ' + (error.message || 'Failed to generate SEO'), 'error');
                }
            },

            // Export project with all data
            exportProject: async function(format) {
                if (!state.projectId) {
                    utils.showToast('No project to export', 'error');
                    return;
                }

                utils.showToast('Preparing export...', 'info');

                try {
                    var wizardExportProject = functions.httpsCallable('wizardExportProject');
                    var result = await wizardExportProject({
                        projectId: state.projectId,
                        format: format || 'json',
                        clipIds: state.selectedClipIds
                    });

                    if (result.data.success) {
                        // Handle download based on format
                        if (format === 'csv') {
                            app.downloadCSV(result.data.data.csv, 'project-seo.csv');
                        } else {
                            app.downloadJSON(result.data.data, 'project-export.json');
                        }
                        utils.showToast('Export ready!', 'success');
                    } else {
                        throw new Error(result.data.error || 'Failed to export');
                    }
                } catch (error) {
                    console.error('Export error:', error);
                    utils.showToast('Error: ' + (error.message || 'Failed to export'), 'error');
                }
            },

            downloadCSV: function(csvContent, filename) {
                var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                var link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
            },

            downloadJSON: function(jsonContent, filename) {
                var blob = new Blob([JSON.stringify(jsonContent, null, 2)], { type: 'application/json' });
                var link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
            },

            // Phase 5: Project Management Functions
            loadMyProjects: async function() {
                state.projectsLoading = true;
                render();

                try {
                    var wizardGetProjects = functions.httpsCallable('wizardGetProjects');
                    var result = await wizardGetProjects({
                        limit: 20
                    });

                    if (result.data.success) {
                        state.myProjects = result.data.projects;
                        state.projectsLoaded = true;
                        utils.showToast('Loaded ' + result.data.projects.length + ' projects', 'success');
                    } else {
                        throw new Error(result.data.error || 'Failed to load projects');
                    }
                } catch (error) {
                    console.error('Load projects error:', error);
                    utils.showToast('Error: ' + (error.message || 'Failed to load projects'), 'error');
                    state.myProjects = [];
                    state.projectsLoaded = true;
                }

                state.projectsLoading = false;
                render();
            },

            loadProject: async function(projectId) {
                if (!projectId) {
                    utils.showToast('No project ID provided', 'error');
                    return;
                }

                state.loading = true;
                render();

                try {
                    var wizardGetProject = functions.httpsCallable('wizardGetProject');
                    var result = await wizardGetProject({
                        projectId: projectId
                    });

                    if (result.data.success) {
                        var project = result.data.project;

                        // Restore state from loaded project
                        state.projectId = project.id;
                        state.videoInput.url = project.videoUrl || '';
                        // Backend returns videoData as nested object
                        if (project.videoData) {
                            state.videoInput.videoData = {
                                title: project.videoData.title,
                                duration: project.videoData.duration,
                                thumbnail: project.videoData.thumbnail,
                                videoId: project.videoData.videoId
                            };
                        }

                        // Load clips
                        if (project.clips && project.clips.length > 0) {
                            state.clips = project.clips;
                            state.selectedClipIds = project.clips.map(function(c) { return c.id; });
                        }

                        // Load settings and SEO
                        if (project.clipSettings) {
                            state.clipSettings = project.clipSettings;
                        }
                        if (project.clipSEO) {
                            state.clipSEO = project.clipSEO;
                        }

                        // Load AI data if available
                        if (project.clipBRoll) state.clipBRoll = project.clipBRoll;
                        if (project.clipHooks) state.clipHooks = project.clipHooks;
                        if (project.clipFillers) state.clipFillers = project.clipFillers;
                        if (project.clipSpeakers) state.clipSpeakers = project.clipSpeakers;
                        if (project.clipCaptions) state.clipCaptions = project.clipCaptions;

                        // Go to appropriate step based on progress
                        if (project.clips && project.clips.length > 0) {
                            state.currentStep = 3; // Start at clip selection
                            state.analysis.status = 'done';
                        }

                        utils.showToast('Project loaded successfully!', 'success');

                        // Check for any pending/in-progress batch exports
                        setTimeout(function() {
                            app.checkPendingBatchExport();
                        }, 1000);
                    } else {
                        throw new Error(result.data.error || 'Failed to load project');
                    }
                } catch (error) {
                    console.error('Load project error:', error);
                    utils.showToast('Error: ' + (error.message || 'Failed to load project'), 'error');
                }

                state.loading = false;
                render();
            },

            duplicateProject: async function(projectId) {
                if (!projectId) {
                    utils.showToast('No project ID provided', 'error');
                    return;
                }

                if (!confirm('Create a copy of this project?')) {
                    return;
                }

                utils.showToast('Duplicating project...', 'info');

                try {
                    var wizardDuplicateProject = functions.httpsCallable('wizardDuplicateProject');
                    var result = await wizardDuplicateProject({
                        projectId: projectId
                    });

                    if (result.data.success) {
                        utils.showToast('Project duplicated! New ID: ' + result.data.newProjectId, 'success');
                        // Reload projects list
                        app.loadMyProjects();
                    } else {
                        throw new Error(result.data.error || 'Failed to duplicate project');
                    }
                } catch (error) {
                    console.error('Duplicate project error:', error);
                    utils.showToast('Error: ' + (error.message || 'Failed to duplicate project'), 'error');
                }
            },

            archiveProject: async function(projectId) {
                if (!projectId) {
                    utils.showToast('No project ID provided', 'error');
                    return;
                }

                if (!confirm('Archive this project? You can restore it later.')) {
                    return;
                }

                utils.showToast('Archiving project...', 'info');

                try {
                    var wizardUpdateProjectStatus = functions.httpsCallable('wizardUpdateProjectStatus');
                    var result = await wizardUpdateProjectStatus({
                        projectId: projectId,
                        status: 'archived'
                    });

                    if (result.data.success) {
                        utils.showToast('Project archived!', 'success');
                        // Remove from current list
                        state.myProjects = state.myProjects.filter(function(p) {
                            return p.id !== projectId;
                        });
                        render();
                    } else {
                        throw new Error(result.data.error || 'Failed to archive project');
                    }
                } catch (error) {
                    console.error('Archive project error:', error);
                    utils.showToast('Error: ' + (error.message || 'Failed to archive project'), 'error');
                }
            },

            exportFullProject: async function(format) {
                if (!state.projectId) {
                    utils.showToast('No project to export', 'error');
                    return;
                }

                utils.showToast('Preparing full export...', 'info');

                try {
                    var wizardExportFullProject = functions.httpsCallable('wizardExportFullProject');
                    var result = await wizardExportFullProject({
                        projectId: state.projectId,
                        format: format || 'json',
                        clipIds: state.selectedClipIds,
                        includeAIData: true,
                        includeThumbnails: true
                    });

                    if (result.data.success) {
                        // Handle download based on format
                        if (format === 'csv') {
                            app.downloadCSV(result.data.data.csv, 'project-seo-export.csv');
                        } else {
                            app.downloadJSON(result.data.data, 'project-full-export.json');
                        }
                        utils.showToast('Export downloaded!', 'success');
                    } else {
                        throw new Error(result.data.error || 'Failed to export');
                    }
                } catch (error) {
                    console.error('Export error:', error);
                    utils.showToast('Error: ' + (error.message || 'Failed to export'), 'error');
                }
            },

            selectExportFormat: function(format) {
                // Update visual selection
                var options = document.querySelectorAll('.export-option');
                options.forEach(function(opt) {
                    opt.classList.remove('selected');
                });
                event.currentTarget.classList.add('selected');

                // Perform export based on format
                switch (format) {
                    case 'full':
                        app.exportFullProject('json');
                        break;
                    case 'seo':
                        app.exportFullProject('csv');
                        break;
                    case 'captions':
                        app.exportCaptions();
                        break;
                }
            },

            exportCaptions: async function() {
                if (!state.projectId) {
                    utils.showToast('No project to export', 'error');
                    return;
                }

                var selectedClips = state.clips.filter(function(c) {
                    return state.selectedClipIds.indexOf(c.id) !== -1;
                });

                // Generate SRT content for each clip
                var srtContent = '';
                selectedClips.forEach(function(clip, clipIndex) {
                    var captions = (state.clipCaptions || {})[clip.id];
                    srtContent += '--- CLIP ' + (clipIndex + 1) + ': ' + (state.clipSEO[clip.id]?.title || clip.id) + ' ---\n\n';

                    if (captions && captions.words) {
                        captions.words.forEach(function(word, i) {
                            srtContent += (i + 1) + '\n';
                            srtContent += formatSRTTime(word.startTime) + ' --> ' + formatSRTTime(word.endTime) + '\n';
                            srtContent += word.word + '\n\n';
                        });
                    } else {
                        // Use transcript as fallback
                        srtContent += '1\n';
                        srtContent += '00:00:00,000 --> 00:00:' + clip.duration + ',000\n';
                        srtContent += clip.transcript + '\n\n';
                    }
                    srtContent += '\n';
                });

                function formatSRTTime(seconds) {
                    var h = Math.floor(seconds / 3600);
                    var m = Math.floor((seconds % 3600) / 60);
                    var s = Math.floor(seconds % 60);
                    var ms = Math.round((seconds % 1) * 1000);
                    return String(h).padStart(2, '0') + ':' +
                           String(m).padStart(2, '0') + ':' +
                           String(s).padStart(2, '0') + ',' +
                           String(ms).padStart(3, '0');
                }

                var blob = new Blob([srtContent], { type: 'text/plain;charset=utf-8;' });
                var link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'project-captions.srt';
                link.click();
                utils.showToast('Captions exported!', 'success');
            },

            // YouTube OAuth Connection Methods
            // Using popup approach for iframe compatibility
            connectYouTube: async function() {
                if (!state.user) {
                    utils.showToast('Please sign in first to connect YouTube', 'error');
                    return;
                }

                state.youtubeConnection.loading = true;
                state.youtubeConnection.error = null;
                render();

                try {
                    // Use Firebase Function as callback (no separate file upload needed)
                    var callbackUrl = 'https://us-central1-ytseo-6d1b0.cloudfunctions.net/youtubeOAuthCallbackPage';

                    var getYouTubeOAuthUrl = functions.httpsCallable('getYouTubeOAuthUrl');
                    var result = await getYouTubeOAuthUrl({
                        redirectUri: callbackUrl
                    });

                    if (result.data.success && result.data.authUrl) {
                        // Store state for verification
                        sessionStorage.setItem('youtubeOAuthState', result.data.state);

                        // Open OAuth in popup window (works better in iframes)
                        var popupWidth = 500;
                        var popupHeight = 600;
                        var left = (window.screen.width - popupWidth) / 2;
                        var top = (window.screen.height - popupHeight) / 2;

                        var popup = window.open(
                            result.data.authUrl,
                            'YouTube Authorization',
                            'width=' + popupWidth + ',height=' + popupHeight + ',left=' + left + ',top=' + top + ',scrollbars=yes,resizable=yes'
                        );

                        if (!popup || popup.closed) {
                            throw new Error('Popup was blocked. Please allow popups for this site.');
                        }

                        // Listen for message from popup
                        window.youtubeOAuthCallback = async function(code, returnedState) {
                            try {
                                // Verify state matches
                                var storedState = sessionStorage.getItem('youtubeOAuthState');
                                if (storedState !== returnedState) {
                                    throw new Error('Security verification failed');
                                }
                                sessionStorage.removeItem('youtubeOAuthState');

                                // Process the callback
                                var handleYouTubeOAuthCallback = functions.httpsCallable('handleYouTubeOAuthCallback');
                                var callbackResult = await handleYouTubeOAuthCallback({
                                    code: code,
                                    state: returnedState,
                                    redirectUri: callbackUrl
                                });

                                if (callbackResult.data.success) {
                                    state.youtubeConnection.connected = true;
                                    state.youtubeConnection.channel = callbackResult.data.channel;
                                    state.youtubeConnection.error = null;
                                    utils.showToast('YouTube account connected successfully!', 'success');
                                } else {
                                    throw new Error(callbackResult.data.error || 'Failed to connect');
                                }
                            } catch (err) {
                                console.error('OAuth callback error:', err);
                                state.youtubeConnection.error = err.message || 'Failed to complete connection';
                                utils.showToast('Failed to connect YouTube', 'error');
                            }
                            state.youtubeConnection.loading = false;
                            render();
                        };

                        // Also listen for popup close without completing
                        var checkPopupClosed = setInterval(function() {
                            if (popup.closed) {
                                clearInterval(checkPopupClosed);
                                if (state.youtubeConnection.loading) {
                                    state.youtubeConnection.loading = false;
                                    render();
                                }
                            }
                        }, 500);

                        // Safety timeout: stop checking after 60 seconds to prevent infinite loop
                        setTimeout(function() {
                            clearInterval(checkPopupClosed);
                            if (state.youtubeConnection.loading) {
                                state.youtubeConnection.loading = false;
                                state.youtubeConnection.error = 'OAuth popup timed out. Please try again.';
                                render();
                            }
                        }, 60000);

                    } else {
                        throw new Error('Failed to generate authorization URL');
                    }
                } catch (error) {
                    console.error('YouTube connect error:', error);
                    state.youtubeConnection.loading = false;
                    state.youtubeConnection.error = error.message || 'Failed to connect YouTube. Please try again.';
                    render();
                    utils.showToast('Failed to connect YouTube', 'error');
                }
            },

            disconnectYouTube: async function() {
                if (!confirm('Are you sure you want to disconnect your YouTube account?')) {
                    return;
                }

                state.youtubeConnection.loading = true;
                render();

                try {
                    var disconnectYouTube = functions.httpsCallable('disconnectYouTube');
                    await disconnectYouTube({});

                    state.youtubeConnection.connected = false;
                    state.youtubeConnection.channel = null;
                    state.youtubeConnection.loading = false;
                    render();
                    utils.showToast('YouTube account disconnected', 'success');
                } catch (error) {
                    console.error('YouTube disconnect error:', error);
                    state.youtubeConnection.loading = false;
                    render();
                    utils.showToast('Failed to disconnect YouTube', 'error');
                }
            },

            // Load token balance from backend
            loadTokenBalance: async function() {
                if (!state.user) {
                    state.tokens.balance = 0;
                    state.tokens.plan = 'free';
                    return;
                }

                state.tokens.loading = true;
                render();

                try {
                    var getWizardTokenBalance = functions.httpsCallable('getWizardTokenBalance');
                    var result = await getWizardTokenBalance({});

                    if (result.data.success) {
                        state.tokens.balance = result.data.balance || 0;
                        state.tokens.plan = result.data.plan || 'free';
                        state.tokens.monthlyAllocation = result.data.monthlyAllocation || 10;

                        // Update costs from backend
                        if (result.data.costs) {
                            state.tokens.costs = result.data.costs;
                        }

                        console.log('[TokenBalance] Loaded:', state.tokens.balance, 'tokens, plan:', state.tokens.plan);
                    }
                } catch (error) {
                    console.error('[TokenBalance] Error loading balance:', error);
                    // Keep default values
                } finally {
                    state.tokens.loading = false;
                    render();
                }
            },

            // Refresh token balance after an operation
            refreshTokenBalance: async function() {
                try {
                    var getWizardTokenBalance = functions.httpsCallable('getWizardTokenBalance');
                    var result = await getWizardTokenBalance({});

                    if (result.data.success) {
                        state.tokens.balance = result.data.balance || 0;
                        render();
                    }
                } catch (error) {
                    console.error('[TokenBalance] Error refreshing:', error);
                }
            },

            checkYouTubeConnection: async function() {
                if (!state.user) return;

                try {
                    var getYouTubeConnectionStatus = functions.httpsCallable('getYouTubeConnectionStatus');
                    var result = await getYouTubeConnectionStatus({});

                    state.youtubeConnection.connected = result.data.connected;
                    state.youtubeConnection.channel = result.data.channel;

                    if (result.data.needsRefresh) {
                        // Token needs refresh - try to refresh
                        try {
                            var refreshYouTubeToken = functions.httpsCallable('refreshYouTubeToken');
                            await refreshYouTubeToken({});
                        } catch (refreshError) {
                            console.log('Token refresh failed:', refreshError.message);
                        }
                    }

                    render();
                } catch (error) {
                    console.error('Check YouTube connection error:', error);
                }
            },

            handleYouTubeOAuthCallback: async function() {
                // Check if this is an OAuth callback
                var urlParams = new URLSearchParams(window.location.search);
                var code = urlParams.get('code');
                var returnedState = urlParams.get('state');
                var error = urlParams.get('error');

                if (error) {
                    console.log('YouTube OAuth error:', error);
                    state.youtubeConnection.error = 'Authorization was denied or cancelled.';
                    // Clean URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                    render();
                    return;
                }

                if (!code || !returnedState) {
                    return; // Not an OAuth callback
                }

                // Verify state matches what we stored
                var storedState = sessionStorage.getItem('youtubeOAuthState');
                if (storedState !== returnedState) {
                    console.error('OAuth state mismatch');
                    state.youtubeConnection.error = 'Security verification failed. Please try again.';
                    window.history.replaceState({}, document.title, window.location.pathname);
                    render();
                    return;
                }

                // Clear stored state
                sessionStorage.removeItem('youtubeOAuthState');

                // Process the OAuth callback
                state.youtubeConnection.loading = true;
                render();

                try {
                    var handleYouTubeOAuthCallback = functions.httpsCallable('handleYouTubeOAuthCallback');
                    var result = await handleYouTubeOAuthCallback({
                        code: code,
                        state: returnedState,
                        redirectUri: window.location.origin + window.location.pathname
                    });

                    if (result.data.success) {
                        state.youtubeConnection.connected = true;
                        state.youtubeConnection.channel = result.data.channel;
                        state.youtubeConnection.error = null;
                        utils.showToast('YouTube account connected successfully!', 'success');
                    } else {
                        throw new Error(result.data.error || 'Failed to connect');
                    }
                } catch (error) {
                    console.error('YouTube OAuth callback error:', error);
                    state.youtubeConnection.error = error.message || 'Failed to complete YouTube connection.';
                    utils.showToast('Failed to connect YouTube', 'error');
                }

                state.youtubeConnection.loading = false;
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
                render();
            }
        };

        // Make app globally accessible
        window.app = app;
        window.utils = utils;

        /* ==========================================
           4.7 HELPER FUNCTIONS
           ========================================== */

        // Note: getDefaultSettings is defined earlier in the code

        /* ==========================================
           4.8 INITIALIZATION
           ========================================== */

        // Listen for postMessage from OAuth popup (cross-origin compatible)
        window.addEventListener('message', function(event) {
            // Verify origin if needed (for security)
            if (event.data && event.data.type === 'youtube-oauth-callback') {
                if (typeof window.youtubeOAuthCallback === 'function') {
                    window.youtubeOAuthCallback(event.data.code, event.data.state);
                }
            }
        });

        // Check for pending OAuth in localStorage (fallback for popup issues)
        function checkPendingOAuth() {
            try {
                var pending = localStorage.getItem('youtube_oauth_pending');
                if (pending) {
                    var data = JSON.parse(pending);
                    // Check if not expired (5 minutes)
                    if (Date.now() - data.timestamp < 5 * 60 * 1000) {
                        // Clear it first
                        localStorage.removeItem('youtube_oauth_pending');

                        // Process the callback
                        if (state.user && data.code && data.state) {
                            var storedState = sessionStorage.getItem('youtubeOAuthState');
                            if (storedState === data.state) {
                                sessionStorage.removeItem('youtubeOAuthState');

                                state.youtubeConnection.loading = true;
                                render();

                                var callbackUrl = 'https://us-central1-ytseo-6d1b0.cloudfunctions.net/youtubeOAuthCallbackPage';
                                var handleYouTubeOAuthCallback = functions.httpsCallable('handleYouTubeOAuthCallback');
                                handleYouTubeOAuthCallback({
                                    code: data.code,
                                    state: data.state,
                                    redirectUri: callbackUrl
                                }).then(function(result) {
                                    if (result.data.success) {
                                        state.youtubeConnection.connected = true;
                                        state.youtubeConnection.channel = result.data.channel;
                                        utils.showToast('YouTube account connected!', 'success');
                                    }
                                    state.youtubeConnection.loading = false;
                                    render();
                                }).catch(function(err) {
                                    console.error('Pending OAuth error:', err);
                                    state.youtubeConnection.loading = false;
                                    render();
                                });
                            }
                        }
                    } else {
                        // Expired, remove it
                        localStorage.removeItem('youtube_oauth_pending');
                    }
                }
            } catch (e) {
                console.error('Error checking pending OAuth:', e);
            }
        }

        /* ==========================================
           BROWSER EXTENSION INTEGRATION
           ========================================== */

        // Extension communication helpers
        var extensionRequestId = 0;
        var extensionCallbacks = {};

        function sendExtensionRequest(action, data) {
            return new Promise(function(resolve, reject) {
                var requestId = 'req_' + (++extensionRequestId) + '_' + Date.now();

                // Set up callback
                extensionCallbacks[requestId] = { resolve: resolve, reject: reject };

                // Timeout after 210 seconds (3.5 minutes) for video capture
                // The extension uses storage-based polling for 180s, so we add a buffer
                // Capture at 4x speed: 5 min video = 75s capture + upload time
                setTimeout(function() {
                    if (extensionCallbacks[requestId]) {
                        delete extensionCallbacks[requestId];
                        reject(new Error('Extension capture timeout - the video may be too long or network issues occurred'));
                    }
                }, 210000);

                // Send request to extension
                window.dispatchEvent(new CustomEvent('yvo-extension-request', {
                    detail: {
                        action: action,
                        data: data,
                        requestId: requestId
                    }
                }));
            });
        }

        // Listen for extension responses
        window.addEventListener('yvo-extension-response', function(event) {
            var detail = event.detail || {};
            var requestId = detail.requestId;

            if (requestId && extensionCallbacks[requestId]) {
                var callback = extensionCallbacks[requestId];
                delete extensionCallbacks[requestId];
                callback.resolve(detail);
            }
        });

        // Auto-capture function - opens YouTube tab automatically, captures, and closes
        window.triggerAutoCapture = async function() {
            var params = window.__pendingAutoCapture;
            if (!params) {
                console.error('[Video Wizard] No pending auto-capture params');
                utils.showToast('Unable to start auto-capture. Please try exporting again.', 'error');
                return;
            }

            console.log('[Video Wizard] Starting auto-capture for video:', params.videoId);

            // Close any modal
            app.hideModal && app.hideModal();

            // Show progress indicator
            utils.showToast('🚀 Opening YouTube and capturing video... Please wait (this may take 30-60 seconds)', 'info', 60000);

            // Update UI to show capturing state
            if (typeof app.showCapturingStateInModal === 'function') {
                app.showCapturingStateInModal('Auto-capture in progress...<br><small>Opening YouTube tab, capturing video, then closing it automatically.</small>');
            }

            try {
                // Call extension with autoOpenTab: true
                var capturePayload = {
                    videoId: params.videoId,
                    youtubeUrl: params.youtubeUrl,
                    clipStart: params.clipStart,
                    clipEnd: params.clipEnd,
                    quality: params.quality,
                    autoCapture: true,
                    autoOpenTab: true  // This triggers automatic tab opening
                };

                console.log('[Video Wizard] Sending auto-capture request:', capturePayload);
                var captureResult = await sendExtensionRequest('captureVideoForWizard', capturePayload);

                console.log('[Video Wizard] Auto-capture result:', captureResult?.success, captureResult?.error);

                if (captureResult && captureResult.success && captureResult.streamData) {
                    utils.showToast('✅ Video captured successfully!', 'success');

                    // Store the captured data for the export flow
                    state.capturedVideoData = captureResult;

                    // Continue with export flow - this will use the captured video
                    if (typeof processClipAfterCapture === 'function') {
                        processClipAfterCapture(captureResult);
                    } else {
                        // Fallback: trigger export again
                        utils.showToast('Video captured! Click Export again to continue.', 'info');
                    }
                } else {
                    var errorMsg = captureResult?.error || 'Auto-capture failed';
                    console.error('[Video Wizard] Auto-capture failed:', errorMsg);
                    utils.showToast('❌ ' + errorMsg, 'error');

                    app.showCaptureErrorInModal(
                        '<div style="text-align:center;">' +
                        '<h3 style="margin:0 0 15px;color:#ef4444;">❌ Auto-Capture Failed</h3>' +
                        '<p style="margin:0 0 15px;color:#666;">' + errorMsg + '</p>' +
                        '<p style="font-size:13px;color:#888;">Try opening the video manually on YouTube, wait for it to load, then click Export again.</p>' +
                        '</div>'
                    );
                }
            } catch (error) {
                console.error('[Video Wizard] Auto-capture exception:', error);
                utils.showToast('❌ Auto-capture error: ' + error.message, 'error');

                app.showCaptureErrorInModal(
                    '<div style="text-align:center;">' +
                    '<h3 style="margin:0 0 15px;color:#ef4444;">❌ Auto-Capture Error</h3>' +
                    '<p style="margin:0 0 15px;color:#666;">' + error.message + '</p>' +
                    '</div>'
                );
            } finally {
                // Clear pending params
                window.__pendingAutoCapture = null;
            }
        };

        // Listen for extension ready event
        window.addEventListener('yvo-extension-ready', function(event) {
            var detail = event.detail || {};
            state.extension.installed = true;
            state.extension.version = detail.version || '1.0.0';
            state.extension.features = detail.features || [];
            state.extension.checking = false;
            console.log('[Video Wizard] Extension detected:', detail.version, 'features:', detail.features);

            // Check if auto-capture is supported
            if (detail.features && detail.features.indexOf('auto_capture') !== -1) {
                console.log('[Video Wizard] Extension supports auto-capture - reliable stream capture enabled');
            }

            render();
        });

        // Check for extension on load
        function checkExtension() {
            state.extension.checking = true;

            // Check if extension already announced itself
            if (window.__YVO_EXTENSION_INSTALLED__) {
                state.extension.installed = true;
                state.extension.version = window.__YVO_EXTENSION_VERSION__ || '1.0.0';
                state.extension.checking = false;
                console.log('[Video Wizard] Extension already present');
                return;
            }

            // Give extension time to load (it may load after page)
            setTimeout(function() {
                if (!state.extension.installed) {
                    state.extension.checking = false;
                    console.log('[Video Wizard] Extension not detected');
                    render();
                }
            }, 2000);
        }

        // Check for YouTube URL in query params (from extension)
        function checkYouTubeUrlParam() {
            var urlParams = new URLSearchParams(window.location.search);
            var youtubeUrl = urlParams.get('youtube');

            if (youtubeUrl) {
                try {
                    var decoded = decodeURIComponent(youtubeUrl);
                    state.videoInput.url = decoded;
                    console.log('[Video Wizard] YouTube URL from extension:', decoded);

                    // Clean URL param after reading
                    var cleanUrl = window.location.pathname + window.location.hash;
                    window.history.replaceState({}, '', cleanUrl);

                    // Auto-analyze after short delay
                    setTimeout(function() {
                        if (state.user && state.extension.installed) {
                            app.analyzeVideo();
                        }
                    }, 1500);
                } catch (e) {
                    console.error('[Video Wizard] Error parsing YouTube URL param:', e);
                }
            }
        }

        // Load saved platform preference
        try {
            var savedPlatform = localStorage.getItem('wizard_platform_preset');
            if (savedPlatform && PLATFORM_PRESETS[savedPlatform]) {
                state.contentType.selected = savedPlatform;
                state.contentType.preset = PLATFORM_PRESETS[savedPlatform];
            }
        } catch (e) {
            console.warn('Could not load platform preference');
        }

        // Initialize extension check
        checkExtension();
        checkYouTubeUrlParam();

        // Auth state listener
        auth.onAuthStateChanged(function(user) {
            if (user) {
                state.user = user;
                render();

                // Load real token balance from backend
                app.loadTokenBalance();

                // Check for pending OAuth from localStorage
                checkPendingOAuth();

                // Check for YouTube OAuth callback in URL (legacy support)
                app.handleYouTubeOAuthCallback();

                // Check YouTube connection status
                app.checkYouTubeConnection();
            } else {
                // Not logged in - set to 0 tokens (require auth)
                state.tokens.balance = 0;
                state.tokens.plan = 'free';
                render();
            }
        });

        // Initial render
        render();

        } // end runApp()

    })();
    </script>
</body>
</html>
