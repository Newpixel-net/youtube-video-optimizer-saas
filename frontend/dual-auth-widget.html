<!-- ================================================================
     YOUTUBE VIDEO OPTIMIZER - MAIN WIDGET
     ================================================================

     Structure:
     - SECTION 1: External Dependencies (CDN)
     - SECTION 2: Styles (CSS)
     - SECTION 3: HTML Views
     - SECTION 4: Scripts (JavaScript)

     Views: login, register, forgot-password, dashboard, optimizer, results, history

     Last Updated: 2024
     ================================================================ -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>YouTube Video Optimizer</title>

    <!-- ============================================
         SECTION 1: EXTERNAL DEPENDENCIES
         ============================================ -->

    <!-- 1.1 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 1.2 Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-functions-compat.js"></script>

    <!-- ============================================
         SECTION 2: STYLES
         ============================================ -->
    <style>
        /* ------------------------------------------
           2.1 BASE & RESET
           ------------------------------------------ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 1rem;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #app-root {
            width: 100%;
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }

        /* Base typography scale */
        h1 { font-size: 2.5rem; line-height: 1.2; font-weight: 700; letter-spacing: -0.02em; }
        h2 { font-size: 2rem; line-height: 1.25; font-weight: 700; letter-spacing: -0.01em; }
        h3 { font-size: 1.5rem; line-height: 1.3; font-weight: 600; }
        h4 { font-size: 1.25rem; line-height: 1.4; font-weight: 600; }
        p, span, label { font-size: 1rem; line-height: 1.6; }

        /* ------------------------------------------
           2.2 ANIMATIONS
           ------------------------------------------ */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            width: 40px;
            height: 40px;
            animation: spin 0.6s linear infinite;
        }

        .spinner-dark {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top-color: #3b82f6;
        }

        /* Professional Loading Animation */
        @keyframes progressPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-5px) rotate(2deg); }
            75% { transform: translateY(5px) rotate(-2deg); }
        }

        .loading-container {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 1.5rem;
            padding: 3rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        }

        .progress-bar-container {
            background: #e2e8f0;
            border-radius: 1rem;
            height: 12px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 1rem;
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
            background-size: 200% 100%;
            animation: shimmer 2s ease-in-out infinite;
            transition: width 0.5s ease-out;
        }

        .progress-percentage {
            font-size: 3.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
        }

        .loading-step {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.875rem 1.25rem;
            border-radius: 0.875rem;
            transition: all 0.3s ease;
        }

        .loading-step.active {
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
        }

        .loading-step.completed {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        }

        .step-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .step-icon.pending {
            background: #e2e8f0;
            color: #94a3b8;
        }

        .step-icon.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .step-icon.completed {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }

        .loading-emoji {
            font-size: 4rem;
            animation: float 3s ease-in-out infinite;
        }

        .loading-tip {
            background: rgba(99, 102, 241, 0.1);
            border-left: 4px solid #6366f1;
            padding: 1rem 1.25rem;
            border-radius: 0 0.75rem 0.75rem 0;
        }

        /* ------------------------------------------
           2.3 COMPONENTS - Buttons
           ------------------------------------------ */
        .btn-primary {
            width: 100%;
            padding: 1.125rem 1.5rem;
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            color: white;
            font-weight: 600;
            font-size: 1.0625rem;
            border-radius: 0.875rem;
            border: none;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 14px rgba(124, 58, 237, 0.25);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #6d28d9 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(124, 58, 237, 0.35);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(124, 58, 237, 0.25);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            padding: 0.75rem 1.25rem;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            font-weight: 600;
            font-size: 0.9375rem;
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .google-btn {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1rem;
        }

        .google-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .google-btn:active {
            transform: translateY(0);
        }

        /* ------------------------------------------
           2.4 COMPONENTS - Cards
           ------------------------------------------ */
        .tool-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .tool-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            border-color: rgba(124, 58, 237, 0.2);
        }

        .card {
            background: white;
            border-radius: 1.25rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.2);
            padding: 2.5rem;
        }

        /* ------------------------------------------
           2.4b COMPONENTS - Tabs
           ------------------------------------------ */
        .tabs-container {
            display: flex;
            gap: 0.375rem;
            background: #f3f4f6;
            padding: 0.375rem;
            border-radius: 1rem;
            margin-bottom: 1.75rem;
        }

        .tab-btn {
            flex: 1;
            padding: 0.875rem 1.25rem;
            border: none;
            background: transparent;
            color: #6b7280;
            font-weight: 600;
            font-size: 0.9375rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-btn:hover {
            color: #374151;
            background: rgba(255, 255, 255, 0.6);
        }

        .tab-btn.active {
            background: white;
            color: #7c3aed;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .tab-content {
            animation: fadeIn 0.3s ease-out;
        }

        /* ------------------------------------------
           2.4c COMPONENTS - Score Gauge
           ------------------------------------------ */
        .score-gauge {
            position: relative;
            width: 140px;
            height: 140px;
        }

        .score-circle {
            transform: rotate(-90deg);
        }

        .score-circle-bg {
            fill: none;
            stroke: #e5e7eb;
            stroke-width: 10;
        }

        .score-circle-fill {
            fill: none;
            stroke-width: 10;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s ease-out;
        }

        .score-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        /* ------------------------------------------
           2.5 COMPONENTS - Forms
           ------------------------------------------ */
        .input-field {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1rem;
            padding: 1rem 1.25rem;
        }

        .input-field:focus {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            border-color: #7c3aed;
        }

        .input-field::placeholder {
            color: #9ca3af;
        }

        /* ------------------------------------------
           2.6 COMPONENTS - Progress & Usage
           ------------------------------------------ */
        .usage-bar {
            transition: width 0.5s ease-out;
        }

        .usage-green { background-color: #22c55e; }
        .usage-yellow { background-color: #eab308; }
        .usage-red { background-color: #ef4444; }

        /* ------------------------------------------
           2.7 COMPONENTS - Messages
           ------------------------------------------ */
        .alert-error {
            padding: 0.75rem;
            background-color: #fef2f2;
            color: #b91c1c;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .alert-success {
            padding: 0.75rem;
            background-color: #f0fdf4;
            color: #15803d;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        /* ------------------------------------------
           2.8 COMPONENTS - Tags
           ------------------------------------------ */
        .tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background-color: #f3e8ff;
            color: #7c3aed;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* ------------------------------------------
           2.9 LAYOUT - Views
           ------------------------------------------ */
        .view-container {
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding: 2rem 1.5rem;
        }

        .view-centered {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .content-wrapper {
            max-width: 90rem;
            margin: 0 auto;
            width: 100%;
        }

        /* Desktop-optimized widths - expanded for better space utilization */
        @media (min-width: 1024px) {
            .max-w-6xl {
                max-width: 94% !important;
                padding-left: 1.5rem;
                padding-right: 1.5rem;
            }
            .max-w-4xl {
                max-width: 80% !important;
                min-width: 700px;
            }
        }

        @media (min-width: 1280px) {
            .max-w-6xl {
                max-width: 92% !important;
            }
            .max-w-4xl {
                max-width: 76% !important;
                min-width: 800px;
            }
            .view-container {
                padding: 1.75rem 2rem;
            }
        }

        @media (min-width: 1536px) {
            .max-w-6xl {
                max-width: 90% !important;
            }
            .max-w-4xl {
                max-width: 72% !important;
                min-width: 900px;
            }
            .view-container {
                padding: 2rem 3rem;
            }
        }

        @media (min-width: 1920px) {
            .max-w-6xl {
                max-width: 88% !important;
                max-width: min(88%, 1800px) !important;
            }
            .max-w-4xl {
                max-width: 68% !important;
                max-width: min(68%, 1200px) !important;
                min-width: 1000px;
            }
            .view-container {
                padding: 2.5rem 4rem;
            }
        }

        /* Dashboard grid - more columns on larger screens */
        @media (min-width: 1280px) {
            .dashboard-grid-4 {
                grid-template-columns: repeat(4, 1fr) !important;
            }
            .dashboard-grid-2 {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }

        @media (min-width: 1536px) {
            .dashboard-grid-4 {
                gap: 1.5rem !important;
            }
            .dashboard-grid-2 {
                gap: 2rem !important;
            }
        }

        /* ------------------------------------------
           2.10 MOBILE & RESPONSIVE
           ------------------------------------------ */

        /* Tablet styles (769px - 1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            html {
                font-size: 16px;
            }

            .view-container {
                padding: 1.75rem 1.5rem;
            }
        }

        /* Mobile styles (up to 768px) */
        @media (max-width: 768px) {
            html {
                font-size: 17px; /* Larger base for mobile readability */
            }

            body {
                -webkit-text-size-adjust: 100%;
            }

            /* Typography scale for mobile */
            h1 { font-size: 1.875rem !important; line-height: 1.2; }
            h2 { font-size: 1.5rem !important; line-height: 1.25; }
            h3 { font-size: 1.25rem !important; line-height: 1.3; }
            h4 { font-size: 1.125rem !important; line-height: 1.4; }
            p, span, label { font-size: 1rem; line-height: 1.6; }

            .view-container {
                padding: 1.25rem 1rem;
            }

            .mobile-full-screen {
                min-height: 100vh;
                min-height: -webkit-fill-available;
                padding: 1.25rem;
            }

            .mobile-card {
                width: 100%;
                max-width: 100%;
                margin: 0;
            }

            .mobile-padding {
                padding: 1.75rem !important;
            }

            .mobile-text-lg {
                font-size: 1.25rem !important;
            }

            .mobile-text-xl {
                font-size: 1.5rem !important;
            }

            .mobile-grid-cols-1 {
                grid-template-columns: 1fr !important;
            }

            /* Mobile Swipeable Usage Cards */
            .mobile-swipe-container {
                display: flex;
                overflow-x: auto;
                scroll-snap-type: x mandatory;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
                gap: 1rem;
                padding: 0.5rem 0;
                margin: 0 -1rem;
                padding-left: 1rem;
                padding-right: 1rem;
            }

            .mobile-swipe-container::-webkit-scrollbar {
                display: none;
            }

            .mobile-swipe-card {
                flex: 0 0 85%;
                scroll-snap-align: center;
                scroll-snap-stop: always;
            }

            .mobile-swipe-dots {
                display: flex;
                justify-content: center;
                gap: 0.5rem;
                margin-top: 1rem;
                margin-bottom: 0.5rem;
            }

            .mobile-swipe-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background-color: rgba(255, 255, 255, 0.4);
                transition: all 0.3s ease;
                cursor: pointer;
            }

            .mobile-swipe-dot.active {
                background-color: white;
                transform: scale(1.3);
            }

            .mobile-gap-4 {
                gap: 1rem !important;
            }

            /* Improve touch targets for Apple HIG compliance */
            button, .google-btn, input, select, .tab-btn {
                min-height: 50px;
                font-size: 17px !important; /* Apple's recommended mobile size */
            }

            .btn-primary {
                padding: 1rem 1.25rem;
                font-size: 1.0625rem !important;
            }

            .btn-secondary {
                padding: 0.875rem 1rem;
                min-height: 48px;
            }

            /* Cards - more padding on mobile */
            .card {
                padding: 1.75rem;
                border-radius: 1rem;
            }

            /* Forms - larger inputs */
            .input-field {
                padding: 1rem 1rem;
                font-size: 17px !important;
                border-radius: 0.75rem;
            }

            /* Tabs - larger on mobile */
            .tabs-container {
                padding: 0.25rem;
                border-radius: 0.875rem;
            }

            .tab-btn {
                padding: 0.75rem 0.5rem;
                font-size: 0.9375rem !important;
            }

            /* Score gauges - smaller on mobile */
            .score-gauge {
                width: 100px;
                height: 100px;
            }

            .score-value {
                font-size: 1.5rem;
            }

            /* Better spacing for mobile lists */
            .space-y-4 > * + * {
                margin-top: 1.25rem;
            }

            /* Full width buttons on mobile */
            .btn-secondary {
                width: 100%;
            }

            /* Hide desktop grid on mobile, show swipe container */
            .desktop-usage-grid {
                display: none !important;
            }
            .mobile-swipe-container {
                display: flex !important;
            }
            .mobile-swipe-dots {
                display: flex !important;
            }
        }

        /* Desktop: Hide swipe container, show carousel (outside mobile media query) */
        @media (min-width: 769px) {
            .mobile-swipe-container {
                display: none !important;
            }
            .mobile-swipe-dots {
                display: none !important;
            }
            .desktop-usage-grid {
                display: none !important;
            }
            .desktop-usage-carousel {
                display: flex !important;
            }
        }

        /* Desktop Usage Carousel - Compact Horizontal Strip */
        .desktop-usage-carousel {
            display: none;
            overflow-x: auto;
            scroll-behavior: smooth;
            gap: 1rem;
            padding: 0.5rem 0;
            margin-bottom: 2rem;
            cursor: grab;
            user-select: none;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.3) transparent;
        }

        .desktop-usage-carousel:active {
            cursor: grabbing;
        }

        .desktop-usage-carousel::-webkit-scrollbar {
            height: 6px;
        }

        .desktop-usage-carousel::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        .desktop-usage-carousel::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }

        .desktop-usage-carousel::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.5);
        }

        .compact-usage-cell {
            flex: 0 0 auto;
            min-width: 180px;
            max-width: 200px;
            background: white;
            border-radius: 1rem;
            padding: 1rem 1.25rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .compact-usage-cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .compact-cell-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .compact-cell-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .compact-cell-info {
            flex: 1;
            min-width: 0;
        }

        .compact-cell-name {
            font-weight: 700;
            font-size: 0.875rem;
            color: #1f2937;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .compact-cell-usage {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .compact-cell-usage strong {
            font-size: 1rem;
            color: #1f2937;
        }

        .compact-cell-bonus {
            color: #10b981;
            font-weight: 700;
        }

        .compact-progress-bar {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .compact-progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .compact-cell-footer {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .compact-cell-footer.exhausted {
            color: #ef4444;
            font-weight: 600;
        }

        .compact-cell-countdown {
            font-weight: 700;
            color: #dc2626;
        }

        /* Small phones (up to 375px) */
        @media (max-width: 375px) {
            html {
                font-size: 16px;
            }

            h1 { font-size: 1.625rem !important; }
            h2 { font-size: 1.375rem !important; }

            .mobile-padding {
                padding: 1.25rem !important;
            }

            .tab-btn {
                padding: 0.625rem 0.375rem;
                font-size: 0.8125rem !important;
            }
        }

        /* ------------------------------------------
           2.11 SAFE AREA (Notched Devices)
           ------------------------------------------ */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(0px, env(safe-area-inset-left));
                padding-right: max(0px, env(safe-area-inset-right));
            }
        }

        /* ------------------------------------------
           2.12 UTILITIES
           ------------------------------------------ */
        .text-truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .scrollable {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .hidden {
            display: none !important;
        }

        /* Glass morphism effect */
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Better selection colors */
        ::selection {
            background: rgba(124, 58, 237, 0.3);
            color: inherit;
        }

        /* Large screens - desktop optimizations */
        @media (min-width: 1280px) {
            /* Larger padding for cards on big screens */
            .card {
                padding: 3rem;
            }

            /* More gap in grids */
            .grid {
                gap: 1.5rem;
            }

            /* Wider form elements */
            .max-w-md {
                max-width: 30rem;
            }
        }

        @media (min-width: 1536px) {
            .card {
                padding: 3.5rem;
            }

            .max-w-md {
                max-width: 32rem;
            }
        }
    </style>
</head>

<body>
    <!-- ============================================
         SECTION 3: HTML VIEWS
         ============================================

         All views are rendered dynamically into #app-root
         See render functions in Section 4.5
         ============================================ -->
    <div id="app-root"></div>

    <!-- ============================================
         SECTION 4: SCRIPTS
         ============================================ -->
    <script>
    (function() {
        'use strict';

        /* ==========================================
           4.1 FIREBASE CONFIGURATION
           ========================================== */

        // Check Firebase loaded
        if (typeof firebase === 'undefined') {
            console.error('Firebase SDK not loaded');
            document.getElementById('app-root').innerHTML =
                '<div class="view-container view-centered"><div class="card text-center">' +
                '<h2 class="text-xl font-bold text-red-600 mb-2">Error</h2>' +
                '<p class="text-gray-600">Failed to load Firebase. Please refresh the page.</p></div></div>';
            return;
        }

        // Firebase project configuration
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAGczY5ZEIJdTq25BpQdia3lv2I556wOZo",
            authDomain: "ytseo-6d1b0.firebaseapp.com",
            projectId: "ytseo-6d1b0",
            storageBucket: "ytseo-6d1b0.firebasestorage.app",
            messagingSenderId: "382790048044",
            appId: "1:382790048044:web:cd427679ff72108c1f3489"
        };

        // Initialize Firebase
        firebase.initializeApp(FIREBASE_CONFIG);
        const auth = firebase.auth();
        const functions = firebase.functions();

        /* ==========================================
           4.2 APPLICATION STATE
           ========================================== */

        const state = {
            // Current view: initializing | login | register | forgot-password | dashboard | optimizer | results | history | admin | competitor | trends | thumbnail
            currentView: 'initializing',

            // App initialization state
            initializing: true,

            // User data
            user: null,
            profile: null,
            isAdmin: false,

            // UI state
            loading: false,
            error: null,
            success: null,

            // Loading progress state
            loadingProgress: 0,
            loadingStep: 0,
            loadingSteps: [
                { name: 'Fetching video data', icon: 'üé¨' },
                { name: 'Analyzing content', icon: 'üîç' },
                { name: 'Generating titles', icon: 'üìù' },
                { name: 'Writing description', icon: 'üìÑ' },
                { name: 'Creating tags', icon: 'üè∑Ô∏è' },
                { name: 'Calculating SEO score', icon: 'üìä' }
            ],
            loadingInterval: null,

            // Results page
            currentResults: null,    // Current optimization results
            resultsTab: 'titles',    // Current tab: titles | description | tags

            // History/Admin data
            historyData: null,       // List of past optimizations
            historyTab: 'all',       // Current history tab: 'all', 'optimization', 'competitor', 'trend', 'thumbnail', 'placement'
            allHistory: null,        // Combined history from all types
            competitorHistory: null, // Competitor analysis history
            trendHistory: null,      // Trend predictor history
            thumbnailHistory: null,  // Thumbnail history
            placementHistory: null,  // Placement Finder history
            historyCounts: null,     // Counts for each history type
            adminUsers: null,        // Admin user list
            adminLoading: false,

            // New features state
            competitorResults: null,  // Competitor analysis results
            trendResults: null,       // Trend prediction results
            thumbnailJob: null,       // Thumbnail generation job
            thumbnailStatus: null,    // Thumbnail job status
            thumbnailImage: null,     // Generated thumbnail URL

            // Thumbnail from optimizer context
            lastOptimization: null,   // Last optimization results for thumbnail context
            thumbnailStyle: 'professional', // professional | dramatic | minimal | bold
            thumbnailFromOptimizer: false,   // Flag if user came from optimizer results

            // Quota settings (from getUserProfile)
            quotaInfo: null,           // Quota info for each tool with reset times
            resetTimeMinutes: 1440,    // Admin-configured reset time in minutes
            countdownInterval: null,    // Interval for countdown timer

            // Admin settings
            adminQuotaSettings: null,   // For admin panel
            adminSelectedUser: null,    // Selected user for bonus uses

            // Bonus history
            bonusHistory: null,         // User's bonus history
            showBonusHistory: false     // Modal visibility
        };

        // Loading progress simulation - OPTIMIZED to prevent flickering
        // Adjusted timing to match ~90 second RunPod processing time
        function startLoadingProgress() {
            state.loadingProgress = 0;
            state.loadingStep = 0;

            if (state.loadingInterval) {
                clearInterval(state.loadingInterval);
            }

            state.loadingInterval = setInterval(function() {
                if (state.loadingProgress < 95) {
                    // Simulate realistic progress with slower speeds to match ~90s RunPod processing
                    // 0-30%: Initial analysis (fast) - ~10 seconds
                    // 30-60%: AI prompt creation (medium) - ~15 seconds
                    // 60-85%: Image generation (slow) - ~45 seconds (main RunPod work)
                    // 85-95%: Rendering HD (very slow) - ~20 seconds
                    var increment;
                    if (state.loadingProgress < 30) {
                        increment = Math.random() * 2 + 1; // Fast start: 1-3%
                    } else if (state.loadingProgress < 60) {
                        increment = Math.random() * 1.2 + 0.3; // Medium: 0.3-1.5%
                    } else if (state.loadingProgress < 85) {
                        increment = Math.random() * 0.4 + 0.1; // Slow: 0.1-0.5%
                    } else {
                        increment = Math.random() * 0.2 + 0.05; // Very slow: 0.05-0.25%
                    }

                    state.loadingProgress = Math.min(95, state.loadingProgress + increment);

                    // Update current step based on progress (4 steps to match UI)
                    if (state.loadingProgress < 25) state.loadingStep = 0;      // Analyzing video context
                    else if (state.loadingProgress < 50) state.loadingStep = 1; // Creating AI prompt
                    else if (state.loadingProgress < 80) state.loadingStep = 2; // Generating image
                    else state.loadingStep = 3;                                  // Rendering HD

                    // OPTIMIZED: Only update specific elements instead of full render
                    updateLoadingUI();
                }
            }, 1000); // Increased interval from 500ms to 1000ms for slower progress
        }

        // Targeted loading UI update to prevent flickering
        function updateLoadingUI() {
            // Update percentage display
            var percentEls = document.querySelectorAll('.progress-percentage');
            percentEls.forEach(function(el) {
                el.textContent = Math.round(state.loadingProgress) + '%';
            });

            // Update progress bar
            var barEls = document.querySelectorAll('.progress-bar-fill');
            barEls.forEach(function(el) {
                el.style.width = state.loadingProgress + '%';
            });

            // Update step icons
            var stepEls = document.querySelectorAll('.loading-step');
            stepEls.forEach(function(el, index) {
                var iconEl = el.querySelector('.step-icon');
                if (index < state.loadingStep) {
                    el.className = 'loading-step completed';
                    if (iconEl) {
                        iconEl.className = 'step-icon completed';
                        iconEl.textContent = '‚úì';
                    }
                } else if (index === state.loadingStep) {
                    el.className = 'loading-step active';
                    if (iconEl) {
                        iconEl.className = 'step-icon active';
                    }
                }
            });
        }

        function stopLoadingProgress() {
            if (state.loadingInterval) {
                clearInterval(state.loadingInterval);
                state.loadingInterval = null;
            }
            state.loadingProgress = 100;
            state.loadingStep = state.loadingSteps.length - 1;
        }

        // Countdown timer for quota reset
        function startCountdownTimer() {
            if (state.countdownInterval) {
                clearInterval(state.countdownInterval);
            }
            state.countdownInterval = setInterval(function() {
                updateCountdownDisplays();
            }, 1000);
        }

        function updateCountdownDisplays() {
            var countdownEls = document.querySelectorAll('.quota-countdown');
            var now = Date.now();
            countdownEls.forEach(function(el) {
                var resetAt = parseInt(el.getAttribute('data-reset-at'));
                if (resetAt) {
                    var remaining = Math.max(0, resetAt - now);
                    if (remaining > 0) {
                        var hours = Math.floor(remaining / 3600000);
                        var minutes = Math.floor((remaining % 3600000) / 60000);
                        var seconds = Math.floor((remaining % 60000) / 1000);
                        var timeStr = '';
                        if (hours > 0) timeStr += hours + 'h ';
                        if (minutes > 0 || hours > 0) timeStr += minutes + 'm ';
                        timeStr += seconds + 's';
                        el.textContent = timeStr;
                    } else {
                        el.textContent = 'Ready!';
                        el.classList.add('text-green-500');
                    }
                }
            });
        }

        function formatCountdown(ms) {
            if (ms <= 0) return 'Ready!';
            var hours = Math.floor(ms / 3600000);
            var minutes = Math.floor((ms % 3600000) / 60000);
            var seconds = Math.floor((ms % 60000) / 1000);
            var parts = [];
            if (hours > 0) parts.push(hours + 'h');
            if (minutes > 0 || hours > 0) parts.push(minutes + 'm');
            parts.push(seconds + 's');
            return parts.join(' ');
        }

        /* ==========================================
           4.3 UTILITY FUNCTIONS
           ========================================== */

        const utils = {
            /**
             * Format large numbers (e.g., 1500000 -> 1.5M)
             */
            formatNumber: function(n) {
                if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
                if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
                return String(n);
            },

            /**
             * Calculate usage percentage
             */
            getUsagePercent: function(used, limit) {
                return Math.min(100, Math.round((used / limit) * 100));
            },

            /**
             * Get color class based on usage percentage
             */
            getUsageColor: function(percent) {
                if (percent >= 80) return 'bg-red-500';
                if (percent >= 60) return 'bg-yellow-500';
                return 'bg-green-500';
            },

            /**
             * Validate email format
             */
            validateEmail: function(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            },

            /**
             * Escape HTML special characters
             */
            escapeHtml: function(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            /**
             * Escape string for use in JavaScript
             */
            escapeJs: function(text) {
                return String(text)
                    .replace(/\\/g, '\\\\')
                    .replace(/'/g, "\\'")
                    .replace(/"/g, '\\"')
                    .replace(/\n/g, '\\n')
                    .replace(/\r/g, '\\r');
            },

            /**
             * Format date for display
             */
            formatDate: function(timestamp) {
                const date = new Date(timestamp);
                return {
                    date: date.toLocaleDateString(),
                    time: date.toLocaleTimeString()
                };
            }
        };

        /* ==========================================
           4.4 AUTH & API FUNCTIONS
           ========================================== */

        // Auth state listener
        auth.onAuthStateChanged(async function(user) {
            var wasInitializing = state.initializing;
            state.initializing = false;

            if (user) {
                state.user = user;
                try {
                    const result = await functions.httpsCallable('getUserProfile')();
                    state.profile = result.data.profile;
                    state.quotaInfo = result.data.quotaInfo || null;
                    state.resetTimeMinutes = result.data.resetTimeMinutes || 1440;
                    // Check admin status
                    state.isAdmin = state.profile.isAdmin === true;
                    // Start countdown timer if on dashboard
                    startCountdownTimer();
                    // Redirect to dashboard if coming from initializing, login, or register
                    if (wasInitializing || state.currentView === 'login' || state.currentView === 'register' || state.currentView === 'initializing') {
                        state.currentView = 'dashboard';
                    }
                    render();
                } catch (e) {
                    state.error = 'Failed to load profile';
                    state.currentView = 'login';
                    render();
                }
            } else {
                state.user = null;
                state.profile = null;
                state.isAdmin = false;
                if (state.currentView !== 'register' && state.currentView !== 'forgot-password') {
                    state.currentView = 'login';
                }
                render();
            }
        });

        /* ==========================================
           4.5 APP ACTIONS (Global)
           ========================================== */

        window.app = {

            /* ------------------------------------------
               4.5.1 Navigation Actions
               ------------------------------------------ */

            goToLogin: function() {
                state.currentView = 'login';
                state.error = null;
                state.success = null;
                render();
            },

            goToRegister: function() {
                state.currentView = 'register';
                state.error = null;
                state.success = null;
                render();
            },

            goToForgotPassword: function() {
                state.currentView = 'forgot-password';
                state.error = null;
                state.success = null;
                render();
            },

            goToDashboard: function(skipRefresh) {
                state.currentView = 'dashboard';
                state.error = null;
                render();

                // Refresh profile data unless explicitly skipped
                if (!skipRefresh && state.user) {
                    functions.httpsCallable('getUserProfile')()
                        .then(function(result) {
                            state.profile = result.data.profile;
                            state.quotaInfo = result.data.quotaInfo || null;
                            state.resetTimeMinutes = result.data.resetTimeMinutes || 1440;
                            state.isAdmin = state.profile.isAdmin === true;
                            startCountdownTimer();
                            render();
                        })
                        .catch(function(e) {
                            // Silently fail - keep showing cached data
                            console.warn('Failed to refresh profile:', e);
                        });
                }
            },

            goToOptimizer: function() {
                state.currentView = 'optimizer';
                state.error = null;
                render();
            },

            goToResults: function() {
                state.currentView = 'results';
                state.error = null;
                render();
            },

            goToHistory: function(tab) {
                state.currentView = 'history';
                state.error = null;
                state.loading = true;
                state.historyTab = tab || 'all';
                state.allHistory = null;
                state.historyData = null;
                state.competitorHistory = null;
                state.trendHistory = null;
                state.thumbnailHistory = null;
                state.placementHistory = null;
                state.historyCounts = null;
                render();

                // Fetch all history from backend
                functions.httpsCallable('getAllHistory')({ limit: 20 })
                    .then(function(result) {
                        var data = result.data;
                        state.allHistory = data.history.all || [];
                        state.historyData = data.history.optimizations || [];
                        state.competitorHistory = data.history.competitor || [];
                        state.trendHistory = data.history.trends || [];
                        state.thumbnailHistory = data.history.thumbnails || [];
                        state.placementHistory = data.history.placements || [];
                        state.historyCounts = data.counts || {};
                        state.loading = false;
                        render();
                    })
                    .catch(function(e) {
                        state.loading = false;
                        state.error = 'Failed to load history';
                        render();
                    });
            },

            setHistoryTab: function(tab) {
                state.historyTab = tab;
                render();
            },

            goToCompetitor: function() {
                state.currentView = 'competitor';
                state.error = null;
                state.competitorResults = null;
                render();
            },

            goToTrends: function() {
                state.currentView = 'trends';
                state.error = null;
                state.trendResults = null;
                render();
            },

            goToThumbnail: function(fromOptimizer) {
                state.currentView = 'thumbnail';
                state.error = null;
                state.thumbnailJob = null;
                state.thumbnailStatus = null;
                state.thumbnailImage = null;
                state.thumbnailFromOptimizer = fromOptimizer === true;
                render();
            },

            goToPlacement: function() {
                state.currentView = 'placement';
                state.error = null;
                state.placementResults = null;
                state.placementLoading = false;
                render();
            },

            viewPlacementHistory: function(id) {
                // Find the item from history
                var item = (state.allHistory || []).find(function(h) { return h.id === id && h.type === 'placement'; });
                if (!item && state.placementHistory) {
                    item = state.placementHistory.find(function(h) { return h.id === id; });
                }
                if (item) {
                    state.placementResults = {
                        historyId: item.id,
                        channelInfo: item.channelInfo,
                        analysis: item.analysis,
                        placements: item.placements || [],
                        totalFound: item.totalFound || 0,
                        maxAllowed: 50
                    };
                    state.currentView = 'placement';
                    render();
                }
            },

            // Bonus history modal functions
            openBonusHistory: function() {
                state.showBonusHistory = true;
                state.bonusHistory = null;
                render();

                // Fetch bonus history from backend
                functions.httpsCallable('getBonusHistory')()
                    .then(function(result) {
                        state.bonusHistory = result.data.history || [];
                        render();
                    })
                    .catch(function(e) {
                        state.bonusHistory = [];
                        state.error = { message: 'Failed to load bonus history' };
                        render();
                    });
            },

            closeBonusHistory: function() {
                state.showBonusHistory = false;
                render();
            },

            // Scroll to specific usage card (mobile swipe)
            scrollToUsageCard: function(index) {
                var container = document.getElementById('usageSwipeContainer');
                if (container) {
                    var cards = container.querySelectorAll('.mobile-swipe-card');
                    if (cards[index]) {
                        cards[index].scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                    }
                }
            },

            // Initialize swipe dots listener
            initSwipeDots: function() {
                var container = document.getElementById('usageSwipeContainer');
                var dotsContainer = document.getElementById('usageSwipeDots');
                if (container && dotsContainer) {
                    container.addEventListener('scroll', function() {
                        var cards = container.querySelectorAll('.mobile-swipe-card');
                        var containerRect = container.getBoundingClientRect();
                        var containerCenter = containerRect.left + containerRect.width / 2;

                        var closestIndex = 0;
                        var closestDistance = Infinity;

                        cards.forEach(function(card, index) {
                            var cardRect = card.getBoundingClientRect();
                            var cardCenter = cardRect.left + cardRect.width / 2;
                            var distance = Math.abs(containerCenter - cardCenter);

                            if (distance < closestDistance) {
                                closestDistance = distance;
                                closestIndex = index;
                            }
                        });

                        var dots = dotsContainer.querySelectorAll('.mobile-swipe-dot');
                        dots.forEach(function(dot, index) {
                            if (index === closestIndex) {
                                dot.classList.add('active');
                            } else {
                                dot.classList.remove('active');
                            }
                        });
                    });
                }
            },

            // Initialize desktop carousel drag-to-scroll
            initDesktopCarousel: function() {
                var carousel = document.getElementById('desktopUsageCarousel');
                if (!carousel) return;

                var isDown = false;
                var startX;
                var scrollLeft;

                carousel.addEventListener('mousedown', function(e) {
                    isDown = true;
                    carousel.classList.add('active');
                    startX = e.pageX - carousel.offsetLeft;
                    scrollLeft = carousel.scrollLeft;
                    e.preventDefault();
                });

                carousel.addEventListener('mouseleave', function() {
                    isDown = false;
                    carousel.classList.remove('active');
                });

                carousel.addEventListener('mouseup', function() {
                    isDown = false;
                    carousel.classList.remove('active');
                });

                carousel.addEventListener('mousemove', function(e) {
                    if (!isDown) return;
                    e.preventDefault();
                    var x = e.pageX - carousel.offsetLeft;
                    var walk = (x - startX) * 1.5; // Scroll speed multiplier
                    carousel.scrollLeft = scrollLeft - walk;
                });

                // Touch support for hybrid devices
                carousel.addEventListener('touchstart', function(e) {
                    startX = e.touches[0].pageX - carousel.offsetLeft;
                    scrollLeft = carousel.scrollLeft;
                }, { passive: true });

                carousel.addEventListener('touchmove', function(e) {
                    var x = e.touches[0].pageX - carousel.offsetLeft;
                    var walk = (x - startX) * 1.5;
                    carousel.scrollLeft = scrollLeft - walk;
                }, { passive: true });
            },

            /* ------------------------------------------
               4.5.2 Authentication Actions
               ------------------------------------------ */

            signInWithGoogle: function() {
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.setCustomParameters({
                    prompt: 'select_account'
                });

                state.loading = true;
                render();

                auth.signInWithPopup(provider)
                    .then(function(result) {
                        state.loading = false;
                    })
                    .catch(function(error) {
                        state.loading = false;
                        state.error = 'Google sign-in failed. Please try again.';
                        render();
                    });
            },

            register: function(e) {
                e.preventDefault();
                const email = document.getElementById('register-email').value.trim();
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;

                state.error = null;

                // Validation
                if (!utils.validateEmail(email)) {
                    state.error = 'Please enter a valid email address';
                    render();
                    return;
                }

                if (password.length < 6) {
                    state.error = 'Password must be at least 6 characters';
                    render();
                    return;
                }

                if (password !== confirmPassword) {
                    state.error = 'Passwords do not match';
                    render();
                    return;
                }

                state.loading = true;
                render();

                auth.createUserWithEmailAndPassword(email, password)
                    .then(function(result) {
                        state.loading = false;
                    })
                    .catch(function(error) {
                        state.loading = false;

                        switch (error.code) {
                            case 'auth/email-already-in-use':
                                state.error = 'This email is already registered. Please sign in.';
                                break;
                            case 'auth/invalid-email':
                                state.error = 'Invalid email address';
                                break;
                            case 'auth/weak-password':
                                state.error = 'Password is too weak';
                                break;
                            default:
                                state.error = 'Registration failed: ' + error.message;
                        }
                        render();
                    });
            },

            signIn: function(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value.trim();
                const password = document.getElementById('login-password').value;

                state.error = null;

                if (!email || !password) {
                    state.error = 'Please enter email and password';
                    render();
                    return;
                }

                state.loading = true;
                render();

                auth.signInWithEmailAndPassword(email, password)
                    .then(function(result) {
                        state.loading = false;
                    })
                    .catch(function(error) {
                        state.loading = false;

                        switch (error.code) {
                            case 'auth/user-not-found':
                            case 'auth/wrong-password':
                                state.error = 'Invalid email or password';
                                break;
                            case 'auth/invalid-email':
                                state.error = 'Invalid email address';
                                break;
                            case 'auth/user-disabled':
                                state.error = 'This account has been disabled';
                                break;
                            default:
                                state.error = 'Sign in failed: ' + error.message;
                        }
                        render();
                    });
            },

            resetPassword: function(e) {
                e.preventDefault();
                const email = document.getElementById('reset-email').value.trim();

                state.error = null;
                state.success = null;

                if (!utils.validateEmail(email)) {
                    state.error = 'Please enter a valid email address';
                    render();
                    return;
                }

                state.loading = true;
                render();

                auth.sendPasswordResetEmail(email)
                    .then(function() {
                        state.loading = false;
                        state.success = 'Password reset email sent! Check your inbox.';
                        render();
                    })
                    .catch(function(error) {
                        state.loading = false;

                        switch (error.code) {
                            case 'auth/user-not-found':
                                state.error = 'No account found with this email';
                                break;
                            case 'auth/invalid-email':
                                state.error = 'Invalid email address';
                                break;
                            default:
                                state.error = 'Failed to send reset email: ' + error.message;
                        }
                        render();
                    });
            },

            signOut: function() {
                auth.signOut();
            },

            /* ------------------------------------------
               4.5.3 Optimizer Actions
               ------------------------------------------ */

            optimize: function(e) {
                e.preventDefault();
                const url = document.getElementById('video-url').value.trim();

                if (!url) {
                    state.error = { message: 'Please enter a video URL', type: 'validation' };
                    render();
                    return;
                }

                // Validate URL format
                if (!url.includes('youtube.com') && !url.includes('youtu.be')) {
                    state.error = { message: 'Please enter a valid YouTube URL', type: 'validation' };
                    render();
                    return;
                }

                state.loading = true;
                state.error = null;
                startLoadingProgress();
                render();

                functions.httpsCallable('optimizeVideo')({ videoUrl: url })
                    .then(function(result) {
                        stopLoadingProgress();
                        state.currentResults = result.data;
                        state.lastOptimization = result.data; // Save for thumbnail generator
                        state.loading = false;
                        state.currentView = 'results';
                        return functions.httpsCallable('getUserProfile')();
                    })
                    .then(function(result) {
                        state.profile = result.data.profile;
                        render();
                    })
                    .catch(function(e) {
                        stopLoadingProgress();
                        state.loading = false;

                        // Parse Firebase error for detailed message
                        var errorMessage = 'Optimization failed. Please try again.';
                        var errorDetails = null;
                        var errorType = 'unknown';

                        if (e.code) {
                            errorType = e.code;

                            // Map Firebase error codes to user-friendly messages
                            switch (e.code) {
                                case 'functions/internal':
                                    // Check the error message for more specific issues
                                    if (e.message && e.message.includes('API')) {
                                        errorMessage = 'YouTube API error. The API may not be enabled.';
                                        errorDetails = 'Admin: Enable YouTube Data API v3 in Google Cloud Console';
                                    } else if (e.message && e.message.includes('quota')) {
                                        errorMessage = 'API quota exceeded. Please try again later.';
                                    } else {
                                        errorMessage = 'Server error occurred.';
                                        errorDetails = e.message || 'No additional details available';
                                    }
                                    break;
                                case 'functions/failed-precondition':
                                    // API not enabled or configured
                                    errorMessage = e.message || 'Service not properly configured.';
                                    if (e.message && e.message.includes('YouTube API')) {
                                        errorDetails = 'Go to Google Cloud Console ‚Üí APIs & Services ‚Üí Enable YouTube Data API v3';
                                    } else if (e.message && e.message.includes('API key')) {
                                        errorDetails = 'Check Firebase Functions config: firebase functions:config:set youtube.key="YOUR_KEY"';
                                    }
                                    break;
                                case 'functions/unauthenticated':
                                    errorMessage = 'You must be logged in to optimize videos.';
                                    break;
                                case 'functions/resource-exhausted':
                                    if (e.message && e.message.includes('quota')) {
                                        errorMessage = 'YouTube API quota exceeded. Please try again later.';
                                        errorDetails = 'The daily API limit has been reached. Try again tomorrow.';
                                    } else {
                                        errorMessage = 'Daily limit reached. Please upgrade your plan or try again tomorrow.';
                                        errorDetails = e.message;
                                    }
                                    break;
                                case 'functions/invalid-argument':
                                    errorMessage = 'Invalid video URL. Please check and try again.';
                                    break;
                                case 'functions/not-found':
                                    errorMessage = e.message || 'Video not found. Please check the URL.';
                                    break;
                                case 'functions/permission-denied':
                                    errorMessage = 'Access denied. Please check your subscription.';
                                    break;
                                case 'functions/unavailable':
                                    errorMessage = 'Service temporarily unavailable. Please try again.';
                                    break;
                                default:
                                    errorMessage = e.message || 'An unexpected error occurred.';
                            }
                        } else if (e.message) {
                            errorMessage = e.message;
                        }

                        state.error = {
                            message: errorMessage,
                            details: errorDetails,
                            code: e.code || 'unknown',
                            type: errorType,
                            raw: e.message // For debugging
                        };
                        render();
                    });
            },

            /* ------------------------------------------
               4.5.4 Utility Actions
               ------------------------------------------ */

            copyToClipboard: function(text, buttonId) {
                const showSuccess = function(btn) {
                    if (!btn) return;
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '‚úÖ Copied!';
                    btn.classList.add('bg-green-500');
                    setTimeout(function() {
                        btn.innerHTML = originalText;
                        btn.classList.remove('bg-green-500');
                    }, 2000);
                };

                const btn = document.getElementById(buttonId);

                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).then(function() {
                        showSuccess(btn);
                    });
                } else {
                    // Fallback for older browsers
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        showSuccess(btn);
                    } catch (err) {
                        alert('Copy failed. Please copy manually.');
                    }
                    document.body.removeChild(textarea);
                }
            },

            viewHistoryItem: function(index, id) {
                var item = null;
                if (id) {
                    // Find by ID (from "all" tab)
                    item = (state.allHistory || []).find(function(h) { return h.id === id && h.type === 'optimization'; });
                    if (!item) item = (state.historyData || []).find(function(h) { return h.id === id; });
                } else if (state.historyData && state.historyData[index]) {
                    item = state.historyData[index];
                }
                if (item) {
                    state.currentResults = item;
                    state.lastOptimization = item; // For thumbnail generator
                    state.currentView = 'results';
                    render();
                }
            },

            viewCompetitorHistory: function(index, id) {
                var item = null;
                if (id) {
                    item = (state.allHistory || []).find(function(h) { return h.id === id && h.type === 'competitor'; });
                    if (!item) item = (state.competitorHistory || []).find(function(h) { return h.id === id; });
                } else if (state.competitorHistory && state.competitorHistory[index]) {
                    item = state.competitorHistory[index];
                }
                if (item) {
                    state.competitorResults = item;
                    state.currentView = 'competitor';
                    render();
                }
            },

            viewTrendHistory: function(index, id) {
                var item = null;
                if (id) {
                    item = (state.allHistory || []).find(function(h) { return h.id === id && h.type === 'trend'; });
                    if (!item) item = (state.trendHistory || []).find(function(h) { return h.id === id; });
                } else if (state.trendHistory && state.trendHistory[index]) {
                    item = state.trendHistory[index];
                }
                if (item) {
                    state.trendResults = item;
                    state.currentView = 'trends';
                    render();
                }
            },

            viewThumbnailHistory: function(index, id) {
                var item = null;
                if (id) {
                    item = (state.allHistory || []).find(function(h) { return h.id === id && h.type === 'thumbnail'; });
                    if (!item) item = (state.thumbnailHistory || []).find(function(h) { return h.id === id; });
                } else if (state.thumbnailHistory && state.thumbnailHistory[index]) {
                    item = state.thumbnailHistory[index];
                }
                if (item) {
                    state.thumbnailImage = item.imageUrl;
                    state.thumbnailJob = { id: item.jobId };
                    state.thumbnailStatus = item.status;
                    state.currentView = 'thumbnail';
                    render();
                }
            },

            deleteHistoryItem: function(type, id, index) {
                if (!confirm('Are you sure you want to delete this item?')) return;

                var functionName;
                switch(type) {
                    case 'optimization': functionName = 'deleteOptimization'; break;
                    case 'competitor': functionName = 'deleteCompetitorAnalysis'; break;
                    case 'trend': functionName = 'deleteTrendPrediction'; break;
                    case 'thumbnail': functionName = 'deleteThumbnail'; break;
                    case 'placement': functionName = 'deletePlacementFinder'; break;
                    default: return;
                }

                state.loading = true;
                render();

                functions.httpsCallable(functionName)({ id: id })
                    .then(function(result) {
                        // Remove from local state
                        switch(type) {
                            case 'optimization':
                                state.historyData.splice(index, 1);
                                state.historyCounts.optimizations--;
                                break;
                            case 'competitor':
                                state.competitorHistory.splice(index, 1);
                                state.historyCounts.competitor--;
                                break;
                            case 'trend':
                                state.trendHistory.splice(index, 1);
                                state.historyCounts.trends--;
                                break;
                            case 'thumbnail':
                                state.thumbnailHistory.splice(index, 1);
                                state.historyCounts.thumbnails--;
                                break;
                            case 'placement':
                                if (state.placementHistory) state.placementHistory.splice(index, 1);
                                if (state.historyCounts) state.historyCounts.placements--;
                                break;
                        }
                        // Also remove from allHistory
                        if (state.allHistory) {
                            state.allHistory = state.allHistory.filter(function(item) {
                                return item.id !== id;
                            });
                        }
                        state.loading = false;
                        state.success = 'Item deleted successfully';
                        render();
                        setTimeout(function() { state.success = null; render(); }, 3000);
                    })
                    .catch(function(e) {
                        state.loading = false;
                        state.error = 'Failed to delete: ' + e.message;
                        render();
                    });
            },

            toggleErrorDetails: function() {
                var details = document.getElementById('error-details');
                if (details) {
                    details.classList.toggle('hidden');
                    var btn = details.previousElementSibling;
                    if (btn && btn.tagName === 'BUTTON') {
                        btn.textContent = details.classList.contains('hidden') ? 'Show Technical Details' : 'Hide Technical Details';
                    }
                }
            },

            /* ------------------------------------------
               4.5.5 Results Tab Actions
               ------------------------------------------ */

            setResultsTab: function(tab) {
                state.resultsTab = tab;
                render();
            },

            /* ------------------------------------------
               4.5.6 Admin Actions
               ------------------------------------------ */

            goToAdmin: function() {
                state.currentView = 'admin';
                state.error = null;
                state.adminLoading = true;
                render();

                // Load admin data
                functions.httpsCallable('adminGetUsers')()
                    .then(function(result) {
                        state.adminUsers = result.data.users || [];
                        state.adminLoading = false;
                        render();
                    })
                    .catch(function(e) {
                        state.adminLoading = false;
                        state.error = { message: 'Failed to load admin data: ' + e.message };
                        render();
                    });
            },

            setupAdmin: function() {
                state.loading = true;
                render();

                functions.httpsCallable('setupAdmin')()
                    .then(function(result) {
                        state.loading = false;
                        state.isAdmin = true;
                        state.success = result.data.message;
                        render();
                    })
                    .catch(function(e) {
                        state.loading = false;
                        state.error = { message: 'Failed to setup admin: ' + e.message };
                        render();
                    });
            },

            updateUserPlan: function(userId, newPlan) {
                state.adminLoading = true;
                render();

                functions.httpsCallable('adminUpdateUserPlan')({ userId: userId, plan: newPlan })
                    .then(function(result) {
                        // Refresh user list
                        return functions.httpsCallable('adminGetUsers')();
                    })
                    .then(function(result) {
                        state.adminUsers = result.data.users || [];
                        state.adminLoading = false;
                        state.success = 'User plan updated successfully!';
                        render();
                        setTimeout(function() { state.success = null; render(); }, 3000);
                    })
                    .catch(function(e) {
                        state.adminLoading = false;
                        state.error = { message: 'Failed to update user: ' + e.message };
                        render();
                    });
            },

            checkAdminStatus: function() {
                // Check if user is admin when profile loads
                if (state.profile && state.profile.isAdmin) {
                    state.isAdmin = true;
                }
            },

            setQuotaResetTime: function() {
                var resetMinutes = parseInt(document.getElementById('reset-time-input').value);
                if (!resetMinutes || resetMinutes < 1) {
                    state.error = { message: 'Please enter a valid number of minutes (minimum 1)' };
                    render();
                    return;
                }

                state.adminLoading = true;
                render();

                functions.httpsCallable('adminSetQuotaSettings')({ resetTimeMinutes: resetMinutes })
                    .then(function(result) {
                        state.adminLoading = false;
                        state.resetTimeMinutes = resetMinutes;
                        state.success = 'Quota reset time updated to ' + resetMinutes + ' minutes!';
                        render();
                        setTimeout(function() { state.success = null; render(); }, 3000);
                    })
                    .catch(function(e) {
                        state.adminLoading = false;
                        // Firebase Functions errors have code, message, and details
                        var errorMsg = e.message || 'Unknown error';
                        if (e.details) errorMsg = e.details;
                        // If only got error code, provide more context
                        if (errorMsg === 'internal' || errorMsg === 'INTERNAL') {
                            errorMsg = 'Server error occurred. Please check Firebase Functions logs for details.';
                        }
                        console.error('Admin setQuotaResetTime error:', e);
                        state.error = { message: 'Failed to update reset time: ' + errorMsg };
                        render();
                    });
            },

            grantBonusUses: function() {
                var userId = document.getElementById('bonus-user-select').value;
                var tool = document.getElementById('bonus-tool-select').value;
                var amount = parseInt(document.getElementById('bonus-amount-input').value);

                if (!userId) {
                    state.error = { message: 'Please select a user' };
                    render();
                    return;
                }
                if (!amount || amount < 1) {
                    state.error = { message: 'Please enter a valid bonus amount (minimum 1)' };
                    render();
                    return;
                }

                state.adminLoading = true;
                render();

                functions.httpsCallable('adminGrantBonusUses')({ userId: userId, tool: tool, bonusAmount: amount })
                    .then(function(result) {
                        state.adminLoading = false;
                        state.success = 'Granted ' + amount + ' bonus uses for ' + tool + '!';
                        // Refresh user list
                        return functions.httpsCallable('adminGetUsers')();
                    })
                    .then(function(result) {
                        if (result && result.data) {
                            state.adminUsers = result.data.users || [];
                        }
                        render();
                        setTimeout(function() { state.success = null; render(); }, 3000);
                    })
                    .catch(function(e) {
                        state.adminLoading = false;
                        state.error = { message: 'Failed to grant bonus: ' + e.message };
                        render();
                    });
            },

            /* ------------------------------------------
               4.5.5 Competitor Analysis Actions
               ------------------------------------------ */
            analyzeCompetitor: function(e) {
                e.preventDefault();
                const url = document.getElementById('competitor-url').value.trim();

                if (!url) {
                    state.error = { message: 'Please enter a competitor video URL' };
                    render();
                    return;
                }

                state.loading = true;
                state.error = null;
                state.loadingSteps = [
                    { name: 'Fetching video data', icon: 'üé¨' },
                    { name: 'Analyzing channel', icon: 'üì∫' },
                    { name: 'Evaluating SEO', icon: 'üîç' },
                    { name: 'Finding weaknesses', icon: 'üéØ' },
                    { name: 'Generating strategy', icon: 'üìä' }
                ];
                startLoadingProgress();
                render();

                functions.httpsCallable('analyzeCompetitor')({ videoUrl: url })
                    .then(function(result) {
                        stopLoadingProgress();
                        state.competitorResults = result.data;
                        state.loading = false;
                        render();
                    })
                    .catch(function(e) {
                        stopLoadingProgress();
                        state.loading = false;
                        state.error = { message: 'Analysis failed: ' + e.message };
                        render();
                    });
            },

            /* ------------------------------------------
               4.5.6 Trend Predictor Actions
               ------------------------------------------ */
            predictTrends: function(e) {
                e.preventDefault();
                const niche = document.getElementById('trend-niche').value.trim();
                const country = document.getElementById('trend-country').value || 'US';

                if (!niche) {
                    state.error = { message: 'Please enter a niche/topic' };
                    render();
                    return;
                }

                state.loading = true;
                state.error = null;
                state.loadingSteps = [
                    { name: 'Scanning trending videos', icon: 'üìà' },
                    { name: 'Analyzing patterns', icon: 'üîç' },
                    { name: 'Identifying opportunities', icon: 'üéØ' },
                    { name: 'Predicting future trends', icon: 'üîÆ' },
                    { name: 'Generating video ideas', icon: 'üí°' }
                ];
                startLoadingProgress();
                render();

                functions.httpsCallable('predictTrends')({ niche: niche, country: country })
                    .then(function(result) {
                        stopLoadingProgress();
                        state.trendResults = result.data;
                        state.loading = false;
                        render();
                    })
                    .catch(function(e) {
                        stopLoadingProgress();
                        state.loading = false;
                        state.error = { message: 'Prediction failed: ' + e.message };
                        render();
                    });
            },

            /* ------------------------------------------
               4.5.7 Thumbnail Generator Actions
               ------------------------------------------ */
            setThumbnailStyle: function(style) {
                state.thumbnailStyle = style;
                render();
            },

            generateThumbnail: function(e) {
                e.preventDefault();
                var title = document.getElementById('thumbnail-title').value.trim();
                var customPrompt = document.getElementById('thumbnail-prompt')?.value.trim() || '';

                // Get video context if available
                var videoContext = '';
                if (state.lastOptimization && state.thumbnailFromOptimizer) {
                    var opt = state.lastOptimization;
                    var videoInfo = opt.videoInfo || {};
                    videoContext = 'Video context: ' + (videoInfo.channelTitle || '') + ' channel. ';
                    if (opt.tags && opt.tags.length > 0) {
                        videoContext += 'Keywords: ' + opt.tags.slice(0, 5).join(', ') + '. ';
                    }
                }

                // Build style-specific prompt
                var stylePrompts = {
                    professional: 'Clean, professional look with sharp focus, studio lighting, high contrast',
                    dramatic: 'Dramatic lighting, intense colors, bold shadows, cinematic feel',
                    minimal: 'Minimalist design, soft colors, clean background, elegant simplicity',
                    bold: 'Vibrant colors, eye-catching, bold graphics, high energy, dynamic composition'
                };

                var fullPrompt = stylePrompts[state.thumbnailStyle] + '. ' + videoContext + customPrompt;

                if (!title) {
                    state.error = { message: 'Please enter a video title' };
                    render();
                    return;
                }

                state.loading = true;
                state.error = null;
                state.thumbnailImage = null;
                state.loadingSteps = [
                    { name: 'Analyzing video context', icon: 'üîç' },
                    { name: 'Creating AI prompt', icon: '‚ú®' },
                    { name: 'Generating image', icon: 'üé®' },
                    { name: 'Rendering HD', icon: 'üñºÔ∏è' }
                ];
                startLoadingProgress();
                render();

                functions.httpsCallable('generateThumbnail')({
                    title: title,
                    customPrompt: fullPrompt,
                    style: state.thumbnailStyle
                })
                    .then(function(result) {
                        state.thumbnailJob = result.data;
                        // Start polling for result
                        app.pollThumbnailStatus(result.data.jobId);
                    })
                    .catch(function(e) {
                        stopLoadingProgress();
                        state.loading = false;
                        state.error = { message: 'Generation failed: ' + e.message };
                        render();
                    });
            },

            pollThumbnailStatus: function(jobId) {
                var pollCount = 0;
                var maxPolls = 60; // Maximum 3 minutes (60 * 3 seconds)

                var pollInterval = setInterval(function() {
                    pollCount++;

                    // Check if exceeded max polls
                    if (pollCount > maxPolls) {
                        clearInterval(pollInterval);
                        stopLoadingProgress();
                        state.loading = false;
                        state.error = { message: 'Generation timed out. Please try again.' };
                        render();
                        return;
                    }

                    functions.httpsCallable('checkThumbnailStatus')({ jobId: jobId })
                        .then(function(result) {
                            state.thumbnailStatus = result.data.status;

                            if (result.data.status === 'COMPLETED') {
                                clearInterval(pollInterval);
                                stopLoadingProgress();
                                state.loading = false;

                                // The image URL was set in the initial generateThumbnail call
                                // RunPod uploads to Firebase Storage at state.thumbnailJob.imageUrl
                                var imageUrl = state.thumbnailJob?.imageUrl;

                                // Also check if RunPod returns output with image data (might be URL or base64)
                                var runpodOutput = result.data.output;
                                console.log('Thumbnail completed. Firebase URL:', imageUrl, 'RunPod output:', runpodOutput ? typeof runpodOutput : 'none');

                                // Try multiple sources for the image
                                // Priority: RunPod direct output > Firebase Storage URL (more reliable if RunPod provides it)
                                if (runpodOutput && typeof runpodOutput === 'string' && runpodOutput.length > 50) {
                                    // RunPod returned a URL or base64 data directly
                                    if (runpodOutput.startsWith('http') || runpodOutput.startsWith('data:')) {
                                        state.thumbnailImage = runpodOutput;
                                    } else {
                                        // Likely base64 encoded image
                                        state.thumbnailImage = 'data:image/png;base64,' + runpodOutput;
                                    }
                                } else if (imageUrl) {
                                    // Use Firebase Storage URL
                                    state.thumbnailImage = imageUrl;
                                } else {
                                    state.error = { message: 'Image generated but URL not available. Check Firebase Storage.' };
                                }

                                render();
                            } else if (result.data.status === 'FAILED') {
                                clearInterval(pollInterval);
                                stopLoadingProgress();
                                state.loading = false;
                                var errorDetail = result.data.error || 'Unknown error';
                                if (typeof errorDetail === 'object') {
                                    errorDetail = errorDetail.message || JSON.stringify(errorDetail);
                                }
                                state.error = { message: 'Thumbnail generation failed: ' + errorDetail };
                                render();
                            } else {
                                // Still processing (IN_QUEUE or IN_PROGRESS), update progress
                                if (state.loadingProgress < 90) {
                                    state.loadingProgress += 2;
                                }
                                updateLoadingUI();
                            }
                        })
                        .catch(function(e) {
                            // Don't clear interval on transient errors, just log
                            console.error('Thumbnail status check error:', e);
                            if (pollCount > 5) {
                                // Only fail after multiple attempts
                                clearInterval(pollInterval);
                                stopLoadingProgress();
                                state.loading = false;
                                state.error = { message: 'Status check failed: ' + e.message };
                                render();
                            }
                        });
                }, 3000); // Poll every 3 seconds
            },

            /* ------------------------------------------
               4.5.8 Placement Finder Actions
               ------------------------------------------ */
            findPlacements: function(e) {
                e.preventDefault();
                var channelUrl = document.getElementById('placement-channel-url').value.trim();

                if (!channelUrl) {
                    state.error = { message: 'Please enter your YouTube channel URL' };
                    render();
                    return;
                }

                state.placementLoading = true;
                state.loading = true;
                state.error = null;
                state.loadingSteps = [
                    { name: 'Analyzing your channel', icon: 'üì∫' },
                    { name: 'Understanding your content', icon: 'üîç' },
                    { name: 'Identifying your niche', icon: 'üéØ' },
                    { name: 'Searching similar channels', icon: 'üîé' },
                    { name: 'Scoring relevance', icon: 'üìä' },
                    { name: 'Compiling results', icon: '‚ú®' }
                ];
                startLoadingProgress();
                render();

                functions.httpsCallable('findPlacements')({ channelUrl: channelUrl })
                    .then(function(result) {
                        stopLoadingProgress();
                        state.placementResults = result.data;
                        state.placementLoading = false;
                        state.loading = false;
                        render();
                    })
                    .catch(function(e) {
                        stopLoadingProgress();
                        state.placementLoading = false;
                        state.loading = false;
                        state.error = { message: 'Failed to find placements: ' + e.message };
                        render();
                    });
            },

            findMorePlacements: function() {
                if (!state.placementResults || !state.placementResults.historyId) return;

                state.placementLoading = true;
                render();

                functions.httpsCallable('findMorePlacements')({ historyId: state.placementResults.historyId })
                    .then(function(result) {
                        state.placementResults.placements = result.data.placements;
                        state.placementResults.totalFound = result.data.totalFound;
                        state.placementLoading = false;
                        if (result.data.added === 0) {
                            state.error = { message: 'No more channels found matching your criteria.' };
                        }
                        render();
                    })
                    .catch(function(e) {
                        state.placementLoading = false;
                        state.error = { message: 'Failed to find more: ' + e.message };
                        render();
                    });
            },

            copyAllPlacements: function() {
                if (!state.placementResults || !state.placementResults.placements) return;

                var urls = state.placementResults.placements.map(function(p) {
                    return p.channelUrl;
                }).join('\n');

                navigator.clipboard.writeText(urls).then(function() {
                    state.copySuccess = 'Copied ' + state.placementResults.placements.length + ' channel URLs!';
                    render();
                    setTimeout(function() {
                        state.copySuccess = null;
                        render();
                    }, 3000);
                }).catch(function(err) {
                    state.error = { message: 'Failed to copy: ' + err.message };
                    render();
                });
            },

            copySinglePlacement: function(url) {
                navigator.clipboard.writeText(url).then(function() {
                    state.copySuccess = 'Channel URL copied!';
                    render();
                    setTimeout(function() {
                        state.copySuccess = null;
                        render();
                    }, 2000);
                }).catch(function(err) {
                    state.error = { message: 'Failed to copy: ' + err.message };
                    render();
                });
            }
        };

        /* ==========================================
           4.6 RENDER FUNCTIONS (Views)
           ========================================== */

        /* ------------------------------------------
           4.6.0 Initializing View (Loading Screen)
           ------------------------------------------ */
        function renderInitializing() {
            var html = '';
            html += '<div class="min-h-screen flex items-center justify-center">';
            html += '<div class="text-center fade-in">';
            html += '<div class="text-7xl mb-6">üé¨</div>';
            html += '<div class="spinner mx-auto mb-4"></div>';
            html += '<p class="text-white/80 text-lg">Loading...</p>';
            html += '</div>';
            html += '</div>';
            return html;
        }

        /* ------------------------------------------
           4.6.1 Login View
           ------------------------------------------ */
        function renderLogin() {
            var html = '';

            // Container
            html += '<div class="min-h-screen mobile-full-screen flex items-center justify-center px-4 py-8">';
            html += '<div class="max-w-md w-full mobile-card">';

            // Header
            html += '<div class="text-center mb-8 fade-in">';
            html += '<div class="text-6xl mb-4">üé¨</div>';
            html += '<h1 class="text-4xl mobile-text-xl font-bold text-white mb-2">YouTube Video Optimizer</h1>';
            html += '<p class="text-white/80 text-lg mobile-text-lg">AI-powered video optimization</p>';
            html += '</div>';

            // Card
            html += '<div class="bg-white rounded-2xl shadow-2xl p-8 mobile-padding fade-in">';
            html += '<h2 class="text-2xl mobile-text-xl font-bold text-gray-800 mb-6">Sign In</h2>';

            // Error message
            if (state.error) {
                html += '<div class="alert-error">' + utils.escapeHtml(state.error) + '</div>';
            }

            // Google Sign-In Button
            html += '<button onclick="app.signInWithGoogle()" class="google-btn w-full flex items-center justify-center gap-3 bg-white border-2 border-gray-300 rounded-xl py-4 px-6 text-gray-700 font-semibold hover:border-gray-400 mb-6"';
            if (state.loading) html += ' disabled';
            html += '>';
            html += '<svg width="20" height="20" viewBox="0 0 20 20"><path fill="#4285F4" d="M19.6 10.23c0-.82-.1-1.42-.25-2.05H10v3.72h5.5c-.15.96-.74 2.31-2.04 3.22v2.45h3.16c1.89-1.73 2.98-4.3 2.98-7.34z"/><path fill="#34A853" d="M13.46 15.13c-.83.59-1.96 1-3.46 1-2.64 0-4.88-1.74-5.68-4.15H1.07v2.52C2.72 17.75 6.09 20 10 20c2.7 0 4.96-.89 6.62-2.42l-3.16-2.45z"/><path fill="#FBBC05" d="M3.99 10c0-.69.12-1.35.32-1.97V5.51H1.07A9.973 9.973 0 000 10c0 1.61.39 3.14 1.07 4.49l3.24-2.52c-.2-.62-.32-1.28-.32-1.97z"/><path fill="#EA4335" d="M10 3.88c1.88 0 3.13.81 3.85 1.48l2.84-2.76C14.96.99 12.7 0 10 0 6.09 0 2.72 2.25 1.07 5.51l3.24 2.52C5.12 5.62 7.36 3.88 10 3.88z"/></svg>';
            html += state.loading ? 'Signing in...' : 'Sign in with Google';
            html += '</button>';

            // Divider
            html += '<div class="relative my-6">';
            html += '<div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>';
            html += '<div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">Or sign in with email</span></div>';
            html += '</div>';

            // Email/Password Form
            html += '<form onsubmit="app.signIn(event)">';
            html += '<div class="mb-4">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Email</label>';
            html += '<input type="email" id="login-email" required class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="your@email.com" />';
            html += '</div>';

            html += '<div class="mb-6">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Password</label>';
            html += '<input type="password" id="login-password" required class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />';
            html += '</div>';

            html += '<button type="submit" class="btn-primary"';
            if (state.loading) html += ' disabled';
            html += '>';
            html += state.loading ? '‚è≥ Signing in...' : 'üöÄ Sign In';
            html += '</button>';
            html += '</form>';

            // Forgot password link
            html += '<div class="mt-6 text-center">';
            html += '<button onclick="app.goToForgotPassword()" class="text-blue-600 hover:text-blue-700 font-semibold">Forgot Password?</button>';
            html += '</div>';

            // Register link
            html += '<div class="mt-4 pt-4 border-t border-gray-200 text-center">';
            html += '<p class="text-gray-600">Don\'t have an account?</p>';
            html += '<button onclick="app.goToRegister()" class="mt-2 text-purple-600 hover:text-purple-700 font-bold">Create Account ‚Üí</button>';
            html += '</div>';

            html += '</div></div></div>';

            return html;
        }

        /* ------------------------------------------
           4.6.2 Register View
           ------------------------------------------ */
        function renderRegister() {
            var html = '';

            // Container
            html += '<div class="min-h-screen flex items-center justify-center px-4 py-8">';
            html += '<div class="max-w-md w-full">';

            // Header
            html += '<div class="text-center mb-8 fade-in">';
            html += '<div class="text-6xl mb-4">üé¨</div>';
            html += '<h1 class="text-4xl font-bold text-white mb-2">Create Account</h1>';
            html += '<p class="text-white/80 text-lg">Start optimizing your videos</p>';
            html += '</div>';

            // Card
            html += '<div class="bg-white rounded-2xl shadow-2xl p-8 fade-in">';
            html += '<h2 class="text-2xl font-bold text-gray-800 mb-6">Register</h2>';

            // Error message
            if (state.error) {
                html += '<div class="alert-error">' + utils.escapeHtml(state.error) + '</div>';
            }

            // Google Sign-Up Button
            html += '<button onclick="app.signInWithGoogle()" class="google-btn w-full flex items-center justify-center gap-3 bg-white border-2 border-gray-300 rounded-xl py-4 px-6 text-gray-700 font-semibold hover:border-gray-400 mb-6"';
            if (state.loading) html += ' disabled';
            html += '>';
            html += '<svg width="20" height="20" viewBox="0 0 20 20"><path fill="#4285F4" d="M19.6 10.23c0-.82-.1-1.42-.25-2.05H10v3.72h5.5c-.15.96-.74 2.31-2.04 3.22v2.45h3.16c1.89-1.73 2.98-4.3 2.98-7.34z"/><path fill="#34A853" d="M13.46 15.13c-.83.59-1.96 1-3.46 1-2.64 0-4.88-1.74-5.68-4.15H1.07v2.52C2.72 17.75 6.09 20 10 20c2.7 0 4.96-.89 6.62-2.42l-3.16-2.45z"/><path fill="#FBBC05" d="M3.99 10c0-.69.12-1.35.32-1.97V5.51H1.07A9.973 9.973 0 000 10c0 1.61.39 3.14 1.07 4.49l3.24-2.52c-.2-.62-.32-1.28-.32-1.97z"/><path fill="#EA4335" d="M10 3.88c1.88 0 3.13.81 3.85 1.48l2.84-2.76C14.96.99 12.7 0 10 0 6.09 0 2.72 2.25 1.07 5.51l3.24 2.52C5.12 5.62 7.36 3.88 10 3.88z"/></svg>';
            html += state.loading ? 'Creating account...' : 'Sign up with Google';
            html += '</button>';

            // Divider
            html += '<div class="relative my-6">';
            html += '<div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>';
            html += '<div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">Or register with email</span></div>';
            html += '</div>';

            // Email/Password Form
            html += '<form onsubmit="app.register(event)">';
            html += '<div class="mb-4">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Email</label>';
            html += '<input type="email" id="register-email" required class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="your@email.com" />';
            html += '</div>';

            html += '<div class="mb-4">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Password (min 6 characters)</label>';
            html += '<input type="password" id="register-password" required minlength="6" class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />';
            html += '</div>';

            html += '<div class="mb-6">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Confirm Password</label>';
            html += '<input type="password" id="register-confirm-password" required minlength="6" class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />';
            html += '</div>';

            html += '<button type="submit" class="btn-primary"';
            if (state.loading) html += ' disabled';
            html += '>';
            html += state.loading ? '‚è≥ Creating account...' : 'üéâ Create Account';
            html += '</button>';
            html += '</form>';

            // Login link
            html += '<div class="mt-6 pt-4 border-t border-gray-200 text-center">';
            html += '<p class="text-gray-600">Already have an account?</p>';
            html += '<button onclick="app.goToLogin()" class="mt-2 text-purple-600 hover:text-purple-700 font-bold">Sign In ‚Üí</button>';
            html += '</div>';

            html += '</div></div></div>';

            return html;
        }

        /* ------------------------------------------
           4.6.3 Forgot Password View
           ------------------------------------------ */
        function renderForgotPassword() {
            var html = '';

            // Container
            html += '<div class="min-h-screen flex items-center justify-center px-4 py-8">';
            html += '<div class="max-w-md w-full">';

            // Header
            html += '<div class="text-center mb-8 fade-in">';
            html += '<div class="text-6xl mb-4">üîê</div>';
            html += '<h1 class="text-4xl font-bold text-white mb-2">Reset Password</h1>';
            html += '<p class="text-white/80 text-lg">We\'ll send you a reset link</p>';
            html += '</div>';

            // Card
            html += '<div class="bg-white rounded-2xl shadow-2xl p-8 fade-in">';
            html += '<h2 class="text-2xl font-bold text-gray-800 mb-6">Forgot Password?</h2>';

            // Messages
            if (state.error) {
                html += '<div class="alert-error">' + utils.escapeHtml(state.error) + '</div>';
            }
            if (state.success) {
                html += '<div class="alert-success">' + utils.escapeHtml(state.success) + '</div>';
            }

            // Form
            html += '<form onsubmit="app.resetPassword(event)">';
            html += '<div class="mb-6">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Email Address</label>';
            html += '<input type="email" id="reset-email" required class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="your@email.com" />';
            html += '<p class="text-sm text-gray-500 mt-2">Enter your email and we\'ll send you a password reset link</p>';
            html += '</div>';

            html += '<button type="submit" class="btn-primary"';
            if (state.loading) html += ' disabled';
            html += '>';
            html += state.loading ? '‚è≥ Sending...' : 'üìß Send Reset Link';
            html += '</button>';
            html += '</form>';

            // Back link
            html += '<div class="mt-6 pt-4 border-t border-gray-200 text-center">';
            html += '<button onclick="app.goToLogin()" class="text-purple-600 hover:text-purple-700 font-bold">‚Üê Back to Sign In</button>';
            html += '</div>';

            html += '</div></div></div>';

            return html;
        }

        /* ------------------------------------------
           4.6.4 Dashboard View
           ------------------------------------------ */
        function renderDashboard() {
            if (!state.profile) {
                return '<div class="text-white text-center py-12"><div class="spinner mx-auto mb-4"></div>Loading profile...</div>';
            }

            const p = state.profile;
            const plan = (p.subscription && p.subscription.plan) || 'free';
            const planName = plan.charAt(0).toUpperCase() + plan.slice(1);

            var html = '';

            // Container
            html += '<div class="min-h-screen mobile-full-screen py-8 px-4 lg:py-12">';
            html += '<div class="max-w-6xl mx-auto">';

            // Header - larger and more prominent
            html += '<div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-10 fade-in gap-6">';
            html += '<div>';
            html += '<h1 class="text-4xl lg:text-5xl font-bold text-white mb-3">Welcome back!</h1>';
            html += '<div class="flex flex-wrap gap-4 text-white/90">';
            html += '<span class="flex items-center gap-2 bg-white/10 px-4 py-2 rounded-full backdrop-blur"><span class="text-lg">üìß</span> ' + utils.escapeHtml(p.email || '') + '</span>';
            html += '<span class="flex items-center gap-2 bg-gradient-to-r from-purple-500/30 to-indigo-500/30 px-4 py-2 rounded-full backdrop-blur font-semibold"><span class="text-lg">‚≠ê</span> ' + planName + ' Plan</span>';
            html += '</div>';
            html += '</div>';
            html += '<button onclick="app.signOut()" class="btn-secondary">Sign Out</button>';
            html += '</div>';

            // Usage Stats - Tools data
            var tools = [
                { name: 'Warp Optimizer', key: 'warpOptimizer', emoji: 'üöÄ', color: 'from-blue-500 to-indigo-600' },
                { name: 'Competitor Analysis', key: 'competitorAnalysis', emoji: 'üéØ', color: 'from-red-500 to-orange-600' },
                { name: 'Trend Predictor', key: 'trendPredictor', emoji: 'üìà', color: 'from-cyan-500 to-blue-600' },
                { name: 'AI Thumbnails', key: 'thumbnailGenerator', emoji: 'üé®', color: 'from-pink-500 to-rose-600' },
                { name: 'Placement Finder', key: 'placementFinder', emoji: 'üé¨', color: 'from-purple-500 to-violet-600' }
            ];

            // Helper function to generate card HTML
            function generateUsageCard(tool, extraClass) {
                var usage = (p.usage && p.usage[tool.key]) || { usedToday: 0, limit: 2, lastResetAt: new Date().toISOString() };
                var quotaData = state.quotaInfo && state.quotaInfo[tool.key] ? state.quotaInfo[tool.key] : null;
                var totalLimit = quotaData ? quotaData.totalLimit : (usage.limit || 2);
                var baseLimit = quotaData ? quotaData.baseLimit : (usage.limit || 2);
                var bonusUses = quotaData ? quotaData.bonusUses : 0;

                var nextResetMs = 0;
                if (quotaData && quotaData.nextResetMs) {
                    nextResetMs = quotaData.nextResetMs;
                } else if (usage.lastResetAt) {
                    var lastResetTime = usage.lastResetAt;
                    if (typeof lastResetTime === 'object' && lastResetTime.seconds) {
                        lastResetTime = lastResetTime.seconds * 1000;
                    } else if (typeof lastResetTime === 'object' && lastResetTime._seconds) {
                        lastResetTime = lastResetTime._seconds * 1000;
                    } else if (typeof lastResetTime === 'string') {
                        lastResetTime = new Date(lastResetTime).getTime();
                    }
                    var resetIntervalMs = (state.resetTimeMinutes || 1440) * 60 * 1000;
                    nextResetMs = lastResetTime + resetIntervalMs;
                }

                var remainingUses = totalLimit - usage.usedToday;
                var isExhausted = remainingUses <= 0;
                var percent = utils.getUsagePercent(usage.usedToday, totalLimit);
                var color = utils.getUsageColor(percent);

                var cardHtml = '<div class="bg-white rounded-2xl shadow-lg p-6 lg:p-8 mobile-padding hover:shadow-xl transition-all ' + (extraClass || '') + '">';
                cardHtml += '<div class="flex justify-between items-start mb-4">';
                cardHtml += '<div class="w-14 h-14 lg:w-16 lg:h-16 bg-gradient-to-br ' + tool.color + ' rounded-2xl flex items-center justify-center text-3xl lg:text-4xl shadow-lg">' + tool.emoji + '</div>';
                cardHtml += '<div class="text-right">';
                cardHtml += '<span class="text-3xl lg:text-4xl font-bold text-gray-800">' + usage.usedToday + '<span class="text-xl lg:text-2xl text-gray-400">/' + baseLimit + '</span></span>';
                if (bonusUses > 0) {
                    cardHtml += '<span class="text-lg lg:text-xl font-bold text-green-500 ml-1">+' + bonusUses + '</span>';
                }
                cardHtml += '</div>';
                cardHtml += '</div>';
                cardHtml += '<h4 class="font-bold text-gray-800 text-lg lg:text-xl mb-3">' + tool.name + '</h4>';
                cardHtml += '<div class="w-full bg-gray-100 rounded-full h-3 mb-3">';
                cardHtml += '<div class="' + color + ' h-3 rounded-full usage-bar transition-all" style="width:' + percent + '%"></div>';
                cardHtml += '</div>';

                if (isExhausted) {
                    var now = Date.now();
                    if (!nextResetMs || nextResetMs <= now) {
                        var resetIntervalMs = (state.resetTimeMinutes || 1440) * 60 * 1000;
                        nextResetMs = now + resetIntervalMs;
                    }
                    var remainingMs = Math.max(0, nextResetMs - now);
                    cardHtml += '<div class="flex items-center justify-between">';
                    cardHtml += '<p class="text-sm lg:text-base text-red-500 font-medium">‚è±Ô∏è Resets in:</p>';
                    cardHtml += '<span class="quota-countdown text-red-600 font-bold text-lg" data-reset-at="' + nextResetMs + '">' + formatCountdown(remainingMs) + '</span>';
                    cardHtml += '</div>';
                } else {
                    cardHtml += '<p class="text-sm lg:text-base text-gray-500 font-medium">' + remainingUses + ' uses remaining</p>';
                }
                cardHtml += '</div>';
                return cardHtml;
            }

            // Helper function to generate compact usage cell for desktop carousel
            function generateCompactUsageCell(tool) {
                var usage = (p.usage && p.usage[tool.key]) || { usedToday: 0, limit: 2, lastResetAt: new Date().toISOString() };
                var quotaData = state.quotaInfo && state.quotaInfo[tool.key] ? state.quotaInfo[tool.key] : null;
                var totalLimit = quotaData ? quotaData.totalLimit : (usage.limit || 2);
                var baseLimit = quotaData ? quotaData.baseLimit : (usage.limit || 2);
                var bonusUses = quotaData ? quotaData.bonusUses : 0;

                var nextResetMs = 0;
                if (quotaData && quotaData.nextResetMs) {
                    nextResetMs = quotaData.nextResetMs;
                } else if (usage.lastResetAt) {
                    var lastResetTime = usage.lastResetAt;
                    if (typeof lastResetTime === 'object' && lastResetTime.seconds) {
                        lastResetTime = lastResetTime.seconds * 1000;
                    } else if (typeof lastResetTime === 'object' && lastResetTime._seconds) {
                        lastResetTime = lastResetTime._seconds * 1000;
                    } else if (typeof lastResetTime === 'string') {
                        lastResetTime = new Date(lastResetTime).getTime();
                    }
                    var resetIntervalMs = (state.resetTimeMinutes || 1440) * 60 * 1000;
                    nextResetMs = lastResetTime + resetIntervalMs;
                }

                var remainingUses = totalLimit - usage.usedToday;
                var isExhausted = remainingUses <= 0;
                var percent = utils.getUsagePercent(usage.usedToday, totalLimit);

                // Determine progress bar color class
                var progressColor = 'bg-gradient-to-r from-green-400 to-green-500';
                if (percent >= 100) {
                    progressColor = 'bg-gradient-to-r from-red-400 to-red-500';
                } else if (percent >= 50) {
                    progressColor = 'bg-gradient-to-r from-yellow-400 to-orange-500';
                }

                var cellHtml = '<div class="compact-usage-cell">';

                // Header: Icon + Info
                cellHtml += '<div class="compact-cell-header">';
                cellHtml += '<div class="compact-cell-icon bg-gradient-to-br ' + tool.color + '">' + tool.emoji + '</div>';
                cellHtml += '<div class="compact-cell-info">';
                cellHtml += '<div class="compact-cell-name">' + tool.name + '</div>';
                cellHtml += '<div class="compact-cell-usage"><strong>' + usage.usedToday + '</strong>/' + baseLimit;
                if (bonusUses > 0) {
                    cellHtml += ' <span class="compact-cell-bonus">+' + bonusUses + '</span>';
                }
                cellHtml += '</div>';
                cellHtml += '</div>';
                cellHtml += '</div>';

                // Progress bar
                cellHtml += '<div class="compact-progress-bar">';
                cellHtml += '<div class="compact-progress-fill ' + progressColor + '" style="width:' + percent + '%"></div>';
                cellHtml += '</div>';

                // Footer: remaining or countdown
                if (isExhausted) {
                    var now = Date.now();
                    if (!nextResetMs || nextResetMs <= now) {
                        var resetIntervalMs = (state.resetTimeMinutes || 1440) * 60 * 1000;
                        nextResetMs = now + resetIntervalMs;
                    }
                    var remainingMs = Math.max(0, nextResetMs - now);
                    cellHtml += '<div class="compact-cell-footer exhausted">';
                    cellHtml += '‚è±Ô∏è <span class="compact-cell-countdown quota-countdown" data-reset-at="' + nextResetMs + '">' + formatCountdown(remainingMs) + '</span>';
                    cellHtml += '</div>';
                } else {
                    cellHtml += '<div class="compact-cell-footer">' + remainingUses + ' remaining</div>';
                }

                cellHtml += '</div>';
                return cellHtml;
            }

            // Desktop Carousel (hidden on mobile) - compact horizontal strip
            html += '<div class="desktop-usage-carousel fade-in" id="desktopUsageCarousel">';
            for (var i = 0; i < tools.length; i++) {
                html += generateCompactUsageCell(tools[i]);
            }
            html += '</div>';

            // Desktop Grid - kept for fallback but hidden by CSS
            html += '<div class="desktop-usage-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 dashboard-grid-4 gap-5 lg:gap-6 mb-10 fade-in">';
            for (var i = 0; i < tools.length; i++) {
                html += generateUsageCard(tools[i], '');
            }
            html += '</div>';

            // Mobile Swipeable Container (hidden on desktop)
            html += '<div class="mobile-swipe-container mb-2 fade-in" id="usageSwipeContainer">';
            for (var i = 0; i < tools.length; i++) {
                html += generateUsageCard(tools[i], 'mobile-swipe-card');
            }
            html += '</div>';

            // Mobile Swipe Dots
            html += '<div class="mobile-swipe-dots mb-8" id="usageSwipeDots">';
            for (var i = 0; i < tools.length; i++) {
                html += '<div class="mobile-swipe-dot' + (i === 0 ? ' active' : '') + '" data-index="' + i + '" onclick="app.scrollToUsageCard(' + i + ')"></div>';
            }
            html += '</div>';

            // Check if user has any bonus uses to show history link
            var hasBonusUses = false;
            var toolKeys = ['warpOptimizer', 'competitorAnalysis', 'trendPredictor', 'thumbnailGenerator'];
            for (var j = 0; j < toolKeys.length; j++) {
                var qd = state.quotaInfo && state.quotaInfo[toolKeys[j]] ? state.quotaInfo[toolKeys[j]] : null;
                if (qd && qd.bonusUses > 0) {
                    hasBonusUses = true;
                    break;
                }
            }

            // Show bonus history link if user has bonus uses
            if (hasBonusUses) {
                html += '<div class="flex justify-end mb-4 fade-in">';
                html += '<button onclick="app.openBonusHistory()" class="text-sm text-green-400 hover:text-green-300 transition-colors flex items-center gap-1">';
                html += '<span>üéÅ</span> View Bonus History';
                html += '</button>';
                html += '</div>';
            }

            // Main Tools Section Title
            html += '<h2 class="text-2xl lg:text-3xl font-bold text-white mb-6 fade-in">üõ†Ô∏è AI Tools</h2>';

            // Action Cards - 5 tools in responsive grid
            html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8 fade-in">';

            // Optimizer Card
            html += '<div class="bg-gradient-to-br from-white to-gray-50 rounded-3xl shadow-xl p-6 lg:p-8 tool-card cursor-pointer border border-gray-100" onclick="app.goToOptimizer()">';
            html += '<div class="w-16 h-16 lg:w-20 lg:h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center text-4xl lg:text-5xl shadow-xl mb-5">üöÄ</div>';
            html += '<h3 class="text-xl lg:text-2xl font-bold text-gray-800 mb-2">Video Optimizer</h3>';
            html += '<p class="text-gray-600 mb-4 text-sm lg:text-base">AI-powered SEO optimization for your videos</p>';
            html += '<div class="flex items-center text-blue-600 font-bold group">';
            html += '<span>Optimize</span><span class="ml-2 group-hover:translate-x-2 transition-transform">‚Üí</span>';
            html += '</div></div>';

            // Competitor Analysis Card (NEW)
            html += '<div class="bg-gradient-to-br from-white to-gray-50 rounded-3xl shadow-xl p-6 lg:p-8 tool-card cursor-pointer border border-gray-100 relative overflow-hidden" onclick="app.goToCompetitor()">';
            html += '<div class="absolute top-3 right-3 bg-gradient-to-r from-green-400 to-emerald-500 text-white text-xs font-bold px-2 py-1 rounded-full">NEW</div>';
            html += '<div class="w-16 h-16 lg:w-20 lg:h-20 bg-gradient-to-br from-red-500 to-orange-600 rounded-2xl flex items-center justify-center text-4xl lg:text-5xl shadow-xl mb-5">üéØ</div>';
            html += '<h3 class="text-xl lg:text-2xl font-bold text-gray-800 mb-2">Competitor Analysis</h3>';
            html += '<p class="text-gray-600 mb-4 text-sm lg:text-base">Analyze competitors and find ways to beat them</p>';
            html += '<div class="flex items-center text-red-600 font-bold group">';
            html += '<span>Analyze</span><span class="ml-2 group-hover:translate-x-2 transition-transform">‚Üí</span>';
            html += '</div></div>';

            // Trend Predictor Card (NEW)
            html += '<div class="bg-gradient-to-br from-white to-gray-50 rounded-3xl shadow-xl p-6 lg:p-8 tool-card cursor-pointer border border-gray-100 relative overflow-hidden" onclick="app.goToTrends()">';
            html += '<div class="absolute top-3 right-3 bg-gradient-to-r from-green-400 to-emerald-500 text-white text-xs font-bold px-2 py-1 rounded-full">NEW</div>';
            html += '<div class="w-16 h-16 lg:w-20 lg:h-20 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-2xl flex items-center justify-center text-4xl lg:text-5xl shadow-xl mb-5">üìà</div>';
            html += '<h3 class="text-xl lg:text-2xl font-bold text-gray-800 mb-2">Trend Predictor</h3>';
            html += '<p class="text-gray-600 mb-4 text-sm lg:text-base">Predict viral trends before they happen</p>';
            html += '<div class="flex items-center text-cyan-600 font-bold group">';
            html += '<span>Predict</span><span class="ml-2 group-hover:translate-x-2 transition-transform">‚Üí</span>';
            html += '</div></div>';

            // Thumbnail Generator Card (NEW)
            html += '<div class="bg-gradient-to-br from-white to-gray-50 rounded-3xl shadow-xl p-6 lg:p-8 tool-card cursor-pointer border border-gray-100 relative overflow-hidden" onclick="app.goToThumbnail()">';
            html += '<div class="absolute top-3 right-3 bg-gradient-to-r from-green-400 to-emerald-500 text-white text-xs font-bold px-2 py-1 rounded-full">NEW</div>';
            html += '<div class="w-16 h-16 lg:w-20 lg:h-20 bg-gradient-to-br from-pink-500 to-rose-600 rounded-2xl flex items-center justify-center text-4xl lg:text-5xl shadow-xl mb-5">üé®</div>';
            html += '<h3 class="text-xl lg:text-2xl font-bold text-gray-800 mb-2">AI Thumbnails</h3>';
            html += '<p class="text-gray-600 mb-4 text-sm lg:text-base">Generate click-worthy thumbnails with AI</p>';
            html += '<div class="flex items-center text-pink-600 font-bold group">';
            html += '<span>Generate</span><span class="ml-2 group-hover:translate-x-2 transition-transform">‚Üí</span>';
            html += '</div></div>';

            // Placement Finder Card (NEW)
            html += '<div class="bg-gradient-to-br from-white to-gray-50 rounded-3xl shadow-xl p-6 lg:p-8 tool-card cursor-pointer border border-gray-100 relative overflow-hidden" onclick="app.goToPlacement()">';
            html += '<div class="absolute top-3 right-3 bg-gradient-to-r from-green-400 to-emerald-500 text-white text-xs font-bold px-2 py-1 rounded-full">NEW</div>';
            html += '<div class="w-16 h-16 lg:w-20 lg:h-20 bg-gradient-to-br from-purple-500 to-violet-600 rounded-2xl flex items-center justify-center text-4xl lg:text-5xl shadow-xl mb-5">üé¨</div>';
            html += '<h3 class="text-xl lg:text-2xl font-bold text-gray-800 mb-2">Placement Finder</h3>';
            html += '<p class="text-gray-600 mb-4 text-sm lg:text-base">Find YouTube channels for Google Ads placements</p>';
            html += '<div class="flex items-center text-purple-600 font-bold group">';
            html += '<span>Find Channels</span><span class="ml-2 group-hover:translate-x-2 transition-transform">‚Üí</span>';
            html += '</div></div>';

            // History Card
            html += '<div class="bg-gradient-to-br from-white to-gray-50 rounded-3xl shadow-xl p-6 lg:p-8 tool-card cursor-pointer border border-gray-100" onclick="app.goToHistory()">';
            html += '<div class="w-16 h-16 lg:w-20 lg:h-20 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl flex items-center justify-center text-4xl lg:text-5xl shadow-xl mb-5">üìú</div>';
            html += '<h3 class="text-xl lg:text-2xl font-bold text-gray-800 mb-2">History</h3>';
            html += '<p class="text-gray-600 mb-4 text-sm lg:text-base">View all your past optimizations</p>';
            html += '<div class="flex items-center text-purple-600 font-bold group">';
            html += '<span>View</span><span class="ml-2 group-hover:translate-x-2 transition-transform">‚Üí</span>';
            html += '</div></div>';

            html += '</div>';

            // Admin Section (only for admins)
            if (state.isAdmin) {
                html += '<div class="mt-8 fade-in">';
                html += '<div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl shadow-xl p-8 mobile-padding cursor-pointer hover:from-purple-700 hover:to-indigo-700 transition-all hover:shadow-2xl hover:scale-[1.02]" onclick="app.goToAdmin()">';
                html += '<div class="flex items-center gap-5">';
                html += '<div class="text-5xl">‚öôÔ∏è</div>';
                html += '<div class="flex-1">';
                html += '<h3 class="text-2xl font-bold text-white mb-1">Admin Dashboard</h3>';
                html += '<p class="text-white/80">Manage users, subscriptions & analytics</p>';
                html += '</div>';
                html += '<div class="text-white text-3xl">‚Üí</div>';
                html += '</div></div></div>';
            }

            html += '</div></div>';

            // Bonus History Modal
            if (state.showBonusHistory) {
                html += '<div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" onclick="app.closeBonusHistory()">';
                html += '<div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[80vh] overflow-hidden" onclick="event.stopPropagation()">';
                html += '<div class="bg-gradient-to-r from-green-500 to-emerald-600 p-6">';
                html += '<div class="flex justify-between items-center">';
                html += '<h3 class="text-xl font-bold text-white flex items-center gap-2"><span>üéÅ</span> Bonus History</h3>';
                html += '<button onclick="app.closeBonusHistory()" class="text-white/80 hover:text-white text-2xl">&times;</button>';
                html += '</div>';
                html += '</div>';
                html += '<div class="p-6 overflow-y-auto max-h-[60vh]">';

                if (state.bonusHistory === null) {
                    // Loading
                    html += '<div class="flex items-center justify-center py-8">';
                    html += '<div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-500"></div>';
                    html += '</div>';
                } else if (state.bonusHistory.length === 0) {
                    // No history
                    html += '<div class="text-center py-8 text-gray-500">';
                    html += '<p>No bonus history found.</p>';
                    html += '</div>';
                } else {
                    // History list
                    html += '<div class="space-y-3">';
                    var toolNames = {
                        warpOptimizer: 'Warp Optimizer',
                        competitorAnalysis: 'Competitor Analysis',
                        trendPredictor: 'Trend Predictor',
                        thumbnailGenerator: 'AI Thumbnails',
                        placementFinder: 'Placement Finder'
                    };
                    var toolEmojis = {
                        warpOptimizer: 'üöÄ',
                        competitorAnalysis: 'üéØ',
                        trendPredictor: 'üìà',
                        thumbnailGenerator: 'üé®',
                        placementFinder: 'üé¨'
                    };
                    for (var h = 0; h < state.bonusHistory.length; h++) {
                        var bonus = state.bonusHistory[h];
                        var toolDisplayName = toolNames[bonus.tool] || bonus.tool;
                        var toolEmoji = toolEmojis[bonus.tool] || 'üéÅ';
                        var bonusDate = new Date(bonus.timestamp);
                        var dateStr = bonusDate.toLocaleDateString() + ' ' + bonusDate.toLocaleTimeString();

                        html += '<div class="bg-gray-50 rounded-lg p-4 flex items-center justify-between">';
                        html += '<div class="flex items-center gap-3">';
                        html += '<span class="text-2xl">' + toolEmoji + '</span>';
                        html += '<div>';
                        html += '<p class="font-semibold text-gray-800">' + toolDisplayName + '</p>';
                        html += '<p class="text-sm text-gray-500">' + dateStr + '</p>';
                        html += '</div>';
                        html += '</div>';
                        html += '<span class="text-xl font-bold text-green-600">+' + bonus.amount + '</span>';
                        html += '</div>';
                    }
                    html += '</div>';
                }

                html += '</div>';
                html += '</div>';
                html += '</div>';
            }

            return html;
        }

        /* ------------------------------------------
           4.6.5 Optimizer View
           ------------------------------------------ */
        function renderOptimizer() {
            var html = '';

            // Container
            html += '<div class="min-h-screen mobile-full-screen py-12 px-4">';
            html += '<div class="max-w-4xl mx-auto">';

            // Navigation buttons
            html += '<div class="flex flex-wrap gap-3 mb-6">';
            html += '<button onclick="app.goToDashboard()" class="px-6 py-3 bg-white/20 text-white rounded-xl hover:bg-white/30">‚Üê Back</button>';
            html += '<button onclick="app.goToHistory(\'optimization\')" class="px-6 py-3 bg-white/20 text-white rounded-xl hover:bg-white/30">üìú View History</button>';
            html += '</div>';

            // Card
            html += '<div class="bg-white rounded-2xl shadow-xl p-8 mobile-padding fade-in">';
            html += '<h2 class="text-3xl mobile-text-xl font-bold text-gray-800 mb-6">üöÄ Video Optimizer</h2>';

            // Error message (supports both string and object format)
            if (state.error) {
                var errorMsg = typeof state.error === 'string' ? state.error : state.error.message;
                var errorDetails = typeof state.error === 'object' ? state.error.details : null;
                var errorCode = typeof state.error === 'object' ? state.error.code : null;
                var errorRaw = typeof state.error === 'object' ? state.error.raw : null;

                html += '<div class="mb-6 p-4 bg-red-50 border-2 border-red-300 rounded-lg">';
                html += '<div class="flex items-start gap-3">';
                html += '<span class="text-2xl">‚ö†Ô∏è</span>';
                html += '<div class="flex-1">';
                html += '<p class="font-bold text-red-800">' + utils.escapeHtml(errorMsg) + '</p>';

                if (errorDetails) {
                    html += '<p class="mt-2 text-sm text-red-600">' + utils.escapeHtml(errorDetails) + '</p>';
                }

                if (errorCode) {
                    html += '<div class="mt-3 pt-3 border-t border-red-200">';
                    html += '<button onclick="app.toggleErrorDetails()" class="text-xs text-red-500 hover:text-red-700 underline">Show Technical Details</button>';
                    html += '<div id="error-details" class="hidden mt-2 p-2 bg-red-100 rounded text-xs font-mono text-red-700">';
                    html += '<p><strong>Code:</strong> ' + utils.escapeHtml(errorCode) + '</p>';
                    if (errorRaw) {
                        html += '<p class="mt-1"><strong>Raw:</strong> ' + utils.escapeHtml(errorRaw) + '</p>';
                    }
                    html += '</div></div>';
                }

                html += '</div></div></div>';
            }

            // Form
            html += '<form onsubmit="app.optimize(event)">';
            html += '<div class="mb-6">';
            html += '<label class="block text-gray-700 font-semibold mb-2">YouTube Video URL</label>';
            html += '<input type="text" id="video-url" placeholder="https://www.youtube.com/watch?v=..." class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" required />';
            html += '</div>';

            html += '<button type="submit" class="btn-primary"';
            if (state.loading) html += ' disabled';
            html += '>';
            html += state.loading ? '‚è≥ Optimizing...' : 'üöÄ Optimize Video';
            html += '</button>';
            html += '</form>';

            // Professional Loading Animation
            if (state.loading) {
                var progress = Math.round(state.loadingProgress);
                var currentStep = state.loadingStep;
                var tips = [
                    'üí° Tip: Titles with numbers get 36% more clicks!',
                    'üí° Did you know? Descriptions over 200 words rank higher.',
                    'üí° Pro tip: Use 8-15 relevant tags for best results.',
                    'üí° Fun fact: Question-based titles increase engagement by 23%.'
                ];
                var randomTip = tips[Math.floor(progress / 25) % tips.length];

                html += '<div class="mt-8 loading-container fade-in">';

                // Header with emoji and percentage
                html += '<div class="flex flex-col md:flex-row items-center justify-between gap-6 mb-8">';
                html += '<div class="flex items-center gap-4">';
                html += '<div class="loading-emoji">üöÄ</div>';
                html += '<div>';
                html += '<h3 class="text-2xl font-bold text-gray-800">Optimizing Your Video</h3>';
                html += '<p class="text-gray-500">AI magic in progress...</p>';
                html += '</div></div>';
                html += '<div class="progress-percentage">' + progress + '%</div>';
                html += '</div>';

                // Progress Bar
                html += '<div class="mb-8">';
                html += '<div class="progress-bar-container">';
                html += '<div class="progress-bar-fill" style="width: ' + progress + '%"></div>';
                html += '</div>';
                html += '</div>';

                // Steps Grid
                html += '<div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6">';
                for (var s = 0; s < state.loadingSteps.length; s++) {
                    var step = state.loadingSteps[s];
                    var stepStatus = s < currentStep ? 'completed' : (s === currentStep ? 'active' : 'pending');
                    var iconStatus = stepStatus;

                    html += '<div class="loading-step ' + stepStatus + '">';
                    html += '<div class="step-icon ' + iconStatus + '">';
                    if (stepStatus === 'completed') {
                        html += '‚úì';
                    } else {
                        html += step.icon;
                    }
                    html += '</div>';
                    html += '<span class="text-sm font-medium ' + (stepStatus === 'pending' ? 'text-gray-400' : 'text-gray-700') + '">' + step.name + '</span>';
                    html += '</div>';
                }
                html += '</div>';

                // Tip
                html += '<div class="loading-tip">';
                html += '<p class="text-sm text-indigo-700">' + randomTip + '</p>';
                html += '</div>';

                html += '</div>';
            }

            html += '</div></div></div>';

            return html;
        }

        /* ------------------------------------------
           4.6.6 Results View (Tabbed Interface)
           ------------------------------------------ */
        function renderResults() {
            if (!state.currentResults) {
                return '<div class="text-white text-center py-12">No results available. <button onclick="app.goToOptimizer()" class="underline">Optimize a video</button></div>';
            }

            const r = state.currentResults;
            const tab = state.resultsTab || 'titles';
            var html = '';

            // Container
            html += '<div class="min-h-screen mobile-full-screen py-6 px-4">';
            html += '<div class="max-w-4xl mx-auto">';

            // Header with navigation
            html += '<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4 fade-in">';
            html += '<h1 class="text-3xl mobile-text-xl font-bold text-white">‚ú® Optimization Results</h1>';
            html += '<div class="flex gap-2 w-full sm:w-auto">';
            html += '<button onclick="app.goToDashboard()" class="flex-1 sm:flex-none btn-secondary">‚Üê Dashboard</button>';
            html += '<button onclick="app.goToOptimizer()" class="flex-1 sm:flex-none btn-secondary">üîÑ New</button>';
            html += '</div></div>';

            // SEO Score Card (Before/After)
            html += '<div class="bg-white rounded-2xl shadow-xl p-6 mobile-padding mb-6 fade-in">';
            html += '<div class="flex flex-col md:flex-row items-center justify-around gap-6">';

            // Before Score (estimated based on video metadata)
            var beforeScore = Math.min(45, Math.round((r.videoInfo?.viewCount || 0) / 100000 * 10) + 25);
            var afterScore = r.seoAnalysis?.score || 85;
            var improvement = afterScore - beforeScore;

            // Before
            html += '<div class="text-center">';
            html += '<p class="text-sm font-medium text-gray-500 mb-3">Current SEO</p>';
            html += '<div class="score-gauge">';
            html += '<svg class="score-circle" width="140" height="140" viewBox="0 0 140 140">';
            html += '<circle class="score-circle-bg" cx="70" cy="70" r="58"></circle>';
            var beforeDash = (beforeScore / 100) * 364;
            html += '<circle class="score-circle-fill" cx="70" cy="70" r="58" stroke="#ef4444" stroke-dasharray="' + beforeDash + ' 364"></circle>';
            html += '</svg>';
            html += '<div class="score-value text-red-500">' + beforeScore + '</div>';
            html += '</div>';
            html += '</div>';

            // Arrow
            html += '<div class="text-5xl text-gray-300 hidden md:block">‚Üí</div>';
            html += '<div class="text-3xl text-gray-300 md:hidden">‚Üì</div>';

            // After
            html += '<div class="text-center">';
            html += '<p class="text-sm font-medium text-gray-500 mb-3">After Optimization</p>';
            html += '<div class="score-gauge">';
            html += '<svg class="score-circle" width="140" height="140" viewBox="0 0 140 140">';
            html += '<circle class="score-circle-bg" cx="70" cy="70" r="58"></circle>';
            var afterDash = (afterScore / 100) * 364;
            var afterColor = afterScore >= 80 ? '#22c55e' : afterScore >= 60 ? '#eab308' : '#ef4444';
            html += '<circle class="score-circle-fill" cx="70" cy="70" r="58" stroke="' + afterColor + '" stroke-dasharray="' + afterDash + ' 364"></circle>';
            html += '</svg>';
            html += '<div class="score-value" style="color:' + afterColor + '">' + afterScore + '</div>';
            html += '</div>';
            html += '</div>';

            // Improvement badge
            html += '<div class="text-center bg-gradient-to-br from-green-50 to-emerald-100 px-8 py-5 rounded-2xl border border-green-200">';
            html += '<p class="text-4xl font-bold text-green-600">+' + improvement + '%</p>';
            html += '<p class="text-sm font-medium text-green-700 mt-1">SEO Improvement</p>';
            html += '</div>';

            html += '</div></div>';

            // Video Info (Compact)
            if (r.videoInfo) {
                html += '<div class="bg-white/10 rounded-xl p-4 mb-4 fade-in">';
                html += '<div class="flex items-center gap-4">';
                if (r.videoInfo.thumbnail) {
                    html += '<img src="' + utils.escapeHtml(r.videoInfo.thumbnail) + '" class="w-24 h-14 object-cover rounded-lg" alt="Thumbnail" />';
                }
                html += '<div class="flex-1 min-w-0">';
                html += '<p class="text-white font-semibold truncate">' + utils.escapeHtml(r.videoInfo.title || 'N/A') + '</p>';
                html += '<p class="text-white/70 text-sm">' + utils.escapeHtml(r.videoInfo.channelTitle || '') + ' ‚Ä¢ ' + utils.formatNumber(r.videoInfo.viewCount || 0) + ' views</p>';
                html += '</div></div></div>';
            }

            // Main Content Card with Tabs
            html += '<div class="bg-white rounded-2xl shadow-xl p-6 mobile-padding fade-in">';

            // Tabs
            html += '<div class="tabs-container">';
            html += '<button onclick="app.setResultsTab(\'titles\')" class="tab-btn ' + (tab === 'titles' ? 'active' : '') + '">üìù Titles</button>';
            html += '<button onclick="app.setResultsTab(\'description\')" class="tab-btn ' + (tab === 'description' ? 'active' : '') + '">üìÑ Description</button>';
            html += '<button onclick="app.setResultsTab(\'tags\')" class="tab-btn ' + (tab === 'tags' ? 'active' : '') + '">üè∑Ô∏è Tags</button>';
            html += '</div>';

            // Tab Content
            html += '<div class="tab-content">';

            if (tab === 'titles') {
                // Titles Tab
                if (r.titles && r.titles.length > 0) {
                    html += '<div class="space-y-3">';
                    var titleLabels = ['üéØ Clickbait Style', 'üîç SEO Optimized', '‚ùì Question Format'];
                    for (var i = 0; i < r.titles.length; i++) {
                        var titleId = 'title-' + i;
                        var escapedTitle = utils.escapeJs(r.titles[i]);
                        html += '<div class="p-4 bg-gradient-to-r from-gray-50 to-white rounded-xl border-2 border-gray-100 hover:border-purple-300 transition-all">';
                        html += '<p class="text-xs text-purple-600 font-semibold mb-1">' + (titleLabels[i] || 'Title ' + (i+1)) + '</p>';
                        html += '<div class="flex justify-between items-start gap-3">';
                        html += '<p class="flex-1 text-lg font-medium text-gray-800">' + utils.escapeHtml(r.titles[i]) + '</p>';
                        html += '<button id="' + titleId + '-btn" onclick="app.copyToClipboard(\'' + escapedTitle + '\', \'' + titleId + '-btn\')" class="px-4 py-2 bg-purple-500 text-white text-sm rounded-lg hover:bg-purple-600 whitespace-nowrap transition-all">üìã Copy</button>';
                        html += '</div></div>';
                    }
                    html += '</div>';
                } else {
                    html += '<p class="text-gray-500 text-center py-8">No titles generated</p>';
                }
            } else if (tab === 'description') {
                // Description Tab
                if (r.description) {
                    var escapedDesc = utils.escapeJs(r.description);
                    html += '<div class="relative">';
                    html += '<div class="p-4 bg-gray-50 rounded-xl border-2 border-gray-200 max-h-96 overflow-y-auto">';
                    html += '<pre class="text-gray-800 whitespace-pre-wrap font-sans text-sm leading-relaxed">' + utils.escapeHtml(r.description) + '</pre>';
                    html += '</div>';
                    html += '<button id="desc-btn" onclick="app.copyToClipboard(\'' + escapedDesc + '\', \'desc-btn\')" class="mt-4 w-full py-3 bg-purple-500 text-white font-semibold rounded-lg hover:bg-purple-600 transition-all">üìã Copy Full Description</button>';
                    html += '</div>';
                } else {
                    html += '<p class="text-gray-500 text-center py-8">No description generated</p>';
                }
            } else if (tab === 'tags') {
                // Tags Tab
                if (r.tags && r.tags.length > 0) {
                    var escapedTags = utils.escapeJs(r.tags.join(', '));
                    html += '<div class="mb-4">';
                    html += '<p class="text-sm text-gray-500 mb-3">' + r.tags.length + ' tags generated</p>';
                    html += '<div class="flex flex-wrap gap-2 max-h-64 overflow-y-auto p-2">';
                    for (var j = 0; j < r.tags.length; j++) {
                        html += '<span class="inline-block px-3 py-1.5 bg-gradient-to-r from-purple-100 to-blue-100 text-purple-700 rounded-full text-sm font-medium hover:from-purple-200 hover:to-blue-200 transition-all cursor-default">' + utils.escapeHtml(r.tags[j]) + '</span>';
                    }
                    html += '</div></div>';
                    html += '<button id="tags-btn" onclick="app.copyToClipboard(\'' + escapedTags + '\', \'tags-btn\')" class="w-full py-3 bg-purple-500 text-white font-semibold rounded-lg hover:bg-purple-600 transition-all">üìã Copy All Tags</button>';
                } else {
                    html += '<p class="text-gray-500 text-center py-8">No tags generated</p>';
                }
            }

            html += '</div>'; // End tab-content
            html += '</div>'; // End main card

            // Recommendations (if any)
            if (r.seoAnalysis?.recommendations && r.seoAnalysis.recommendations.length > 0) {
                html += '<div class="mt-4 p-4 bg-white/10 rounded-xl fade-in">';
                html += '<p class="text-white font-semibold mb-2">üí° Tips to improve further:</p>';
                html += '<ul class="text-white/80 text-sm space-y-1">';
                for (var k = 0; k < r.seoAnalysis.recommendations.length; k++) {
                    html += '<li>‚Ä¢ ' + utils.escapeHtml(r.seoAnalysis.recommendations[k]) + '</li>';
                }
                html += '</ul></div>';
            }

            // Thumbnail Generator CTA
            html += '<div class="mt-6 p-6 bg-gradient-to-r from-pink-500/20 to-purple-500/20 rounded-2xl border border-white/20 fade-in">';
            html += '<div class="flex flex-col sm:flex-row items-center justify-between gap-4">';
            html += '<div class="text-center sm:text-left">';
            html += '<h3 class="text-xl font-bold text-white mb-1">üé® Create an Eye-Catching Thumbnail</h3>';
            html += '<p class="text-white/70 text-sm">Use AI to generate a professional thumbnail based on your optimized video content</p>';
            html += '</div>';
            html += '<button onclick="app.goToThumbnail(true)" class="whitespace-nowrap px-6 py-3 bg-gradient-to-r from-pink-500 to-purple-600 text-white font-bold rounded-xl hover:from-pink-600 hover:to-purple-700 transition-all shadow-lg hover:shadow-xl transform hover:scale-105">';
            html += '‚ú® Generate Thumbnail';
            html += '</button>';
            html += '</div></div>';

            html += '</div></div>';

            return html;
        }

        /* ------------------------------------------
           4.6.7 History View
           ------------------------------------------ */
        function renderHistory() {
            var html = '';
            var counts = state.historyCounts || {};

            // Container
            html += '<div class="min-h-screen mobile-full-screen py-6 px-4">';
            html += '<div class="max-w-6xl mx-auto">';

            // Header
            html += '<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4 fade-in">';
            html += '<h1 class="text-3xl mobile-text-xl font-bold text-white">üìú Activity History</h1>';
            html += '<button onclick="app.goToDashboard()" class="btn-secondary w-full sm:w-auto">‚Üê Back to Dashboard</button>';
            html += '</div>';

            // Success message
            if (state.success) {
                html += '<div class="mb-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg fade-in">';
                html += '<p>' + utils.escapeHtml(state.success) + '</p>';
                html += '</div>';
            }

            // Loading state
            if (state.loading) {
                html += '<div class="text-center py-12">';
                html += '<div class="spinner mx-auto mb-4"></div>';
                html += '<p class="text-white">Loading history...</p>';
                html += '</div>';
            }
            // Error state
            else if (state.error) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-8 mobile-padding text-center">';
                html += '<p class="text-red-600 font-semibold">‚ö†Ô∏è ' + utils.escapeHtml(state.error) + '</p>';
                html += '<button onclick="app.goToHistory()" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Try Again</button>';
                html += '</div>';
            }
            else {
                // Tab Navigation
                html += '<div class="bg-white rounded-xl shadow-lg mb-6 fade-in overflow-hidden">';
                html += '<div class="flex flex-wrap border-b border-gray-200">';

                var tabs = [
                    { id: 'all', label: 'All', icon: 'üìã', count: (counts.optimizations || 0) + (counts.competitor || 0) + (counts.trends || 0) + (counts.thumbnails || 0) + (counts.placements || 0) },
                    { id: 'optimization', label: 'Video', icon: 'üé¨', count: counts.optimizations || 0 },
                    { id: 'competitor', label: 'Competitor', icon: 'üîç', count: counts.competitor || 0 },
                    { id: 'trend', label: 'Trends', icon: 'üìà', count: counts.trends || 0 },
                    { id: 'thumbnail', label: 'Thumbnails', icon: 'üé®', count: counts.thumbnails || 0 },
                    { id: 'placement', label: 'Placements', icon: 'üìç', count: counts.placements || 0 }
                ];

                for (var t = 0; t < tabs.length; t++) {
                    var tab = tabs[t];
                    var isActive = state.historyTab === tab.id;
                    var tabClass = isActive
                        ? 'border-b-2 border-blue-500 text-blue-600 bg-blue-50'
                        : 'text-gray-600 hover:text-gray-800 hover:bg-gray-50';
                    html += '<button onclick="app.setHistoryTab(\'' + tab.id + '\')" class="flex-1 min-w-0 px-3 py-3 text-sm font-medium ' + tabClass + ' transition-colors">';
                    html += '<span class="hidden sm:inline">' + tab.icon + ' </span>' + tab.label;
                    if (tab.count > 0) {
                        html += ' <span class="inline-flex items-center justify-center px-2 py-0.5 text-xs font-bold rounded-full ' + (isActive ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700') + '">' + tab.count + '</span>';
                    }
                    html += '</button>';
                }
                html += '</div></div>';

                // Get items based on current tab
                var items = [];
                var itemType = state.historyTab;

                if (state.historyTab === 'all') {
                    items = state.allHistory || [];
                } else if (state.historyTab === 'optimization') {
                    items = state.historyData || [];
                } else if (state.historyTab === 'competitor') {
                    items = state.competitorHistory || [];
                } else if (state.historyTab === 'trend') {
                    items = state.trendHistory || [];
                } else if (state.historyTab === 'thumbnail') {
                    items = state.thumbnailHistory || [];
                } else if (state.historyTab === 'placement') {
                    items = state.placementHistory || [];
                }

                // Empty state for current tab
                if (!items || items.length === 0) {
                    html += '<div class="bg-white rounded-2xl shadow-xl p-12 mobile-padding text-center fade-in">';
                    html += '<div class="text-6xl mb-4">üì≠</div>';
                    html += '<h2 class="text-2xl mobile-text-lg font-bold text-gray-800 mb-2">No History Yet</h2>';
                    html += '<p class="text-gray-600 mb-6">Start using tools to see your history here!</p>';
                    html += '<button onclick="app.goToDashboard()" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold rounded-lg hover:from-blue-700 hover:to-purple-700">üöÄ Go to Dashboard</button>';
                    html += '</div>';
                }
                // History list
                else {
                    html += '<div class="space-y-4 fade-in">';

                    for (var i = 0; i < items.length; i++) {
                        var item = items[i];
                        var type = state.historyTab === 'all' ? item.type : state.historyTab;
                        var timestamp = item.timestamp || item.createdAt;
                        var dateInfo = utils.formatDate(timestamp);

                        html += '<div class="bg-white rounded-xl shadow-lg p-6 mobile-padding hover:shadow-xl transition-all">';
                        html += '<div class="flex flex-col sm:flex-row justify-between items-start gap-4">';

                        // Type badge
                        var typeBadge = '';
                        var typeIcon = '';
                        var typeColor = '';
                        switch(type) {
                            case 'optimization':
                                typeIcon = 'üé¨';
                                typeBadge = 'Video Optimization';
                                typeColor = 'bg-blue-100 text-blue-800';
                                break;
                            case 'competitor':
                                typeIcon = 'üîç';
                                typeBadge = 'Competitor Analysis';
                                typeColor = 'bg-purple-100 text-purple-800';
                                break;
                            case 'trend':
                                typeIcon = 'üìà';
                                typeBadge = 'Trend Prediction';
                                typeColor = 'bg-green-100 text-green-800';
                                break;
                            case 'thumbnail':
                                typeIcon = 'üé®';
                                typeBadge = 'Thumbnail';
                                typeColor = 'bg-orange-100 text-orange-800';
                                break;
                            case 'placement':
                                typeIcon = 'üìç';
                                typeBadge = 'Placement Finder';
                                typeColor = 'bg-violet-100 text-violet-800';
                                break;
                        }

                        // Info section
                        html += '<div class="flex-1">';

                        // Type badge (only show in "all" tab)
                        if (state.historyTab === 'all') {
                            html += '<span class="inline-block px-2 py-1 text-xs font-semibold rounded-full ' + typeColor + ' mb-2">' + typeIcon + ' ' + typeBadge + '</span>';
                        }

                        // Title based on type
                        var title = '';
                        var subtitle = '';
                        switch(type) {
                            case 'optimization':
                                title = (item.videoInfo && item.videoInfo.title) ? item.videoInfo.title : 'Video Optimization';
                                if (item.titles && item.titles.length > 0) {
                                    subtitle = '<strong>Best Title:</strong> ' + utils.escapeHtml(item.titles[0]);
                                }
                                break;
                            case 'competitor':
                                title = (item.competitor && item.competitor.title) ? item.competitor.title : 'Competitor Analysis';
                                if (item.competitor && item.competitor.channelTitle) {
                                    subtitle = '<strong>Channel:</strong> ' + utils.escapeHtml(item.competitor.channelTitle);
                                }
                                break;
                            case 'trend':
                                title = item.niche ? 'Trends: ' + item.niche : 'Trend Analysis';
                                subtitle = '<strong>Country:</strong> ' + (item.country || 'US') + ' | <strong>Videos Analyzed:</strong> ' + (item.analyzedVideos || 0);
                                break;
                            case 'thumbnail':
                                title = item.title || 'AI Thumbnail';
                                subtitle = '<strong>Style:</strong> ' + (item.style || 'Default');
                                break;
                            case 'placement':
                                title = (item.channelInfo && item.channelInfo.name) ? item.channelInfo.name : 'Placement Search';
                                subtitle = '<strong>Channels Found:</strong> ' + (item.totalFound || 0) + ' | <strong>Niche:</strong> ' + ((item.analysis && item.analysis.niche) || 'N/A');
                                break;
                        }

                        html += '<h3 class="font-bold text-lg text-gray-800 mb-2">' + utils.escapeHtml(title) + '</h3>';
                        html += '<div class="flex flex-wrap gap-4 text-sm text-gray-600 mb-2">';
                        html += '<span>üìÖ ' + dateInfo.date + '</span>';
                        html += '<span>üïê ' + dateInfo.time + '</span>';
                        html += '</div>';

                        if (subtitle) {
                            html += '<p class="text-sm text-gray-700">' + subtitle + '</p>';
                        }

                        // Show thumbnail preview for thumbnail items
                        if (type === 'thumbnail' && item.imageUrl) {
                            html += '<div class="mt-3"><img src="' + utils.escapeHtml(item.imageUrl) + '" alt="Thumbnail" class="h-20 rounded-lg shadow-sm"></div>';
                        }

                        html += '</div>';

                        // Action buttons
                        html += '<div class="flex gap-2 flex-shrink-0">';

                        // View button based on type
                        switch(type) {
                            case 'optimization':
                                html += '<button onclick="app.viewHistoryItem(' + (state.historyTab === 'all' ? 'null, \'' + item.id + '\'' : i) + ')" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 whitespace-nowrap text-sm">üëÅÔ∏è View</button>';
                                break;
                            case 'competitor':
                                html += '<button onclick="app.viewCompetitorHistory(' + (state.historyTab === 'all' ? 'null, \'' + item.id + '\'' : i) + ')" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 whitespace-nowrap text-sm">üëÅÔ∏è View</button>';
                                break;
                            case 'trend':
                                html += '<button onclick="app.viewTrendHistory(' + (state.historyTab === 'all' ? 'null, \'' + item.id + '\'' : i) + ')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 whitespace-nowrap text-sm">üëÅÔ∏è View</button>';
                                break;
                            case 'thumbnail':
                                html += '<button onclick="app.viewThumbnailHistory(' + (state.historyTab === 'all' ? 'null, \'' + item.id + '\'' : i) + ')" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 whitespace-nowrap text-sm">üëÅÔ∏è View</button>';
                                break;
                            case 'placement':
                                html += '<button onclick="app.viewPlacementHistory(\'' + item.id + '\')" class="px-4 py-2 bg-violet-500 text-white rounded-lg hover:bg-violet-600 whitespace-nowrap text-sm">üëÅÔ∏è View</button>';
                                break;
                        }

                        // Delete button
                        html += '<button onclick="app.deleteHistoryItem(\'' + type + '\', \'' + item.id + '\', ' + i + ')" class="px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 whitespace-nowrap text-sm">üóëÔ∏è</button>';

                        html += '</div>';

                        html += '</div></div>';
                    }

                    html += '</div>';
                }
            }

            html += '</div></div>';

            return html;
        }

        /* ------------------------------------------
           4.6.8 Admin Dashboard View
           ------------------------------------------ */
        function renderAdmin() {
            var html = '';

            // Container
            html += '<div class="min-h-screen mobile-full-screen py-6 px-4">';
            html += '<div class="max-w-6xl mx-auto">';

            // Header
            html += '<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4 fade-in">';
            html += '<h1 class="text-3xl mobile-text-xl font-bold text-white">‚öôÔ∏è Admin Dashboard</h1>';
            html += '<button onclick="app.goToDashboard()" class="btn-secondary w-full sm:w-auto">‚Üê Back to Dashboard</button>';
            html += '</div>';

            // Success message
            if (state.success) {
                html += '<div class="mb-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg fade-in">';
                html += '<p>' + utils.escapeHtml(state.success) + '</p>';
                html += '</div>';
            }

            // Error message
            if (state.error) {
                var errorMsg = typeof state.error === 'string' ? state.error : state.error.message;
                html += '<div class="mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg fade-in">';
                html += '<p>' + utils.escapeHtml(errorMsg) + '</p>';
                html += '</div>';
            }

            // Stats Cards
            html += '<div class="grid grid-cols-1 sm:grid-cols-3 gap-5 mb-8 fade-in">';
            var totalUsers = state.adminUsers ? state.adminUsers.length : 0;
            var proUsers = state.adminUsers ? state.adminUsers.filter(function(u) { return u.subscription && u.subscription.plan === 'pro'; }).length : 0;
            var freeUsers = state.adminUsers ? state.adminUsers.filter(function(u) { return !u.subscription || u.subscription.plan === 'free'; }).length : 0;

            html += '<div class="bg-white rounded-2xl p-8 text-center shadow-lg border border-gray-100">';
            html += '<div class="text-5xl mb-3">üë•</div>';
            html += '<p class="text-5xl font-bold text-gray-800 mb-2">' + totalUsers + '</p>';
            html += '<p class="text-gray-600 font-medium text-lg">Total Users</p>';
            html += '</div>';

            html += '<div class="bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl p-8 text-center shadow-lg">';
            html += '<div class="text-5xl mb-3">‚≠ê</div>';
            html += '<p class="text-5xl font-bold text-white mb-2">' + proUsers + '</p>';
            html += '<p class="text-white/90 font-medium text-lg">Pro Users</p>';
            html += '</div>';

            html += '<div class="bg-white rounded-2xl p-8 text-center shadow-lg border border-gray-100">';
            html += '<div class="text-5xl mb-3">üÜì</div>';
            html += '<p class="text-5xl font-bold text-gray-500 mb-2">' + freeUsers + '</p>';
            html += '<p class="text-gray-600 font-medium text-lg">Free Users</p>';
            html += '</div>';
            html += '</div>';

            // Users Table
            html += '<div class="bg-white rounded-2xl shadow-xl p-8 mobile-padding fade-in">';
            html += '<h2 class="text-2xl font-bold text-gray-800 mb-6">üë• User Management</h2>';

            if (state.adminLoading) {
                html += '<div class="text-center py-8">';
                html += '<div class="spinner spinner-dark mx-auto mb-4"></div>';
                html += '<p class="text-gray-600">Loading users...</p>';
                html += '</div>';
            } else if (!state.adminUsers || state.adminUsers.length === 0) {
                html += '<p class="text-gray-500 text-center py-8">No users found</p>';
            } else {
                html += '<div class="overflow-x-auto">';
                html += '<table class="w-full text-left">';
                html += '<thead class="bg-gray-50 rounded-lg">';
                html += '<tr>';
                html += '<th class="px-6 py-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">User</th>';
                html += '<th class="px-6 py-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Plan</th>';
                html += '<th class="px-6 py-4 text-sm font-semibold text-gray-600 uppercase tracking-wider hidden sm:table-cell">Usage</th>';
                html += '<th class="px-6 py-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Actions</th>';
                html += '</tr></thead>';
                html += '<tbody class="divide-y divide-gray-100">';

                for (var i = 0; i < state.adminUsers.length; i++) {
                    var user = state.adminUsers[i];
                    var plan = user.subscription ? user.subscription.plan : 'free';
                    var planColor = plan === 'pro' ? 'bg-purple-100 text-purple-800' : plan === 'lite' ? 'bg-blue-100 text-blue-800' : plan === 'enterprise' ? 'bg-amber-100 text-amber-800' : 'bg-gray-100 text-gray-800';

                    // Calculate total limit including bonus uses
                    var baseLimit = user.usage && user.usage.warpOptimizer ? user.usage.warpOptimizer.limit : 0;
                    var bonusUses = user.bonusUses && user.bonusUses.warpOptimizer ? user.bonusUses.warpOptimizer : 0;
                    var totalLimit = baseLimit + bonusUses;
                    var usedToday = user.usage && user.usage.warpOptimizer ? user.usage.warpOptimizer.usedToday : 0;
                    var usageInfo = usedToday + '/' + totalLimit;
                    var bonusIndicator = bonusUses > 0 ? ' <span class="text-green-600 text-xs">(+' + bonusUses + ')</span>' : '';

                    html += '<tr class="hover:bg-gray-50 transition-colors">';
                    html += '<td class="px-6 py-5">';
                    html += '<p class="font-semibold text-gray-800 text-base">' + utils.escapeHtml(user.email || 'No email') + '</p>';
                    html += '<p class="text-sm text-gray-500 mt-1">ID: ' + utils.escapeHtml(user.uid ? user.uid.substring(0, 12) + '...' : '') + '</p>';
                    html += '</td>';
                    html += '<td class="px-6 py-5">';
                    html += '<span class="px-3 py-1.5 text-sm font-semibold rounded-full ' + planColor + '">' + plan.toUpperCase() + '</span>';
                    html += '</td>';
                    html += '<td class="px-6 py-5 hidden sm:table-cell">';
                    html += '<span class="text-base text-gray-700 font-medium">' + usageInfo + '</span>' + bonusIndicator;
                    html += '<span class="text-sm text-gray-500 ml-1">today</span>';
                    html += '</td>';
                    html += '<td class="px-6 py-5">';
                    html += '<select onchange="app.updateUserPlan(\'' + user.uid + '\', this.value)" class="text-base border-2 border-gray-200 rounded-lg px-3 py-2 focus:border-purple-500 focus:outline-none transition-colors">';
                    html += '<option value="free"' + (plan === 'free' ? ' selected' : '') + '>Free</option>';
                    html += '<option value="lite"' + (plan === 'lite' ? ' selected' : '') + '>Lite</option>';
                    html += '<option value="pro"' + (plan === 'pro' ? ' selected' : '') + '>Pro</option>';
                    html += '<option value="enterprise"' + (plan === 'enterprise' ? ' selected' : '') + '>Enterprise</option>';
                    html += '</select>';
                    html += '</td>';
                    html += '</tr>';
                }

                html += '</tbody></table></div>';
            }

            html += '</div>';

            // Quota Settings Section
            html += '<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">';

            // Reset Time Settings
            html += '<div class="bg-white rounded-2xl shadow-xl p-8 mobile-padding fade-in">';
            html += '<h2 class="text-2xl font-bold text-gray-800 mb-4">‚è±Ô∏è Quota Reset Time</h2>';
            html += '<p class="text-gray-600 mb-6">Set how often user quotas reset (in minutes). Default is 1440 minutes (24 hours).</p>';
            html += '<div class="flex gap-4 items-end">';
            html += '<div class="flex-1">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Reset Interval (minutes)</label>';
            html += '<input type="number" id="reset-time-input" value="' + (state.resetTimeMinutes || 1440) + '" min="1" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-lg" />';
            html += '<p class="text-sm text-gray-500 mt-2">Examples: 60 = 1 hour, 240 = 4 hours, 1440 = 24 hours</p>';
            html += '</div>';
            html += '<button onclick="app.setQuotaResetTime()" class="px-6 py-3 bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold rounded-xl hover:from-purple-600 hover:to-indigo-700 transition-all">Save</button>';
            html += '</div>';
            html += '</div>';

            // Grant Bonus Uses
            html += '<div class="bg-white rounded-2xl shadow-xl p-8 mobile-padding fade-in">';
            html += '<h2 class="text-2xl font-bold text-gray-800 mb-4">üéÅ Grant Bonus Uses</h2>';
            html += '<p class="text-gray-600 mb-6">Give extra uses to a specific user as a gift or bonus.</p>';

            // User selector
            html += '<div class="mb-4">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Select User</label>';
            html += '<select id="bonus-user-select" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-lg">';
            html += '<option value="">-- Select a user --</option>';
            if (state.adminUsers) {
                for (var j = 0; j < state.adminUsers.length; j++) {
                    var u = state.adminUsers[j];
                    html += '<option value="' + u.uid + '">' + utils.escapeHtml(u.email || u.uid) + '</option>';
                }
            }
            html += '</select>';
            html += '</div>';

            // Tool selector
            html += '<div class="mb-4">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Select Tool</label>';
            html += '<select id="bonus-tool-select" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-lg">';
            html += '<option value="warpOptimizer">Warp Optimizer</option>';
            html += '<option value="competitorAnalysis">Competitor Analysis</option>';
            html += '<option value="trendPredictor">Trend Predictor</option>';
            html += '<option value="thumbnailGenerator">AI Thumbnails</option>';
            html += '<option value="placementFinder">Placement Finder</option>';
            html += '</select>';
            html += '</div>';

            // Amount
            html += '<div class="mb-4">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Bonus Amount</label>';
            html += '<input type="number" id="bonus-amount-input" value="5" min="1" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-lg" />';
            html += '</div>';

            html += '<button onclick="app.grantBonusUses()" class="w-full px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold rounded-xl hover:from-green-600 hover:to-emerald-700 transition-all">üéÅ Grant Bonus Uses</button>';
            html += '</div>';

            html += '</div>'; // End grid

            html += '</div></div>';

            return html;
        }

        /* ------------------------------------------
           4.6.9 Competitor Analysis View
           ------------------------------------------ */
        function renderCompetitor() {
            var html = '';

            html += '<div class="min-h-screen mobile-full-screen py-8 px-4">';
            html += '<div class="max-w-6xl mx-auto">';

            // Navigation buttons
            html += '<div class="flex flex-wrap gap-3 mb-6">';
            html += '<button onclick="app.goToDashboard()" class="btn-secondary">‚Üê Back to Dashboard</button>';
            html += '<button onclick="app.goToHistory(\'competitor\')" class="btn-secondary">üìú View History</button>';
            html += '</div>';

            // Header
            html += '<div class="text-center mb-8 fade-in">';
            html += '<div class="w-20 h-20 bg-gradient-to-br from-red-500 to-orange-600 rounded-3xl flex items-center justify-center text-5xl mx-auto mb-4 shadow-xl">üéØ</div>';
            html += '<h1 class="text-3xl lg:text-4xl font-bold text-white mb-2">Competitor Analysis</h1>';
            html += '<p class="text-white/80 text-lg">Analyze any competitor video and get strategies to beat them</p>';
            html += '</div>';

            // Form Card
            if (!state.competitorResults) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-8 mobile-padding max-w-2xl mx-auto fade-in">';

                if (state.error) {
                    html += '<div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-xl text-red-700">' + utils.escapeHtml(state.error.message) + '</div>';
                }

                html += '<form onsubmit="app.analyzeCompetitor(event)">';
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-2">Competitor Video URL</label>';
                html += '<input type="text" id="competitor-url" placeholder="https://www.youtube.com/watch?v=..." class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:border-red-500 focus:outline-none text-lg" required />';
                html += '</div>';
                html += '<button type="submit" class="btn-primary bg-gradient-to-r from-red-500 to-orange-600" ' + (state.loading ? 'disabled' : '') + '>';
                html += state.loading ? '‚è≥ Analyzing...' : 'üéØ Analyze Competitor';
                html += '</button>';
                html += '</form>';

                // Loading Animation
                if (state.loading) {
                    html += '<div class="mt-8 loading-container">';
                    html += '<div class="flex items-center justify-between mb-6">';
                    html += '<div class="flex items-center gap-4"><div class="loading-emoji">üîç</div><div><h3 class="text-xl font-bold text-gray-800">Analyzing Competitor</h3></div></div>';
                    html += '<div class="progress-percentage">' + Math.round(state.loadingProgress) + '%</div>';
                    html += '</div>';
                    html += '<div class="progress-bar-container mb-4"><div class="progress-bar-fill" style="width:' + state.loadingProgress + '%"></div></div>';
                    html += '</div>';
                }

                html += '</div>';
            } else {
                // Results Display
                var r = state.competitorResults;
                var c = r.competitor;
                var a = r.analysis;

                // Competitor Info Card
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 mb-6 fade-in">';
                html += '<div class="flex flex-col md:flex-row gap-6">';
                if (c.thumbnail) {
                    html += '<img src="' + utils.escapeHtml(c.thumbnail) + '" class="w-full md:w-64 h-36 object-cover rounded-xl" />';
                }
                html += '<div class="flex-1">';
                html += '<h2 class="text-xl font-bold text-gray-800 mb-2">' + utils.escapeHtml(c.title) + '</h2>';
                html += '<p class="text-gray-600 mb-3">' + utils.escapeHtml(c.channelTitle) + '</p>';
                html += '<div class="flex flex-wrap gap-4 text-sm">';
                html += '<span class="bg-gray-100 px-3 py-1 rounded-full">üëÅÔ∏è ' + utils.formatNumber(c.viewCount) + ' views</span>';
                html += '<span class="bg-gray-100 px-3 py-1 rounded-full">üëç ' + utils.formatNumber(c.likeCount) + ' likes</span>';
                html += '<span class="bg-gray-100 px-3 py-1 rounded-full">üí¨ ' + utils.formatNumber(c.commentCount) + ' comments</span>';
                html += '</div></div></div></div>';

                // SEO Score & Difficulty
                html += '<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 fade-in">';
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 text-center">';
                html += '<p class="text-5xl font-bold ' + (a.seoScore >= 70 ? 'text-green-500' : a.seoScore >= 50 ? 'text-yellow-500' : 'text-red-500') + '">' + a.seoScore + '</p>';
                html += '<p class="text-gray-600 font-medium">Competitor SEO Score</p>';
                html += '</div>';
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 text-center">';
                var diffColor = a.estimatedDifficulty === 'easy' ? 'text-green-500' : a.estimatedDifficulty === 'medium' ? 'text-yellow-500' : 'text-red-500';
                html += '<p class="text-4xl font-bold ' + diffColor + '">' + (a.estimatedDifficulty || 'medium').toUpperCase() + '</p>';
                html += '<p class="text-gray-600 font-medium">Difficulty to Beat</p>';
                html += '</div>';
                html += '<div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl shadow-xl p-6 text-center text-white">';
                html += '<p class="text-4xl font-bold">üéØ</p>';
                html += '<p class="font-medium">Ready to Beat!</p>';
                html += '</div></div>';

                // Analysis Sections
                html += '<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 fade-in">';

                // Strengths
                html += '<div class="bg-white rounded-2xl shadow-xl p-6">';
                html += '<h3 class="text-xl font-bold text-gray-800 mb-4">üí™ Their Strengths</h3>';
                html += '<ul class="space-y-2">';
                (a.strengths || []).forEach(function(s) { html += '<li class="flex items-start gap-2"><span class="text-green-500">‚úì</span><span>' + utils.escapeHtml(s) + '</span></li>'; });
                html += '</ul></div>';

                // Weaknesses
                html += '<div class="bg-white rounded-2xl shadow-xl p-6">';
                html += '<h3 class="text-xl font-bold text-gray-800 mb-4">üéØ Their Weaknesses</h3>';
                html += '<ul class="space-y-2">';
                (a.weaknesses || []).forEach(function(w) { html += '<li class="flex items-start gap-2"><span class="text-red-500">‚úó</span><span>' + utils.escapeHtml(w) + '</span></li>'; });
                html += '</ul></div>';

                // Better Titles
                html += '<div class="bg-white rounded-2xl shadow-xl p-6">';
                html += '<h3 class="text-xl font-bold text-gray-800 mb-4">üìù Better Titles to Use</h3>';
                html += '<ul class="space-y-2">';
                (a.betterTitles || []).forEach(function(t) { html += '<li class="p-3 bg-blue-50 rounded-lg text-blue-800 font-medium">' + utils.escapeHtml(t) + '</li>'; });
                html += '</ul></div>';

                // Opportunities
                html += '<div class="bg-white rounded-2xl shadow-xl p-6">';
                html += '<h3 class="text-xl font-bold text-gray-800 mb-4">üí° Opportunities</h3>';
                html += '<ul class="space-y-2">';
                (a.opportunities || []).forEach(function(o) { html += '<li class="flex items-start gap-2"><span class="text-purple-500">‚òÖ</span><span>' + utils.escapeHtml(o) + '</span></li>'; });
                html += '</ul></div>';
                html += '</div>';

                // Summary
                html += '<div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl shadow-xl p-6 mt-6 fade-in">';
                html += '<h3 class="text-xl font-bold text-white mb-3">üìã Strategy Summary</h3>';
                html += '<p class="text-white/90 text-lg">' + utils.escapeHtml(a.summary || '') + '</p>';
                html += '</div>';

                // New Analysis Button
                html += '<div class="text-center mt-8">';
                html += '<button onclick="state.competitorResults=null;render();" class="btn-secondary">Analyze Another Competitor</button>';
                html += '</div>';
            }

            html += '</div></div>';
            return html;
        }

        /* ------------------------------------------
           4.6.10 Trend Predictor View
           ------------------------------------------ */
        function renderTrends() {
            var html = '';

            html += '<div class="min-h-screen mobile-full-screen py-8 px-4">';
            html += '<div class="max-w-6xl mx-auto">';

            // Navigation buttons
            html += '<div class="flex flex-wrap gap-3 mb-6">';
            html += '<button onclick="app.goToDashboard()" class="btn-secondary">‚Üê Back to Dashboard</button>';
            html += '<button onclick="app.goToHistory(\'trend\')" class="btn-secondary">üìú View History</button>';
            html += '</div>';

            html += '<div class="text-center mb-8 fade-in">';
            html += '<div class="w-20 h-20 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-3xl flex items-center justify-center text-5xl mx-auto mb-4 shadow-xl">üìà</div>';
            html += '<h1 class="text-3xl lg:text-4xl font-bold text-white mb-2">Trend Predictor</h1>';
            html += '<p class="text-white/80 text-lg">Discover trending topics and predict what will go viral</p>';
            html += '</div>';

            if (!state.trendResults) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-8 mobile-padding max-w-2xl mx-auto fade-in">';

                if (state.error) {
                    html += '<div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-xl text-red-700">' + utils.escapeHtml(state.error.message) + '</div>';
                }

                html += '<form onsubmit="app.predictTrends(event)">';
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-2">Your Niche / Topic</label>';
                html += '<input type="text" id="trend-niche" placeholder="e.g., Gaming, Cooking, Tech Reviews..." class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:border-cyan-500 focus:outline-none text-lg" required />';
                html += '</div>';
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-2">Country/Region</label>';
                html += '<select id="trend-country" class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:border-cyan-500 focus:outline-none text-lg">';
                html += '<option value="US">United States</option><option value="GB">United Kingdom</option><option value="CA">Canada</option>';
                html += '<option value="AU">Australia</option><option value="DE">Germany</option><option value="FR">France</option>';
                html += '<option value="IN">India</option><option value="BR">Brazil</option><option value="JP">Japan</option>';
                html += '</select></div>';
                html += '<button type="submit" class="btn-primary bg-gradient-to-r from-cyan-500 to-blue-600" ' + (state.loading ? 'disabled' : '') + '>';
                html += state.loading ? '‚è≥ Predicting...' : 'üîÆ Predict Trends';
                html += '</button>';
                html += '</form>';

                if (state.loading) {
                    html += '<div class="mt-8 loading-container">';
                    html += '<div class="flex items-center justify-between mb-6">';
                    html += '<div class="flex items-center gap-4"><div class="loading-emoji">üîÆ</div><div><h3 class="text-xl font-bold text-gray-800">Predicting Trends</h3></div></div>';
                    html += '<div class="progress-percentage">' + Math.round(state.loadingProgress) + '%</div>';
                    html += '</div>';
                    html += '<div class="progress-bar-container mb-4"><div class="progress-bar-fill" style="width:' + state.loadingProgress + '%"></div></div>';
                    html += '</div>';
                }

                html += '</div>';
            } else {
                var r = state.trendResults;
                var p = r.predictions;

                // Current Trends
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 mb-6 fade-in">';
                html += '<h3 class="text-2xl font-bold text-gray-800 mb-4">üî• Current Trends in "' + utils.escapeHtml(r.niche) + '"</h3>';
                html += '<div class="grid grid-cols-1 md:grid-cols-3 gap-4">';
                (p.currentTrends || []).forEach(function(t) {
                    var gColor = t.growthRate === 'rising' ? 'text-green-500' : t.growthRate === 'stable' ? 'text-yellow-500' : 'text-red-500';
                    html += '<div class="p-4 bg-gray-50 rounded-xl">';
                    html += '<div class="flex items-center justify-between mb-2">';
                    html += '<span class="font-bold text-gray-800">' + utils.escapeHtml(t.topic) + '</span>';
                    html += '<span class="' + gColor + ' font-medium">' + (t.growthRate === 'rising' ? '‚Üë' : t.growthRate === 'declining' ? '‚Üì' : '‚Üí') + '</span>';
                    html += '</div>';
                    html += '<p class="text-sm text-gray-600">' + utils.escapeHtml(t.description) + '</p>';
                    html += '</div>';
                });
                html += '</div></div>';

                // Predicted Trends
                html += '<div class="bg-gradient-to-br from-purple-600 to-indigo-600 rounded-2xl shadow-xl p-6 mb-6 fade-in">';
                html += '<h3 class="text-2xl font-bold text-white mb-4">üîÆ Predicted Future Trends</h3>';
                html += '<div class="grid grid-cols-1 md:grid-cols-3 gap-4">';
                (p.predictedTrends || []).forEach(function(t) {
                    var confBadge = t.confidence === 'high' ? 'bg-green-500' : t.confidence === 'medium' ? 'bg-yellow-500' : 'bg-gray-500';
                    html += '<div class="p-4 bg-white/10 backdrop-blur rounded-xl">';
                    html += '<div class="flex items-center justify-between mb-2">';
                    html += '<span class="font-bold text-white">' + utils.escapeHtml(t.topic) + '</span>';
                    html += '<span class="' + confBadge + ' text-white text-xs px-2 py-1 rounded-full">' + (t.confidence || 'medium') + '</span>';
                    html += '</div>';
                    html += '<p class="text-sm text-white/80 mb-2">' + utils.escapeHtml(t.reasoning) + '</p>';
                    html += '<p class="text-xs text-white/60">‚è∞ ' + utils.escapeHtml(t.timeframe || '2-4 weeks') + '</p>';
                    html += '</div>';
                });
                html += '</div></div>';

                // Video Ideas
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 mb-6 fade-in">';
                html += '<h3 class="text-2xl font-bold text-gray-800 mb-4">üí° Video Ideas for You</h3>';
                html += '<div class="space-y-4">';
                (p.videoIdeas || []).forEach(function(v, i) {
                    html += '<div class="p-4 border-2 border-gray-100 rounded-xl hover:border-blue-200 transition-all">';
                    html += '<div class="flex items-start justify-between">';
                    html += '<div><span class="text-2xl mr-3">' + (i+1) + '.</span><span class="font-bold text-gray-800 text-lg">' + utils.escapeHtml(v.title) + '</span></div>';
                    html += '<span class="bg-green-100 text-green-700 text-sm px-3 py-1 rounded-full font-medium">' + utils.escapeHtml(v.estimatedViews || '50K+') + '</span>';
                    html += '</div>';
                    html += '<p class="text-gray-600 mt-2 ml-8">' + utils.escapeHtml(v.description) + '</p>';
                    html += '</div>';
                });
                html += '</div></div>';

                // Hashtags
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 fade-in">';
                html += '<h3 class="text-xl font-bold text-gray-800 mb-4">#Ô∏è‚É£ Trending Hashtags</h3>';
                html += '<div class="flex flex-wrap gap-2">';
                (p.hashtagsToUse || []).forEach(function(h) {
                    html += '<span class="bg-blue-100 text-blue-700 px-4 py-2 rounded-full font-medium">' + utils.escapeHtml(h) + '</span>';
                });
                html += '</div></div>';

                html += '<div class="text-center mt-8">';
                html += '<button onclick="state.trendResults=null;render();" class="btn-secondary">Predict for Another Niche</button>';
                html += '</div>';
            }

            html += '</div></div>';
            return html;
        }

        /* ------------------------------------------
           4.6.11 Thumbnail Generator View (ADVANCED)
           ------------------------------------------ */
        function renderThumbnail() {
            var html = '';
            var hasVideoContext = state.lastOptimization && state.thumbnailFromOptimizer;
            var videoInfo = hasVideoContext ? (state.lastOptimization.videoInfo || {}) : {};
            var optimizedTitles = hasVideoContext ? (state.lastOptimization.titles || []) : [];
            var suggestedTitle = optimizedTitles[0] || videoInfo.title || '';

            html += '<div class="min-h-screen mobile-full-screen py-8 px-4">';
            html += '<div class="max-w-5xl mx-auto">';

            // Navigation buttons
            html += '<div class="flex flex-wrap gap-3 mb-6">';
            if (hasVideoContext) {
                html += '<button onclick="app.goToResults()" class="btn-secondary">‚Üê Back to Results</button>';
            } else {
                html += '<button onclick="app.goToDashboard()" class="btn-secondary">‚Üê Back to Dashboard</button>';
            }
            html += '<button onclick="app.goToHistory(\'thumbnail\')" class="btn-secondary">üìú View History</button>';
            html += '</div>';

            // Header
            html += '<div class="text-center mb-8 fade-in">';
            html += '<div class="w-20 h-20 bg-gradient-to-br from-pink-500 to-rose-600 rounded-3xl flex items-center justify-center text-5xl mx-auto mb-4 shadow-xl">üé®</div>';
            html += '<h1 class="text-3xl lg:text-4xl font-bold text-white mb-2">AI Thumbnail Generator</h1>';
            if (hasVideoContext) {
                html += '<p class="text-white/80 text-lg">Create a thumbnail for your optimized video</p>';
            } else {
                html += '<p class="text-white/80 text-lg">Generate click-worthy thumbnails with AI</p>';
            }
            html += '</div>';

            // Loading Section - Show at TOP when generating
            if (state.loading && !state.thumbnailImage) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 lg:p-8 mobile-padding mb-6 fade-in">';
                html += '<div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">';
                html += '<div class="flex items-center gap-4"><div class="loading-emoji">üé®</div><div><h3 class="text-xl font-bold text-gray-800">Creating Your Thumbnail</h3><p class="text-gray-500">AI is generating your image...</p></div></div>';
                html += '<div class="progress-percentage">' + Math.round(state.loadingProgress) + '%</div>';
                html += '</div>';
                html += '<div class="progress-bar-container mb-6"><div class="progress-bar-fill" style="width:' + state.loadingProgress + '%"></div></div>';
                html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-3">';
                for (var li = 0; li < state.loadingSteps.length; li++) {
                    var lstep = state.loadingSteps[li];
                    var lstepClass = li < state.loadingStep ? 'completed' : li === state.loadingStep ? 'active' : 'pending';
                    html += '<div class="loading-step ' + lstepClass + '">';
                    html += '<div class="step-icon ' + lstepClass + '">' + (lstepClass === 'completed' ? '‚úì' : lstep.icon) + '</div>';
                    html += '<span class="text-sm font-medium">' + lstep.name + '</span>';
                    html += '</div>';
                }
                html += '</div></div>';
            }

            // Video Context Card (if from optimizer) - show when not loading
            if (hasVideoContext && videoInfo.thumbnail && !state.loading) {
                html += '<div class="bg-white/10 backdrop-blur rounded-2xl p-4 mb-6 fade-in">';
                html += '<div class="flex items-center gap-4">';
                html += '<img src="' + utils.escapeHtml(videoInfo.thumbnail) + '" class="w-32 h-18 object-cover rounded-lg" />';
                html += '<div>';
                html += '<p class="text-white font-semibold">' + utils.escapeHtml(videoInfo.title || 'Your Video') + '</p>';
                html += '<p class="text-white/70 text-sm">' + utils.escapeHtml(videoInfo.channelTitle || '') + '</p>';
                html += '<span class="inline-block mt-2 bg-green-500 text-white text-xs px-2 py-1 rounded-full">‚úì Video context loaded</span>';
                html += '</div></div></div>';
            }

            // Main Form Card
            html += '<div class="bg-white rounded-2xl shadow-xl p-6 lg:p-8 mobile-padding fade-in">';

            if (state.error) {
                html += '<div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-xl text-red-700">' + utils.escapeHtml(state.error.message) + '</div>';
            }

            if (!state.thumbnailImage) {
                html += '<form onsubmit="app.generateThumbnail(event)">';

                // Title Input (pre-filled if from optimizer)
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-2">Video Title</label>';
                html += '<input type="text" id="thumbnail-title" value="' + utils.escapeHtml(suggestedTitle) + '" placeholder="Enter your video title..." class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-500 focus:outline-none text-lg" required />';
                if (hasVideoContext && optimizedTitles.length > 1) {
                    html += '<p class="text-sm text-gray-500 mt-2">üí° Or try: <span class="text-pink-600 cursor-pointer hover:underline" onclick="document.getElementById(\'thumbnail-title\').value=\'' + utils.escapeHtml(optimizedTitles[1]).replace(/'/g, "\\'") + '\'">' + utils.escapeHtml(optimizedTitles[1]) + '</span></p>';
                }
                html += '</div>';

                // Style Selection
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-3">Thumbnail Style</label>';
                html += '<div class="grid grid-cols-2 lg:grid-cols-4 gap-3">';

                var styles = [
                    { id: 'professional', name: 'Professional', icon: 'üíº', desc: 'Clean & sharp', color: 'blue' },
                    { id: 'dramatic', name: 'Dramatic', icon: 'üé≠', desc: 'Bold & intense', color: 'purple' },
                    { id: 'minimal', name: 'Minimal', icon: '‚ú®', desc: 'Simple & elegant', color: 'gray' },
                    { id: 'bold', name: 'Bold', icon: 'üî•', desc: 'Eye-catching', color: 'orange' }
                ];

                styles.forEach(function(s) {
                    var isActive = state.thumbnailStyle === s.id;
                    var borderClass = isActive ? 'border-pink-500 bg-pink-50' : 'border-gray-200 hover:border-pink-300';
                    html += '<div onclick="app.setThumbnailStyle(\'' + s.id + '\')" class="cursor-pointer p-4 border-2 ' + borderClass + ' rounded-xl text-center transition-all">';
                    html += '<div class="text-3xl mb-1">' + s.icon + '</div>';
                    html += '<p class="font-semibold text-gray-800">' + s.name + '</p>';
                    html += '<p class="text-xs text-gray-500">' + s.desc + '</p>';
                    if (isActive) html += '<span class="inline-block mt-2 text-pink-600 text-xs font-medium">‚úì Selected</span>';
                    html += '</div>';
                });
                html += '</div></div>';

                // Custom Prompt
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-2">Additional Details <span class="text-gray-400 font-normal">(Optional)</span></label>';
                html += '<textarea id="thumbnail-prompt" placeholder="e.g., Include a person looking surprised, bright red arrow pointing right, space for text on the left side..." class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-500 focus:outline-none h-20"></textarea>';
                html += '</div>';

                // Tips Section
                html += '<div class="bg-gradient-to-r from-pink-50 to-purple-50 p-4 rounded-xl mb-6">';
                html += '<h4 class="font-semibold text-gray-800 mb-2">üí° Pro Tips for Better Thumbnails</h4>';
                html += '<ul class="text-sm text-gray-600 space-y-1">';
                html += '<li>‚Ä¢ Use faces with emotions - they get 38% more clicks</li>';
                html += '<li>‚Ä¢ Keep text minimal - the AI will leave space for overlay</li>';
                html += '<li>‚Ä¢ High contrast colors stand out in YouTube feed</li>';
                html += '</ul></div>';

                // Submit Button
                html += '<button type="submit" class="btn-primary bg-gradient-to-r from-pink-500 to-rose-600 text-lg py-4" ' + (state.loading ? 'disabled' : '') + '>';
                html += state.loading ? '‚è≥ Generating...' : 'üé® Generate AI Thumbnail';
                html += '</button>';
                html += '</form>';
            } else {
                // Show generated thumbnail
                html += '<div class="text-center">';

                // Parse output - handle various RunPod response formats
                var imgSrc = '';
                var outputData = state.thumbnailImage;
                var hasError = false;
                var errorMsg = '';

                // Check for error in response
                if (outputData && (outputData.message || outputData.error)) {
                    hasError = true;
                    errorMsg = outputData.message || outputData.error || 'Unknown error';
                }

                if (!hasError) {
                    // Try to extract image from various formats
                    if (typeof outputData === 'string' && (outputData.startsWith('http') || outputData.startsWith('data:'))) {
                        imgSrc = outputData;
                    } else if (outputData) {
                        // Common RunPod output formats
                        if (outputData.image_url) imgSrc = outputData.image_url;
                        else if (outputData.image && typeof outputData.image === 'string') {
                            imgSrc = outputData.image.startsWith('http') || outputData.image.startsWith('data:')
                                ? outputData.image
                                : 'data:image/png;base64,' + outputData.image;
                        }
                        else if (outputData.images && outputData.images[0]) imgSrc = outputData.images[0];
                        else if (outputData.result) {
                            imgSrc = outputData.result.startsWith && (outputData.result.startsWith('http') || outputData.result.startsWith('data:'))
                                ? outputData.result
                                : 'data:image/png;base64,' + outputData.result;
                        }
                        else if (outputData.output && typeof outputData.output === 'string') imgSrc = outputData.output;
                        else if (outputData.url) imgSrc = outputData.url;
                    }
                }

                if (hasError) {
                    // Show error message
                    html += '<div class="inline-block bg-gradient-to-r from-red-400 to-rose-500 text-white px-4 py-2 rounded-full mb-4 font-semibold">‚ö†Ô∏è Generation Issue</div>';
                    html += '<div class="bg-red-50 border border-red-200 p-6 rounded-xl mb-6 max-w-2xl mx-auto">';
                    html += '<p class="text-red-700 font-medium mb-2">The AI service returned an error:</p>';
                    html += '<p class="text-red-600">' + utils.escapeHtml(errorMsg) + '</p>';
                    html += '</div>';
                } else if (imgSrc) {
                    html += '<div class="inline-block bg-gradient-to-r from-green-400 to-emerald-500 text-white px-4 py-2 rounded-full mb-4 font-semibold">‚ú® Thumbnail Generated!</div>';
                    html += '<div class="relative inline-block">';
                    html += '<img src="' + utils.escapeHtml(imgSrc) + '" class="w-full max-w-2xl mx-auto rounded-xl shadow-2xl mb-6" alt="Generated Thumbnail" />';
                    html += '<div class="absolute bottom-8 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded">1280 √ó 720</div>';
                    html += '</div>';
                } else {
                    // Unknown format - show debug info
                    html += '<div class="inline-block bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-4 py-2 rounded-full mb-4 font-semibold">‚ö†Ô∏è Check Output Format</div>';
                    html += '<div class="bg-yellow-50 border border-yellow-200 p-6 rounded-xl mb-6 max-w-2xl mx-auto text-left">';
                    html += '<p class="text-yellow-700 font-medium mb-2">Thumbnail generated but format not recognized:</p>';
                    html += '<pre class="text-xs overflow-auto bg-yellow-100 p-4 rounded max-h-40">' + JSON.stringify(outputData, null, 2) + '</pre>';
                    html += '<p class="text-yellow-600 text-sm mt-2">Please share this with support to fix the integration.</p>';
                    html += '</div>';
                }

                html += '<div class="flex flex-col sm:flex-row justify-center gap-4 mt-6">';
                if (imgSrc && !hasError) {
                    html += '<a href="' + imgSrc + '" download="thumbnail.png" class="btn-primary bg-gradient-to-r from-green-500 to-emerald-600 inline-flex items-center justify-center gap-2"><span>üì•</span> Download Thumbnail</a>';
                }
                html += '<button onclick="state.thumbnailImage=null;state.thumbnailJob=null;render();" class="btn-secondary">üîÑ Try Again</button>';
                html += '</div></div>';
            }

            html += '</div></div></div>';
            return html;
        }

        /* ------------------------------------------
           4.6.12 Placement Finder View
           ------------------------------------------ */
        function renderPlacement() {
            var html = '';
            var results = state.placementResults;

            html += '<div class="min-h-screen mobile-full-screen py-8 px-4">';
            html += '<div class="max-w-6xl mx-auto">';

            // Navigation buttons
            html += '<div class="flex flex-wrap gap-3 mb-6">';
            html += '<button onclick="app.goToDashboard()" class="btn-secondary">‚Üê Back to Dashboard</button>';
            html += '</div>';

            // Header
            html += '<div class="text-center mb-8 fade-in">';
            html += '<div class="w-20 h-20 bg-gradient-to-br from-purple-500 to-violet-600 rounded-3xl flex items-center justify-center text-5xl mx-auto mb-4 shadow-xl">üé¨</div>';
            html += '<h1 class="text-3xl lg:text-4xl font-bold text-white mb-2">Placement Finder</h1>';
            html += '<p class="text-white/80 text-lg">Find successful YouTube channels for your Google Ads placements</p>';
            html += '</div>';

            // Copy Success Toast
            if (state.copySuccess) {
                html += '<div class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-xl shadow-xl z-50 fade-in">';
                html += '‚úÖ ' + utils.escapeHtml(state.copySuccess);
                html += '</div>';
            }

            // Error Message
            if (state.error) {
                html += '<div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-xl text-red-700">' + utils.escapeHtml(state.error.message) + '</div>';
            }

            // Loading Section
            if (state.loading && !results) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 lg:p-8 mobile-padding mb-6 fade-in">';
                html += '<div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">';
                html += '<div class="flex items-center gap-4"><div class="loading-emoji">üé¨</div><div><h3 class="text-xl font-bold text-gray-800">Finding Placement Channels</h3><p class="text-gray-500">Analyzing your channel and finding matches...</p></div></div>';
                html += '<div class="progress-percentage">' + Math.round(state.loadingProgress) + '%</div>';
                html += '</div>';
                html += '<div class="progress-bar-container mb-6"><div class="progress-bar-fill" style="width:' + state.loadingProgress + '%"></div></div>';
                html += '<div class="grid grid-cols-2 md:grid-cols-3 gap-3">';
                for (var li = 0; li < state.loadingSteps.length; li++) {
                    var lstep = state.loadingSteps[li];
                    var lstepClass = li < state.loadingStep ? 'completed' : li === state.loadingStep ? 'active' : 'pending';
                    html += '<div class="loading-step ' + lstepClass + '">';
                    html += '<div class="step-icon ' + lstepClass + '">' + (lstepClass === 'completed' ? '‚úì' : lstep.icon) + '</div>';
                    html += '<span class="text-sm font-medium">' + lstep.name + '</span>';
                    html += '</div>';
                }
                html += '</div></div>';
            }

            // Input Form (show when no results)
            if (!results && !state.loading) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 lg:p-8 mobile-padding fade-in">';
                html += '<div class="max-w-xl mx-auto">';

                html += '<div class="text-center mb-6">';
                html += '<p class="text-gray-600 text-lg">Enter your YouTube channel link and we\'ll find successful channels whose audience may like your content.</p>';
                html += '</div>';

                html += '<form onsubmit="app.findPlacements(event)">';
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-2">Your YouTube Channel URL</label>';
                html += '<input type="text" id="placement-channel-url" placeholder="https://youtube.com/@yourchannel" class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-lg" required />';
                html += '<p class="text-sm text-gray-500 mt-2">Supports: youtube.com/@handle, youtube.com/channel/..., youtube.com/c/...</p>';
                html += '</div>';

                html += '<button type="submit" class="w-full py-4 bg-gradient-to-r from-purple-500 to-violet-600 text-white font-bold rounded-xl hover:from-purple-600 hover:to-violet-700 transition-all shadow-lg hover:shadow-xl text-lg">';
                html += 'üîç Find Placement Channels';
                html += '</button>';
                html += '</form>';

                // Tips Section
                html += '<div class="mt-8 bg-gradient-to-r from-purple-50 to-violet-50 p-5 rounded-xl">';
                html += '<h4 class="font-semibold text-gray-800 mb-3">üí° What is Placement Targeting?</h4>';
                html += '<ul class="text-sm text-gray-600 space-y-2">';
                html += '<li>‚Ä¢ <strong>Google Ads Placements</strong> let you show ads on specific YouTube channels</li>';
                html += '<li>‚Ä¢ Find channels with audiences similar to your content</li>';
                html += '<li>‚Ä¢ Copy channel URLs directly into your Google Ads campaign</li>';
                html += '<li>‚Ä¢ Target viewers who are already interested in your niche</li>';
                html += '</ul>';
                html += '</div>';

                html += '</div></div>';
            }

            // Results Section
            if (results && results.placements) {
                var placements = results.placements;
                var channelInfo = results.channelInfo || {};
                var analysis = results.analysis || {};

                // Channel Info Card
                html += '<div class="bg-white/10 backdrop-blur rounded-2xl p-5 mb-6 fade-in">';
                html += '<div class="flex flex-wrap items-center gap-4">';
                if (channelInfo.thumbnail) {
                    html += '<img src="' + utils.escapeHtml(channelInfo.thumbnail) + '" class="w-16 h-16 object-cover rounded-full" />';
                }
                html += '<div class="flex-1 min-w-[200px]">';
                html += '<p class="text-white font-bold text-lg">' + utils.escapeHtml(channelInfo.name || 'Your Channel') + '</p>';
                html += '<p class="text-white/70">' + utils.escapeHtml(analysis.niche || '') + '</p>';
                if (analysis.audienceDescription) {
                    html += '<p class="text-white/60 text-sm mt-1">üë• ' + utils.escapeHtml(analysis.audienceDescription) + '</p>';
                }
                html += '</div>';
                html += '<div class="bg-green-500 text-white px-4 py-2 rounded-full font-bold">';
                html += '‚úì ' + placements.length + ' Channels Found';
                html += '</div>';
                html += '</div></div>';

                // Action Buttons
                html += '<div class="flex flex-wrap gap-3 mb-6">';
                html += '<button onclick="app.copyAllPlacements()" class="btn-primary bg-gradient-to-r from-green-500 to-emerald-600 flex items-center gap-2">';
                html += '<span>üìã</span> Copy All ' + placements.length + ' Channels';
                html += '</button>';
                if (placements.length < 50) {
                    html += '<button onclick="app.findMorePlacements()" class="btn-secondary flex items-center gap-2" ' + (state.placementLoading ? 'disabled' : '') + '>';
                    if (state.placementLoading) {
                        html += '<span class="animate-spin">‚è≥</span> Finding...';
                    } else {
                        html += '<span>üîÑ</span> Find 10 More (' + (50 - placements.length) + ' remaining)';
                    }
                    html += '</button>';
                }
                html += '<button onclick="app.goToPlacement()" class="btn-secondary flex items-center gap-2">';
                html += '<span>üîç</span> New Search';
                html += '</button>';
                html += '</div>';

                // Results Grid
                html += '<div class="bg-white rounded-2xl shadow-xl p-4 lg:p-6 fade-in">';
                html += '<div class="overflow-x-auto">';
                html += '<table class="w-full">';
                html += '<thead>';
                html += '<tr class="border-b-2 border-gray-100">';
                html += '<th class="text-left py-3 px-2 text-gray-600 font-semibold">#</th>';
                html += '<th class="text-left py-3 px-2 text-gray-600 font-semibold">Channel</th>';
                html += '<th class="text-left py-3 px-2 text-gray-600 font-semibold hidden md:table-cell">Subscribers</th>';
                html += '<th class="text-left py-3 px-2 text-gray-600 font-semibold hidden lg:table-cell">Score</th>';
                html += '<th class="text-right py-3 px-2 text-gray-600 font-semibold">Actions</th>';
                html += '</tr>';
                html += '</thead>';
                html += '<tbody>';

                for (var i = 0; i < placements.length; i++) {
                    var p = placements[i];
                    html += '<tr class="border-b border-gray-50 hover:bg-gray-50 transition-colors">';
                    html += '<td class="py-3 px-2 text-gray-400 font-medium">' + (i + 1) + '</td>';
                    html += '<td class="py-3 px-2">';
                    html += '<div class="flex items-center gap-3">';
                    if (p.thumbnail) {
                        html += '<img src="' + utils.escapeHtml(p.thumbnail) + '" class="w-10 h-10 rounded-full object-cover" />';
                    } else {
                        html += '<div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-400">üì∫</div>';
                    }
                    html += '<div>';
                    html += '<p class="font-semibold text-gray-800">' + utils.escapeHtml(p.channelName) + '</p>';
                    if (p.handle) {
                        html += '<p class="text-sm text-gray-500">' + utils.escapeHtml(p.handle) + '</p>';
                    }
                    html += '<p class="text-sm text-gray-500 md:hidden">' + utils.escapeHtml(p.subscribersFormatted) + ' subscribers</p>';
                    html += '</div>';
                    html += '</div>';
                    html += '</td>';
                    html += '<td class="py-3 px-2 hidden md:table-cell">';
                    html += '<span class="font-semibold text-gray-700">' + utils.escapeHtml(p.subscribersFormatted) + '</span>';
                    html += '</td>';
                    html += '<td class="py-3 px-2 hidden lg:table-cell">';
                    var scoreColor = p.relevanceScore >= 80 ? 'green' : p.relevanceScore >= 60 ? 'yellow' : 'gray';
                    html += '<span class="inline-block px-2 py-1 rounded-full text-xs font-bold bg-' + scoreColor + '-100 text-' + scoreColor + '-700">' + p.relevanceScore + '%</span>';
                    html += '</td>';
                    html += '<td class="py-3 px-2 text-right">';
                    html += '<div class="flex justify-end gap-2">';
                    html += '<a href="' + utils.escapeHtml(p.channelUrl) + '" target="_blank" class="p-2 text-gray-500 hover:text-purple-600 hover:bg-purple-50 rounded-lg transition-colors" title="Visit Channel">üîó</a>';
                    html += '<button onclick="app.copySinglePlacement(\'' + utils.escapeHtml(p.channelUrl) + '\')" class="p-2 text-gray-500 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors" title="Copy URL">üìã</button>';
                    html += '</div>';
                    html += '</td>';
                    html += '</tr>';
                }

                html += '</tbody>';
                html += '</table>';
                html += '</div>';

                // Footer info
                html += '<div class="mt-4 pt-4 border-t border-gray-100 flex flex-wrap justify-between items-center gap-4">';
                html += '<p class="text-sm text-gray-500">Showing ' + placements.length + ' of maximum 50 channels</p>';
                html += '<p class="text-sm text-gray-500">üí° Tip: Copy all and paste directly into Google Ads Placements</p>';
                html += '</div>';

                html += '</div>';
            }

            html += '</div></div>';
            return html;
        }

        /* ==========================================
           4.7 MAIN RENDER FUNCTION
           ========================================== */

        function render() {
            const root = document.getElementById('app-root');
            if (!root) return;

            var html = '';

            // Route to correct view
            switch (state.currentView) {
                case 'initializing':
                    html = renderInitializing();
                    break;
                case 'login':
                    html = renderLogin();
                    break;
                case 'register':
                    html = renderRegister();
                    break;
                case 'forgot-password':
                    html = renderForgotPassword();
                    break;
                case 'dashboard':
                    html = renderDashboard();
                    break;
                case 'optimizer':
                    html = renderOptimizer();
                    break;
                case 'results':
                    html = renderResults();
                    break;
                case 'history':
                    html = renderHistory();
                    break;
                case 'admin':
                    html = renderAdmin();
                    break;
                case 'competitor':
                    html = renderCompetitor();
                    break;
                case 'trends':
                    html = renderTrends();
                    break;
                case 'thumbnail':
                    html = renderThumbnail();
                    break;
                case 'placement':
                    html = renderPlacement();
                    break;
                default:
                    html = '<div class="view-container view-centered"><div class="spinner"></div></div>';
            }

            root.innerHTML = html;

            // Initialize mobile swipe dots and desktop carousel after DOM update (dashboard only)
            if (state.currentView === 'dashboard') {
                setTimeout(function() {
                    app.initSwipeDots();
                    app.initDesktopCarousel();
                }, 50);
            }
        }

        /* ==========================================
           4.8 INITIALIZE APPLICATION
           ========================================== */

        // Initial render
        render();

    })();
    </script>
</body>
</html>
