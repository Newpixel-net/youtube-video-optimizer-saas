<!-- ================================================================
     YOUTUBE VIDEO OPTIMIZER - MAIN WIDGET
     ================================================================

     Structure:
     - SECTION 1: External Dependencies (CDN)
     - SECTION 2: Styles (CSS)
     - SECTION 3: HTML Views
     - SECTION 4: Scripts (JavaScript)

     Views: login, register, forgot-password, dashboard, optimizer, results, history

     Last Updated: 2024
     ================================================================ -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>YouTube Video Optimizer</title>

    <!-- ============================================
         SECTION 1: EXTERNAL DEPENDENCIES
         ============================================ -->

    <!-- 1.1 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 1.2 Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-functions-compat.js"></script>

    <!-- ============================================
         SECTION 2: STYLES
         ============================================ -->
    <style>
        /* ------------------------------------------
           2.1 BASE & RESET
           ------------------------------------------ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }

        body {
            background: #0f1419;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 1rem;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        #app-root {
            width: 100%;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            position: relative;
            z-index: 1;
        }

        /* Base typography scale */
        h1 { font-size: 2.5rem; line-height: 1.2; font-weight: 700; letter-spacing: -0.02em; }
        h2 { font-size: 2rem; line-height: 1.25; font-weight: 700; letter-spacing: -0.01em; }
        h3 { font-size: 1.5rem; line-height: 1.3; font-weight: 600; }
        h4 { font-size: 1.25rem; line-height: 1.4; font-weight: 600; }
        p, span, label { font-size: 1rem; line-height: 1.6; }

        /* ------------------------------------------
           2.2 ANIMATIONS
           ------------------------------------------ */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            width: 40px;
            height: 40px;
            animation: spin 0.6s linear infinite;
        }

        .spinner-dark {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top-color: #3b82f6;
        }

        /* Professional Loading Animation */
        @keyframes progressPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-5px) rotate(2deg); }
            75% { transform: translateY(5px) rotate(-2deg); }
        }

        .loading-container {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 1.5rem;
            padding: 3rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        }

        .progress-bar-container {
            background: #e2e8f0;
            border-radius: 1rem;
            height: 12px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 1rem;
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
            background-size: 200% 100%;
            animation: shimmer 2s ease-in-out infinite;
            transition: width 0.5s ease-out;
        }

        .progress-percentage {
            font-size: 3.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
        }

        .loading-step {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.875rem 1.25rem;
            border-radius: 0.875rem;
            transition: all 0.3s ease;
        }

        .loading-step.active {
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
        }

        .loading-step.completed {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        }

        .step-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .step-icon.pending {
            background: #e2e8f0;
            color: #94a3b8;
        }

        .step-icon.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .step-icon.completed {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }

        .loading-emoji {
            font-size: 4rem;
            animation: float 3s ease-in-out infinite;
        }

        .loading-tip {
            background: rgba(99, 102, 241, 0.1);
            border-left: 4px solid #6366f1;
            padding: 1rem 1.25rem;
            border-radius: 0 0.75rem 0.75rem 0;
        }

        /* ------------------------------------------
           2.2.5 NOTIFICATION & REPORT STYLES
           ------------------------------------------ */
        @keyframes notificationPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { transform: scale(1.1); box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }

        @keyframes notificationGlow {
            0%, 100% { box-shadow: 0 0 5px rgba(34, 197, 94, 0.5); }
            50% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.8), 0 0 30px rgba(34, 197, 94, 0.4); }
        }

        /* New notification attention animation - triggered when new notifications arrive */
        @keyframes notificationBounce {
            0%, 100% { transform: scale(1); }
            10% { transform: scale(1.3); }
            20% { transform: scale(1); }
            30% { transform: scale(1.2); }
            40% { transform: scale(1); }
            50% { transform: scale(1.15); }
            60% { transform: scale(1); }
        }

        @keyframes notificationFlash {
            0%, 100% { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
            25% { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
            50% { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
            75% { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
        }

        .notification-badge.notification-new {
            animation: notificationBounce 1s ease-in-out, notificationFlash 1s ease-in-out 3;
        }

        .notification-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            min-width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            font-size: 11px;
            font-weight: 700;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
            animation: notificationPulse 2s ease-in-out infinite;
        }

        .notification-dot {
            width: 12px;
            height: 12px;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            border-radius: 50%;
            animation: notificationGlow 2s ease-in-out infinite;
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 8px;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .notification-bell:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 320px;
            max-height: 400px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            z-index: 1001;
            margin-top: 8px;
            animation: fadeIn 0.2s ease-out;
        }

        .notification-empty {
            padding: 2rem;
            text-align: center;
            color: #94a3b8;
        }

        .notification-empty-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            opacity: 0.5;
        }

        /* Click-outside overlay for notifications */
        .notification-overlay {
            position: fixed;
            inset: 0;
            z-index: 999;
        }

        /* ------------------------------------------
           2.2.6 SCROLLABLE TABS (Mobile-friendly)
           ------------------------------------------ */
        .history-tabs-container {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }

        .history-tabs-container::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        .history-tab-btn {
            min-width: max-content;
        }

        /* Scrollbar hide utility */
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        /* Global Header */
        .global-header {
            position: fixed;
            top: 0;
            right: 0;
            left: 0;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 1rem;
            z-index: 1000;
            pointer-events: none;
        }

        .global-header > * {
            pointer-events: auto;
        }

        .global-header-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* View Transitions */
        .view-transitioning {
            opacity: 0;
            transform: translateY(8px);
        }

        .view-entering {
            animation: viewEnter 0.25s ease-out forwards;
        }

        @keyframes viewEnter {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Hide carousel during initialization */
        .carousel-initializing {
            visibility: hidden;
        }

        .carousel-ready {
            visibility: visible;
            animation: fadeIn 0.3s ease-out;
        }

        .upload-zone {
            border: 3px dashed #cbd5e1;
            border-radius: 16px;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #f8fafc;
        }

        .upload-zone:hover, .upload-zone.drag-over {
            border-color: #6366f1;
            background: #eef2ff;
        }

        .upload-zone.has-images {
            border-style: solid;
            border-color: #22c55e;
            background: #f0fdf4;
        }

        .image-preview {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 16/9;
            background: #f1f5f9;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview .remove-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .image-preview .remove-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .report-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0;
        }

        .report-card:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-draft { background: #f1f5f9; color: #64748b; }
        .status-ready { background: #dbeafe; color: #2563eb; }
        .status-sent { background: #dcfce7; color: #16a34a; }
        .status-viewed { background: #f3e8ff; color: #9333ea; }

        .metric-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }

        .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1e293b;
        }

        .metric-label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .recommendation-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            border-left: 4px solid;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .recommendation-card.priority-high { border-left-color: #ef4444; }
        .recommendation-card.priority-medium { border-left-color: #f59e0b; }
        .recommendation-card.priority-low { border-left-color: #22c55e; }

        .client-report-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .client-report-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
        }

        .client-report-card.has-new::after {
            content: 'NEW';
            position: absolute;
            top: 12px;
            right: -28px;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 4px 32px;
            transform: rotate(45deg);
        }

        /* ------------------------------------------
           2.2.6 LIVING AURORA EFFECT
           Animated orbs + noise texture + time-aware colors
           ------------------------------------------ */

        /* Time-aware color CSS custom properties - set by JavaScript */
        :root {
            /* Default colors (will be overridden by JS based on time) */
            --aurora-primary: #6366f1;
            --aurora-secondary: #8b5cf6;
            --aurora-tertiary: #a855f7;
            --aurora-accent: #06b6d4;
            --aurora-glow: rgba(99, 102, 241, 0.3);

            /* Morning colors (6am-12pm) */
            --aurora-morning-primary: #f59e0b;
            --aurora-morning-secondary: #fb923c;
            --aurora-morning-tertiary: #fbbf24;
            --aurora-morning-accent: #fcd34d;

            /* Afternoon colors (12pm-6pm) */
            --aurora-afternoon-primary: #22c55e;
            --aurora-afternoon-secondary: #34d399;
            --aurora-afternoon-tertiary: #10b981;
            --aurora-afternoon-accent: #06b6d4;

            /* Evening colors (6pm-9pm) */
            --aurora-evening-primary: #f97316;
            --aurora-evening-secondary: #ef4444;
            --aurora-evening-tertiary: #ec4899;
            --aurora-evening-accent: #f59e0b;

            /* Night colors (9pm-6am) */
            --aurora-night-primary: #6366f1;
            --aurora-night-secondary: #8b5cf6;
            --aurora-night-tertiary: #a855f7;
            --aurora-night-accent: #3b82f6;
        }

        /* Aurora gradient animation */
        @keyframes auroraFlow {
            0%, 100% {
                background-position: 0% 50%;
            }
            25% {
                background-position: 50% 100%;
            }
            50% {
                background-position: 100% 50%;
            }
            75% {
                background-position: 50% 0%;
            }
        }

        @keyframes auroraShift {
            0%, 100% {
                filter: hue-rotate(0deg);
                transform: scale(1);
            }
            33% {
                filter: hue-rotate(15deg);
                transform: scale(1.02);
            }
            66% {
                filter: hue-rotate(-10deg);
                transform: scale(0.98);
            }
        }

        /* Floating orb animations */
        @keyframes orbFloat1 {
            0%, 100% {
                transform: translate(0, 0) scale(1);
                opacity: 0.6;
            }
            25% {
                transform: translate(30%, -20%) scale(1.1);
                opacity: 0.8;
            }
            50% {
                transform: translate(60%, 10%) scale(0.9);
                opacity: 0.5;
            }
            75% {
                transform: translate(20%, 30%) scale(1.05);
                opacity: 0.7;
            }
        }

        @keyframes orbFloat2 {
            0%, 100% {
                transform: translate(0, 0) scale(1);
                opacity: 0.5;
            }
            25% {
                transform: translate(-40%, 30%) scale(0.8);
                opacity: 0.7;
            }
            50% {
                transform: translate(-20%, -30%) scale(1.2);
                opacity: 0.4;
            }
            75% {
                transform: translate(30%, -10%) scale(0.9);
                opacity: 0.6;
            }
        }

        @keyframes orbFloat3 {
            0%, 100% {
                transform: translate(0, 0) scale(0.9);
                opacity: 0.4;
            }
            33% {
                transform: translate(50%, 40%) scale(1.1);
                opacity: 0.6;
            }
            66% {
                transform: translate(-30%, 20%) scale(0.85);
                opacity: 0.5;
            }
        }

        @keyframes orbPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.3);
                opacity: 0.8;
            }
        }

        @keyframes noiseAnimation {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-1%, -1%); }
            20% { transform: translate(1%, 1%); }
            30% { transform: translate(-0.5%, 0.5%); }
            40% { transform: translate(0.5%, -0.5%); }
            50% { transform: translate(-1%, 1%); }
            60% { transform: translate(1%, -1%); }
            70% { transform: translate(0, 0.5%); }
            80% { transform: translate(-0.5%, 0); }
            90% { transform: translate(0.5%, 0.5%); }
        }

        /* Living Aurora Card Container */
        .living-aurora {
            position: relative;
            overflow: hidden;
            isolation: isolate;
        }

        /* Aurora gradient background layer - OPTIMIZED */
        .living-aurora::before {
            content: '';
            position: absolute;
            inset: -20%; /* Reduced from -50% */
            background: linear-gradient(
                135deg,
                var(--aurora-primary) 0%,
                var(--aurora-secondary) 25%,
                var(--aurora-tertiary) 50%,
                var(--aurora-accent) 75%,
                var(--aurora-primary) 100%
            );
            background-size: 200% 200%; /* Reduced from 400% 400% */
            animation: auroraFlow 25s ease-in-out infinite; /* Slower animation */
            z-index: -3;
            opacity: 1;
            will-change: background-position;
        }

        /* Noise texture overlay - OPTIMIZED: removed animation for performance */
        .living-aurora::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            background-size: 200px 200px;
            opacity: 0.05;
            mix-blend-mode: overlay;
            /* REMOVED animation - was causing performance issues */
            /* animation: noiseAnimation 8s steps(10) infinite; */
            z-index: 1;
            pointer-events: none;
        }

        /* Animated orbs container */
        .aurora-orbs {
            position: absolute;
            inset: 0;
            overflow: hidden;
            z-index: -2;
            pointer-events: none;
        }

        /* Individual orbs - OPTIMIZED for performance */
        .aurora-orb {
            position: absolute;
            border-radius: 50%;
            /* REMOVED blur filter - was causing major performance issues */
            /* filter: blur(40px); */
            mix-blend-mode: screen;
            /* REMOVED will-change to prevent separate compositing layer issues during navigation */
            /* will-change: transform, opacity; */
            /* Use a softer gradient instead of blur for performance */
            opacity: 0.4;
            /* Ensure orbs transition with parent */
            transition: opacity 0.15s ease-out;
        }

        /* Hide aurora orbs when link is clicked to prevent flash during navigation */
        a:active .aurora-orb,
        a:active .aurora-orbs,
        a:active .living-aurora::before,
        a:active .aurora-shimmer {
            opacity: 0 !important;
            transition: none;
        }

        /* Also hide during view transitions */
        .view-transitioning .aurora-orb,
        .view-transitioning .aurora-orbs,
        .view-transitioning .living-aurora::before {
            opacity: 0;
        }

        .aurora-orb-1 {
            width: 60%;
            height: 60%;
            top: -20%;
            left: -10%;
            /* Softer gradient to simulate blur without GPU cost */
            background: radial-gradient(circle, var(--aurora-primary) 0%, transparent 50%);
            animation: orbFloat1 20s ease-in-out infinite; /* Slower = less GPU work */
        }

        .aurora-orb-2 {
            width: 50%;
            height: 50%;
            bottom: -15%;
            right: -15%;
            background: radial-gradient(circle, var(--aurora-secondary) 0%, transparent 50%);
            animation: orbFloat2 18s ease-in-out infinite;
            animation-delay: -3s;
        }

        .aurora-orb-3 {
            width: 40%;
            height: 40%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle, var(--aurora-tertiary) 0%, transparent 50%);
            animation: orbFloat3 22s ease-in-out infinite;
            animation-delay: -5s;
        }

        .aurora-orb-4 {
            width: 30%;
            height: 30%;
            top: 20%;
            right: 10%;
            background: radial-gradient(circle, var(--aurora-accent) 0%, transparent 50%);
            animation: orbPulse 10s ease-in-out infinite; /* Slower pulse */
            animation-delay: -2s;
        }

        /* Card content wrapper - ensures content is above aurora */
        .aurora-content {
            position: relative;
            z-index: 2;
        }

        /* Glassmorphism overlay for better text readability - OPTIMIZED */
        .aurora-glass {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.08);
            /* REMOVED backdrop-filter for performance */
            /* backdrop-filter: blur(1px); */
            z-index: 0;
            pointer-events: none;
        }

        /* Aurora glow effect on hover - DISABLED for performance */
        /* Hover acceleration was causing jank */
        /*
        .living-aurora:hover::before {
            animation-duration: 8s;
        }

        .living-aurora:hover .aurora-orb {
            animation-duration: 6s;
        }
        */

        /* Accessibility: Respect reduced motion preference */
        @media (prefers-reduced-motion: reduce) {
            .living-aurora::before,
            .living-aurora::after,
            .aurora-orb {
                animation: none;
            }
            .living-aurora::before {
                background-position: 50% 50%;
            }
        }

        /* Time-aware theme classes */
        .aurora-morning {
            --aurora-primary: var(--aurora-morning-primary);
            --aurora-secondary: var(--aurora-morning-secondary);
            --aurora-tertiary: var(--aurora-morning-tertiary);
            --aurora-accent: var(--aurora-morning-accent);
        }

        .aurora-afternoon {
            --aurora-primary: var(--aurora-afternoon-primary);
            --aurora-secondary: var(--aurora-afternoon-secondary);
            --aurora-tertiary: var(--aurora-afternoon-tertiary);
            --aurora-accent: var(--aurora-afternoon-accent);
        }

        .aurora-evening {
            --aurora-primary: var(--aurora-evening-primary);
            --aurora-secondary: var(--aurora-evening-secondary);
            --aurora-tertiary: var(--aurora-evening-tertiary);
            --aurora-accent: var(--aurora-evening-accent);
        }

        .aurora-night {
            --aurora-primary: var(--aurora-night-primary);
            --aurora-secondary: var(--aurora-night-secondary);
            --aurora-tertiary: var(--aurora-night-tertiary);
            --aurora-accent: var(--aurora-night-accent);
        }

        /* Specific aurora themes for different card types */
        .aurora-emerald {
            --aurora-primary: #10b981;
            --aurora-secondary: #14b8a6;
            --aurora-tertiary: #06b6d4;
            --aurora-accent: #22c55e;
        }

        .aurora-gold {
            --aurora-primary: #f59e0b;
            --aurora-secondary: #fbbf24;
            --aurora-tertiary: #f97316;
            --aurora-accent: #eab308;
        }

        .aurora-creative {
            --aurora-primary: #8b5cf6;
            --aurora-secondary: #a855f7;
            --aurora-tertiary: #ec4899;
            --aurora-accent: #d946ef;
        }

        /* Aurora shimmer for subtle movement */
        @keyframes auroraShimmer {
            0% {
                opacity: 0.3;
                transform: translateX(-100%) rotate(45deg);
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 0.3;
                transform: translateX(100%) rotate(45deg);
            }
        }

        .aurora-shimmer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.15) 50%,
                transparent 100%
            );
            animation: auroraShimmer 8s ease-in-out infinite; /* Slower */
            will-change: transform, opacity;
            z-index: 1;
            pointer-events: none;
        }

        /* Image Lightbox Modal */
        .lightbox-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            animation: fadeIn 0.2s ease;
        }

        .lightbox-content {
            position: relative;
            max-width: 95vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .lightbox-image {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
        }

        .lightbox-close {
            position: absolute;
            top: -50px;
            right: 0;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lightbox-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lightbox-nav:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .lightbox-nav.prev { left: -70px; }
        .lightbox-nav.next { right: -70px; }

        .lightbox-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .lightbox-download {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .lightbox-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4);
        }

        .lightbox-counter {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            margin-top: 1rem;
        }

        /* Report Image Gallery */
        .report-image-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .report-image-item:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .report-image-item img {
            width: 100%;
            height: auto;
            display: block;
        }

        .report-image-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s ease;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding: 1rem;
        }

        .report-image-item:hover .report-image-overlay {
            opacity: 1;
        }

        .report-image-actions {
            display: flex;
            gap: 0.5rem;
        }

        .report-image-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.9);
            color: #1e293b;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            transition: all 0.2s ease;
        }

        .report-image-btn:hover {
            background: white;
            transform: translateY(-2px);
        }

        /* YouTube Performance Hero Section */
        .youtube-hero {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .youtube-hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff0000 0%, #ff4444 50%, #ff6666 100%);
        }

        .youtube-hero-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }

        .youtube-hero-main {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .youtube-hero-main::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }

        .youtube-views-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .youtube-views-value {
            color: white;
            font-size: 3.5rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 1rem;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .youtube-view-rate {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .view-rate-bar {
            flex: 1;
            max-width: 200px;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .view-rate-fill {
            height: 100%;
            background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 100%);
            border-radius: 4px;
            transition: width 1s ease;
        }

        .view-rate-text {
            color: #fbbf24;
            font-weight: 700;
            font-size: 1.125rem;
        }

        .youtube-metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .youtube-metric-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .youtube-metric-card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .youtube-metric-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .youtube-metric-value {
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .youtube-metric-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.25rem;
        }

        .youtube-video-info {
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .youtube-video-title {
            color: white;
            font-weight: 600;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .youtube-video-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 0.75rem;
            flex-wrap: wrap;
        }

        .youtube-video-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.8rem;
        }

        .youtube-video-tag.status-eligible {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        @media (max-width: 640px) {
            .youtube-hero { padding: 1.25rem; }
            .youtube-views-value { font-size: 2.5rem; }
            .youtube-metrics-grid { grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
            .youtube-metric-card { padding: 0.75rem 0.5rem; }
            .youtube-metric-value { font-size: 1.125rem; }
            .lightbox-nav { display: none; }
        }

        /* ------------------------------------------
           2.3 COMPONENTS - Buttons
           ------------------------------------------ */
        .btn-primary {
            width: 100%;
            padding: 1.125rem 1.5rem;
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            color: white;
            font-weight: 600;
            font-size: 1.0625rem;
            border-radius: 0.875rem;
            border: none;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 14px rgba(124, 58, 237, 0.25);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #6d28d9 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(124, 58, 237, 0.35);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(124, 58, 237, 0.25);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            padding: 0.75rem 1.25rem;
            background: rgba(255, 255, 255, 0.25);
            /* REMOVED backdrop-filter for performance */
            color: white;
            font-weight: 600;
            font-size: 0.9375rem;
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .google-btn {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1rem;
        }

        .google-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .google-btn:active {
            transform: translateY(0);
        }

        /* ------------------------------------------
           2.4 COMPONENTS - Cards
           ------------------------------------------ */
        .tool-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .tool-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            border-color: rgba(124, 58, 237, 0.2);
        }

        .card {
            background: white;
            border-radius: 1.25rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.2);
            padding: 2.5rem;
        }

        /* ------------------------------------------
           2.4b COMPONENTS - Tabs
           ------------------------------------------ */
        .tabs-container {
            display: flex;
            gap: 0.375rem;
            background: #f3f4f6;
            padding: 0.375rem;
            border-radius: 1rem;
            margin-bottom: 1.75rem;
        }

        .tab-btn {
            flex: 1;
            padding: 0.875rem 1.25rem;
            border: none;
            background: transparent;
            color: #6b7280;
            font-weight: 600;
            font-size: 0.9375rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-btn:hover {
            color: #374151;
            background: rgba(255, 255, 255, 0.6);
        }

        .tab-btn.active {
            background: white;
            color: #7c3aed;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .tab-content {
            animation: fadeIn 0.3s ease-out;
        }

        /* ------------------------------------------
           2.4c COMPONENTS - Score Gauge
           ------------------------------------------ */
        .score-gauge {
            position: relative;
            width: 140px;
            height: 140px;
        }

        .score-circle {
            transform: rotate(-90deg);
        }

        .score-circle-bg {
            fill: none;
            stroke: #e5e7eb;
            stroke-width: 10;
        }

        .score-circle-fill {
            fill: none;
            stroke-width: 10;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s ease-out;
        }

        .score-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        /* ------------------------------------------
           2.5 COMPONENTS - Forms
           ------------------------------------------ */
        .input-field {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1rem;
            padding: 1rem 1.25rem;
        }

        .input-field:focus {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            border-color: #7c3aed;
        }

        .input-field::placeholder {
            color: #9ca3af;
        }

        /* ------------------------------------------
           2.6 COMPONENTS - Progress & Usage
           ------------------------------------------ */
        .usage-bar {
            transition: width 0.5s ease-out;
        }

        .usage-green { background-color: #22c55e; }
        .usage-yellow { background-color: #eab308; }
        .usage-red { background-color: #ef4444; }

        /* ------------------------------------------
           2.7 COMPONENTS - Messages
           ------------------------------------------ */
        .alert-error {
            padding: 0.75rem;
            background-color: #fef2f2;
            color: #b91c1c;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .alert-success {
            padding: 0.75rem;
            background-color: #f0fdf4;
            color: #15803d;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        /* ------------------------------------------
           2.8 COMPONENTS - Tags
           ------------------------------------------ */
        .tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background-color: #f3e8ff;
            color: #7c3aed;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* ------------------------------------------
           2.9 LAYOUT - Views
           ------------------------------------------ */
        .view-container {
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding: 2rem 1.5rem;
        }

        .view-centered {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .content-wrapper {
            max-width: 90rem;
            margin: 0 auto;
            width: 100%;
        }

        /* Desktop-optimized widths - expanded for better space utilization */
        @media (min-width: 1024px) {
            .max-w-6xl {
                max-width: 94% !important;
                padding-left: 1.5rem;
                padding-right: 1.5rem;
            }
            .max-w-4xl {
                max-width: 80% !important;
                min-width: 700px;
            }
        }

        @media (min-width: 1280px) {
            .max-w-6xl {
                max-width: 92% !important;
            }
            .max-w-4xl {
                max-width: 76% !important;
                min-width: 800px;
            }
            .view-container {
                padding: 1.75rem 2rem;
            }
        }

        @media (min-width: 1536px) {
            .max-w-6xl {
                max-width: 90% !important;
            }
            .max-w-4xl {
                max-width: 72% !important;
                min-width: 900px;
            }
            .view-container {
                padding: 2rem 3rem;
            }
        }

        @media (min-width: 1920px) {
            .max-w-6xl {
                max-width: 88% !important;
                max-width: min(88%, 1800px) !important;
            }
            .max-w-4xl {
                max-width: 68% !important;
                max-width: min(68%, 1200px) !important;
                min-width: 1000px;
            }
            .view-container {
                padding: 2.5rem 4rem;
            }
        }

        /* Dashboard grid - more columns on larger screens */
        @media (min-width: 1280px) {
            .dashboard-grid-4 {
                grid-template-columns: repeat(4, 1fr) !important;
            }
            .dashboard-grid-2 {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }

        @media (min-width: 1536px) {
            .dashboard-grid-4 {
                gap: 1.5rem !important;
            }
            .dashboard-grid-2 {
                gap: 2rem !important;
            }
        }

        /* ------------------------------------------
           2.10 MOBILE & RESPONSIVE
           ------------------------------------------ */

        /* Tablet styles (769px - 1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            html {
                font-size: 16px;
            }

            .view-container {
                padding: 1.75rem 1.5rem;
            }
        }

        /* Mobile styles (up to 768px) */
        @media (max-width: 768px) {
            html {
                font-size: 17px; /* Larger base for mobile readability */
            }

            body {
                -webkit-text-size-adjust: 100%;
            }

            /* Typography scale for mobile */
            h1 { font-size: 1.875rem !important; line-height: 1.2; }
            h2 { font-size: 1.5rem !important; line-height: 1.25; }
            h3 { font-size: 1.25rem !important; line-height: 1.3; }
            h4 { font-size: 1.125rem !important; line-height: 1.4; }
            p, span, label { font-size: 1rem; line-height: 1.6; }

            .view-container {
                padding: 1.25rem 1rem;
            }

            .mobile-full-screen {
                min-height: 100vh;
                min-height: -webkit-fill-available;
                padding: 1.25rem;
            }

            .mobile-card {
                width: 100%;
                max-width: 100%;
                margin: 0;
            }

            .mobile-padding {
                padding: 1.75rem !important;
            }

            .mobile-text-lg {
                font-size: 1.25rem !important;
            }

            .mobile-text-xl {
                font-size: 1.5rem !important;
            }

            .mobile-grid-cols-1 {
                grid-template-columns: 1fr !important;
            }

            /* Mobile Swipeable Usage Cards */
            .mobile-swipe-container {
                display: flex;
                overflow-x: auto;
                scroll-snap-type: x mandatory;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
                gap: 1rem;
                padding: 0.5rem 0;
                margin: 0 -1rem;
                padding-left: 1rem;
                padding-right: 1rem;
            }

            .mobile-swipe-container::-webkit-scrollbar {
                display: none;
            }

            .mobile-swipe-card {
                flex: 0 0 85%;
                scroll-snap-align: center;
                scroll-snap-stop: always;
            }

            .mobile-swipe-dots {
                display: flex;
                justify-content: center;
                gap: 0.5rem;
                margin-top: 1rem;
                margin-bottom: 0.5rem;
            }

            .mobile-swipe-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background-color: rgba(255, 255, 255, 0.4);
                transition: all 0.3s ease;
                cursor: pointer;
            }

            .mobile-swipe-dot.active {
                background-color: white;
                transform: scale(1.3);
            }

            .mobile-gap-4 {
                gap: 1rem !important;
            }

            /* Mobile wide container - expands content to near full width */
            .mobile-wide-container {
                max-width: 100% !important;
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
            }

            .mobile-wide-container .bg-white {
                margin-left: 0 !important;
                margin-right: 0 !important;
            }

            /* Dashboard cards side-by-side on mobile */
            .dashboard-cards-grid {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 0.75rem !important;
            }

            .dashboard-cards-grid .dashboard-card {
                padding: 0.875rem !important;
            }

            .dashboard-cards-grid .dashboard-card-icon {
                width: 2.5rem !important;
                height: 2.5rem !important;
                font-size: 1.5rem !important;
            }

            .dashboard-cards-grid .dashboard-card-title {
                font-size: 0.875rem !important;
                line-height: 1.2 !important;
            }

            .dashboard-cards-grid .dashboard-card-subtitle {
                display: none !important;
            }

            .dashboard-cards-grid .dashboard-card-arrow {
                font-size: 1.25rem !important;
            }

            /* Optimization results mobile layout */
            .optimization-scores-mobile {
                flex-direction: row !important;
                flex-wrap: wrap !important;
                justify-content: center !important;
                gap: 1rem !important;
            }

            .optimization-scores-mobile .score-gauge {
                transform: scale(0.85);
            }

            .optimization-scores-mobile .improvement-badge {
                width: 100% !important;
                margin-top: 0.5rem !important;
            }

            /* Improve touch targets for Apple HIG compliance */
            button, .google-btn, input, select, .tab-btn {
                min-height: 50px;
                font-size: 17px !important; /* Apple's recommended mobile size */
            }

            .btn-primary {
                padding: 1rem 1.25rem;
                font-size: 1.0625rem !important;
            }

            .btn-secondary {
                padding: 0.875rem 1rem;
                min-height: 48px;
            }

            /* Cards - more padding on mobile */
            .card {
                padding: 1.75rem;
                border-radius: 1rem;
            }

            /* Forms - larger inputs */
            .input-field {
                padding: 1rem 1rem;
                font-size: 17px !important;
                border-radius: 0.75rem;
            }

            /* Tabs - larger on mobile */
            .tabs-container {
                padding: 0.25rem;
                border-radius: 0.875rem;
            }

            .tab-btn {
                padding: 0.75rem 0.5rem;
                font-size: 0.9375rem !important;
            }

            /* Score gauges - smaller on mobile */
            .score-gauge {
                width: 100px;
                height: 100px;
            }

            .score-value {
                font-size: 1.5rem;
            }

            /* Better spacing for mobile lists */
            .space-y-4 > * + * {
                margin-top: 1.25rem;
            }

            /* Full width buttons on mobile */
            .btn-secondary {
                width: 100%;
            }

            /* Hide desktop grid on mobile, show swipe container */
            .desktop-usage-grid {
                display: none !important;
            }
            .mobile-swipe-container {
                display: flex !important;
            }
            .mobile-swipe-dots {
                display: flex !important;
            }
        }

        /* Desktop: Hide swipe container, show carousel (outside mobile media query) */
        @media (min-width: 769px) {
            .mobile-swipe-container {
                display: none !important;
            }
            .mobile-swipe-dots {
                display: none !important;
            }
            .desktop-usage-grid {
                display: none !important;
            }
            .desktop-usage-carousel {
                display: flex !important;
            }
        }

        /* Desktop Usage Carousel - Compact Horizontal Strip */
        .desktop-usage-carousel {
            display: none;
            overflow-x: auto;
            scroll-behavior: smooth;
            gap: 1rem;
            padding: 0.5rem 0;
            margin-bottom: 2rem;
            cursor: grab;
            user-select: none;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.3) transparent;
        }

        .desktop-usage-carousel:active {
            cursor: grabbing;
        }

        .desktop-usage-carousel::-webkit-scrollbar {
            height: 6px;
        }

        .desktop-usage-carousel::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        .desktop-usage-carousel::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }

        .desktop-usage-carousel::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.5);
        }

        .compact-usage-cell {
            flex: 0 0 auto;
            min-width: 180px;
            max-width: 200px;
            background: white;
            border-radius: 1rem;
            padding: 1rem 1.25rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .compact-usage-cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .compact-cell-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .compact-cell-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .compact-cell-info {
            flex: 1;
            min-width: 0;
        }

        .compact-cell-name {
            font-weight: 700;
            font-size: 0.875rem;
            color: #1f2937;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .compact-cell-usage {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .compact-cell-usage strong {
            font-size: 1rem;
            color: #1f2937;
        }

        .compact-cell-bonus {
            color: #10b981;
            font-weight: 700;
        }

        .compact-progress-bar {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .compact-progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .compact-cell-footer {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .compact-cell-footer.exhausted {
            color: #ef4444;
            font-weight: 600;
        }

        .compact-cell-countdown {
            font-weight: 700;
            color: #dc2626;
        }

        /* Small phones (up to 375px) */
        @media (max-width: 375px) {
            html {
                font-size: 16px;
            }

            h1 { font-size: 1.625rem !important; }
            h2 { font-size: 1.375rem !important; }

            .mobile-padding {
                padding: 1.25rem !important;
            }

            .tab-btn {
                padding: 0.625rem 0.375rem;
                font-size: 0.8125rem !important;
            }
        }

        /* ------------------------------------------
           2.11 SAFE AREA (Notched Devices)
           ------------------------------------------ */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(0px, env(safe-area-inset-left));
                padding-right: max(0px, env(safe-area-inset-right));
            }
        }

        /* ------------------------------------------
           2.12 UTILITIES
           ------------------------------------------ */
        .text-truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .scrollable {
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .hidden {
            display: none !important;
        }

        /* Feature Info Collapsible Section */
        .feature-info-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }

        .expanded .feature-info-content {
            max-height: 500px;
            padding-top: 0;
        }

        @media (min-width: 768px) {
            .feature-info-content {
                max-height: none;
                overflow: visible;
            }
        }

        /* Glass morphism effect - OPTIMIZED: removed blur for performance */
        .glass {
            background: rgba(255, 255, 255, 0.15);
            /* REMOVED backdrop-filter for performance */
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Better selection colors */
        ::selection {
            background: rgba(124, 58, 237, 0.3);
            color: inherit;
        }

        /* Large screens - desktop optimizations */
        @media (min-width: 1280px) {
            /* Larger padding for cards on big screens */
            .card {
                padding: 3rem;
            }

            /* More gap in grids */
            .grid {
                gap: 1.5rem;
            }

            /* Wider form elements */
            .max-w-md {
                max-width: 30rem;
            }
        }

        @media (min-width: 1536px) {
            .card {
                padding: 3.5rem;
            }

            .max-w-md {
                max-width: 32rem;
            }
        }

        /* ------------------------------------------
           2.13 VELVET AURORA - Main Page Background
           ------------------------------------------
           A sophisticated animated background inspired by
           premium art galleries at dusk - warm ambient
           lighting mixing with cool shadows.
        */

        /* Base container - fixed behind all content */
        .velvet-aurora {
            position: fixed;
            inset: 0;
            z-index: -1;
            background: linear-gradient(
                145deg,
                #0f1419 0%,
                #121820 30%,
                #0d1117 60%,
                #101418 100%
            );
            overflow: hidden;
        }

        /* Grain texture overlay - editorial premium feel */
        .velvet-aurora::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='grain'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.7' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23grain)'/%3E%3C/svg%3E");
            opacity: 0.03;
            pointer-events: none;
            z-index: 2;
        }

        /* Orbs container */
        .velvet-orbs {
            position: absolute;
            inset: 0;
            overflow: hidden;
            z-index: 1;
        }

        /* Base orb styling - PERFORMANCE OPTIMIZED: No blur, no animations */
        .velvet-orb {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            /* REMOVED will-change - not animating anymore */
            /* REMOVED blur filters - major performance killer */
        }

        /* Warm coral/dusty rose - top-left region (closer/brighter) */
        .velvet-orb-coral {
            width: 70vmax;
            height: 70vmax;
            top: -20%;
            left: -15%;
            background: radial-gradient(
                circle at center,
                rgba(220, 120, 130, 0.35) 0%,
                rgba(200, 100, 110, 0.20) 25%,
                rgba(180, 85, 95, 0.08) 45%,
                transparent 65%
            );
            /* REMOVED: filter: blur(60px); - causes GPU thrashing */
            /* REMOVED: animation - continuous animations kill performance */
        }

        /* Soft amber/gold - accent glow (mid-depth) */
        .velvet-orb-amber {
            width: 55vmax;
            height: 55vmax;
            top: 5%;
            left: 20%;
            background: radial-gradient(
                circle at center,
                rgba(230, 180, 100, 0.30) 0%,
                rgba(215, 160, 85, 0.15) 30%,
                rgba(195, 140, 70, 0.05) 50%,
                transparent 65%
            );
            /* REMOVED: filter: blur(65px); */
            /* REMOVED: animation */
        }

        /* Muted lavender - center blend (mid-depth) */
        .velvet-orb-lavender {
            width: 60vmax;
            height: 60vmax;
            top: 25%;
            left: 30%;
            background: radial-gradient(
                circle at center,
                rgba(170, 140, 200, 0.25) 0%,
                rgba(155, 125, 185, 0.12) 30%,
                rgba(140, 110, 170, 0.05) 50%,
                transparent 65%
            );
            /* REMOVED: filter: blur(70px); */
            /* REMOVED: animation */
        }

        /* Deep teal/cyan - bottom-right region (closer/brighter) */
        .velvet-orb-teal {
            width: 75vmax;
            height: 75vmax;
            bottom: -25%;
            right: -20%;
            background: radial-gradient(
                circle at center,
                rgba(70, 180, 190, 0.35) 0%,
                rgba(55, 160, 170, 0.18) 25%,
                rgba(45, 140, 150, 0.08) 45%,
                transparent 65%
            );
            /* REMOVED: filter: blur(55px); */
            /* REMOVED: animation */
        }

        /* Secondary amber - subtle accent (further/dimmer) */
        .velvet-orb-amber-soft {
            width: 45vmax;
            height: 45vmax;
            bottom: 15%;
            left: 0%;
            background: radial-gradient(
                circle at center,
                rgba(215, 165, 100, 0.20) 0%,
                rgba(195, 145, 85, 0.08) 40%,
                transparent 65%
            );
            /* REMOVED: filter: blur(70px); */
            /* REMOVED: animation */
        }

        /* Secondary teal - distant accent (further/dimmer) */
        .velvet-orb-teal-soft {
            width: 50vmax;
            height: 50vmax;
            top: 0%;
            right: 5%;
            background: radial-gradient(
                circle at center,
                rgba(65, 165, 175, 0.22) 0%,
                rgba(50, 145, 155, 0.10) 35%,
                transparent 60%
            );
            /* REMOVED: filter: blur(65px); */
            /* REMOVED: animation */
        }

        /* DISABLED: Smooth drift animations - caused severe performance issues
        @keyframes velvetDrift1 {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            25% {
                transform: translate(15%, 10%) scale(1.08);
            }
            50% {
                transform: translate(5%, 20%) scale(0.95);
            }
            75% {
                transform: translate(-10%, 12%) scale(1.03);
            }
        }

        @keyframes velvetDrift2 {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            20% {
                transform: translate(-18%, 12%) scale(0.9);
            }
            50% {
                transform: translate(8%, 25%) scale(1.12);
            }
            75% {
                transform: translate(20%, -8%) scale(0.95);
            }
        }

        @keyframes velvetDrift3 {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            33% {
                transform: translate(-15%, -18%) scale(1.15);
            }
            66% {
                transform: translate(18%, 10%) scale(0.88);
            }
        }

        @keyframes velvetDrift4 {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            30% {
                transform: translate(-20%, -15%) scale(1.1);
            }
            65% {
                transform: translate(-8%, 12%) scale(0.92);
            }
        }

        @keyframes velvetDrift5 {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            35% {
                transform: translate(25%, -15%) scale(1.2);
            }
            70% {
                transform: translate(-12%, 20%) scale(0.85);
            }
        }

        @keyframes velvetDrift6 {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            40% {
                transform: translate(-12%, 22%) scale(0.88);
            }
            75% {
                transform: translate(15%, -12%) scale(1.15);
            }
        }
        END OF DISABLED ANIMATIONS */

        /* Accessibility: Respect reduced motion preference - kept for future use */
        @media (prefers-reduced-motion: reduce) {
            .velvet-orb,
            .aurora-orb,
            .living-aurora::before {
                animation: none !important;
            }
        }
    </style>
</head>

<body>
    <!-- ============================================
         VELVET AURORA - Animated Background
         ============================================ -->
    <div class="velvet-aurora" aria-hidden="true">
        <div class="velvet-orbs">
            <!-- Closer/brighter orbs -->
            <div class="velvet-orb velvet-orb-coral"></div>
            <div class="velvet-orb velvet-orb-teal"></div>
            <!-- Mid-depth orbs -->
            <div class="velvet-orb velvet-orb-amber"></div>
            <div class="velvet-orb velvet-orb-lavender"></div>
            <!-- Further/dimmer orbs -->
            <div class="velvet-orb velvet-orb-amber-soft"></div>
            <div class="velvet-orb velvet-orb-teal-soft"></div>
        </div>
    </div>

    <!-- ============================================
         SECTION 3: HTML VIEWS
         ============================================

         All views are rendered dynamically into #app-root
         See render functions in Section 4.5
         ============================================ -->
    <div id="app-root"></div>

    <!-- ============================================
         SECTION 4: SCRIPTS
         ============================================ -->
    <script>
    (function() {
        'use strict';

        /* ==========================================
           4.1 FIREBASE CONFIGURATION
           ========================================== */

        // Check Firebase loaded
        if (typeof firebase === 'undefined') {
            console.error('Firebase SDK not loaded');
            document.getElementById('app-root').innerHTML =
                '<div class="view-container view-centered"><div class="card text-center">' +
                '<h2 class="text-xl font-bold text-red-600 mb-2">Error</h2>' +
                '<p class="text-gray-600">Failed to load Firebase. Please refresh the page.</p></div></div>';
            return;
        }

        // Platform Version
        const PLATFORM_VERSION = '1.0.3';

        // Firebase project configuration
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAGczY5ZEIJdTq25BpQdia3lv2I556wOZo",
            authDomain: "ytseo-6d1b0.firebaseapp.com",
            projectId: "ytseo-6d1b0",
            storageBucket: "ytseo-6d1b0.firebasestorage.app",
            messagingSenderId: "382790048044",
            appId: "1:382790048044:web:cd427679ff72108c1f3489"
        };

        // Initialize Firebase
        firebase.initializeApp(FIREBASE_CONFIG);
        const auth = firebase.auth();
        const functions = firebase.functions();
        const db = firebase.firestore();

        // Real-time notification listener unsubscribe function
        let notificationUnsubscribe = null;

        /* ==========================================
           4.2 APPLICATION STATE
           ========================================== */

        const state = {
            // Current view: initializing | login | register | forgot-password | dashboard | optimizer | results | history | admin | competitor | trends | thumbnail
            currentView: 'initializing',

            // App initialization state
            initializing: true,

            // User data
            user: null,
            profile: null,
            isAdmin: false,

            // UI state
            loading: false,
            error: null,
            success: null,

            // Loading progress state
            loadingProgress: 0,
            loadingStep: 0,
            loadingSteps: [
                { name: 'Fetching video data', icon: '' },
                { name: 'Analyzing content', icon: '' },
                { name: 'Generating titles', icon: '' },
                { name: 'Writing description', icon: '' },
                { name: 'Creating tags', icon: '' },
                { name: 'Calculating SEO score', icon: '' }
            ],
            loadingInterval: null,

            // Results page
            currentResults: null,    // Current optimization results
            resultsTab: 'titles',    // Current tab: titles | description | tags

            // History/Admin data
            historyData: null,       // List of past optimizations
            historyTab: 'all',       // Current history tab: 'all', 'optimization', 'competitor', 'trend', 'thumbnail', 'placement'
            allHistory: null,        // Combined history from all types
            competitorHistory: null, // Competitor analysis history
            trendHistory: null,      // Trend predictor history
            thumbnailHistory: null,  // Thumbnail history
            placementHistory: null,  // Placement Finder history
            historyCounts: null,     // Counts for each history type
            adminUsers: null,        // Admin user list
            adminLoading: false,

            // New features state
            competitorResults: null,  // Competitor analysis results
            trendResults: null,       // Trend prediction results
            thumbnailJob: null,       // Thumbnail generation job
            thumbnailStatus: null,    // Thumbnail job status
            thumbnailImage: null,     // Generated thumbnail URL

            // Channel Audit Pro state
            channelAuditResults: null,  // Channel audit results
            channelAuditLoading: false, // Loading state for channel audit
            channelAuditHistory: null,  // Channel audit history

            // Thumbnail from optimizer context
            lastOptimization: null,   // Last optimization results for thumbnail context
            thumbnailStyle: 'professional', // professional | dramatic | minimal | bold
            thumbnailFromOptimizer: false,   // Flag if user came from optimizer results

            // Quota settings (from getUserProfile)
            quotaInfo: null,           // Quota info for each tool with reset times
            resetTimeMinutes: 1440,    // Admin-configured reset time in minutes
            countdownInterval: null,    // Interval for countdown timer

            // Admin settings
            adminQuotaSettings: null,   // For admin panel
            adminSelectedUser: null,    // Selected user for bonus uses

            // Bonus history
            bonusHistory: null,         // User's bonus history
            showBonusHistory: false,    // Modal visibility

            // Campaign Reports (Admin feature)
            campaignReports: null,       // List of all reports (admin view)
            clientReports: null,         // Reports for current user
            currentReport: null,         // Report being viewed/edited
            reportImages: [],            // Images for new report
            reportAnalysis: null,        // AI analysis result
            reportLoading: false,        // Loading state for report operations
            editingReport: null,         // Report being edited

            // Notifications
            notifications: [],           // User's notifications
            unreadCount: 0,              // Unread notification count
            showNotifications: false,    // Notification dropdown visibility

            // Report modals
            sendModalReportId: null,     // Report ID for send modal

            // Lightbox state
            lightboxOpen: false,         // Is lightbox open
            lightboxImages: [],          // Array of image URLs
            lightboxIndex: 0             // Current image index
        };

        /* ==========================================
           4.2.5 TIME-AWARE AURORA COLOR SYSTEM
           ========================================== */

        // Get time-based aurora theme class
        function getAuroraTimeClass() {
            var hour = new Date().getHours();

            // Morning: 6am-12pm (warm, energetic)
            if (hour >= 6 && hour < 12) {
                return 'aurora-morning';
            }
            // Afternoon: 12pm-6pm (productive, green)
            else if (hour >= 12 && hour < 18) {
                return 'aurora-afternoon';
            }
            // Evening: 6pm-9pm (sunset, warm)
            else if (hour >= 18 && hour < 21) {
                return 'aurora-evening';
            }
            // Night: 9pm-6am (calm, purple)
            else {
                return 'aurora-night';
            }
        }

        // Update all aurora elements with time-aware theme
        function updateAuroraTheme() {
            var auroraElements = document.querySelectorAll('.living-aurora');
            var timeClass = getAuroraTimeClass();

            auroraElements.forEach(function(el) {
                // Remove existing time classes
                el.classList.remove('aurora-morning', 'aurora-afternoon', 'aurora-evening', 'aurora-night');

                // Only add time class if element doesn't have a specific theme
                if (!el.classList.contains('aurora-emerald') && !el.classList.contains('aurora-gold') && !el.classList.contains('aurora-creative')) {
                    el.classList.add(timeClass);
                }
            });
        }

        // Schedule aurora theme updates (every hour)
        function scheduleAuroraUpdates() {
            // Update immediately
            updateAuroraTheme();

            // Calculate time until next hour
            var now = new Date();
            var msUntilNextHour = (60 - now.getMinutes()) * 60 * 1000 - now.getSeconds() * 1000;

            // Update at the top of each hour
            setTimeout(function() {
                updateAuroraTheme();
                // Then set regular hourly interval
                setInterval(updateAuroraTheme, 60 * 60 * 1000);
            }, msUntilNextHour);
        }

        // Initialize aurora theme on load
        scheduleAuroraUpdates();

        // Loading progress simulation - OPTIMIZED to prevent flickering
        // Adjusted timing to match ~90 second RunPod processing time
        function startLoadingProgress() {
            state.loadingProgress = 0;
            state.loadingStep = 0;

            if (state.loadingInterval) {
                clearInterval(state.loadingInterval);
            }

            state.loadingInterval = setInterval(function() {
                if (state.loadingProgress < 95) {
                    // Simulate realistic progress with slower speeds to match ~90s RunPod processing
                    // 0-30%: Initial analysis (fast) - ~10 seconds
                    // 30-60%: AI prompt creation (medium) - ~15 seconds
                    // 60-85%: Image generation (slow) - ~45 seconds (main RunPod work)
                    // 85-95%: Rendering HD (very slow) - ~20 seconds
                    var increment;
                    if (state.loadingProgress < 30) {
                        increment = Math.random() * 2 + 1; // Fast start: 1-3%
                    } else if (state.loadingProgress < 60) {
                        increment = Math.random() * 1.2 + 0.3; // Medium: 0.3-1.5%
                    } else if (state.loadingProgress < 85) {
                        increment = Math.random() * 0.4 + 0.1; // Slow: 0.1-0.5%
                    } else {
                        increment = Math.random() * 0.2 + 0.05; // Very slow: 0.05-0.25%
                    }

                    state.loadingProgress = Math.min(95, state.loadingProgress + increment);

                    // Update current step based on progress (4 steps to match UI)
                    if (state.loadingProgress < 25) state.loadingStep = 0;      // Analyzing video context
                    else if (state.loadingProgress < 50) state.loadingStep = 1; // Creating AI prompt
                    else if (state.loadingProgress < 80) state.loadingStep = 2; // Generating image
                    else state.loadingStep = 3;                                  // Rendering HD

                    // OPTIMIZED: Only update specific elements instead of full render
                    updateLoadingUI();
                }
            }, 1000); // Increased interval from 500ms to 1000ms for slower progress
        }

        // Targeted loading UI update to prevent flickering
        function updateLoadingUI() {
            // Update percentage display
            var percentEls = document.querySelectorAll('.progress-percentage');
            percentEls.forEach(function(el) {
                el.textContent = Math.round(state.loadingProgress) + '%';
            });

            // Update progress bar
            var barEls = document.querySelectorAll('.progress-bar-fill');
            barEls.forEach(function(el) {
                el.style.width = state.loadingProgress + '%';
            });

            // Update step icons
            var stepEls = document.querySelectorAll('.loading-step');
            stepEls.forEach(function(el, index) {
                var iconEl = el.querySelector('.step-icon');
                if (index < state.loadingStep) {
                    el.className = 'loading-step completed';
                    if (iconEl) {
                        iconEl.className = 'step-icon completed';
                        iconEl.textContent = '';
                    }
                } else if (index === state.loadingStep) {
                    el.className = 'loading-step active';
                    if (iconEl) {
                        iconEl.className = 'step-icon active';
                    }
                }
            });
        }

        function stopLoadingProgress() {
            if (state.loadingInterval) {
                clearInterval(state.loadingInterval);
                state.loadingInterval = null;
            }
            state.loadingProgress = 100;
            state.loadingStep = state.loadingSteps.length - 1;
        }

        // Countdown timer for quota reset - OPTIMIZED
        var cachedCountdownElements = null;

        function startCountdownTimer() {
            if (state.countdownInterval) {
                clearInterval(state.countdownInterval);
            }
            // Clear cache when starting new timer
            cachedCountdownElements = null;
            state.countdownInterval = setInterval(function() {
                updateCountdownDisplays();
            }, 1000);
        }

        function updateCountdownDisplays() {
            // Cache DOM elements - only query once per view
            if (!cachedCountdownElements) {
                cachedCountdownElements = document.querySelectorAll('.quota-countdown');
            }
            // If no countdown elements, clear interval to save resources
            if (!cachedCountdownElements || cachedCountdownElements.length === 0) {
                return;
            }
            var now = Date.now();
            cachedCountdownElements.forEach(function(el) {
                var resetAt = parseInt(el.getAttribute('data-reset-at'));
                if (resetAt) {
                    var remaining = Math.max(0, resetAt - now);
                    if (remaining > 0) {
                        var hours = Math.floor(remaining / 3600000);
                        var minutes = Math.floor((remaining % 3600000) / 60000);
                        var seconds = Math.floor((remaining % 60000) / 1000);
                        var timeStr = '';
                        if (hours > 0) timeStr += hours + 'h ';
                        if (minutes > 0 || hours > 0) timeStr += minutes + 'm ';
                        timeStr += seconds + 's';
                        el.textContent = timeStr;
                    } else {
                        el.textContent = 'Ready!';
                        el.classList.add('text-green-500');
                    }
                }
            });
        }

        function formatCountdown(ms) {
            if (ms <= 0) return 'Ready!';
            var hours = Math.floor(ms / 3600000);
            var minutes = Math.floor((ms % 3600000) / 60000);
            var seconds = Math.floor((ms % 60000) / 1000);
            var parts = [];
            if (hours > 0) parts.push(hours + 'h');
            if (minutes > 0 || hours > 0) parts.push(minutes + 'm');
            parts.push(seconds + 's');
            return parts.join(' ');
        }

        /* ==========================================
           4.3 UTILITY FUNCTIONS
           ========================================== */

        const utils = {
            /**
             * Format large numbers (e.g., 1500000 -> 1.5M)
             */
            formatNumber: function(n) {
                if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
                if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
                return String(n);
            },

            /**
             * Calculate usage percentage
             */
            getUsagePercent: function(used, limit) {
                return Math.min(100, Math.round((used / limit) * 100));
            },

            /**
             * Get color class based on usage percentage
             */
            getUsageColor: function(percent) {
                if (percent >= 80) return 'bg-red-500';
                if (percent >= 60) return 'bg-yellow-500';
                return 'bg-green-500';
            },

            /**
             * Validate email format
             */
            validateEmail: function(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            },

            /**
             * Escape HTML special characters
             */
            escapeHtml: function(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            /**
             * Escape string for use in JavaScript
             */
            escapeJs: function(text) {
                return String(text)
                    .replace(/\\/g, '\\\\')
                    .replace(/'/g, "\\'")
                    .replace(/"/g, '\\"')
                    .replace(/\n/g, '\\n')
                    .replace(/\r/g, '\\r');
            },

            /**
             * Format date for display
             */
            formatDate: function(timestamp) {
                const date = new Date(timestamp);
                return {
                    date: date.toLocaleDateString(),
                    time: date.toLocaleTimeString()
                };
            }
        };

        /* ==========================================
           4.4 AUTH & API FUNCTIONS
           ========================================== */

        // Start real-time notification listener
        function startNotificationListener(userId) {
            // Stop any existing listener
            stopNotificationListener();

            // Listen for unread notifications in real-time
            notificationUnsubscribe = db.collection('userNotifications')
                .where('userId', '==', userId)
                .where('isRead', '==', false)
                .orderBy('createdAt', 'desc')
                .limit(20)
                .onSnapshot(function(snapshot) {
                    var previousCount = state.unreadCount;
                    var notifications = [];

                    snapshot.forEach(function(doc) {
                        var data = doc.data();
                        notifications.push({
                            id: doc.id,
                            type: data.type,
                            reportId: data.reportId,
                            title: data.title,
                            message: data.message,
                            isRead: data.isRead,
                            createdAt: data.createdAt ? (data.createdAt.toDate ? data.createdAt.toDate().toISOString() : data.createdAt) : null
                        });
                    });

                    state.notifications = notifications;
                    state.unreadCount = notifications.length;

                    // If new notifications arrived, trigger attention animation
                    if (notifications.length > previousCount && previousCount >= 0) {
                        triggerNotificationAttention();
                    }

                    // OPTIMIZATION: Only update notification badge, NOT full render
                    // This prevents flickering caused by full DOM replacement
                    updateNotificationBadge(previousCount, notifications.length);
                }, function(error) {
                    console.error('Notification listener error:', error);
                });
        }

        // Stop real-time notification listener
        function stopNotificationListener() {
            if (notificationUnsubscribe) {
                notificationUnsubscribe();
                notificationUnsubscribe = null;
            }
        }

        // Trigger attention animation for new notifications
        function triggerNotificationAttention() {
            var badge = document.querySelector('.notification-badge');
            if (badge) {
                badge.classList.add('notification-new');
                setTimeout(function() {
                    badge.classList.remove('notification-new');
                }, 3000);
            }
        }

        // OPTIMIZATION: Update notification badge without full render
        // This prevents flickering by doing targeted DOM updates
        function updateNotificationBadge(previousCount, newCount) {
            // Only update if count actually changed
            if (previousCount === newCount) return;

            // Update notification badge in header
            var badge = document.querySelector('.notification-badge');
            if (badge) {
                if (newCount > 0) {
                    badge.textContent = newCount > 99 ? '99+' : newCount;
                    badge.style.display = '';
                } else {
                    badge.style.display = 'none';
                }
            }

            // Update unread count on dashboard card
            var dashboardBadge = document.querySelector('.dashboard-card .notification-dot');
            if (dashboardBadge) {
                var countSpan = dashboardBadge.parentElement.querySelector('span:last-child');
                if (countSpan && newCount > 0) {
                    countSpan.textContent = newCount;
                }
            }
        }

        // Auth state listener
        auth.onAuthStateChanged(async function(user) {
            var wasInitializing = state.initializing;
            state.initializing = false;

            if (user) {
                state.user = user;
                try {
                    const result = await functions.httpsCallable('getUserProfile')();
                    state.profile = result.data.profile;
                    state.quotaInfo = result.data.quotaInfo || null;
                    state.resetTimeMinutes = result.data.resetTimeMinutes || 1440;
                    // Check admin status
                    state.isAdmin = state.profile.isAdmin === true;
                    // Start countdown timer if on dashboard
                    startCountdownTimer();
                    // Start real-time notification listener
                    startNotificationListener(user.uid);
                    // Redirect to dashboard if coming from initializing, login, or register
                    if (wasInitializing || state.currentView === 'login' || state.currentView === 'register' || state.currentView === 'initializing') {
                        state.currentView = 'dashboard';
                    }
                    render();
                } catch (e) {
                    state.error = 'Failed to load profile';
                    state.currentView = 'login';
                    render();
                }
            } else {
                // Stop notification listener on logout
                stopNotificationListener();
                state.user = null;
                state.profile = null;
                state.isAdmin = false;
                state.notifications = [];
                state.unreadCount = 0;
                if (state.currentView !== 'register' && state.currentView !== 'forgot-password') {
                    state.currentView = 'login';
                }
                render();
            }
        });

        /* ==========================================
           4.5 APP ACTIONS (Global)
           ========================================== */

        window.app = {

            /* ------------------------------------------
               4.5.1 Navigation Actions
               ------------------------------------------ */

            goToLogin: function() {
                state.currentView = 'login';
                state.error = null;
                state.success = null;
                render();
            },

            goToRegister: function() {
                state.currentView = 'register';
                state.error = null;
                state.success = null;
                render();
            },

            goToForgotPassword: function() {
                state.currentView = 'forgot-password';
                state.error = null;
                state.success = null;
                render();
            },

            goToDashboard: function(skipRefresh) {
                state.currentView = 'dashboard';
                state.error = null;
                state.showNotifications = false;
                render();

                // Refresh profile data unless explicitly skipped
                if (!skipRefresh && state.user) {
                    functions.httpsCallable('getUserProfile')()
                        .then(function(result) {
                            state.profile = result.data.profile;
                            state.quotaInfo = result.data.quotaInfo || null;
                            state.resetTimeMinutes = result.data.resetTimeMinutes || 1440;
                            state.isAdmin = state.profile.isAdmin === true;
                            startCountdownTimer();
                            render();
                        })
                        .catch(function(e) {
                            // Silently fail - keep showing cached data
                            console.warn('Failed to refresh profile:', e);
                        });

                    // Load notifications
                    this.loadNotifications();
                }
            },

            goToOptimizer: function() {
                state.currentView = 'optimizer';
                state.error = null;
                render();
            },

            goToResults: function() {
                state.currentView = 'results';
                state.error = null;
                render();
            },

            goToHistory: function(tab) {
                state.currentView = 'history';
                state.error = null;
                state.loading = true;
                state.historyTab = tab || 'all';
                state.allHistory = null;
                state.historyData = null;
                state.competitorHistory = null;
                state.trendHistory = null;
                state.thumbnailHistory = null;
                state.placementHistory = null;
                state.channelAuditHistory = null;
                state.historyCounts = null;
                render();

                // Fetch all history from backend
                functions.httpsCallable('getAllHistory')({ limit: 20 })
                    .then(function(result) {
                        var data = result.data;
                        state.allHistory = data.history.all || [];
                        state.historyData = data.history.optimizations || [];
                        state.competitorHistory = data.history.competitor || [];
                        state.trendHistory = data.history.trends || [];
                        state.thumbnailHistory = data.history.thumbnails || [];
                        state.placementHistory = data.history.placements || [];
                        state.channelAuditHistory = data.history.channelAudit || [];
                        state.historyCounts = data.counts || {};
                        state.loading = false;
                        render();
                    })
                    .catch(function(e) {
                        state.loading = false;
                        state.error = 'Failed to load history';
                        render();
                    });
            },

            setHistoryTab: function(tab) {
                state.historyTab = tab;
                render();
            },

            goToCompetitor: function() {
                state.currentView = 'competitor';
                state.error = null;
                state.competitorResults = null;
                render();
            },

            goToTrends: function() {
                state.currentView = 'trends';
                state.error = null;
                state.trendResults = null;
                render();
            },

            goToThumbnail: function(fromOptimizer) {
                state.currentView = 'thumbnail';
                state.error = null;
                state.thumbnailJob = null;
                state.thumbnailStatus = null;
                state.thumbnailImage = null;
                state.thumbnailFromOptimizer = fromOptimizer === true;
                render();
            },

            goToPlacement: function() {
                state.currentView = 'placement';
                state.error = null;
                state.placementResults = null;
                state.placementLoading = false;
                render();
            },

            goToChannelAudit: function() {
                state.currentView = 'channelAudit';
                state.error = null;
                state.channelAuditResults = null;
                state.channelAuditLoading = false;
                render();
            },

            runChannelAudit: function(e) {
                e.preventDefault();
                var channelUrl = document.getElementById('audit-channel-url').value.trim();

                if (!channelUrl) {
                    state.error = { message: 'Please enter a YouTube channel URL' };
                    render();
                    return;
                }

                state.channelAuditLoading = true;
                state.loading = true;
                state.error = null;
                state.loadingSteps = [
                    { name: 'Fetching channel data', icon: '' },
                    { name: 'Analyzing content strategy', icon: '' },
                    { name: 'Evaluating SEO health', icon: '' },
                    { name: 'Checking engagement metrics', icon: '' },
                    { name: 'Identifying growth opportunities', icon: '' },
                    { name: 'Generating recommendations', icon: '' }
                ];
                startLoadingProgress();
                render();

                functions.httpsCallable('auditChannel')({ channelUrl: channelUrl })
                    .then(function(result) {
                        stopLoadingProgress();
                        state.channelAuditResults = result.data;
                        state.channelAuditLoading = false;
                        state.loading = false;
                        render();
                    })
                    .catch(function(e) {
                        stopLoadingProgress();
                        state.channelAuditLoading = false;
                        state.loading = false;
                        state.error = { message: 'Failed to audit channel: ' + e.message };
                        render();
                    });
            },

            viewPlacementHistory: function(id) {
                // Find the item from history
                var item = (state.allHistory || []).find(function(h) { return h.id === id && h.type === 'placement'; });
                if (!item && state.placementHistory) {
                    item = state.placementHistory.find(function(h) { return h.id === id; });
                }
                if (item) {
                    state.placementResults = {
                        historyId: item.id,
                        channelInfo: item.channelInfo,
                        analysis: item.analysis,
                        placements: item.placements || [],
                        totalFound: item.totalFound || 0,
                        maxAllowed: 50
                    };
                    state.currentView = 'placement';
                    render();
                }
            },

            viewChannelAuditHistory: function(id) {
                // Find the item from history
                var item = (state.allHistory || []).find(function(h) { return h.id === id && h.type === 'channelAudit'; });
                if (!item && state.channelAuditHistory) {
                    item = state.channelAuditHistory.find(function(h) { return h.id === id; });
                }
                if (item) {
                    state.channelAuditResults = {
                        historyId: item.id,
                        channelInfo: item.channelInfo,
                        scores: item.scores,
                        analysis: item.analysis,
                        recommendations: item.recommendations,
                        metrics: item.metrics
                    };
                    state.currentView = 'channelAudit';
                    render();
                }
            },

            // Bonus history modal functions
            openBonusHistory: function() {
                state.showBonusHistory = true;
                state.bonusHistory = null;
                render();

                // Fetch bonus history from backend
                functions.httpsCallable('getBonusHistory')()
                    .then(function(result) {
                        state.bonusHistory = result.data.history || [];
                        render();
                    })
                    .catch(function(e) {
                        state.bonusHistory = [];
                        state.error = { message: 'Failed to load bonus history' };
                        render();
                    });
            },

            closeBonusHistory: function() {
                state.showBonusHistory = false;
                render();
            },

            // Scroll to specific usage card (mobile swipe)
            scrollToUsageCard: function(index) {
                var container = document.getElementById('usageSwipeContainer');
                if (container) {
                    var cards = container.querySelectorAll('.mobile-swipe-card');
                    if (cards[index]) {
                        cards[index].scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                    }
                }
            },

            // Initialize swipe dots listener
            initSwipeDots: function() {
                var container = document.getElementById('usageSwipeContainer');
                var dotsContainer = document.getElementById('usageSwipeDots');
                if (container && dotsContainer) {
                    container.addEventListener('scroll', function() {
                        var cards = container.querySelectorAll('.mobile-swipe-card');
                        var containerRect = container.getBoundingClientRect();
                        var containerCenter = containerRect.left + containerRect.width / 2;

                        var closestIndex = 0;
                        var closestDistance = Infinity;

                        cards.forEach(function(card, index) {
                            var cardRect = card.getBoundingClientRect();
                            var cardCenter = cardRect.left + cardRect.width / 2;
                            var distance = Math.abs(containerCenter - cardCenter);

                            if (distance < closestDistance) {
                                closestDistance = distance;
                                closestIndex = index;
                            }
                        });

                        var dots = dotsContainer.querySelectorAll('.mobile-swipe-dot');
                        dots.forEach(function(dot, index) {
                            if (index === closestIndex) {
                                dot.classList.add('active');
                            } else {
                                dot.classList.remove('active');
                            }
                        });
                    });
                }
            },

            // Initialize desktop carousel drag-to-scroll
            initDesktopCarousel: function() {
                var carousel = document.getElementById('desktopUsageCarousel');
                if (!carousel) return;

                var isDown = false;
                var startX;
                var scrollLeft;

                carousel.addEventListener('mousedown', function(e) {
                    isDown = true;
                    carousel.classList.add('active');
                    startX = e.pageX - carousel.offsetLeft;
                    scrollLeft = carousel.scrollLeft;
                    e.preventDefault();
                });

                carousel.addEventListener('mouseleave', function() {
                    isDown = false;
                    carousel.classList.remove('active');
                });

                carousel.addEventListener('mouseup', function() {
                    isDown = false;
                    carousel.classList.remove('active');
                });

                carousel.addEventListener('mousemove', function(e) {
                    if (!isDown) return;
                    e.preventDefault();
                    var x = e.pageX - carousel.offsetLeft;
                    var walk = (x - startX) * 1.5; // Scroll speed multiplier
                    carousel.scrollLeft = scrollLeft - walk;
                });

                // Touch support for hybrid devices
                carousel.addEventListener('touchstart', function(e) {
                    startX = e.touches[0].pageX - carousel.offsetLeft;
                    scrollLeft = carousel.scrollLeft;
                }, { passive: true });

                carousel.addEventListener('touchmove', function(e) {
                    var x = e.touches[0].pageX - carousel.offsetLeft;
                    var walk = (x - startX) * 1.5;
                    carousel.scrollLeft = scrollLeft - walk;
                }, { passive: true });
            },

            /* ------------------------------------------
               4.5.2 Authentication Actions
               ------------------------------------------ */

            signInWithGoogle: function() {
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.setCustomParameters({
                    prompt: 'select_account'
                });

                state.loading = true;
                render();

                auth.signInWithPopup(provider)
                    .then(function(result) {
                        state.loading = false;
                    })
                    .catch(function(error) {
                        state.loading = false;
                        state.error = 'Google sign-in failed. Please try again.';
                        render();
                    });
            },

            register: function(e) {
                e.preventDefault();
                const email = document.getElementById('register-email').value.trim();
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;

                state.error = null;

                // Validation
                if (!utils.validateEmail(email)) {
                    state.error = 'Please enter a valid email address';
                    render();
                    return;
                }

                if (password.length < 6) {
                    state.error = 'Password must be at least 6 characters';
                    render();
                    return;
                }

                if (password !== confirmPassword) {
                    state.error = 'Passwords do not match';
                    render();
                    return;
                }

                state.loading = true;
                render();

                auth.createUserWithEmailAndPassword(email, password)
                    .then(function(result) {
                        state.loading = false;
                    })
                    .catch(function(error) {
                        state.loading = false;

                        switch (error.code) {
                            case 'auth/email-already-in-use':
                                state.error = 'This email is already registered. Please sign in.';
                                break;
                            case 'auth/invalid-email':
                                state.error = 'Invalid email address';
                                break;
                            case 'auth/weak-password':
                                state.error = 'Password is too weak';
                                break;
                            default:
                                state.error = 'Registration failed: ' + error.message;
                        }
                        render();
                    });
            },

            signIn: function(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value.trim();
                const password = document.getElementById('login-password').value;

                state.error = null;

                if (!email || !password) {
                    state.error = 'Please enter email and password';
                    render();
                    return;
                }

                state.loading = true;
                render();

                auth.signInWithEmailAndPassword(email, password)
                    .then(function(result) {
                        state.loading = false;
                    })
                    .catch(function(error) {
                        state.loading = false;

                        switch (error.code) {
                            case 'auth/user-not-found':
                            case 'auth/wrong-password':
                                state.error = 'Invalid email or password';
                                break;
                            case 'auth/invalid-email':
                                state.error = 'Invalid email address';
                                break;
                            case 'auth/user-disabled':
                                state.error = 'This account has been disabled';
                                break;
                            default:
                                state.error = 'Sign in failed: ' + error.message;
                        }
                        render();
                    });
            },

            resetPassword: function(e) {
                e.preventDefault();
                const email = document.getElementById('reset-email').value.trim();

                state.error = null;
                state.success = null;

                if (!utils.validateEmail(email)) {
                    state.error = 'Please enter a valid email address';
                    render();
                    return;
                }

                state.loading = true;
                render();

                auth.sendPasswordResetEmail(email)
                    .then(function() {
                        state.loading = false;
                        state.success = 'Password reset email sent! Check your inbox.';
                        render();
                    })
                    .catch(function(error) {
                        state.loading = false;

                        switch (error.code) {
                            case 'auth/user-not-found':
                                state.error = 'No account found with this email';
                                break;
                            case 'auth/invalid-email':
                                state.error = 'Invalid email address';
                                break;
                            default:
                                state.error = 'Failed to send reset email: ' + error.message;
                        }
                        render();
                    });
            },

            signOut: function() {
                auth.signOut();
            },

            /* ------------------------------------------
               4.5.3 Optimizer Actions
               ------------------------------------------ */

            optimize: function(e) {
                e.preventDefault();
                const url = document.getElementById('video-url').value.trim();

                if (!url) {
                    state.error = { message: 'Please enter a video URL', type: 'validation' };
                    render();
                    return;
                }

                // Validate URL format
                if (!url.includes('youtube.com') && !url.includes('youtu.be')) {
                    state.error = { message: 'Please enter a valid YouTube URL', type: 'validation' };
                    render();
                    return;
                }

                state.loading = true;
                state.error = null;
                startLoadingProgress();
                render();

                functions.httpsCallable('optimizeVideo')({ videoUrl: url })
                    .then(function(result) {
                        stopLoadingProgress();
                        state.currentResults = result.data;
                        state.lastOptimization = result.data; // Save for thumbnail generator
                        state.loading = false;
                        state.currentView = 'results';
                        return functions.httpsCallable('getUserProfile')();
                    })
                    .then(function(result) {
                        state.profile = result.data.profile;
                        render();
                    })
                    .catch(function(e) {
                        stopLoadingProgress();
                        state.loading = false;

                        // Parse Firebase error for detailed message
                        var errorMessage = 'Optimization failed. Please try again.';
                        var errorDetails = null;
                        var errorType = 'unknown';

                        if (e.code) {
                            errorType = e.code;

                            // Map Firebase error codes to user-friendly messages
                            switch (e.code) {
                                case 'functions/internal':
                                    // Check the error message for more specific issues
                                    if (e.message && e.message.includes('API')) {
                                        errorMessage = 'YouTube API error. The API may not be enabled.';
                                        errorDetails = 'Admin: Enable YouTube Data API v3 in Google Cloud Console';
                                    } else if (e.message && e.message.includes('quota')) {
                                        errorMessage = 'API quota exceeded. Please try again later.';
                                    } else {
                                        errorMessage = 'Server error occurred.';
                                        errorDetails = e.message || 'No additional details available';
                                    }
                                    break;
                                case 'functions/failed-precondition':
                                    // API not enabled or configured
                                    errorMessage = e.message || 'Service not properly configured.';
                                    if (e.message && e.message.includes('YouTube API')) {
                                        errorDetails = 'Go to Google Cloud Console  APIs & Services  Enable YouTube Data API v3';
                                    } else if (e.message && e.message.includes('API key')) {
                                        errorDetails = 'Check Firebase Functions config: firebase functions:config:set youtube.key="YOUR_KEY"';
                                    }
                                    break;
                                case 'functions/unauthenticated':
                                    errorMessage = 'You must be logged in to optimize videos.';
                                    break;
                                case 'functions/resource-exhausted':
                                    if (e.message && e.message.includes('quota')) {
                                        errorMessage = 'YouTube API quota exceeded. Please try again later.';
                                        errorDetails = 'The daily API limit has been reached. Try again tomorrow.';
                                    } else {
                                        errorMessage = 'Daily limit reached. Please upgrade your plan or try again tomorrow.';
                                        errorDetails = e.message;
                                    }
                                    break;
                                case 'functions/invalid-argument':
                                    errorMessage = 'Invalid video URL. Please check and try again.';
                                    break;
                                case 'functions/not-found':
                                    errorMessage = e.message || 'Video not found. Please check the URL.';
                                    break;
                                case 'functions/permission-denied':
                                    errorMessage = 'Access denied. Please check your subscription.';
                                    break;
                                case 'functions/unavailable':
                                    errorMessage = 'Service temporarily unavailable. Please try again.';
                                    break;
                                default:
                                    errorMessage = e.message || 'An unexpected error occurred.';
                            }
                        } else if (e.message) {
                            errorMessage = e.message;
                        }

                        state.error = {
                            message: errorMessage,
                            details: errorDetails,
                            code: e.code || 'unknown',
                            type: errorType,
                            raw: e.message // For debugging
                        };
                        render();
                    });
            },

            /* ------------------------------------------
               4.5.4 Utility Actions
               ------------------------------------------ */

            copyToClipboard: function(text, buttonId) {
                const showSuccess = function(btn) {
                    if (!btn) return;
                    const originalText = btn.innerHTML;
                    btn.innerHTML = ' Copied!';
                    btn.classList.add('bg-green-500');
                    setTimeout(function() {
                        btn.innerHTML = originalText;
                        btn.classList.remove('bg-green-500');
                    }, 2000);
                };

                const btn = document.getElementById(buttonId);

                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).then(function() {
                        showSuccess(btn);
                    });
                } else {
                    // Fallback for older browsers
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        showSuccess(btn);
                    } catch (err) {
                        alert('Copy failed. Please copy manually.');
                    }
                    document.body.removeChild(textarea);
                }
            },

            viewHistoryItem: function(index, id) {
                var item = null;
                if (id) {
                    // Find by ID (from "all" tab)
                    item = (state.allHistory || []).find(function(h) { return h.id === id && h.type === 'optimization'; });
                    if (!item) item = (state.historyData || []).find(function(h) { return h.id === id; });
                } else if (state.historyData && state.historyData[index]) {
                    item = state.historyData[index];
                }
                if (item) {
                    state.currentResults = item;
                    state.lastOptimization = item; // For thumbnail generator
                    state.currentView = 'results';
                    render();
                }
            },

            viewCompetitorHistory: function(index, id) {
                var item = null;
                if (id) {
                    item = (state.allHistory || []).find(function(h) { return h.id === id && h.type === 'competitor'; });
                    if (!item) item = (state.competitorHistory || []).find(function(h) { return h.id === id; });
                } else if (state.competitorHistory && state.competitorHistory[index]) {
                    item = state.competitorHistory[index];
                }
                if (item) {
                    state.competitorResults = item;
                    state.currentView = 'competitor';
                    render();
                }
            },

            viewTrendHistory: function(index, id) {
                var item = null;
                if (id) {
                    item = (state.allHistory || []).find(function(h) { return h.id === id && h.type === 'trend'; });
                    if (!item) item = (state.trendHistory || []).find(function(h) { return h.id === id; });
                } else if (state.trendHistory && state.trendHistory[index]) {
                    item = state.trendHistory[index];
                }
                if (item) {
                    state.trendResults = item;
                    state.currentView = 'trends';
                    render();
                }
            },

            viewThumbnailHistory: function(index, id) {
                var item = null;
                if (id) {
                    item = (state.allHistory || []).find(function(h) { return h.id === id && h.type === 'thumbnail'; });
                    if (!item) item = (state.thumbnailHistory || []).find(function(h) { return h.id === id; });
                } else if (state.thumbnailHistory && state.thumbnailHistory[index]) {
                    item = state.thumbnailHistory[index];
                }
                if (item) {
                    state.thumbnailImage = item.imageUrl;
                    state.thumbnailJob = { id: item.jobId };
                    state.thumbnailStatus = item.status;
                    state.currentView = 'thumbnail';
                    render();
                }
            },

            deleteHistoryItem: function(type, id, index) {
                if (!confirm('Are you sure you want to delete this item?')) return;

                var functionName;
                switch(type) {
                    case 'optimization': functionName = 'deleteOptimization'; break;
                    case 'competitor': functionName = 'deleteCompetitorAnalysis'; break;
                    case 'trend': functionName = 'deleteTrendPrediction'; break;
                    case 'thumbnail': functionName = 'deleteThumbnail'; break;
                    case 'placement': functionName = 'deletePlacementFinder'; break;
                    case 'channelAudit': functionName = 'deleteChannelAudit'; break;
                    default: return;
                }

                state.loading = true;
                render();

                functions.httpsCallable(functionName)({ id: id })
                    .then(function(result) {
                        // Remove from local state
                        switch(type) {
                            case 'optimization':
                                state.historyData.splice(index, 1);
                                state.historyCounts.optimizations--;
                                break;
                            case 'competitor':
                                state.competitorHistory.splice(index, 1);
                                state.historyCounts.competitor--;
                                break;
                            case 'trend':
                                state.trendHistory.splice(index, 1);
                                state.historyCounts.trends--;
                                break;
                            case 'thumbnail':
                                state.thumbnailHistory.splice(index, 1);
                                state.historyCounts.thumbnails--;
                                break;
                            case 'placement':
                                if (state.placementHistory) state.placementHistory.splice(index, 1);
                                if (state.historyCounts) state.historyCounts.placements--;
                                break;
                            case 'channelAudit':
                                if (state.channelAuditHistory) state.channelAuditHistory.splice(index, 1);
                                if (state.historyCounts) state.historyCounts.channelAudit--;
                                break;
                        }
                        // Also remove from allHistory
                        if (state.allHistory) {
                            state.allHistory = state.allHistory.filter(function(item) {
                                return item.id !== id;
                            });
                        }
                        state.loading = false;
                        state.success = 'Item deleted successfully';
                        render();
                        setTimeout(function() { state.success = null; render(); }, 3000);
                    })
                    .catch(function(e) {
                        state.loading = false;
                        state.error = 'Failed to delete: ' + e.message;
                        render();
                    });
            },

            toggleErrorDetails: function() {
                var details = document.getElementById('error-details');
                if (details) {
                    details.classList.toggle('hidden');
                    var btn = details.previousElementSibling;
                    if (btn && btn.tagName === 'BUTTON') {
                        btn.textContent = details.classList.contains('hidden') ? 'Show Technical Details' : 'Hide Technical Details';
                    }
                }
            },

            /* ------------------------------------------
               4.5.5 Results Tab Actions
               ------------------------------------------ */

            setResultsTab: function(tab) {
                state.resultsTab = tab;
                render();
            },

            /* ------------------------------------------
               4.5.6 Admin Actions
               ------------------------------------------ */

            goToAdmin: function() {
                state.currentView = 'admin';
                state.error = null;
                state.adminLoading = true;
                render();

                // Load admin data
                functions.httpsCallable('adminGetUsers')()
                    .then(function(result) {
                        state.adminUsers = result.data.users || [];
                        state.adminLoading = false;
                        render();
                    })
                    .catch(function(e) {
                        state.adminLoading = false;
                        state.error = { message: 'Failed to load admin data: ' + e.message };
                        render();
                    });
            },

            setupAdmin: function() {
                state.loading = true;
                render();

                functions.httpsCallable('setupAdmin')()
                    .then(function(result) {
                        state.loading = false;
                        state.isAdmin = true;
                        state.success = result.data.message;
                        render();
                    })
                    .catch(function(e) {
                        state.loading = false;
                        state.error = { message: 'Failed to setup admin: ' + e.message };
                        render();
                    });
            },

            updateUserPlan: function(userId, newPlan) {
                state.adminLoading = true;
                render();

                functions.httpsCallable('adminUpdateUserPlan')({ userId: userId, plan: newPlan })
                    .then(function(result) {
                        // Refresh user list
                        return functions.httpsCallable('adminGetUsers')();
                    })
                    .then(function(result) {
                        state.adminUsers = result.data.users || [];
                        state.adminLoading = false;
                        state.success = 'User plan updated successfully!';
                        render();
                        setTimeout(function() { state.success = null; render(); }, 3000);
                    })
                    .catch(function(e) {
                        state.adminLoading = false;
                        state.error = { message: 'Failed to update user: ' + e.message };
                        render();
                    });
            },

            checkAdminStatus: function() {
                // Check if user is admin when profile loads
                if (state.profile && state.profile.isAdmin) {
                    state.isAdmin = true;
                }
            },

            setQuotaResetTime: function() {
                var resetMinutes = parseInt(document.getElementById('reset-time-input').value);
                if (!resetMinutes || resetMinutes < 1) {
                    state.error = { message: 'Please enter a valid number of minutes (minimum 1)' };
                    render();
                    return;
                }

                state.adminLoading = true;
                render();

                functions.httpsCallable('adminSetQuotaSettings')({ resetTimeMinutes: resetMinutes })
                    .then(function(result) {
                        state.adminLoading = false;
                        state.resetTimeMinutes = resetMinutes;
                        state.success = 'Quota reset time updated to ' + resetMinutes + ' minutes!';
                        render();
                        setTimeout(function() { state.success = null; render(); }, 3000);
                    })
                    .catch(function(e) {
                        state.adminLoading = false;
                        // Firebase Functions errors have code, message, and details
                        var errorMsg = e.message || 'Unknown error';
                        if (e.details) errorMsg = e.details;
                        // If only got error code, provide more context
                        if (errorMsg === 'internal' || errorMsg === 'INTERNAL') {
                            errorMsg = 'Server error occurred. Please check Firebase Functions logs for details.';
                        }
                        console.error('Admin setQuotaResetTime error:', e);
                        state.error = { message: 'Failed to update reset time: ' + errorMsg };
                        render();
                    });
            },

            grantBonusUses: function() {
                var userId = document.getElementById('bonus-user-select').value;
                var tool = document.getElementById('bonus-tool-select').value;
                var amount = parseInt(document.getElementById('bonus-amount-input').value);

                if (!userId) {
                    state.error = { message: 'Please select a user' };
                    render();
                    return;
                }
                if (!amount || amount < 1) {
                    state.error = { message: 'Please enter a valid bonus amount (minimum 1)' };
                    render();
                    return;
                }

                state.adminLoading = true;
                render();

                functions.httpsCallable('adminGrantBonusUses')({ userId: userId, tool: tool, bonusAmount: amount })
                    .then(function(result) {
                        state.adminLoading = false;
                        state.success = 'Granted ' + amount + ' bonus uses for ' + tool + '!';
                        // Refresh user list
                        return functions.httpsCallable('adminGetUsers')();
                    })
                    .then(function(result) {
                        if (result && result.data) {
                            state.adminUsers = result.data.users || [];
                        }
                        render();
                        setTimeout(function() { state.success = null; render(); }, 3000);
                    })
                    .catch(function(e) {
                        state.adminLoading = false;
                        state.error = { message: 'Failed to grant bonus: ' + e.message };
                        render();
                    });
            },

            /* ------------------------------------------
               4.5.5 Competitor Analysis Actions
               ------------------------------------------ */
            analyzeCompetitor: function(e) {
                e.preventDefault();
                const url = document.getElementById('competitor-url').value.trim();

                if (!url) {
                    state.error = { message: 'Please enter a competitor video URL' };
                    render();
                    return;
                }

                state.loading = true;
                state.error = null;
                state.loadingSteps = [
                    { name: 'Fetching video data', icon: '' },
                    { name: 'Analyzing channel', icon: '' },
                    { name: 'Evaluating SEO', icon: '' },
                    { name: 'Finding weaknesses', icon: '' },
                    { name: 'Generating strategy', icon: '' }
                ];
                startLoadingProgress();
                render();

                functions.httpsCallable('analyzeCompetitor')({ videoUrl: url })
                    .then(function(result) {
                        stopLoadingProgress();
                        state.competitorResults = result.data;
                        state.loading = false;
                        render();
                    })
                    .catch(function(e) {
                        stopLoadingProgress();
                        state.loading = false;
                        state.error = { message: 'Analysis failed: ' + e.message };
                        render();
                    });
            },

            /* ------------------------------------------
               4.5.6 Trend Predictor Actions
               ------------------------------------------ */
            predictTrends: function(e) {
                e.preventDefault();
                const niche = document.getElementById('trend-niche').value.trim();
                const country = document.getElementById('trend-country').value || 'US';

                if (!niche) {
                    state.error = { message: 'Please enter a niche/topic' };
                    render();
                    return;
                }

                state.loading = true;
                state.error = null;
                state.loadingSteps = [
                    { name: 'Scanning trending videos', icon: '' },
                    { name: 'Analyzing patterns', icon: '' },
                    { name: 'Identifying opportunities', icon: '' },
                    { name: 'Predicting future trends', icon: '' },
                    { name: 'Generating video ideas', icon: '' }
                ];
                startLoadingProgress();
                render();

                functions.httpsCallable('predictTrends')({ niche: niche, country: country })
                    .then(function(result) {
                        stopLoadingProgress();
                        state.trendResults = result.data;
                        state.loading = false;
                        render();
                    })
                    .catch(function(e) {
                        stopLoadingProgress();
                        state.loading = false;
                        state.error = { message: 'Prediction failed: ' + e.message };
                        render();
                    });
            },

            /* ------------------------------------------
               4.5.7 Thumbnail Generator Actions
               ------------------------------------------ */
            setThumbnailStyle: function(style) {
                state.thumbnailStyle = style;
                render();
            },

            generateThumbnail: function(e) {
                e.preventDefault();
                var title = document.getElementById('thumbnail-title').value.trim();
                var customPrompt = document.getElementById('thumbnail-prompt')?.value.trim() || '';

                // Get video context if available
                var videoContext = '';
                if (state.lastOptimization && state.thumbnailFromOptimizer) {
                    var opt = state.lastOptimization;
                    var videoInfo = opt.videoInfo || {};
                    videoContext = 'Video context: ' + (videoInfo.channelTitle || '') + ' channel. ';
                    if (opt.tags && opt.tags.length > 0) {
                        videoContext += 'Keywords: ' + opt.tags.slice(0, 5).join(', ') + '. ';
                    }
                }

                // Build style-specific prompt
                var stylePrompts = {
                    professional: 'Clean, professional look with sharp focus, studio lighting, high contrast',
                    dramatic: 'Dramatic lighting, intense colors, bold shadows, cinematic feel',
                    minimal: 'Minimalist design, soft colors, clean background, elegant simplicity',
                    bold: 'Vibrant colors, eye-catching, bold graphics, high energy, dynamic composition'
                };

                var fullPrompt = stylePrompts[state.thumbnailStyle] + '. ' + videoContext + customPrompt;

                if (!title) {
                    state.error = { message: 'Please enter a video title' };
                    render();
                    return;
                }

                state.loading = true;
                state.error = null;
                state.thumbnailImage = null;
                state.loadingSteps = [
                    { name: 'Analyzing video context', icon: '' },
                    { name: 'Creating AI prompt', icon: '' },
                    { name: 'Generating image', icon: '' },
                    { name: 'Rendering HD', icon: '' }
                ];
                startLoadingProgress();
                render();

                functions.httpsCallable('generateThumbnail')({
                    title: title,
                    customPrompt: fullPrompt,
                    style: state.thumbnailStyle
                })
                    .then(function(result) {
                        state.thumbnailJob = result.data;
                        // Start polling for result
                        app.pollThumbnailStatus(result.data.jobId);
                    })
                    .catch(function(e) {
                        stopLoadingProgress();
                        state.loading = false;
                        state.error = { message: 'Generation failed: ' + e.message };
                        render();
                    });
            },

            pollThumbnailStatus: function(jobId) {
                var pollCount = 0;
                var maxPolls = 60; // Maximum 3 minutes (60 * 3 seconds)

                var pollInterval = setInterval(function() {
                    pollCount++;

                    // Check if exceeded max polls
                    if (pollCount > maxPolls) {
                        clearInterval(pollInterval);
                        stopLoadingProgress();
                        state.loading = false;
                        state.error = { message: 'Generation timed out. Please try again.' };
                        render();
                        return;
                    }

                    functions.httpsCallable('checkThumbnailStatus')({ jobId: jobId })
                        .then(function(result) {
                            state.thumbnailStatus = result.data.status;

                            if (result.data.status === 'COMPLETED') {
                                clearInterval(pollInterval);
                                stopLoadingProgress();
                                state.loading = false;

                                // The image URL was set in the initial generateThumbnail call
                                // RunPod uploads to Firebase Storage at state.thumbnailJob.imageUrl
                                var imageUrl = state.thumbnailJob?.imageUrl;

                                // Also check if RunPod returns output with image data (might be URL or base64)
                                var runpodOutput = result.data.output;
                                console.log('Thumbnail completed. Firebase URL:', imageUrl, 'RunPod output:', runpodOutput ? typeof runpodOutput : 'none');

                                // Try multiple sources for the image
                                // Priority: RunPod direct output > Firebase Storage URL (more reliable if RunPod provides it)
                                if (runpodOutput && typeof runpodOutput === 'string' && runpodOutput.length > 50) {
                                    // RunPod returned a URL or base64 data directly
                                    if (runpodOutput.startsWith('http') || runpodOutput.startsWith('data:')) {
                                        state.thumbnailImage = runpodOutput;
                                    } else {
                                        // Likely base64 encoded image
                                        state.thumbnailImage = 'data:image/png;base64,' + runpodOutput;
                                    }
                                } else if (imageUrl) {
                                    // Use Firebase Storage URL
                                    state.thumbnailImage = imageUrl;
                                } else {
                                    state.error = { message: 'Image generated but URL not available. Check Firebase Storage.' };
                                }

                                render();
                            } else if (result.data.status === 'FAILED') {
                                clearInterval(pollInterval);
                                stopLoadingProgress();
                                state.loading = false;
                                var errorDetail = result.data.error || 'Unknown error';
                                if (typeof errorDetail === 'object') {
                                    errorDetail = errorDetail.message || JSON.stringify(errorDetail);
                                }
                                state.error = { message: 'Thumbnail generation failed: ' + errorDetail };
                                render();
                            } else {
                                // Still processing (IN_QUEUE or IN_PROGRESS), update progress
                                if (state.loadingProgress < 90) {
                                    state.loadingProgress += 2;
                                }
                                updateLoadingUI();
                            }
                        })
                        .catch(function(e) {
                            // Don't clear interval on transient errors, just log
                            console.error('Thumbnail status check error:', e);
                            if (pollCount > 5) {
                                // Only fail after multiple attempts
                                clearInterval(pollInterval);
                                stopLoadingProgress();
                                state.loading = false;
                                state.error = { message: 'Status check failed: ' + e.message };
                                render();
                            }
                        });
                }, 3000); // Poll every 3 seconds
            },

            /* ------------------------------------------
               4.5.8 Placement Finder Actions
               ------------------------------------------ */
            findPlacements: function(e) {
                e.preventDefault();
                var channelUrl = document.getElementById('placement-channel-url').value.trim();

                if (!channelUrl) {
                    state.error = { message: 'Please enter your YouTube channel URL' };
                    render();
                    return;
                }

                state.placementLoading = true;
                state.loading = true;
                state.error = null;
                state.loadingSteps = [
                    { name: 'Analyzing your channel', icon: '' },
                    { name: 'Understanding your content', icon: '' },
                    { name: 'Identifying your niche', icon: '' },
                    { name: 'Searching similar channels', icon: '' },
                    { name: 'Scoring relevance', icon: '' },
                    { name: 'Compiling results', icon: '' }
                ];
                startLoadingProgress();
                render();

                functions.httpsCallable('findPlacements')({ channelUrl: channelUrl })
                    .then(function(result) {
                        stopLoadingProgress();
                        state.placementResults = result.data;
                        state.placementLoading = false;
                        state.loading = false;
                        render();
                    })
                    .catch(function(e) {
                        stopLoadingProgress();
                        state.placementLoading = false;
                        state.loading = false;
                        state.error = { message: 'Failed to find placements: ' + e.message };
                        render();
                    });
            },

            findMorePlacements: function() {
                if (!state.placementResults || !state.placementResults.historyId) return;

                state.placementLoading = true;
                render();

                functions.httpsCallable('findMorePlacements')({ historyId: state.placementResults.historyId })
                    .then(function(result) {
                        state.placementResults.placements = result.data.placements;
                        state.placementResults.totalFound = result.data.totalFound;
                        state.placementLoading = false;
                        if (result.data.added === 0) {
                            state.error = { message: 'No more channels found matching your criteria.' };
                        }
                        render();
                    })
                    .catch(function(e) {
                        state.placementLoading = false;
                        state.error = { message: 'Failed to find more: ' + e.message };
                        render();
                    });
            },

            copyAllPlacements: function() {
                if (!state.placementResults || !state.placementResults.placements) return;

                var urls = state.placementResults.placements.map(function(p) {
                    return p.channelUrl;
                }).join('\n');

                navigator.clipboard.writeText(urls).then(function() {
                    state.copySuccess = 'Copied ' + state.placementResults.placements.length + ' channel URLs!';
                    render();
                    setTimeout(function() {
                        state.copySuccess = null;
                        render();
                    }, 3000);
                }).catch(function(err) {
                    state.error = { message: 'Failed to copy: ' + err.message };
                    render();
                });
            },

            copySinglePlacement: function(url) {
                navigator.clipboard.writeText(url).then(function() {
                    state.copySuccess = 'Channel URL copied!';
                    render();
                    setTimeout(function() {
                        state.copySuccess = null;
                        render();
                    }, 2000);
                }).catch(function(err) {
                    state.error = { message: 'Failed to copy: ' + err.message };
                    render();
                });
            },

            /* ------------------------------------------
               4.5.10 Campaign Reports Functions
               ------------------------------------------ */

            // Navigation
            goToAdminReports: function() {
                state.currentView = 'admin-reports';
                state.error = null;
                state.success = null;
                state.reportImages = [];
                state.reportAnalysis = null;
                state.sendModalReportId = null;
                this.loadAdminReports();
                render();
            },

            goToClientReports: function() {
                state.currentView = 'client-reports';
                state.error = null;
                state.success = null;
                this.loadClientReports();
                render();
            },

            goToReportEditor: function() {
                if (!state.reportAnalysis && !state.editingReport) {
                    state.error = 'No report to edit';
                    render();
                    return;
                }

                if (!state.editingReport) {
                    // Creating new report from analysis
                    state.editingReport = {
                        id: null,
                        campaignName: document.getElementById('campaign-name')?.value || 'Campaign Report',
                        images: state.reportImages,
                        aiAnalysis: state.reportAnalysis,
                        editedContent: {
                            title: document.getElementById('campaign-name')?.value || 'Campaign Performance Report',
                            summary: state.reportAnalysis.summary || '',
                            metrics: state.reportAnalysis.metrics || {},
                            youtubeMetrics: state.reportAnalysis.youtubeMetrics || {},
                            performance: state.reportAnalysis.performance || {},
                            recommendations: state.reportAnalysis.recommendations || [],
                            callToAction: state.reportAnalysis.fiverCTA || ''
                        }
                    };
                }

                state.currentView = 'report-editor';
                state.error = null;
                state.success = null;
                render();
            },

            // Image Upload Handling
            handleImageUpload: function(event) {
                var files = event.target.files;
                if (!files || files.length === 0) return;

                var maxImages = 6;
                var currentCount = state.reportImages.length;
                var remainingSlots = maxImages - currentCount;

                if (files.length > remainingSlots) {
                    state.error = 'Maximum ' + maxImages + ' images allowed. You can add ' + remainingSlots + ' more.';
                    render();
                    return;
                }

                for (var i = 0; i < files.length && i < remainingSlots; i++) {
                    var file = files[i];

                    // Validate file type
                    if (!file.type.match(/^image\/(png|jpe?g|webp)$/)) {
                        state.error = 'Only PNG, JPG, and WebP images are supported';
                        render();
                        return;
                    }

                    // Validate file size (10MB max)
                    if (file.size > 10 * 1024 * 1024) {
                        state.error = 'Each image must be under 10MB';
                        render();
                        return;
                    }

                    // Read file and create preview
                    (function(f) {
                        var reader = new FileReader();
                        reader.onload = function(e) {
                            state.reportImages.push({
                                file: f,
                                preview: e.target.result,
                                base64: e.target.result.split(',')[1],
                                mimeType: f.type,
                                name: f.name
                            });
                            render();
                        };
                        reader.readAsDataURL(f);
                    })(file);
                }

                // Clear input
                event.target.value = '';
            },

            removeReportImage: function(index) {
                state.reportImages.splice(index, 1);
                render();
            },

            clearReportImages: function() {
                state.reportImages = [];
                state.reportAnalysis = null;
                render();
            },

            // Drag and Drop Handler
            handleImageDrop: function(event) {
                event.preventDefault();
                event.stopPropagation();

                var uploadZone = document.getElementById('upload-zone');
                if (uploadZone) uploadZone.classList.remove('drag-over');

                var files = event.dataTransfer.files;
                if (!files || files.length === 0) return;

                var maxImages = 6;
                var currentCount = state.reportImages.length;
                var remainingSlots = maxImages - currentCount;

                if (files.length > remainingSlots) {
                    state.error = 'Maximum ' + maxImages + ' images allowed. You can add ' + remainingSlots + ' more.';
                    render();
                    return;
                }

                for (var i = 0; i < files.length && i < remainingSlots; i++) {
                    var file = files[i];

                    // Validate file type
                    if (!file.type.match(/^image\/(png|jpe?g|webp)$/)) {
                        state.error = 'Only PNG, JPG, and WebP images are supported';
                        render();
                        return;
                    }

                    // Validate file size (10MB max)
                    if (file.size > 10 * 1024 * 1024) {
                        state.error = 'Each image must be under 10MB';
                        render();
                        return;
                    }

                    // Read file and create preview
                    (function(f) {
                        var reader = new FileReader();
                        reader.onload = function(e) {
                            state.reportImages.push({
                                file: f,
                                preview: e.target.result,
                                base64: e.target.result.split(',')[1],
                                mimeType: f.type,
                                name: f.name
                            });
                            render();
                        };
                        reader.readAsDataURL(f);
                    })(file);
                }
            },

            handleDragOver: function(event) {
                event.preventDefault();
                event.stopPropagation();
                var uploadZone = document.getElementById('upload-zone');
                if (uploadZone) uploadZone.classList.add('drag-over');
            },

            handleDragLeave: function(event) {
                event.preventDefault();
                event.stopPropagation();
                var uploadZone = document.getElementById('upload-zone');
                if (uploadZone) uploadZone.classList.remove('drag-over');
            },

            // Lightbox Functions
            openLightbox: function(images, index) {
                state.lightboxImages = images;
                state.lightboxIndex = index || 0;
                state.lightboxOpen = true;
                document.body.style.overflow = 'hidden';
                render();
            },

            closeLightbox: function() {
                state.lightboxOpen = false;
                state.lightboxImages = [];
                state.lightboxIndex = 0;
                document.body.style.overflow = '';
                render();
            },

            prevLightboxImage: function() {
                if (state.lightboxIndex > 0) {
                    state.lightboxIndex--;
                    render();
                }
            },

            nextLightboxImage: function() {
                if (state.lightboxIndex < state.lightboxImages.length - 1) {
                    state.lightboxIndex++;
                    render();
                }
            },

            downloadImage: function(url, filename) {
                // Create a temporary link to download the image
                var link = document.createElement('a');
                link.href = url;
                link.download = filename || 'campaign-screenshot.png';
                link.target = '_blank';

                // For cross-origin images, open in new tab
                if (url.includes('firebasestorage.googleapis.com')) {
                    window.open(url, '_blank');
                } else {
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            },

            // AI Analysis
            analyzeReportImages: async function() {
                if (state.reportImages.length === 0) {
                    state.error = 'Please upload at least one image';
                    render();
                    return;
                }

                state.reportLoading = true;
                state.error = null;
                render();

                try {
                    var campaignName = document.getElementById('campaign-name')?.value || '';
                    var additionalContext = document.getElementById('additional-context')?.value || '';

                    var analyzeReportImages = firebase.functions().httpsCallable('analyzeReportImages');
                    var result = await analyzeReportImages({
                        images: state.reportImages.map(function(img) {
                            return {
                                base64: img.base64,
                                mimeType: img.mimeType
                            };
                        }),
                        campaignName: campaignName,
                        additionalContext: additionalContext
                    });

                    if (result.data.success) {
                        state.reportAnalysis = result.data.analysis;
                        state.success = 'AI analysis completed successfully!';
                    } else {
                        state.error = 'Analysis failed. Please try again.';
                    }
                } catch (err) {
                    console.error('Analysis error:', err);
                    state.error = err.message || 'Failed to analyze images';
                } finally {
                    state.reportLoading = false;
                    render();
                }
            },

            // Save Report
            saveReportAsDraft: async function() {
                if (!state.reportAnalysis || state.reportImages.length === 0) {
                    state.error = 'No analysis to save';
                    render();
                    return;
                }

                state.reportLoading = true;
                state.error = null;
                render();

                try {
                    // First upload images to storage
                    var uploadReportImages = firebase.functions().httpsCallable('uploadReportImages');
                    var uploadResult = await uploadReportImages({
                        images: state.reportImages.map(function(img) {
                            return {
                                base64: img.base64,
                                mimeType: img.mimeType
                            };
                        })
                    });

                    if (!uploadResult.data.success) {
                        throw new Error('Failed to upload images');
                    }

                    // Then create the report
                    var createCampaignReport = firebase.functions().httpsCallable('createCampaignReport');
                    var campaignName = document.getElementById('campaign-name')?.value || 'Campaign Report';

                    var result = await createCampaignReport({
                        reportId: uploadResult.data.reportId,
                        images: uploadResult.data.images,
                        aiAnalysis: state.reportAnalysis,
                        campaignName: campaignName,
                        status: 'draft'
                    });

                    if (result.data.success) {
                        state.success = 'Report saved as draft!';
                        state.reportImages = [];
                        state.reportAnalysis = null;
                        this.loadAdminReports();
                    }
                } catch (err) {
                    console.error('Save report error:', err);
                    state.error = err.message || 'Failed to save report';
                } finally {
                    state.reportLoading = false;
                    render();
                }
            },

            saveReportChanges: async function() {
                if (!state.editingReport) {
                    state.error = 'No report to save';
                    render();
                    return;
                }

                state.reportLoading = true;
                state.error = null;
                render();

                try {
                    var title = document.getElementById('edit-title')?.value || '';
                    var summary = document.getElementById('edit-summary')?.value || '';
                    var cta = document.getElementById('edit-cta')?.value || '';

                    // Get recommendations from inputs
                    var recInputs = document.querySelectorAll('.rec-input');
                    var recommendations = [];
                    recInputs.forEach(function(input) {
                        if (input.value.trim()) {
                            recommendations.push({ title: input.value.trim() });
                        }
                    });

                    var editedContent = {
                        title: title,
                        summary: summary,
                        metrics: state.editingReport.editedContent?.metrics || state.editingReport.aiAnalysis?.metrics || {},
                        youtubeMetrics: state.editingReport.editedContent?.youtubeMetrics || state.editingReport.aiAnalysis?.youtubeMetrics || {},
                        performance: state.editingReport.editedContent?.performance || state.editingReport.aiAnalysis?.performance || {},
                        recommendations: recommendations,
                        callToAction: cta
                    };

                    if (state.editingReport.id) {
                        // Update existing report
                        var updateCampaignReport = firebase.functions().httpsCallable('updateCampaignReport');
                        var result = await updateCampaignReport({
                            reportId: state.editingReport.id,
                            editedContent: editedContent,
                            campaignName: title,
                            status: 'ready'
                        });

                        if (result.data.success) {
                            state.success = 'Report updated successfully!';
                            state.editingReport.editedContent = editedContent;
                        }
                    } else {
                        // Create new report
                        var uploadReportImages = firebase.functions().httpsCallable('uploadReportImages');
                        var uploadResult = await uploadReportImages({
                            images: state.editingReport.images.map(function(img) {
                                return {
                                    base64: img.base64,
                                    mimeType: img.mimeType
                                };
                            })
                        });

                        if (!uploadResult.data.success) {
                            throw new Error('Failed to upload images');
                        }

                        var createCampaignReport = firebase.functions().httpsCallable('createCampaignReport');
                        var result = await createCampaignReport({
                            reportId: uploadResult.data.reportId,
                            images: uploadResult.data.images,
                            aiAnalysis: state.editingReport.aiAnalysis,
                            editedContent: editedContent,
                            campaignName: title,
                            status: 'ready'
                        });

                        if (result.data.success) {
                            state.success = 'Report created successfully!';
                            state.editingReport.id = result.data.reportId;
                            state.editingReport.images = uploadResult.data.images;
                        }
                    }
                } catch (err) {
                    console.error('Save changes error:', err);
                    state.error = err.message || 'Failed to save changes';
                } finally {
                    state.reportLoading = false;
                    render();
                }
            },

            // Edit/Delete Reports
            editReport: async function(reportId) {
                state.reportLoading = true;
                render();

                try {
                    var getCampaignReport = firebase.functions().httpsCallable('getCampaignReport');
                    var result = await getCampaignReport({ reportId: reportId });

                    if (result.data.success) {
                        state.editingReport = result.data.report;
                        state.currentView = 'report-editor';
                    }
                } catch (err) {
                    console.error('Load report error:', err);
                    state.error = err.message || 'Failed to load report';
                } finally {
                    state.reportLoading = false;
                    render();
                }
            },

            deleteReport: async function(reportId) {
                if (!confirm('Are you sure you want to delete this report? This action cannot be undone.')) {
                    return;
                }

                state.reportLoading = true;
                render();

                try {
                    var deleteCampaignReport = firebase.functions().httpsCallable('deleteCampaignReport');
                    var result = await deleteCampaignReport({ reportId: reportId });

                    if (result.data.success) {
                        state.success = 'Report deleted successfully';
                        this.loadAdminReports();
                    }
                } catch (err) {
                    console.error('Delete report error:', err);
                    state.error = err.message || 'Failed to delete report';
                } finally {
                    state.reportLoading = false;
                    render();
                }
            },

            // Send to Client
            openSendModal: function(reportId) {
                state.sendModalReportId = reportId;
                render();
            },

            closeSendModal: function() {
                state.sendModalReportId = null;
                render();
            },

            sendReportToClient: async function() {
                var clientId = document.getElementById('send-client-select')?.value;
                if (!clientId) {
                    state.error = 'Please select a client';
                    render();
                    return;
                }

                state.reportLoading = true;
                render();

                try {
                    var sendReportToClient = firebase.functions().httpsCallable('sendReportToClient');
                    var result = await sendReportToClient({
                        reportId: state.sendModalReportId,
                        clientId: clientId
                    });

                    if (result.data.success) {
                        state.success = result.data.message;
                        state.sendModalReportId = null;
                        this.loadAdminReports();
                    }
                } catch (err) {
                    console.error('Send report error:', err);
                    state.error = err.message || 'Failed to send report';
                } finally {
                    state.reportLoading = false;
                    render();
                }
            },

            // Load Reports
            loadAdminReports: async function() {
                try {
                    var getAdminReports = firebase.functions().httpsCallable('getAdminReports');
                    var result = await getAdminReports({});

                    if (result.data.success) {
                        state.campaignReports = result.data.reports;
                    }
                } catch (err) {
                    console.error('Load admin reports error:', err);
                    state.campaignReports = [];
                }
                render();
            },

            loadClientReports: async function() {
                try {
                    var getClientReports = firebase.functions().httpsCallable('getClientReports');
                    var result = await getClientReports({});

                    if (result.data.success) {
                        state.clientReports = result.data.reports;
                    }
                } catch (err) {
                    console.error('Load client reports error:', err);
                    state.clientReports = [];
                }
                render();
            },

            // View Report (Client)
            viewReport: async function(reportId) {
                state.currentReport = { id: null };
                state.currentView = 'view-report';
                render();

                try {
                    var getCampaignReport = firebase.functions().httpsCallable('getCampaignReport');
                    var result = await getCampaignReport({ reportId: reportId });

                    if (result.data.success) {
                        state.currentReport = result.data.report;

                        // Mark as viewed
                        var markReportViewed = firebase.functions().httpsCallable('markReportViewed');
                        await markReportViewed({ reportId: reportId });

                        // Update local state
                        if (state.clientReports) {
                            state.clientReports = state.clientReports.map(function(r) {
                                if (r.id === reportId) {
                                    r.status = 'viewed';
                                }
                                return r;
                            });
                        }

                        // Refresh notifications
                        this.loadNotifications();
                    }
                } catch (err) {
                    console.error('View report error:', err);
                    state.error = err.message || 'Failed to load report';
                }
                render();
            },

            // Recommendations editing
            addRecommendation: function() {
                if (!state.editingReport) return;
                if (!state.editingReport.editedContent) {
                    state.editingReport.editedContent = { recommendations: [] };
                }
                if (!state.editingReport.editedContent.recommendations) {
                    state.editingReport.editedContent.recommendations = [];
                }
                state.editingReport.editedContent.recommendations.push({ title: '' });
                render();
            },

            removeRecommendation: function(index) {
                if (!state.editingReport?.editedContent?.recommendations) return;
                state.editingReport.editedContent.recommendations.splice(index, 1);
                render();
            },

            // Notifications
            loadNotifications: async function() {
                try {
                    var getUnreadNotifications = firebase.functions().httpsCallable('getUnreadNotifications');
                    var result = await getUnreadNotifications({});

                    if (result.data.success) {
                        state.notifications = result.data.notifications;
                        state.unreadCount = result.data.unreadCount;
                    }
                } catch (err) {
                    console.error('Load notifications error:', err);
                }
                render();
            },

            toggleNotifications: function() {
                state.showNotifications = !state.showNotifications;
                render();
            },

            closeNotifications: function() {
                if (state.showNotifications) {
                    state.showNotifications = false;
                    render();
                }
            },

            markAllNotificationsRead: async function() {
                try {
                    var markNotificationRead = firebase.functions().httpsCallable('markNotificationRead');
                    await markNotificationRead({ markAll: true });
                    state.notifications = [];
                    state.unreadCount = 0;
                    state.showNotifications = false;
                } catch (err) {
                    console.error('Mark notifications error:', err);
                }
                render();
            },

            openNotificationReport: async function(reportId, notificationId) {
                // Mark notification as read
                try {
                    var markNotificationRead = firebase.functions().httpsCallable('markNotificationRead');
                    await markNotificationRead({ notificationId: notificationId });
                } catch (err) {
                    console.error('Mark notification error:', err);
                }

                state.showNotifications = false;
                this.viewReport(reportId);
            }
        };

        /* ==========================================
           4.6 RENDER FUNCTIONS (Views)
           ========================================== */

        /* ------------------------------------------
           4.6.0 Initializing View (Loading Screen)
           ------------------------------------------ */
        function renderInitializing() {
            var html = '';
            html += '<div class="min-h-screen flex items-center justify-center">';
            html += '<div class="text-center fade-in">';
            html += '<div class="text-7xl mb-6"></div>';
            html += '<div class="spinner mx-auto mb-4"></div>';
            html += '<p class="text-white/80 text-lg">Loading...</p>';
            html += '</div>';
            html += '</div>';
            return html;
        }

        /* ------------------------------------------
           4.6.1 Login View
           ------------------------------------------ */
        function renderLogin() {
            var html = '';

            // Container
            html += '<div class="min-h-screen mobile-full-screen flex items-center justify-center px-4 py-8">';
            html += '<div class="max-w-md w-full mobile-card">';

            // Header
            html += '<div class="text-center mb-8 fade-in">';
            html += '<div class="text-6xl mb-4"></div>';
            html += '<h1 class="text-4xl mobile-text-xl font-bold text-white mb-2">YouTube Video Optimizer</h1>';
            html += '<p class="text-white/80 text-lg mobile-text-lg">AI-powered video optimization</p>';
            html += '</div>';

            // Card
            html += '<div class="bg-white rounded-2xl shadow-2xl p-8 mobile-padding fade-in">';
            html += '<h2 class="text-2xl mobile-text-xl font-bold text-gray-800 mb-6">Sign In</h2>';

            // Error message
            if (state.error) {
                html += '<div class="alert-error">' + utils.escapeHtml(state.error) + '</div>';
            }

            // Google Sign-In Button
            html += '<button onclick="app.signInWithGoogle()" class="google-btn w-full flex items-center justify-center gap-3 bg-white border-2 border-gray-300 rounded-xl py-4 px-6 text-gray-700 font-semibold hover:border-gray-400 mb-6"';
            if (state.loading) html += ' disabled';
            html += '>';
            html += '<svg width="20" height="20" viewBox="0 0 20 20"><path fill="#4285F4" d="M19.6 10.23c0-.82-.1-1.42-.25-2.05H10v3.72h5.5c-.15.96-.74 2.31-2.04 3.22v2.45h3.16c1.89-1.73 2.98-4.3 2.98-7.34z"/><path fill="#34A853" d="M13.46 15.13c-.83.59-1.96 1-3.46 1-2.64 0-4.88-1.74-5.68-4.15H1.07v2.52C2.72 17.75 6.09 20 10 20c2.7 0 4.96-.89 6.62-2.42l-3.16-2.45z"/><path fill="#FBBC05" d="M3.99 10c0-.69.12-1.35.32-1.97V5.51H1.07A9.973 9.973 0 000 10c0 1.61.39 3.14 1.07 4.49l3.24-2.52c-.2-.62-.32-1.28-.32-1.97z"/><path fill="#EA4335" d="M10 3.88c1.88 0 3.13.81 3.85 1.48l2.84-2.76C14.96.99 12.7 0 10 0 6.09 0 2.72 2.25 1.07 5.51l3.24 2.52C5.12 5.62 7.36 3.88 10 3.88z"/></svg>';
            html += state.loading ? 'Signing in...' : 'Sign in with Google';
            html += '</button>';

            // Divider
            html += '<div class="relative my-6">';
            html += '<div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>';
            html += '<div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">Or sign in with email</span></div>';
            html += '</div>';

            // Email/Password Form
            html += '<form onsubmit="app.signIn(event)">';
            html += '<div class="mb-4">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Email</label>';
            html += '<input type="email" id="login-email" required class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="your@email.com" />';
            html += '</div>';

            html += '<div class="mb-6">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Password</label>';
            html += '<input type="password" id="login-password" required class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="" />';
            html += '</div>';

            html += '<button type="submit" class="btn-primary"';
            if (state.loading) html += ' disabled';
            html += '>';
            html += state.loading ? ' Signing in...' : ' Sign In';
            html += '</button>';
            html += '</form>';

            // Forgot password link
            html += '<div class="mt-6 text-center">';
            html += '<button onclick="app.goToForgotPassword()" class="text-blue-600 hover:text-blue-700 font-semibold">Forgot Password?</button>';
            html += '</div>';

            // Register link
            html += '<div class="mt-4 pt-4 border-t border-gray-200 text-center">';
            html += '<p class="text-gray-600">Don\'t have an account?</p>';
            html += '<button onclick="app.goToRegister()" class="mt-2 text-purple-600 hover:text-purple-700 font-bold">Create Account </button>';
            html += '</div>';

            html += '</div></div></div>';

            return html;
        }

        /* ------------------------------------------
           4.6.2 Register View
           ------------------------------------------ */
        function renderRegister() {
            var html = '';

            // Container
            html += '<div class="min-h-screen flex items-center justify-center px-4 py-8">';
            html += '<div class="max-w-md w-full">';

            // Header
            html += '<div class="text-center mb-8 fade-in">';
            html += '<div class="text-6xl mb-4"></div>';
            html += '<h1 class="text-4xl font-bold text-white mb-2">Create Account</h1>';
            html += '<p class="text-white/80 text-lg">Start optimizing your videos</p>';
            html += '</div>';

            // Card
            html += '<div class="bg-white rounded-2xl shadow-2xl p-8 fade-in">';
            html += '<h2 class="text-2xl font-bold text-gray-800 mb-6">Register</h2>';

            // Error message
            if (state.error) {
                html += '<div class="alert-error">' + utils.escapeHtml(state.error) + '</div>';
            }

            // Google Sign-Up Button
            html += '<button onclick="app.signInWithGoogle()" class="google-btn w-full flex items-center justify-center gap-3 bg-white border-2 border-gray-300 rounded-xl py-4 px-6 text-gray-700 font-semibold hover:border-gray-400 mb-6"';
            if (state.loading) html += ' disabled';
            html += '>';
            html += '<svg width="20" height="20" viewBox="0 0 20 20"><path fill="#4285F4" d="M19.6 10.23c0-.82-.1-1.42-.25-2.05H10v3.72h5.5c-.15.96-.74 2.31-2.04 3.22v2.45h3.16c1.89-1.73 2.98-4.3 2.98-7.34z"/><path fill="#34A853" d="M13.46 15.13c-.83.59-1.96 1-3.46 1-2.64 0-4.88-1.74-5.68-4.15H1.07v2.52C2.72 17.75 6.09 20 10 20c2.7 0 4.96-.89 6.62-2.42l-3.16-2.45z"/><path fill="#FBBC05" d="M3.99 10c0-.69.12-1.35.32-1.97V5.51H1.07A9.973 9.973 0 000 10c0 1.61.39 3.14 1.07 4.49l3.24-2.52c-.2-.62-.32-1.28-.32-1.97z"/><path fill="#EA4335" d="M10 3.88c1.88 0 3.13.81 3.85 1.48l2.84-2.76C14.96.99 12.7 0 10 0 6.09 0 2.72 2.25 1.07 5.51l3.24 2.52C5.12 5.62 7.36 3.88 10 3.88z"/></svg>';
            html += state.loading ? 'Creating account...' : 'Sign up with Google';
            html += '</button>';

            // Divider
            html += '<div class="relative my-6">';
            html += '<div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>';
            html += '<div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">Or register with email</span></div>';
            html += '</div>';

            // Email/Password Form
            html += '<form onsubmit="app.register(event)">';
            html += '<div class="mb-4">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Email</label>';
            html += '<input type="email" id="register-email" required class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="your@email.com" />';
            html += '</div>';

            html += '<div class="mb-4">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Password (min 6 characters)</label>';
            html += '<input type="password" id="register-password" required minlength="6" class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="" />';
            html += '</div>';

            html += '<div class="mb-6">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Confirm Password</label>';
            html += '<input type="password" id="register-confirm-password" required minlength="6" class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="" />';
            html += '</div>';

            html += '<button type="submit" class="btn-primary"';
            if (state.loading) html += ' disabled';
            html += '>';
            html += state.loading ? ' Creating account...' : ' Create Account';
            html += '</button>';
            html += '</form>';

            // Login link
            html += '<div class="mt-6 pt-4 border-t border-gray-200 text-center">';
            html += '<p class="text-gray-600">Already have an account?</p>';
            html += '<button onclick="app.goToLogin()" class="mt-2 text-purple-600 hover:text-purple-700 font-bold">Sign In </button>';
            html += '</div>';

            html += '</div></div></div>';

            return html;
        }

        /* ------------------------------------------
           4.6.3 Forgot Password View
           ------------------------------------------ */
        function renderForgotPassword() {
            var html = '';

            // Container
            html += '<div class="min-h-screen flex items-center justify-center px-4 py-8">';
            html += '<div class="max-w-md w-full">';

            // Header
            html += '<div class="text-center mb-8 fade-in">';
            html += '<div class="text-6xl mb-4"></div>';
            html += '<h1 class="text-4xl font-bold text-white mb-2">Reset Password</h1>';
            html += '<p class="text-white/80 text-lg">We\'ll send you a reset link</p>';
            html += '</div>';

            // Card
            html += '<div class="bg-white rounded-2xl shadow-2xl p-8 fade-in">';
            html += '<h2 class="text-2xl font-bold text-gray-800 mb-6">Forgot Password?</h2>';

            // Messages
            if (state.error) {
                html += '<div class="alert-error">' + utils.escapeHtml(state.error) + '</div>';
            }
            if (state.success) {
                html += '<div class="alert-success">' + utils.escapeHtml(state.success) + '</div>';
            }

            // Form
            html += '<form onsubmit="app.resetPassword(event)">';
            html += '<div class="mb-6">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Email Address</label>';
            html += '<input type="email" id="reset-email" required class="input-field w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="your@email.com" />';
            html += '<p class="text-sm text-gray-500 mt-2">Enter your email and we\'ll send you a password reset link</p>';
            html += '</div>';

            html += '<button type="submit" class="btn-primary"';
            if (state.loading) html += ' disabled';
            html += '>';
            html += state.loading ? ' Sending...' : ' Send Reset Link';
            html += '</button>';
            html += '</form>';

            // Back link
            html += '<div class="mt-6 pt-4 border-t border-gray-200 text-center">';
            html += '<button onclick="app.goToLogin()" class="text-purple-600 hover:text-purple-700 font-bold"> Back to Sign In</button>';
            html += '</div>';

            html += '</div></div></div>';

            return html;
        }

        /* ------------------------------------------
           4.6.4 Dashboard View
           ------------------------------------------ */
        function renderDashboard() {
            if (!state.profile) {
                return '<div class="text-white text-center py-12"><div class="spinner mx-auto mb-4"></div>Loading profile...</div>';
            }

            const p = state.profile;
            const plan = (p.subscription && p.subscription.plan) || 'free';
            const planName = plan.charAt(0).toUpperCase() + plan.slice(1);

            var html = '';

            // Container
            html += '<div class="min-h-screen mobile-full-screen py-8 px-4 lg:py-12 mobile-wide-container">';
            html += '<div class="max-w-6xl mx-auto">';

            // Header - larger and more prominent
            html += '<div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-10 fade-in gap-6">';
            html += '<div>';
            html += '<h1 class="text-4xl lg:text-5xl font-bold text-white mb-3">Welcome back!</h1>';
            html += '<div class="flex flex-wrap gap-4 text-white/90">';
            html += '<span class="flex items-center gap-2 bg-white/10 px-4 py-2 rounded-full backdrop-blur"><span class="text-lg"></span> ' + utils.escapeHtml(p.email || '') + '</span>';
            html += '<span class="flex items-center gap-2 bg-gradient-to-r from-purple-500/30 to-indigo-500/30 px-4 py-2 rounded-full backdrop-blur font-semibold"><span class="text-lg"></span> ' + planName + ' Plan</span>';
            html += '</div>';
            html += '</div>';
            html += '<div class="flex items-center gap-4">';
            // Note: Notification bell is now rendered globally via renderGlobalHeader()
            html += '<button onclick="app.signOut()" class="btn-secondary">Sign Out</button>';
            html += '</div>';
            html += '</div>';

            // Usage Stats - Tools data
            var tools = [
                { name: 'Warp Optimizer', key: 'warpOptimizer', emoji: '', color: 'from-blue-500 to-indigo-600' },
                { name: 'Competitor Analysis', key: 'competitorAnalysis', emoji: '', color: 'from-red-500 to-orange-600' },
                { name: 'Trend Predictor', key: 'trendPredictor', emoji: '', color: 'from-cyan-500 to-blue-600' },
                { name: 'AI Thumbnails', key: 'thumbnailGenerator', emoji: '', color: 'from-pink-500 to-rose-600' },
                { name: 'Channel Audit Pro', key: 'channelAudit', emoji: '', color: 'from-emerald-500 to-teal-600' }
            ];

            // Helper function to generate card HTML
            function generateUsageCard(tool, extraClass) {
                var usage = (p.usage && p.usage[tool.key]) || { usedToday: 0, limit: 2, lastResetAt: new Date().toISOString() };
                var quotaData = state.quotaInfo && state.quotaInfo[tool.key] ? state.quotaInfo[tool.key] : null;
                var totalLimit = quotaData ? quotaData.totalLimit : (usage.limit || 2);
                var baseLimit = quotaData ? quotaData.baseLimit : (usage.limit || 2);
                var bonusUses = quotaData ? quotaData.bonusUses : 0;

                var nextResetMs = 0;
                if (quotaData && quotaData.nextResetMs) {
                    nextResetMs = quotaData.nextResetMs;
                } else if (usage.lastResetAt) {
                    var lastResetTime = usage.lastResetAt;
                    if (typeof lastResetTime === 'object' && lastResetTime.seconds) {
                        lastResetTime = lastResetTime.seconds * 1000;
                    } else if (typeof lastResetTime === 'object' && lastResetTime._seconds) {
                        lastResetTime = lastResetTime._seconds * 1000;
                    } else if (typeof lastResetTime === 'string') {
                        lastResetTime = new Date(lastResetTime).getTime();
                    }
                    var resetIntervalMs = (state.resetTimeMinutes || 1440) * 60 * 1000;
                    nextResetMs = lastResetTime + resetIntervalMs;
                }

                var remainingUses = totalLimit - usage.usedToday;
                var isExhausted = remainingUses <= 0;
                var percent = utils.getUsagePercent(usage.usedToday, totalLimit);
                var color = utils.getUsageColor(percent);

                var cardHtml = '<div class="bg-white rounded-2xl shadow-lg p-6 lg:p-8 mobile-padding hover:shadow-xl transition-all ' + (extraClass || '') + '">';
                cardHtml += '<div class="flex justify-between items-start mb-4">';
                cardHtml += '<div class="w-14 h-14 lg:w-16 lg:h-16 bg-gradient-to-br ' + tool.color + ' rounded-2xl flex items-center justify-center text-3xl lg:text-4xl shadow-lg">' + tool.emoji + '</div>';
                cardHtml += '<div class="text-right">';
                cardHtml += '<span class="text-3xl lg:text-4xl font-bold text-gray-800">' + usage.usedToday + '<span class="text-xl lg:text-2xl text-gray-400">/' + baseLimit + '</span></span>';
                if (bonusUses > 0) {
                    cardHtml += '<span class="text-lg lg:text-xl font-bold text-green-500 ml-1">+' + bonusUses + '</span>';
                }
                cardHtml += '</div>';
                cardHtml += '</div>';
                cardHtml += '<h4 class="font-bold text-gray-800 text-lg lg:text-xl mb-3">' + tool.name + '</h4>';
                cardHtml += '<div class="w-full bg-gray-100 rounded-full h-3 mb-3">';
                cardHtml += '<div class="' + color + ' h-3 rounded-full usage-bar transition-all" style="width:' + percent + '%"></div>';
                cardHtml += '</div>';

                if (isExhausted) {
                    var now = Date.now();
                    if (!nextResetMs || nextResetMs <= now) {
                        var resetIntervalMs = (state.resetTimeMinutes || 1440) * 60 * 1000;
                        nextResetMs = now + resetIntervalMs;
                    }
                    var remainingMs = Math.max(0, nextResetMs - now);
                    cardHtml += '<div class="flex items-center justify-between">';
                    cardHtml += '<p class="text-sm lg:text-base text-red-500 font-medium"> Resets in:</p>';
                    cardHtml += '<span class="quota-countdown text-red-600 font-bold text-lg" data-reset-at="' + nextResetMs + '">' + formatCountdown(remainingMs) + '</span>';
                    cardHtml += '</div>';
                } else {
                    cardHtml += '<p class="text-sm lg:text-base text-gray-500 font-medium">' + remainingUses + ' uses remaining</p>';
                }
                cardHtml += '</div>';
                return cardHtml;
            }

            // Helper function to generate compact usage cell for desktop carousel
            function generateCompactUsageCell(tool) {
                var usage = (p.usage && p.usage[tool.key]) || { usedToday: 0, limit: 2, lastResetAt: new Date().toISOString() };
                var quotaData = state.quotaInfo && state.quotaInfo[tool.key] ? state.quotaInfo[tool.key] : null;
                var totalLimit = quotaData ? quotaData.totalLimit : (usage.limit || 2);
                var baseLimit = quotaData ? quotaData.baseLimit : (usage.limit || 2);
                var bonusUses = quotaData ? quotaData.bonusUses : 0;

                var nextResetMs = 0;
                if (quotaData && quotaData.nextResetMs) {
                    nextResetMs = quotaData.nextResetMs;
                } else if (usage.lastResetAt) {
                    var lastResetTime = usage.lastResetAt;
                    if (typeof lastResetTime === 'object' && lastResetTime.seconds) {
                        lastResetTime = lastResetTime.seconds * 1000;
                    } else if (typeof lastResetTime === 'object' && lastResetTime._seconds) {
                        lastResetTime = lastResetTime._seconds * 1000;
                    } else if (typeof lastResetTime === 'string') {
                        lastResetTime = new Date(lastResetTime).getTime();
                    }
                    var resetIntervalMs = (state.resetTimeMinutes || 1440) * 60 * 1000;
                    nextResetMs = lastResetTime + resetIntervalMs;
                }

                var remainingUses = totalLimit - usage.usedToday;
                var isExhausted = remainingUses <= 0;
                var percent = utils.getUsagePercent(usage.usedToday, totalLimit);

                // Determine progress bar color class
                var progressColor = 'bg-gradient-to-r from-green-400 to-green-500';
                if (percent >= 100) {
                    progressColor = 'bg-gradient-to-r from-red-400 to-red-500';
                } else if (percent >= 50) {
                    progressColor = 'bg-gradient-to-r from-yellow-400 to-orange-500';
                }

                var cellHtml = '<div class="compact-usage-cell">';

                // Header: Icon + Info
                cellHtml += '<div class="compact-cell-header">';
                cellHtml += '<div class="compact-cell-icon bg-gradient-to-br ' + tool.color + '">' + tool.emoji + '</div>';
                cellHtml += '<div class="compact-cell-info">';
                cellHtml += '<div class="compact-cell-name">' + tool.name + '</div>';
                cellHtml += '<div class="compact-cell-usage"><strong>' + usage.usedToday + '</strong>/' + baseLimit;
                if (bonusUses > 0) {
                    cellHtml += ' <span class="compact-cell-bonus">+' + bonusUses + '</span>';
                }
                cellHtml += '</div>';
                cellHtml += '</div>';
                cellHtml += '</div>';

                // Progress bar
                cellHtml += '<div class="compact-progress-bar">';
                cellHtml += '<div class="compact-progress-fill ' + progressColor + '" style="width:' + percent + '%"></div>';
                cellHtml += '</div>';

                // Footer: remaining or countdown
                if (isExhausted) {
                    var now = Date.now();
                    if (!nextResetMs || nextResetMs <= now) {
                        var resetIntervalMs = (state.resetTimeMinutes || 1440) * 60 * 1000;
                        nextResetMs = now + resetIntervalMs;
                    }
                    var remainingMs = Math.max(0, nextResetMs - now);
                    cellHtml += '<div class="compact-cell-footer exhausted">';
                    cellHtml += ' <span class="compact-cell-countdown quota-countdown" data-reset-at="' + nextResetMs + '">' + formatCountdown(remainingMs) + '</span>';
                    cellHtml += '</div>';
                } else {
                    cellHtml += '<div class="compact-cell-footer">' + remainingUses + ' remaining</div>';
                }

                cellHtml += '</div>';
                return cellHtml;
            }

            // Desktop Carousel (hidden on mobile) - compact horizontal strip
            html += '<div class="desktop-usage-carousel fade-in" id="desktopUsageCarousel">';
            for (var i = 0; i < tools.length; i++) {
                html += generateCompactUsageCell(tools[i]);
            }
            html += '</div>';

            // Desktop Grid - kept for fallback but hidden by CSS
            html += '<div class="desktop-usage-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 dashboard-grid-4 gap-5 lg:gap-6 mb-10 fade-in">';
            for (var i = 0; i < tools.length; i++) {
                html += generateUsageCard(tools[i], '');
            }
            html += '</div>';

            // Mobile Swipeable Container (hidden on desktop)
            html += '<div class="mobile-swipe-container mb-2 fade-in" id="usageSwipeContainer">';
            for (var i = 0; i < tools.length; i++) {
                html += generateUsageCard(tools[i], 'mobile-swipe-card');
            }
            html += '</div>';

            // Mobile Swipe Dots
            html += '<div class="mobile-swipe-dots mb-8" id="usageSwipeDots">';
            for (var i = 0; i < tools.length; i++) {
                html += '<div class="mobile-swipe-dot' + (i === 0 ? ' active' : '') + '" data-index="' + i + '" onclick="app.scrollToUsageCard(' + i + ')"></div>';
            }
            html += '</div>';

            // Check if user has any bonus uses to show history link
            var hasBonusUses = false;
            var toolKeys = ['warpOptimizer', 'competitorAnalysis', 'trendPredictor', 'thumbnailGenerator'];
            for (var j = 0; j < toolKeys.length; j++) {
                var qd = state.quotaInfo && state.quotaInfo[toolKeys[j]] ? state.quotaInfo[toolKeys[j]] : null;
                if (qd && qd.bonusUses > 0) {
                    hasBonusUses = true;
                    break;
                }
            }

            // Show bonus history link if user has bonus uses
            if (hasBonusUses) {
                html += '<div class="flex justify-end mb-4 fade-in">';
                html += '<button onclick="app.openBonusHistory()" class="text-sm text-green-400 hover:text-green-300 transition-colors flex items-center gap-1">';
                html += '<span></span> View Bonus History';
                html += '</button>';
                html += '</div>';
            }

            // My Campaign Reports & Enterprise Suite Cards - Side by Side
            html += '<div class="grid grid-cols-2 gap-4 lg:gap-6 mb-8 fade-in dashboard-cards-grid">';

            // My Campaign Reports Card - with Living Aurora effect
            html += '<div class="living-aurora aurora-emerald rounded-2xl shadow-xl p-5 lg:p-8 dashboard-card cursor-pointer transition-all hover:shadow-2xl hover:scale-[1.02] relative overflow-hidden" style="transition: opacity 0.1s ease-out" onclick="this.style.opacity=\'0\'; app.goToClientReports()">';
            // Aurora orbs layer
            html += '<div class="aurora-orbs">';
            html += '<div class="aurora-orb aurora-orb-1"></div>';
            html += '<div class="aurora-orb aurora-orb-2"></div>';
            html += '<div class="aurora-orb aurora-orb-3"></div>';
            html += '<div class="aurora-orb aurora-orb-4"></div>';
            html += '</div>';
            // Glass overlay for readability
            html += '<div class="aurora-glass"></div>';
            // Shimmer effect
            html += '<div class="aurora-shimmer"></div>';
            if (state.unreadCount > 0) {
                html += '<div class="absolute top-2 right-2 lg:top-4 lg:right-4 flex items-center gap-1 lg:gap-2 z-10">';
                html += '<span class="notification-dot"></span>';
                html += '<span class="bg-white/20 text-white text-xs lg:text-sm font-bold px-2 lg:px-3 py-0.5 lg:py-1 rounded-full">' + state.unreadCount + '</span>';
                html += '</div>';
            }
            html += '<div class="aurora-content flex items-center gap-3 lg:gap-5">';
            html += '<div class="dashboard-card-icon w-12 h-12 lg:w-16 lg:h-16 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center text-2xl lg:text-4xl"></div>';
            html += '<div class="flex-1 min-w-0">';
            html += '<h3 class="dashboard-card-title text-base lg:text-2xl font-bold text-white mb-0.5 lg:mb-1 drop-shadow-sm">My Campaign Reports</h3>';
            html += '<p class="dashboard-card-subtitle text-white/90 text-xs lg:text-base truncate drop-shadow-sm">View your Google Ads performance reports</p>';
            html += '</div>';
            html += '<div class="dashboard-card-arrow text-white text-xl lg:text-3xl hidden sm:block drop-shadow-sm"></div>';
            html += '</div></div>';

            // Enterprise Suite Card - with Living Aurora effect
            html += '<a href="https://ytseo.siteuo.com/enterprise-suite" class="block" onclick="this.querySelector(\'.living-aurora\').style.opacity=\'0\'">';
            html += '<div class="living-aurora aurora-gold rounded-2xl shadow-xl p-5 lg:p-8 dashboard-card cursor-pointer transition-all hover:shadow-2xl hover:scale-[1.02] relative overflow-hidden border-2 border-yellow-300/50 h-full" style="transition: opacity 0.1s ease-out">';
            // Aurora orbs layer
            html += '<div class="aurora-orbs">';
            html += '<div class="aurora-orb aurora-orb-1"></div>';
            html += '<div class="aurora-orb aurora-orb-2"></div>';
            html += '<div class="aurora-orb aurora-orb-3"></div>';
            html += '<div class="aurora-orb aurora-orb-4"></div>';
            html += '</div>';
            // Glass overlay for readability
            html += '<div class="aurora-glass"></div>';
            // Shimmer effect
            html += '<div class="aurora-shimmer"></div>';
            html += '<div class="aurora-content flex items-center gap-3 lg:gap-5">';
            html += '<div class="dashboard-card-icon w-12 h-12 lg:w-16 lg:h-16 bg-gradient-to-br from-yellow-200/90 to-amber-300/90 backdrop-blur-sm rounded-xl flex items-center justify-center text-2xl lg:text-4xl shadow-lg"></div>';
            html += '<div class="flex-1 min-w-0">';
            html += '<div class="flex items-center gap-1 lg:gap-2 mb-0.5 lg:mb-1">';
            html += '<h3 class="dashboard-card-title text-base lg:text-2xl font-bold text-gray-900 drop-shadow-sm">Enterprise Suite</h3>';
            html += '<span class="bg-gray-900/80 text-yellow-400 text-[10px] lg:text-xs font-bold px-1.5 lg:px-2 py-0.5 lg:py-1 rounded-full backdrop-blur-sm">PRO</span>';
            html += '</div>';
            html += '<p class="dashboard-card-subtitle text-gray-800/90 text-xs lg:text-base truncate drop-shadow-sm">Bulk Optimizer, Placement Finder, Viral Predictor, Monetization & Script Writer</p>';
            html += '</div>';
            html += '<div class="dashboard-card-arrow text-gray-900 text-xl lg:text-3xl font-bold hidden sm:block drop-shadow-sm"></div>';
            html += '</div>';
            html += '</div>';
            html += '</a>';

            html += '</div>'; // End grid

            // Creative Studio Banner - Full Width
            html += '<a href="https://ytseo.siteuo.com/creative-studio" class="block mb-8 fade-in" onclick="this.querySelector(\'.living-aurora\').style.opacity=\'0\'">';
            html += '<div class="living-aurora aurora-creative rounded-2xl shadow-xl p-6 lg:p-8 cursor-pointer transition-all hover:shadow-2xl hover:scale-[1.01] relative overflow-hidden border border-purple-400/30" style="transition: opacity 0.1s ease-out">';
            // Aurora orbs layer
            html += '<div class="aurora-orbs">';
            html += '<div class="aurora-orb aurora-orb-1"></div>';
            html += '<div class="aurora-orb aurora-orb-2"></div>';
            html += '<div class="aurora-orb aurora-orb-3"></div>';
            html += '<div class="aurora-orb aurora-orb-4"></div>';
            html += '</div>';
            // Glass overlay for readability
            html += '<div class="aurora-glass"></div>';
            // Shimmer effect
            html += '<div class="aurora-shimmer"></div>';
            html += '<div class="aurora-content flex flex-col lg:flex-row items-center gap-4 lg:gap-6">';
            html += '<div class="w-16 h-16 lg:w-20 lg:h-20 bg-gradient-to-br from-purple-400/90 to-pink-500/90 backdrop-blur-sm rounded-2xl flex items-center justify-center text-4xl lg:text-5xl shadow-lg"></div>';
            html += '<div class="flex-1 text-center lg:text-left">';
            html += '<div class="flex items-center justify-center lg:justify-start gap-2 lg:gap-3 mb-1">';
            html += '<h3 class="text-xl lg:text-2xl font-bold text-white drop-shadow-sm">Creative Studio</h3>';
            html += '<span class="bg-gradient-to-r from-purple-500 to-pink-500 text-white text-[10px] lg:text-xs font-bold px-2 py-0.5 lg:py-1 rounded-full">NEW</span>';
            html += '</div>';
            html += '<p class="text-white/90 text-sm lg:text-base drop-shadow-sm">AI Image Creation, Motion, Upscaler, Canvas Editor & more - Bring your ideas to life</p>';
            html += '</div>';
            html += '<div class="text-white text-2xl lg:text-3xl font-bold drop-shadow-sm"></div>';
            html += '</div>';
            html += '</div>';
            html += '</a>';

            // Main Tools Section Title
            html += '<h2 class="text-2xl lg:text-3xl font-bold text-white mb-6 fade-in"> AI Tools</h2>';

            // Action Cards - 5 tools in responsive grid
            html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8 fade-in">';

            // Optimizer Card
            html += '<div class="bg-gradient-to-br from-white to-gray-50 rounded-3xl shadow-xl p-6 lg:p-8 tool-card cursor-pointer border border-gray-100" onclick="app.goToOptimizer()">';
            html += '<div class="w-16 h-16 lg:w-20 lg:h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center text-4xl lg:text-5xl shadow-xl mb-5"></div>';
            html += '<h3 class="text-xl lg:text-2xl font-bold text-gray-800 mb-2">Video Optimizer</h3>';
            html += '<p class="text-gray-600 mb-4 text-sm lg:text-base">AI-powered SEO optimization for your videos</p>';
            html += '<div class="flex items-center text-blue-600 font-bold group">';
            html += '<span>Optimize</span><span class="ml-2 group-hover:translate-x-2 transition-transform"></span>';
            html += '</div></div>';

            // Competitor Analysis Card (NEW)
            html += '<div class="bg-gradient-to-br from-white to-gray-50 rounded-3xl shadow-xl p-6 lg:p-8 tool-card cursor-pointer border border-gray-100 relative overflow-hidden" onclick="app.goToCompetitor()">';
            html += '<div class="absolute top-3 right-3 bg-gradient-to-r from-green-400 to-emerald-500 text-white text-xs font-bold px-2 py-1 rounded-full">NEW</div>';
            html += '<div class="w-16 h-16 lg:w-20 lg:h-20 bg-gradient-to-br from-red-500 to-orange-600 rounded-2xl flex items-center justify-center text-4xl lg:text-5xl shadow-xl mb-5"></div>';
            html += '<h3 class="text-xl lg:text-2xl font-bold text-gray-800 mb-2">Competitor Analysis</h3>';
            html += '<p class="text-gray-600 mb-4 text-sm lg:text-base">Analyze competitors and find ways to beat them</p>';
            html += '<div class="flex items-center text-red-600 font-bold group">';
            html += '<span>Analyze</span><span class="ml-2 group-hover:translate-x-2 transition-transform"></span>';
            html += '</div></div>';

            // Trend Predictor Card (NEW)
            html += '<div class="bg-gradient-to-br from-white to-gray-50 rounded-3xl shadow-xl p-6 lg:p-8 tool-card cursor-pointer border border-gray-100 relative overflow-hidden" onclick="app.goToTrends()">';
            html += '<div class="absolute top-3 right-3 bg-gradient-to-r from-green-400 to-emerald-500 text-white text-xs font-bold px-2 py-1 rounded-full">NEW</div>';
            html += '<div class="w-16 h-16 lg:w-20 lg:h-20 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-2xl flex items-center justify-center text-4xl lg:text-5xl shadow-xl mb-5"></div>';
            html += '<h3 class="text-xl lg:text-2xl font-bold text-gray-800 mb-2">Trend Predictor</h3>';
            html += '<p class="text-gray-600 mb-4 text-sm lg:text-base">Predict viral trends before they happen</p>';
            html += '<div class="flex items-center text-cyan-600 font-bold group">';
            html += '<span>Predict</span><span class="ml-2 group-hover:translate-x-2 transition-transform"></span>';
            html += '</div></div>';

            // Thumbnail Generator Card (NEW)
            html += '<div class="bg-gradient-to-br from-white to-gray-50 rounded-3xl shadow-xl p-6 lg:p-8 tool-card cursor-pointer border border-gray-100 relative overflow-hidden" onclick="app.goToThumbnail()">';
            html += '<div class="absolute top-3 right-3 bg-gradient-to-r from-green-400 to-emerald-500 text-white text-xs font-bold px-2 py-1 rounded-full">NEW</div>';
            html += '<div class="w-16 h-16 lg:w-20 lg:h-20 bg-gradient-to-br from-pink-500 to-rose-600 rounded-2xl flex items-center justify-center text-4xl lg:text-5xl shadow-xl mb-5"></div>';
            html += '<h3 class="text-xl lg:text-2xl font-bold text-gray-800 mb-2">AI Thumbnails</h3>';
            html += '<p class="text-gray-600 mb-4 text-sm lg:text-base">Generate click-worthy thumbnails with AI</p>';
            html += '<div class="flex items-center text-pink-600 font-bold group">';
            html += '<span>Generate</span><span class="ml-2 group-hover:translate-x-2 transition-transform"></span>';
            html += '</div></div>';

            // Channel Audit Pro Card (NEW - replaces Placement Finder)
            html += '<div class="bg-gradient-to-br from-white to-gray-50 rounded-3xl shadow-xl p-6 lg:p-8 tool-card cursor-pointer border border-gray-100 relative overflow-hidden" onclick="app.goToChannelAudit()">';
            html += '<div class="absolute top-3 right-3 bg-gradient-to-r from-green-400 to-emerald-500 text-white text-xs font-bold px-2 py-1 rounded-full">NEW</div>';
            html += '<div class="w-16 h-16 lg:w-20 lg:h-20 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl flex items-center justify-center text-4xl lg:text-5xl shadow-xl mb-5"></div>';
            html += '<h3 class="text-xl lg:text-2xl font-bold text-gray-800 mb-2">Channel Audit Pro</h3>';
            html += '<p class="text-gray-600 mb-4 text-sm lg:text-base">Complete channel analysis with growth recommendations</p>';
            html += '<div class="flex items-center text-emerald-600 font-bold group">';
            html += '<span>Audit Channel</span><span class="ml-2 group-hover:translate-x-2 transition-transform"></span>';
            html += '</div></div>';

            // History Card
            html += '<div class="bg-gradient-to-br from-white to-gray-50 rounded-3xl shadow-xl p-6 lg:p-8 tool-card cursor-pointer border border-gray-100" onclick="app.goToHistory()">';
            html += '<div class="w-16 h-16 lg:w-20 lg:h-20 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl flex items-center justify-center text-4xl lg:text-5xl shadow-xl mb-5"></div>';
            html += '<h3 class="text-xl lg:text-2xl font-bold text-gray-800 mb-2">History</h3>';
            html += '<p class="text-gray-600 mb-4 text-sm lg:text-base">View all your past optimizations</p>';
            html += '<div class="flex items-center text-purple-600 font-bold group">';
            html += '<span>View</span><span class="ml-2 group-hover:translate-x-2 transition-transform"></span>';
            html += '</div></div>';

            html += '</div>';

            // Admin Section (only for admins)
            if (state.isAdmin) {
                html += '<div class="mt-8 fade-in">';
                html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">';

                // Admin Dashboard Card
                html += '<div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl shadow-xl p-8 mobile-padding cursor-pointer hover:from-purple-700 hover:to-indigo-700 transition-all hover:shadow-2xl hover:scale-[1.02]" onclick="app.goToAdmin()">';
                html += '<div class="flex items-center gap-5">';
                html += '<div class="text-5xl"></div>';
                html += '<div class="flex-1">';
                html += '<h3 class="text-2xl font-bold text-white mb-1">Admin Dashboard</h3>';
                html += '<p class="text-white/80">Manage users, subscriptions & analytics</p>';
                html += '</div>';
                html += '<div class="text-white text-3xl"></div>';
                html += '</div></div>';

                // Campaign Reports Card (Admin)
                html += '<div class="bg-gradient-to-r from-amber-500 to-orange-600 rounded-2xl shadow-xl p-8 mobile-padding cursor-pointer hover:from-amber-600 hover:to-orange-700 transition-all hover:shadow-2xl hover:scale-[1.02]" onclick="app.goToAdminReports()">';
                html += '<div class="flex items-center gap-5">';
                html += '<div class="text-5xl"></div>';
                html += '<div class="flex-1">';
                html += '<h3 class="text-2xl font-bold text-white mb-1">Campaign Reports</h3>';
                html += '<p class="text-white/80">Create & send client reports</p>';
                html += '</div>';
                html += '<div class="text-white text-3xl"></div>';
                html += '</div></div>';

                html += '</div></div>';
            }

            html += '</div></div>';

            // Version Footer
            html += '<div class="text-center py-6 mt-8">';
            html += '<p class="text-white/40 text-sm">YouTube Video Optimizer v' + PLATFORM_VERSION + '</p>';
            html += '</div>';

            // Bonus History Modal
            if (state.showBonusHistory) {
                html += '<div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" onclick="app.closeBonusHistory()">';
                html += '<div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[80vh] overflow-hidden" onclick="event.stopPropagation()">';
                html += '<div class="bg-gradient-to-r from-green-500 to-emerald-600 p-6">';
                html += '<div class="flex justify-between items-center">';
                html += '<h3 class="text-xl font-bold text-white flex items-center gap-2"><span></span> Bonus History</h3>';
                html += '<button onclick="app.closeBonusHistory()" class="text-white/80 hover:text-white text-2xl">&times;</button>';
                html += '</div>';
                html += '</div>';
                html += '<div class="p-6 overflow-y-auto max-h-[60vh]">';

                if (state.bonusHistory === null) {
                    // Loading
                    html += '<div class="flex items-center justify-center py-8">';
                    html += '<div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-500"></div>';
                    html += '</div>';
                } else if (state.bonusHistory.length === 0) {
                    // No history
                    html += '<div class="text-center py-8 text-gray-500">';
                    html += '<p>No bonus history found.</p>';
                    html += '</div>';
                } else {
                    // History list
                    html += '<div class="space-y-3">';
                    var toolNames = {
                        warpOptimizer: 'Warp Optimizer',
                        competitorAnalysis: 'Competitor Analysis',
                        trendPredictor: 'Trend Predictor',
                        thumbnailGenerator: 'AI Thumbnails',
                        channelAudit: 'Channel Audit Pro'
                    };
                    var toolEmojis = {
                        warpOptimizer: '',
                        competitorAnalysis: '',
                        trendPredictor: '',
                        thumbnailGenerator: '',
                        channelAudit: ''
                    };
                    for (var h = 0; h < state.bonusHistory.length; h++) {
                        var bonus = state.bonusHistory[h];
                        var toolDisplayName = toolNames[bonus.tool] || bonus.tool;
                        var toolEmoji = toolEmojis[bonus.tool] || '';
                        var bonusDate = new Date(bonus.timestamp);
                        var dateStr = bonusDate.toLocaleDateString() + ' ' + bonusDate.toLocaleTimeString();

                        html += '<div class="bg-gray-50 rounded-lg p-4 flex items-center justify-between">';
                        html += '<div class="flex items-center gap-3">';
                        html += '<span class="text-2xl">' + toolEmoji + '</span>';
                        html += '<div>';
                        html += '<p class="font-semibold text-gray-800">' + toolDisplayName + '</p>';
                        html += '<p class="text-sm text-gray-500">' + dateStr + '</p>';
                        html += '</div>';
                        html += '</div>';
                        html += '<span class="text-xl font-bold text-green-600">+' + bonus.amount + '</span>';
                        html += '</div>';
                    }
                    html += '</div>';
                }

                html += '</div>';
                html += '</div>';
                html += '</div>';
            }

            return html;
        }

        /* ------------------------------------------
           4.6.5 Optimizer View
           ------------------------------------------ */
        function renderOptimizer() {
            var html = '';

            // Container
            html += '<div class="min-h-screen mobile-full-screen py-12 px-4 mobile-wide-container">';
            html += '<div class="max-w-4xl mx-auto">';

            // Navigation buttons
            html += '<div class="flex flex-wrap gap-3 mb-6">';
            html += '<button onclick="app.goToDashboard()" class="px-6 py-3 bg-white/20 text-white rounded-xl hover:bg-white/30"> Back</button>';
            html += '<button onclick="app.goToHistory(\'optimization\')" class="px-6 py-3 bg-white/20 text-white rounded-xl hover:bg-white/30"> View History</button>';
            html += '</div>';

            // Card
            html += '<div class="bg-white rounded-2xl shadow-xl p-8 mobile-padding fade-in">';
            html += '<h2 class="text-3xl mobile-text-xl font-bold text-gray-800 mb-4"> Video Optimizer</h2>';

            // Feature Description Section - Collapsible on mobile
            html += '<div class="mb-6">';
            html += '<div class="bg-gradient-to-r from-blue-50 via-indigo-50 to-purple-50 rounded-xl overflow-hidden border border-blue-100">';

            // Mobile: Collapsible header
            html += '<button type="button" onclick="this.parentElement.classList.toggle(\'expanded\'); this.querySelector(\'.chevron\').classList.toggle(\'rotate-180\')" class="w-full p-4 flex items-center justify-between text-left md:hidden">';
            html += '<span class="flex items-center gap-2 font-semibold text-gray-800"><span class="text-lg"></span> What can this tool do?</span>';
            html += '<svg class="chevron w-5 h-5 text-gray-500 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>';
            html += '</button>';

            // Content area
            html += '<div class="feature-info-content p-4 pt-0 md:p-5 hidden md:block">';
            html += '<p class="text-gray-700 mb-3 leading-relaxed">Transform your video\'s discoverability with AI-powered SEO optimization. Our advanced algorithms analyze your content and generate optimized metadata to help you rank higher and get more views.</p>';
            html += '<div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">';
            html += '<div class="flex items-start gap-2"><span class="text-green-500 mt-0.5"></span><span class="text-gray-600"><strong>SEO-Optimized Titles</strong>  5 click-worthy title suggestions</span></div>';
            html += '<div class="flex items-start gap-2"><span class="text-green-500 mt-0.5"></span><span class="text-gray-600"><strong>Rich Descriptions</strong>  Keyword-rich, engaging descriptions</span></div>';
            html += '<div class="flex items-start gap-2"><span class="text-green-500 mt-0.5"></span><span class="text-gray-600"><strong>Strategic Tags</strong>  High-ranking keyword tags</span></div>';
            html += '<div class="flex items-start gap-2"><span class="text-green-500 mt-0.5"></span><span class="text-gray-600"><strong>SEO Score</strong>  Before & after optimization rating</span></div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
            html += '</div>';

            // Error message (supports both string and object format)
            if (state.error) {
                var errorMsg = typeof state.error === 'string' ? state.error : state.error.message;
                var errorDetails = typeof state.error === 'object' ? state.error.details : null;
                var errorCode = typeof state.error === 'object' ? state.error.code : null;
                var errorRaw = typeof state.error === 'object' ? state.error.raw : null;

                html += '<div class="mb-6 p-4 bg-red-50 border-2 border-red-300 rounded-lg">';
                html += '<div class="flex items-start gap-3">';
                html += '<span class="text-2xl"></span>';
                html += '<div class="flex-1">';
                html += '<p class="font-bold text-red-800">' + utils.escapeHtml(errorMsg) + '</p>';

                if (errorDetails) {
                    html += '<p class="mt-2 text-sm text-red-600">' + utils.escapeHtml(errorDetails) + '</p>';
                }

                if (errorCode) {
                    html += '<div class="mt-3 pt-3 border-t border-red-200">';
                    html += '<button onclick="app.toggleErrorDetails()" class="text-xs text-red-500 hover:text-red-700 underline">Show Technical Details</button>';
                    html += '<div id="error-details" class="hidden mt-2 p-2 bg-red-100 rounded text-xs font-mono text-red-700">';
                    html += '<p><strong>Code:</strong> ' + utils.escapeHtml(errorCode) + '</p>';
                    if (errorRaw) {
                        html += '<p class="mt-1"><strong>Raw:</strong> ' + utils.escapeHtml(errorRaw) + '</p>';
                    }
                    html += '</div></div>';
                }

                html += '</div></div></div>';
            }

            // Form
            html += '<form onsubmit="app.optimize(event)">';
            html += '<div class="mb-6">';
            html += '<label class="block text-gray-700 font-semibold mb-2">YouTube Video URL</label>';
            html += '<input type="text" id="video-url" placeholder="https://www.youtube.com/watch?v=..." class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none" required />';
            html += '</div>';

            html += '<button type="submit" class="btn-primary"';
            if (state.loading) html += ' disabled';
            html += '>';
            html += state.loading ? ' Optimizing...' : ' Optimize Video';
            html += '</button>';
            html += '</form>';

            // Professional Loading Animation
            if (state.loading) {
                var progress = Math.round(state.loadingProgress);
                var currentStep = state.loadingStep;
                var tips = [
                    ' Tip: Titles with numbers get 36% more clicks!',
                    ' Did you know? Descriptions over 200 words rank higher.',
                    ' Pro tip: Use 8-15 relevant tags for best results.',
                    ' Fun fact: Question-based titles increase engagement by 23%.'
                ];
                var randomTip = tips[Math.floor(progress / 25) % tips.length];

                html += '<div class="mt-8 loading-container fade-in">';

                // Header with emoji and percentage
                html += '<div class="flex flex-col md:flex-row items-center justify-between gap-6 mb-8">';
                html += '<div class="flex items-center gap-4">';
                html += '<div class="loading-emoji"></div>';
                html += '<div>';
                html += '<h3 class="text-2xl font-bold text-gray-800">Optimizing Your Video</h3>';
                html += '<p class="text-gray-500">AI magic in progress...</p>';
                html += '</div></div>';
                html += '<div class="progress-percentage">' + progress + '%</div>';
                html += '</div>';

                // Progress Bar
                html += '<div class="mb-8">';
                html += '<div class="progress-bar-container">';
                html += '<div class="progress-bar-fill" style="width: ' + progress + '%"></div>';
                html += '</div>';
                html += '</div>';

                // Steps Grid
                html += '<div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6">';
                for (var s = 0; s < state.loadingSteps.length; s++) {
                    var step = state.loadingSteps[s];
                    var stepStatus = s < currentStep ? 'completed' : (s === currentStep ? 'active' : 'pending');
                    var iconStatus = stepStatus;

                    html += '<div class="loading-step ' + stepStatus + '">';
                    html += '<div class="step-icon ' + iconStatus + '">';
                    if (stepStatus === 'completed') {
                        html += '';
                    } else {
                        html += step.icon;
                    }
                    html += '</div>';
                    html += '<span class="text-sm font-medium ' + (stepStatus === 'pending' ? 'text-gray-400' : 'text-gray-700') + '">' + step.name + '</span>';
                    html += '</div>';
                }
                html += '</div>';

                // Tip
                html += '<div class="loading-tip">';
                html += '<p class="text-sm text-indigo-700">' + randomTip + '</p>';
                html += '</div>';

                html += '</div>';
            }

            html += '</div></div></div>';

            return html;
        }

        /* ------------------------------------------
           4.6.6 Results View (Tabbed Interface)
           ------------------------------------------ */
        function renderResults() {
            if (!state.currentResults) {
                return '<div class="text-white text-center py-12">No results available. <button onclick="app.goToOptimizer()" class="underline">Optimize a video</button></div>';
            }

            const r = state.currentResults;
            const tab = state.resultsTab || 'titles';
            var html = '';

            // Container - mobile-wide-container for expanded width on mobile
            html += '<div class="min-h-screen mobile-full-screen py-6 px-4 mobile-wide-container">';
            html += '<div class="max-w-4xl mx-auto">';

            // Header with navigation
            html += '<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4 fade-in">';
            html += '<h1 class="text-2xl sm:text-3xl font-bold text-white"> Optimization Results</h1>';
            html += '<div class="flex gap-2 w-full sm:w-auto">';
            html += '<button onclick="app.goToDashboard()" class="flex-1 sm:flex-none btn-secondary text-sm sm:text-base"> Dashboard</button>';
            html += '<button onclick="app.goToOptimizer()" class="flex-1 sm:flex-none btn-secondary text-sm sm:text-base"> New</button>';
            html += '</div></div>';

            // SEO Score Card (Before/After) - improved mobile layout
            html += '<div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 mb-6 fade-in">';

            // Before Score (estimated based on video metadata)
            var beforeScore = Math.min(45, Math.round((r.videoInfo?.viewCount || 0) / 100000 * 10) + 25);
            var afterScore = r.seoAnalysis?.score || 85;
            var improvement = afterScore - beforeScore;

            // Scores container - horizontal on all screens with responsive sizing
            html += '<div class="flex flex-row items-center justify-center gap-2 sm:gap-6 md:gap-8 flex-wrap">';

            // Before Score
            html += '<div class="text-center">';
            html += '<p class="text-xs sm:text-sm font-medium text-gray-500 mb-2">Current SEO</p>';
            html += '<div class="score-gauge">';
            html += '<svg class="score-circle w-24 h-24 sm:w-32 sm:h-32 md:w-[140px] md:h-[140px]" viewBox="0 0 140 140">';
            html += '<circle class="score-circle-bg" cx="70" cy="70" r="58"></circle>';
            var beforeDash = (beforeScore / 100) * 364;
            html += '<circle class="score-circle-fill" cx="70" cy="70" r="58" stroke="#ef4444" stroke-dasharray="' + beforeDash + ' 364"></circle>';
            html += '</svg>';
            html += '<div class="score-value text-red-500 text-2xl sm:text-3xl md:text-4xl">' + beforeScore + '</div>';
            html += '</div>';
            html += '</div>';

            // Arrow - always horizontal
            html += '<div class="text-2xl sm:text-4xl md:text-5xl text-gray-300"></div>';

            // After Score
            html += '<div class="text-center">';
            html += '<p class="text-xs sm:text-sm font-medium text-gray-500 mb-2">After Optimization</p>';
            html += '<div class="score-gauge">';
            html += '<svg class="score-circle w-24 h-24 sm:w-32 sm:h-32 md:w-[140px] md:h-[140px]" viewBox="0 0 140 140">';
            html += '<circle class="score-circle-bg" cx="70" cy="70" r="58"></circle>';
            var afterDash = (afterScore / 100) * 364;
            var afterColor = afterScore >= 80 ? '#22c55e' : afterScore >= 60 ? '#eab308' : '#ef4444';
            html += '<circle class="score-circle-fill" cx="70" cy="70" r="58" stroke="' + afterColor + '" stroke-dasharray="' + afterDash + ' 364"></circle>';
            html += '</svg>';
            html += '<div class="score-value text-2xl sm:text-3xl md:text-4xl" style="color:' + afterColor + '">' + afterScore + '</div>';
            html += '</div>';
            html += '</div>';

            // Improvement badge - inline on larger screens, below on mobile
            html += '<div class="text-center bg-gradient-to-br from-green-50 to-emerald-100 px-4 sm:px-8 py-3 sm:py-5 rounded-2xl border border-green-200 w-full sm:w-auto mt-4 sm:mt-0">';
            html += '<p class="text-2xl sm:text-3xl md:text-4xl font-bold text-green-600">+' + improvement + '%</p>';
            html += '<p class="text-xs sm:text-sm font-medium text-green-700 mt-1">SEO Improvement</p>';
            html += '</div>';

            html += '</div></div>';

            // Video Info (Compact)
            if (r.videoInfo) {
                html += '<div class="bg-white/10 rounded-xl p-4 mb-4 fade-in">';
                html += '<div class="flex items-center gap-4">';
                if (r.videoInfo.thumbnail) {
                    html += '<img src="' + utils.escapeHtml(r.videoInfo.thumbnail) + '" class="w-24 h-14 object-cover rounded-lg" alt="Thumbnail" />';
                }
                html += '<div class="flex-1 min-w-0">';
                html += '<p class="text-white font-semibold truncate">' + utils.escapeHtml(r.videoInfo.title || 'N/A') + '</p>';
                html += '<p class="text-white/70 text-sm">' + utils.escapeHtml(r.videoInfo.channelTitle || '') + '  ' + utils.formatNumber(r.videoInfo.viewCount || 0) + ' views</p>';
                html += '</div></div></div>';
            }

            // Main Content Card with Tabs - reduced padding on mobile
            html += '<div class="bg-white rounded-2xl shadow-xl p-3 sm:p-6 fade-in">';

            // Tabs
            html += '<div class="tabs-container">';
            html += '<button onclick="app.setResultsTab(\'titles\')" class="tab-btn ' + (tab === 'titles' ? 'active' : '') + '"> Titles</button>';
            html += '<button onclick="app.setResultsTab(\'description\')" class="tab-btn ' + (tab === 'description' ? 'active' : '') + '"> Description</button>';
            html += '<button onclick="app.setResultsTab(\'tags\')" class="tab-btn ' + (tab === 'tags' ? 'active' : '') + '"> Tags</button>';
            html += '</div>';

            // Tab Content
            html += '<div class="tab-content">';

            if (tab === 'titles') {
                // Titles Tab
                if (r.titles && r.titles.length > 0) {
                    html += '<div class="space-y-3">';
                    var titleLabels = [' Clickbait Style', ' SEO Optimized', ' Question Format'];
                    for (var i = 0; i < r.titles.length; i++) {
                        var titleId = 'title-' + i;
                        var escapedTitle = utils.escapeJs(r.titles[i]);
                        html += '<div class="p-4 bg-gradient-to-r from-gray-50 to-white rounded-xl border-2 border-gray-100 hover:border-purple-300 transition-all">';
                        html += '<p class="text-xs text-purple-600 font-semibold mb-1">' + (titleLabels[i] || 'Title ' + (i+1)) + '</p>';
                        html += '<div class="flex justify-between items-start gap-3">';
                        html += '<p class="flex-1 text-lg font-medium text-gray-800">' + utils.escapeHtml(r.titles[i]) + '</p>';
                        html += '<button id="' + titleId + '-btn" onclick="app.copyToClipboard(\'' + escapedTitle + '\', \'' + titleId + '-btn\')" class="px-4 py-2 bg-purple-500 text-white text-sm rounded-lg hover:bg-purple-600 whitespace-nowrap transition-all"> Copy</button>';
                        html += '</div></div>';
                    }
                    html += '</div>';
                } else {
                    html += '<p class="text-gray-500 text-center py-8">No titles generated</p>';
                }
            } else if (tab === 'description') {
                // Description Tab
                if (r.description) {
                    var escapedDesc = utils.escapeJs(r.description);
                    html += '<div class="relative">';
                    html += '<div class="p-4 bg-gray-50 rounded-xl border-2 border-gray-200 max-h-96 overflow-y-auto">';
                    html += '<pre class="text-gray-800 whitespace-pre-wrap font-sans text-sm leading-relaxed">' + utils.escapeHtml(r.description) + '</pre>';
                    html += '</div>';
                    html += '<button id="desc-btn" onclick="app.copyToClipboard(\'' + escapedDesc + '\', \'desc-btn\')" class="mt-4 w-full py-3 bg-purple-500 text-white font-semibold rounded-lg hover:bg-purple-600 transition-all"> Copy Full Description</button>';
                    html += '</div>';
                } else {
                    html += '<p class="text-gray-500 text-center py-8">No description generated</p>';
                }
            } else if (tab === 'tags') {
                // Tags Tab
                if (r.tags && r.tags.length > 0) {
                    var escapedTags = utils.escapeJs(r.tags.join(', '));
                    html += '<div class="mb-4">';
                    html += '<p class="text-sm text-gray-500 mb-3">' + r.tags.length + ' tags generated</p>';
                    html += '<div class="flex flex-wrap gap-2 max-h-64 overflow-y-auto p-2">';
                    for (var j = 0; j < r.tags.length; j++) {
                        html += '<span class="inline-block px-3 py-1.5 bg-gradient-to-r from-purple-100 to-blue-100 text-purple-700 rounded-full text-sm font-medium hover:from-purple-200 hover:to-blue-200 transition-all cursor-default">' + utils.escapeHtml(r.tags[j]) + '</span>';
                    }
                    html += '</div></div>';
                    html += '<button id="tags-btn" onclick="app.copyToClipboard(\'' + escapedTags + '\', \'tags-btn\')" class="w-full py-3 bg-purple-500 text-white font-semibold rounded-lg hover:bg-purple-600 transition-all"> Copy All Tags</button>';
                } else {
                    html += '<p class="text-gray-500 text-center py-8">No tags generated</p>';
                }
            }

            html += '</div>'; // End tab-content
            html += '</div>'; // End main card

            // Recommendations (if any)
            if (r.seoAnalysis?.recommendations && r.seoAnalysis.recommendations.length > 0) {
                html += '<div class="mt-4 p-4 bg-white/10 rounded-xl fade-in">';
                html += '<p class="text-white font-semibold mb-2"> Tips to improve further:</p>';
                html += '<ul class="text-white/80 text-sm space-y-1">';
                for (var k = 0; k < r.seoAnalysis.recommendations.length; k++) {
                    html += '<li> ' + utils.escapeHtml(r.seoAnalysis.recommendations[k]) + '</li>';
                }
                html += '</ul></div>';
            }

            // Thumbnail Generator CTA
            html += '<div class="mt-6 p-6 bg-gradient-to-r from-pink-500/20 to-purple-500/20 rounded-2xl border border-white/20 fade-in">';
            html += '<div class="flex flex-col sm:flex-row items-center justify-between gap-4">';
            html += '<div class="text-center sm:text-left">';
            html += '<h3 class="text-xl font-bold text-white mb-1"> Create an Eye-Catching Thumbnail</h3>';
            html += '<p class="text-white/70 text-sm">Use AI to generate a professional thumbnail based on your optimized video content</p>';
            html += '</div>';
            html += '<button onclick="app.goToThumbnail(true)" class="whitespace-nowrap px-6 py-3 bg-gradient-to-r from-pink-500 to-purple-600 text-white font-bold rounded-xl hover:from-pink-600 hover:to-purple-700 transition-all shadow-lg hover:shadow-xl transform hover:scale-105">';
            html += ' Generate Thumbnail';
            html += '</button>';
            html += '</div></div>';

            html += '</div></div>';

            return html;
        }

        /* ------------------------------------------
           4.6.7 History View
           ------------------------------------------ */
        function renderHistory() {
            var html = '';
            var counts = state.historyCounts || {};

            // Container
            html += '<div class="min-h-screen mobile-full-screen py-6 px-4 mobile-wide-container">';
            html += '<div class="max-w-6xl mx-auto">';

            // Header
            html += '<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4 fade-in">';
            html += '<h1 class="text-3xl mobile-text-xl font-bold text-white"> Activity History</h1>';
            html += '<button onclick="app.goToDashboard()" class="btn-secondary w-full sm:w-auto"> Back to Dashboard</button>';
            html += '</div>';

            // Success message
            if (state.success) {
                html += '<div class="mb-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg fade-in">';
                html += '<p>' + utils.escapeHtml(state.success) + '</p>';
                html += '</div>';
            }

            // Loading state
            if (state.loading) {
                html += '<div class="text-center py-12">';
                html += '<div class="spinner mx-auto mb-4"></div>';
                html += '<p class="text-white">Loading history...</p>';
                html += '</div>';
            }
            // Error state
            else if (state.error) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-8 mobile-padding text-center">';
                html += '<p class="text-red-600 font-semibold"> ' + utils.escapeHtml(state.error) + '</p>';
                html += '<button onclick="app.goToHistory()" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Try Again</button>';
                html += '</div>';
            }
            else {
                // Tab Navigation - Horizontally scrollable for mobile
                html += '<div class="bg-white rounded-xl shadow-lg mb-6 fade-in overflow-hidden">';
                html += '<div class="history-tabs-container flex flex-nowrap overflow-x-auto border-b border-gray-200 scrollbar-hide">';

                var tabs = [
                    { id: 'all', label: 'All', icon: '', count: (counts.optimizations || 0) + (counts.competitor || 0) + (counts.trends || 0) + (counts.thumbnails || 0) + (counts.placements || 0) + (counts.channelAudit || 0) },
                    { id: 'optimization', label: 'Video', icon: '', count: counts.optimizations || 0 },
                    { id: 'competitor', label: 'Competitor', icon: '', count: counts.competitor || 0 },
                    { id: 'trend', label: 'Trends', icon: '', count: counts.trends || 0 },
                    { id: 'thumbnail', label: 'Thumbnails', icon: '', count: counts.thumbnails || 0 },
                    { id: 'placement', label: 'Placements', icon: '', count: counts.placements || 0 },
                    { id: 'channelAudit', label: 'Audit', icon: '', count: counts.channelAudit || 0 }
                ];

                for (var t = 0; t < tabs.length; t++) {
                    var tab = tabs[t];
                    var isActive = state.historyTab === tab.id;
                    var tabClass = isActive
                        ? 'border-b-2 border-blue-500 text-blue-600 bg-blue-50'
                        : 'text-gray-600 hover:text-gray-800 hover:bg-gray-50';
                    html += '<button onclick="app.setHistoryTab(\'' + tab.id + '\')" class="history-tab-btn flex-shrink-0 whitespace-nowrap px-4 py-3 text-sm font-medium ' + tabClass + ' transition-colors">';
                    html += '<span class="hidden sm:inline">' + tab.icon + ' </span>' + tab.label;
                    if (tab.count > 0) {
                        html += ' <span class="inline-flex items-center justify-center px-2 py-0.5 text-xs font-bold rounded-full ' + (isActive ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700') + '">' + tab.count + '</span>';
                    }
                    html += '</button>';
                }
                html += '</div></div>';

                // Get items based on current tab
                var items = [];
                var itemType = state.historyTab;

                if (state.historyTab === 'all') {
                    items = state.allHistory || [];
                } else if (state.historyTab === 'optimization') {
                    items = state.historyData || [];
                } else if (state.historyTab === 'competitor') {
                    items = state.competitorHistory || [];
                } else if (state.historyTab === 'trend') {
                    items = state.trendHistory || [];
                } else if (state.historyTab === 'thumbnail') {
                    items = state.thumbnailHistory || [];
                } else if (state.historyTab === 'placement') {
                    items = state.placementHistory || [];
                } else if (state.historyTab === 'channelAudit') {
                    items = state.channelAuditHistory || [];
                }

                // Empty state for current tab
                if (!items || items.length === 0) {
                    html += '<div class="bg-white rounded-2xl shadow-xl p-12 mobile-padding text-center fade-in">';
                    html += '<div class="text-6xl mb-4"></div>';
                    html += '<h2 class="text-2xl mobile-text-lg font-bold text-gray-800 mb-2">No History Yet</h2>';
                    html += '<p class="text-gray-600 mb-6">Start using tools to see your history here!</p>';
                    html += '<button onclick="app.goToDashboard()" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold rounded-lg hover:from-blue-700 hover:to-purple-700"> Go to Dashboard</button>';
                    html += '</div>';
                }
                // History list
                else {
                    html += '<div class="space-y-4 fade-in">';

                    for (var i = 0; i < items.length; i++) {
                        var item = items[i];
                        var type = state.historyTab === 'all' ? item.type : state.historyTab;
                        var timestamp = item.timestamp || item.createdAt;
                        var dateInfo = utils.formatDate(timestamp);

                        html += '<div class="bg-white rounded-xl shadow-lg p-6 mobile-padding hover:shadow-xl transition-all">';
                        html += '<div class="flex flex-col sm:flex-row justify-between items-start gap-4">';

                        // Type badge
                        var typeBadge = '';
                        var typeIcon = '';
                        var typeColor = '';
                        switch(type) {
                            case 'optimization':
                                typeIcon = '';
                                typeBadge = 'Video Optimization';
                                typeColor = 'bg-blue-100 text-blue-800';
                                break;
                            case 'competitor':
                                typeIcon = '';
                                typeBadge = 'Competitor Analysis';
                                typeColor = 'bg-purple-100 text-purple-800';
                                break;
                            case 'trend':
                                typeIcon = '';
                                typeBadge = 'Trend Prediction';
                                typeColor = 'bg-green-100 text-green-800';
                                break;
                            case 'thumbnail':
                                typeIcon = '';
                                typeBadge = 'Thumbnail';
                                typeColor = 'bg-orange-100 text-orange-800';
                                break;
                            case 'placement':
                                typeIcon = '';
                                typeBadge = 'Placement Finder';
                                typeColor = 'bg-violet-100 text-violet-800';
                                break;
                            case 'channelAudit':
                                typeIcon = '';
                                typeBadge = 'Channel Audit';
                                typeColor = 'bg-teal-100 text-teal-800';
                                break;
                        }

                        // Info section
                        html += '<div class="flex-1">';

                        // Type badge (only show in "all" tab)
                        if (state.historyTab === 'all') {
                            html += '<span class="inline-block px-2 py-1 text-xs font-semibold rounded-full ' + typeColor + ' mb-2">' + typeIcon + ' ' + typeBadge + '</span>';
                        }

                        // Title based on type
                        var title = '';
                        var subtitle = '';
                        switch(type) {
                            case 'optimization':
                                title = (item.videoInfo && item.videoInfo.title) ? item.videoInfo.title : 'Video Optimization';
                                if (item.titles && item.titles.length > 0) {
                                    subtitle = '<strong>Best Title:</strong> ' + utils.escapeHtml(item.titles[0]);
                                }
                                break;
                            case 'competitor':
                                title = (item.competitor && item.competitor.title) ? item.competitor.title : 'Competitor Analysis';
                                if (item.competitor && item.competitor.channelTitle) {
                                    subtitle = '<strong>Channel:</strong> ' + utils.escapeHtml(item.competitor.channelTitle);
                                }
                                break;
                            case 'trend':
                                title = item.niche ? 'Trends: ' + item.niche : 'Trend Analysis';
                                subtitle = '<strong>Country:</strong> ' + (item.country || 'US') + ' | <strong>Videos Analyzed:</strong> ' + (item.analyzedVideos || 0);
                                break;
                            case 'thumbnail':
                                title = item.title || 'AI Thumbnail';
                                subtitle = '<strong>Style:</strong> ' + (item.style || 'Default');
                                break;
                            case 'placement':
                                title = (item.channelInfo && item.channelInfo.name) ? item.channelInfo.name : 'Placement Search';
                                subtitle = '<strong>Channels Found:</strong> ' + (item.totalFound || 0) + ' | <strong>Niche:</strong> ' + ((item.analysis && item.analysis.niche) || 'N/A');
                                break;
                            case 'channelAudit':
                                title = (item.channelInfo && item.channelInfo.name) ? item.channelInfo.name : 'Channel Audit';
                                var overallScore = (item.scores && item.scores.overall) || 0;
                                subtitle = '<strong>Overall Score:</strong> ' + overallScore + '/100 | <strong>Subscribers:</strong> ' + utils.formatNumber((item.channelInfo && item.channelInfo.subscribers) || 0);
                                break;
                        }

                        html += '<h3 class="font-bold text-lg text-gray-800 mb-2">' + utils.escapeHtml(title) + '</h3>';
                        html += '<div class="flex flex-wrap gap-4 text-sm text-gray-600 mb-2">';
                        html += '<span> ' + dateInfo.date + '</span>';
                        html += '<span> ' + dateInfo.time + '</span>';
                        html += '</div>';

                        if (subtitle) {
                            html += '<p class="text-sm text-gray-700">' + subtitle + '</p>';
                        }

                        // Show thumbnail preview for thumbnail items
                        if (type === 'thumbnail' && item.imageUrl) {
                            html += '<div class="mt-3"><img src="' + utils.escapeHtml(item.imageUrl) + '" alt="Thumbnail" class="h-20 rounded-lg shadow-sm"></div>';
                        }

                        html += '</div>';

                        // Action buttons
                        html += '<div class="flex gap-2 flex-shrink-0">';

                        // View button based on type
                        switch(type) {
                            case 'optimization':
                                html += '<button onclick="app.viewHistoryItem(' + (state.historyTab === 'all' ? 'null, \'' + item.id + '\'' : i) + ')" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 whitespace-nowrap text-sm"> View</button>';
                                break;
                            case 'competitor':
                                html += '<button onclick="app.viewCompetitorHistory(' + (state.historyTab === 'all' ? 'null, \'' + item.id + '\'' : i) + ')" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 whitespace-nowrap text-sm"> View</button>';
                                break;
                            case 'trend':
                                html += '<button onclick="app.viewTrendHistory(' + (state.historyTab === 'all' ? 'null, \'' + item.id + '\'' : i) + ')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 whitespace-nowrap text-sm"> View</button>';
                                break;
                            case 'thumbnail':
                                html += '<button onclick="app.viewThumbnailHistory(' + (state.historyTab === 'all' ? 'null, \'' + item.id + '\'' : i) + ')" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 whitespace-nowrap text-sm"> View</button>';
                                break;
                            case 'placement':
                                html += '<button onclick="app.viewPlacementHistory(\'' + item.id + '\')" class="px-4 py-2 bg-violet-500 text-white rounded-lg hover:bg-violet-600 whitespace-nowrap text-sm"> View</button>';
                                break;
                            case 'channelAudit':
                                html += '<button onclick="app.viewChannelAuditHistory(\'' + item.id + '\')" class="px-4 py-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 whitespace-nowrap text-sm"> View</button>';
                                break;
                        }

                        // Delete button
                        html += '<button onclick="app.deleteHistoryItem(\'' + type + '\', \'' + item.id + '\', ' + i + ')" class="px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 whitespace-nowrap text-sm"></button>';

                        html += '</div>';

                        html += '</div></div>';
                    }

                    html += '</div>';
                }
            }

            html += '</div></div>';

            return html;
        }

        /* ------------------------------------------
           4.6.8 Admin Dashboard View
           ------------------------------------------ */
        function renderAdmin() {
            var html = '';

            // Container
            html += '<div class="min-h-screen mobile-full-screen py-6 px-4 mobile-wide-container">';
            html += '<div class="max-w-6xl mx-auto">';

            // Header
            html += '<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4 fade-in">';
            html += '<h1 class="text-3xl mobile-text-xl font-bold text-white"> Admin Dashboard</h1>';
            html += '<button onclick="app.goToDashboard()" class="btn-secondary w-full sm:w-auto"> Back to Dashboard</button>';
            html += '</div>';

            // Success message
            if (state.success) {
                html += '<div class="mb-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg fade-in">';
                html += '<p>' + utils.escapeHtml(state.success) + '</p>';
                html += '</div>';
            }

            // Error message
            if (state.error) {
                var errorMsg = typeof state.error === 'string' ? state.error : state.error.message;
                html += '<div class="mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg fade-in">';
                html += '<p>' + utils.escapeHtml(errorMsg) + '</p>';
                html += '</div>';
            }

            // Stats Cards
            html += '<div class="grid grid-cols-1 sm:grid-cols-3 gap-5 mb-8 fade-in">';
            var totalUsers = state.adminUsers ? state.adminUsers.length : 0;
            var proUsers = state.adminUsers ? state.adminUsers.filter(function(u) { return u.subscription && u.subscription.plan === 'pro'; }).length : 0;
            var freeUsers = state.adminUsers ? state.adminUsers.filter(function(u) { return !u.subscription || u.subscription.plan === 'free'; }).length : 0;

            html += '<div class="bg-white rounded-2xl p-8 text-center shadow-lg border border-gray-100">';
            html += '<div class="text-5xl mb-3"></div>';
            html += '<p class="text-5xl font-bold text-gray-800 mb-2">' + totalUsers + '</p>';
            html += '<p class="text-gray-600 font-medium text-lg">Total Users</p>';
            html += '</div>';

            html += '<div class="bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl p-8 text-center shadow-lg">';
            html += '<div class="text-5xl mb-3"></div>';
            html += '<p class="text-5xl font-bold text-white mb-2">' + proUsers + '</p>';
            html += '<p class="text-white/90 font-medium text-lg">Pro Users</p>';
            html += '</div>';

            html += '<div class="bg-white rounded-2xl p-8 text-center shadow-lg border border-gray-100">';
            html += '<div class="text-5xl mb-3"></div>';
            html += '<p class="text-5xl font-bold text-gray-500 mb-2">' + freeUsers + '</p>';
            html += '<p class="text-gray-600 font-medium text-lg">Free Users</p>';
            html += '</div>';
            html += '</div>';

            // Users Table
            html += '<div class="bg-white rounded-2xl shadow-xl p-8 mobile-padding fade-in">';
            html += '<h2 class="text-2xl font-bold text-gray-800 mb-6"> User Management</h2>';

            if (state.adminLoading) {
                html += '<div class="text-center py-8">';
                html += '<div class="spinner spinner-dark mx-auto mb-4"></div>';
                html += '<p class="text-gray-600">Loading users...</p>';
                html += '</div>';
            } else if (!state.adminUsers || state.adminUsers.length === 0) {
                html += '<p class="text-gray-500 text-center py-8">No users found</p>';
            } else {
                html += '<div class="overflow-x-auto">';
                html += '<table class="w-full text-left">';
                html += '<thead class="bg-gray-50 rounded-lg">';
                html += '<tr>';
                html += '<th class="px-6 py-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">User</th>';
                html += '<th class="px-6 py-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Plan</th>';
                html += '<th class="px-6 py-4 text-sm font-semibold text-gray-600 uppercase tracking-wider hidden sm:table-cell">Usage</th>';
                html += '<th class="px-6 py-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Actions</th>';
                html += '</tr></thead>';
                html += '<tbody class="divide-y divide-gray-100">';

                for (var i = 0; i < state.adminUsers.length; i++) {
                    var user = state.adminUsers[i];
                    var plan = user.subscription ? user.subscription.plan : 'free';
                    var planColor = plan === 'pro' ? 'bg-purple-100 text-purple-800' : plan === 'lite' ? 'bg-blue-100 text-blue-800' : plan === 'enterprise' ? 'bg-amber-100 text-amber-800' : 'bg-gray-100 text-gray-800';

                    // Calculate total limit including bonus uses
                    var baseLimit = user.usage && user.usage.warpOptimizer ? user.usage.warpOptimizer.limit : 0;
                    var bonusUses = user.bonusUses && user.bonusUses.warpOptimizer ? user.bonusUses.warpOptimizer : 0;
                    var totalLimit = baseLimit + bonusUses;
                    var usedToday = user.usage && user.usage.warpOptimizer ? user.usage.warpOptimizer.usedToday : 0;
                    var usageInfo = usedToday + '/' + totalLimit;
                    var bonusIndicator = bonusUses > 0 ? ' <span class="text-green-600 text-xs">(+' + bonusUses + ')</span>' : '';

                    html += '<tr class="hover:bg-gray-50 transition-colors">';
                    html += '<td class="px-6 py-5">';
                    html += '<p class="font-semibold text-gray-800 text-base">' + utils.escapeHtml(user.email || 'No email') + '</p>';
                    html += '<p class="text-sm text-gray-500 mt-1">ID: ' + utils.escapeHtml(user.uid ? user.uid.substring(0, 12) + '...' : '') + '</p>';
                    html += '</td>';
                    html += '<td class="px-6 py-5">';
                    html += '<span class="px-3 py-1.5 text-sm font-semibold rounded-full ' + planColor + '">' + plan.toUpperCase() + '</span>';
                    html += '</td>';
                    html += '<td class="px-6 py-5 hidden sm:table-cell">';
                    html += '<span class="text-base text-gray-700 font-medium">' + usageInfo + '</span>' + bonusIndicator;
                    html += '<span class="text-sm text-gray-500 ml-1">today</span>';
                    html += '</td>';
                    html += '<td class="px-6 py-5">';
                    html += '<select onchange="app.updateUserPlan(\'' + user.uid + '\', this.value)" class="text-base border-2 border-gray-200 rounded-lg px-3 py-2 focus:border-purple-500 focus:outline-none transition-colors">';
                    html += '<option value="free"' + (plan === 'free' ? ' selected' : '') + '>Free</option>';
                    html += '<option value="lite"' + (plan === 'lite' ? ' selected' : '') + '>Lite</option>';
                    html += '<option value="pro"' + (plan === 'pro' ? ' selected' : '') + '>Pro</option>';
                    html += '<option value="enterprise"' + (plan === 'enterprise' ? ' selected' : '') + '>Enterprise</option>';
                    html += '</select>';
                    html += '</td>';
                    html += '</tr>';
                }

                html += '</tbody></table></div>';
            }

            html += '</div>';

            // Quota Settings Section
            html += '<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">';

            // Reset Time Settings
            html += '<div class="bg-white rounded-2xl shadow-xl p-8 mobile-padding fade-in">';
            html += '<h2 class="text-2xl font-bold text-gray-800 mb-4"> Quota Reset Time</h2>';
            html += '<p class="text-gray-600 mb-6">Set how often user quotas reset (in minutes). Default is 1440 minutes (24 hours).</p>';
            html += '<div class="flex gap-4 items-end">';
            html += '<div class="flex-1">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Reset Interval (minutes)</label>';
            html += '<input type="number" id="reset-time-input" value="' + (state.resetTimeMinutes || 1440) + '" min="1" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-lg" />';
            html += '<p class="text-sm text-gray-500 mt-2">Examples: 60 = 1 hour, 240 = 4 hours, 1440 = 24 hours</p>';
            html += '</div>';
            html += '<button onclick="app.setQuotaResetTime()" class="px-6 py-3 bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold rounded-xl hover:from-purple-600 hover:to-indigo-700 transition-all">Save</button>';
            html += '</div>';
            html += '</div>';

            // Grant Bonus Uses
            html += '<div class="bg-white rounded-2xl shadow-xl p-8 mobile-padding fade-in">';
            html += '<h2 class="text-2xl font-bold text-gray-800 mb-4"> Grant Bonus Uses</h2>';
            html += '<p class="text-gray-600 mb-6">Give extra uses to a specific user as a gift or bonus.</p>';

            // User selector
            html += '<div class="mb-4">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Select User</label>';
            html += '<select id="bonus-user-select" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-lg">';
            html += '<option value="">-- Select a user --</option>';
            if (state.adminUsers) {
                for (var j = 0; j < state.adminUsers.length; j++) {
                    var u = state.adminUsers[j];
                    html += '<option value="' + u.uid + '">' + utils.escapeHtml(u.email || u.uid) + '</option>';
                }
            }
            html += '</select>';
            html += '</div>';

            // Tool selector
            html += '<div class="mb-4">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Select Tool</label>';
            html += '<select id="bonus-tool-select" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-lg">';
            html += '<option value="warpOptimizer">Warp Optimizer</option>';
            html += '<option value="competitorAnalysis">Competitor Analysis</option>';
            html += '<option value="trendPredictor">Trend Predictor</option>';
            html += '<option value="thumbnailGenerator">AI Thumbnails</option>';
            html += '<option value="placementFinder">Placement Finder</option>';
            html += '</select>';
            html += '</div>';

            // Amount
            html += '<div class="mb-4">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Bonus Amount</label>';
            html += '<input type="number" id="bonus-amount-input" value="5" min="1" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-lg" />';
            html += '</div>';

            html += '<button onclick="app.grantBonusUses()" class="w-full px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold rounded-xl hover:from-green-600 hover:to-emerald-700 transition-all"> Grant Bonus Uses</button>';
            html += '</div>';

            html += '</div>'; // End grid

            html += '</div></div>';

            return html;
        }

        /* ------------------------------------------
           4.6.9 Competitor Analysis View
           ------------------------------------------ */
        function renderCompetitor() {
            var html = '';

            html += '<div class="min-h-screen mobile-full-screen py-8 px-4 mobile-wide-container">';
            html += '<div class="max-w-6xl mx-auto">';

            // Navigation buttons
            html += '<div class="flex flex-wrap gap-3 mb-6">';
            html += '<button onclick="app.goToDashboard()" class="btn-secondary"> Back to Dashboard</button>';
            html += '<button onclick="app.goToHistory(\'competitor\')" class="btn-secondary"> View History</button>';
            html += '</div>';

            // Header
            html += '<div class="text-center mb-8 fade-in">';
            html += '<div class="w-20 h-20 bg-gradient-to-br from-red-500 to-orange-600 rounded-3xl flex items-center justify-center text-5xl mx-auto mb-4 shadow-xl"></div>';
            html += '<h1 class="text-3xl lg:text-4xl font-bold text-white mb-2">Competitor Analysis</h1>';
            html += '<p class="text-white/80 text-lg">Analyze any competitor video and get strategies to beat them</p>';
            html += '</div>';

            // Form Card
            if (!state.competitorResults) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-8 mobile-padding max-w-2xl mx-auto fade-in">';

                // Feature Description Section - Collapsible on mobile
                html += '<div class="mb-6">';
                html += '<div class="bg-gradient-to-r from-red-50 via-orange-50 to-amber-50 rounded-xl overflow-hidden border border-red-100">';

                // Mobile: Collapsible header
                html += '<button type="button" onclick="this.parentElement.classList.toggle(\'expanded\'); this.querySelector(\'.chevron\').classList.toggle(\'rotate-180\')" class="w-full p-4 flex items-center justify-between text-left md:hidden">';
                html += '<span class="flex items-center gap-2 font-semibold text-gray-800"><span class="text-lg"></span> How does this help?</span>';
                html += '<svg class="chevron w-5 h-5 text-gray-500 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>';
                html += '</button>';

                // Content area
                html += '<div class="feature-info-content p-4 pt-0 md:p-5 hidden md:block">';
                html += '<p class="text-gray-700 mb-3 leading-relaxed">Reverse-engineer the success of any YouTube video. Our AI analyzes competitor content to reveal their SEO strategies, strengths, and weaknesses  giving you the blueprint to outperform them.</p>';
                html += '<div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">';
                html += '<div class="flex items-start gap-2"><span class="text-red-500 mt-0.5"></span><span class="text-gray-600"><strong>SEO Breakdown</strong>  Competitor\'s optimization score</span></div>';
                html += '<div class="flex items-start gap-2"><span class="text-red-500 mt-0.5"></span><span class="text-gray-600"><strong>Strengths Analysis</strong>  What they\'re doing right</span></div>';
                html += '<div class="flex items-start gap-2"><span class="text-red-500 mt-0.5"></span><span class="text-gray-600"><strong>Weaknesses Found</strong>  Gaps you can exploit</span></div>';
                html += '<div class="flex items-start gap-2"><span class="text-red-500 mt-0.5"></span><span class="text-gray-600"><strong>Better Titles</strong>  Outrank them with superior titles</span></div>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
                html += '</div>';

                if (state.error) {
                    html += '<div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-xl text-red-700">' + utils.escapeHtml(state.error.message) + '</div>';
                }

                html += '<form onsubmit="app.analyzeCompetitor(event)">';
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-2">Competitor Video URL</label>';
                html += '<input type="text" id="competitor-url" placeholder="https://www.youtube.com/watch?v=..." class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:border-red-500 focus:outline-none text-lg" required />';
                html += '</div>';
                html += '<button type="submit" class="btn-primary bg-gradient-to-r from-red-500 to-orange-600" ' + (state.loading ? 'disabled' : '') + '>';
                html += state.loading ? ' Analyzing...' : ' Analyze Competitor';
                html += '</button>';
                html += '</form>';

                // Loading Animation
                if (state.loading) {
                    html += '<div class="mt-8 loading-container">';
                    html += '<div class="flex items-center justify-between mb-6">';
                    html += '<div class="flex items-center gap-4"><div class="loading-emoji"></div><div><h3 class="text-xl font-bold text-gray-800">Analyzing Competitor</h3></div></div>';
                    html += '<div class="progress-percentage">' + Math.round(state.loadingProgress) + '%</div>';
                    html += '</div>';
                    html += '<div class="progress-bar-container mb-4"><div class="progress-bar-fill" style="width:' + state.loadingProgress + '%"></div></div>';
                    html += '</div>';
                }

                html += '</div>';
            } else {
                // Results Display
                var r = state.competitorResults;
                var c = r.competitor;
                var a = r.analysis;

                // Competitor Info Card
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 mb-6 fade-in">';
                html += '<div class="flex flex-col md:flex-row gap-6">';
                if (c.thumbnail) {
                    html += '<img src="' + utils.escapeHtml(c.thumbnail) + '" class="w-full md:w-64 h-36 object-cover rounded-xl" />';
                }
                html += '<div class="flex-1">';
                html += '<h2 class="text-xl font-bold text-gray-800 mb-2">' + utils.escapeHtml(c.title) + '</h2>';
                html += '<p class="text-gray-600 mb-3">' + utils.escapeHtml(c.channelTitle) + '</p>';
                html += '<div class="flex flex-wrap gap-4 text-sm">';
                html += '<span class="bg-gray-100 px-3 py-1 rounded-full"> ' + utils.formatNumber(c.viewCount) + ' views</span>';
                html += '<span class="bg-gray-100 px-3 py-1 rounded-full"> ' + utils.formatNumber(c.likeCount) + ' likes</span>';
                html += '<span class="bg-gray-100 px-3 py-1 rounded-full"> ' + utils.formatNumber(c.commentCount) + ' comments</span>';
                html += '</div></div></div></div>';

                // SEO Score & Difficulty
                html += '<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 fade-in">';
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 text-center">';
                html += '<p class="text-5xl font-bold ' + (a.seoScore >= 70 ? 'text-green-500' : a.seoScore >= 50 ? 'text-yellow-500' : 'text-red-500') + '">' + a.seoScore + '</p>';
                html += '<p class="text-gray-600 font-medium">Competitor SEO Score</p>';
                html += '</div>';
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 text-center">';
                var diffColor = a.estimatedDifficulty === 'easy' ? 'text-green-500' : a.estimatedDifficulty === 'medium' ? 'text-yellow-500' : 'text-red-500';
                html += '<p class="text-4xl font-bold ' + diffColor + '">' + (a.estimatedDifficulty || 'medium').toUpperCase() + '</p>';
                html += '<p class="text-gray-600 font-medium">Difficulty to Beat</p>';
                html += '</div>';
                html += '<div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl shadow-xl p-6 text-center text-white">';
                html += '<p class="text-4xl font-bold"></p>';
                html += '<p class="font-medium">Ready to Beat!</p>';
                html += '</div></div>';

                // Analysis Sections
                html += '<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 fade-in">';

                // Strengths
                html += '<div class="bg-white rounded-2xl shadow-xl p-6">';
                html += '<h3 class="text-xl font-bold text-gray-800 mb-4"> Their Strengths</h3>';
                html += '<ul class="space-y-2">';
                (a.strengths || []).forEach(function(s) { html += '<li class="flex items-start gap-2"><span class="text-green-500"></span><span>' + utils.escapeHtml(s) + '</span></li>'; });
                html += '</ul></div>';

                // Weaknesses
                html += '<div class="bg-white rounded-2xl shadow-xl p-6">';
                html += '<h3 class="text-xl font-bold text-gray-800 mb-4"> Their Weaknesses</h3>';
                html += '<ul class="space-y-2">';
                (a.weaknesses || []).forEach(function(w) { html += '<li class="flex items-start gap-2"><span class="text-red-500"></span><span>' + utils.escapeHtml(w) + '</span></li>'; });
                html += '</ul></div>';

                // Better Titles
                html += '<div class="bg-white rounded-2xl shadow-xl p-6">';
                html += '<h3 class="text-xl font-bold text-gray-800 mb-4"> Better Titles to Use</h3>';
                html += '<ul class="space-y-2">';
                (a.betterTitles || []).forEach(function(t) { html += '<li class="p-3 bg-blue-50 rounded-lg text-blue-800 font-medium">' + utils.escapeHtml(t) + '</li>'; });
                html += '</ul></div>';

                // Opportunities
                html += '<div class="bg-white rounded-2xl shadow-xl p-6">';
                html += '<h3 class="text-xl font-bold text-gray-800 mb-4"> Opportunities</h3>';
                html += '<ul class="space-y-2">';
                (a.opportunities || []).forEach(function(o) { html += '<li class="flex items-start gap-2"><span class="text-purple-500"></span><span>' + utils.escapeHtml(o) + '</span></li>'; });
                html += '</ul></div>';
                html += '</div>';

                // Summary
                html += '<div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl shadow-xl p-6 mt-6 fade-in">';
                html += '<h3 class="text-xl font-bold text-white mb-3"> Strategy Summary</h3>';
                html += '<p class="text-white/90 text-lg">' + utils.escapeHtml(a.summary || '') + '</p>';
                html += '</div>';

                // New Analysis Button
                html += '<div class="text-center mt-8">';
                html += '<button onclick="state.competitorResults=null;render();" class="btn-secondary">Analyze Another Competitor</button>';
                html += '</div>';
            }

            html += '</div></div>';
            return html;
        }

        /* ------------------------------------------
           4.6.10 Trend Predictor View
           ------------------------------------------ */
        function renderTrends() {
            var html = '';

            html += '<div class="min-h-screen mobile-full-screen py-8 px-4 mobile-wide-container">';
            html += '<div class="max-w-6xl mx-auto">';

            // Navigation buttons
            html += '<div class="flex flex-wrap gap-3 mb-6">';
            html += '<button onclick="app.goToDashboard()" class="btn-secondary"> Back to Dashboard</button>';
            html += '<button onclick="app.goToHistory(\'trend\')" class="btn-secondary"> View History</button>';
            html += '</div>';

            html += '<div class="text-center mb-8 fade-in">';
            html += '<div class="w-20 h-20 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-3xl flex items-center justify-center text-5xl mx-auto mb-4 shadow-xl"></div>';
            html += '<h1 class="text-3xl lg:text-4xl font-bold text-white mb-2">Trend Predictor</h1>';
            html += '<p class="text-white/80 text-lg">Discover trending topics and predict what will go viral</p>';
            html += '</div>';

            if (!state.trendResults) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-8 mobile-padding max-w-2xl mx-auto fade-in">';

                // Feature Description Section - Collapsible on mobile
                html += '<div class="mb-6">';
                html += '<div class="bg-gradient-to-r from-cyan-50 via-blue-50 to-indigo-50 rounded-xl overflow-hidden border border-cyan-100">';

                // Mobile: Collapsible header
                html += '<button type="button" onclick="this.parentElement.classList.toggle(\'expanded\'); this.querySelector(\'.chevron\').classList.toggle(\'rotate-180\')" class="w-full p-4 flex items-center justify-between text-left md:hidden">';
                html += '<span class="flex items-center gap-2 font-semibold text-gray-800"><span class="text-lg"></span> What will you discover?</span>';
                html += '<svg class="chevron w-5 h-5 text-gray-500 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>';
                html += '</button>';

                // Content area
                html += '<div class="feature-info-content p-4 pt-0 md:p-5 hidden md:block">';
                html += '<p class="text-gray-700 mb-3 leading-relaxed">Stay ahead of the curve with AI-powered trend forecasting. Discover what\'s hot right now and predict future viral topics in your niche before your competitors catch on.</p>';
                html += '<div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">';
                html += '<div class="flex items-start gap-2"><span class="text-cyan-500 mt-0.5"></span><span class="text-gray-600"><strong>Current Trends</strong>  What\'s trending now in your niche</span></div>';
                html += '<div class="flex items-start gap-2"><span class="text-cyan-500 mt-0.5"></span><span class="text-gray-600"><strong>Future Predictions</strong>  Topics about to explode</span></div>';
                html += '<div class="flex items-start gap-2"><span class="text-cyan-500 mt-0.5"></span><span class="text-gray-600"><strong>Video Ideas</strong>  Ready-to-use content concepts</span></div>';
                html += '<div class="flex items-start gap-2"><span class="text-cyan-500 mt-0.5"></span><span class="text-gray-600"><strong>Trending Hashtags</strong>  Boost your discoverability</span></div>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
                html += '</div>';

                if (state.error) {
                    html += '<div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-xl text-red-700">' + utils.escapeHtml(state.error.message) + '</div>';
                }

                html += '<form onsubmit="app.predictTrends(event)">';
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-2">Your Niche / Topic</label>';
                html += '<input type="text" id="trend-niche" placeholder="e.g., Gaming, Cooking, Tech Reviews..." class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:border-cyan-500 focus:outline-none text-lg" required />';
                html += '</div>';
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-2">Country/Region</label>';
                html += '<select id="trend-country" class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:border-cyan-500 focus:outline-none text-lg">';
                html += '<option value="US">United States</option><option value="GB">United Kingdom</option><option value="CA">Canada</option>';
                html += '<option value="AU">Australia</option><option value="DE">Germany</option><option value="FR">France</option>';
                html += '<option value="IN">India</option><option value="BR">Brazil</option><option value="JP">Japan</option>';
                html += '</select></div>';
                html += '<button type="submit" class="btn-primary bg-gradient-to-r from-cyan-500 to-blue-600" ' + (state.loading ? 'disabled' : '') + '>';
                html += state.loading ? ' Predicting...' : ' Predict Trends';
                html += '</button>';
                html += '</form>';

                if (state.loading) {
                    html += '<div class="mt-8 loading-container">';
                    html += '<div class="flex items-center justify-between mb-6">';
                    html += '<div class="flex items-center gap-4"><div class="loading-emoji"></div><div><h3 class="text-xl font-bold text-gray-800">Predicting Trends</h3></div></div>';
                    html += '<div class="progress-percentage">' + Math.round(state.loadingProgress) + '%</div>';
                    html += '</div>';
                    html += '<div class="progress-bar-container mb-4"><div class="progress-bar-fill" style="width:' + state.loadingProgress + '%"></div></div>';
                    html += '</div>';
                }

                html += '</div>';
            } else {
                var r = state.trendResults;
                var p = r.predictions;

                // Current Trends
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 mb-6 fade-in">';
                html += '<h3 class="text-2xl font-bold text-gray-800 mb-4"> Current Trends in "' + utils.escapeHtml(r.niche) + '"</h3>';
                html += '<div class="grid grid-cols-1 md:grid-cols-3 gap-4">';
                (p.currentTrends || []).forEach(function(t) {
                    var gColor = t.growthRate === 'rising' ? 'text-green-500' : t.growthRate === 'stable' ? 'text-yellow-500' : 'text-red-500';
                    html += '<div class="p-4 bg-gray-50 rounded-xl">';
                    html += '<div class="flex items-center justify-between mb-2">';
                    html += '<span class="font-bold text-gray-800">' + utils.escapeHtml(t.topic) + '</span>';
                    html += '<span class="' + gColor + ' font-medium">' + (t.growthRate === 'rising' ? '' : t.growthRate === 'declining' ? '' : '') + '</span>';
                    html += '</div>';
                    html += '<p class="text-sm text-gray-600">' + utils.escapeHtml(t.description) + '</p>';
                    html += '</div>';
                });
                html += '</div></div>';

                // Predicted Trends
                html += '<div class="bg-gradient-to-br from-purple-600 to-indigo-600 rounded-2xl shadow-xl p-6 mb-6 fade-in">';
                html += '<h3 class="text-2xl font-bold text-white mb-4"> Predicted Future Trends</h3>';
                html += '<div class="grid grid-cols-1 md:grid-cols-3 gap-4">';
                (p.predictedTrends || []).forEach(function(t) {
                    var confBadge = t.confidence === 'high' ? 'bg-green-500' : t.confidence === 'medium' ? 'bg-yellow-500' : 'bg-gray-500';
                    html += '<div class="p-4 bg-white/10 backdrop-blur rounded-xl">';
                    html += '<div class="flex items-center justify-between mb-2">';
                    html += '<span class="font-bold text-white">' + utils.escapeHtml(t.topic) + '</span>';
                    html += '<span class="' + confBadge + ' text-white text-xs px-2 py-1 rounded-full">' + (t.confidence || 'medium') + '</span>';
                    html += '</div>';
                    html += '<p class="text-sm text-white/80 mb-2">' + utils.escapeHtml(t.reasoning) + '</p>';
                    html += '<p class="text-xs text-white/60"> ' + utils.escapeHtml(t.timeframe || '2-4 weeks') + '</p>';
                    html += '</div>';
                });
                html += '</div></div>';

                // Video Ideas
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 mb-6 fade-in">';
                html += '<h3 class="text-2xl font-bold text-gray-800 mb-4"> Video Ideas for You</h3>';
                html += '<div class="space-y-4">';
                (p.videoIdeas || []).forEach(function(v, i) {
                    html += '<div class="p-4 border-2 border-gray-100 rounded-xl hover:border-blue-200 transition-all">';
                    html += '<div class="flex items-start justify-between">';
                    html += '<div><span class="text-2xl mr-3">' + (i+1) + '.</span><span class="font-bold text-gray-800 text-lg">' + utils.escapeHtml(v.title) + '</span></div>';
                    html += '<span class="bg-green-100 text-green-700 text-sm px-3 py-1 rounded-full font-medium">' + utils.escapeHtml(v.estimatedViews || '50K+') + '</span>';
                    html += '</div>';
                    html += '<p class="text-gray-600 mt-2 ml-8">' + utils.escapeHtml(v.description) + '</p>';
                    html += '</div>';
                });
                html += '</div></div>';

                // Hashtags
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 fade-in">';
                html += '<h3 class="text-xl font-bold text-gray-800 mb-4"># Trending Hashtags</h3>';
                html += '<div class="flex flex-wrap gap-2">';
                (p.hashtagsToUse || []).forEach(function(h) {
                    html += '<span class="bg-blue-100 text-blue-700 px-4 py-2 rounded-full font-medium">' + utils.escapeHtml(h) + '</span>';
                });
                html += '</div></div>';

                html += '<div class="text-center mt-8">';
                html += '<button onclick="state.trendResults=null;render();" class="btn-secondary">Predict for Another Niche</button>';
                html += '</div>';
            }

            html += '</div></div>';
            return html;
        }

        /* ------------------------------------------
           4.6.11 Thumbnail Generator View (ADVANCED)
           ------------------------------------------ */
        function renderThumbnail() {
            var html = '';
            var hasVideoContext = state.lastOptimization && state.thumbnailFromOptimizer;
            var videoInfo = hasVideoContext ? (state.lastOptimization.videoInfo || {}) : {};
            var optimizedTitles = hasVideoContext ? (state.lastOptimization.titles || []) : [];
            var suggestedTitle = optimizedTitles[0] || videoInfo.title || '';

            html += '<div class="min-h-screen mobile-full-screen py-8 px-4 mobile-wide-container">';
            html += '<div class="max-w-5xl mx-auto">';

            // Navigation buttons
            html += '<div class="flex flex-wrap gap-3 mb-6">';
            if (hasVideoContext) {
                html += '<button onclick="app.goToResults()" class="btn-secondary"> Back to Results</button>';
            } else {
                html += '<button onclick="app.goToDashboard()" class="btn-secondary"> Back to Dashboard</button>';
            }
            html += '<button onclick="app.goToHistory(\'thumbnail\')" class="btn-secondary"> View History</button>';
            html += '</div>';

            // Header
            html += '<div class="text-center mb-8 fade-in">';
            html += '<div class="w-20 h-20 bg-gradient-to-br from-pink-500 to-rose-600 rounded-3xl flex items-center justify-center text-5xl mx-auto mb-4 shadow-xl"></div>';
            html += '<h1 class="text-3xl lg:text-4xl font-bold text-white mb-2">AI Thumbnail Generator</h1>';
            if (hasVideoContext) {
                html += '<p class="text-white/80 text-lg">Create a thumbnail for your optimized video</p>';
            } else {
                html += '<p class="text-white/80 text-lg">Generate click-worthy thumbnails with AI</p>';
            }
            html += '</div>';

            // Loading Section - Show at TOP when generating
            if (state.loading && !state.thumbnailImage) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 lg:p-8 mobile-padding mb-6 fade-in">';
                html += '<div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">';
                html += '<div class="flex items-center gap-4"><div class="loading-emoji"></div><div><h3 class="text-xl font-bold text-gray-800">Creating Your Thumbnail</h3><p class="text-gray-500">AI is generating your image...</p></div></div>';
                html += '<div class="progress-percentage">' + Math.round(state.loadingProgress) + '%</div>';
                html += '</div>';
                html += '<div class="progress-bar-container mb-6"><div class="progress-bar-fill" style="width:' + state.loadingProgress + '%"></div></div>';
                html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-3">';
                for (var li = 0; li < state.loadingSteps.length; li++) {
                    var lstep = state.loadingSteps[li];
                    var lstepClass = li < state.loadingStep ? 'completed' : li === state.loadingStep ? 'active' : 'pending';
                    html += '<div class="loading-step ' + lstepClass + '">';
                    html += '<div class="step-icon ' + lstepClass + '">' + (lstepClass === 'completed' ? '' : lstep.icon) + '</div>';
                    html += '<span class="text-sm font-medium">' + lstep.name + '</span>';
                    html += '</div>';
                }
                html += '</div></div>';
            }

            // Video Context Card (if from optimizer) - show when not loading
            if (hasVideoContext && videoInfo.thumbnail && !state.loading) {
                html += '<div class="bg-white/10 backdrop-blur rounded-2xl p-4 mb-6 fade-in">';
                html += '<div class="flex items-center gap-4">';
                html += '<img src="' + utils.escapeHtml(videoInfo.thumbnail) + '" class="w-32 h-18 object-cover rounded-lg" />';
                html += '<div>';
                html += '<p class="text-white font-semibold">' + utils.escapeHtml(videoInfo.title || 'Your Video') + '</p>';
                html += '<p class="text-white/70 text-sm">' + utils.escapeHtml(videoInfo.channelTitle || '') + '</p>';
                html += '<span class="inline-block mt-2 bg-green-500 text-white text-xs px-2 py-1 rounded-full"> Video context loaded</span>';
                html += '</div></div></div>';
            }

            // Main Form Card
            html += '<div class="bg-white rounded-2xl shadow-xl p-6 lg:p-8 mobile-padding fade-in">';

            if (state.error) {
                html += '<div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-xl text-red-700">' + utils.escapeHtml(state.error.message) + '</div>';
            }

            if (!state.thumbnailImage) {
                // Feature Description Section - Collapsible on mobile
                html += '<div class="mb-6">';
                html += '<div class="bg-gradient-to-r from-pink-50 via-rose-50 to-fuchsia-50 rounded-xl overflow-hidden border border-pink-100">';

                // Mobile: Collapsible header
                html += '<button type="button" onclick="this.parentElement.classList.toggle(\'expanded\'); this.querySelector(\'.chevron\').classList.toggle(\'rotate-180\')" class="w-full p-4 flex items-center justify-between text-left md:hidden">';
                html += '<span class="flex items-center gap-2 font-semibold text-gray-800"><span class="text-lg"></span> What makes great thumbnails?</span>';
                html += '<svg class="chevron w-5 h-5 text-gray-500 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>';
                html += '</button>';

                // Content area
                html += '<div class="feature-info-content p-4 pt-0 md:p-5 hidden md:block">';
                html += '<p class="text-gray-700 mb-3 leading-relaxed">Create scroll-stopping thumbnails with our AI image generator. Get professional-quality visuals that match your video\'s content and maximize click-through rates.</p>';
                html += '<div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">';
                html += '<div class="flex items-start gap-2"><span class="text-pink-500 mt-0.5"></span><span class="text-gray-600"><strong>AI-Generated Art</strong>  Unique visuals tailored to your title</span></div>';
                html += '<div class="flex items-start gap-2"><span class="text-pink-500 mt-0.5"></span><span class="text-gray-600"><strong>Multiple Styles</strong>  Professional, dramatic, minimal, bold</span></div>';
                html += '<div class="flex items-start gap-2"><span class="text-pink-500 mt-0.5"></span><span class="text-gray-600"><strong>Optimized Format</strong>  Perfect 16:9 YouTube dimensions</span></div>';
                html += '<div class="flex items-start gap-2"><span class="text-pink-500 mt-0.5"></span><span class="text-gray-600"><strong>Instant Download</strong>  High-resolution image ready to use</span></div>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
                html += '</div>';

                html += '<form onsubmit="app.generateThumbnail(event)">';

                // Title Input (pre-filled if from optimizer)
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-2">Video Title</label>';
                html += '<input type="text" id="thumbnail-title" value="' + utils.escapeHtml(suggestedTitle) + '" placeholder="Enter your video title..." class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-500 focus:outline-none text-lg" required />';
                if (hasVideoContext && optimizedTitles.length > 1) {
                    html += '<p class="text-sm text-gray-500 mt-2"> Or try: <span class="text-pink-600 cursor-pointer hover:underline" onclick="document.getElementById(\'thumbnail-title\').value=\'' + utils.escapeHtml(optimizedTitles[1]).replace(/'/g, "\\'") + '\'">' + utils.escapeHtml(optimizedTitles[1]) + '</span></p>';
                }
                html += '</div>';

                // Style Selection
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-3">Thumbnail Style</label>';
                html += '<div class="grid grid-cols-2 lg:grid-cols-4 gap-3">';

                var styles = [
                    { id: 'professional', name: 'Professional', icon: '', desc: 'Clean & sharp', color: 'blue' },
                    { id: 'dramatic', name: 'Dramatic', icon: '', desc: 'Bold & intense', color: 'purple' },
                    { id: 'minimal', name: 'Minimal', icon: '', desc: 'Simple & elegant', color: 'gray' },
                    { id: 'bold', name: 'Bold', icon: '', desc: 'Eye-catching', color: 'orange' }
                ];

                styles.forEach(function(s) {
                    var isActive = state.thumbnailStyle === s.id;
                    var borderClass = isActive ? 'border-pink-500 bg-pink-50' : 'border-gray-200 hover:border-pink-300';
                    html += '<div onclick="app.setThumbnailStyle(\'' + s.id + '\')" class="cursor-pointer p-4 border-2 ' + borderClass + ' rounded-xl text-center transition-all">';
                    html += '<div class="text-3xl mb-1">' + s.icon + '</div>';
                    html += '<p class="font-semibold text-gray-800">' + s.name + '</p>';
                    html += '<p class="text-xs text-gray-500">' + s.desc + '</p>';
                    if (isActive) html += '<span class="inline-block mt-2 text-pink-600 text-xs font-medium"> Selected</span>';
                    html += '</div>';
                });
                html += '</div></div>';

                // Custom Prompt
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-2">Additional Details <span class="text-gray-400 font-normal">(Optional)</span></label>';
                html += '<textarea id="thumbnail-prompt" placeholder="e.g., Include a person looking surprised, bright red arrow pointing right, space for text on the left side..." class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-pink-500 focus:outline-none h-20"></textarea>';
                html += '</div>';

                // Tips Section
                html += '<div class="bg-gradient-to-r from-pink-50 to-purple-50 p-4 rounded-xl mb-6">';
                html += '<h4 class="font-semibold text-gray-800 mb-2"> Pro Tips for Better Thumbnails</h4>';
                html += '<ul class="text-sm text-gray-600 space-y-1">';
                html += '<li> Use faces with emotions - they get 38% more clicks</li>';
                html += '<li> Keep text minimal - the AI will leave space for overlay</li>';
                html += '<li> High contrast colors stand out in YouTube feed</li>';
                html += '</ul></div>';

                // Submit Button
                html += '<button type="submit" class="btn-primary bg-gradient-to-r from-pink-500 to-rose-600 text-lg py-4" ' + (state.loading ? 'disabled' : '') + '>';
                html += state.loading ? ' Generating...' : ' Generate AI Thumbnail';
                html += '</button>';
                html += '</form>';
            } else {
                // Show generated thumbnail
                html += '<div class="text-center">';

                // Parse output - handle various RunPod response formats
                var imgSrc = '';
                var outputData = state.thumbnailImage;
                var hasError = false;
                var errorMsg = '';

                // Check for error in response
                if (outputData && (outputData.message || outputData.error)) {
                    hasError = true;
                    errorMsg = outputData.message || outputData.error || 'Unknown error';
                }

                if (!hasError) {
                    // Try to extract image from various formats
                    if (typeof outputData === 'string' && (outputData.startsWith('http') || outputData.startsWith('data:'))) {
                        imgSrc = outputData;
                    } else if (outputData) {
                        // Common RunPod output formats
                        if (outputData.image_url) imgSrc = outputData.image_url;
                        else if (outputData.image && typeof outputData.image === 'string') {
                            imgSrc = outputData.image.startsWith('http') || outputData.image.startsWith('data:')
                                ? outputData.image
                                : 'data:image/png;base64,' + outputData.image;
                        }
                        else if (outputData.images && outputData.images[0]) imgSrc = outputData.images[0];
                        else if (outputData.result) {
                            imgSrc = outputData.result.startsWith && (outputData.result.startsWith('http') || outputData.result.startsWith('data:'))
                                ? outputData.result
                                : 'data:image/png;base64,' + outputData.result;
                        }
                        else if (outputData.output && typeof outputData.output === 'string') imgSrc = outputData.output;
                        else if (outputData.url) imgSrc = outputData.url;
                    }
                }

                if (hasError) {
                    // Show error message
                    html += '<div class="inline-block bg-gradient-to-r from-red-400 to-rose-500 text-white px-4 py-2 rounded-full mb-4 font-semibold"> Generation Issue</div>';
                    html += '<div class="bg-red-50 border border-red-200 p-6 rounded-xl mb-6 max-w-2xl mx-auto">';
                    html += '<p class="text-red-700 font-medium mb-2">The AI service returned an error:</p>';
                    html += '<p class="text-red-600">' + utils.escapeHtml(errorMsg) + '</p>';
                    html += '</div>';
                } else if (imgSrc) {
                    html += '<div class="inline-block bg-gradient-to-r from-green-400 to-emerald-500 text-white px-4 py-2 rounded-full mb-4 font-semibold"> Thumbnail Generated!</div>';
                    html += '<div class="relative inline-block">';
                    html += '<img src="' + utils.escapeHtml(imgSrc) + '" class="w-full max-w-2xl mx-auto rounded-xl shadow-2xl mb-6" alt="Generated Thumbnail" />';
                    html += '<div class="absolute bottom-8 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded">1280  720</div>';
                    html += '</div>';
                } else {
                    // Unknown format - show debug info
                    html += '<div class="inline-block bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-4 py-2 rounded-full mb-4 font-semibold"> Check Output Format</div>';
                    html += '<div class="bg-yellow-50 border border-yellow-200 p-6 rounded-xl mb-6 max-w-2xl mx-auto text-left">';
                    html += '<p class="text-yellow-700 font-medium mb-2">Thumbnail generated but format not recognized:</p>';
                    html += '<pre class="text-xs overflow-auto bg-yellow-100 p-4 rounded max-h-40">' + JSON.stringify(outputData, null, 2) + '</pre>';
                    html += '<p class="text-yellow-600 text-sm mt-2">Please share this with support to fix the integration.</p>';
                    html += '</div>';
                }

                html += '<div class="flex flex-col sm:flex-row justify-center gap-4 mt-6">';
                if (imgSrc && !hasError) {
                    html += '<a href="' + imgSrc + '" download="thumbnail.png" class="btn-primary bg-gradient-to-r from-green-500 to-emerald-600 inline-flex items-center justify-center gap-2"><span></span> Download Thumbnail</a>';
                }
                html += '<button onclick="state.thumbnailImage=null;state.thumbnailJob=null;render();" class="btn-secondary"> Try Again</button>';
                html += '</div></div>';
            }

            html += '</div></div></div>';
            return html;
        }

        /* ------------------------------------------
           4.6.12 Placement Finder View
           ------------------------------------------ */
        function renderPlacement() {
            var html = '';
            var results = state.placementResults;

            html += '<div class="min-h-screen mobile-full-screen py-8 px-4 mobile-wide-container">';
            html += '<div class="max-w-6xl mx-auto">';

            // Navigation buttons
            html += '<div class="flex flex-wrap gap-3 mb-6">';
            html += '<button onclick="app.goToDashboard()" class="btn-secondary"> Back to Dashboard</button>';
            html += '</div>';

            // Header
            html += '<div class="text-center mb-8 fade-in">';
            html += '<div class="w-20 h-20 bg-gradient-to-br from-purple-500 to-violet-600 rounded-3xl flex items-center justify-center text-5xl mx-auto mb-4 shadow-xl"></div>';
            html += '<h1 class="text-3xl lg:text-4xl font-bold text-white mb-2">Placement Finder</h1>';
            html += '<p class="text-white/80 text-lg">Find successful YouTube channels for your Google Ads placements</p>';
            html += '</div>';

            // Copy Success Toast
            if (state.copySuccess) {
                html += '<div class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-xl shadow-xl z-50 fade-in">';
                html += ' ' + utils.escapeHtml(state.copySuccess);
                html += '</div>';
            }

            // Error Message
            if (state.error) {
                html += '<div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-xl text-red-700">' + utils.escapeHtml(state.error.message) + '</div>';
            }

            // Loading Section
            if (state.loading && !results) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 lg:p-8 mobile-padding mb-6 fade-in">';
                html += '<div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">';
                html += '<div class="flex items-center gap-4"><div class="loading-emoji"></div><div><h3 class="text-xl font-bold text-gray-800">Finding Placement Channels</h3><p class="text-gray-500">Analyzing your channel and finding matches...</p></div></div>';
                html += '<div class="progress-percentage">' + Math.round(state.loadingProgress) + '%</div>';
                html += '</div>';
                html += '<div class="progress-bar-container mb-6"><div class="progress-bar-fill" style="width:' + state.loadingProgress + '%"></div></div>';
                html += '<div class="grid grid-cols-2 md:grid-cols-3 gap-3">';
                for (var li = 0; li < state.loadingSteps.length; li++) {
                    var lstep = state.loadingSteps[li];
                    var lstepClass = li < state.loadingStep ? 'completed' : li === state.loadingStep ? 'active' : 'pending';
                    html += '<div class="loading-step ' + lstepClass + '">';
                    html += '<div class="step-icon ' + lstepClass + '">' + (lstepClass === 'completed' ? '' : lstep.icon) + '</div>';
                    html += '<span class="text-sm font-medium">' + lstep.name + '</span>';
                    html += '</div>';
                }
                html += '</div></div>';
            }

            // Input Form (show when no results)
            if (!results && !state.loading) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 lg:p-8 mobile-padding fade-in">';
                html += '<div class="max-w-xl mx-auto">';

                html += '<div class="text-center mb-6">';
                html += '<p class="text-gray-600 text-lg">Enter your YouTube channel link and we\'ll find successful channels whose audience may like your content.</p>';
                html += '</div>';

                html += '<form onsubmit="app.findPlacements(event)">';
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-2">Your YouTube Channel URL</label>';
                html += '<input type="text" id="placement-channel-url" placeholder="https://youtube.com/@yourchannel" class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-lg" required />';
                html += '<p class="text-sm text-gray-500 mt-2">Supports: youtube.com/@handle, youtube.com/channel/..., youtube.com/c/...</p>';
                html += '</div>';

                html += '<button type="submit" class="w-full py-4 bg-gradient-to-r from-purple-500 to-violet-600 text-white font-bold rounded-xl hover:from-purple-600 hover:to-violet-700 transition-all shadow-lg hover:shadow-xl text-lg">';
                html += ' Find Placement Channels';
                html += '</button>';
                html += '</form>';

                // Tips Section
                html += '<div class="mt-8 bg-gradient-to-r from-purple-50 to-violet-50 p-5 rounded-xl">';
                html += '<h4 class="font-semibold text-gray-800 mb-3"> What is Placement Targeting?</h4>';
                html += '<ul class="text-sm text-gray-600 space-y-2">';
                html += '<li> <strong>Google Ads Placements</strong> let you show ads on specific YouTube channels</li>';
                html += '<li> Find channels with audiences similar to your content</li>';
                html += '<li> Copy channel URLs directly into your Google Ads campaign</li>';
                html += '<li> Target viewers who are already interested in your niche</li>';
                html += '</ul>';
                html += '</div>';

                html += '</div></div>';
            }

            // Results Section
            if (results && results.placements) {
                var placements = results.placements;
                var channelInfo = results.channelInfo || {};
                var analysis = results.analysis || {};

                // Channel Info Card
                html += '<div class="bg-white/10 backdrop-blur rounded-2xl p-5 mb-6 fade-in">';
                html += '<div class="flex flex-wrap items-center gap-4">';
                if (channelInfo.thumbnail) {
                    html += '<img src="' + utils.escapeHtml(channelInfo.thumbnail) + '" class="w-16 h-16 object-cover rounded-full" />';
                }
                html += '<div class="flex-1 min-w-[200px]">';
                html += '<p class="text-white font-bold text-lg">' + utils.escapeHtml(channelInfo.name || 'Your Channel') + '</p>';
                html += '<p class="text-white/70">' + utils.escapeHtml(analysis.niche || '') + '</p>';
                if (analysis.audienceDescription) {
                    html += '<p class="text-white/60 text-sm mt-1"> ' + utils.escapeHtml(analysis.audienceDescription) + '</p>';
                }
                html += '</div>';
                html += '<div class="bg-green-500 text-white px-4 py-2 rounded-full font-bold">';
                html += ' ' + placements.length + ' Channels Found';
                html += '</div>';
                html += '</div></div>';

                // Action Buttons
                html += '<div class="flex flex-wrap gap-3 mb-6">';
                html += '<button onclick="app.copyAllPlacements()" class="btn-primary bg-gradient-to-r from-green-500 to-emerald-600 flex items-center gap-2">';
                html += '<span></span> Copy All ' + placements.length + ' Channels';
                html += '</button>';
                if (placements.length < 50) {
                    html += '<button onclick="app.findMorePlacements()" class="btn-secondary flex items-center gap-2" ' + (state.placementLoading ? 'disabled' : '') + '>';
                    if (state.placementLoading) {
                        html += '<span class="animate-spin"></span> Finding...';
                    } else {
                        html += '<span></span> Find 10 More (' + (50 - placements.length) + ' remaining)';
                    }
                    html += '</button>';
                }
                html += '<button onclick="app.goToPlacement()" class="btn-secondary flex items-center gap-2">';
                html += '<span></span> New Search';
                html += '</button>';
                html += '</div>';

                // Results Grid
                html += '<div class="bg-white rounded-2xl shadow-xl p-4 lg:p-6 fade-in">';
                html += '<div class="overflow-x-auto">';
                html += '<table class="w-full">';
                html += '<thead>';
                html += '<tr class="border-b-2 border-gray-100">';
                html += '<th class="text-left py-3 px-2 text-gray-600 font-semibold">#</th>';
                html += '<th class="text-left py-3 px-2 text-gray-600 font-semibold">Channel</th>';
                html += '<th class="text-left py-3 px-2 text-gray-600 font-semibold hidden md:table-cell">Subscribers</th>';
                html += '<th class="text-left py-3 px-2 text-gray-600 font-semibold hidden lg:table-cell">Score</th>';
                html += '<th class="text-right py-3 px-2 text-gray-600 font-semibold">Actions</th>';
                html += '</tr>';
                html += '</thead>';
                html += '<tbody>';

                for (var i = 0; i < placements.length; i++) {
                    var p = placements[i];
                    html += '<tr class="border-b border-gray-50 hover:bg-gray-50 transition-colors">';
                    html += '<td class="py-3 px-2 text-gray-400 font-medium">' + (i + 1) + '</td>';
                    html += '<td class="py-3 px-2">';
                    html += '<div class="flex items-center gap-3">';
                    if (p.thumbnail) {
                        html += '<img src="' + utils.escapeHtml(p.thumbnail) + '" class="w-10 h-10 rounded-full object-cover" />';
                    } else {
                        html += '<div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-400"></div>';
                    }
                    html += '<div>';
                    html += '<p class="font-semibold text-gray-800">' + utils.escapeHtml(p.channelName) + '</p>';
                    if (p.handle) {
                        html += '<p class="text-sm text-gray-500">' + utils.escapeHtml(p.handle) + '</p>';
                    }
                    html += '<p class="text-sm text-gray-500 md:hidden">' + utils.escapeHtml(p.subscribersFormatted) + ' subscribers</p>';
                    html += '</div>';
                    html += '</div>';
                    html += '</td>';
                    html += '<td class="py-3 px-2 hidden md:table-cell">';
                    html += '<span class="font-semibold text-gray-700">' + utils.escapeHtml(p.subscribersFormatted) + '</span>';
                    html += '</td>';
                    html += '<td class="py-3 px-2 hidden lg:table-cell">';
                    var scoreColor = p.relevanceScore >= 80 ? 'green' : p.relevanceScore >= 60 ? 'yellow' : 'gray';
                    html += '<span class="inline-block px-2 py-1 rounded-full text-xs font-bold bg-' + scoreColor + '-100 text-' + scoreColor + '-700">' + p.relevanceScore + '%</span>';
                    html += '</td>';
                    html += '<td class="py-3 px-2 text-right">';
                    html += '<div class="flex justify-end gap-2">';
                    html += '<a href="' + utils.escapeHtml(p.channelUrl) + '" target="_blank" class="p-2 text-gray-500 hover:text-purple-600 hover:bg-purple-50 rounded-lg transition-colors" title="Visit Channel"></a>';
                    html += '<button onclick="app.copySinglePlacement(\'' + utils.escapeHtml(p.channelUrl) + '\')" class="p-2 text-gray-500 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors" title="Copy URL"></button>';
                    html += '</div>';
                    html += '</td>';
                    html += '</tr>';
                }

                html += '</tbody>';
                html += '</table>';
                html += '</div>';

                // Footer info
                html += '<div class="mt-4 pt-4 border-t border-gray-100 flex flex-wrap justify-between items-center gap-4">';
                html += '<p class="text-sm text-gray-500">Showing ' + placements.length + ' of maximum 50 channels</p>';
                html += '<p class="text-sm text-gray-500"> Tip: Copy all and paste directly into Google Ads Placements</p>';
                html += '</div>';

                html += '</div>';
            }

            html += '</div></div>';
            return html;
        }

        /* ------------------------------------------
           4.6.13 Channel Audit Pro View
           ------------------------------------------ */
        function renderChannelAudit() {
            var html = '';
            var results = state.channelAuditResults;

            html += '<div class="min-h-screen mobile-full-screen py-8 px-4 mobile-wide-container">';
            html += '<div class="max-w-6xl mx-auto">';

            // Navigation buttons
            html += '<div class="flex flex-wrap gap-3 mb-6">';
            html += '<button onclick="app.goToDashboard()" class="btn-secondary"> Back to Dashboard</button>';
            html += '</div>';

            // Header
            html += '<div class="text-center mb-8 fade-in">';
            html += '<div class="w-20 h-20 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-3xl flex items-center justify-center text-5xl mx-auto mb-4 shadow-xl"></div>';
            html += '<h1 class="text-3xl lg:text-4xl font-bold text-white mb-2">Channel Audit Pro</h1>';
            html += '<p class="text-white/80 text-lg">Complete channel analysis with growth recommendations</p>';
            html += '</div>';

            // Error Message
            if (state.error) {
                html += '<div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-xl text-red-700">' + utils.escapeHtml(state.error.message) + '</div>';
            }

            // Loading Section
            if (state.loading && !results) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 lg:p-8 mobile-padding mb-6 fade-in">';
                html += '<div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">';
                html += '<div class="flex items-center gap-4"><div class="loading-emoji"></div><div><h3 class="text-xl font-bold text-gray-800">Analyzing Channel</h3><p class="text-gray-500">Performing comprehensive audit...</p></div></div>';
                html += '<div class="progress-percentage">' + Math.round(state.loadingProgress) + '%</div>';
                html += '</div>';
                html += '<div class="progress-bar-container mb-6"><div class="progress-bar-fill" style="width:' + state.loadingProgress + '%"></div></div>';
                html += '<div class="grid grid-cols-2 md:grid-cols-3 gap-3">';
                for (var li = 0; li < state.loadingSteps.length; li++) {
                    var lstep = state.loadingSteps[li];
                    var lstepClass = li < state.loadingStep ? 'completed' : li === state.loadingStep ? 'active' : 'pending';
                    html += '<div class="loading-step ' + lstepClass + '">';
                    html += '<div class="step-icon ' + lstepClass + '">' + (lstepClass === 'completed' ? '' : lstep.icon) + '</div>';
                    html += '<span class="text-sm font-medium">' + lstep.name + '</span>';
                    html += '</div>';
                }
                html += '</div></div>';
            }

            // Input Form (show when no results)
            if (!results && !state.loading) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 lg:p-8 mobile-padding fade-in">';
                html += '<div class="max-w-xl mx-auto">';

                // Feature Description Section - Collapsible on mobile
                html += '<div class="mb-6">';
                html += '<div class="bg-gradient-to-r from-emerald-50 via-teal-50 to-cyan-50 rounded-xl overflow-hidden border border-emerald-100">';

                // Mobile: Collapsible header
                html += '<button type="button" onclick="this.parentElement.classList.toggle(\'expanded\'); this.querySelector(\'.chevron\').classList.toggle(\'rotate-180\')" class="w-full p-4 flex items-center justify-between text-left md:hidden">';
                html += '<span class="flex items-center gap-2 font-semibold text-gray-800"><span class="text-lg"></span> What will you learn?</span>';
                html += '<svg class="chevron w-5 h-5 text-gray-500 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>';
                html += '</button>';

                // Content area
                html += '<div class="feature-info-content p-4 pt-0 md:p-5 hidden md:block">';
                html += '<p class="text-gray-700 mb-3 leading-relaxed">Get a complete health check for any YouTube channel. Our AI analyzes every aspect of channel performance and provides actionable recommendations for growth.</p>';
                html += '<div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">';
                html += '<div class="flex items-start gap-2"><span class="text-emerald-500 mt-0.5"></span><span class="text-gray-600"><strong>SEO Health Score</strong>  Overall optimization rating</span></div>';
                html += '<div class="flex items-start gap-2"><span class="text-emerald-500 mt-0.5"></span><span class="text-gray-600"><strong>Content Strategy</strong>  Upload frequency & topics</span></div>';
                html += '<div class="flex items-start gap-2"><span class="text-emerald-500 mt-0.5"></span><span class="text-gray-600"><strong>Engagement Analysis</strong>  Views, likes & comments</span></div>';
                html += '<div class="flex items-start gap-2"><span class="text-emerald-500 mt-0.5"></span><span class="text-gray-600"><strong>Growth Roadmap</strong>  Personalized recommendations</span></div>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
                html += '</div>';

                html += '<form onsubmit="app.runChannelAudit(event)">';
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-2">YouTube Channel URL</label>';
                html += '<input type="text" id="audit-channel-url" placeholder="https://youtube.com/@channel" class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:border-emerald-500 focus:outline-none text-lg" required />';
                html += '<p class="text-sm text-gray-500 mt-2">Supports: youtube.com/@handle, youtube.com/channel/..., youtube.com/c/...</p>';
                html += '</div>';

                html += '<button type="submit" class="w-full py-4 bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-bold rounded-xl hover:from-emerald-600 hover:to-teal-700 transition-all shadow-lg hover:shadow-xl text-lg">';
                html += ' Start Channel Audit';
                html += '</button>';
                html += '</form>';

                html += '</div></div>';
            }

            // Results Section
            if (results) {
                var channelInfo = results.channelInfo || {};
                var scores = results.scores || {};
                var analysis = results.analysis || {};
                var recommendations = results.recommendations || [];

                // Channel Info Card
                html += '<div class="bg-white/10 backdrop-blur rounded-2xl p-5 mb-6 fade-in">';
                html += '<div class="flex flex-wrap items-center gap-4">';
                if (channelInfo.thumbnail) {
                    html += '<img src="' + utils.escapeHtml(channelInfo.thumbnail) + '" class="w-16 h-16 object-cover rounded-full" />';
                }
                html += '<div class="flex-1 min-w-[200px]">';
                html += '<p class="text-white font-bold text-lg">' + utils.escapeHtml(channelInfo.name || 'Channel') + '</p>';
                html += '<p class="text-white/70">' + utils.formatNumber(channelInfo.subscribers || 0) + ' subscribers  ' + utils.formatNumber(channelInfo.videoCount || 0) + ' videos</p>';
                html += '</div>';
                var overallScore = scores.overall || 0;
                var scoreColor = overallScore >= 80 ? 'bg-green-500' : overallScore >= 60 ? 'bg-yellow-500' : 'bg-red-500';
                html += '<div class="' + scoreColor + ' text-white px-6 py-3 rounded-full font-bold text-2xl">';
                html += overallScore + '<span class="text-sm">/100</span>';
                html += '</div>';
                html += '</div></div>';

                // Score Breakdown
                html += '<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">';
                var scoreCategories = [
                    { key: 'seo', name: 'SEO Health', icon: '' },
                    { key: 'content', name: 'Content Strategy', icon: '' },
                    { key: 'engagement', name: 'Engagement', icon: '' },
                    { key: 'growth', name: 'Growth Potential', icon: '' }
                ];
                for (var i = 0; i < scoreCategories.length; i++) {
                    var cat = scoreCategories[i];
                    var catScore = scores[cat.key] || 0;
                    var catColor = catScore >= 80 ? 'text-green-400 border-green-400' : catScore >= 60 ? 'text-yellow-400 border-yellow-400' : 'text-red-400 border-red-400';
                    html += '<div class="bg-white rounded-2xl p-5 text-center shadow-lg">';
                    html += '<div class="text-3xl mb-2">' + cat.icon + '</div>';
                    html += '<div class="text-3xl font-bold ' + catColor + ' mb-1">' + catScore + '</div>';
                    html += '<div class="text-gray-600 text-sm font-medium">' + cat.name + '</div>';
                    html += '</div>';
                }
                html += '</div>';

                // Analysis Details
                if (analysis.summary) {
                    html += '<div class="bg-white rounded-2xl shadow-xl p-6 mb-6 fade-in">';
                    html += '<h3 class="text-xl font-bold text-gray-800 mb-4"> Analysis Summary</h3>';
                    html += '<p class="text-gray-600">' + utils.escapeHtml(analysis.summary) + '</p>';
                    html += '</div>';
                }

                // Strengths & Weaknesses
                html += '<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">';

                if (analysis.strengths && analysis.strengths.length > 0) {
                    html += '<div class="bg-white rounded-2xl shadow-xl p-6 fade-in">';
                    html += '<h3 class="text-xl font-bold text-green-600 mb-4"> Strengths</h3>';
                    html += '<ul class="space-y-2">';
                    for (var s = 0; s < analysis.strengths.length; s++) {
                        html += '<li class="flex items-start gap-2 text-gray-600"><span class="text-green-500"></span>' + utils.escapeHtml(analysis.strengths[s]) + '</li>';
                    }
                    html += '</ul></div>';
                }

                if (analysis.weaknesses && analysis.weaknesses.length > 0) {
                    html += '<div class="bg-white rounded-2xl shadow-xl p-6 fade-in">';
                    html += '<h3 class="text-xl font-bold text-red-600 mb-4"> Areas to Improve</h3>';
                    html += '<ul class="space-y-2">';
                    for (var w = 0; w < analysis.weaknesses.length; w++) {
                        html += '<li class="flex items-start gap-2 text-gray-600"><span class="text-red-500"></span>' + utils.escapeHtml(analysis.weaknesses[w]) + '</li>';
                    }
                    html += '</ul></div>';
                }

                html += '</div>';

                // Recommendations
                if (recommendations.length > 0) {
                    html += '<div class="bg-white rounded-2xl shadow-xl p-6 fade-in">';
                    html += '<h3 class="text-xl font-bold text-gray-800 mb-4"> Growth Recommendations</h3>';
                    html += '<div class="space-y-4">';
                    for (var r = 0; r < recommendations.length; r++) {
                        var rec = recommendations[r];
                        var priorityColor = rec.priority === 'high' ? 'bg-red-100 text-red-700' : rec.priority === 'medium' ? 'bg-yellow-100 text-yellow-700' : 'bg-blue-100 text-blue-700';
                        html += '<div class="p-4 bg-gray-50 rounded-xl">';
                        html += '<div class="flex items-center gap-3 mb-2">';
                        html += '<span class="px-2 py-1 text-xs font-bold rounded-full ' + priorityColor + '">' + (rec.priority || 'tip').toUpperCase() + '</span>';
                        html += '<span class="font-bold text-gray-800">' + utils.escapeHtml(rec.title || rec) + '</span>';
                        html += '</div>';
                        if (rec.description) {
                            html += '<p class="text-gray-600 text-sm">' + utils.escapeHtml(rec.description) + '</p>';
                        }
                        html += '</div>';
                    }
                    html += '</div></div>';
                }

                // New Audit Button
                html += '<div class="mt-6 text-center">';
                html += '<button onclick="app.goToChannelAudit()" class="btn-primary bg-gradient-to-r from-emerald-500 to-teal-600">';
                html += ' Audit Another Channel';
                html += '</button>';
                html += '</div>';
            }

            html += '</div></div>';
            return html;
        }

        /* ------------------------------------------
           4.6.14 Admin Reports View (Campaign Reports Manager)
           ------------------------------------------ */
        function renderAdminReports() {
            var html = '';

            html += '<div class="min-h-screen mobile-full-screen py-6 px-4 mobile-wide-container">';
            html += '<div class="max-w-6xl mx-auto">';

            // Header
            html += '<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4 fade-in">';
            html += '<h1 class="text-3xl mobile-text-xl font-bold text-white"> Campaign Reports</h1>';
            html += '<button onclick="app.goToAdmin()" class="btn-secondary w-full sm:w-auto"> Back to Admin</button>';
            html += '</div>';

            // Success/Error messages
            if (state.success) {
                html += '<div class="mb-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg fade-in">' + utils.escapeHtml(state.success) + '</div>';
            }
            if (state.error) {
                html += '<div class="mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg fade-in">' + utils.escapeHtml(state.error) + '</div>';
            }

            // Create New Report Section
            html += '<div class="bg-white rounded-2xl shadow-xl p-6 lg:p-8 mb-8 fade-in">';
            html += '<h2 class="text-2xl font-bold text-gray-800 mb-6"> Create New Report</h2>';

            // Upload Zone with drag-and-drop support
            html += '<div id="upload-zone" class="upload-zone' + (state.reportImages.length > 0 ? ' has-images' : '') + '" onclick="document.getElementById(\'image-input\').click()" ondragover="app.handleDragOver(event)" ondragleave="app.handleDragLeave(event)" ondrop="app.handleImageDrop(event)">';
            html += '<input type="file" id="image-input" accept="image/*" multiple style="display:none" onchange="app.handleImageUpload(event)" />';

            if (state.reportImages.length === 0) {
                html += '<div class="text-5xl mb-4"></div>';
                html += '<p class="text-xl font-bold text-gray-700 mb-2">Drop Google Ads Screenshots Here</p>';
                html += '<p class="text-gray-500">or click to browse (3-6 images recommended)</p>';
                html += '<p class="text-sm text-gray-400 mt-4">Supports: PNG, JPG, WebP (max 10MB each)</p>';
            } else {
                html += '<div class="text-green-600 font-bold text-lg mb-2"> ' + state.reportImages.length + ' images ready</div>';
                html += '<p class="text-gray-500 text-sm">Click to add more or use buttons below</p>';
            }
            html += '</div>';

            // Image Previews
            if (state.reportImages.length > 0) {
                html += '<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mt-6">';
                for (var i = 0; i < state.reportImages.length; i++) {
                    html += '<div class="image-preview">';
                    html += '<img src="' + state.reportImages[i].preview + '" alt="Screenshot ' + (i + 1) + '" />';
                    html += '<button class="remove-btn" onclick="event.stopPropagation(); app.removeReportImage(' + i + ')"></button>';
                    html += '<div class="absolute bottom-2 left-2 bg-black/60 text-white text-xs px-2 py-1 rounded">' + (i + 1) + '</div>';
                    html += '</div>';
                }
                html += '</div>';

                // Campaign Name Input
                html += '<div class="mt-6">';
                html += '<label class="block text-gray-700 font-semibold mb-2">Campaign Name</label>';
                html += '<input type="text" id="campaign-name" placeholder="e.g., Q4 Search Campaign" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none" />';
                html += '</div>';

                // Additional Context
                html += '<div class="mt-4">';
                html += '<label class="block text-gray-700 font-semibold mb-2">Additional Context (optional)</label>';
                html += '<textarea id="additional-context" rows="2" placeholder="Any specific details about the campaign..." class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none resize-none"></textarea>';
                html += '</div>';

                // Action Buttons
                html += '<div class="flex flex-wrap gap-4 mt-6">';
                html += '<button onclick="app.analyzeReportImages()" class="flex-1 px-6 py-4 bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold rounded-xl hover:from-purple-600 hover:to-indigo-700 transition-all flex items-center justify-center gap-2" ' + (state.reportLoading ? 'disabled' : '') + '>';
                if (state.reportLoading) {
                    html += '<span class="animate-spin"></span> Analyzing with AI...';
                } else {
                    html += '<span></span> Analyze with AI';
                }
                html += '</button>';
                html += '<button onclick="app.clearReportImages()" class="px-6 py-4 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition-all">Clear All</button>';
                html += '</div>';
            }

            html += '</div>';

            // AI Analysis Results
            if (state.reportAnalysis) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 lg:p-8 mb-8 fade-in">';
                html += '<div class="flex justify-between items-center mb-6">';
                html += '<h2 class="text-2xl font-bold text-gray-800"> AI Analysis</h2>';
                html += '<span class="status-badge status-ready">Analysis Complete</span>';
                html += '</div>';

                var analysis = state.reportAnalysis;

                // Summary
                if (analysis.summary) {
                    html += '<div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-4 mb-6">';
                    html += '<p class="text-gray-700">' + utils.escapeHtml(analysis.summary) + '</p>';
                    html += '</div>';
                }

                // YouTube Metrics Section
                if (analysis.youtubeMetrics) {
                    var ytMetrics = analysis.youtubeMetrics;
                    var hasYoutubeMetrics = ytMetrics.publicViews || ytMetrics.impressions || ytMetrics.videoTitle || ytMetrics.adType || ytMetrics.adGroup || ytMetrics.status;

                    if (hasYoutubeMetrics) {
                        html += '<h3 class="font-bold text-gray-800 mb-3"> Extracted Metrics</h3>';
                        html += '<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 mb-6">';

                        // YouTube-specific metrics with labels
                        var youtubeMetricLabels = {
                            publicViews: 'Public Views',
                            impressions: 'Impressions',
                            videoTitle: 'Video Title',
                            adType: 'Ad Type',
                            adGroup: 'Ad Group',
                            status: 'Status'
                        };

                        for (var ytKey in youtubeMetricLabels) {
                            if (ytMetrics[ytKey] !== null && ytMetrics[ytKey] !== undefined && ytMetrics[ytKey] !== '') {
                                html += '<div class="metric-card">';
                                // For longer text values like videoTitle, truncate if needed
                                var displayValue = String(ytMetrics[ytKey]);
                                if (ytKey === 'videoTitle' && displayValue.length > 30) {
                                    displayValue = displayValue.substring(0, 30) + '...';
                                }
                                html += '<div class="metric-value" title="' + utils.escapeHtml(String(ytMetrics[ytKey])) + '">' + utils.escapeHtml(displayValue) + '</div>';
                                html += '<div class="metric-label">' + youtubeMetricLabels[ytKey] + '</div>';
                                html += '</div>';
                            }
                        }
                        html += '</div>';
                    }
                }

                // Standard Metrics Grid (Google Ads metrics)
                if (analysis.metrics) {
                    // Only show header if we didn't already show YouTube metrics header
                    if (!analysis.youtubeMetrics || !(analysis.youtubeMetrics.publicViews || analysis.youtubeMetrics.impressions || analysis.youtubeMetrics.videoTitle || analysis.youtubeMetrics.adType || analysis.youtubeMetrics.adGroup || analysis.youtubeMetrics.status)) {
                        html += '<h3 class="font-bold text-gray-800 mb-3"> Extracted Metrics</h3>';
                    }
                    html += '<div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 mb-6">';
                    var metricLabels = {
                        impressions: 'Impressions',
                        clicks: 'Clicks',
                        ctr: 'CTR',
                        avgCpc: 'Avg CPC',
                        cost: 'Cost',
                        conversions: 'Conversions',
                        conversionRate: 'Conv Rate',
                        costPerConversion: 'Cost/Conv'
                    };
                    for (var key in metricLabels) {
                        if (analysis.metrics[key] !== null && analysis.metrics[key] !== undefined) {
                            html += '<div class="metric-card">';
                            html += '<div class="metric-value">' + utils.escapeHtml(String(analysis.metrics[key])) + '</div>';
                            html += '<div class="metric-label">' + metricLabels[key] + '</div>';
                            html += '</div>';
                        }
                    }
                    html += '</div>';
                }

                // Performance
                if (analysis.performance) {
                    html += '<h3 class="font-bold text-gray-800 mb-3"> Performance Assessment</h3>';
                    html += '<div class="bg-gray-50 rounded-xl p-4 mb-6">';
                    var perfColor = analysis.performance.overall === 'Excellent' ? 'green' : analysis.performance.overall === 'Good' ? 'blue' : analysis.performance.overall === 'Average' ? 'yellow' : 'red';
                    html += '<div class="flex items-center gap-3 mb-3">';
                    html += '<span class="px-3 py-1 bg-' + perfColor + '-100 text-' + perfColor + '-700 rounded-full font-bold">' + utils.escapeHtml(analysis.performance.overall || 'N/A') + '</span>';
                    html += '<span class="text-gray-500">Trend: ' + utils.escapeHtml(analysis.performance.trend || 'N/A') + '</span>';
                    html += '</div>';
                    if (analysis.performance.highlights && analysis.performance.highlights.length > 0) {
                        html += '<div class="mb-2"><span class="font-semibold text-green-600"> Highlights:</span></div>';
                        html += '<ul class="list-disc list-inside text-gray-600 mb-3">';
                        for (var h = 0; h < analysis.performance.highlights.length; h++) {
                            html += '<li>' + utils.escapeHtml(analysis.performance.highlights[h]) + '</li>';
                        }
                        html += '</ul>';
                    }
                    if (analysis.performance.concerns && analysis.performance.concerns.length > 0) {
                        html += '<div class="mb-2"><span class="font-semibold text-orange-600"> Areas for Improvement:</span></div>';
                        html += '<ul class="list-disc list-inside text-gray-600">';
                        for (var c = 0; c < analysis.performance.concerns.length; c++) {
                            html += '<li>' + utils.escapeHtml(analysis.performance.concerns[c]) + '</li>';
                        }
                        html += '</ul>';
                    }
                    html += '</div>';
                }

                // Recommendations
                if (analysis.recommendations && analysis.recommendations.length > 0) {
                    html += '<h3 class="font-bold text-gray-800 mb-3"> Recommendations</h3>';
                    html += '<div class="space-y-3 mb-6">';
                    for (var r = 0; r < analysis.recommendations.length; r++) {
                        var rec = analysis.recommendations[r];
                        var priority = (rec.priority || 'medium').toLowerCase();
                        html += '<div class="recommendation-card priority-' + priority + '">';
                        html += '<div class="flex items-start justify-between mb-2">';
                        html += '<span class="font-bold text-gray-800">' + utils.escapeHtml(rec.title || 'Recommendation ' + (r + 1)) + '</span>';
                        html += '<span class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600">' + utils.escapeHtml(rec.category || 'General') + '</span>';
                        html += '</div>';
                        html += '<p class="text-gray-600 text-sm">' + utils.escapeHtml(rec.description || '') + '</p>';
                        if (rec.expectedImpact) {
                            html += '<p class="text-sm text-green-600 mt-2"> ' + utils.escapeHtml(rec.expectedImpact) + '</p>';
                        }
                        html += '</div>';
                    }
                    html += '</div>';
                }

                // CTA
                if (analysis.fiverCTA) {
                    html += '<div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl p-4 mb-6">';
                    html += '<h4 class="font-bold text-green-700 mb-2"> Client Call-to-Action</h4>';
                    html += '<p class="text-gray-700">' + utils.escapeHtml(analysis.fiverCTA) + '</p>';
                    html += '</div>';
                }

                // Save/Edit Actions
                html += '<div class="flex flex-wrap gap-4 mt-6 pt-6 border-t border-gray-200">';
                html += '<button onclick="app.saveReportAsDraft()" class="flex-1 px-6 py-4 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition-all flex items-center justify-center gap-2">';
                html += '<span></span> Save as Draft';
                html += '</button>';
                html += '<button onclick="app.goToReportEditor()" class="flex-1 px-6 py-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-bold rounded-xl hover:from-blue-600 hover:to-indigo-700 transition-all flex items-center justify-center gap-2">';
                html += '<span></span> Edit & Send to Client';
                html += '</button>';
                html += '</div>';

                html += '</div>';
            }

            // Existing Reports Table
            html += '<div class="bg-white rounded-2xl shadow-xl p-6 lg:p-8 fade-in">';
            html += '<h2 class="text-2xl font-bold text-gray-800 mb-6"> All Reports</h2>';

            if (state.campaignReports === null) {
                html += '<div class="text-center py-8">';
                html += '<div class="spinner spinner-dark mx-auto mb-4"></div>';
                html += '<p class="text-gray-600">Loading reports...</p>';
                html += '</div>';
            } else if (state.campaignReports.length === 0) {
                html += '<div class="text-center py-12">';
                html += '<div class="text-6xl mb-4"></div>';
                html += '<p class="text-gray-500 text-lg">No reports yet. Create your first one above!</p>';
                html += '</div>';
            } else {
                html += '<div class="overflow-x-auto">';
                html += '<table class="w-full">';
                html += '<thead class="bg-gray-50">';
                html += '<tr>';
                html += '<th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Campaign</th>';
                html += '<th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Status</th>';
                html += '<th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 hidden md:table-cell">Client</th>';
                html += '<th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 hidden lg:table-cell">Created</th>';
                html += '<th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">Actions</th>';
                html += '</tr>';
                html += '</thead>';
                html += '<tbody class="divide-y divide-gray-100">';

                for (var i = 0; i < state.campaignReports.length; i++) {
                    var report = state.campaignReports[i];
                    var statusClass = 'status-' + report.status;
                    var statusIcon = report.status === 'draft' ? '' : report.status === 'ready' ? '' : report.status === 'sent' ? '' : '';

                    html += '<tr class="hover:bg-gray-50">';
                    html += '<td class="px-4 py-4">';
                    html += '<p class="font-semibold text-gray-800">' + utils.escapeHtml(report.campaignName || 'Untitled Report') + '</p>';
                    html += '<p class="text-sm text-gray-500">' + (report.images ? report.images.length : 0) + ' images</p>';
                    html += '</td>';
                    html += '<td class="px-4 py-4">';
                    html += '<span class="status-badge ' + statusClass + '">' + statusIcon + ' ' + utils.escapeHtml(report.status) + '</span>';
                    html += '</td>';
                    html += '<td class="px-4 py-4 hidden md:table-cell">';
                    if (report.clientInfo) {
                        html += '<span class="text-gray-700">' + utils.escapeHtml(report.clientInfo.email) + '</span>';
                    } else {
                        html += '<span class="text-gray-400">Not assigned</span>';
                    }
                    html += '</td>';
                    html += '<td class="px-4 py-4 hidden lg:table-cell text-gray-500">';
                    html += report.createdAt ? new Date(report.createdAt).toLocaleDateString() : 'N/A';
                    html += '</td>';
                    html += '<td class="px-4 py-4 text-right">';
                    html += '<div class="flex justify-end gap-2">';
                    html += '<button onclick="app.editReport(\'' + report.id + '\')" class="p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-lg" title="Edit"></button>';
                    if (report.status === 'draft' || report.status === 'ready') {
                        html += '<button onclick="app.openSendModal(\'' + report.id + '\')" class="p-2 text-gray-500 hover:text-green-600 hover:bg-green-50 rounded-lg" title="Send to Client"></button>';
                    }
                    html += '<button onclick="app.deleteReport(\'' + report.id + '\')" class="p-2 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-lg" title="Delete"></button>';
                    html += '</div>';
                    html += '</td>';
                    html += '</tr>';
                }

                html += '</tbody></table></div>';
            }

            html += '</div>';

            html += '</div></div>';

            // Send to Client Modal
            if (state.sendModalReportId) {
                html += '<div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" onclick="app.closeSendModal()">';
                html += '<div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6" onclick="event.stopPropagation()">';
                html += '<h3 class="text-xl font-bold text-gray-800 mb-4"> Send Report to Client</h3>';
                html += '<p class="text-gray-600 mb-4">Select which client should receive this report:</p>';

                html += '<select id="send-client-select" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none mb-6">';
                html += '<option value="">-- Select a client --</option>';
                if (state.adminUsers) {
                    for (var u = 0; u < state.adminUsers.length; u++) {
                        var user = state.adminUsers[u];
                        html += '<option value="' + user.uid + '">' + utils.escapeHtml(user.email || user.uid) + '</option>';
                    }
                }
                html += '</select>';

                html += '<div class="flex gap-3">';
                html += '<button onclick="app.closeSendModal()" class="flex-1 px-4 py-3 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200">Cancel</button>';
                html += '<button onclick="app.sendReportToClient()" class="flex-1 px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold rounded-xl hover:from-green-600 hover:to-emerald-700">Send Report</button>';
                html += '</div>';
                html += '</div></div>';
            }

            return html;
        }

        /* ------------------------------------------
           4.6.15 Report Editor View
           ------------------------------------------ */
        function renderReportEditor() {
            var html = '';
            var report = state.editingReport || {};
            var content = report.editedContent || {};

            html += '<div class="min-h-screen mobile-full-screen py-6 px-4 mobile-wide-container">';
            html += '<div class="max-w-4xl mx-auto">';

            // Header
            html += '<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4 fade-in">';
            html += '<h1 class="text-3xl mobile-text-xl font-bold text-white"> Edit Report</h1>';
            html += '<button onclick="app.goToAdminReports()" class="btn-secondary w-full sm:w-auto"> Back to Reports</button>';
            html += '</div>';

            if (state.success) {
                html += '<div class="mb-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg fade-in">' + utils.escapeHtml(state.success) + '</div>';
            }
            if (state.error) {
                html += '<div class="mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg fade-in">' + utils.escapeHtml(state.error) + '</div>';
            }

            html += '<div class="bg-white rounded-2xl shadow-xl p-6 lg:p-8 fade-in">';

            // Campaign Name
            html += '<div class="mb-6">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Report Title</label>';
            html += '<input type="text" id="edit-title" value="' + utils.escapeHtml(content.title || report.campaignName || '') + '" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none text-lg" />';
            html += '</div>';

            // Summary
            html += '<div class="mb-6">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Executive Summary</label>';
            html += '<textarea id="edit-summary" rows="3" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none resize-none">' + utils.escapeHtml(content.summary || '') + '</textarea>';
            html += '</div>';

            // Recommendations (editable list)
            html += '<div class="mb-6">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Recommendations</label>';
            html += '<div id="recommendations-list" class="space-y-3">';
            var recs = content.recommendations || [];
            for (var i = 0; i < recs.length; i++) {
                html += '<div class="flex gap-2 items-start">';
                html += '<input type="text" class="rec-input flex-1 px-3 py-2 border border-gray-200 rounded-lg" value="' + utils.escapeHtml(recs[i].title || recs[i]) + '" data-index="' + i + '" />';
                html += '<button onclick="app.removeRecommendation(' + i + ')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg"></button>';
                html += '</div>';
            }
            html += '</div>';
            html += '<button onclick="app.addRecommendation()" class="mt-3 text-purple-600 font-semibold hover:underline">+ Add Recommendation</button>';
            html += '</div>';

            // Call to Action
            html += '<div class="mb-6">';
            html += '<label class="block text-gray-700 font-semibold mb-2">Call to Action (Fiverr CTA)</label>';
            html += '<textarea id="edit-cta" rows="2" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none resize-none">' + utils.escapeHtml(content.callToAction || '') + '</textarea>';
            html += '</div>';

            // Images Preview
            if (report.images && report.images.length > 0) {
                html += '<div class="mb-6">';
                html += '<label class="block text-gray-700 font-semibold mb-2">Report Images</label>';
                html += '<div class="grid grid-cols-3 md:grid-cols-4 gap-2">';
                for (var j = 0; j < report.images.length; j++) {
                    html += '<img src="' + utils.escapeHtml(report.images[j].url || report.images[j].preview) + '" class="rounded-lg aspect-video object-cover" />';
                }
                html += '</div>';
                html += '</div>';
            }

            // Actions
            html += '<div class="flex flex-wrap gap-4 pt-6 border-t border-gray-200">';
            html += '<button onclick="app.saveReportChanges()" class="flex-1 px-6 py-4 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition-all" ' + (state.reportLoading ? 'disabled' : '') + '> Save Changes</button>';
            html += '<button onclick="app.openSendModal(\'' + (report.id || '') + '\')" class="flex-1 px-6 py-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold rounded-xl hover:from-green-600 hover:to-emerald-700 transition-all"> Send to Client</button>';
            html += '</div>';

            html += '</div>';
            html += '</div></div>';

            return html;
        }

        /* ------------------------------------------
           4.6.16 Client Reports View
           ------------------------------------------ */
        function renderClientReports() {
            var html = '';

            html += '<div class="min-h-screen mobile-full-screen py-8 px-4 mobile-wide-container">';
            html += '<div class="max-w-4xl mx-auto">';

            // Header
            html += '<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4 fade-in">';
            html += '<div>';
            html += '<h1 class="text-3xl lg:text-4xl font-bold text-white mb-2"> My Campaign Reports</h1>';
            html += '<p class="text-white/80">View your performance reports and recommendations</p>';
            html += '</div>';
            html += '<button onclick="app.goToDashboard()" class="btn-secondary w-full sm:w-auto"> Back to Dashboard</button>';
            html += '</div>';

            // Reports List
            if (state.clientReports === null) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-12 text-center fade-in">';
                html += '<div class="spinner spinner-dark mx-auto mb-4"></div>';
                html += '<p class="text-gray-600">Loading your reports...</p>';
                html += '</div>';
            } else if (state.clientReports.length === 0) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-12 text-center fade-in">';
                html += '<div class="text-6xl mb-4"></div>';
                html += '<h3 class="text-xl font-bold text-gray-800 mb-2">No Reports Yet</h3>';
                html += '<p class="text-gray-500">When your campaign reports are ready, they\'ll appear here.</p>';
                html += '</div>';
            } else {
                html += '<div class="grid gap-6 fade-in">';
                for (var i = 0; i < state.clientReports.length; i++) {
                    var report = state.clientReports[i];
                    var isNew = report.status === 'sent';

                    html += '<div class="client-report-card' + (isNew ? ' has-new' : '') + ' cursor-pointer" onclick="app.viewReport(\'' + report.id + '\')">';
                    html += '<div class="flex flex-col md:flex-row md:items-center justify-between gap-4">';
                    html += '<div class="flex-1">';
                    html += '<div class="flex items-center gap-3 mb-2">';
                    html += '<span class="text-3xl"></span>';
                    html += '<h3 class="text-xl font-bold text-gray-800">' + utils.escapeHtml(report.campaignName || 'Campaign Report') + '</h3>';
                    if (isNew) {
                        html += '<span class="notification-dot"></span>';
                    }
                    html += '</div>';
                    html += '<p class="text-gray-500">Delivered: ' + (report.sentAt ? new Date(report.sentAt).toLocaleDateString() : 'N/A') + '</p>';
                    html += '</div>';
                    html += '<div class="flex items-center gap-3">';
                    html += '<button class="px-6 py-3 bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold rounded-xl hover:from-purple-600 hover:to-indigo-700 transition-all">View Report </button>';
                    html += '</div>';
                    html += '</div>';
                    html += '</div>';
                }
                html += '</div>';
            }

            html += '</div></div>';

            return html;
        }

        /* ------------------------------------------
           4.6.17 View Report (Client View)
           ------------------------------------------ */
        function renderViewReport() {
            var html = '';
            var report = state.currentReport || {};
            var content = report.editedContent || {};

            html += '<div class="min-h-screen mobile-full-screen py-8 px-4 mobile-wide-container">';
            html += '<div class="max-w-4xl mx-auto">';

            // Header
            html += '<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4 fade-in">';
            html += '<h1 class="text-3xl lg:text-4xl font-bold text-white">' + utils.escapeHtml(content.title || report.campaignName || 'Campaign Report') + '</h1>';
            html += '<button onclick="app.goToClientReports()" class="btn-secondary w-full sm:w-auto"> Back to Reports</button>';
            html += '</div>';

            if (!report.id) {
                html += '<div class="bg-white rounded-2xl shadow-xl p-12 text-center">';
                html += '<div class="spinner spinner-dark mx-auto mb-4"></div>';
                html += '<p class="text-gray-600">Loading report...</p>';
                html += '</div>';
            } else {
                // YouTube Performance Hero Section
                var ytMetrics = content.youtubeMetrics || {};
                if (ytMetrics.publicViews || ytMetrics.impressions) {
                    html += '<div class="youtube-hero fade-in">';
                    html += '<div class="youtube-hero-title"><span></span> YouTube Campaign Performance</div>';

                    // Main Views Card
                    if (ytMetrics.publicViews) {
                        var viewRate = 0;
                        if (ytMetrics.publicViews && ytMetrics.impressions) {
                            viewRate = Math.round((parseInt(String(ytMetrics.publicViews).replace(/,/g, '')) / parseInt(String(ytMetrics.impressions).replace(/,/g, ''))) * 1000) / 10;
                        }
                        html += '<div class="youtube-hero-main">';
                        html += '<div class="youtube-views-label"><span></span> YouTube Public Views</div>';
                        html += '<div class="youtube-views-value">' + utils.escapeHtml(String(ytMetrics.publicViews)) + '</div>';
                        if (viewRate > 0) {
                            html += '<div class="youtube-view-rate">';
                            html += '<div class="view-rate-bar"><div class="view-rate-fill" style="width:' + Math.min(viewRate, 100) + '%"></div></div>';
                            html += '<span class="view-rate-text">' + viewRate + '% View Rate</span>';
                            html += '</div>';
                        }
                        html += '</div>';
                    }

                    // Supporting Metrics Grid
                    html += '<div class="youtube-metrics-grid">';
                    if (ytMetrics.impressions) {
                        html += '<div class="youtube-metric-card">';
                        html += '<div class="youtube-metric-icon"></div>';
                        html += '<div class="youtube-metric-value">' + utils.escapeHtml(String(ytMetrics.impressions)) + '</div>';
                        html += '<div class="youtube-metric-label">Impressions</div>';
                        html += '</div>';
                    }
                    if (ytMetrics.publicViews) {
                        var viewRateCalc = ytMetrics.impressions ? Math.round((parseInt(String(ytMetrics.publicViews).replace(/,/g, '')) / parseInt(String(ytMetrics.impressions).replace(/,/g, ''))) * 1000) / 10 : 0;
                        html += '<div class="youtube-metric-card">';
                        html += '<div class="youtube-metric-icon"></div>';
                        html += '<div class="youtube-metric-value">' + viewRateCalc + '%</div>';
                        html += '<div class="youtube-metric-label">View Rate</div>';
                        html += '</div>';
                    }
                    if (ytMetrics.status) {
                        html += '<div class="youtube-metric-card">';
                        html += '<div class="youtube-metric-icon"></div>';
                        html += '<div class="youtube-metric-value" style="font-size:1rem;">' + utils.escapeHtml(ytMetrics.status) + '</div>';
                        html += '<div class="youtube-metric-label">Status</div>';
                        html += '</div>';
                    }
                    html += '</div>';

                    // Video Info
                    if (ytMetrics.videoTitle || ytMetrics.adType) {
                        html += '<div class="youtube-video-info">';
                        if (ytMetrics.videoTitle) {
                            html += '<div class="youtube-video-title"><span></span> ' + utils.escapeHtml(ytMetrics.videoTitle) + '</div>';
                        }
                        html += '<div class="youtube-video-meta">';
                        if (ytMetrics.adType) {
                            html += '<span class="youtube-video-tag"><span></span> ' + utils.escapeHtml(ytMetrics.adType) + '</span>';
                        }
                        if (ytMetrics.adGroup) {
                            html += '<span class="youtube-video-tag"><span></span> ' + utils.escapeHtml(ytMetrics.adGroup) + '</span>';
                        }
                        if (ytMetrics.status) {
                            html += '<span class="youtube-video-tag status-eligible"><span></span> ' + utils.escapeHtml(ytMetrics.status) + '</span>';
                        }
                        html += '</div>';
                        html += '</div>';
                    }

                    html += '</div>';
                }

                // Report Content Card
                html += '<div class="bg-white rounded-2xl shadow-xl p-6 lg:p-8 fade-in">';

                // Summary
                if (content.summary) {
                    html += '<div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-6 mb-8">';
                    html += '<h3 class="font-bold text-gray-800 mb-2">Executive Summary</h3>';
                    html += '<p class="text-gray-700 text-lg">' + utils.escapeHtml(content.summary) + '</p>';
                    html += '</div>';
                }

                // Narrative Summary (detailed visual analysis)
                if (content.narrativeSummary) {
                    html += '<div class="bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl p-6 mb-8 border border-blue-100">';
                    html += '<div class="flex items-start gap-3">';
                    html += '<span class="text-2xl"></span>';
                    html += '<div>';
                    html += '<h3 class="font-bold text-gray-800 mb-2">Detailed Analysis</h3>';
                    html += '<p class="text-gray-700 leading-relaxed">' + utils.escapeHtml(content.narrativeSummary) + '</p>';
                    html += '</div>';
                    html += '</div>';
                    html += '</div>';
                }

                // Images with Lightbox and Download
                if (report.images && report.images.length > 0) {
                    var imageUrls = report.images.map(function(img) { return img.url; });
                    html += '<div class="mb-8">';
                    html += '<div class="flex items-center justify-between mb-4">';
                    html += '<h3 class="font-bold text-gray-800"> Campaign Screenshots</h3>';
                    html += '<span class="text-sm text-gray-500">Click to enlarge</span>';
                    html += '</div>';
                    html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                    for (var i = 0; i < report.images.length; i++) {
                        var imgUrl = utils.escapeHtml(report.images[i].url);
                        html += '<div class="report-image-item" onclick="app.openLightbox(' + JSON.stringify(imageUrls).replace(/"/g, '&quot;') + ', ' + i + ')">';
                        html += '<img src="' + imgUrl + '" alt="Screenshot ' + (i + 1) + '" />';
                        html += '<div class="report-image-overlay">';
                        html += '<div class="report-image-actions">';
                        html += '<button class="report-image-btn" onclick="event.stopPropagation(); app.openLightbox(' + JSON.stringify(imageUrls).replace(/"/g, '&quot;') + ', ' + i + ')"><span></span> View</button>';
                        html += '<button class="report-image-btn" onclick="event.stopPropagation(); app.downloadImage(\'' + imgUrl + '\', \'screenshot-' + (i + 1) + '.png\')"><span></span> Download</button>';
                        html += '</div>';
                        html += '</div>';
                        html += '</div>';
                    }
                    html += '</div>';
                    html += '</div>';
                }

                // Screenshot Analysis (visual descriptions from AI)
                if (content.screenshotAnalysis && content.screenshotAnalysis.length > 0) {
                    html += '<div class="mb-8">';
                    html += '<div class="flex items-center gap-3 mb-4">';
                    html += '<div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center text-white text-xl"></div>';
                    html += '<div>';
                    html += '<h3 class="font-bold text-gray-800">Visual Analysis</h3>';
                    html += '<p class="text-sm text-gray-500">Detailed breakdown of each screenshot</p>';
                    html += '</div>';
                    html += '</div>';
                    html += '<div class="space-y-4">';
                    for (var sa = 0; sa < content.screenshotAnalysis.length; sa++) {
                        var analysis = content.screenshotAnalysis[sa];
                        html += '<div class="bg-gray-50 rounded-xl p-5 border border-gray-100">';
                        html += '<div class="flex items-center gap-2 mb-3">';
                        html += '<span class="w-7 h-7 bg-indigo-100 text-indigo-700 rounded-full flex items-center justify-center font-bold text-sm">' + (analysis.imageNumber || (sa + 1)) + '</span>';
                        html += '<span class="font-semibold text-gray-800">Screenshot ' + (analysis.imageNumber || (sa + 1)) + '</span>';
                        html += '</div>';
                        if (analysis.description) {
                            html += '<p class="text-gray-700 mb-3">' + utils.escapeHtml(analysis.description) + '</p>';
                        }
                        if (analysis.keyObservations && analysis.keyObservations.length > 0) {
                            html += '<div class="space-y-2">';
                            for (var ko = 0; ko < analysis.keyObservations.length; ko++) {
                                html += '<div class="flex items-start gap-2">';
                                html += '<span class="text-green-500 mt-0.5"></span>';
                                html += '<span class="text-gray-600 text-sm">' + utils.escapeHtml(analysis.keyObservations[ko]) + '</span>';
                                html += '</div>';
                            }
                            html += '</div>';
                        }
                        if (analysis.dataExtracted) {
                            html += '<div class="mt-3 pt-3 border-t border-gray-200">';
                            html += '<p class="text-sm text-gray-500"><span class="font-medium text-gray-700">Key Data:</span> ' + utils.escapeHtml(analysis.dataExtracted) + '</p>';
                            html += '</div>';
                        }
                        html += '</div>';
                    }
                    html += '</div>';
                    html += '</div>';
                }

                // Metrics (Google Ads metrics)
                if (content.metrics && Object.keys(content.metrics).length > 0) {
                    html += '<div class="mb-8">';
                    html += '<h3 class="font-bold text-gray-800 mb-4"> Campaign Metrics</h3>';
                    html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4">';
                    var metricLabels = {
                        impressions: 'Impressions',
                        clicks: 'Clicks',
                        ctr: 'CTR',
                        avgCpc: 'Avg CPC',
                        cost: 'Cost',
                        conversions: 'Conversions',
                        conversionRate: 'Conv Rate',
                        costPerConversion: 'Cost/Conv'
                    };
                    for (var key in metricLabels) {
                        if (content.metrics[key] !== null && content.metrics[key] !== undefined) {
                            html += '<div class="metric-card">';
                            html += '<div class="metric-value">' + utils.escapeHtml(String(content.metrics[key])) + '</div>';
                            html += '<div class="metric-label">' + metricLabels[key] + '</div>';
                            html += '</div>';
                        }
                    }
                    html += '</div>';
                    html += '</div>';
                }

                // YouTube Channel Recommendations (enhanced styling)
                if (content.recommendations && content.recommendations.length > 0) {
                    html += '<div class="mb-8">';
                    html += '<div class="flex items-center gap-3 mb-4">';
                    html += '<div class="w-10 h-10 bg-gradient-to-br from-red-500 to-red-600 rounded-xl flex items-center justify-center text-white text-xl"></div>';
                    html += '<div>';
                    html += '<h3 class="font-bold text-gray-800">YouTube Channel Recommendations</h3>';
                    html += '<p class="text-sm text-gray-500">Expert tips to grow your channel</p>';
                    html += '</div>';
                    html += '</div>';
                    html += '<div class="space-y-4">';
                    for (var r = 0; r < content.recommendations.length; r++) {
                        var rec = content.recommendations[r];
                        var title = typeof rec === 'string' ? rec : rec.title;
                        var desc = typeof rec === 'object' ? rec.description : '';
                        var priority = typeof rec === 'object' ? (rec.priority || 'medium').toLowerCase() : 'medium';
                        var category = typeof rec === 'object' ? (rec.category || '') : '';
                        var impact = typeof rec === 'object' ? (rec.expectedImpact || '') : '';

                        // Category icons
                        var categoryIcon = '';
                        if (category.toLowerCase().includes('thumbnail')) categoryIcon = '';
                        else if (category.toLowerCase().includes('title')) categoryIcon = '';
                        else if (category.toLowerCase().includes('description')) categoryIcon = '';
                        else if (category.toLowerCase().includes('content')) categoryIcon = '';
                        else if (category.toLowerCase().includes('schedule') || category.toLowerCase().includes('posting')) categoryIcon = '';
                        else if (category.toLowerCase().includes('engagement')) categoryIcon = '';
                        else if (category.toLowerCase().includes('seo') || category.toLowerCase().includes('tag')) categoryIcon = '';
                        else if (category.toLowerCase().includes('brand')) categoryIcon = '';

                        html += '<div class="recommendation-card priority-' + priority + '">';
                        html += '<div class="flex items-start gap-3">';
                        html += '<span class="text-2xl">' + categoryIcon + '</span>';
                        html += '<div class="flex-1">';
                        html += '<div class="flex items-center gap-2 flex-wrap mb-1">';
                        html += '<p class="font-bold text-gray-800">' + utils.escapeHtml(title) + '</p>';
                        if (priority === 'high') {
                            html += '<span class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full font-semibold">High Priority</span>';
                        } else if (priority === 'medium') {
                            html += '<span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full font-semibold">Medium</span>';
                        }
                        html += '</div>';
                        if (desc) {
                            html += '<p class="text-gray-600 mt-1">' + utils.escapeHtml(desc) + '</p>';
                        }
                        // Show evidence from screenshots if available
                        var evidence = typeof rec === 'object' ? (rec.evidenceFromScreenshots || '') : '';
                        if (evidence) {
                            html += '<div class="mt-2 p-2 bg-blue-50 rounded-lg border border-blue-100">';
                            html += '<p class="text-sm text-blue-700"><span class="font-medium"> Evidence:</span> ' + utils.escapeHtml(evidence) + '</p>';
                            html += '</div>';
                        }
                        if (impact) {
                            html += '<p class="text-sm text-green-600 mt-2 font-medium"> Expected Impact: ' + utils.escapeHtml(impact) + '</p>';
                        }
                        html += '</div>';
                        html += '</div>';
                        html += '</div>';
                    }
                    html += '</div>';
                    html += '</div>';
                }

                // Call to Action
                if (content.callToAction) {
                    html += '<div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl p-6 text-white">';
                    html += '<h3 class="font-bold text-xl mb-2"> Ready to Optimize Your Channel?</h3>';
                    html += '<p class="text-white/90 mb-4">' + utils.escapeHtml(content.callToAction) + '</p>';
                    html += '</div>';
                }

                // Report Date
                html += '<div class="mt-8 pt-6 border-t border-gray-200 text-center text-gray-500">';
                html += '<p>Report generated: ' + (report.createdAt ? new Date(report.createdAt).toLocaleDateString() : 'N/A') + '</p>';
                html += '</div>';

                html += '</div>';
            }

            html += '</div></div>';

            return html;
        }

        /* ==========================================
           4.7 GLOBAL HEADER (Notification Bell)
           ========================================== */

        function renderGlobalHeader() {
            // Only show on authenticated views (not login, register, forgot-password, initializing)
            var authViews = ['login', 'register', 'forgot-password', 'initializing'];
            if (authViews.indexOf(state.currentView) !== -1) {
                return '';
            }

            // Don't show if no user
            if (!state.user) {
                return '';
            }

            var html = '';

            // Click-outside overlay (only when dropdown is open)
            if (state.showNotifications) {
                html += '<div class="notification-overlay" onclick="app.closeNotifications()"></div>';
            }

            // Global header
            html += '<div class="global-header">';
            html += '<div class="global-header-content">';

            // Notification Bell (always visible when logged in)
            html += '<div class="notification-bell relative" onclick="event.stopPropagation(); app.toggleNotifications()">';
            html += '<span class="text-2xl"></span>';
            if (state.unreadCount > 0) {
                html += '<span class="notification-badge">' + state.unreadCount + '</span>';
            }

            // Notification Dropdown
            if (state.showNotifications) {
                html += '<div class="notification-dropdown" onclick="event.stopPropagation()">';
                html += '<div class="p-4 border-b border-gray-100 flex justify-between items-center">';
                html += '<h4 class="font-bold text-gray-800">Notifications</h4>';
                if (state.notifications.length > 0) {
                    html += '<button onclick="app.markAllNotificationsRead()" class="text-sm text-blue-600 hover:underline">Mark all read</button>';
                }
                html += '</div>';

                if (state.notifications.length > 0) {
                    html += '<div class="max-h-64 overflow-y-auto">';
                    for (var n = 0; n < state.notifications.length; n++) {
                        var notif = state.notifications[n];
                        html += '<div class="p-4 hover:bg-gray-50 cursor-pointer border-b border-gray-50" onclick="app.openNotificationReport(\'' + notif.reportId + '\', \'' + notif.id + '\')">';
                        html += '<div class="flex items-start gap-3">';
                        html += '<span class="text-2xl"></span>';
                        html += '<div>';
                        html += '<p class="font-semibold text-gray-800 text-sm">' + utils.escapeHtml(notif.title) + '</p>';
                        html += '<p class="text-gray-500 text-xs mt-1">' + utils.escapeHtml(notif.message) + '</p>';
                        html += '</div>';
                        html += '</div>';
                        html += '</div>';
                    }
                    html += '</div>';
                } else {
                    // Empty state
                    html += '<div class="notification-empty">';
                    html += '<div class="notification-empty-icon"></div>';
                    html += '<p class="font-medium text-gray-600">No new notifications</p>';
                    html += '<p class="text-sm mt-1">You\'re all caught up!</p>';
                    html += '</div>';
                }
                html += '</div>';
            }

            html += '</div>'; // End notification-bell

            html += '</div>'; // End global-header-content
            html += '</div>'; // End global-header

            return html;
        }

        /* ==========================================
           4.8 MAIN RENDER FUNCTION
           ========================================== */

        // Track previous view for transitions
        var previousView = null;

        function render() {
            const root = document.getElementById('app-root');
            if (!root) return;

            var html = '';

            // Route to correct view
            switch (state.currentView) {
                case 'initializing':
                    html = renderInitializing();
                    break;
                case 'login':
                    html = renderLogin();
                    break;
                case 'register':
                    html = renderRegister();
                    break;
                case 'forgot-password':
                    html = renderForgotPassword();
                    break;
                case 'dashboard':
                    html = renderDashboard();
                    break;
                case 'optimizer':
                    html = renderOptimizer();
                    break;
                case 'results':
                    html = renderResults();
                    break;
                case 'history':
                    html = renderHistory();
                    break;
                case 'admin':
                    html = renderAdmin();
                    break;
                case 'competitor':
                    html = renderCompetitor();
                    break;
                case 'trends':
                    html = renderTrends();
                    break;
                case 'thumbnail':
                    html = renderThumbnail();
                    break;
                case 'placement':
                    html = renderPlacement();
                    break;
                case 'channelAudit':
                    html = renderChannelAudit();
                    break;
                case 'admin-reports':
                    html = renderAdminReports();
                    break;
                case 'report-editor':
                    html = renderReportEditor();
                    break;
                case 'client-reports':
                    html = renderClientReports();
                    break;
                case 'view-report':
                    html = renderViewReport();
                    break;
                default:
                    html = '<div class="view-container view-centered"><div class="spinner"></div></div>';
            }

            // Check if this is a view change (not just a re-render)
            var isViewChange = previousView !== null && previousView !== state.currentView;
            previousView = state.currentView;

            // Apply smooth transition for view changes
            if (isViewChange) {
                root.classList.add('view-transitioning');
                root.innerHTML = html;
                // Invalidate cached DOM references after DOM change
                cachedCountdownElements = null;
                // Use requestAnimationFrame for smoother transition
                requestAnimationFrame(function() {
                    root.classList.remove('view-transitioning');
                    root.classList.add('view-entering');
                    // Remove animation class after it completes
                    setTimeout(function() {
                        root.classList.remove('view-entering');
                    }, 250);
                });
            } else {
                root.innerHTML = html;
                // Invalidate cached DOM references after DOM change
                cachedCountdownElements = null;
            }

            // Render global header (notification bell) for authenticated views
            var existingHeader = document.getElementById('global-header-container');
            var headerHtml = renderGlobalHeader();
            if (headerHtml) {
                if (!existingHeader) {
                    existingHeader = document.createElement('div');
                    existingHeader.id = 'global-header-container';
                    document.body.appendChild(existingHeader);
                }
                existingHeader.innerHTML = headerHtml;
            } else if (existingHeader) {
                existingHeader.remove();
            }

            // Initialize mobile swipe dots and desktop carousel after DOM update (dashboard only)
            if (state.currentView === 'dashboard') {
                // Pre-hide carousel elements to prevent flash
                var carouselEl = document.getElementById('desktopUsageCarousel');
                var swipeEl = document.getElementById('usageSwipeContainer');
                if (carouselEl) carouselEl.classList.add('carousel-initializing');
                if (swipeEl) swipeEl.classList.add('carousel-initializing');

                // Use requestAnimationFrame instead of setTimeout for smoother init
                requestAnimationFrame(function() {
                    app.initSwipeDots();
                    app.initDesktopCarousel();
                    // Update aurora theme for time-aware colors
                    updateAuroraTheme();
                    // Show carousel elements after init
                    if (carouselEl) {
                        carouselEl.classList.remove('carousel-initializing');
                        carouselEl.classList.add('carousel-ready');
                    }
                    if (swipeEl) {
                        swipeEl.classList.remove('carousel-initializing');
                        swipeEl.classList.add('carousel-ready');
                    }
                });
            }

            // Render lightbox overlay if open
            if (state.lightboxOpen && state.lightboxImages.length > 0) {
                var lightboxHtml = '<div class="lightbox-overlay" onclick="app.closeLightbox()">';
                lightboxHtml += '<div class="lightbox-content" onclick="event.stopPropagation()">';
                lightboxHtml += '<button class="lightbox-close" onclick="app.closeLightbox()"></button>';

                // Navigation arrows
                if (state.lightboxImages.length > 1) {
                    if (state.lightboxIndex > 0) {
                        lightboxHtml += '<button class="lightbox-nav prev" onclick="app.prevLightboxImage()"></button>';
                    }
                    if (state.lightboxIndex < state.lightboxImages.length - 1) {
                        lightboxHtml += '<button class="lightbox-nav next" onclick="app.nextLightboxImage()"></button>';
                    }
                }

                // Current image
                var currentImg = state.lightboxImages[state.lightboxIndex];
                lightboxHtml += '<img src="' + currentImg + '" class="lightbox-image" alt="Screenshot" />';

                // Actions
                lightboxHtml += '<div class="lightbox-actions">';
                lightboxHtml += '<button class="lightbox-download" onclick="app.downloadImage(\'' + currentImg + '\', \'screenshot-' + (state.lightboxIndex + 1) + '.png\')"> Download Image</button>';
                lightboxHtml += '</div>';

                // Counter
                if (state.lightboxImages.length > 1) {
                    lightboxHtml += '<div class="lightbox-counter">' + (state.lightboxIndex + 1) + ' / ' + state.lightboxImages.length + '</div>';
                }

                lightboxHtml += '</div></div>';

                // Append to body
                var lightboxDiv = document.createElement('div');
                lightboxDiv.id = 'lightbox-container';
                lightboxDiv.innerHTML = lightboxHtml;
                document.body.appendChild(lightboxDiv);

                // Keyboard navigation
                document.onkeydown = function(e) {
                    if (!state.lightboxOpen) return;
                    if (e.key === 'Escape') app.closeLightbox();
                    if (e.key === 'ArrowLeft') app.prevLightboxImage();
                    if (e.key === 'ArrowRight') app.nextLightboxImage();
                };
            } else {
                // Remove lightbox if closed
                var existingLightbox = document.getElementById('lightbox-container');
                if (existingLightbox) existingLightbox.remove();
                document.onkeydown = null;
            }
        }

        /* ==========================================
           4.8 INITIALIZE APPLICATION
           ========================================== */

        // Initial render
        render();

    })();
    </script>
</body>
</html>
