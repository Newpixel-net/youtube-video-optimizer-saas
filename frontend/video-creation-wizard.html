<!-- ================================================================
     YOUTUBE VIDEO OPTIMIZER - VIDEO CREATION WIZARD
     ================================================================

     Structure:
     - SECTION 1: External Dependencies (CDN)
     - SECTION 2: Styles (CSS)
     - SECTION 3: HTML Container
     - SECTION 4: Configuration Data (Platforms, Niches, Styles)
     - SECTION 5: State Management
     - SECTION 6: Core Functions
     - SECTION 7: Render Functions

     Wizard Steps:
     1. Platform & Format - Select target platform and aspect ratio
     2. Niche & Style - Choose content niche and visual style
     3. Script Generation - AI generates video script with scenes
     4. Storyboard - Generate images for each scene
     5. Animation - Animate images to video (Runpod/Veo)
     6. Assembly - Combine scenes, add music, captions
     7. Export - Final render and download

     Video Generation Engines:
     - Runpod Multi-talk: 15-second clips, ~$0.03-0.05/clip
     - Google Veo 3.1: 8-second base (extendable), $0.15-0.40/second

     Access: All authenticated users (with token system)
     Last Updated: December 2025
     ================================================================ -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Video Creation Wizard - YouTubeHub</title>

    <!-- PWA Manifest & Theme -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"YouTubeHub Video Creator","short_name":"Video Creator","description":"AI-powered video creation from scratch","start_url":"/video-creation-wizard","display":"standalone","background_color":"#0f172a","theme_color":"#8b5cf6","orientation":"portrait-primary","icons":[{"src":"https://ytseo.siteuo.com/icon-192.png","sizes":"192x192","type":"image/png","purpose":"any maskable"},{"src":"https://ytseo.siteuo.com/icon-512.png","sizes":"512x512","type":"image/png","purpose":"any maskable"}]}'>
    <meta name="theme-color" content="#8b5cf6">

    <!-- ============================================
         SECTION 1: EXTERNAL DEPENDENCIES
         ============================================ -->

    <!-- 1.0 Performance: Preconnect & DNS Prefetch -->
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://firebasestorage.googleapis.com" crossorigin>
    <link rel="dns-prefetch" href="https://www.gstatic.com">
    <link rel="dns-prefetch" href="https://firestore.googleapis.com">

    <!-- 1.1 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 1.2 Firebase SDKs -->
    <link rel="preload" href="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js" as="script">
    <link rel="preload" href="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js" as="script">
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>

    <!-- ============================================
         SECTION 2: STYLES
         ============================================ -->
    <style>
        /* ------------------------------------------
           2.1 BASE & RESET
           ------------------------------------------ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }

        body {
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 1rem;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            color: white;
        }

        #app-root {
            width: 100%;
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }

        /* ------------------------------------------
           2.2 ANIMATIONS
           ------------------------------------------ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes gradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.3); }
            50% { box-shadow: 0 0 40px rgba(139, 92, 246, 0.6); }
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        .animate-pulse {
            animation: pulse 2s ease-in-out infinite;
        }

        .animate-float {
            animation: float 3s ease-in-out infinite;
        }

        .animate-glow {
            animation: glow 2s ease-in-out infinite;
        }

        .scale-in {
            animation: scaleIn 0.3s ease-out forwards;
        }

        /* ------------------------------------------
           2.3 WIZARD LAYOUT
           ------------------------------------------ */
        .wizard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
            min-height: 100vh;
        }

        .wizard-header {
            text-align: center;
            padding: 1.5rem 1rem;
            margin-bottom: 1rem;
        }

        .wizard-title {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 50%, #10b981 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .wizard-subtitle {
            color: rgba(255, 255, 255, 0.6);
            font-size: 1rem;
        }

        /* ------------------------------------------
           2.4 STEPPER
           ------------------------------------------ */
        .wizard-stepper {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.25rem;
            padding: 1rem 0.5rem;
            margin-bottom: 2rem;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .wizard-stepper::-webkit-scrollbar {
            display: none;
        }

        .wizard-step {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.6rem 1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .wizard-step:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .wizard-step.active {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(6, 182, 212, 0.2) 100%);
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
        }

        .wizard-step.completed {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .wizard-step.completed .step-number {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .step-number {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .wizard-step.active .step-number {
            background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%);
        }

        .step-label {
            font-size: 0.8rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
        }

        .wizard-step.active .step-label {
            color: white;
        }

        /* Step connector line */
        .step-connector {
            width: 20px;
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }

        .step-connector.completed {
            background: rgba(16, 185, 129, 0.5);
        }

        /* ------------------------------------------
           2.5 CONTENT CARDS
           ------------------------------------------ */
        .content-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1.5rem;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .content-card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .content-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(6, 182, 212, 0.2) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .content-card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
        }

        .content-card-subtitle {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.5);
        }

        /* ------------------------------------------
           2.6 PLATFORM CARDS
           ------------------------------------------ */
        .platform-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1rem;
        }

        .platform-card {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .platform-card:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .platform-card.selected {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(6, 182, 212, 0.15) 100%);
            border-color: rgba(139, 92, 246, 0.6);
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.2);
        }

        .platform-card-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
        }

        .platform-card-name {
            font-size: 1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.25rem;
        }

        .platform-card-info {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }

        /* ------------------------------------------
           2.7 FORMAT SELECTOR
           ------------------------------------------ */
        .format-selector {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .format-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .format-option:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .format-option.selected {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(6, 182, 212, 0.15) 100%);
            border-color: rgba(139, 92, 246, 0.6);
        }

        .format-option.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .format-preview {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .format-preview-box {
            background: rgba(139, 92, 246, 0.3);
            border: 2px solid rgba(139, 92, 246, 0.6);
            border-radius: 4px;
        }

        .format-preview-box.ratio-16-9 {
            width: 64px;
            height: 36px;
        }

        .format-preview-box.ratio-9-16 {
            width: 36px;
            height: 64px;
        }

        .format-preview-box.ratio-1-1 {
            width: 48px;
            height: 48px;
        }

        .format-preview-box.ratio-4-5 {
            width: 40px;
            height: 50px;
        }

        .format-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: white;
        }

        .format-desc {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
        }

        /* ------------------------------------------
           2.8 DURATION SLIDER
           ------------------------------------------ */
        .duration-container {
            margin-top: 1.5rem;
        }

        .duration-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .duration-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
        }

        .duration-value {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .duration-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        .duration-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
            transition: transform 0.2s ease;
        }

        .duration-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        .duration-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        }

        .duration-presets {
            display: flex;
            justify-content: space-between;
            margin-top: 0.75rem;
        }

        .duration-preset {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.4);
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .duration-preset:hover {
            color: rgba(255, 255, 255, 0.8);
        }

        /* ------------------------------------------
           2.9 NICHE GRID
           ------------------------------------------ */
        .niche-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.75rem;
        }

        .niche-card {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .niche-card:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .niche-card.selected {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(6, 182, 212, 0.15) 100%);
            border-color: rgba(139, 92, 246, 0.6);
        }

        .niche-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .niche-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: white;
        }

        /* Sub-niche chips */
        .subniche-container {
            margin-top: 1.5rem;
        }

        .subniche-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .subniche-chip {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 2rem;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .subniche-chip:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .subniche-chip.selected {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3) 0%, rgba(6, 182, 212, 0.3) 100%);
            border-color: rgba(139, 92, 246, 0.5);
            color: white;
        }

        /* ------------------------------------------
           2.10 STYLE GRID
           ------------------------------------------ */
        .style-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }

        .style-card {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            padding: 1.25rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .style-card:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .style-card.selected {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(6, 182, 212, 0.15) 100%);
            border-color: rgba(139, 92, 246, 0.6);
        }

        .style-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .style-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.25rem;
        }

        .style-desc {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
            line-height: 1.3;
        }

        /* ------------------------------------------
           2.11 TOPIC INPUT
           ------------------------------------------ */
        .topic-input-container {
            margin-top: 1.5rem;
        }

        .topic-input {
            width: 100%;
            padding: 1rem 1.25rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            color: white;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .topic-input:focus {
            border-color: rgba(139, 92, 246, 0.5);
            background: rgba(255, 255, 255, 0.08);
        }

        .topic-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .topic-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .topic-suggestion {
            padding: 0.4rem 0.8rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .topic-suggestion:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.4);
            color: white;
        }

        /* ------------------------------------------
           2.12 CONFIG TAGS
           ------------------------------------------ */
        .config-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.35rem 0.65rem;
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 0.5rem;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        /* ------------------------------------------
           2.13 NAVIGATION BUTTONS
           ------------------------------------------ */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .nav-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            border-radius: 1rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .nav-button-back {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
        }

        .nav-button-back:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-button-next {
            background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .nav-button-next:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }

        .nav-button-next:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* ------------------------------------------
           2.13 TOKEN DISPLAY
           ------------------------------------------ */
        .token-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 2rem;
            font-size: 0.85rem;
        }

        .token-icon {
            font-size: 1rem;
        }

        .token-count {
            font-weight: 700;
            background: linear-gradient(135deg, #f59e0b 0%, #eab308 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ------------------------------------------
           2.14 HEADER BAR
           ------------------------------------------ */
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .back-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s ease;
        }

        .back-link:hover {
            color: white;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* ------------------------------------------
           2.15 LOADING STATE
           ------------------------------------------ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 15, 26, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(139, 92, 246, 0.2);
            border-top-color: #8b5cf6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 1.5rem;
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* ------------------------------------------
           2.16 COST ESTIMATE PANEL
           ------------------------------------------ */
        .cost-estimate {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 1rem;
            padding: 1rem 1.25rem;
            margin-top: 1.5rem;
        }

        .cost-estimate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .cost-estimate-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
        }

        .cost-estimate-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #8b5cf6;
        }

        .cost-estimate-breakdown {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }

        /* ------------------------------------------
           2.17 RESPONSIVE ADJUSTMENTS
           ------------------------------------------ */
        @media (max-width: 768px) {
            .wizard-container {
                padding: 0.5rem;
            }

            .wizard-title {
                font-size: 1.5rem;
            }

            .wizard-stepper {
                justify-content: flex-start;
                padding: 0.75rem;
            }

            .wizard-step {
                padding: 0.5rem 0.75rem;
            }

            .step-label {
                display: none;
            }

            .content-card {
                padding: 1.25rem;
            }

            .platform-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .niche-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .style-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .format-selector {
                flex-direction: column;
                align-items: center;
            }

            .nav-buttons {
                flex-direction: column;
                gap: 1rem;
            }

            .nav-button {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- ============================================
         SECTION 3: HTML CONTAINER
         ============================================ -->
    <div id="app-root">
        <!-- Content rendered by JavaScript -->
        <div class="loading-overlay" id="initial-loading">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading Video Creation Wizard...</div>
        </div>
    </div>

    <!-- ============================================
         SECTION 4: CONFIGURATION DATA
         ============================================ -->
    <script>
        // ==========================================
        // 4.1 PLATFORM PRESETS
        // ==========================================
        const PLATFORM_PRESETS = {
            'youtube-long': {
                id: 'youtube-long',
                name: 'YouTube Long-form',
                icon: 'üì∫',
                formats: ['16:9'],
                defaultFormat: '16:9',
                resolution: { width: 1920, height: 1080 },
                maxDuration: 300,
                minDuration: 60,
                fps: 30,
                bitrate: '8M',
                description: 'Standard videos up to 5 min'
            },
            'youtube-shorts': {
                id: 'youtube-shorts',
                name: 'YouTube Shorts',
                icon: 'üì±',
                formats: ['9:16'],
                defaultFormat: '9:16',
                resolution: { width: 1080, height: 1920 },
                maxDuration: 60,
                minDuration: 15,
                fps: 30,
                bitrate: '4M',
                description: 'Vertical shorts up to 60s'
            },
            'tiktok': {
                id: 'tiktok',
                name: 'TikTok',
                icon: 'üéµ',
                formats: ['9:16', '16:9', '1:1'],
                defaultFormat: '9:16',
                resolution: { width: 1080, height: 1920 },
                maxDuration: 180,
                minDuration: 15,
                fps: 30,
                bitrate: '4M',
                description: 'Viral content up to 3 min'
            },
            'instagram-reels': {
                id: 'instagram-reels',
                name: 'Instagram Reels',
                icon: 'üì∏',
                formats: ['9:16'],
                defaultFormat: '9:16',
                resolution: { width: 1080, height: 1920 },
                maxDuration: 180,
                minDuration: 15,
                fps: 30,
                bitrate: '4M',
                description: 'Reels up to 3 min'
            },
            'instagram-feed': {
                id: 'instagram-feed',
                name: 'Instagram Feed',
                icon: 'üñºÔ∏è',
                formats: ['1:1', '4:5', '16:9'],
                defaultFormat: '1:1',
                resolution: { width: 1080, height: 1080 },
                maxDuration: 60,
                minDuration: 3,
                fps: 30,
                bitrate: '4M',
                description: 'Feed videos up to 60s'
            },
            'facebook-reels': {
                id: 'facebook-reels',
                name: 'Facebook Reels',
                icon: 'üëç',
                formats: ['9:16'],
                defaultFormat: '9:16',
                resolution: { width: 1080, height: 1920 },
                maxDuration: 90,
                minDuration: 3,
                fps: 30,
                bitrate: '4M',
                description: 'Reels up to 90s'
            },
            'facebook-feed': {
                id: 'facebook-feed',
                name: 'Facebook Feed',
                icon: 'üìò',
                formats: ['16:9', '1:1', '9:16'],
                defaultFormat: '16:9',
                resolution: { width: 1920, height: 1080 },
                maxDuration: 300,
                minDuration: 3,
                fps: 30,
                bitrate: '6M',
                description: 'Feed videos up to 5 min'
            },
            'linkedin': {
                id: 'linkedin',
                name: 'LinkedIn',
                icon: 'üíº',
                formats: ['16:9', '1:1', '4:5'],
                defaultFormat: '4:5',
                resolution: { width: 1080, height: 1350 },
                maxDuration: 300,
                minDuration: 3,
                fps: 30,
                bitrate: '5M',
                description: 'Professional videos up to 5 min'
            },
            'multi-platform': {
                id: 'multi-platform',
                name: 'Multi-Platform',
                icon: 'üåê',
                formats: ['9:16', '16:9', '1:1'],
                defaultFormat: '9:16',
                resolution: { width: 1080, height: 1920 },
                maxDuration: 60,
                minDuration: 15,
                fps: 30,
                bitrate: '4M',
                description: 'Optimized for all platforms'
            }
        };

        // ==========================================
        // 4.2 VIDEO NICHES
        // ==========================================
        const VIDEO_NICHES = {
            entertainment: {
                id: 'entertainment',
                name: 'Entertainment',
                icon: 'üé¨',
                subniches: [
                    { id: 'comedy', name: 'Comedy & Humor' },
                    { id: 'stories', name: 'Story Time' },
                    { id: 'reactions', name: 'Reactions' },
                    { id: 'celebrity', name: 'Pop Culture' },
                    { id: 'true-crime', name: 'True Crime' }
                ]
            },
            education: {
                id: 'education',
                name: 'Education',
                icon: 'üìö',
                subniches: [
                    { id: 'explainer', name: 'Explainer Videos' },
                    { id: 'tutorials', name: 'Tutorials' },
                    { id: 'science', name: 'Science & Tech' },
                    { id: 'history', name: 'History' },
                    { id: 'language', name: 'Language Learning' }
                ]
            },
            business: {
                id: 'business',
                name: 'Business',
                icon: 'üí∞',
                subniches: [
                    { id: 'investing', name: 'Investing' },
                    { id: 'entrepreneurship', name: 'Entrepreneurship' },
                    { id: 'productivity', name: 'Productivity' },
                    { id: 'career', name: 'Career Tips' },
                    { id: 'money-tips', name: 'Money Tips' }
                ]
            },
            health: {
                id: 'health',
                name: 'Health',
                icon: 'üí™',
                subniches: [
                    { id: 'fitness', name: 'Fitness' },
                    { id: 'nutrition', name: 'Nutrition' },
                    { id: 'mental-health', name: 'Mental Health' },
                    { id: 'meditation', name: 'Meditation' },
                    { id: 'self-improvement', name: 'Self Improvement' }
                ]
            },
            technology: {
                id: 'technology',
                name: 'Technology',
                icon: 'üíª',
                subniches: [
                    { id: 'tech-reviews', name: 'Tech Reviews' },
                    { id: 'ai-tech', name: 'AI & Future Tech' },
                    { id: 'coding', name: 'Coding' },
                    { id: 'gadgets', name: 'Gadgets' },
                    { id: 'gaming-tech', name: 'Gaming' }
                ]
            },
            creative: {
                id: 'creative',
                name: 'Creative',
                icon: 'üé®',
                subniches: [
                    { id: 'art-tutorials', name: 'Art Tutorials' },
                    { id: 'music', name: 'Music' },
                    { id: 'photography', name: 'Photography' },
                    { id: 'diy-crafts', name: 'DIY & Crafts' },
                    { id: 'animation', name: 'Animation' }
                ]
            },
            travel: {
                id: 'travel',
                name: 'Travel',
                icon: '‚úàÔ∏è',
                subniches: [
                    { id: 'travel-guides', name: 'Travel Guides' },
                    { id: 'food-travel', name: 'Food & Cuisine' },
                    { id: 'luxury', name: 'Luxury' },
                    { id: 'minimalism', name: 'Minimalism' },
                    { id: 'adventure', name: 'Adventure' }
                ]
            },
            motivation: {
                id: 'motivation',
                name: 'Motivation',
                icon: 'üî•',
                subniches: [
                    { id: 'motivational', name: 'Speeches' },
                    { id: 'quotes', name: 'Quotes' },
                    { id: 'success-stories', name: 'Success Stories' },
                    { id: 'life-lessons', name: 'Life Lessons' },
                    { id: 'spirituality', name: 'Spirituality' }
                ]
            },
            news: {
                id: 'news',
                name: 'News',
                icon: 'üì∞',
                subniches: [
                    { id: 'world-news', name: 'World News' },
                    { id: 'politics', name: 'Politics' },
                    { id: 'sports', name: 'Sports' },
                    { id: 'social-commentary', name: 'Commentary' }
                ]
            }
        };

        // ==========================================
        // 4.3 VIDEO STYLES
        // ==========================================
        const VIDEO_STYLES = {
            modern: {
                id: 'modern',
                name: 'Modern Minimalist',
                icon: '‚ú®',
                description: 'Clean, sleek aesthetics',
                imagePromptModifiers: 'minimalist, clean design, modern aesthetic, solid colors, geometric shapes',
                transitionStyle: 'smooth-fade',
                pacing: 'medium'
            },
            cinematic: {
                id: 'cinematic',
                name: 'Cinematic',
                icon: 'üé¨',
                description: 'Movie-quality visuals',
                imagePromptModifiers: 'cinematic lighting, dramatic, film quality, depth of field, professional photography',
                transitionStyle: 'cinematic-fade',
                pacing: 'slow'
            },
            energetic: {
                id: 'energetic',
                name: 'Energetic',
                icon: '‚ö°',
                description: 'Fast-paced, bold colors',
                imagePromptModifiers: 'vibrant colors, dynamic composition, energetic, bold, eye-catching',
                transitionStyle: 'quick-cuts',
                pacing: 'fast'
            },
            documentary: {
                id: 'documentary',
                name: 'Documentary',
                icon: 'üìπ',
                description: 'Authentic, raw style',
                imagePromptModifiers: 'documentary style, realistic, photojournalistic, authentic, raw',
                transitionStyle: 'simple-cut',
                pacing: 'medium'
            },
            retro: {
                id: 'retro',
                name: 'Retro/Vintage',
                icon: 'üìº',
                description: 'Nostalgic film grain',
                imagePromptModifiers: 'vintage aesthetic, retro style, film grain, warm tones, nostalgic',
                transitionStyle: 'vhs-glitch',
                pacing: 'medium'
            },
            futuristic: {
                id: 'futuristic',
                name: 'Futuristic',
                icon: 'üöÄ',
                description: 'High-tech, neon aesthetic',
                imagePromptModifiers: 'futuristic, sci-fi, neon lights, cyber, holographic, high-tech',
                transitionStyle: 'digital-glitch',
                pacing: 'medium-fast'
            },
            cartoon: {
                id: 'cartoon',
                name: 'Animated',
                icon: 'üé®',
                description: 'Illustrated, playful',
                imagePromptModifiers: 'cartoon style, illustrated, colorful, playful, digital art, animation style',
                transitionStyle: 'bounce',
                pacing: 'medium'
            },
            elegant: {
                id: 'elegant',
                name: 'Elegant & Luxury',
                icon: 'üëë',
                description: 'Sophisticated, premium',
                imagePromptModifiers: 'luxury, elegant, sophisticated, premium quality, gold accents, refined',
                transitionStyle: 'smooth-elegant',
                pacing: 'slow'
            },
            nature: {
                id: 'nature',
                name: 'Nature & Organic',
                icon: 'üåø',
                description: 'Natural, calming',
                imagePromptModifiers: 'natural, organic, earthy tones, peaceful, nature photography, serene',
                transitionStyle: 'soft-dissolve',
                pacing: 'slow'
            },
            dark: {
                id: 'dark',
                name: 'Dark & Moody',
                icon: 'üåô',
                description: 'Dramatic, mysterious',
                imagePromptModifiers: 'dark mood, dramatic shadows, mysterious, noir style, moody lighting',
                transitionStyle: 'fade-dark',
                pacing: 'medium'
            }
        };

        // ==========================================
        // 4.4 FORMAT DISPLAY INFO
        // ==========================================
        const FORMAT_INFO = {
            '16:9': { name: 'Landscape', ratio: '16:9', className: 'ratio-16-9', desc: 'Wide screen' },
            '9:16': { name: 'Portrait', ratio: '9:16', className: 'ratio-9-16', desc: 'Vertical' },
            '1:1': { name: 'Square', ratio: '1:1', className: 'ratio-1-1', desc: 'Square' },
            '4:5': { name: 'Portrait', ratio: '4:5', className: 'ratio-4-5', desc: 'Tall' }
        };

        // ==========================================
        // 4.5 WIZARD STEPS
        // ==========================================
        const WIZARD_STEPS = [
            { num: 1, label: 'Platform', icon: 'üì±' },
            { num: 2, label: 'Niche & Style', icon: 'üé®' },
            { num: 3, label: 'Script', icon: 'üìù' },
            { num: 4, label: 'Storyboard', icon: 'üñºÔ∏è' },
            { num: 5, label: 'Animation', icon: 'üé¨' },
            { num: 6, label: 'Assembly', icon: 'üîß' },
            { num: 7, label: 'Export', icon: 'üì§' }
        ];

        // ==========================================
        // 4.6 TOPIC SUGGESTIONS BY NICHE
        // ==========================================
        const TOPIC_SUGGESTIONS = {
            entertainment: ['Top 10 plot twists', 'Hidden movie details', 'Celebrity facts you didn\'t know'],
            education: ['How X really works', '5 things school didn\'t teach you', 'The science behind Y'],
            business: ['Money habits of millionaires', 'Side hustle ideas', 'Investing mistakes to avoid'],
            health: ['Morning routine hacks', 'Foods that boost energy', 'Quick workout tips'],
            technology: ['AI tools you need', 'Tech predictions for 2025', 'Hidden phone features'],
            creative: ['Art techniques explained', 'Music production tips', 'Design trends'],
            travel: ['Hidden gem destinations', 'Travel hacks', 'Best street food cities'],
            motivation: ['Success mindset', 'Overcoming failure', 'Daily habits of winners'],
            news: ['Breaking down the headlines', 'What this means for you', 'Expert analysis']
        };
    </script>

    <!-- ============================================
         SECTION 5: STATE MANAGEMENT
         ============================================ -->
    <script>
        // ==========================================
        // 5.1 APPLICATION STATE
        // ==========================================
        const state = {
            // User & Auth
            user: null,
            isLoading: true,

            // Token system
            tokens: {
                balance: 0,
                plan: 'free'
            },

            // Current wizard step
            currentStep: 1,
            maxReachedStep: 1,

            // Project metadata
            project: {
                id: null,
                name: 'Untitled Video',
                createdAt: null,
                updatedAt: null
            },

            // Step 1: Platform & Format
            platform: {
                selected: null,           // Platform ID
                preset: null,             // Full preset object
                aspectRatio: null,        // Selected aspect ratio
                targetDuration: 60        // Target duration in seconds
            },

            // Step 2: Niche & Style
            content: {
                niche: null,              // Niche ID
                subniche: null,           // Sub-niche ID
                style: null,              // Style ID
                topic: '',                // User's topic/theme
                tone: 'engaging'          // casual, professional, humorous, serious
            },

            // Step 3: Script
            script: {
                status: 'idle',
                title: '',
                hook: '',
                scenes: [],
                cta: '',
                totalDuration: 0,
                expandedScene: null,  // Track which scene is expanded in editor
                metadata: null,       // AI-generated metadata
                generatedAt: null,
                generationConfig: null
            },

            // Step 4: Storyboard
            storyboard: {
                status: 'idle', // idle, generating, ready, error
                scenes: [],     // Array of { sceneId, status, imageUrl, prompt, jobId }
                characterReference: null,
                styleReference: null,
                modifyingScene: null,  // Scene ID being modified in modal
                modifyPrompt: null,    // Current prompt in modify modal
                modifyStyle: null      // Current style in modify modal
            },

            // Step 5: Animation (to be implemented)
            animation: {
                status: 'idle',
                scenes: [],
                voiceover: {
                    voice: 'default',
                    speed: 1.0,
                    status: 'idle'
                }
            },

            // Step 6: Assembly
            assembly: {
                status: 'idle',
                sceneOrder: [],
                transitions: {},
                music: { enabled: false, trackId: null, volume: 30 },
                captions: { enabled: true, style: 'karaoke', position: 'bottom', fontSize: 'medium' },
                audioMix: { voiceVolume: 100, musicVolume: 30 },
                musicLibrary: [],
                transitionTypes: [],
                captionStyles: []
            },

            // Step 7: Export (to be implemented)
            export: {
                status: 'idle',
                jobId: null,
                progress: 0,
                outputUrl: null
            }
        };

        // ==========================================
        // 5.2 STATE HELPERS
        // ==========================================
        function updateState(path, value) {
            const keys = path.split('.');
            let current = state;
            for (let i = 0; i < keys.length - 1; i++) {
                current = current[keys[i]];
            }
            current[keys[keys.length - 1]] = value;
        }

        function getState(path) {
            const keys = path.split('.');
            let current = state;
            for (const key of keys) {
                current = current[key];
            }
            return current;
        }
    </script>

    <!-- ============================================
         SECTION 6: CORE FUNCTIONS
         ============================================ -->
    <script>
        // ==========================================
        // 6.1 FIREBASE INITIALIZATION
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyAi7vT3k2QCYw3c6h6IMp9pZdXVGjqNGS0",
            authDomain: "ytseo-6d1b0.firebaseapp.com",
            projectId: "ytseo-6d1b0",
            storageBucket: "ytseo-6d1b0.firebasestorage.app",
            messagingSenderId: "363779069774",
            appId: "1:363779069774:web:1c9eb0be0abf8d5c2a7f66"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const functions = firebase.functions();
        const storage = firebase.storage();

        // ==========================================
        // 6.2 AUTHENTICATION
        // ==========================================
        async function initAuth() {
            return new Promise((resolve, reject) => {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        state.user = user;
                        await loadUserTokens();
                        resolve(user);
                    } else {
                        // Redirect to login
                        window.location.href = '/video-optimizer';
                        reject('Not authenticated');
                    }
                });
            });
        }

        async function loadUserTokens() {
            try {
                const userDoc = await db.collection('users').doc(state.user.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    state.tokens.balance = userData.creativeTokens || userData.tokens || 0;
                    state.tokens.plan = userData.plan || 'free';
                }
            } catch (error) {
                console.error('Error loading tokens:', error);
            }
        }

        // ==========================================
        // 6.3 PROJECT SAVE/LOAD
        // ==========================================
        let saveDebounceTimer = null;
        let isSaving = false;

        function scheduleAutoSave() {
            // Don't auto-save if no project ID yet (new project needs explicit save)
            if (!state.project.id) return;

            // Debounce to avoid too many saves
            if (saveDebounceTimer) {
                clearTimeout(saveDebounceTimer);
            }
            saveDebounceTimer = setTimeout(() => {
                saveProject(true); // true = silent save
            }, 2000);
        }

        async function saveProject(silent = false) {
            if (isSaving) return;
            isSaving = true;

            try {
                const saveProjectFn = functions.httpsCallable('creationWizardSaveProject');

                const projectData = {
                    name: state.project.name || generateProjectName(),
                    status: state.project.status,
                    platform: state.platform,
                    content: state.content,
                    script: state.script,
                    storyboard: state.storyboard,
                    animation: state.animation,
                    assembly: state.assembly,
                    export: state.export
                };

                const result = await saveProjectFn({
                    projectId: state.project.id || null,
                    projectData
                });

                if (result.data.success) {
                    state.project.id = result.data.projectId;
                    state.project.updatedAt = new Date().toISOString();

                    // Update URL with project ID
                    if (window.history.replaceState) {
                        const url = new URL(window.location);
                        url.searchParams.set('project', state.project.id);
                        window.history.replaceState({}, '', url);
                    }

                    if (!silent) {
                        showToast('Project saved', 'success');
                    }
                }
            } catch (error) {
                console.error('Save project error:', error);
                if (!silent) {
                    showToast('Failed to save project', 'error');
                }
            } finally {
                isSaving = false;
            }
        }

        async function loadProject(projectId) {
            state.isLoading = true;
            render();

            try {
                const loadProjectFn = functions.httpsCallable('creationWizardLoadProject');
                const result = await loadProjectFn({ projectId });

                if (result.data.success) {
                    const project = result.data.project;

                    // Restore state from project
                    state.project.id = project.id;
                    state.project.name = project.name;
                    state.project.status = project.status;
                    state.project.createdAt = project.createdAt;
                    state.project.updatedAt = project.updatedAt;

                    // Restore platform config
                    if (project.platform) {
                        state.platform = { ...state.platform, ...project.platform };
                        // Restore preset if platform was selected
                        if (project.platform.selected && PLATFORM_PRESETS[project.platform.selected]) {
                            state.platform.preset = PLATFORM_PRESETS[project.platform.selected];
                        }
                    }

                    // Restore content config
                    if (project.content) {
                        state.content = { ...state.content, ...project.content };
                    }

                    // Restore script data
                    if (project.script) {
                        state.script = { ...state.script, ...project.script };
                    }

                    // Restore storyboard data
                    if (project.storyboard) {
                        state.storyboard = { ...state.storyboard, ...project.storyboard };
                    }

                    // Restore animation data
                    if (project.animation) {
                        state.animation = { ...state.animation, ...project.animation };
                    }

                    // Restore assembly data
                    if (project.assembly) {
                        state.assembly = { ...state.assembly, ...project.assembly };
                    }

                    // Restore export data
                    if (project.export) {
                        state.export = { ...state.export, ...project.export };
                    }

                    // Calculate max reached step based on completed data
                    state.maxReachedStep = calculateMaxReachedStep();

                    showToast('Project loaded', 'success');
                }
            } catch (error) {
                console.error('Load project error:', error);
                showToast('Failed to load project', 'error');
            } finally {
                state.isLoading = false;
                render();
            }
        }

        async function loadProjectsList() {
            try {
                const getProjectsFn = functions.httpsCallable('creationWizardGetProjects');
                const result = await getProjectsFn({ limit: 20 });

                if (result.data.success) {
                    return result.data.projects;
                }
                return [];
            } catch (error) {
                console.error('Load projects list error:', error);
                return [];
            }
        }

        async function deleteProject(projectId) {
            if (!confirm('Are you sure you want to delete this project?')) return;

            try {
                const deleteProjectFn = functions.httpsCallable('creationWizardDeleteProject');
                await deleteProjectFn({ projectId });
                showToast('Project deleted', 'success');

                // If we deleted the current project, start fresh
                if (state.project.id === projectId) {
                    window.location.href = '/video-creation-wizard';
                }
            } catch (error) {
                console.error('Delete project error:', error);
                showToast('Failed to delete project', 'error');
            }
        }

        function generateProjectName() {
            const niche = state.content.niche ? VIDEO_NICHES[state.content.niche]?.name : '';
            const topic = state.content.topic ? ` - ${state.content.topic.slice(0, 30)}` : '';
            const date = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            return `${niche || 'Video'} Project${topic} (${date})`;
        }

        function calculateMaxReachedStep() {
            if (state.export.status === 'complete') return 7;
            if (state.assembly.status === 'ready') return 7;
            if (state.animation.scenes.length > 0) return 6;
            if (state.storyboard.scenes.length > 0) return 5;
            if (state.script.scenes.length > 0) return 4;
            if (state.content.niche && state.content.style) return 3;
            if (state.platform.selected) return 2;
            return 1;
        }

        function checkUrlForProject() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('project');
            if (projectId) {
                return projectId;
            }
            return null;
        }

        // ==========================================
        // 6.4 NAVIGATION
        // ==========================================
        function goToStep(step) {
            // Validate step transition
            if (step < 1 || step > WIZARD_STEPS.length) return;
            if (step > state.maxReachedStep + 1) return;

            // Validate current step is complete before moving forward
            if (step > state.currentStep && !isStepComplete(state.currentStep)) {
                showToast('Please complete the current step first', 'warning');
                return;
            }

            state.currentStep = step;
            if (step > state.maxReachedStep) {
                state.maxReachedStep = step;
            }

            render();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function isStepComplete(step) {
            switch (step) {
                case 1:
                    return state.platform.selected && state.platform.aspectRatio;
                case 2:
                    return state.content.niche && state.content.style;
                case 3:
                    return state.script.scenes.length > 0;
                case 4:
                    return state.storyboard.scenes.length > 0;
                case 5:
                    return state.animation.scenes.length > 0;
                case 6:
                    return state.assembly.status === 'ready';
                default:
                    return true;
            }
        }

        // ==========================================
        // 6.4 PLATFORM SELECTION
        // ==========================================
        function selectPlatform(platformId) {
            const preset = PLATFORM_PRESETS[platformId];
            if (!preset) return;

            state.platform.selected = platformId;
            state.platform.preset = preset;
            state.platform.aspectRatio = preset.defaultFormat;
            state.platform.targetDuration = Math.min(
                preset.maxDuration,
                Math.max(preset.minDuration, state.platform.targetDuration)
            );

            render();
            scheduleAutoSave();
        }

        function selectFormat(format) {
            if (!state.platform.preset) return;
            if (!state.platform.preset.formats.includes(format)) return;

            state.platform.aspectRatio = format;

            // Update resolution based on format
            const resolutions = {
                '16:9': { width: 1920, height: 1080 },
                '9:16': { width: 1080, height: 1920 },
                '1:1': { width: 1080, height: 1080 },
                '4:5': { width: 1080, height: 1350 }
            };
            state.platform.preset.resolution = resolutions[format];

            render();
            scheduleAutoSave();
        }

        function setDuration(duration) {
            if (!state.platform.preset) return;
            const preset = state.platform.preset;
            state.platform.targetDuration = Math.min(
                preset.maxDuration,
                Math.max(preset.minDuration, parseInt(duration))
            );
            render();
            scheduleAutoSave();
        }

        // ==========================================
        // 6.6 NICHE & STYLE SELECTION
        // ==========================================
        function selectNiche(nicheId) {
            state.content.niche = nicheId;
            state.content.subniche = null; // Reset subniche
            render();
            scheduleAutoSave();
        }

        function selectSubniche(subnicheId) {
            state.content.subniche = subnicheId;
            render();
            scheduleAutoSave();
        }

        function selectStyle(styleId) {
            state.content.style = styleId;
            render();
            scheduleAutoSave();
        }

        function setTopic(topic) {
            state.content.topic = topic;
            scheduleAutoSave();
        }

        function applyTopicSuggestion(topic) {
            state.content.topic = topic;
            render();
            scheduleAutoSave();
        }

        // ==========================================
        // 6.7 SCRIPT GENERATION & EDITING
        // ==========================================
        function setScriptTone(tone) {
            state.content.tone = tone;
            render();
        }

        async function generateScript() {
            // Get topic from input
            const topicInput = document.getElementById('script-topic');
            const instructionsInput = document.getElementById('script-instructions');

            const topic = topicInput?.value?.trim() || state.content.topic;
            const additionalInstructions = instructionsInput?.value?.trim() || '';

            if (!topic || topic.length < 3) {
                showToast('Please enter a topic for your video', 'warning');
                return;
            }

            // Update state
            state.content.topic = topic;
            state.script.status = 'generating';
            render();

            try {
                const generateScriptFn = functions.httpsCallable('creationWizardGenerateScript');

                const config = {
                    platform: state.platform.selected,
                    aspectRatio: state.platform.aspectRatio,
                    targetDuration: state.platform.targetDuration,
                    niche: state.content.niche,
                    subniche: state.content.subniche,
                    style: state.content.style,
                    topic: topic,
                    tone: state.content.tone || 'engaging',
                    additionalInstructions
                };

                const result = await generateScriptFn({
                    projectId: state.project.id || null,
                    config
                });

                if (result.data.success) {
                    const script = result.data.script;

                    // Update state with generated script
                    state.script = {
                        ...state.script,
                        ...script,
                        status: 'generated',
                        expandedScene: null
                    };

                    // Update project ID if new project was created
                    if (result.data.projectId && !state.project.id) {
                        state.project.id = result.data.projectId;
                    }

                    showToast('Script generated successfully!', 'success');
                    scheduleAutoSave();
                } else {
                    throw new Error('Script generation failed');
                }
            } catch (error) {
                console.error('Script generation error:', error);
                state.script.status = 'idle';
                showToast('Failed to generate script. Please try again.', 'error');
            }

            render();
        }

        async function regenerateFullScript() {
            if (!confirm('This will replace your current script. Continue?')) return;

            state.script.status = 'idle';
            state.script.scenes = [];
            state.script.title = '';
            state.script.hook = '';
            state.script.cta = '';
            render();
        }

        function updateScriptTitle(title) {
            state.script.title = title;
            scheduleAutoSave();
        }

        function updateScriptHook(hook) {
            state.script.hook = hook;
            scheduleAutoSave();
        }

        function updateScriptCTA(cta) {
            state.script.cta = cta;
            scheduleAutoSave();
        }

        function toggleSceneExpand(sceneId) {
            if (state.script.expandedScene === sceneId) {
                state.script.expandedScene = null;
            } else {
                state.script.expandedScene = sceneId;
            }
            render();
        }

        function updateSceneNarration(sceneId, value) {
            const scene = state.script.scenes.find(s => s.id === sceneId);
            if (scene) {
                scene.narration = value;
                scheduleAutoSave();
            }
        }

        function updateSceneVisual(sceneId, value) {
            const scene = state.script.scenes.find(s => s.id === sceneId);
            if (scene) {
                scene.visual = value;
                scheduleAutoSave();
            }
        }

        function updateSceneDuration(sceneId, value) {
            const scene = state.script.scenes.find(s => s.id === sceneId);
            if (scene) {
                scene.duration = parseInt(value) || 8;
                // Recalculate total duration
                state.script.totalDuration = state.script.scenes.reduce((sum, s) => sum + s.duration, 0);
                scheduleAutoSave();
                render();
            }
        }

        function updateSceneTransition(sceneId, value) {
            const scene = state.script.scenes.find(s => s.id === sceneId);
            if (scene) {
                scene.transition = value;
                scheduleAutoSave();
            }
        }

        async function regenerateScene(sceneId) {
            const scene = state.script.scenes.find(s => s.id === sceneId);
            if (!scene) return;

            const instructions = prompt('Any specific instructions for regenerating this scene? (or leave empty)');

            try {
                showToast('Regenerating scene...', 'info');

                const regenerateSceneFn = functions.httpsCallable('creationWizardRegenerateScene');
                const result = await regenerateSceneFn({
                    projectId: state.project.id,
                    sceneId: sceneId,
                    currentScript: state.script,
                    instructions: instructions || ''
                });

                if (result.data.success) {
                    // Update the scene in state
                    const index = state.script.scenes.findIndex(s => s.id === sceneId);
                    if (index !== -1) {
                        state.script.scenes[index] = {
                            ...state.script.scenes[index],
                            ...result.data.scene
                        };
                    }

                    showToast('Scene regenerated!', 'success');
                    scheduleAutoSave();
                    render();
                }
            } catch (error) {
                console.error('Regenerate scene error:', error);
                showToast('Failed to regenerate scene', 'error');
            }
        }

        function moveSceneUp(sceneId) {
            const index = state.script.scenes.findIndex(s => s.id === sceneId);
            if (index > 0) {
                const temp = state.script.scenes[index];
                state.script.scenes[index] = state.script.scenes[index - 1];
                state.script.scenes[index - 1] = temp;
                scheduleAutoSave();
                render();
            }
        }

        function moveSceneDown(sceneId) {
            const index = state.script.scenes.findIndex(s => s.id === sceneId);
            if (index < state.script.scenes.length - 1) {
                const temp = state.script.scenes[index];
                state.script.scenes[index] = state.script.scenes[index + 1];
                state.script.scenes[index + 1] = temp;
                scheduleAutoSave();
                render();
            }
        }

        function deleteScene(sceneId) {
            if (state.script.scenes.length <= 1) {
                showToast('You need at least one scene', 'warning');
                return;
            }

            if (!confirm('Delete this scene?')) return;

            state.script.scenes = state.script.scenes.filter(s => s.id !== sceneId);
            state.script.totalDuration = state.script.scenes.reduce((sum, s) => sum + s.duration, 0);
            scheduleAutoSave();
            render();
        }

        function addNewScene() {
            const maxId = Math.max(...state.script.scenes.map(s => s.id), 0);
            const newScene = {
                id: maxId + 1,
                narration: '',
                visual: '',
                duration: 10,
                transition: 'cut',
                status: 'pending'
            };

            state.script.scenes.push(newScene);
            state.script.expandedScene = newScene.id;
            state.script.totalDuration = state.script.scenes.reduce((sum, s) => sum + s.duration, 0);
            scheduleAutoSave();
            render();

            // Scroll to new scene
            setTimeout(() => {
                const sceneCards = document.querySelectorAll('.scene-card');
                if (sceneCards.length > 0) {
                    sceneCards[sceneCards.length - 1].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }

        // ==========================================
        // 6.8 STORYBOARD GENERATION
        // ==========================================
        let imagePollingIntervals = {};

        async function generateInitialStoryboard() {
            const scenes = state.script.scenes || [];
            if (scenes.length === 0) return;

            // Only generate first 4 scenes automatically
            const maxInitialScenes = 4;
            const scenesToGenerate = scenes.slice(0, maxInitialScenes);

            state.storyboard.status = 'generating';

            // Initialize storyboard scenes with generating status
            state.storyboard.scenes = scenes.map((scene, index) => ({
                sceneId: scene.id,
                status: index < maxInitialScenes ? 'generating' : 'pending',
                imageUrl: null,
                prompt: scene.visual || '',
                jobId: null
            }));

            render();

            try {
                const generateFn = functions.httpsCallable('creationWizardGenerateInitialStoryboard');
                const result = await generateFn({
                    projectId: state.project.id,
                    scenes: scenesToGenerate,
                    style: state.content.style,
                    aspectRatio: state.platform.aspectRatio
                });

                if (result.data.success) {
                    // Update state with job IDs and start polling
                    result.data.jobs.forEach(job => {
                        const storyboardScene = state.storyboard.scenes.find(s => s.sceneId === job.sceneId);
                        if (storyboardScene) {
                            storyboardScene.jobId = job.jobId;
                            storyboardScene.imageUrl = job.imageUrl;
                            storyboardScene.prompt = job.prompt;
                            // Start polling for this job
                            startImagePolling(job.sceneId, job.jobId);
                        }
                    });

                    render();
                }
            } catch (error) {
                console.error('Initial storyboard generation error:', error);
                showToast('Failed to start image generation', 'error');

                // Mark all as error
                state.storyboard.scenes.forEach(s => {
                    if (s.status === 'generating') s.status = 'error';
                });
                state.storyboard.status = 'error';
                render();
            }
        }

        async function generateSingleSceneImage(sceneId) {
            const scene = state.script.scenes.find(s => s.id === sceneId);
            if (!scene) return;

            // Find or create storyboard entry
            let storyboardScene = state.storyboard.scenes.find(s => s.sceneId === sceneId);
            if (!storyboardScene) {
                storyboardScene = {
                    sceneId: sceneId,
                    status: 'pending',
                    imageUrl: null,
                    prompt: scene.visual || '',
                    jobId: null
                };
                state.storyboard.scenes.push(storyboardScene);
            }

            storyboardScene.status = 'generating';
            render();

            try {
                const generateFn = functions.httpsCallable('creationWizardGenerateSceneImage');
                const result = await generateFn({
                    projectId: state.project.id,
                    sceneId: sceneId,
                    prompt: scene.visual || scene.narration || 'A cinematic scene',
                    style: state.content.style,
                    aspectRatio: state.platform.aspectRatio
                });

                if (result.data.success) {
                    storyboardScene.jobId = result.data.jobId;
                    storyboardScene.imageUrl = result.data.imageUrl;
                    storyboardScene.prompt = result.data.prompt;

                    // Start polling for completion
                    startImagePolling(sceneId, result.data.jobId);
                }
            } catch (error) {
                console.error('Single scene generation error:', error);
                storyboardScene.status = 'error';
                showToast('Failed to generate image', 'error');
                render();
            }
        }

        async function regenerateSingleSceneImage(sceneId) {
            await generateSingleSceneImage(sceneId);
        }

        function startImagePolling(sceneId, jobId) {
            // Clear any existing polling for this scene
            if (imagePollingIntervals[sceneId]) {
                clearInterval(imagePollingIntervals[sceneId]);
            }

            let pollCount = 0;
            const maxPolls = 60; // 2 minutes max (2s intervals)

            imagePollingIntervals[sceneId] = setInterval(async () => {
                pollCount++;

                if (pollCount > maxPolls) {
                    clearInterval(imagePollingIntervals[sceneId]);
                    const storyboardScene = state.storyboard.scenes.find(s => s.sceneId === sceneId);
                    if (storyboardScene && storyboardScene.status === 'generating') {
                        storyboardScene.status = 'error';
                        render();
                    }
                    return;
                }

                try {
                    const checkStatusFn = functions.httpsCallable('creationWizardCheckImageStatus');
                    const result = await checkStatusFn({ jobId });

                    if (result.data.status === 'COMPLETED') {
                        clearInterval(imagePollingIntervals[sceneId]);

                        const storyboardScene = state.storyboard.scenes.find(s => s.sceneId === sceneId);
                        if (storyboardScene) {
                            storyboardScene.status = 'ready';
                            // Image URL was set earlier, now it should be available
                        }

                        // Check if all generating scenes are done
                        const allDone = state.storyboard.scenes.every(s =>
                            s.status === 'ready' || s.status === 'pending' || s.status === 'error'
                        );
                        if (allDone) {
                            state.storyboard.status = 'ready';
                        }

                        render();
                        scheduleAutoSave();

                    } else if (result.data.status === 'FAILED') {
                        clearInterval(imagePollingIntervals[sceneId]);

                        const storyboardScene = state.storyboard.scenes.find(s => s.sceneId === sceneId);
                        if (storyboardScene) {
                            storyboardScene.status = 'error';
                        }
                        render();
                    }
                    // If IN_PROGRESS or IN_QUEUE, keep polling

                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 2000); // Poll every 2 seconds
        }

        // Modify Modal Functions
        function openModifyModal(sceneId) {
            const storyboardScene = state.storyboard.scenes.find(s => s.sceneId === sceneId);
            const scene = state.script.scenes.find(s => s.id === sceneId);

            state.storyboard.modifyingScene = sceneId;
            state.storyboard.modifyPrompt = storyboardScene?.prompt || scene?.visual || '';
            state.storyboard.modifyStyle = state.content.style || 'cinematic';

            render();
        }

        function closeModifyModal() {
            state.storyboard.modifyingScene = null;
            state.storyboard.modifyPrompt = null;
            state.storyboard.modifyStyle = null;
            render();
        }

        function setModifyStyle(style) {
            state.storyboard.modifyStyle = style;
            render();
        }

        function appendToModifyPrompt(text) {
            const input = document.getElementById('modify-prompt-input');
            if (input) {
                const currentPrompt = input.value.trim();
                input.value = currentPrompt ? `${currentPrompt}, ${text}` : text;
                state.storyboard.modifyPrompt = input.value;
            }
        }

        async function applyModifyAndGenerate() {
            const sceneId = state.storyboard.modifyingScene;
            if (!sceneId) return;

            const input = document.getElementById('modify-prompt-input');
            const newPrompt = input?.value?.trim();

            if (!newPrompt || newPrompt.length < 10) {
                showToast('Please enter a more detailed prompt', 'warning');
                return;
            }

            // Update the scene's visual description
            const scene = state.script.scenes.find(s => s.id === sceneId);
            if (scene) {
                scene.visual = newPrompt;
            }

            // Update storyboard scene
            let storyboardScene = state.storyboard.scenes.find(s => s.sceneId === sceneId);
            if (storyboardScene) {
                storyboardScene.prompt = newPrompt;
            }

            closeModifyModal();

            // Generate with new prompt
            await generateSingleSceneImage(sceneId);
        }

        // ==========================================
        // 6.9 COST ESTIMATION
        // ==========================================
        function estimateCost() {
            const duration = state.platform.targetDuration || 60;
            const sceneDuration = 10; // Average scene duration
            const sceneCount = Math.ceil(duration / sceneDuration);

            // Base costs (in tokens)
            const costs = {
                scriptGeneration: 5,
                imagesPerScene: 2, // HD quality
                voiceoverPer30s: 1,
                animationPerScene: 3, // Runpod Multi-talk
                export: 3
            };

            const totalImages = sceneCount * costs.imagesPerScene;
            const voiceoverUnits = Math.ceil(duration / 30);
            const animationCost = sceneCount * costs.animationPerScene;

            const total = costs.scriptGeneration +
                         totalImages +
                         (voiceoverUnits * costs.voiceoverPer30s) +
                         animationCost +
                         costs.export;

            return {
                total,
                breakdown: {
                    script: costs.scriptGeneration,
                    images: totalImages,
                    voiceover: voiceoverUnits * costs.voiceoverPer30s,
                    animation: animationCost,
                    export: costs.export
                },
                sceneCount
            };
        }

        // ==========================================
        // 6.7 UTILITY FUNCTIONS
        // ==========================================
        function formatDuration(seconds) {
            if (seconds < 60) {
                return `${seconds}s`;
            }
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return secs > 0 ? `${minutes}m ${secs}s` : `${minutes}m`;
        }

        function showToast(message, type = 'info') {
            // Simple toast implementation
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg text-white text-sm font-medium z-50 fade-in`;
            toast.style.background = type === 'warning' ? '#f59e0b' :
                                    type === 'error' ? '#ef4444' :
                                    type === 'success' ? '#10b981' : '#8b5cf6';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ==========================================
        // 6.8 PROJECTS MODAL
        // ==========================================
        let projectsModalOpen = false;

        async function openProjectsModal() {
            projectsModalOpen = true;
            renderProjectsModal();

            // Load projects list
            const projects = await loadProjectsList();
            renderProjectsModal(projects);
        }

        function closeProjectsModal() {
            projectsModalOpen = false;
            const modal = document.getElementById('projects-modal');
            if (modal) modal.remove();
        }

        function renderProjectsModal(projects = null) {
            // Remove existing modal if any
            const existing = document.getElementById('projects-modal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'projects-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                padding: 1rem;
            `;

            let content = `
                <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 1rem; width: 100%; max-width: 600px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
                    <div style="padding: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="color: white; font-size: 1.25rem; font-weight: 700;">My Video Projects</h2>
                        <button onclick="closeProjectsModal()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0.25rem;">√ó</button>
                    </div>
                    <div style="padding: 1rem; overflow-y: auto; flex: 1;">
            `;

            if (projects === null) {
                // Loading state
                content += `
                    <div style="text-align: center; padding: 3rem; color: rgba(255,255,255,0.6);">
                        <div class="animate-spin" style="width: 2rem; height: 2rem; border: 3px solid rgba(139,92,246,0.3); border-top-color: #8b5cf6; border-radius: 50%; margin: 0 auto 1rem;"></div>
                        Loading projects...
                    </div>
                `;
            } else if (projects.length === 0) {
                // Empty state
                content += `
                    <div style="text-align: center; padding: 3rem; color: rgba(255,255,255,0.6);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìÇ</div>
                        <p>No projects yet</p>
                        <p style="font-size: 0.85rem; margin-top: 0.5rem;">Create your first video to see it here!</p>
                    </div>
                `;
            } else {
                // Projects list
                projects.forEach(project => {
                    const isCurrent = state.project.id === project.id;
                    const nicheIcon = project.niche ? VIDEO_NICHES[project.niche]?.icon || 'üìπ' : 'üìπ';
                    const updatedDate = project.updatedAt ? new Date(project.updatedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'Unknown';

                    content += `
                        <div style="background: ${isCurrent ? 'rgba(139,92,246,0.2)' : 'rgba(255,255,255,0.05)'}; border: 1px solid ${isCurrent ? 'rgba(139,92,246,0.4)' : 'rgba(255,255,255,0.1)'}; border-radius: 0.75rem; padding: 1rem; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 1.5rem;">${nicheIcon}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="color: white; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${project.name || 'Untitled'}</div>
                                <div style="color: rgba(255,255,255,0.5); font-size: 0.8rem;">${project.platform || 'No platform'} ‚Ä¢ ${project.sceneCount} scenes ‚Ä¢ ${updatedDate}</div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                ${isCurrent ? '<span style="color: #8b5cf6; font-size: 0.75rem; font-weight: 600;">CURRENT</span>' : `
                                    <button onclick="loadProjectFromModal('${project.id}')" style="background: rgba(139,92,246,0.2); border: 1px solid rgba(139,92,246,0.4); border-radius: 0.5rem; padding: 0.4rem 0.75rem; color: white; cursor: pointer; font-size: 0.75rem;">Open</button>
                                `}
                                <button onclick="deleteProjectFromModal('${project.id}')" style="background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.4); border-radius: 0.5rem; padding: 0.4rem 0.5rem; color: #ef4444; cursor: pointer; font-size: 0.75rem;">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                });
            }

            content += `
                    </div>
                    <div style="padding: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                        <button onclick="startNewProject()" style="width: 100%; background: linear-gradient(135deg, #8b5cf6, #06b6d4); border: none; border-radius: 0.5rem; padding: 0.75rem; color: white; font-weight: 600; cursor: pointer;">
                            + New Project
                        </button>
                    </div>
                </div>
            `;

            modal.innerHTML = content;
            modal.onclick = (e) => {
                if (e.target === modal) closeProjectsModal();
            };

            document.body.appendChild(modal);
        }

        function loadProjectFromModal(projectId) {
            closeProjectsModal();
            window.location.href = `/video-creation-wizard?project=${projectId}`;
        }

        async function deleteProjectFromModal(projectId) {
            if (!confirm('Are you sure you want to delete this project?')) return;

            try {
                const deleteProjectFn = functions.httpsCallable('creationWizardDeleteProject');
                await deleteProjectFn({ projectId });

                // Reload projects list
                const projects = await loadProjectsList();
                renderProjectsModal(projects);

                // If we deleted the current project, reset state
                if (state.project.id === projectId) {
                    state.project.id = null;
                    state.project.name = null;
                    render();
                }

                showToast('Project deleted', 'success');
            } catch (error) {
                console.error('Delete error:', error);
                showToast('Failed to delete project', 'error');
            }
        }

        function startNewProject() {
            closeProjectsModal();
            window.location.href = '/video-creation-wizard';
        }
    </script>

    <!-- ============================================
         SECTION 7: RENDER FUNCTIONS
         ============================================ -->
    <script>
        // ==========================================
        // 7.1 MAIN RENDER FUNCTION
        // ==========================================
        function render() {
            const app = document.getElementById('app-root');

            let html = '';

            // Header bar
            html += renderHeaderBar();

            // Main container
            html += '<div class="wizard-container">';

            // Wizard header
            html += renderWizardHeader();

            // Stepper
            html += renderStepper();

            // Step content
            switch (state.currentStep) {
                case 1:
                    html += renderStep1Platform();
                    break;
                case 2:
                    html += renderStep2NicheStyle();
                    break;
                case 3:
                    html += renderStep3Script();
                    break;
                case 4:
                    html += renderStep4Storyboard();
                    break;
                case 5:
                    html += renderStep5Animation();
                    break;
                case 6:
                    html += renderStep6Assembly();
                    break;
                case 7:
                    html += renderStep7Export();
                    break;
            }

            html += '</div>'; // End wizard-container

            app.innerHTML = html;
            attachEventListeners();
        }

        // ==========================================
        // 7.2 HEADER BAR
        // ==========================================
        function renderHeaderBar() {
            const projectName = state.project.name || 'New Project';
            const isSaved = state.project.id !== null;

            return `
                <div class="header-bar">
                    <div class="header-left">
                        <a href="/video-optimizer" class="back-link">
                            <span>‚Üê</span>
                            <span>Dashboard</span>
                        </a>
                        <div class="project-info" style="margin-left: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">${projectName}</span>
                            ${isSaved ? '<span style="color: #10b981; font-size: 0.7rem;">Saved</span>' : '<span style="color: #f59e0b; font-size: 0.7rem;">Unsaved</span>'}
                        </div>
                    </div>
                    <div class="header-right" style="display: flex; align-items: center; gap: 1rem;">
                        <button onclick="openProjectsModal()" class="header-btn" style="background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 0.5rem; padding: 0.4rem 0.75rem; color: white; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 0.3rem;">
                            <span>üìÅ</span>
                            <span>Projects</span>
                        </button>
                        <button onclick="saveProject(false)" class="header-btn" style="background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.4); border-radius: 0.5rem; padding: 0.4rem 0.75rem; color: white; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 0.3rem;">
                            <span>üíæ</span>
                            <span>Save</span>
                        </button>
                        <div class="token-display">
                            <span class="token-icon">ü™ô</span>
                            <span class="token-count">${state.tokens.balance}</span>
                            <span style="color: rgba(255,255,255,0.5)">tokens</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==========================================
        // 7.3 WIZARD HEADER
        // ==========================================
        function renderWizardHeader() {
            return `
                <div class="wizard-header">
                    <h1 class="wizard-title">Video Creation Wizard</h1>
                    <p class="wizard-subtitle">Create professional AI-generated videos from scratch</p>
                </div>
            `;
        }

        // ==========================================
        // 7.4 STEPPER
        // ==========================================
        function renderStepper() {
            let html = '<div class="wizard-stepper">';

            WIZARD_STEPS.forEach((step, index) => {
                const isActive = state.currentStep === step.num;
                const isCompleted = state.currentStep > step.num;
                const isReachable = step.num <= state.maxReachedStep + 1;

                html += `
                    <div class="wizard-step ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}"
                         onclick="${isReachable ? `goToStep(${step.num})` : ''}"
                         style="${!isReachable ? 'opacity: 0.4; cursor: not-allowed;' : ''}">
                        <div class="step-number">
                            ${isCompleted ? '‚úì' : step.num}
                        </div>
                        <span class="step-label">${step.label}</span>
                    </div>
                `;

                // Add connector between steps
                if (index < WIZARD_STEPS.length - 1) {
                    html += `<div class="step-connector ${isCompleted ? 'completed' : ''}"></div>`;
                }
            });

            html += '</div>';
            return html;
        }

        // ==========================================
        // 7.5 STEP 1: PLATFORM & FORMAT
        // ==========================================
        function renderStep1Platform() {
            const selectedPlatform = state.platform.selected;
            const preset = state.platform.preset;

            let html = '<div class="fade-in">';

            // Platform Selection Card
            html += `
                <div class="content-card">
                    <div class="content-card-header">
                        <div class="content-card-icon">üì±</div>
                        <div>
                            <div class="content-card-title">Choose Platform</div>
                            <div class="content-card-subtitle">Where will your video be published?</div>
                        </div>
                    </div>

                    <div class="platform-grid">
            `;

            Object.values(PLATFORM_PRESETS).forEach(platform => {
                const isSelected = selectedPlatform === platform.id;
                html += `
                    <div class="platform-card ${isSelected ? 'selected' : ''}"
                         onclick="selectPlatform('${platform.id}')">
                        <div class="platform-card-icon">${platform.icon}</div>
                        <div class="platform-card-name">${platform.name}</div>
                        <div class="platform-card-info">${platform.description}</div>
                    </div>
                `;
            });

            html += '</div></div>';

            // Format Selection (only show if platform selected)
            if (preset) {
                html += `
                    <div class="content-card">
                        <div class="content-card-header">
                            <div class="content-card-icon">üìê</div>
                            <div>
                                <div class="content-card-title">Select Format</div>
                                <div class="content-card-subtitle">Choose aspect ratio for your video</div>
                            </div>
                        </div>

                        <div class="format-selector">
                `;

                const allFormats = ['16:9', '9:16', '1:1', '4:5'];
                allFormats.forEach(format => {
                    const isAvailable = preset.formats.includes(format);
                    const isSelected = state.platform.aspectRatio === format;
                    const info = FORMAT_INFO[format];

                    html += `
                        <div class="format-option ${isSelected ? 'selected' : ''} ${!isAvailable ? 'disabled' : ''}"
                             onclick="${isAvailable ? `selectFormat('${format}')` : ''}">
                            <div class="format-preview">
                                <div class="format-preview-box ${info.className}"></div>
                            </div>
                            <div class="format-label">${info.ratio}</div>
                            <div class="format-desc">${info.desc}</div>
                        </div>
                    `;
                });

                html += '</div>';

                // Duration Slider
                html += `
                    <div class="duration-container">
                        <div class="duration-header">
                            <span class="duration-label">Video Duration</span>
                            <span class="duration-value">${formatDuration(state.platform.targetDuration)}</span>
                        </div>
                        <input type="range"
                               class="duration-slider"
                               id="duration-slider"
                               min="${preset.minDuration}"
                               max="${preset.maxDuration}"
                               value="${state.platform.targetDuration}"
                               oninput="setDuration(this.value)">
                        <div class="duration-presets">
                            <span class="duration-preset" onclick="setDuration(${preset.minDuration})">${formatDuration(preset.minDuration)}</span>
                            <span class="duration-preset" onclick="setDuration(${Math.floor((preset.minDuration + preset.maxDuration) / 2)})">${formatDuration(Math.floor((preset.minDuration + preset.maxDuration) / 2))}</span>
                            <span class="duration-preset" onclick="setDuration(${preset.maxDuration})">${formatDuration(preset.maxDuration)}</span>
                        </div>
                    </div>
                `;

                // Cost Estimate
                const cost = estimateCost();
                html += `
                    <div class="cost-estimate">
                        <div class="cost-estimate-header">
                            <span class="cost-estimate-title">Estimated Cost</span>
                            <span class="cost-estimate-value">~${cost.total} tokens</span>
                        </div>
                        <div class="cost-estimate-breakdown">
                            ${cost.sceneCount} scenes ‚Ä¢ Script ${cost.breakdown.script} ‚Ä¢ Images ${cost.breakdown.images} ‚Ä¢ Voice ${cost.breakdown.voiceover} ‚Ä¢ Animation ${cost.breakdown.animation} ‚Ä¢ Export ${cost.breakdown.export}
                        </div>
                    </div>
                `;

                html += '</div>';
            }

            // Navigation
            html += renderNavButtons(null, isStepComplete(1) ? 2 : null);

            html += '</div>';
            return html;
        }

        // ==========================================
        // 7.6 STEP 2: NICHE & STYLE
        // ==========================================
        function renderStep2NicheStyle() {
            const selectedNiche = state.content.niche;
            const selectedSubniche = state.content.subniche;
            const selectedStyle = state.content.style;

            let html = '<div class="fade-in">';

            // Niche Selection Card
            html += `
                <div class="content-card">
                    <div class="content-card-header">
                        <div class="content-card-icon">üìÇ</div>
                        <div>
                            <div class="content-card-title">Select Your Niche</div>
                            <div class="content-card-subtitle">What category best describes your content?</div>
                        </div>
                    </div>

                    <div class="niche-grid">
            `;

            Object.values(VIDEO_NICHES).forEach(niche => {
                const isSelected = selectedNiche === niche.id;
                html += `
                    <div class="niche-card ${isSelected ? 'selected' : ''}"
                         onclick="selectNiche('${niche.id}')">
                        <div class="niche-icon">${niche.icon}</div>
                        <div class="niche-name">${niche.name}</div>
                    </div>
                `;
            });

            html += '</div>';

            // Sub-niche chips (if niche selected)
            if (selectedNiche && VIDEO_NICHES[selectedNiche]) {
                const niche = VIDEO_NICHES[selectedNiche];
                html += `
                    <div class="subniche-container">
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 0.75rem;">
                            Refine your focus (optional):
                        </div>
                        <div class="subniche-chips">
                `;

                niche.subniches.forEach(sub => {
                    const isSelected = selectedSubniche === sub.id;
                    html += `
                        <div class="subniche-chip ${isSelected ? 'selected' : ''}"
                             onclick="selectSubniche('${sub.id}')">
                            ${sub.name}
                        </div>
                    `;
                });

                html += '</div></div>';
            }

            html += '</div>';

            // Style Selection Card
            html += `
                <div class="content-card">
                    <div class="content-card-header">
                        <div class="content-card-icon">üé®</div>
                        <div>
                            <div class="content-card-title">Choose Visual Style</div>
                            <div class="content-card-subtitle">How should your video look and feel?</div>
                        </div>
                    </div>

                    <div class="style-grid">
            `;

            Object.values(VIDEO_STYLES).forEach(style => {
                const isSelected = selectedStyle === style.id;
                html += `
                    <div class="style-card ${isSelected ? 'selected' : ''}"
                         onclick="selectStyle('${style.id}')">
                        <div class="style-icon">${style.icon}</div>
                        <div class="style-name">${style.name}</div>
                        <div class="style-desc">${style.description}</div>
                    </div>
                `;
            });

            html += '</div></div>';

            // Topic Input Card
            html += `
                <div class="content-card">
                    <div class="content-card-header">
                        <div class="content-card-icon">üí°</div>
                        <div>
                            <div class="content-card-title">Video Topic (Optional)</div>
                            <div class="content-card-subtitle">Describe what your video should be about</div>
                        </div>
                    </div>

                    <div class="topic-input-container">
                        <input type="text"
                               class="topic-input"
                               id="topic-input"
                               placeholder="e.g., 5 habits of successful entrepreneurs"
                               value="${state.content.topic}"
                               onchange="setTopic(this.value)">
            `;

            // Topic suggestions based on niche
            if (selectedNiche && TOPIC_SUGGESTIONS[selectedNiche]) {
                html += '<div class="topic-suggestions">';
                TOPIC_SUGGESTIONS[selectedNiche].forEach(suggestion => {
                    html += `
                        <div class="topic-suggestion" onclick="applyTopicSuggestion('${suggestion}')">
                            ${suggestion}
                        </div>
                    `;
                });
                html += '</div>';
            }

            html += '</div></div>';

            // Navigation
            html += renderNavButtons(1, isStepComplete(2) ? 3 : null);

            html += '</div>';
            return html;
        }

        // ==========================================
        // 7.7 STEP 3: SCRIPT GENERATION
        // ==========================================
        function renderStep3Script() {
            const hasScript = state.script.scenes && state.script.scenes.length > 0;
            const isGenerating = state.script.status === 'generating';

            let html = '<div class="fade-in">';

            // If no script yet, show generation form
            if (!hasScript && !isGenerating) {
                html += renderScriptGenerationForm();
            }
            // If generating, show progress
            else if (isGenerating) {
                html += renderScriptGeneratingState();
            }
            // If script exists, show editor
            else {
                html += renderScriptEditor();
            }

            // Navigation
            html += renderNavButtons(2, hasScript ? 4 : null);

            html += '</div>';
            return html;
        }

        function renderScriptGenerationForm() {
            const niche = VIDEO_NICHES[state.content.niche];
            const style = VIDEO_STYLES.find(s => s.id === state.content.style);

            return `
                <div class="content-card">
                    <div class="content-card-header">
                        <div class="content-card-icon">‚ú®</div>
                        <div>
                            <div class="content-card-title">Generate Your Script</div>
                            <div class="content-card-subtitle">AI will create a professional video script based on your settings</div>
                        </div>
                    </div>

                    <!-- Summary of selections -->
                    <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 0.75rem; padding: 1rem; margin-bottom: 1.5rem;">
                        <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem;">Your video configuration:</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            <span class="config-tag">${state.platform.selected || 'Platform'}</span>
                            <span class="config-tag">${state.platform.aspectRatio || '16:9'}</span>
                            <span class="config-tag">${formatDuration(state.platform.targetDuration)}</span>
                            <span class="config-tag">${niche?.icon || ''} ${niche?.name || 'Niche'}</span>
                            <span class="config-tag">${style?.icon || ''} ${style?.name || 'Style'}</span>
                        </div>
                    </div>

                    <!-- Topic (editable) -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-size: 0.9rem; font-weight: 600; color: white; margin-bottom: 0.5rem;">
                            Video Topic
                        </label>
                        <input type="text"
                               id="script-topic"
                               class="topic-input"
                               value="${state.content.topic || ''}"
                               placeholder="e.g., 5 Morning Habits That Changed My Life"
                               style="width: 100%;">
                    </div>

                    <!-- Tone selector -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-size: 0.9rem; font-weight: 600; color: white; margin-bottom: 0.5rem;">
                            Script Tone
                        </label>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem;">
                            ${['engaging', 'professional', 'casual', 'inspirational'].map(tone => `
                                <button onclick="setScriptTone('${tone}')"
                                        class="tone-btn ${state.content.tone === tone ? 'selected' : ''}"
                                        style="padding: 0.6rem; border-radius: 0.5rem; border: 1px solid ${state.content.tone === tone ? 'rgba(139, 92, 246, 0.6)' : 'rgba(255,255,255,0.2)'}; background: ${state.content.tone === tone ? 'rgba(139, 92, 246, 0.2)' : 'rgba(255,255,255,0.05)'}; color: white; cursor: pointer; font-size: 0.8rem; text-transform: capitalize;">
                                    ${tone}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Additional instructions -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-size: 0.9rem; font-weight: 600; color: white; margin-bottom: 0.5rem;">
                            Additional Instructions <span style="color: rgba(255,255,255,0.5); font-weight: 400;">(optional)</span>
                        </label>
                        <textarea id="script-instructions"
                                  placeholder="Any specific requirements? e.g., Include a personal story, mention specific products, focus on beginners..."
                                  style="width: 100%; min-height: 80px; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; font-size: 0.9rem; resize: vertical;"></textarea>
                    </div>

                    <!-- Generate button -->
                    <button onclick="generateScript()"
                            class="generate-btn"
                            style="width: 100%; padding: 1rem; border-radius: 0.75rem; border: none; background: linear-gradient(135deg, #8b5cf6, #06b6d4); color: white; font-size: 1rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                        <span>ü™Ñ</span>
                        <span>Generate Script with AI</span>
                    </button>

                    <div style="text-align: center; margin-top: 1rem; color: rgba(255,255,255,0.5); font-size: 0.8rem;">
                        Estimated cost: ~5 tokens ‚Ä¢ Powered by GPT-4o
                    </div>
                </div>
            `;
        }

        function renderScriptGeneratingState() {
            return `
                <div class="content-card" style="text-align: center; padding: 4rem 2rem;">
                    <div class="animate-float" style="font-size: 4rem; margin-bottom: 1.5rem;">‚ú®</div>
                    <div style="font-size: 1.25rem; font-weight: 700; color: white; margin-bottom: 0.5rem;">
                        Generating Your Script...
                    </div>
                    <div style="color: rgba(255,255,255,0.6); margin-bottom: 2rem;">
                        AI is crafting an engaging script for your video
                    </div>
                    <div class="loading-bar" style="width: 200px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin: 0 auto; overflow: hidden;">
                        <div style="width: 30%; height: 100%; background: linear-gradient(90deg, #8b5cf6, #06b6d4); border-radius: 2px; animation: shimmer 1.5s infinite;"></div>
                    </div>
                </div>
            `;
        }

        function renderScriptEditor() {
            const script = state.script;

            let html = `
                <!-- Script Header -->
                <div class="content-card">
                    <div class="content-card-header">
                        <div class="content-card-icon">üìù</div>
                        <div style="flex: 1;">
                            <input type="text"
                                   id="script-title-input"
                                   value="${script.title || ''}"
                                   onchange="updateScriptTitle(this.value)"
                                   style="background: none; border: none; color: white; font-size: 1.1rem; font-weight: 700; width: 100%; outline: none;">
                            <div class="content-card-subtitle">${script.scenes.length} scenes ‚Ä¢ ${script.totalDuration || 0}s total</div>
                        </div>
                        <button onclick="regenerateFullScript()"
                                style="background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 0.5rem; padding: 0.5rem 1rem; color: white; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 0.3rem;">
                            <span>üîÑ</span> Regenerate
                        </button>
                    </div>

                    <!-- Hook -->
                    <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem;">
                        <div style="font-size: 0.75rem; color: #10b981; font-weight: 600; margin-bottom: 0.5rem;">üé£ HOOK</div>
                        <input type="text"
                               value="${script.hook || ''}"
                               onchange="updateScriptHook(this.value)"
                               style="width: 100%; background: none; border: none; color: white; font-size: 0.95rem; outline: none;">
                    </div>

                    <!-- Metadata -->
                    ${script.metadata ? `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1rem;">
                            <div style="background: rgba(255,255,255,0.05); border-radius: 0.5rem; padding: 0.75rem;">
                                <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5);">Target Audience</div>
                                <div style="font-size: 0.85rem; color: white;">${script.metadata.targetAudience || '-'}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.05); border-radius: 0.5rem; padding: 0.75rem;">
                                <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5);">Key Message</div>
                                <div style="font-size: 0.85rem; color: white;">${script.metadata.keyMessage || '-'}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.05); border-radius: 0.5rem; padding: 0.75rem;">
                                <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5);">Suggested Music</div>
                                <div style="font-size: 0.85rem; color: white;">${script.metadata.suggestedMusic || '-'}</div>
                            </div>
                        </div>
                    ` : ''}
                </div>

                <!-- Scenes -->
                <div class="content-card">
                    <div class="content-card-header">
                        <div class="content-card-icon">üé¨</div>
                        <div>
                            <div class="content-card-title">Scenes</div>
                            <div class="content-card-subtitle">Edit narration and visuals for each scene</div>
                        </div>
                        <button onclick="addNewScene()"
                                style="background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.4); border-radius: 0.5rem; padding: 0.5rem 1rem; color: white; cursor: pointer; font-size: 0.8rem;">
                            + Add Scene
                        </button>
                    </div>

                    <div class="scenes-list" style="display: flex; flex-direction: column; gap: 1rem;">
            `;

            // Render each scene
            script.scenes.forEach((scene, index) => {
                html += renderSceneCard(scene, index);
            });

            html += `
                    </div>
                </div>

                <!-- CTA -->
                <div class="content-card">
                    <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.75rem; padding: 1rem;">
                        <div style="font-size: 0.75rem; color: #ef4444; font-weight: 600; margin-bottom: 0.5rem;">üì¢ CALL TO ACTION</div>
                        <input type="text"
                               value="${script.cta || ''}"
                               onchange="updateScriptCTA(this.value)"
                               style="width: 100%; background: none; border: none; color: white; font-size: 0.95rem; outline: none;">
                    </div>
                </div>
            `;

            return html;
        }

        function renderSceneCard(scene, index) {
            const isExpanded = state.script.expandedScene === scene.id;

            return `
                <div class="scene-card" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.75rem; overflow: hidden;">
                    <!-- Scene Header -->
                    <div onclick="toggleSceneExpand(${scene.id})"
                         style="padding: 1rem; cursor: pointer; display: flex; align-items: center; gap: 1rem; border-bottom: ${isExpanded ? '1px solid rgba(255,255,255,0.1)' : 'none'};">
                        <div style="width: 2rem; height: 2rem; background: linear-gradient(135deg, #8b5cf6, #06b6d4); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">
                            ${index + 1}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="color: white; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ${scene.narration?.substring(0, 60) || 'No narration'}${scene.narration?.length > 60 ? '...' : ''}
                            </div>
                            <div style="color: rgba(255,255,255,0.5); font-size: 0.75rem;">
                                ${scene.duration}s ‚Ä¢ ${scene.transition || 'cut'}
                            </div>
                        </div>
                        <div style="color: rgba(255,255,255,0.5); transform: rotate(${isExpanded ? '180deg' : '0deg'}); transition: transform 0.2s;">‚ñº</div>
                    </div>

                    ${isExpanded ? `
                        <!-- Expanded Content -->
                        <div style="padding: 1rem;">
                            <!-- Narration -->
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem;">üéôÔ∏è Narration</label>
                                <textarea id="scene-narration-${scene.id}"
                                          onchange="updateSceneNarration(${scene.id}, this.value)"
                                          style="width: 100%; min-height: 60px; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; font-size: 0.9rem; resize: vertical;">${scene.narration || ''}</textarea>
                            </div>

                            <!-- Visual Description -->
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem;">üé® Visual Description (for AI image generation)</label>
                                <textarea id="scene-visual-${scene.id}"
                                          onchange="updateSceneVisual(${scene.id}, this.value)"
                                          style="width: 100%; min-height: 80px; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; font-size: 0.9rem; resize: vertical;">${scene.visual || ''}</textarea>
                            </div>

                            <!-- Duration & Transition -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem;">‚è±Ô∏è Duration (seconds)</label>
                                    <input type="number"
                                           value="${scene.duration || 8}"
                                           min="3" max="30"
                                           onchange="updateSceneDuration(${scene.id}, this.value)"
                                           style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem;">üîÄ Transition</label>
                                    <select onchange="updateSceneTransition(${scene.id}, this.value)"
                                            style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(30,30,50,1); color: white;">
                                        ${['cut', 'fade', 'zoom', 'slide'].map(t => `
                                            <option value="${t}" ${scene.transition === t ? 'selected' : ''}>${t.charAt(0).toUpperCase() + t.slice(1)}</option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>

                            <!-- Scene Actions -->
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button onclick="regenerateScene(${scene.id})"
                                        style="flex: 1; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid rgba(139, 92, 246, 0.4); background: rgba(139, 92, 246, 0.1); color: white; cursor: pointer; font-size: 0.8rem;">
                                    üîÑ Regenerate
                                </button>
                                <button onclick="moveSceneUp(${scene.id})"
                                        ${index === 0 ? 'disabled' : ''}
                                        style="padding: 0.5rem 0.75rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; cursor: pointer; opacity: ${index === 0 ? '0.5' : '1'};">
                                    ‚Üë
                                </button>
                                <button onclick="moveSceneDown(${scene.id})"
                                        ${index === state.script.scenes.length - 1 ? 'disabled' : ''}
                                        style="padding: 0.5rem 0.75rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; cursor: pointer; opacity: ${index === state.script.scenes.length - 1 ? '0.5' : '1'};">
                                    ‚Üì
                                </button>
                                <button onclick="deleteScene(${scene.id})"
                                        style="padding: 0.5rem 0.75rem; border-radius: 0.5rem; border: 1px solid rgba(239, 68, 68, 0.4); background: rgba(239, 68, 68, 0.1); color: #ef4444; cursor: pointer;">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // ==========================================
        // 7.8 STEP 4: STORYBOARD
        // ==========================================
        function renderStep4Storyboard() {
            const scenes = state.script.scenes || [];
            const storyboardScenes = state.storyboard.scenes || [];

            // Check if we need to auto-generate
            if (scenes.length > 0 && storyboardScenes.length === 0 && state.storyboard.status !== 'generating') {
                // Trigger auto-generation on first visit
                setTimeout(() => generateInitialStoryboard(), 100);
            }

            let html = '<div class="fade-in">';

            // Header
            html += `
                <div class="content-card">
                    <div class="content-card-header">
                        <div class="content-card-icon">üé®</div>
                        <div>
                            <div class="content-card-title">Storyboard</div>
                            <div class="content-card-subtitle">Visual preview of each scene ‚Ä¢ ${storyboardScenes.filter(s => s.imageUrl && s.status === 'ready').length}/${scenes.length} images ready</div>
                        </div>
                    </div>
                </div>
            `;

            // Storyboard Grid
            html += `<div class="storyboard-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; margin-top: 1rem;">`;

            scenes.forEach((scene, index) => {
                const storyboardScene = storyboardScenes.find(s => s.sceneId === scene.id) || {};
                html += renderStoryboardCard(scene, storyboardScene, index);
            });

            html += `</div>`;

            // Navigation
            const hasAllImages = storyboardScenes.filter(s => s.status === 'ready').length >= scenes.length;
            html += renderNavButtons(3, hasAllImages ? 5 : null);

            html += '</div>';

            // Modify Modal (rendered outside main flow)
            if (state.storyboard.modifyingScene) {
                html += renderModifyModal();
            }

            return html;
        }

        function renderStoryboardCard(scene, storyboardScene, index) {
            const status = storyboardScene.status || 'pending';
            const imageUrl = storyboardScene.imageUrl;
            const prompt = storyboardScene.prompt || scene.visual || '';

            let cardContent = '';

            if (status === 'pending') {
                // Empty state - needs generation
                cardContent = `
                    <div style="height: 160px; background: rgba(255,255,255,0.03); border: 2px dashed rgba(255,255,255,0.2); border-radius: 0.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer;" onclick="generateSingleSceneImage(${scene.id})">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">+</div>
                        <div style="color: rgba(255,255,255,0.5); font-size: 0.8rem;">Click to Generate</div>
                    </div>
                `;
            } else if (status === 'generating') {
                // Loading state
                cardContent = `
                    <div style="height: 160px; background: rgba(139, 92, 246, 0.1); border-radius: 0.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <div class="animate-spin" style="width: 2rem; height: 2rem; border: 3px solid rgba(139,92,246,0.3); border-top-color: #8b5cf6; border-radius: 50%; margin-bottom: 0.75rem;"></div>
                        <div style="color: rgba(255,255,255,0.6); font-size: 0.8rem;">Generating...</div>
                    </div>
                `;
            } else if (status === 'ready' && imageUrl) {
                // Image ready
                cardContent = `
                    <div style="height: 160px; border-radius: 0.5rem; overflow: hidden; position: relative;">
                        <img src="${imageUrl}" alt="Scene ${index + 1}" style="width: 100%; height: 100%; object-fit: cover;">
                        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); padding: 0.5rem; display: flex; gap: 0.5rem;">
                            <button onclick="openModifyModal(${scene.id})" style="flex: 1; padding: 0.4rem; border-radius: 0.4rem; border: 1px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.5); color: white; cursor: pointer; font-size: 0.75rem;">
                                ‚úèÔ∏è Modify
                            </button>
                            <button onclick="regenerateSingleSceneImage(${scene.id})" style="padding: 0.4rem 0.6rem; border-radius: 0.4rem; border: 1px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.5); color: white; cursor: pointer; font-size: 0.75rem;">
                                üîÑ
                            </button>
                        </div>
                    </div>
                `;
            } else if (status === 'error') {
                // Error state
                cardContent = `
                    <div style="height: 160px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer;" onclick="generateSingleSceneImage(${scene.id})">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚ö†Ô∏è</div>
                        <div style="color: #ef4444; font-size: 0.8rem;">Failed - Click to retry</div>
                    </div>
                `;
            }

            return `
                <div class="storyboard-card" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.75rem; overflow: hidden;">
                    <!-- Scene number badge -->
                    <div style="position: relative;">
                        <div style="position: absolute; top: 0.5rem; left: 0.5rem; background: rgba(0,0,0,0.7); color: white; padding: 0.2rem 0.5rem; border-radius: 0.25rem; font-size: 0.7rem; font-weight: 600; z-index: 1;">
                            Scene ${index + 1}
                        </div>
                        ${cardContent}
                    </div>

                    <!-- Prompt -->
                    <div style="padding: 0.75rem;">
                        <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5); margin-bottom: 0.25rem;">PROMPT</div>
                        <div style="font-size: 0.8rem; color: rgba(255,255,255,0.8); line-height: 1.4; max-height: 3.6em; overflow: hidden; text-overflow: ellipsis;">
                            ${prompt.substring(0, 120)}${prompt.length > 120 ? '...' : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderModifyModal() {
            const sceneId = state.storyboard.modifyingScene;
            const scene = state.script.scenes.find(s => s.id === sceneId);
            const storyboardScene = state.storyboard.scenes.find(s => s.sceneId === sceneId) || {};

            if (!scene) return '';

            const currentPrompt = state.storyboard.modifyPrompt || storyboardScene.prompt || scene.visual || '';

            return `
                <div id="modify-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1rem;" onclick="if(event.target.id === 'modify-modal') closeModifyModal()">
                    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 1rem; width: 100%; max-width: 700px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
                        <!-- Header -->
                        <div style="padding: 1.25rem; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: white;">‚úèÔ∏è Modify Scene ${scene.id}</div>
                                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.5);">Customize the image generation</div>
                            </div>
                            <button onclick="closeModifyModal()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0.25rem;">√ó</button>
                        </div>

                        <!-- Content -->
                        <div style="padding: 1.25rem; overflow-y: auto; flex: 1;">
                            <!-- Current Image Preview -->
                            ${storyboardScene.imageUrl ? `
                                <div style="margin-bottom: 1.25rem;">
                                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem;">Current Image</div>
                                    <img src="${storyboardScene.imageUrl}" alt="Current" style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 0.5rem;">
                                </div>
                            ` : ''}

                            <!-- Prompt Editor -->
                            <div style="margin-bottom: 1.25rem;">
                                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: white; margin-bottom: 0.5rem;">
                                    Image Prompt
                                </label>
                                <textarea id="modify-prompt-input"
                                          style="width: 100%; min-height: 100px; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; font-size: 0.9rem; resize: vertical;"
                                          placeholder="Describe what you want to see...">${currentPrompt}</textarea>
                            </div>

                            <!-- Style Selector -->
                            <div style="margin-bottom: 1.25rem;">
                                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: white; margin-bottom: 0.5rem;">
                                    Style
                                </label>
                                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem;">
                                    ${['cinematic', 'modern', 'retro', 'cartoon', 'dark'].map(styleOpt => `
                                        <button onclick="setModifyStyle('${styleOpt}')"
                                                style="padding: 0.5rem; border-radius: 0.4rem; border: 1px solid ${state.storyboard.modifyStyle === styleOpt ? 'rgba(139, 92, 246, 0.6)' : 'rgba(255,255,255,0.2)'}; background: ${state.storyboard.modifyStyle === styleOpt ? 'rgba(139, 92, 246, 0.2)' : 'rgba(255,255,255,0.05)'}; color: white; cursor: pointer; font-size: 0.75rem; text-transform: capitalize;">
                                            ${styleOpt}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Camera/Composition -->
                            <div style="margin-bottom: 1.25rem;">
                                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: white; margin-bottom: 0.5rem;">
                                    Camera Shot
                                </label>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem;">
                                    ${['wide shot', 'medium shot', 'close-up', 'aerial'].map(shot => `
                                        <button onclick="appendToModifyPrompt('${shot}')"
                                                style="padding: 0.5rem; border-radius: 0.4rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; cursor: pointer; font-size: 0.75rem; text-transform: capitalize;">
                                            ${shot}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Lighting -->
                            <div style="margin-bottom: 1.25rem;">
                                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: white; margin-bottom: 0.5rem;">
                                    Lighting
                                </label>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem;">
                                    ${['golden hour', 'dramatic', 'soft light', 'neon'].map(light => `
                                        <button onclick="appendToModifyPrompt('${light} lighting')"
                                                style="padding: 0.5rem; border-radius: 0.4rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; cursor: pointer; font-size: 0.75rem; text-transform: capitalize;">
                                            ${light}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div style="padding: 1.25rem; border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 0.75rem;">
                            <button onclick="closeModifyModal()"
                                    style="flex: 1; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: transparent; color: white; cursor: pointer; font-weight: 600;">
                                Cancel
                            </button>
                            <button onclick="applyModifyAndGenerate()"
                                    style="flex: 2; padding: 0.75rem; border-radius: 0.5rem; border: none; background: linear-gradient(135deg, #8b5cf6, #06b6d4); color: white; cursor: pointer; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <span>‚ú®</span>
                                <span>Generate New Image</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==========================================
        // 7.9 STEP 5: ANIMATION
        // ==========================================
        function renderStep5Animation() {
            const storyboardScenes = state.storyboard.scenes || [];
            const animationScenes = state.animation.scenes || [];
            const scriptScenes = state.script.scenes || [];

            // Initialize animation scenes if needed
            if (animationScenes.length === 0 && storyboardScenes.length > 0) {
                initializeAnimationScenes();
            }

            let html = '<div class="fade-in">';

            // Header with global settings
            html += `
                <div class="content-card">
                    <div class="content-card-header">
                        <div class="content-card-icon">üé¨</div>
                        <div style="flex: 1;">
                            <div class="content-card-title">Animation Studio</div>
                            <div class="content-card-subtitle">Generate voiceovers and animate your scenes ‚Ä¢ ${animationScenes.filter(s => s.videoUrl).length}/${storyboardScenes.length} videos ready</div>
                        </div>
                    </div>

                    <!-- Global Voice Settings -->
                    <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 0.75rem; padding: 1rem; margin-top: 1rem;">
                        <div style="font-size: 0.85rem; font-weight: 600; color: white; margin-bottom: 0.75rem;">üéôÔ∏è Global Voice Settings</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem;">Voice</label>
                                <select id="global-voice-select" onchange="setGlobalVoice(this.value)"
                                        style="width: 100%; padding: 0.6rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(30,30,50,1); color: white; font-size: 0.85rem;">
                                    ${['alloy', 'nova', 'shimmer', 'echo', 'onyx', 'fable'].map(v => `
                                        <option value="${v}" ${state.animation.voiceover.voice === v ? 'selected' : ''}>${v.charAt(0).toUpperCase() + v.slice(1)}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem;">Speed: ${state.animation.voiceover.speed.toFixed(1)}x</label>
                                <input type="range" min="0.5" max="2.0" step="0.1" value="${state.animation.voiceover.speed}"
                                       onchange="setGlobalSpeed(this.value)"
                                       style="width: 100%; height: 6px; cursor: pointer;">
                            </div>
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 0.75rem;">
                            <button onclick="generateAllVoiceovers()"
                                    style="flex: 1; padding: 0.75rem; border-radius: 0.5rem; border: none; background: linear-gradient(135deg, #8b5cf6, #a855f7); color: white; cursor: pointer; font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <span>üéôÔ∏è</span> Generate All Voiceovers
                            </button>
                            <button onclick="animateAllScenes()"
                                    ${animationScenes.filter(s => s.voiceoverUrl).length < storyboardScenes.length ? 'disabled' : ''}
                                    style="flex: 1; padding: 0.75rem; border-radius: 0.5rem; border: none; background: ${animationScenes.filter(s => s.voiceoverUrl).length >= storyboardScenes.length ? 'linear-gradient(135deg, #06b6d4, #10b981)' : 'rgba(255,255,255,0.1)'}; color: ${animationScenes.filter(s => s.voiceoverUrl).length >= storyboardScenes.length ? 'white' : 'rgba(255,255,255,0.4)'}; cursor: ${animationScenes.filter(s => s.voiceoverUrl).length >= storyboardScenes.length ? 'pointer' : 'not-allowed'}; font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <span>üé¨</span> Animate All Scenes
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Animation Scene Cards
            html += `<div style="display: grid; gap: 1rem; margin-top: 1rem;">`;

            scriptScenes.forEach((scriptScene, index) => {
                const storyboardScene = storyboardScenes.find(s => s.sceneId === scriptScene.id) || {};
                const animScene = animationScenes.find(s => s.sceneId === scriptScene.id) || {};
                html += renderAnimationSceneCard(scriptScene, storyboardScene, animScene, index);
            });

            html += `</div>`;

            // Navigation
            const hasAllVideos = animationScenes.filter(s => s.videoUrl).length >= storyboardScenes.length;
            html += renderNavButtons(4, hasAllVideos ? 6 : null);

            html += '</div>';
            return html;
        }

        function initializeAnimationScenes() {
            const storyboardScenes = state.storyboard.scenes || [];
            const scriptScenes = state.script.scenes || [];

            state.animation.scenes = scriptScenes.map(scene => ({
                sceneId: scene.id,
                voiceoverStatus: 'idle',
                voiceoverUrl: null,
                animationStatus: 'idle',
                videoUrl: null,
                voice: state.animation.voiceover.voice,
                speed: state.animation.voiceover.speed,
                animationType: 'ken_burns',
                jobId: null
            }));
            saveProject();
        }

        function renderAnimationSceneCard(scriptScene, storyboardScene, animScene, index) {
            const imageUrl = storyboardScene.imageUrl;
            const voiceoverStatus = animScene.voiceoverStatus || 'idle';
            const voiceoverUrl = animScene.voiceoverUrl;
            const animationStatus = animScene.animationStatus || 'idle';
            const videoUrl = animScene.videoUrl;
            const animationType = animScene.animationType || 'ken_burns';

            return `
                <div class="content-card" style="padding: 0; overflow: hidden;">
                    <div style="display: grid; grid-template-columns: 200px 1fr; gap: 0;">
                        <!-- Left: Image/Video Preview -->
                        <div style="position: relative; background: rgba(0,0,0,0.3);">
                            ${videoUrl ? `
                                <video src="${videoUrl}" controls style="width: 100%; height: 180px; object-fit: cover;"></video>
                                <div style="position: absolute; top: 0.5rem; right: 0.5rem; background: rgba(16, 185, 129, 0.9); padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.65rem; font-weight: 600;">
                                    ‚úì ANIMATED
                                </div>
                            ` : imageUrl ? `
                                <img src="${imageUrl}" alt="Scene ${index + 1}" style="width: 100%; height: 180px; object-fit: cover;">
                                ${animationStatus === 'generating' ? `
                                    <div style="position: absolute; inset: 0; background: rgba(0,0,0,0.7); display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                        <div class="animate-spin" style="width: 2rem; height: 2rem; border: 3px solid rgba(6,182,212,0.3); border-top-color: #06b6d4; border-radius: 50%; margin-bottom: 0.5rem;"></div>
                                        <div style="color: white; font-size: 0.75rem;">Animating...</div>
                                    </div>
                                ` : ''}
                            ` : `
                                <div style="width: 100%; height: 180px; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.4);">
                                    No Image
                                </div>
                            `}
                            <div style="position: absolute; top: 0.5rem; left: 0.5rem; width: 1.75rem; height: 1.75rem; background: linear-gradient(135deg, #8b5cf6, #06b6d4); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.75rem;">
                                ${index + 1}
                            </div>
                        </div>

                        <!-- Right: Controls -->
                        <div style="padding: 1rem;">
                            <!-- Narration Preview -->
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.8); margin-bottom: 0.75rem; line-height: 1.4; max-height: 2.8em; overflow: hidden; text-overflow: ellipsis;">
                                "${scriptScene.narration?.substring(0, 100) || 'No narration'}${scriptScene.narration?.length > 100 ? '...' : ''}"
                            </div>

                            <!-- Voiceover Section -->
                            <div style="margin-bottom: 0.75rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">üéôÔ∏è Voiceover:</span>
                                    ${voiceoverStatus === 'idle' ? `
                                        <span style="font-size: 0.7rem; color: rgba(255,255,255,0.4);">Not generated</span>
                                    ` : voiceoverStatus === 'generating' ? `
                                        <span style="font-size: 0.7rem; color: #a855f7;" class="animate-pulse">Generating...</span>
                                    ` : voiceoverStatus === 'ready' ? `
                                        <span style="font-size: 0.7rem; color: #10b981;">‚úì Ready</span>
                                    ` : `
                                        <span style="font-size: 0.7rem; color: #ef4444;">Error</span>
                                    `}
                                </div>
                                ${voiceoverUrl ? `
                                    <audio src="${voiceoverUrl}" controls style="width: 100%; height: 28px; margin-bottom: 0.5rem;"></audio>
                                ` : ''}
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="generateSceneVoiceover(${scriptScene.id})"
                                            ${voiceoverStatus === 'generating' ? 'disabled' : ''}
                                            style="flex: 1; padding: 0.4rem 0.6rem; border-radius: 0.4rem; border: 1px solid rgba(139, 92, 246, 0.4); background: rgba(139, 92, 246, 0.15); color: ${voiceoverStatus === 'generating' ? 'rgba(255,255,255,0.4)' : 'white'}; cursor: ${voiceoverStatus === 'generating' ? 'wait' : 'pointer'}; font-size: 0.75rem;">
                                        ${voiceoverUrl ? 'üîÑ Regenerate' : 'üéôÔ∏è Generate'} Voice
                                    </button>
                                </div>
                            </div>

                            <!-- Animation Section -->
                            <div>
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">üé¨ Animation Type:</span>
                                    <select onchange="setSceneAnimationType(${scriptScene.id}, this.value)"
                                            style="padding: 0.3rem 0.5rem; border-radius: 0.3rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(30,30,50,1); color: white; font-size: 0.7rem;">
                                        ${[
                                            { id: 'ken_burns', name: 'Ken Burns (Zoom/Pan)' },
                                            { id: 'talking_head', name: 'Talking Head' },
                                            { id: 'static', name: 'Static (No Animation)' }
                                        ].map(type => `
                                            <option value="${type.id}" ${animationType === type.id ? 'selected' : ''}>${type.name}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                <button onclick="animateScene(${scriptScene.id})"
                                        ${!voiceoverUrl || animationStatus === 'generating' ? 'disabled' : ''}
                                        style="width: 100%; padding: 0.5rem; border-radius: 0.4rem; border: none; background: ${voiceoverUrl && animationStatus !== 'generating' ? 'linear-gradient(135deg, #06b6d4, #10b981)' : 'rgba(255,255,255,0.1)'}; color: ${voiceoverUrl && animationStatus !== 'generating' ? 'white' : 'rgba(255,255,255,0.4)'}; cursor: ${voiceoverUrl && animationStatus !== 'generating' ? 'pointer' : 'not-allowed'}; font-size: 0.8rem; font-weight: 600;">
                                    ${animationStatus === 'generating' ? '‚è≥ Animating...' : videoUrl ? 'üîÑ Re-Animate' : 'üé¨ Animate Scene'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Animation Functions
        function setGlobalVoice(voice) {
            state.animation.voiceover.voice = voice;
            // Update all scenes that haven't generated voiceover yet
            state.animation.scenes.forEach(scene => {
                if (!scene.voiceoverUrl) {
                    scene.voice = voice;
                }
            });
            saveProject();
            render();
        }

        function setGlobalSpeed(speed) {
            state.animation.voiceover.speed = parseFloat(speed);
            // Update all scenes that haven't generated voiceover yet
            state.animation.scenes.forEach(scene => {
                if (!scene.voiceoverUrl) {
                    scene.speed = parseFloat(speed);
                }
            });
            saveProject();
            render();
        }

        function setSceneAnimationType(sceneId, type) {
            const scene = state.animation.scenes.find(s => s.sceneId === sceneId);
            if (scene) {
                scene.animationType = type;
                saveProject();
            }
        }

        async function generateSceneVoiceover(sceneId) {
            const animScene = state.animation.scenes.find(s => s.sceneId === sceneId);
            const scriptScene = state.script.scenes.find(s => s.id === sceneId);

            if (!animScene || !scriptScene || !scriptScene.narration) {
                showToast('No narration available for this scene', 'error');
                return;
            }

            animScene.voiceoverStatus = 'generating';
            render();

            try {
                const generateVoiceover = firebase.functions().httpsCallable('creationWizardGenerateVoiceover');
                const result = await generateVoiceover({
                    projectId: state.projectId,
                    sceneId: sceneId,
                    text: scriptScene.narration,
                    voice: animScene.voice || state.animation.voiceover.voice,
                    speed: animScene.speed || state.animation.voiceover.speed
                });

                animScene.voiceoverStatus = 'ready';
                animScene.voiceoverUrl = result.data.audioUrl;
                showToast('Voiceover generated successfully!', 'success');
            } catch (error) {
                console.error('Voiceover generation error:', error);
                animScene.voiceoverStatus = 'error';
                showToast('Failed to generate voiceover: ' + error.message, 'error');
            }

            saveProject();
            render();
        }

        async function generateAllVoiceovers() {
            const scenesToGenerate = state.animation.scenes.filter(s => !s.voiceoverUrl && s.voiceoverStatus !== 'generating');

            if (scenesToGenerate.length === 0) {
                showToast('All voiceovers are already generated', 'info');
                return;
            }

            showToast(`Generating ${scenesToGenerate.length} voiceovers...`, 'info');

            // Generate sequentially to avoid rate limits
            for (const scene of scenesToGenerate) {
                await generateSceneVoiceover(scene.sceneId);
                // Small delay between generations
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            showToast('All voiceovers generated!', 'success');
        }

        async function animateScene(sceneId) {
            const animScene = state.animation.scenes.find(s => s.sceneId === sceneId);
            const storyboardScene = state.storyboard.scenes.find(s => s.sceneId === sceneId);

            if (!animScene || !storyboardScene || !storyboardScene.imageUrl) {
                showToast('No image available for animation', 'error');
                return;
            }

            if (!animScene.voiceoverUrl) {
                showToast('Please generate voiceover first', 'error');
                return;
            }

            animScene.animationStatus = 'generating';
            render();

            try {
                const animate = firebase.functions().httpsCallable('creationWizardAnimateScene');
                const result = await animate({
                    projectId: state.projectId,
                    sceneId: sceneId,
                    imageUrl: storyboardScene.imageUrl,
                    audioUrl: animScene.voiceoverUrl,
                    animationType: animScene.animationType || 'ken_burns'
                });

                // Start polling for completion
                animScene.jobId = result.data.jobId;
                pollAnimationStatus(sceneId, result.data.jobId);

            } catch (error) {
                console.error('Animation error:', error);
                animScene.animationStatus = 'error';
                showToast('Failed to start animation: ' + error.message, 'error');
                saveProject();
                render();
            }
        }

        async function pollAnimationStatus(sceneId, jobId) {
            const animScene = state.animation.scenes.find(s => s.sceneId === sceneId);
            if (!animScene) return;

            try {
                const checkStatus = firebase.functions().httpsCallable('creationWizardCheckAnimationStatus');
                const result = await checkStatus({ jobId });

                if (result.data.status === 'COMPLETED') {
                    animScene.animationStatus = 'ready';
                    animScene.videoUrl = result.data.videoUrl;
                    animScene.jobId = null;
                    showToast(`Scene ${state.script.scenes.findIndex(s => s.id === sceneId) + 1} animated!`, 'success');
                    saveProject();
                    render();
                } else if (result.data.status === 'FAILED') {
                    animScene.animationStatus = 'error';
                    animScene.jobId = null;
                    showToast('Animation failed. Please try again.', 'error');
                    saveProject();
                    render();
                } else {
                    // Still processing, poll again
                    setTimeout(() => pollAnimationStatus(sceneId, jobId), 5000);
                }
            } catch (error) {
                console.error('Animation status check error:', error);
                // Retry polling
                setTimeout(() => pollAnimationStatus(sceneId, jobId), 8000);
            }
        }

        async function animateAllScenes() {
            const scenesToAnimate = state.animation.scenes.filter(s => s.voiceoverUrl && !s.videoUrl && s.animationStatus !== 'generating');

            if (scenesToAnimate.length === 0) {
                showToast('No scenes ready to animate', 'info');
                return;
            }

            showToast(`Starting animation for ${scenesToAnimate.length} scenes...`, 'info');

            // Start all animations (they will poll independently)
            for (const scene of scenesToAnimate) {
                await animateScene(scene.sceneId);
                // Small delay between starting jobs
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }

        // ==========================================
        // 7.10 STEP 6: ASSEMBLY
        // ==========================================

        async function initializeAssembly() {
            // Load music library and options if not already loaded
            if (state.assembly.musicLibrary.length === 0) {
                try {
                    const getMusicLibrary = firebase.functions().httpsCallable('creationWizardGetMusicLibrary');
                    const result = await getMusicLibrary({});
                    state.assembly.musicLibrary = result.data.tracks || [];
                    state.assembly.transitionTypes = result.data.transitionTypes || [];
                    state.assembly.captionStyles = result.data.captionStyles || [];
                } catch (error) {
                    console.error('Failed to load music library:', error);
                    // Use defaults
                    state.assembly.transitionTypes = [
                        { id: 'cut', name: 'Cut' },
                        { id: 'fade', name: 'Fade' },
                        { id: 'crossfade', name: 'Crossfade' },
                        { id: 'dissolve', name: 'Dissolve' }
                    ];
                    state.assembly.captionStyles = [
                        { id: 'karaoke', name: 'Karaoke' },
                        { id: 'subtitle', name: 'Subtitle' },
                        { id: 'dynamic', name: 'Dynamic' },
                        { id: 'none', name: 'No Captions' }
                    ];
                }
            }

            // Initialize scene order if empty
            if (state.assembly.sceneOrder.length === 0 && state.script.scenes.length > 0) {
                state.assembly.sceneOrder = state.script.scenes.map(s => s.id);
            }

            // Initialize transitions for each scene if empty
            if (Object.keys(state.assembly.transitions).length === 0) {
                state.script.scenes.forEach(scene => {
                    state.assembly.transitions[scene.id] = { type: 'cut' };
                });
            }
        }

        function renderStep6Assembly() {
            // Initialize on first render
            if (state.assembly.musicLibrary.length === 0) {
                setTimeout(() => initializeAssembly().then(() => render()), 100);
            }

            const scriptScenes = state.script.scenes || [];
            const animationScenes = state.animation.scenes || [];
            const sceneOrder = state.assembly.sceneOrder.length > 0
                ? state.assembly.sceneOrder
                : scriptScenes.map(s => s.id);

            // Calculate total duration
            let totalDuration = 0;
            sceneOrder.forEach(sceneId => {
                const scene = scriptScenes.find(s => s.id === sceneId);
                if (scene) totalDuration += scene.duration || 8;
            });

            let html = '<div class="fade-in">';

            // Header
            html += `
                <div class="content-card">
                    <div class="content-card-header">
                        <div class="content-card-icon">üéûÔ∏è</div>
                        <div style="flex: 1;">
                            <div class="content-card-title">Video Assembly</div>
                            <div class="content-card-subtitle">Arrange scenes, add music & captions ‚Ä¢ Total: ${formatDuration(totalDuration)}</div>
                        </div>
                    </div>
                </div>
            `;

            // Main Assembly Layout - Two columns
            html += `<div style="display: grid; grid-template-columns: 1fr 350px; gap: 1rem; margin-top: 1rem;">`;

            // Left Column - Timeline
            html += `
                <div>
                    <div class="content-card" style="padding: 1rem;">
                        <div style="font-size: 0.9rem; font-weight: 600; color: white; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üìã</span> Scene Timeline
                            <span style="font-size: 0.75rem; color: rgba(255,255,255,0.5); font-weight: 400; margin-left: auto;">Drag to reorder</span>
                        </div>
                        <div id="timeline-container" style="display: flex; flex-direction: column; gap: 0.5rem;">
            `;

            sceneOrder.forEach((sceneId, index) => {
                const scriptScene = scriptScenes.find(s => s.id === sceneId);
                const animScene = animationScenes.find(s => s.sceneId === sceneId);
                const storyboardScene = state.storyboard.scenes.find(s => s.sceneId === sceneId);
                const transition = state.assembly.transitions[sceneId] || { type: 'cut' };

                if (scriptScene) {
                    html += renderTimelineSceneCard(scriptScene, animScene, storyboardScene, transition, index, sceneOrder.length);
                }
            });

            html += `
                        </div>
                    </div>
                </div>
            `;

            // Right Column - Settings
            html += `
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    ${renderMusicSettings()}
                    ${renderCaptionSettings()}
                    ${renderAudioMixSettings()}
                </div>
            `;

            html += `</div>`;

            // Navigation
            const isAssemblyReady = sceneOrder.length > 0;
            html += renderNavButtons(5, isAssemblyReady ? 7 : null);

            html += '</div>';
            return html;
        }

        function renderTimelineSceneCard(scriptScene, animScene, storyboardScene, transition, index, totalScenes) {
            const imageUrl = storyboardScene?.imageUrl;
            const hasVideo = animScene?.videoUrl;
            const transitionTypes = state.assembly.transitionTypes || [];

            let html = `
                <div class="timeline-scene" data-scene-id="${scriptScene.id}"
                     style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.5rem; overflow: hidden;">
                    <div style="display: flex; gap: 0.75rem; padding: 0.75rem;">
                        <!-- Drag Handle & Number -->
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                            <div style="cursor: grab; color: rgba(255,255,255,0.3); font-size: 1rem;">‚ãÆ‚ãÆ</div>
                            <div style="width: 1.5rem; height: 1.5rem; background: linear-gradient(135deg, #8b5cf6, #06b6d4); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 700;">
                                ${index + 1}
                            </div>
                        </div>

                        <!-- Thumbnail -->
                        <div style="width: 80px; height: 50px; border-radius: 0.25rem; overflow: hidden; background: rgba(0,0,0,0.3); flex-shrink: 0;">
                            ${imageUrl ? `<img src="${imageUrl}" style="width: 100%; height: 100%; object-fit: cover;">` :
                              `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.3); font-size: 0.7rem;">No image</div>`}
                        </div>

                        <!-- Scene Info -->
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 0.8rem; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 0.25rem;">
                                ${scriptScene.narration?.substring(0, 40) || 'No narration'}...
                            </div>
                            <div style="display: flex; gap: 0.5rem; font-size: 0.7rem; color: rgba(255,255,255,0.5);">
                                <span>‚è±Ô∏è ${scriptScene.duration || 8}s</span>
                                ${hasVideo ? '<span style="color: #10b981;">‚úì Video</span>' : '<span style="color: #f59e0b;">‚ö†Ô∏è No video</span>'}
                            </div>
                        </div>

                        <!-- Reorder Buttons -->
                        <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                            <button onclick="moveSceneInOrder(${scriptScene.id}, -1)" ${index === 0 ? 'disabled' : ''}
                                    style="padding: 0.25rem 0.4rem; border-radius: 0.25rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: ${index === 0 ? 'rgba(255,255,255,0.2)' : 'white'}; cursor: ${index === 0 ? 'not-allowed' : 'pointer'}; font-size: 0.65rem;">
                                ‚Üë
                            </button>
                            <button onclick="moveSceneInOrder(${scriptScene.id}, 1)" ${index === totalScenes - 1 ? 'disabled' : ''}
                                    style="padding: 0.25rem 0.4rem; border-radius: 0.25rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: ${index === totalScenes - 1 ? 'rgba(255,255,255,0.2)' : 'white'}; cursor: ${index === totalScenes - 1 ? 'not-allowed' : 'pointer'}; font-size: 0.65rem;">
                                ‚Üì
                            </button>
                        </div>
                    </div>

                    <!-- Transition Selector (between scenes) -->
                    ${index < totalScenes - 1 ? `
                        <div style="padding: 0.5rem 0.75rem; background: rgba(139, 92, 246, 0.1); border-top: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 0.7rem; color: rgba(255,255,255,0.6);">Transition:</span>
                            <select onchange="setSceneTransition(${scriptScene.id}, this.value)"
                                    style="flex: 1; padding: 0.3rem 0.5rem; border-radius: 0.25rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(30,30,50,1); color: white; font-size: 0.7rem;">
                                ${transitionTypes.map(t => `
                                    <option value="${t.id}" ${transition.type === t.id ? 'selected' : ''}>${t.name}</option>
                                `).join('')}
                            </select>
                        </div>
                    ` : ''}
                </div>
            `;
            return html;
        }

        function renderMusicSettings() {
            const musicLibrary = state.assembly.musicLibrary || [];
            const selectedTrackId = state.assembly.music.trackId;
            const musicEnabled = state.assembly.music.enabled;
            const musicVolume = state.assembly.music.volume;

            // Group by category
            const categories = ['upbeat', 'calm', 'dramatic', 'electronic', 'hiphop', 'none'];
            const categoryNames = {
                upbeat: 'üéâ Upbeat',
                calm: 'üåä Calm',
                dramatic: 'üé¨ Dramatic',
                electronic: 'üéß Electronic',
                hiphop: 'üé§ Hip Hop',
                none: 'üîá None'
            };

            return `
                <div class="content-card" style="padding: 1rem;">
                    <div style="font-size: 0.9rem; font-weight: 600; color: white; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span>üéµ</span> Background Music
                        <label style="margin-left: auto; display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" ${musicEnabled ? 'checked' : ''} onchange="toggleMusic(this.checked)"
                                   style="width: 1rem; height: 1rem; cursor: pointer;">
                            <span style="font-size: 0.75rem; font-weight: 400; color: rgba(255,255,255,0.6);">Enable</span>
                        </label>
                    </div>

                    <div style="opacity: ${musicEnabled ? '1' : '0.5'}; pointer-events: ${musicEnabled ? 'auto' : 'none'};">
                        <select id="music-select" onchange="selectMusicTrack(this.value)"
                                style="width: 100%; padding: 0.6rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(30,30,50,1); color: white; font-size: 0.85rem; margin-bottom: 0.75rem;">
                            <option value="">Select a track...</option>
                            ${categories.map(cat => `
                                <optgroup label="${categoryNames[cat] || cat}">
                                    ${musicLibrary.filter(t => t.category === cat).map(track => `
                                        <option value="${track.id}" ${selectedTrackId === track.id ? 'selected' : ''}>
                                            ${track.name} ${track.duration ? `(${Math.floor(track.duration / 60)}:${(track.duration % 60).toString().padStart(2, '0')})` : ''}
                                        </option>
                                    `).join('')}
                                </optgroup>
                            `).join('')}
                        </select>

                        ${selectedTrackId && selectedTrackId !== 'none' ? `
                            <div style="background: rgba(139, 92, 246, 0.1); border-radius: 0.4rem; padding: 0.5rem; margin-bottom: 0.75rem;">
                                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.7);">
                                    ${musicLibrary.find(t => t.id === selectedTrackId)?.mood || ''}
                                </div>
                            </div>
                        ` : ''}

                        <div>
                            <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.4rem;">
                                Volume: ${musicVolume}%
                            </label>
                            <input type="range" min="0" max="100" value="${musicVolume}"
                                   onchange="setMusicVolume(this.value)"
                                   style="width: 100%; height: 6px; cursor: pointer;">
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCaptionSettings() {
            const captionStyles = state.assembly.captionStyles || [];
            const captionsEnabled = state.assembly.captions.enabled;
            const selectedStyle = state.assembly.captions.style;
            const position = state.assembly.captions.position;

            return `
                <div class="content-card" style="padding: 1rem;">
                    <div style="font-size: 0.9rem; font-weight: 600; color: white; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span>üí¨</span> Captions
                        <label style="margin-left: auto; display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" ${captionsEnabled ? 'checked' : ''} onchange="toggleCaptions(this.checked)"
                                   style="width: 1rem; height: 1rem; cursor: pointer;">
                            <span style="font-size: 0.75rem; font-weight: 400; color: rgba(255,255,255,0.6);">Enable</span>
                        </label>
                    </div>

                    <div style="opacity: ${captionsEnabled ? '1' : '0.5'}; pointer-events: ${captionsEnabled ? 'auto' : 'none'};">
                        <!-- Style Selection -->
                        <div style="margin-bottom: 0.75rem;">
                            <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.4rem;">Style</label>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.4rem;">
                                ${captionStyles.filter(s => s.id !== 'none').map(style => `
                                    <button onclick="setCaptionStyle('${style.id}')"
                                            style="padding: 0.4rem; border-radius: 0.4rem; border: 1px solid ${selectedStyle === style.id ? 'rgba(139, 92, 246, 0.6)' : 'rgba(255,255,255,0.2)'}; background: ${selectedStyle === style.id ? 'rgba(139, 92, 246, 0.2)' : 'rgba(255,255,255,0.05)'}; color: white; cursor: pointer; font-size: 0.7rem;">
                                        ${style.name}
                                    </button>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Position -->
                        <div>
                            <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.4rem;">Position</label>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.4rem;">
                                ${['top', 'center', 'bottom'].map(pos => `
                                    <button onclick="setCaptionPosition('${pos}')"
                                            style="padding: 0.4rem; border-radius: 0.4rem; border: 1px solid ${position === pos ? 'rgba(6, 182, 212, 0.6)' : 'rgba(255,255,255,0.2)'}; background: ${position === pos ? 'rgba(6, 182, 212, 0.2)' : 'rgba(255,255,255,0.05)'}; color: white; cursor: pointer; font-size: 0.7rem; text-transform: capitalize;">
                                        ${pos}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAudioMixSettings() {
            const voiceVolume = state.assembly.audioMix?.voiceVolume || 100;
            const musicVolume = state.assembly.audioMix?.musicVolume || 30;

            return `
                <div class="content-card" style="padding: 1rem;">
                    <div style="font-size: 0.9rem; font-weight: 600; color: white; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span>üéöÔ∏è</span> Audio Mix
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <div>
                            <label style="display: flex; justify-content: space-between; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.4rem;">
                                <span>üéôÔ∏è Voiceover</span>
                                <span>${voiceVolume}%</span>
                            </label>
                            <input type="range" min="0" max="100" value="${voiceVolume}"
                                   onchange="setVoiceVolume(this.value)"
                                   style="width: 100%; height: 6px; cursor: pointer;">
                        </div>

                        <div>
                            <label style="display: flex; justify-content: space-between; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.4rem;">
                                <span>üéµ Music</span>
                                <span>${musicVolume}%</span>
                            </label>
                            <input type="range" min="0" max="100" value="${musicVolume}"
                                   onchange="setAudioMixMusicVolume(this.value)"
                                   style="width: 100%; height: 6px; cursor: pointer;">
                        </div>
                    </div>

                    <!-- Save Assembly Button -->
                    <button onclick="saveAssemblySettings()"
                            style="width: 100%; margin-top: 1rem; padding: 0.75rem; border-radius: 0.5rem; border: none; background: linear-gradient(135deg, #8b5cf6, #06b6d4); color: white; font-weight: 600; cursor: pointer; font-size: 0.85rem;">
                        üíæ Save Assembly Settings
                    </button>
                </div>
            `;
        }

        // Assembly Functions
        function moveSceneInOrder(sceneId, direction) {
            const order = state.assembly.sceneOrder.length > 0
                ? [...state.assembly.sceneOrder]
                : state.script.scenes.map(s => s.id);

            const currentIndex = order.indexOf(sceneId);
            const newIndex = currentIndex + direction;

            if (newIndex >= 0 && newIndex < order.length) {
                [order[currentIndex], order[newIndex]] = [order[newIndex], order[currentIndex]];
                state.assembly.sceneOrder = order;
                saveProject();
                render();
            }
        }

        function setSceneTransition(sceneId, transitionType) {
            state.assembly.transitions[sceneId] = { type: transitionType };
            saveProject();
        }

        function toggleMusic(enabled) {
            state.assembly.music.enabled = enabled;
            saveProject();
            render();
        }

        function selectMusicTrack(trackId) {
            state.assembly.music.trackId = trackId;
            if (trackId && trackId !== 'none') {
                state.assembly.music.enabled = true;
            }
            saveProject();
            render();
        }

        function setMusicVolume(volume) {
            state.assembly.music.volume = parseInt(volume);
            saveProject();
        }

        function toggleCaptions(enabled) {
            state.assembly.captions.enabled = enabled;
            saveProject();
            render();
        }

        function setCaptionStyle(style) {
            state.assembly.captions.style = style;
            saveProject();
            render();
        }

        function setCaptionPosition(position) {
            state.assembly.captions.position = position;
            saveProject();
            render();
        }

        function setVoiceVolume(volume) {
            if (!state.assembly.audioMix) state.assembly.audioMix = {};
            state.assembly.audioMix.voiceVolume = parseInt(volume);
            saveProject();
            render();
        }

        function setAudioMixMusicVolume(volume) {
            if (!state.assembly.audioMix) state.assembly.audioMix = {};
            state.assembly.audioMix.musicVolume = parseInt(volume);
            saveProject();
            render();
        }

        async function saveAssemblySettings() {
            try {
                const updateAssembly = firebase.functions().httpsCallable('creationWizardUpdateAssembly');
                await updateAssembly({
                    projectId: state.projectId,
                    assembly: {
                        status: 'ready',
                        sceneOrder: state.assembly.sceneOrder,
                        transitions: state.assembly.transitions,
                        music: state.assembly.music,
                        captions: state.assembly.captions,
                        audioMix: state.assembly.audioMix
                    }
                });
                state.assembly.status = 'ready';
                showToast('Assembly settings saved!', 'success');
                saveProject();
                render();
            } catch (error) {
                console.error('Failed to save assembly:', error);
                showToast('Failed to save assembly settings', 'error');
            }
        }

        // ==========================================
        // 7.11 STEP 7: EXPORT (PLACEHOLDER)
        // ==========================================

        function renderStep7Export() {
            return renderComingSoonStep(7, 'Export', 'Render and download your final video.');
        }

        function renderComingSoonStep(stepNum, title, description) {
            return `
                <div class="fade-in">
                    <div class="content-card" style="text-align: center; padding: 4rem 2rem;">
                        <div style="font-size: 4rem; margin-bottom: 1.5rem;">üöß</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: white; margin-bottom: 0.5rem;">
                            Step ${stepNum}: ${title}
                        </div>
                        <div style="color: rgba(255,255,255,0.6); margin-bottom: 2rem;">
                            ${description}
                        </div>
                        <div style="color: rgba(139, 92, 246, 0.8); font-size: 0.9rem;">
                            Coming soon in Phase ${stepNum > 2 ? Math.ceil((stepNum - 2) / 2) + 1 : 1}...
                        </div>
                    </div>
                    ${renderNavButtons(stepNum - 1, stepNum < 7 ? stepNum + 1 : null)}
                </div>
            `;
        }

        // ==========================================
        // 7.8 NAVIGATION BUTTONS
        // ==========================================
        function renderNavButtons(backStep, nextStep) {
            let html = '<div class="nav-buttons">';

            if (backStep) {
                html += `
                    <button class="nav-button nav-button-back" onclick="goToStep(${backStep})">
                        <span>‚Üê</span>
                        <span>Back</span>
                    </button>
                `;
            } else {
                html += '<div></div>';
            }

            if (nextStep) {
                html += `
                    <button class="nav-button nav-button-next" onclick="goToStep(${nextStep})">
                        <span>Continue</span>
                        <span>‚Üí</span>
                    </button>
                `;
            } else if (state.currentStep < 7) {
                html += `
                    <button class="nav-button nav-button-next" disabled>
                        <span>Continue</span>
                        <span>‚Üí</span>
                    </button>
                `;
            }

            html += '</div>';
            return html;
        }

        // ==========================================
        // 7.9 EVENT LISTENERS
        // ==========================================
        function attachEventListeners() {
            // Duration slider continuous update
            const durationSlider = document.getElementById('duration-slider');
            if (durationSlider) {
                durationSlider.addEventListener('input', function() {
                    const value = parseInt(this.value);
                    state.platform.targetDuration = value;
                    // Update just the display without full re-render
                    const valueDisplay = document.querySelector('.duration-value');
                    if (valueDisplay) {
                        valueDisplay.textContent = formatDuration(value);
                    }
                });
            }

            // Topic input
            const topicInput = document.getElementById('topic-input');
            if (topicInput) {
                topicInput.addEventListener('input', function() {
                    state.content.topic = this.value;
                });
            }
        }

        // ==========================================
        // 7.10 INITIALIZATION
        // ==========================================
        async function init() {
            try {
                await initAuth();

                // Check if loading an existing project
                const projectId = checkUrlForProject();
                if (projectId) {
                    await loadProject(projectId);
                } else {
                    state.isLoading = false;
                    render();
                }
            } catch (error) {
                console.error('Init error:', error);
                state.isLoading = false;
                render();
            }
        }

        // Start the app
        init();
    </script>
</body>
</html>
