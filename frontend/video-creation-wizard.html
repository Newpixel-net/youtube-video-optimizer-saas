<!-- ================================================================
     YOUTUBE VIDEO OPTIMIZER - VIDEO CREATION WIZARD
     ================================================================

     Structure:
     - SECTION 1: External Dependencies (CDN)
     - SECTION 2: Styles (CSS)
     - SECTION 3: HTML Container
     - SECTION 4: Configuration Data (Platforms, Niches, Styles)
     - SECTION 5: State Management
     - SECTION 6: Core Functions
     - SECTION 7: Render Functions

     Wizard Steps:
     1. Platform & Format - Select target platform and aspect ratio
     2. Niche & Style - Choose content niche and visual style
     3. Script Generation - AI generates video script with scenes
     4. Storyboard - Generate images for each scene
     5. Animation - Animate images to video (Runpod/Veo)
     6. Assembly - Combine scenes, add music, captions
     7. Export - Final render and download

     Video Generation Engines:
     - Runpod Multi-talk: 15-second clips, ~$0.03-0.05/clip
     - Google Veo 3.1: 8-second base (extendable), $0.15-0.40/second

     Access: All authenticated users (with token system)
     Last Updated: December 2025
     ================================================================ -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Video Creation Wizard - YouTubeHub</title>

    <!-- PWA Manifest & Theme -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"YouTubeHub Video Creator","short_name":"Video Creator","description":"AI-powered video creation from scratch","start_url":"/video-creation-wizard","display":"standalone","background_color":"#0f172a","theme_color":"#8b5cf6","orientation":"portrait-primary","icons":[{"src":"https://ytseo.siteuo.com/icon-192.png","sizes":"192x192","type":"image/png","purpose":"any maskable"},{"src":"https://ytseo.siteuo.com/icon-512.png","sizes":"512x512","type":"image/png","purpose":"any maskable"}]}'>
    <meta name="theme-color" content="#8b5cf6">

    <!-- ============================================
         SECTION 1: EXTERNAL DEPENDENCIES
         ============================================ -->

    <!-- 1.0 Performance: Preconnect & DNS Prefetch -->
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://firebasestorage.googleapis.com" crossorigin>
    <link rel="dns-prefetch" href="https://www.gstatic.com">
    <link rel="dns-prefetch" href="https://firestore.googleapis.com">

    <!-- 1.1 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 1.2 Firebase SDKs -->
    <link rel="preload" href="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js" as="script">
    <link rel="preload" href="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js" as="script">
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>
    <script src="VideoPreviewEngine.js"></script>

    <!-- ============================================
         SECTION 2: STYLES
         ============================================ -->
    <style>
        /* ------------------------------------------
           2.1 BASE & RESET
           ------------------------------------------ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }

        body {
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 1rem;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            color: white;
        }

        #app-root {
            width: 100%;
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }

        /* ------------------------------------------
           2.2 ANIMATIONS
           ------------------------------------------ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes gradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.3); }
            50% { box-shadow: 0 0 40px rgba(139, 92, 246, 0.6); }
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        .animate-pulse {
            animation: pulse 2s ease-in-out infinite;
        }

        .animate-float {
            animation: float 3s ease-in-out infinite;
        }

        .animate-glow {
            animation: glow 2s ease-in-out infinite;
        }

        .scale-in {
            animation: scaleIn 0.3s ease-out forwards;
        }

        /* ------------------------------------------
           2.3 WIZARD LAYOUT
           ------------------------------------------ */
        .wizard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
            min-height: 100vh;
        }

        .wizard-header {
            text-align: center;
            padding: 1.5rem 1rem;
            margin-bottom: 1rem;
        }

        .wizard-title {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 50%, #10b981 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .wizard-subtitle {
            color: rgba(255, 255, 255, 0.6);
            font-size: 1rem;
        }

        /* ------------------------------------------
           2.4 STEPPER
           ------------------------------------------ */
        .wizard-stepper {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.25rem;
            padding: 1rem 0.5rem;
            margin-bottom: 2rem;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .wizard-stepper::-webkit-scrollbar {
            display: none;
        }

        .wizard-step {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.6rem 1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .wizard-step:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .wizard-step.active {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(6, 182, 212, 0.2) 100%);
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
        }

        .wizard-step.completed {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .wizard-step.completed .step-number {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .step-number {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .wizard-step.active .step-number {
            background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%);
        }

        .step-label {
            font-size: 0.8rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
        }

        .wizard-step.active .step-label {
            color: white;
        }

        /* Step connector line */
        .step-connector {
            width: 20px;
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }

        .step-connector.completed {
            background: rgba(16, 185, 129, 0.5);
        }

        /* ------------------------------------------
           2.5 CONTENT CARDS
           ------------------------------------------ */
        .content-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1.5rem;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .content-card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .content-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(6, 182, 212, 0.2) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .content-card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
        }

        .content-card-subtitle {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.5);
        }

        /* ------------------------------------------
           2.6 PLATFORM CARDS
           ------------------------------------------ */
        .platform-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1rem;
        }

        .platform-card {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .platform-card:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .platform-card.selected {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(6, 182, 212, 0.15) 100%);
            border-color: rgba(139, 92, 246, 0.6);
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.2);
        }

        .platform-card-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
        }

        .platform-card-name {
            font-size: 1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.25rem;
        }

        .platform-card-info {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }

        /* ------------------------------------------
           2.7 FORMAT SELECTOR
           ------------------------------------------ */
        .format-selector {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .format-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .format-option:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .format-option.selected {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(6, 182, 212, 0.15) 100%);
            border-color: rgba(139, 92, 246, 0.6);
        }

        .format-option.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .format-preview {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .format-preview-box {
            background: rgba(139, 92, 246, 0.3);
            border: 2px solid rgba(139, 92, 246, 0.6);
            border-radius: 4px;
        }

        .format-preview-box.ratio-16-9 {
            width: 64px;
            height: 36px;
        }

        .format-preview-box.ratio-9-16 {
            width: 36px;
            height: 64px;
        }

        .format-preview-box.ratio-1-1 {
            width: 48px;
            height: 48px;
        }

        .format-preview-box.ratio-4-5 {
            width: 40px;
            height: 50px;
        }

        .format-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: white;
        }

        .format-desc {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
        }

        /* ------------------------------------------
           2.8 DURATION SLIDER
           ------------------------------------------ */
        .duration-container {
            margin-top: 1.5rem;
        }

        .duration-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .duration-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
        }

        .duration-value {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .duration-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        .duration-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
            transition: transform 0.2s ease;
        }

        .duration-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        .duration-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        }

        .duration-presets {
            display: flex;
            justify-content: space-between;
            margin-top: 0.75rem;
        }

        .duration-preset {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.4);
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .duration-preset:hover {
            color: rgba(255, 255, 255, 0.8);
        }

        /* ------------------------------------------
           2.9 NICHE GRID
           ------------------------------------------ */
        .niche-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.75rem;
        }

        .niche-card {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .niche-card:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .niche-card.selected {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(6, 182, 212, 0.15) 100%);
            border-color: rgba(139, 92, 246, 0.6);
        }

        .niche-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .niche-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: white;
        }

        /* Sub-niche chips */
        .subniche-container {
            margin-top: 1.5rem;
        }

        .subniche-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .subniche-chip {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 2rem;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .subniche-chip:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .subniche-chip.selected {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3) 0%, rgba(6, 182, 212, 0.3) 100%);
            border-color: rgba(139, 92, 246, 0.5);
            color: white;
        }

        /* ------------------------------------------
           2.10 STYLE GRID
           ------------------------------------------ */
        .style-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }

        .style-card {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 1rem;
            padding: 1.25rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .style-card:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .style-card.selected {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(6, 182, 212, 0.15) 100%);
            border-color: rgba(139, 92, 246, 0.6);
        }

        .style-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .style-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.25rem;
        }

        .style-desc {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
            line-height: 1.3;
        }

        /* ------------------------------------------
           2.11 TOPIC INPUT
           ------------------------------------------ */
        .topic-input-container {
            margin-top: 1.5rem;
        }

        .topic-input {
            width: 100%;
            padding: 1rem 1.25rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            color: white;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .topic-input:focus {
            border-color: rgba(139, 92, 246, 0.5);
            background: rgba(255, 255, 255, 0.08);
        }

        .topic-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .topic-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .topic-suggestion {
            padding: 0.4rem 0.8rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .topic-suggestion:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.4);
            color: white;
        }

        /* ------------------------------------------
           2.12 CONFIG TAGS
           ------------------------------------------ */
        .config-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.35rem 0.65rem;
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 0.5rem;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        /* ------------------------------------------
           2.13 NAVIGATION BUTTONS
           ------------------------------------------ */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .nav-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            border-radius: 1rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .nav-button-back {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
        }

        .nav-button-back:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-button-next {
            background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .nav-button-next:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }

        .nav-button-next:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* ------------------------------------------
           2.13 TOKEN DISPLAY
           ------------------------------------------ */
        .token-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 2rem;
            font-size: 0.85rem;
        }

        .token-icon {
            font-size: 1rem;
        }

        .token-count {
            font-weight: 700;
            background: linear-gradient(135deg, #f59e0b 0%, #eab308 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ------------------------------------------
           2.14 HEADER BAR
           ------------------------------------------ */
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .back-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s ease;
        }

        .back-link:hover {
            color: white;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* ------------------------------------------
           2.15 LOADING STATE
           ------------------------------------------ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 15, 26, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(139, 92, 246, 0.2);
            border-top-color: #8b5cf6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 1.5rem;
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* ------------------------------------------
           2.16 COST ESTIMATE PANEL
           ------------------------------------------ */
        .cost-estimate {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 1rem;
            padding: 1rem 1.25rem;
            margin-top: 1.5rem;
        }

        .cost-estimate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .cost-estimate-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
        }

        .cost-estimate-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #8b5cf6;
        }

        .cost-estimate-breakdown {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }

        /* ------------------------------------------
           2.17 RESPONSIVE ADJUSTMENTS
           ------------------------------------------ */
        @media (max-width: 768px) {
            .wizard-container {
                padding: 0.5rem;
            }

            .wizard-title {
                font-size: 1.5rem;
            }

            .wizard-stepper {
                justify-content: flex-start;
                padding: 0.75rem;
            }

            .wizard-step {
                padding: 0.5rem 0.75rem;
            }

            .step-label {
                display: none;
            }

            .content-card {
                padding: 1.25rem;
            }

            .platform-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .niche-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .style-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .format-selector {
                flex-direction: column;
                align-items: center;
            }

            .nav-buttons {
                flex-direction: column;
                gap: 1rem;
            }

            .nav-button {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- ============================================
         SECTION 3: HTML CONTAINER
         ============================================ -->
    <div id="app-root">
        <!-- Content rendered by JavaScript -->
        <div class="loading-overlay" id="initial-loading">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loading-text">Authenticating...</div>
        </div>
    </div>

    <!-- ============================================
         SECTION 4: CONFIGURATION DATA
         ============================================ -->
    <script>
        // ==========================================
        // 4.1 PLATFORM PRESETS
        // ==========================================
        const PLATFORM_PRESETS = {
            'youtube-long': {
                id: 'youtube-long',
                name: 'YouTube Long-form',
                icon: 'üì∫',
                formats: ['16:9'],
                defaultFormat: '16:9',
                resolution: { width: 1920, height: 1080 },
                maxDuration: 300,
                minDuration: 60,
                fps: 30,
                bitrate: '8M',
                description: 'Standard videos up to 5 min'
            },
            'youtube-shorts': {
                id: 'youtube-shorts',
                name: 'YouTube Shorts',
                icon: 'üì±',
                formats: ['9:16'],
                defaultFormat: '9:16',
                resolution: { width: 1080, height: 1920 },
                maxDuration: 60,
                minDuration: 15,
                fps: 30,
                bitrate: '4M',
                description: 'Vertical shorts up to 60s'
            },
            'tiktok': {
                id: 'tiktok',
                name: 'TikTok',
                icon: 'üéµ',
                formats: ['9:16', '16:9', '1:1'],
                defaultFormat: '9:16',
                resolution: { width: 1080, height: 1920 },
                maxDuration: 180,
                minDuration: 15,
                fps: 30,
                bitrate: '4M',
                description: 'Viral content up to 3 min'
            },
            'instagram-reels': {
                id: 'instagram-reels',
                name: 'Instagram Reels',
                icon: 'üì∏',
                formats: ['9:16'],
                defaultFormat: '9:16',
                resolution: { width: 1080, height: 1920 },
                maxDuration: 180,
                minDuration: 15,
                fps: 30,
                bitrate: '4M',
                description: 'Reels up to 3 min'
            },
            'instagram-feed': {
                id: 'instagram-feed',
                name: 'Instagram Feed',
                icon: 'üñºÔ∏è',
                formats: ['1:1', '4:5', '16:9'],
                defaultFormat: '1:1',
                resolution: { width: 1080, height: 1080 },
                maxDuration: 60,
                minDuration: 3,
                fps: 30,
                bitrate: '4M',
                description: 'Feed videos up to 60s'
            },
            'facebook-reels': {
                id: 'facebook-reels',
                name: 'Facebook Reels',
                icon: 'üëç',
                formats: ['9:16'],
                defaultFormat: '9:16',
                resolution: { width: 1080, height: 1920 },
                maxDuration: 90,
                minDuration: 3,
                fps: 30,
                bitrate: '4M',
                description: 'Reels up to 90s'
            },
            'facebook-feed': {
                id: 'facebook-feed',
                name: 'Facebook Feed',
                icon: 'üìò',
                formats: ['16:9', '1:1', '9:16'],
                defaultFormat: '16:9',
                resolution: { width: 1920, height: 1080 },
                maxDuration: 300,
                minDuration: 3,
                fps: 30,
                bitrate: '6M',
                description: 'Feed videos up to 5 min'
            },
            'linkedin': {
                id: 'linkedin',
                name: 'LinkedIn',
                icon: 'üíº',
                formats: ['16:9', '1:1', '4:5'],
                defaultFormat: '4:5',
                resolution: { width: 1080, height: 1350 },
                maxDuration: 300,
                minDuration: 3,
                fps: 30,
                bitrate: '5M',
                description: 'Professional videos up to 5 min'
            },
            'multi-platform': {
                id: 'multi-platform',
                name: 'Multi-Platform',
                icon: 'üåê',
                formats: ['9:16', '16:9', '1:1'],
                defaultFormat: '9:16',
                resolution: { width: 1080, height: 1920 },
                maxDuration: 60,
                minDuration: 15,
                fps: 30,
                bitrate: '4M',
                description: 'Optimized for all platforms'
            }
        };

        // ==========================================
        // 4.2 VIDEO NICHES
        // ==========================================
        const VIDEO_NICHES = {
            entertainment: {
                id: 'entertainment',
                name: 'Entertainment',
                icon: 'üé¨',
                subniches: [
                    { id: 'comedy', name: 'Comedy & Humor' },
                    { id: 'stories', name: 'Story Time' },
                    { id: 'reactions', name: 'Reactions' },
                    { id: 'celebrity', name: 'Pop Culture' },
                    { id: 'true-crime', name: 'True Crime' }
                ]
            },
            education: {
                id: 'education',
                name: 'Education',
                icon: 'üìö',
                subniches: [
                    { id: 'explainer', name: 'Explainer Videos' },
                    { id: 'tutorials', name: 'Tutorials' },
                    { id: 'science', name: 'Science & Tech' },
                    { id: 'history', name: 'History' },
                    { id: 'language', name: 'Language Learning' }
                ]
            },
            business: {
                id: 'business',
                name: 'Business',
                icon: 'üí∞',
                subniches: [
                    { id: 'investing', name: 'Investing' },
                    { id: 'entrepreneurship', name: 'Entrepreneurship' },
                    { id: 'productivity', name: 'Productivity' },
                    { id: 'career', name: 'Career Tips' },
                    { id: 'money-tips', name: 'Money Tips' }
                ]
            },
            health: {
                id: 'health',
                name: 'Health',
                icon: 'üí™',
                subniches: [
                    { id: 'fitness', name: 'Fitness' },
                    { id: 'nutrition', name: 'Nutrition' },
                    { id: 'mental-health', name: 'Mental Health' },
                    { id: 'meditation', name: 'Meditation' },
                    { id: 'self-improvement', name: 'Self Improvement' }
                ]
            },
            technology: {
                id: 'technology',
                name: 'Technology',
                icon: 'üíª',
                subniches: [
                    { id: 'tech-reviews', name: 'Tech Reviews' },
                    { id: 'ai-tech', name: 'AI & Future Tech' },
                    { id: 'coding', name: 'Coding' },
                    { id: 'gadgets', name: 'Gadgets' },
                    { id: 'gaming-tech', name: 'Gaming' }
                ]
            },
            creative: {
                id: 'creative',
                name: 'Creative',
                icon: 'üé®',
                subniches: [
                    { id: 'art-tutorials', name: 'Art Tutorials' },
                    { id: 'music', name: 'Music' },
                    { id: 'photography', name: 'Photography' },
                    { id: 'diy-crafts', name: 'DIY & Crafts' },
                    { id: 'animation', name: 'Animation' }
                ]
            },
            travel: {
                id: 'travel',
                name: 'Travel',
                icon: '‚úàÔ∏è',
                subniches: [
                    { id: 'travel-guides', name: 'Travel Guides' },
                    { id: 'food-travel', name: 'Food & Cuisine' },
                    { id: 'luxury', name: 'Luxury' },
                    { id: 'minimalism', name: 'Minimalism' },
                    { id: 'adventure', name: 'Adventure' }
                ]
            },
            motivation: {
                id: 'motivation',
                name: 'Motivation',
                icon: 'üî•',
                subniches: [
                    { id: 'motivational', name: 'Speeches' },
                    { id: 'quotes', name: 'Quotes' },
                    { id: 'success-stories', name: 'Success Stories' },
                    { id: 'life-lessons', name: 'Life Lessons' },
                    { id: 'spirituality', name: 'Spirituality' }
                ]
            },
            news: {
                id: 'news',
                name: 'News',
                icon: 'üì∞',
                subniches: [
                    { id: 'world-news', name: 'World News' },
                    { id: 'politics', name: 'Politics' },
                    { id: 'sports', name: 'Sports' },
                    { id: 'social-commentary', name: 'Commentary' }
                ]
            }
        };

        // ==========================================
        // 4.3 VIDEO STYLES
        // ==========================================
        const VIDEO_STYLES = {
            modern: {
                id: 'modern',
                name: 'Modern Minimalist',
                icon: '‚ú®',
                description: 'Clean, sleek aesthetics',
                imagePromptModifiers: 'minimalist, clean design, modern aesthetic, solid colors, geometric shapes',
                transitionStyle: 'smooth-fade',
                pacing: 'medium'
            },
            cinematic: {
                id: 'cinematic',
                name: 'Cinematic',
                icon: 'üé¨',
                description: 'Movie-quality visuals',
                imagePromptModifiers: 'cinematic lighting, dramatic, film quality, depth of field, professional photography',
                transitionStyle: 'cinematic-fade',
                pacing: 'slow'
            },
            energetic: {
                id: 'energetic',
                name: 'Energetic',
                icon: '‚ö°',
                description: 'Fast-paced, bold colors',
                imagePromptModifiers: 'vibrant colors, dynamic composition, energetic, bold, eye-catching',
                transitionStyle: 'quick-cuts',
                pacing: 'fast'
            },
            documentary: {
                id: 'documentary',
                name: 'Documentary',
                icon: 'üìπ',
                description: 'Authentic, raw style',
                imagePromptModifiers: 'documentary style, realistic, photojournalistic, authentic, raw',
                transitionStyle: 'simple-cut',
                pacing: 'medium'
            },
            retro: {
                id: 'retro',
                name: 'Retro/Vintage',
                icon: 'üìº',
                description: 'Nostalgic film grain',
                imagePromptModifiers: 'vintage aesthetic, retro style, film grain, warm tones, nostalgic',
                transitionStyle: 'vhs-glitch',
                pacing: 'medium'
            },
            futuristic: {
                id: 'futuristic',
                name: 'Futuristic',
                icon: 'üöÄ',
                description: 'High-tech, neon aesthetic',
                imagePromptModifiers: 'futuristic, sci-fi, neon lights, cyber, holographic, high-tech',
                transitionStyle: 'digital-glitch',
                pacing: 'medium-fast'
            },
            cartoon: {
                id: 'cartoon',
                name: 'Animated',
                icon: 'üé®',
                description: 'Illustrated, playful',
                imagePromptModifiers: 'cartoon style, illustrated, colorful, playful, digital art, animation style',
                transitionStyle: 'bounce',
                pacing: 'medium'
            },
            elegant: {
                id: 'elegant',
                name: 'Elegant & Luxury',
                icon: 'üëë',
                description: 'Sophisticated, premium',
                imagePromptModifiers: 'luxury, elegant, sophisticated, premium quality, gold accents, refined',
                transitionStyle: 'smooth-elegant',
                pacing: 'slow'
            },
            nature: {
                id: 'nature',
                name: 'Nature & Organic',
                icon: 'üåø',
                description: 'Natural, calming',
                imagePromptModifiers: 'natural, organic, earthy tones, peaceful, nature photography, serene',
                transitionStyle: 'soft-dissolve',
                pacing: 'slow'
            },
            dark: {
                id: 'dark',
                name: 'Dark & Moody',
                icon: 'üåô',
                description: 'Dramatic, mysterious',
                imagePromptModifiers: 'dark mood, dramatic shadows, mysterious, noir style, moody lighting',
                transitionStyle: 'fade-dark',
                pacing: 'medium'
            }
        };

        // ==========================================
        // 4.4 FORMAT DISPLAY INFO
        // ==========================================
        const FORMAT_INFO = {
            '16:9': { name: 'Landscape', ratio: '16:9', className: 'ratio-16-9', desc: 'Wide screen' },
            '9:16': { name: 'Portrait', ratio: '9:16', className: 'ratio-9-16', desc: 'Vertical' },
            '1:1': { name: 'Square', ratio: '1:1', className: 'ratio-1-1', desc: 'Square' },
            '4:5': { name: 'Portrait', ratio: '4:5', className: 'ratio-4-5', desc: 'Tall' }
        };

        // ==========================================
        // 4.5 WIZARD STEPS
        // ==========================================
        const WIZARD_STEPS = [
            { num: 1, label: 'Platform', icon: 'üì±' },
            { num: 2, label: 'Niche & Style', icon: 'üé®' },
            { num: 3, label: 'Script', icon: 'üìù' },
            { num: 4, label: 'Storyboard', icon: 'üñºÔ∏è' },
            { num: 5, label: 'Animation', icon: 'üé¨' },
            { num: 6, label: 'Assembly', icon: 'üîß' },
            { num: 7, label: 'Export', icon: 'üì§' }
        ];

        // ==========================================
        // 4.6 TOPIC SUGGESTIONS BY NICHE
        // ==========================================
        const TOPIC_SUGGESTIONS = {
            entertainment: ['Top 10 plot twists', 'Hidden movie details', 'Celebrity facts you didn\'t know'],
            education: ['How X really works', '5 things school didn\'t teach you', 'The science behind Y'],
            business: ['Money habits of millionaires', 'Side hustle ideas', 'Investing mistakes to avoid'],
            health: ['Morning routine hacks', 'Foods that boost energy', 'Quick workout tips'],
            technology: ['AI tools you need', 'Tech predictions for 2025', 'Hidden phone features'],
            creative: ['Art techniques explained', 'Music production tips', 'Design trends'],
            travel: ['Hidden gem destinations', 'Travel hacks', 'Best street food cities'],
            motivation: ['Success mindset', 'Overcoming failure', 'Daily habits of winners'],
            news: ['Breaking down the headlines', 'What this means for you', 'Expert analysis']
        };
    </script>

    <!-- ============================================
         SECTION 5: STATE MANAGEMENT
         ============================================ -->
    <script>
        // ==========================================
        // 5.1 APPLICATION STATE
        // ==========================================
        const state = {
            // User & Auth
            user: null,
            isLoading: true,

            // Token system
            tokens: {
                balance: 0,
                plan: 'free'
            },

            // Current wizard step
            currentStep: 1,
            maxReachedStep: 1,

            // Project metadata
            project: {
                id: null,
                name: 'Untitled Video',
                createdAt: null,
                updatedAt: null
            },

            // Step 1: Platform & Format
            platform: {
                selected: null,           // Platform ID
                preset: null,             // Full preset object
                aspectRatio: null,        // Selected aspect ratio
                targetDuration: 60        // Target duration in seconds
            },

            // Step 2: Niche & Style
            content: {
                niche: null,              // Niche ID
                subniche: null,           // Sub-niche ID
                style: null,              // Style ID
                topic: '',                // User's topic/theme
                tone: 'engaging',         // casual, professional, humorous, serious
                pacing: 'medium'          // 'fast' | 'medium' | 'slow' - controls scene timing
            },

            // Step 3: Script
            script: {
                status: 'idle',
                title: '',
                hook: '',
                scenes: [],
                cta: '',
                totalDuration: 0,
                expandedScene: null,  // Track which scene is expanded in editor
                metadata: null,       // AI-generated metadata
                generatedAt: null,
                generationConfig: null
            },

            // Step 4: Storyboard
            storyboard: {
                status: 'idle', // idle, generating, ready, error
                scenes: [],     // Array of { sceneId, status, imageUrl, prompt, jobId, source }
                characterReference: null,
                styleReference: null,
                modifyingScene: null,  // Scene ID being modified in modal
                modifyPrompt: null,    // Current prompt in modify modal
                modifyStyle: null,     // Current style in modify modal
                // Image generation settings
                imageModel: 'hidream',  // 'hidream' | 'nanobanana-pro' | 'nanobanana'
                // Edit with AI state
                editingScene: null,     // Scene ID being edited
                editMaskCanvas: null,   // Canvas element for mask
                editMaskCtx: null,      // Canvas 2D context
                editBrushSize: 30,      // Brush size in pixels
                editPrompt: '',         // Edit instruction prompt
                editLoading: false,     // Is edit in progress
                editHistory: [],        // Mask history for undo
                editOriginalData: null  // Original image data for canvas
            },

            // Step 5: Animation (to be implemented)
            animation: {
                status: 'idle',
                scenes: [],
                voiceover: {
                    voice: 'default',
                    speed: 1.0,
                    status: 'idle'
                }
            },

            // Step 6: Assembly
            assembly: {
                status: 'idle',
                sceneOrder: [],
                transitions: {},
                music: { enabled: false, trackId: null, volume: 30 },
                captions: { enabled: true, style: 'karaoke', position: 'bottom', fontSize: 'medium' },
                audioMix: { voiceVolume: 100, musicVolume: 30 },
                musicLibrary: [],
                transitionTypes: [],
                captionStyles: []
            },

            // Preview Engine State
            preview: {
                isReady: false,
                isPlaying: false,
                currentTime: 0,
                totalDuration: 0,
                currentSceneIndex: 0,
                loadProgress: 0,
                volume: 100
            },

            // Step 7: Export
            export: {
                status: 'idle',
                jobId: null,
                progress: 0,
                currentStage: null,
                outputUrl: null,
                error: null,
                selectedQuality: '1080p'
            }
        };

        // ==========================================
        // 5.2 STATE HELPERS
        // ==========================================
        function updateState(path, value) {
            const keys = path.split('.');
            let current = state;
            for (let i = 0; i < keys.length - 1; i++) {
                current = current[keys[i]];
            }
            current[keys[keys.length - 1]] = value;
        }

        function getState(path) {
            const keys = path.split('.');
            let current = state;
            for (const key of keys) {
                current = current[key];
            }
            return current;
        }
    </script>

    <!-- ============================================
         SECTION 6: CORE FUNCTIONS
         ============================================ -->
    <script>
        // ==========================================
        // 6.1 FIREBASE INITIALIZATION
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyAGczY5ZEIJdTq25BpQdia3lv2I556wOZo",
            authDomain: "ytseo-6d1b0.firebaseapp.com",
            projectId: "ytseo-6d1b0",
            storageBucket: "ytseo-6d1b0.firebasestorage.app",
            messagingSenderId: "363779069774",
            appId: "1:363779069774:web:1c9eb0be0abf8d5c2a7f66"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const functions = firebase.functions();
        const storage = firebase.storage();

        // ==========================================
        // 6.2 AUTHENTICATION
        // ==========================================
        let authResolved = false;
        let authTimeoutId = null;

        async function initAuth() {
            return new Promise((resolve, reject) => {
                // Set up a maximum wait time for auth (2.5 seconds)
                // This handles the race condition where Firebase takes time to restore auth state
                authTimeoutId = setTimeout(() => {
                    if (authResolved) return; // Already resolved

                    // Final check before redirecting
                    const currentUser = auth.currentUser;
                    if (currentUser) {
                        authResolved = true;
                        state.user = currentUser;
                        loadUserTokens().then(() => resolve(currentUser));
                    } else {
                        // Truly not authenticated after waiting - redirect to login
                        console.log('Auth timeout: No user found, redirecting to login');
                        window.location.href = '/video-optimizer';
                        reject('Not authenticated');
                    }
                }, 2500);

                // Listen for auth state changes
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    // If already resolved, ignore subsequent calls
                    if (authResolved) return;

                    if (user) {
                        // User is authenticated - clear timeout and proceed
                        authResolved = true;
                        if (authTimeoutId) {
                            clearTimeout(authTimeoutId);
                            authTimeoutId = null;
                        }
                        state.user = user;
                        await loadUserTokens();
                        resolve(user);
                        return;
                    }

                    // User is null - this could be:
                    // 1. Initial call before Firebase loads auth from storage (wait for real state)
                    // 2. User is truly not authenticated
                    // The timeout above will handle the final decision
                    console.log('Auth state: waiting for Firebase to restore session...');
                });
            });
        }

        async function loadUserTokens() {
            try {
                const userDoc = await db.collection('users').doc(state.user.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    state.tokens.balance = userData.creativeTokens || userData.tokens || 0;
                    state.tokens.plan = userData.plan || 'free';
                }
            } catch (error) {
                console.error('Error loading tokens:', error);
            }
        }

        // ==========================================
        // 6.3 PROJECT SAVE/LOAD
        // ==========================================
        let saveDebounceTimer = null;
        let isSaving = false;

        function scheduleAutoSave() {
            // Don't auto-save if no project ID yet (new project needs explicit save)
            if (!state.project.id) return;

            // Debounce to avoid too many saves
            if (saveDebounceTimer) {
                clearTimeout(saveDebounceTimer);
            }
            saveDebounceTimer = setTimeout(() => {
                saveProject(true); // true = silent save
            }, 2000);
        }

        async function saveProject(silent = false) {
            if (isSaving) return;
            isSaving = true;

            try {
                const saveProjectFn = functions.httpsCallable('creationWizardSaveProject');

                const projectData = {
                    name: state.project.name || generateProjectName(),
                    status: state.project.status,
                    platform: state.platform,
                    content: state.content,
                    script: state.script,
                    storyboard: state.storyboard,
                    animation: state.animation,
                    assembly: state.assembly,
                    export: state.export
                };

                const result = await saveProjectFn({
                    projectId: state.project.id || null,
                    projectData
                });

                if (result.data.success) {
                    state.project.id = result.data.projectId;
                    state.project.updatedAt = new Date().toISOString();

                    // Update URL with project ID
                    if (window.history.replaceState) {
                        const url = new URL(window.location);
                        url.searchParams.set('project', state.project.id);
                        window.history.replaceState({}, '', url);
                    }

                    if (!silent) {
                        showToast('Project saved', 'success');
                    }
                }
            } catch (error) {
                console.error('Save project error:', error);
                if (!silent) {
                    showToast('Failed to save project', 'error');
                }
            } finally {
                isSaving = false;
            }
        }

        async function loadProject(projectId) {
            state.isLoading = true;
            render();

            try {
                const loadProjectFn = functions.httpsCallable('creationWizardLoadProject');
                const result = await loadProjectFn({ projectId });

                if (result.data.success) {
                    const project = result.data.project;

                    // Restore state from project
                    state.project.id = project.id;
                    state.project.name = project.name;
                    state.project.status = project.status;
                    state.project.createdAt = project.createdAt;
                    state.project.updatedAt = project.updatedAt;

                    // Restore platform config
                    if (project.platform) {
                        state.platform = { ...state.platform, ...project.platform };
                        // Restore preset if platform was selected
                        if (project.platform.selected && PLATFORM_PRESETS[project.platform.selected]) {
                            state.platform.preset = PLATFORM_PRESETS[project.platform.selected];
                        }
                    }

                    // Restore content config
                    if (project.content) {
                        state.content = { ...state.content, ...project.content };
                    }

                    // Restore script data
                    if (project.script) {
                        state.script = { ...state.script, ...project.script };
                    }

                    // Restore storyboard data
                    if (project.storyboard) {
                        state.storyboard = { ...state.storyboard, ...project.storyboard };
                    }

                    // Restore animation data
                    if (project.animation) {
                        state.animation = { ...state.animation, ...project.animation };
                    }

                    // Restore assembly data
                    if (project.assembly) {
                        state.assembly = { ...state.assembly, ...project.assembly };
                    }

                    // Restore export data
                    if (project.export) {
                        state.export = { ...state.export, ...project.export };
                    }

                    // Calculate max reached step based on completed data
                    state.maxReachedStep = calculateMaxReachedStep();

                    showToast('Project loaded', 'success');
                }
            } catch (error) {
                console.error('Load project error:', error);
                showToast('Failed to load project', 'error');
            } finally {
                state.isLoading = false;
                render();
            }
        }

        async function loadProjectsList() {
            try {
                const getProjectsFn = functions.httpsCallable('creationWizardGetProjects');
                const result = await getProjectsFn({ limit: 20 });

                if (result.data.success) {
                    return result.data.projects;
                }
                return [];
            } catch (error) {
                console.error('Load projects list error:', error);
                return [];
            }
        }

        async function deleteProject(projectId) {
            if (!confirm('Are you sure you want to delete this project?')) return;

            try {
                const deleteProjectFn = functions.httpsCallable('creationWizardDeleteProject');
                await deleteProjectFn({ projectId });
                showToast('Project deleted', 'success');

                // If we deleted the current project, start fresh
                if (state.project.id === projectId) {
                    window.location.href = '/video-creation-wizard';
                }
            } catch (error) {
                console.error('Delete project error:', error);
                showToast('Failed to delete project', 'error');
            }
        }

        function generateProjectName() {
            const niche = state.content.niche ? VIDEO_NICHES[state.content.niche]?.name : '';
            const topic = state.content.topic ? ` - ${state.content.topic.slice(0, 30)}` : '';
            const date = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            return `${niche || 'Video'} Project${topic} (${date})`;
        }

        function calculateMaxReachedStep() {
            if (state.export.status === 'complete') return 7;
            if (state.assembly.status === 'ready') return 7;
            if (state.animation.scenes.length > 0) return 6;
            if (state.storyboard.scenes.length > 0) return 5;
            if (state.script.scenes.length > 0) return 4;
            if (state.content.niche && state.content.style) return 3;
            if (state.platform.selected) return 2;
            return 1;
        }

        function checkUrlForProject() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('project');
            if (projectId) {
                return projectId;
            }
            return null;
        }

        // ==========================================
        // 6.4 NAVIGATION
        // ==========================================
        function goToStep(step) {
            // Validate step transition
            if (step < 1 || step > WIZARD_STEPS.length) return;
            if (step > state.maxReachedStep + 1) return;

            // Validate current step is complete before moving forward
            if (step > state.currentStep && !isStepComplete(state.currentStep)) {
                showToast('Please complete the current step first', 'warning');
                return;
            }

            // Cleanup preview engine when leaving Assembly step
            if (state.currentStep === 6 && step !== 6) {
                cleanupPreviewEngine();
            }

            state.currentStep = step;
            if (step > state.maxReachedStep) {
                state.maxReachedStep = step;
            }

            render();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function isStepComplete(step) {
            switch (step) {
                case 1:
                    return state.platform.selected && state.platform.aspectRatio;
                case 2:
                    return state.content.niche && state.content.style;
                case 3:
                    return state.script.scenes.length > 0;
                case 4:
                    return state.storyboard.scenes.length > 0;
                case 5:
                    return state.animation.scenes.length > 0;
                case 6:
                    return state.assembly.status === 'ready';
                default:
                    return true;
            }
        }

        // ==========================================
        // 6.4 PLATFORM SELECTION
        // ==========================================
        function selectPlatform(platformId) {
            const preset = PLATFORM_PRESETS[platformId];
            if (!preset) return;

            state.platform.selected = platformId;
            state.platform.preset = preset;
            state.platform.aspectRatio = preset.defaultFormat;
            state.platform.targetDuration = Math.min(
                preset.maxDuration,
                Math.max(preset.minDuration, state.platform.targetDuration)
            );

            render();
            scheduleAutoSave();
        }

        function selectFormat(format) {
            if (!state.platform.preset) return;
            if (!state.platform.preset.formats.includes(format)) return;

            state.platform.aspectRatio = format;

            // Update resolution based on format
            const resolutions = {
                '16:9': { width: 1920, height: 1080 },
                '9:16': { width: 1080, height: 1920 },
                '1:1': { width: 1080, height: 1080 },
                '4:5': { width: 1080, height: 1350 }
            };
            state.platform.preset.resolution = resolutions[format];

            render();
            scheduleAutoSave();
        }

        function setDuration(duration) {
            if (!state.platform.preset) return;
            const preset = state.platform.preset;
            state.platform.targetDuration = Math.min(
                preset.maxDuration,
                Math.max(preset.minDuration, parseInt(duration))
            );
            render();
            scheduleAutoSave();
        }

        // ==========================================
        // 6.6 NICHE & STYLE SELECTION
        // ==========================================
        function selectNiche(nicheId) {
            state.content.niche = nicheId;
            state.content.subniche = null; // Reset subniche
            render();
            scheduleAutoSave();
        }

        function selectSubniche(subnicheId) {
            state.content.subniche = subnicheId;
            render();
            scheduleAutoSave();
        }

        function selectStyle(styleId) {
            state.content.style = styleId;
            render();
            scheduleAutoSave();
        }

        function setTopic(topic) {
            state.content.topic = topic;
            scheduleAutoSave();
        }

        function setPacing(pacing) {
            state.content.pacing = pacing;
            render();
            scheduleAutoSave();
        }

        function applyTopicSuggestion(topic) {
            state.content.topic = topic;
            render();
            scheduleAutoSave();
        }

        // ==========================================
        // 6.7 SCRIPT GENERATION & EDITING
        // ==========================================
        function setScriptTone(tone) {
            state.content.tone = tone;
            render();
        }

        async function generateScript() {
            // Get topic from input
            const topicInput = document.getElementById('script-topic');
            const instructionsInput = document.getElementById('script-instructions');

            const topic = topicInput?.value?.trim() || state.content.topic;
            const additionalInstructions = instructionsInput?.value?.trim() || '';

            if (!topic || topic.length < 3) {
                showToast('Please enter a topic for your video', 'warning');
                return;
            }

            // Update state
            state.content.topic = topic;
            state.script.status = 'generating';
            render();

            try {
                const generateScriptFn = functions.httpsCallable('creationWizardGenerateScript');

                const config = {
                    platform: state.platform.selected,
                    aspectRatio: state.platform.aspectRatio,
                    targetDuration: state.platform.targetDuration,
                    niche: state.content.niche,
                    subniche: state.content.subniche,
                    style: state.content.style,
                    topic: topic,
                    tone: state.content.tone || 'engaging',
                    pacing: state.content.pacing || 'medium',
                    additionalInstructions
                };

                const result = await generateScriptFn({
                    projectId: state.project.id || null,
                    config
                });

                if (result.data.success) {
                    const script = result.data.script;

                    // Update state with generated script
                    state.script = {
                        ...state.script,
                        ...script,
                        status: 'generated',
                        expandedScene: null
                    };

                    // Update project ID if new project was created
                    if (result.data.projectId && !state.project.id) {
                        state.project.id = result.data.projectId;
                    }

                    showToast('Script generated successfully!', 'success');
                    scheduleAutoSave();
                } else {
                    throw new Error('Script generation failed');
                }
            } catch (error) {
                console.error('Script generation error:', error);
                state.script.status = 'idle';
                showToast('Failed to generate script. Please try again.', 'error');
            }

            render();
        }

        async function regenerateFullScript() {
            if (!confirm('This will replace your current script. Continue?')) return;

            state.script.status = 'idle';
            state.script.scenes = [];
            state.script.title = '';
            state.script.hook = '';
            state.script.cta = '';
            render();
        }

        function updateScriptTitle(title) {
            state.script.title = title;
            scheduleAutoSave();
        }

        function updateScriptHook(hook) {
            state.script.hook = hook;
            scheduleAutoSave();
        }

        function updateScriptCTA(cta) {
            state.script.cta = cta;
            scheduleAutoSave();
        }

        function toggleSceneExpand(sceneId) {
            if (state.script.expandedScene === sceneId) {
                state.script.expandedScene = null;
            } else {
                state.script.expandedScene = sceneId;
            }
            render();
        }

        function updateSceneNarration(sceneId, value) {
            const scene = state.script.scenes.find(s => s.id === sceneId);
            if (scene) {
                scene.narration = value;
                scheduleAutoSave();
            }
        }

        function updateSceneVisual(sceneId, value) {
            const scene = state.script.scenes.find(s => s.id === sceneId);
            if (scene) {
                scene.visual = value;
                scheduleAutoSave();
            }
        }

        function updateSceneDuration(sceneId, value) {
            const scene = state.script.scenes.find(s => s.id === sceneId);
            if (scene) {
                scene.duration = parseInt(value) || 8;
                // Recalculate total duration
                state.script.totalDuration = state.script.scenes.reduce((sum, s) => sum + s.duration, 0);
                scheduleAutoSave();
                render();
            }
        }

        function updateSceneTransition(sceneId, value) {
            const scene = state.script.scenes.find(s => s.id === sceneId);
            if (scene) {
                scene.transition = value;
                scheduleAutoSave();
            }
        }

        async function regenerateScene(sceneId) {
            const scene = state.script.scenes.find(s => s.id === sceneId);
            if (!scene) return;

            const instructions = prompt('Any specific instructions for regenerating this scene? (or leave empty)');

            try {
                showToast('Regenerating scene...', 'info');

                const regenerateSceneFn = functions.httpsCallable('creationWizardRegenerateScene');
                const result = await regenerateSceneFn({
                    projectId: state.project.id,
                    sceneId: sceneId,
                    currentScript: state.script,
                    instructions: instructions || ''
                });

                if (result.data.success) {
                    // Update the scene in state
                    const index = state.script.scenes.findIndex(s => s.id === sceneId);
                    if (index !== -1) {
                        state.script.scenes[index] = {
                            ...state.script.scenes[index],
                            ...result.data.scene
                        };
                    }

                    showToast('Scene regenerated!', 'success');
                    scheduleAutoSave();
                    render();
                }
            } catch (error) {
                console.error('Regenerate scene error:', error);
                showToast('Failed to regenerate scene', 'error');
            }
        }

        function moveSceneUp(sceneId) {
            const index = state.script.scenes.findIndex(s => s.id === sceneId);
            if (index > 0) {
                const temp = state.script.scenes[index];
                state.script.scenes[index] = state.script.scenes[index - 1];
                state.script.scenes[index - 1] = temp;
                scheduleAutoSave();
                render();
            }
        }

        function moveSceneDown(sceneId) {
            const index = state.script.scenes.findIndex(s => s.id === sceneId);
            if (index < state.script.scenes.length - 1) {
                const temp = state.script.scenes[index];
                state.script.scenes[index] = state.script.scenes[index + 1];
                state.script.scenes[index + 1] = temp;
                scheduleAutoSave();
                render();
            }
        }

        function deleteScene(sceneId) {
            if (state.script.scenes.length <= 1) {
                showToast('You need at least one scene', 'warning');
                return;
            }

            if (!confirm('Delete this scene?')) return;

            state.script.scenes = state.script.scenes.filter(s => s.id !== sceneId);
            state.script.totalDuration = state.script.scenes.reduce((sum, s) => sum + s.duration, 0);
            scheduleAutoSave();
            render();
        }

        function addNewScene() {
            const maxId = Math.max(...state.script.scenes.map(s => s.id), 0);
            const newScene = {
                id: maxId + 1,
                narration: '',
                visual: '',
                duration: 10,
                transition: 'cut',
                status: 'pending'
            };

            state.script.scenes.push(newScene);
            state.script.expandedScene = newScene.id;
            state.script.totalDuration = state.script.scenes.reduce((sum, s) => sum + s.duration, 0);
            scheduleAutoSave();
            render();

            // Scroll to new scene
            setTimeout(() => {
                const sceneCards = document.querySelectorAll('.scene-card');
                if (sceneCards.length > 0) {
                    sceneCards[sceneCards.length - 1].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }

        // ==========================================
        // 6.8 STORYBOARD GENERATION
        // ==========================================
        let imagePollingIntervals = {};

        async function generateInitialStoryboard() {
            const scenes = state.script.scenes || [];
            if (scenes.length === 0) return;

            // Only generate FIRST scene automatically - others on demand
            const firstScene = scenes[0];

            state.storyboard.status = 'generating';

            // Initialize all storyboard scenes - first is generating, others pending
            state.storyboard.scenes = scenes.map((scene, index) => ({
                sceneId: scene.id,
                status: index === 0 ? 'generating' : 'pending',
                imageUrl: null,
                prompt: scene.visual || '',
                jobId: null,
                source: 'ai' // 'ai' | 'stock' | 'upload'
            }));

            render();

            // Generate only first scene
            try {
                await generateSingleSceneImage(firstScene.id);
                state.storyboard.status = 'partial';
                render();
            } catch (error) {
                console.error('Initial storyboard generation error:', error);
                showToast('Failed to generate first image. Click to retry.', 'error');
                state.storyboard.status = 'error';
                render();
            }
        }

        // Model configuration with token costs
        const IMAGE_MODELS = {
            'hidream': {
                name: 'HiDream',
                description: 'Artistic & cinematic style',
                tokenCost: 2,
                cloudFunction: 'creationWizardGenerateSceneImage'
            },
            'nanobanana-pro': {
                name: 'NanoBanana Pro',
                description: 'High quality, fast generation',
                tokenCost: 3,
                cloudFunction: 'generateCreativeImage'
            },
            'nanobanana': {
                name: 'NanoBanana',
                description: 'Quick drafts, lower cost',
                tokenCost: 1,
                cloudFunction: 'generateCreativeImage'
            }
        };

        // Get current model configuration
        function getCurrentModelConfig() {
            return IMAGE_MODELS[state.storyboard.imageModel] || IMAGE_MODELS['hidream'];
        }

        // Set image generation model
        function setImageModel(modelId) {
            if (IMAGE_MODELS[modelId]) {
                state.storyboard.imageModel = modelId;
                render();
            }
        }

        async function generateSingleSceneImage(sceneId, customModel = null) {
            const scene = state.script.scenes.find(s => s.id === sceneId);
            if (!scene) return;

            const modelId = customModel || state.storyboard.imageModel || 'hidream';
            const modelConfig = IMAGE_MODELS[modelId] || IMAGE_MODELS['hidream'];

            // Find or create storyboard entry
            let storyboardScene = state.storyboard.scenes.find(s => s.sceneId === sceneId);
            if (!storyboardScene) {
                storyboardScene = {
                    sceneId: sceneId,
                    status: 'pending',
                    imageUrl: null,
                    prompt: scene.visual || '',
                    jobId: null,
                    source: 'ai',
                    model: modelId
                };
                state.storyboard.scenes.push(storyboardScene);
            }

            storyboardScene.status = 'generating';
            storyboardScene.model = modelId;
            storyboardScene.error = null;
            render();

            const prompt = scene.visual || scene.narration || 'A cinematic scene';

            try {
                // Check if using HiDream (RunPod) or NanoBanana (Gemini)
                if (modelId === 'hidream') {
                    // Use RunPod HiDream endpoint
                    const generateFn = functions.httpsCallable('creationWizardGenerateSceneImage');
                    const result = await generateFn({
                        projectId: state.project.id,
                        sceneId: sceneId,
                        prompt: prompt,
                        style: state.content.style,
                        aspectRatio: state.platform.aspectRatio
                    });

                    if (result.data.success) {
                        storyboardScene.jobId = result.data.jobId;
                        storyboardScene.imageUrl = result.data.imageUrl;
                        storyboardScene.prompt = result.data.prompt;
                        storyboardScene.source = 'ai';

                        // Start polling for completion
                        startImagePolling(sceneId, result.data.jobId);
                    } else {
                        throw new Error(result.data.message || 'Generation failed');
                    }
                } else {
                    // Use NanoBanana (Gemini) - synchronous result
                    const generateFn = functions.httpsCallable('generateCreativeImage');

                    // Map aspect ratio
                    const aspectRatioMap = {
                        '16:9': '16:9',
                        '9:16': '9:16',
                        '1:1': '1:1',
                        '4:3': '4:3'
                    };

                    const result = await generateFn({
                        prompt: prompt,
                        model: modelId,
                        quantity: 1,
                        aspectRatio: aspectRatioMap[state.platform.aspectRatio] || '16:9',
                        quality: modelId === 'nanobanana-pro' ? 'hd' : 'basic'
                    });

                    if (result.data.success && result.data.images && result.data.images.length > 0) {
                        storyboardScene.status = 'ready';
                        storyboardScene.imageUrl = result.data.images[0].url;
                        storyboardScene.prompt = prompt;
                        storyboardScene.source = 'ai';
                        showToast(`Image generated! (${modelConfig.name})`, 'success');
                        scheduleAutoSave();
                    } else {
                        throw new Error(result.data.message || 'No images returned');
                    }
                }

                render();

            } catch (error) {
                console.error('Scene generation error:', error);
                storyboardScene.status = 'error';
                storyboardScene.error = error.message || 'Failed to generate image';

                // Show detailed error message
                const errorMsg = error.message || 'Unknown error';
                if (errorMsg.includes('token') || errorMsg.includes('balance')) {
                    showToast('Insufficient tokens. Visit Creative Studio to get more.', 'error');
                } else if (errorMsg.includes('API key') || errorMsg.includes('configured')) {
                    showToast('Service not configured. Contact support.', 'error');
                } else {
                    showToast(`Failed: ${errorMsg.substring(0, 50)}`, 'error');
                }
                render();
            }
        }

        async function regenerateSingleSceneImage(sceneId) {
            await generateSingleSceneImage(sceneId);
        }

        function startImagePolling(sceneId, jobId) {
            // Clear any existing polling for this scene
            if (imagePollingIntervals[sceneId]) {
                clearInterval(imagePollingIntervals[sceneId]);
            }

            let pollCount = 0;
            const maxPolls = 90; // 3 minutes max (2s intervals) - handles cold starts

            imagePollingIntervals[sceneId] = setInterval(async () => {
                pollCount++;

                if (pollCount > maxPolls) {
                    clearInterval(imagePollingIntervals[sceneId]);
                    const storyboardScene = state.storyboard.scenes.find(s => s.sceneId === sceneId);
                    if (storyboardScene && storyboardScene.status === 'generating') {
                        storyboardScene.status = 'error';
                        storyboardScene.error = 'Generation timed out. Try again.';
                        render();
                    }
                    return;
                }

                try {
                    const checkStatusFn = functions.httpsCallable('creationWizardCheckImageStatus');
                    const result = await checkStatusFn({ jobId });

                    if (result.data.status === 'COMPLETED') {
                        clearInterval(imagePollingIntervals[sceneId]);

                        const storyboardScene = state.storyboard.scenes.find(s => s.sceneId === sceneId);
                        if (storyboardScene) {
                            // Add cache-busting parameter to force browser to fetch fresh
                            if (storyboardScene.imageUrl) {
                                const separator = storyboardScene.imageUrl.includes('?') ? '&' : '?';
                                storyboardScene.imageUrl = `${storyboardScene.imageUrl}${separator}t=${Date.now()}`;
                            }

                            // Wait a moment for Firebase Storage to fully propagate the upload
                            await new Promise(resolve => setTimeout(resolve, 1000));

                            storyboardScene.status = 'ready';
                        }

                        // Check if all generating scenes are done
                        const allDone = state.storyboard.scenes.every(s =>
                            s.status === 'ready' || s.status === 'pending' || s.status === 'error'
                        );
                        if (allDone) {
                            state.storyboard.status = 'ready';
                        }

                        render();
                        scheduleAutoSave();

                    } else if (result.data.status === 'FAILED') {
                        clearInterval(imagePollingIntervals[sceneId]);

                        const storyboardScene = state.storyboard.scenes.find(s => s.sceneId === sceneId);
                        if (storyboardScene) {
                            storyboardScene.status = 'error';
                            storyboardScene.error = result.data.error || 'Generation failed';
                        }
                        render();
                    }
                    // If IN_PROGRESS or IN_QUEUE, keep polling

                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 2000); // Poll every 2 seconds
        }

        // Modify Modal Functions
        function openModifyModal(sceneId) {
            const storyboardScene = state.storyboard.scenes.find(s => s.sceneId === sceneId);
            const scene = state.script.scenes.find(s => s.id === sceneId);

            state.storyboard.modifyingScene = sceneId;
            state.storyboard.modifyPrompt = storyboardScene?.prompt || scene?.visual || '';
            state.storyboard.modifyStyle = state.content.style || 'cinematic';

            render();
        }

        function closeModifyModal() {
            state.storyboard.modifyingScene = null;
            state.storyboard.modifyPrompt = null;
            state.storyboard.modifyStyle = null;
            render();
        }

        function setModifyStyle(style) {
            state.storyboard.modifyStyle = style;
            render();
        }

        function appendToModifyPrompt(text) {
            const input = document.getElementById('modify-prompt-input');
            if (input) {
                const currentPrompt = input.value.trim();
                input.value = currentPrompt ? `${currentPrompt}, ${text}` : text;
                state.storyboard.modifyPrompt = input.value;
            }
        }

        async function applyModifyAndGenerate() {
            const sceneId = state.storyboard.modifyingScene;
            if (!sceneId) return;

            const input = document.getElementById('modify-prompt-input');
            const newPrompt = input?.value?.trim();

            if (!newPrompt || newPrompt.length < 10) {
                showToast('Please enter a more detailed prompt', 'warning');
                return;
            }

            // Update the scene's visual description
            const scene = state.script.scenes.find(s => s.id === sceneId);
            if (scene) {
                scene.visual = newPrompt;
            }

            // Update storyboard scene
            let storyboardScene = state.storyboard.scenes.find(s => s.sceneId === sceneId);
            if (storyboardScene) {
                storyboardScene.prompt = newPrompt;
            }

            closeModifyModal();

            // Generate with new prompt
            await generateSingleSceneImage(sceneId);
        }

        // ==========================================
        // 6.8.5 STOCK MEDIA BROWSER (Enhanced with VIDEO + Trim)
        // ==========================================
        let stockBrowserState = {
            isOpen: false,
            targetSceneId: null,
            mediaType: 'image', // 'image' | 'video'
            activeTab: 'images', // 'images' | 'videos'
            query: '',
            suggestedQuery: '', // Primary AI suggestion
            alternativeQueries: [], // Additional AI suggestions
            suggestedCategory: '', // AI-suggested category
            loadingAiSuggestions: false, // Loading state for AI suggestions
            results: [],
            videoResults: [], // Separate storage for video results
            loading: false,
            page: 1,
            total: 0,
            // Video trim state
            selectedVideo: null,  // Selected video for preview/trim
            trimStart: 0,         // Trim start time in seconds
            trimEnd: null,        // Trim end time (null = full duration)
            videoDuration: 0,     // Total video duration
            isPreviewPlaying: false
        };

        async function openStockBrowser(sceneId, mediaType = 'image') {
            stockBrowserState.isOpen = true;
            stockBrowserState.targetSceneId = sceneId;
            stockBrowserState.mediaType = mediaType;
            stockBrowserState.activeTab = mediaType === 'video' ? 'videos' : 'images';
            stockBrowserState.results = [];
            stockBrowserState.videoResults = [];
            stockBrowserState.query = '';
            stockBrowserState.page = 1;
            stockBrowserState.selectedVideo = null;
            stockBrowserState.trimStart = 0;
            stockBrowserState.trimEnd = null;
            stockBrowserState.alternativeQueries = [];
            stockBrowserState.suggestedCategory = '';
            stockBrowserState.loadingAiSuggestions = true;

            // Get scene for smart suggestions
            const scene = state.script.scenes.find(s => s.id === sceneId);

            // Use basic extraction as initial placeholder
            if (scene) {
                const basicQuery = extractSmartKeywords(scene);
                stockBrowserState.query = basicQuery;
                stockBrowserState.suggestedQuery = basicQuery;
            } else {
                stockBrowserState.query = 'cinematic background';
                stockBrowserState.suggestedQuery = '';
            }

            renderStockBrowserModal();

            // Start initial search with basic query
            if (stockBrowserState.query) {
                searchStockMedia(stockBrowserState.query);
            }

            // Simultaneously fetch AI-powered smart suggestions
            if (scene) {
                try {
                    const generateQueriesFn = functions.httpsCallable('generateSmartStockQueries');
                    const result = await generateQueriesFn({
                        sceneDescription: scene.visual || '',
                        narration: scene.narration || '',
                        mediaType: stockBrowserState.activeTab === 'videos' ? 'video' : 'image'
                    });

                    if (result.data.success) {
                        stockBrowserState.suggestedQuery = result.data.primaryQuery;
                        stockBrowserState.alternativeQueries = result.data.queries.slice(1) || [];
                        stockBrowserState.suggestedCategory = result.data.category || '';
                        stockBrowserState.loadingAiSuggestions = false;

                        // Update the search input with AI suggestion
                        const searchInput = document.getElementById('stock-search-input');
                        if (searchInput && stockBrowserState.query !== result.data.primaryQuery) {
                            searchInput.value = result.data.primaryQuery;
                            stockBrowserState.query = result.data.primaryQuery;
                        }

                        // Re-render to show AI suggestions
                        updateStockSuggestionsUI();

                        // Re-search with AI query if different from basic
                        if (result.data.primaryQuery && result.data.primaryQuery !== extractSmartKeywords(scene)) {
                            searchStockMedia(result.data.primaryQuery);
                        }
                    }
                } catch (error) {
                    console.error('AI suggestions error:', error);
                    stockBrowserState.loadingAiSuggestions = false;
                    updateStockSuggestionsUI();
                }
            } else {
                stockBrowserState.loadingAiSuggestions = false;
            }
        }

        // Update just the suggestions UI without re-rendering entire modal
        function updateStockSuggestionsUI() {
            const suggestionsArea = document.getElementById('stock-ai-suggestions');
            if (!suggestionsArea) return;

            let suggestionsHtml = '';

            if (stockBrowserState.loadingAiSuggestions) {
                suggestionsHtml = `
                    <div style="padding: 0.5rem 1.25rem; background: rgba(139, 92, 246, 0.1); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 0.5rem;">
                        <span class="animate-spin" style="width: 14px; height: 14px; border: 2px solid rgba(139,92,246,0.3); border-top-color: #a78bfa; border-radius: 50%;"></span>
                        <span style="color: #a78bfa; font-size: 0.75rem;">AI analyzing your scene...</span>
                    </div>
                `;
            } else if (stockBrowserState.suggestedQuery) {
                suggestionsHtml = `
                    <div style="padding: 0.6rem 1.25rem; background: rgba(139, 92, 246, 0.1); border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.4rem;">
                            <span style="color: #a78bfa; font-size: 0.7rem;">üß† AI Smart Suggestions:</span>
                            ${stockBrowserState.suggestedCategory ? `<span style="background: rgba(139,92,246,0.3); color: #c4b5fd; padding: 0.1rem 0.4rem; border-radius: 1rem; font-size: 0.6rem;">${stockBrowserState.suggestedCategory}</span>` : ''}
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.4rem;">
                            <button onclick="applyStockSuggestion('${stockBrowserState.suggestedQuery.replace(/'/g, "\\'")}')"
                                    style="padding: 0.3rem 0.6rem; background: linear-gradient(135deg, rgba(139,92,246,0.4), rgba(236,72,153,0.3)); border: 1px solid rgba(139,92,246,0.5); border-radius: 1rem; color: white; cursor: pointer; font-size: 0.75rem; font-weight: 500;">
                                ‚ú® ${stockBrowserState.suggestedQuery}
                            </button>
                            ${stockBrowserState.alternativeQueries.map(q => `
                                <button onclick="applyStockSuggestion('${q.replace(/'/g, "\\'")}')"
                                        style="padding: 0.3rem 0.6rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 1rem; color: rgba(255,255,255,0.8); cursor: pointer; font-size: 0.7rem;">
                                    ${q}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            suggestionsArea.innerHTML = suggestionsHtml;
        }

        // Apply a suggestion to search
        function applyStockSuggestion(query) {
            stockBrowserState.query = query;
            const searchInput = document.getElementById('stock-search-input');
            if (searchInput) searchInput.value = query;
            searchStockMedia(query);
        }

        // Extract smart keywords from scene description for stock search
        function extractSmartKeywords(scene) {
            const visual = scene.visual || '';
            const narration = scene.narration || '';
            const combined = `${visual} ${narration}`.toLowerCase();

            // Remove common words and extract key nouns/adjectives
            const stopWords = ['the', 'a', 'an', 'is', 'are', 'was', 'were', 'be', 'been', 'being',
                              'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could',
                              'should', 'may', 'might', 'must', 'shall', 'can', 'need', 'dare',
                              'ought', 'used', 'to', 'of', 'in', 'for', 'on', 'with', 'at', 'by',
                              'from', 'up', 'about', 'into', 'over', 'after', 'beneath', 'under',
                              'above', 'show', 'showing', 'shows', 'scene', 'image', 'video', 'clip'];

            // Extract words
            const words = combined
                .replace(/[^a-z\s]/g, '') // Remove non-letters
                .split(/\s+/)
                .filter(word => word.length > 2 && !stopWords.includes(word));

            // Prioritize descriptive words (colors, emotions, objects)
            const priorityWords = [];
            const visualKeywords = ['sunset', 'sunrise', 'ocean', 'mountain', 'forest', 'city',
                                   'beach', 'sky', 'cloud', 'rain', 'snow', 'fire', 'water',
                                   'office', 'business', 'technology', 'nature', 'people', 'team',
                                   'happy', 'sad', 'excited', 'calm', 'peaceful', 'dramatic',
                                   'bright', 'dark', 'colorful', 'minimal', 'modern', 'vintage',
                                   'aerial', 'closeup', 'portrait', 'landscape', 'abstract'];

            words.forEach(word => {
                if (visualKeywords.includes(word)) {
                    priorityWords.unshift(word);
                } else if (priorityWords.length < 3) {
                    priorityWords.push(word);
                }
            });

            // Return top 2-3 keywords
            const result = [...new Set(priorityWords)].slice(0, 3).join(' ');
            return result || 'cinematic background';
        }

        function closeStockBrowser() {
            stockBrowserState.isOpen = false;
            stockBrowserState.targetSceneId = null;
            const modal = document.getElementById('stock-browser-modal');
            if (modal) modal.remove();
        }

        async function searchStockMedia(query = stockBrowserState.query, page = 1) {
            if (!query || query.length < 2) {
                showToast('Please enter a search term', 'warning');
                return;
            }

            stockBrowserState.loading = true;
            stockBrowserState.query = query;
            stockBrowserState.page = page;
            renderStockBrowserModal();

            try {
                const searchFn = firebase.functions().httpsCallable('searchStockMedia');
                const result = await searchFn({
                    query: query,
                    type: stockBrowserState.mediaType,
                    source: 'all',
                    filters: {
                        orientation: state.platform.aspectRatio === '9:16' ? 'portrait' : 'landscape',
                        page: page,
                        perPage: 20
                    }
                });

                stockBrowserState.results = result.data.results || [];
                stockBrowserState.total = result.data.total || 0;
                stockBrowserState.loading = false;

            } catch (error) {
                console.error('Stock search error:', error);
                showToast('Failed to search stock media', 'error');
                stockBrowserState.loading = false;
            }

            renderStockBrowserModal();
        }

        async function selectStockMedia(media) {
            if (!stockBrowserState.targetSceneId) return;

            const sceneId = stockBrowserState.targetSceneId;
            showToast('Importing media...', 'info');

            try {
                // Import to Firebase Storage
                const importFn = firebase.functions().httpsCallable('importStockMedia');
                const result = await importFn({
                    mediaId: media.id,
                    url: media.url,
                    type: media.type,
                    projectId: state.project.id
                });

                if (result.data.success) {
                    // Update storyboard scene
                    let storyboardScene = state.storyboard.scenes.find(s => s.sceneId === sceneId);
                    if (!storyboardScene) {
                        storyboardScene = {
                            sceneId: sceneId,
                            status: 'pending',
                            imageUrl: null,
                            prompt: '',
                            jobId: null,
                            source: 'stock'
                        };
                        state.storyboard.scenes.push(storyboardScene);
                    }

                    storyboardScene.imageUrl = result.data.url;
                    storyboardScene.status = 'ready';
                    storyboardScene.source = 'stock';
                    storyboardScene.stockInfo = {
                        id: media.id,
                        source: media.source,
                        author: media.author,
                        license: media.license
                    };

                    closeStockBrowser();
                    showToast('Stock image added!', 'success');
                    scheduleAutoSave();
                    render();
                }
            } catch (error) {
                console.error('Import error:', error);
                showToast('Failed to import media', 'error');
            }
        }

        // Switch between Images and Videos tabs
        async function switchStockTab(tab) {
            stockBrowserState.activeTab = tab;
            stockBrowserState.selectedVideo = null;
            stockBrowserState.trimStart = 0;
            stockBrowserState.trimEnd = null;

            // Search with current query for new media type
            const mediaType = tab === 'videos' ? 'video' : 'image';
            const needsNewSuggestions = stockBrowserState.mediaType !== mediaType;
            stockBrowserState.mediaType = mediaType;

            if (stockBrowserState.query) {
                searchStockMedia(stockBrowserState.query);
            } else {
                renderStockBrowserModal();
            }

            // Regenerate AI suggestions for new media type
            if (needsNewSuggestions && stockBrowserState.targetSceneId) {
                const scene = state.script.scenes.find(s => s.id === stockBrowserState.targetSceneId);
                if (scene) {
                    stockBrowserState.loadingAiSuggestions = true;
                    updateStockSuggestionsUI();

                    try {
                        const generateQueriesFn = functions.httpsCallable('generateSmartStockQueries');
                        const result = await generateQueriesFn({
                            sceneDescription: scene.visual || '',
                            narration: scene.narration || '',
                            mediaType: mediaType
                        });

                        if (result.data.success) {
                            stockBrowserState.suggestedQuery = result.data.primaryQuery;
                            stockBrowserState.alternativeQueries = result.data.queries.slice(1) || [];
                            stockBrowserState.suggestedCategory = result.data.category || '';
                        }
                    } catch (error) {
                        console.error('AI suggestions error on tab switch:', error);
                    }
                    stockBrowserState.loadingAiSuggestions = false;
                    updateStockSuggestionsUI();
                }
            }
        }

        // Preview a stock video for trimming
        function previewStockVideo(media) {
            stockBrowserState.selectedVideo = media;
            stockBrowserState.trimStart = 0;
            stockBrowserState.trimEnd = null;
            stockBrowserState.videoDuration = media.duration || 30;
            renderStockBrowserModal();
        }

        // Update trim values from timeline
        function updateStockVideoTrim(handle, percent) {
            const duration = stockBrowserState.videoDuration || 30;
            const time = (percent / 100) * duration;

            if (handle === 'start') {
                stockBrowserState.trimStart = Math.max(0, Math.min(time, (stockBrowserState.trimEnd || duration) - 3));
            } else {
                stockBrowserState.trimEnd = Math.min(duration, Math.max(time, stockBrowserState.trimStart + 3));
            }
            renderStockBrowserModal();
        }

        // Format duration for display
        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Select stock video with trim settings
        async function selectStockVideoWithTrim() {
            if (!stockBrowserState.selectedVideo || !stockBrowserState.targetSceneId) return;

            const media = stockBrowserState.selectedVideo;
            const sceneId = stockBrowserState.targetSceneId;
            const trimStart = stockBrowserState.trimStart || 0;
            const trimEnd = stockBrowserState.trimEnd || stockBrowserState.videoDuration;

            // Store thumbnail from search results (Pexels/Pixabay allow hotlinking thumbnails)
            const thumbnailUrl = media.thumbnail || media.preview || media.image;

            showToast('Importing video...', 'info');

            try {
                const importFn = firebase.functions().httpsCallable('importStockMedia');
                const result = await importFn({
                    mediaId: media.id,
                    url: media.videoUrl || media.url,
                    type: 'video',
                    projectId: state.project.id,
                    thumbnailUrl: thumbnailUrl, // Pass thumbnail for reference
                    trimStart: trimStart,
                    trimEnd: trimEnd,
                    originalDuration: media.duration || stockBrowserState.videoDuration
                });

                if (result.data.success) {
                    let storyboardScene = state.storyboard.scenes.find(s => s.sceneId === sceneId);
                    if (!storyboardScene) {
                        storyboardScene = {
                            sceneId: sceneId,
                            status: 'pending',
                            imageUrl: null,
                            prompt: '',
                            jobId: null,
                            source: 'stock'
                        };
                        state.storyboard.scenes.push(storyboardScene);
                    }

                    // Use thumbnail from search results for preview (not the video URL)
                    storyboardScene.imageUrl = thumbnailUrl;
                    storyboardScene.videoUrl = result.data.url;
                    storyboardScene.status = 'ready';
                    storyboardScene.source = 'stock-video';
                    storyboardScene.stockInfo = {
                        id: media.id,
                        source: media.source,
                        author: media.author,
                        license: media.license,
                        thumbnailUrl: thumbnailUrl,
                        thumbnailFallback: media.thumbnailFallback || media.preview || null,
                        trimStart: trimStart,
                        trimEnd: trimEnd,
                        originalDuration: media.duration || stockBrowserState.videoDuration,
                        clipDuration: trimEnd - trimStart
                    };

                    closeStockBrowser();
                    showToast(`Video clip added! (${formatDuration(trimEnd - trimStart)})`, 'success');
                    scheduleAutoSave();
                    render();
                }
            } catch (error) {
                console.error('Video import error:', error);
                showToast('Failed to import video', 'error');
            }
        }

        function renderStockBrowserModal() {
            // Remove existing modal
            const existing = document.getElementById('stock-browser-modal');
            if (existing) existing.remove();

            if (!stockBrowserState.isOpen) return;

            const isVideoTab = stockBrowserState.activeTab === 'videos';
            const hasVideoSelected = stockBrowserState.selectedVideo !== null;
            const trimStart = stockBrowserState.trimStart || 0;
            const trimEnd = stockBrowserState.trimEnd || stockBrowserState.videoDuration || 30;
            const duration = stockBrowserState.videoDuration || 30;
            const startPercent = (trimStart / duration) * 100;
            const endPercent = (trimEnd / duration) * 100;

            const modal = document.createElement('div');
            modal.id = 'stock-browser-modal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 1001; padding: 1rem;" onclick="if(event.target === this) closeStockBrowser()">
                    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 1rem; width: 100%; max-width: 950px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
                        <!-- Header -->
                        <div style="padding: 1rem 1.25rem; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin: 0; color: white; font-size: 1.1rem; font-weight: 600;">üì∑ Stock Media Browser</h3>
                                <p style="margin: 0.25rem 0 0 0; color: rgba(255,255,255,0.6); font-size: 0.8rem;">Free royalty-free media from Pexels & Pixabay</p>
                            </div>
                            <button onclick="closeStockBrowser()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0.25rem;">√ó</button>
                        </div>

                        <!-- Tab Switcher -->
                        <div style="display: flex; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <button onclick="switchStockTab('images')"
                                    style="flex: 1; padding: 0.75rem; background: ${!isVideoTab ? 'rgba(139, 92, 246, 0.2)' : 'transparent'}; border: none; border-bottom: ${!isVideoTab ? '2px solid #8b5cf6' : '2px solid transparent'}; color: ${!isVideoTab ? 'white' : 'rgba(255,255,255,0.6)'}; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                üñºÔ∏è Images
                            </button>
                            <button onclick="switchStockTab('videos')"
                                    style="flex: 1; padding: 0.75rem; background: ${isVideoTab ? 'rgba(16, 185, 129, 0.2)' : 'transparent'}; border: none; border-bottom: ${isVideoTab ? '2px solid #10b981' : '2px solid transparent'}; color: ${isVideoTab ? 'white' : 'rgba(255,255,255,0.6)'}; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                üé¨ Videos
                            </button>
                        </div>

                        <!-- AI Smart Suggestions Container -->
                        <div id="stock-ai-suggestions">
                            ${stockBrowserState.loadingAiSuggestions ? `
                                <div style="padding: 0.5rem 1.25rem; background: rgba(139, 92, 246, 0.1); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 0.5rem;">
                                    <span class="animate-spin" style="width: 14px; height: 14px; border: 2px solid rgba(139,92,246,0.3); border-top-color: #a78bfa; border-radius: 50%;"></span>
                                    <span style="color: #a78bfa; font-size: 0.75rem;">AI analyzing your scene...</span>
                                </div>
                            ` : stockBrowserState.suggestedQuery ? `
                                <div style="padding: 0.6rem 1.25rem; background: rgba(139, 92, 246, 0.1); border-bottom: 1px solid rgba(255,255,255,0.1);">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.4rem;">
                                        <span style="color: #a78bfa; font-size: 0.7rem;">üß† AI Smart Suggestions:</span>
                                        ${stockBrowserState.suggestedCategory ? `<span style="background: rgba(139,92,246,0.3); color: #c4b5fd; padding: 0.1rem 0.4rem; border-radius: 1rem; font-size: 0.6rem;">${stockBrowserState.suggestedCategory}</span>` : ''}
                                    </div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 0.4rem;">
                                        <button onclick="applyStockSuggestion('${stockBrowserState.suggestedQuery.replace(/'/g, "\\'")}')"
                                                style="padding: 0.3rem 0.6rem; background: linear-gradient(135deg, rgba(139,92,246,0.4), rgba(236,72,153,0.3)); border: 1px solid rgba(139,92,246,0.5); border-radius: 1rem; color: white; cursor: pointer; font-size: 0.75rem; font-weight: 500;">
                                            ‚ú® ${stockBrowserState.suggestedQuery}
                                        </button>
                                        ${(stockBrowserState.alternativeQueries || []).map(q => `
                                            <button onclick="applyStockSuggestion('${q.replace(/'/g, "\\'")}')"
                                                    style="padding: 0.3rem 0.6rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 1rem; color: rgba(255,255,255,0.8); cursor: pointer; font-size: 0.7rem;">
                                                ${q}
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        <!-- Search Bar -->
                        <div style="padding: 1rem 1.25rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text"
                                       id="stock-search-input"
                                       value="${stockBrowserState.query}"
                                       placeholder="Search for ${isVideoTab ? 'videos' : 'images'}..."
                                       style="flex: 1; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; font-size: 0.9rem;"
                                       onkeydown="if(event.key === 'Enter') searchStockMedia(this.value)">
                                <button onclick="searchStockMedia(document.getElementById('stock-search-input').value)"
                                        style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, ${isVideoTab ? '#10b981, #059669' : '#8b5cf6, #06b6d4'}); border: none; border-radius: 0.5rem; color: white; font-weight: 600; cursor: pointer;">
                                    üîç Search
                                </button>
                            </div>
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-wrap: wrap;">
                                ${['nature', 'business', 'technology', 'people', 'city', 'abstract', 'motion', 'aerial'].map(tag => `
                                    <button onclick="searchStockMedia('${tag}')"
                                            style="padding: 0.4rem 0.75rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 1rem; color: rgba(255,255,255,0.8); font-size: 0.75rem; cursor: pointer; transition: all 0.2s;"
                                            onmouseover="this.style.background='rgba(139,92,246,0.3)'"
                                            onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                                        ${tag}
                                    </button>
                                `).join('')}
                            </div>
                        </div>

                        ${isVideoTab && hasVideoSelected ? `
                            <!-- Video Preview & Trim Panel -->
                            <div style="padding: 1rem; background: rgba(0,0,0,0.3);">
                                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                    <!-- Video Preview -->
                                    <div style="flex: 1; min-width: 300px;">
                                        <video id="stock-video-preview"
                                               src="${stockBrowserState.selectedVideo.videoUrl || stockBrowserState.selectedVideo.url}"
                                               style="width: 100%; max-height: 200px; border-radius: 0.5rem; background: black;"
                                               controls
                                               muted></video>
                                    </div>

                                    <!-- Trim Controls -->
                                    <div style="flex: 1; min-width: 250px;">
                                        <div style="color: white; font-size: 0.85rem; font-weight: 600; margin-bottom: 0.75rem;">‚úÇÔ∏è Trim Video Clip</div>

                                        <!-- Timeline -->
                                        <div style="position: relative; height: 40px; background: rgba(255,255,255,0.1); border-radius: 0.5rem; margin-bottom: 0.75rem; cursor: pointer;"
                                             id="video-trim-timeline">
                                            <!-- Selected region -->
                                            <div style="position: absolute; top: 0; bottom: 0; left: ${startPercent}%; width: ${endPercent - startPercent}%; background: linear-gradient(135deg, rgba(16, 185, 129, 0.4), rgba(6, 182, 212, 0.4)); border-radius: 0.25rem;"></div>

                                            <!-- Start handle -->
                                            <div style="position: absolute; top: 0; bottom: 0; left: ${startPercent}%; width: 12px; background: #10b981; border-radius: 0.25rem; cursor: ew-resize; transform: translateX(-50%); display: flex; align-items: center; justify-content: center;"
                                                 class="trim-handle" data-handle="start">
                                                <div style="width: 2px; height: 60%; background: white; border-radius: 1px;"></div>
                                            </div>

                                            <!-- End handle -->
                                            <div style="position: absolute; top: 0; bottom: 0; left: ${endPercent}%; width: 12px; background: #10b981; border-radius: 0.25rem; cursor: ew-resize; transform: translateX(-50%); display: flex; align-items: center; justify-content: center;"
                                                 class="trim-handle" data-handle="end">
                                                <div style="width: 2px; height: 60%; background: white; border-radius: 1px;"></div>
                                            </div>
                                        </div>

                                        <!-- Time Display -->
                                        <div style="display: flex; justify-content: space-between; color: rgba(255,255,255,0.7); font-size: 0.75rem; margin-bottom: 0.75rem;">
                                            <span>Start: ${formatDuration(trimStart)}</span>
                                            <span style="color: #10b981; font-weight: 600;">Duration: ${formatDuration(trimEnd - trimStart)}</span>
                                            <span>End: ${formatDuration(trimEnd)}</span>
                                        </div>

                                        <!-- Action Buttons -->
                                        <div style="display: flex; gap: 0.5rem;">
                                            <button onclick="stockBrowserState.selectedVideo = null; renderStockBrowserModal();"
                                                    style="flex: 1; padding: 0.6rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; color: white; cursor: pointer;">
                                                ‚Üê Back
                                            </button>
                                            <button onclick="selectStockVideoWithTrim()"
                                                    style="flex: 2; padding: 0.6rem; background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 0.5rem; color: white; font-weight: 600; cursor: pointer;">
                                                ‚úì Use This Clip
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <!-- Results Grid -->
                            <div style="flex: 1; overflow-y: auto; padding: 1rem;">
                                ${stockBrowserState.loading ? `
                                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem;">
                                        <div style="width: 40px; height: 40px; border: 3px solid rgba(139, 92, 246, 0.2); border-top-color: #8b5cf6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                        <p style="color: rgba(255,255,255,0.6); margin-top: 1rem;">Searching ${isVideoTab ? 'videos' : 'images'}...</p>
                                    </div>
                                ` : stockBrowserState.results.length === 0 ? `
                                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem; text-align: center;">
                                        <div style="font-size: 3rem; margin-bottom: 1rem;">${isVideoTab ? 'üé¨' : 'üîç'}</div>
                                        <p style="color: rgba(255,255,255,0.6);">Search for stock ${isVideoTab ? 'videos' : 'images'} above</p>
                                        <p style="color: rgba(255,255,255,0.4); font-size: 0.85rem;">Try keywords like "nature", "business", or "technology"</p>
                                    </div>
                                ` : `
                                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(${isVideoTab ? '200px' : '180px'}, 1fr)); gap: 0.75rem;">
                                        ${stockBrowserState.results.map(media => isVideoTab ? `
                                            <!-- Video Card -->
                                            <div onclick="previewStockVideo(${JSON.stringify(media).replace(/"/g, '&quot;')})"
                                                 style="position: relative; aspect-ratio: 16/9; border-radius: 0.5rem; overflow: hidden; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;"
                                                 onmouseover="this.style.borderColor='#10b981'; this.style.transform='scale(1.02)'"
                                                 onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)'">
                                                <img src="${media.thumbnail || media.preview}"
                                                     alt=""
                                                     style="width: 100%; height: 100%; object-fit: cover;">
                                                <!-- Play icon overlay -->
                                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40px; height: 40px; background: rgba(0,0,0,0.7); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                                    <div style="width: 0; height: 0; border-left: 12px solid white; border-top: 8px solid transparent; border-bottom: 8px solid transparent; margin-left: 3px;"></div>
                                                </div>
                                                <!-- Duration badge -->
                                                <div style="position: absolute; bottom: 0.5rem; right: 0.5rem; background: rgba(0,0,0,0.8); color: white; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-size: 0.7rem;">
                                                    ${formatDuration(media.duration || 30)}
                                                </div>
                                                <!-- Source badge -->
                                                <div style="position: absolute; bottom: 0.5rem; left: 0.5rem; background: rgba(0,0,0,0.8); color: rgba(255,255,255,0.8); padding: 0.15rem 0.35rem; border-radius: 0.25rem; font-size: 0.6rem;">
                                                    ${media.source === 'pexels' ? 'üì∑ Pexels' : 'üñºÔ∏è Pixabay'}
                                                </div>
                                            </div>
                                        ` : `
                                            <!-- Image Card -->
                                            <div onclick="selectStockMedia(${JSON.stringify(media).replace(/"/g, '&quot;')})"
                                                 style="position: relative; aspect-ratio: ${state.platform.aspectRatio === '9:16' ? '9/16' : '16/9'}; border-radius: 0.5rem; overflow: hidden; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;"
                                                 onmouseover="this.style.borderColor='#8b5cf6'; this.style.transform='scale(1.02)'"
                                                 onmouseout="this.style.borderColor='transparent'; this.style.transform='scale(1)'">
                                                <img src="${media.thumbnail || media.preview}"
                                                     alt=""
                                                     style="width: 100%; height: 100%; object-fit: cover;">
                                                <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: 0.5rem; background: linear-gradient(transparent, rgba(0,0,0,0.8));">
                                                    <div style="font-size: 0.65rem; color: rgba(255,255,255,0.8);">
                                                        ${media.source === 'pexels' ? 'üì∑ Pexels' : 'üñºÔ∏è Pixabay'}
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    ${stockBrowserState.total > 20 ? `
                                        <div style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 1rem;">
                                            ${stockBrowserState.page > 1 ? `
                                                <button onclick="searchStockMedia(stockBrowserState.query, ${stockBrowserState.page - 1})"
                                                        style="padding: 0.5rem 1rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; color: white; cursor: pointer;">
                                                    ‚Üê Previous
                                                </button>
                                            ` : ''}
                                            <span style="padding: 0.5rem 1rem; color: rgba(255,255,255,0.6);">
                                                Page ${stockBrowserState.page}
                                            </span>
                                            <button onclick="searchStockMedia(stockBrowserState.query, ${stockBrowserState.page + 1})"
                                                    style="padding: 0.5rem 1rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; color: white; cursor: pointer;">
                                                Next ‚Üí
                                            </button>
                                        </div>
                                    ` : ''}
                                `}
                            </div>
                        `}

                        <!-- Footer -->
                        <div style="padding: 0.75rem 1.25rem; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                            <div style="color: rgba(255,255,255,0.5); font-size: 0.75rem;">
                                ${stockBrowserState.total > 0 ? `${stockBrowserState.total.toLocaleString()} ${isVideoTab ? 'videos' : 'images'} found` : ''}
                            </div>
                            <div style="color: rgba(255,255,255,0.5); font-size: 0.7rem;">
                                üí° Stock media is free and doesn't use tokens
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Setup trim handle dragging for videos
            if (isVideoTab && hasVideoSelected) {
                setupTrimHandles();
            }

            // Focus search input
            setTimeout(() => {
                const input = document.getElementById('stock-search-input');
                if (input && !hasVideoSelected) input.focus();
            }, 100);
        }

        // Setup drag handlers for video trim timeline
        function setupTrimHandles() {
            const timeline = document.getElementById('video-trim-timeline');
            if (!timeline) return;

            let isDragging = null;

            timeline.addEventListener('mousedown', (e) => {
                const handle = e.target.closest('.trim-handle');
                if (handle) {
                    isDragging = handle.dataset.handle;
                    e.preventDefault();
                }
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;

                const timeline = document.getElementById('video-trim-timeline');
                if (!timeline) return;

                const rect = timeline.getBoundingClientRect();
                const percent = Math.max(0, Math.min(100, ((e.clientX - rect.left) / rect.width) * 100));

                updateStockVideoTrim(isDragging, percent);
            });

            document.addEventListener('mouseup', () => {
                isDragging = null;
            });
        }

        // ==========================================
        // 6.8.6 EDIT WITH AI MODAL
        // ==========================================

        // Open the AI edit modal for a scene image
        function openEditModal(sceneId) {
            const storyboardScene = state.storyboard.scenes.find(s => s.sceneId === sceneId);
            if (!storyboardScene || !storyboardScene.imageUrl) {
                showToast('No image to edit', 'warning');
                return;
            }

            state.storyboard.editingScene = sceneId;
            state.storyboard.editPrompt = '';
            state.storyboard.editLoading = false;
            state.storyboard.editHistory = [];
            state.storyboard.editMaskCanvas = null;
            state.storyboard.editMaskCtx = null;

            renderEditModal();
        }

        // Close the edit modal
        function closeEditModal() {
            state.storyboard.editingScene = null;
            state.storyboard.editPrompt = '';
            state.storyboard.editLoading = false;
            const modal = document.getElementById('edit-ai-modal');
            if (modal) modal.remove();
        }

        // Initialize the canvas for mask painting
        function initEditCanvas() {
            const sceneId = state.storyboard.editingScene;
            const storyboardScene = state.storyboard.scenes.find(s => s.sceneId === sceneId);
            if (!storyboardScene || !storyboardScene.imageUrl) return;

            const canvas = document.getElementById('edit-canvas');
            if (!canvas) {
                setTimeout(initEditCanvas, 100);
                return;
            }

            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.crossOrigin = 'anonymous';

            img.onload = function() {
                // Set canvas size - maintain aspect ratio, max width 600px
                const maxWidth = 600;
                const scale = Math.min(1, maxWidth / img.width);
                canvas.width = Math.floor(img.width * scale);
                canvas.height = Math.floor(img.height * scale);

                // Store original dimensions
                canvas.dataset.originalWidth = img.width;
                canvas.dataset.originalHeight = img.height;

                // Draw the image
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                // Store original image data
                state.storyboard.editOriginalData = ctx.getImageData(0, 0, canvas.width, canvas.height);

                // Create mask canvas
                const maskCanvas = document.createElement('canvas');
                maskCanvas.width = canvas.width;
                maskCanvas.height = canvas.height;
                state.storyboard.editMaskCanvas = maskCanvas;
                state.storyboard.editMaskCtx = maskCanvas.getContext('2d');

                // Fill with black (unmasked)
                state.storyboard.editMaskCtx.fillStyle = 'black';
                state.storyboard.editMaskCtx.fillRect(0, 0, maskCanvas.width, maskCanvas.height);

                canvas.style.cursor = 'crosshair';
                setupEditCanvasEvents(canvas);
            };

            img.onerror = function() {
                console.error('Failed to load image for editing');
                showToast('Failed to load image', 'error');
            };

            img.src = storyboardScene.imageUrl;
        }

        // Setup mouse/touch events for canvas painting
        function setupEditCanvasEvents(canvas) {
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;

            const getCoords = (e) => {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return {
                    x: (clientX - rect.left) * scaleX,
                    y: (clientY - rect.top) * scaleY
                };
            };

            const startDraw = (e) => {
                isDrawing = true;
                const coords = getCoords(e);
                lastX = coords.x;
                lastY = coords.y;
                paintEditMask(lastX, lastY);
            };

            const draw = (e) => {
                if (!isDrawing) return;
                const coords = getCoords(e);
                paintEditMaskLine(lastX, lastY, coords.x, coords.y);
                lastX = coords.x;
                lastY = coords.y;
            };

            const endDraw = () => {
                isDrawing = false;
            };

            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', endDraw);
            canvas.addEventListener('mouseleave', endDraw);

            canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDraw(e); });
            canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); });
            canvas.addEventListener('touchend', endDraw);
        }

        // Paint a single point on the mask
        function paintEditMask(x, y) {
            if (!state.storyboard.editMaskCtx) return;

            const brushSize = state.storyboard.editBrushSize || 30;
            state.storyboard.editMaskCtx.fillStyle = 'white';
            state.storyboard.editMaskCtx.beginPath();
            state.storyboard.editMaskCtx.arc(x, y, brushSize / 2, 0, Math.PI * 2);
            state.storyboard.editMaskCtx.fill();

            redrawEditCanvas();
        }

        // Paint a line on the mask
        function paintEditMaskLine(x1, y1, x2, y2) {
            if (!state.storyboard.editMaskCtx) return;

            const brushSize = state.storyboard.editBrushSize || 30;
            state.storyboard.editMaskCtx.strokeStyle = 'white';
            state.storyboard.editMaskCtx.lineWidth = brushSize;
            state.storyboard.editMaskCtx.lineCap = 'round';
            state.storyboard.editMaskCtx.lineJoin = 'round';
            state.storyboard.editMaskCtx.beginPath();
            state.storyboard.editMaskCtx.moveTo(x1, y1);
            state.storyboard.editMaskCtx.lineTo(x2, y2);
            state.storyboard.editMaskCtx.stroke();

            redrawEditCanvas();
        }

        // Redraw the canvas with mask overlay
        function redrawEditCanvas() {
            const canvas = document.getElementById('edit-canvas');
            if (!canvas || !state.storyboard.editOriginalData) return;

            const ctx = canvas.getContext('2d');

            // Draw original image
            const imgCanvas = document.createElement('canvas');
            imgCanvas.width = canvas.width;
            imgCanvas.height = canvas.height;
            imgCanvas.getContext('2d').putImageData(state.storyboard.editOriginalData, 0, 0);

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(imgCanvas, 0, 0);

            // Draw pink overlay where mask is white
            if (state.storyboard.editMaskCanvas) {
                const maskCtx = state.storyboard.editMaskCtx;
                const maskData = maskCtx.getImageData(0, 0, state.storyboard.editMaskCanvas.width, state.storyboard.editMaskCanvas.height);

                const overlayCanvas = document.createElement('canvas');
                overlayCanvas.width = canvas.width;
                overlayCanvas.height = canvas.height;
                const overlayCtx = overlayCanvas.getContext('2d');
                overlayCtx.drawImage(state.storyboard.editMaskCanvas, 0, 0);

                const overlayData = overlayCtx.getImageData(0, 0, overlayCanvas.width, overlayCanvas.height);
                for (let i = 0; i < overlayData.data.length; i += 4) {
                    if (overlayData.data[i] > 128) {
                        overlayData.data[i] = 236;     // R - pink
                        overlayData.data[i + 1] = 72;  // G
                        overlayData.data[i + 2] = 153; // B
                        overlayData.data[i + 3] = 150; // A - semi-transparent
                    } else {
                        overlayData.data[i + 3] = 0;   // Transparent
                    }
                }
                overlayCtx.putImageData(overlayData, 0, 0);
                ctx.drawImage(overlayCanvas, 0, 0);
            }
        }

        // Get mask as base64 PNG
        function getEditMaskBase64() {
            if (!state.storyboard.editMaskCanvas) return null;

            const canvas = document.getElementById('edit-canvas');
            const originalWidth = parseInt(canvas.dataset.originalWidth) || 1280;
            const originalHeight = parseInt(canvas.dataset.originalHeight) || 720;

            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = originalWidth;
            exportCanvas.height = originalHeight;
            const ctx = exportCanvas.getContext('2d');

            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
            ctx.drawImage(state.storyboard.editMaskCanvas, 0, 0, exportCanvas.width, exportCanvas.height);

            // Check if mask has any white pixels
            const imageData = ctx.getImageData(0, 0, exportCanvas.width, exportCanvas.height);
            let hasWhite = false;
            for (let i = 0; i < imageData.data.length; i += 4) {
                if (imageData.data[i] > 200) {
                    hasWhite = true;
                    break;
                }
            }

            if (!hasWhite) return null;
            return exportCanvas.toDataURL('image/png').split(',')[1];
        }

        // Set brush size
        function setEditBrushSize(size) {
            state.storyboard.editBrushSize = parseInt(size) || 30;
        }

        // Clear the mask
        function clearEditMask() {
            if (!state.storyboard.editMaskCtx) return;

            state.storyboard.editMaskCtx.fillStyle = 'black';
            state.storyboard.editMaskCtx.fillRect(0, 0, state.storyboard.editMaskCanvas.width, state.storyboard.editMaskCanvas.height);
            redrawEditCanvas();
        }

        // Set edit prompt
        function setEditPrompt(value) {
            state.storyboard.editPrompt = value;
        }

        // Apply the AI edit
        async function applyAIEdit() {
            const sceneId = state.storyboard.editingScene;
            const storyboardScene = state.storyboard.scenes.find(s => s.sceneId === sceneId);
            if (!storyboardScene || !storyboardScene.imageUrl) return;

            const maskBase64 = getEditMaskBase64();
            let editPrompt = state.storyboard.editPrompt.trim();

            if (!editPrompt && !maskBase64) {
                showToast('Please enter what you want to change, or paint an area', 'warning');
                return;
            }

            if (!editPrompt && maskBase64) {
                editPrompt = 'Remove the marked area seamlessly';
            }

            state.storyboard.editLoading = true;
            renderEditModal();

            try {
                const editFn = firebase.functions().httpsCallable('editThumbnailWithAI');
                const requestData = {
                    imageUrl: storyboardScene.imageUrl,
                    editPrompt: editPrompt
                };

                if (maskBase64) {
                    requestData.maskBase64 = maskBase64;
                }

                const result = await editFn(requestData);

                if (result.data.success && result.data.editedUrl) {
                    // Update scene with edited image
                    storyboardScene.imageUrl = result.data.editedUrl;
                    storyboardScene.editHistory = storyboardScene.editHistory || [];
                    storyboardScene.editHistory.push({
                        prompt: editPrompt,
                        timestamp: Date.now()
                    });

                    closeEditModal();
                    showToast('Image edited successfully!', 'success');
                    scheduleAutoSave();
                    render();
                } else {
                    throw new Error(result.data.message || 'Edit failed');
                }
            } catch (error) {
                console.error('AI edit error:', error);
                state.storyboard.editLoading = false;
                showToast(`Edit failed: ${error.message}`, 'error');
                renderEditModal();
            }
        }

        // Render the Edit with AI modal
        function renderEditModal() {
            const existing = document.getElementById('edit-ai-modal');
            if (existing) existing.remove();

            if (!state.storyboard.editingScene) return;

            const sceneId = state.storyboard.editingScene;
            const storyboardScene = state.storyboard.scenes.find(s => s.sceneId === sceneId);
            const scene = state.script.scenes.find(s => s.id === sceneId);
            const sceneIndex = state.script.scenes.findIndex(s => s.id === sceneId);

            if (!storyboardScene || !storyboardScene.imageUrl) return;

            const modal = document.createElement('div');
            modal.id = 'edit-ai-modal';
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 1002; padding: 1rem;" onclick="if(event.target === this) closeEditModal()">
                    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 1rem; width: 100%; max-width: 700px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
                        <!-- Header -->
                        <div style="padding: 1rem 1.25rem; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin: 0; color: white; font-size: 1.1rem; font-weight: 600;">‚ú® Edit Scene ${sceneIndex + 1} with AI</h3>
                                <p style="margin: 0.25rem 0 0 0; color: rgba(255,255,255,0.6); font-size: 0.8rem;">Paint to select areas, describe your edit</p>
                            </div>
                            <button onclick="closeEditModal()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0.25rem;">√ó</button>
                        </div>

                        <!-- Canvas Area -->
                        <div style="flex: 1; overflow-y: auto; padding: 1rem;">
                            ${state.storyboard.editLoading ? `
                                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem;">
                                    <div style="width: 50px; height: 50px; border: 3px solid rgba(236, 72, 153, 0.2); border-top-color: #ec4899; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                    <p style="color: rgba(255,255,255,0.8); margin-top: 1rem; font-weight: 500;">AI is editing your image...</p>
                                    <p style="color: rgba(255,255,255,0.5); font-size: 0.8rem; margin-top: 0.5rem;">This may take 10-30 seconds</p>
                                </div>
                            ` : `
                                <!-- Canvas -->
                                <div style="display: flex; justify-content: center; margin-bottom: 1rem;">
                                    <canvas id="edit-canvas" style="max-width: 100%; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.3);"></canvas>
                                </div>

                                <!-- Brush Controls -->
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 0.5rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="color: rgba(255,255,255,0.7); font-size: 0.8rem;">üñåÔ∏è Brush:</span>
                                        <input type="range" min="10" max="100" value="${state.storyboard.editBrushSize || 30}"
                                               oninput="setEditBrushSize(this.value); document.getElementById('brush-size-display').textContent = this.value + 'px'"
                                               style="width: 100px; accent-color: #ec4899;">
                                        <span id="brush-size-display" style="color: white; font-size: 0.75rem; width: 40px;">${state.storyboard.editBrushSize || 30}px</span>
                                    </div>
                                    <button onclick="clearEditMask()" style="padding: 0.4rem 0.75rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.4rem; color: white; font-size: 0.75rem; cursor: pointer;">
                                        üóëÔ∏è Clear
                                    </button>
                                </div>

                                <p style="color: rgba(255,255,255,0.5); font-size: 0.75rem; text-align: center; margin-bottom: 1rem;">
                                    üí° <strong>Optional:</strong> Paint to select specific areas, or skip to edit the entire image
                                </p>

                                <!-- Prompt Input -->
                                <div style="margin-bottom: 1rem;">
                                    <label style="color: rgba(255,255,255,0.7); font-size: 0.85rem; display: block; margin-bottom: 0.5rem;">What do you want to change?</label>
                                    <input type="text" id="edit-prompt-input" value="${state.storyboard.editPrompt || ''}"
                                           placeholder="e.g., Make the sky more dramatic, remove the person, add lens flare..."
                                           oninput="setEditPrompt(this.value)"
                                           style="width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; font-size: 0.9rem;">
                                </div>

                                <!-- Quick Suggestions -->
                                <div style="display: flex; flex-wrap: wrap; gap: 0.4rem; margin-bottom: 1rem;">
                                    ${['Remove marked area', 'Make it brighter', 'Add dramatic lighting', 'Make colors more vibrant', 'Add film grain effect'].map(suggestion => `
                                        <button onclick="setEditPrompt('${suggestion}'); document.getElementById('edit-prompt-input').value = '${suggestion}';"
                                                style="padding: 0.35rem 0.6rem; background: rgba(236, 72, 153, 0.1); border: 1px solid rgba(236, 72, 153, 0.3); border-radius: 1rem; color: #f9a8d4; font-size: 0.7rem; cursor: pointer; transition: all 0.2s;"
                                                onmouseover="this.style.background='rgba(236, 72, 153, 0.2)'"
                                                onmouseout="this.style.background='rgba(236, 72, 153, 0.1)'">
                                            ${suggestion}
                                        </button>
                                    `).join('')}
                                </div>
                            `}
                        </div>

                        <!-- Footer -->
                        <div style="padding: 1rem 1.25rem; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                            <button onclick="closeEditModal()"
                                    style="padding: 0.6rem 1rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 0.5rem; color: white; font-size: 0.85rem; cursor: pointer;">
                                Cancel
                            </button>
                            <button onclick="applyAIEdit()" ${state.storyboard.editLoading ? 'disabled' : ''}
                                    style="padding: 0.6rem 1.5rem; background: linear-gradient(135deg, #ec4899, #8b5cf6); border: none; border-radius: 0.5rem; color: white; font-weight: 600; font-size: 0.85rem; cursor: pointer; opacity: ${state.storyboard.editLoading ? '0.5' : '1'};">
                                ${state.storyboard.editLoading ? 'Editing...' : '‚ú® Apply Edit (2 tokens)'}
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Initialize canvas after render
            if (!state.storyboard.editLoading) {
                setTimeout(initEditCanvas, 100);
            }
        }

        // ==========================================
        // 6.9 COST ESTIMATION
        // ==========================================
        function estimateCost() {
            const duration = state.platform.targetDuration || 60;
            const sceneDuration = 10; // Average scene duration
            const sceneCount = Math.ceil(duration / sceneDuration);

            // Base costs (in tokens)
            const costs = {
                scriptGeneration: 5,
                imagesPerScene: 2, // HD quality
                voiceoverPer30s: 1,
                animationPerScene: 3, // Runpod Multi-talk
                export: 3
            };

            const totalImages = sceneCount * costs.imagesPerScene;
            const voiceoverUnits = Math.ceil(duration / 30);
            const animationCost = sceneCount * costs.animationPerScene;

            const total = costs.scriptGeneration +
                         totalImages +
                         (voiceoverUnits * costs.voiceoverPer30s) +
                         animationCost +
                         costs.export;

            return {
                total,
                breakdown: {
                    script: costs.scriptGeneration,
                    images: totalImages,
                    voiceover: voiceoverUnits * costs.voiceoverPer30s,
                    animation: animationCost,
                    export: costs.export
                },
                sceneCount
            };
        }

        // ==========================================
        // 6.7 UTILITY FUNCTIONS
        // ==========================================
        function formatDuration(seconds) {
            if (seconds < 60) {
                return `${seconds}s`;
            }
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return secs > 0 ? `${minutes}m ${secs}s` : `${minutes}m`;
        }

        function showToast(message, type = 'info') {
            // Simple toast implementation
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg text-white text-sm font-medium z-50 fade-in`;
            toast.style.background = type === 'warning' ? '#f59e0b' :
                                    type === 'error' ? '#ef4444' :
                                    type === 'success' ? '#10b981' : '#8b5cf6';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ==========================================
        // 6.8 PROJECTS MODAL
        // ==========================================
        let projectsModalOpen = false;

        async function openProjectsModal() {
            projectsModalOpen = true;
            renderProjectsModal();

            // Load projects list
            const projects = await loadProjectsList();
            renderProjectsModal(projects);
        }

        function closeProjectsModal() {
            projectsModalOpen = false;
            const modal = document.getElementById('projects-modal');
            if (modal) modal.remove();
        }

        function renderProjectsModal(projects = null) {
            // Remove existing modal if any
            const existing = document.getElementById('projects-modal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'projects-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                padding: 1rem;
            `;

            let content = `
                <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 1rem; width: 100%; max-width: 600px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
                    <div style="padding: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="color: white; font-size: 1.25rem; font-weight: 700;">My Video Projects</h2>
                        <button onclick="closeProjectsModal()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0.25rem;">√ó</button>
                    </div>
                    <div style="padding: 1rem; overflow-y: auto; flex: 1;">
            `;

            if (projects === null) {
                // Loading state
                content += `
                    <div style="text-align: center; padding: 3rem; color: rgba(255,255,255,0.6);">
                        <div class="animate-spin" style="width: 2rem; height: 2rem; border: 3px solid rgba(139,92,246,0.3); border-top-color: #8b5cf6; border-radius: 50%; margin: 0 auto 1rem;"></div>
                        Loading projects...
                    </div>
                `;
            } else if (projects.length === 0) {
                // Empty state
                content += `
                    <div style="text-align: center; padding: 3rem; color: rgba(255,255,255,0.6);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìÇ</div>
                        <p>No projects yet</p>
                        <p style="font-size: 0.85rem; margin-top: 0.5rem;">Create your first video to see it here!</p>
                    </div>
                `;
            } else {
                // Projects list
                projects.forEach(project => {
                    const isCurrent = state.project.id === project.id;
                    const nicheIcon = project.niche ? VIDEO_NICHES[project.niche]?.icon || 'üìπ' : 'üìπ';
                    const updatedDate = project.updatedAt ? new Date(project.updatedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'Unknown';

                    content += `
                        <div style="background: ${isCurrent ? 'rgba(139,92,246,0.2)' : 'rgba(255,255,255,0.05)'}; border: 1px solid ${isCurrent ? 'rgba(139,92,246,0.4)' : 'rgba(255,255,255,0.1)'}; border-radius: 0.75rem; padding: 1rem; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 1.5rem;">${nicheIcon}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="color: white; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${project.name || 'Untitled'}</div>
                                <div style="color: rgba(255,255,255,0.5); font-size: 0.8rem;">${project.platform || 'No platform'} ‚Ä¢ ${project.sceneCount} scenes ‚Ä¢ ${updatedDate}</div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                ${isCurrent ? '<span style="color: #8b5cf6; font-size: 0.75rem; font-weight: 600;">CURRENT</span>' : `
                                    <button onclick="loadProjectFromModal('${project.id}')" style="background: rgba(139,92,246,0.2); border: 1px solid rgba(139,92,246,0.4); border-radius: 0.5rem; padding: 0.4rem 0.75rem; color: white; cursor: pointer; font-size: 0.75rem;">Open</button>
                                `}
                                <button onclick="deleteProjectFromModal('${project.id}')" style="background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.4); border-radius: 0.5rem; padding: 0.4rem 0.5rem; color: #ef4444; cursor: pointer; font-size: 0.75rem;">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                });
            }

            content += `
                    </div>
                    <div style="padding: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                        <button onclick="startNewProject()" style="width: 100%; background: linear-gradient(135deg, #8b5cf6, #06b6d4); border: none; border-radius: 0.5rem; padding: 0.75rem; color: white; font-weight: 600; cursor: pointer;">
                            + New Project
                        </button>
                    </div>
                </div>
            `;

            modal.innerHTML = content;
            modal.onclick = (e) => {
                if (e.target === modal) closeProjectsModal();
            };

            document.body.appendChild(modal);
        }

        function loadProjectFromModal(projectId) {
            closeProjectsModal();
            window.location.href = `/video-creation-wizard?project=${projectId}`;
        }

        async function deleteProjectFromModal(projectId) {
            if (!confirm('Are you sure you want to delete this project?')) return;

            try {
                const deleteProjectFn = functions.httpsCallable('creationWizardDeleteProject');
                await deleteProjectFn({ projectId });

                // Reload projects list
                const projects = await loadProjectsList();
                renderProjectsModal(projects);

                // If we deleted the current project, reset state
                if (state.project.id === projectId) {
                    state.project.id = null;
                    state.project.name = null;
                    render();
                }

                showToast('Project deleted', 'success');
            } catch (error) {
                console.error('Delete error:', error);
                showToast('Failed to delete project', 'error');
            }
        }

        function startNewProject() {
            closeProjectsModal();
            window.location.href = '/video-creation-wizard';
        }
    </script>

    <!-- ============================================
         SECTION 7: RENDER FUNCTIONS
         ============================================ -->
    <script>
        // ==========================================
        // 7.1 MAIN RENDER FUNCTION
        // ==========================================
        function render() {
            const app = document.getElementById('app-root');

            let html = '';

            // Header bar
            html += renderHeaderBar();

            // Main container
            html += '<div class="wizard-container">';

            // Wizard header
            html += renderWizardHeader();

            // Stepper
            html += renderStepper();

            // Step content
            switch (state.currentStep) {
                case 1:
                    html += renderStep1Platform();
                    break;
                case 2:
                    html += renderStep2NicheStyle();
                    break;
                case 3:
                    html += renderStep3Script();
                    break;
                case 4:
                    html += renderStep4Storyboard();
                    break;
                case 5:
                    html += renderStep5Animation();
                    break;
                case 6:
                    html += renderStep6Assembly();
                    break;
                case 7:
                    html += renderStep7Export();
                    break;
            }

            html += '</div>'; // End wizard-container

            app.innerHTML = html;
            attachEventListeners();
        }

        // ==========================================
        // 7.2 HEADER BAR
        // ==========================================
        function renderHeaderBar() {
            const projectName = state.project.name || 'New Project';
            const isSaved = state.project.id !== null;

            return `
                <div class="header-bar">
                    <div class="header-left">
                        <a href="/video-optimizer" class="back-link">
                            <span>‚Üê</span>
                            <span>Dashboard</span>
                        </a>
                        <div class="project-info" style="margin-left: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">${projectName}</span>
                            ${isSaved ? '<span style="color: #10b981; font-size: 0.7rem;">Saved</span>' : '<span style="color: #f59e0b; font-size: 0.7rem;">Unsaved</span>'}
                        </div>
                    </div>
                    <div class="header-right" style="display: flex; align-items: center; gap: 1rem;">
                        <button onclick="openProjectsModal()" class="header-btn" style="background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 0.5rem; padding: 0.4rem 0.75rem; color: white; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 0.3rem;">
                            <span>üìÅ</span>
                            <span>Projects</span>
                        </button>
                        <button onclick="saveProject(false)" class="header-btn" style="background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.4); border-radius: 0.5rem; padding: 0.4rem 0.75rem; color: white; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 0.3rem;">
                            <span>üíæ</span>
                            <span>Save</span>
                        </button>
                        <div class="token-display">
                            <span class="token-icon">ü™ô</span>
                            <span class="token-count">${state.tokens.balance}</span>
                            <span style="color: rgba(255,255,255,0.5)">tokens</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==========================================
        // 7.3 WIZARD HEADER
        // ==========================================
        function renderWizardHeader() {
            return `
                <div class="wizard-header">
                    <h1 class="wizard-title">Video Creation Wizard</h1>
                    <p class="wizard-subtitle">Create professional AI-generated videos from scratch</p>
                </div>
            `;
        }

        // ==========================================
        // 7.4 STEPPER
        // ==========================================
        function renderStepper() {
            let html = '<div class="wizard-stepper">';

            WIZARD_STEPS.forEach((step, index) => {
                const isActive = state.currentStep === step.num;
                const isCompleted = state.currentStep > step.num;
                const isReachable = step.num <= state.maxReachedStep + 1;

                html += `
                    <div class="wizard-step ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}"
                         onclick="${isReachable ? `goToStep(${step.num})` : ''}"
                         style="${!isReachable ? 'opacity: 0.4; cursor: not-allowed;' : ''}">
                        <div class="step-number">
                            ${isCompleted ? '‚úì' : step.num}
                        </div>
                        <span class="step-label">${step.label}</span>
                    </div>
                `;

                // Add connector between steps
                if (index < WIZARD_STEPS.length - 1) {
                    html += `<div class="step-connector ${isCompleted ? 'completed' : ''}"></div>`;
                }
            });

            html += '</div>';
            return html;
        }

        // ==========================================
        // 7.5 STEP 1: PLATFORM & FORMAT
        // ==========================================
        function renderStep1Platform() {
            const selectedPlatform = state.platform.selected;
            const preset = state.platform.preset;

            let html = '<div class="fade-in">';

            // Platform Selection Card
            html += `
                <div class="content-card">
                    <div class="content-card-header">
                        <div class="content-card-icon">üì±</div>
                        <div>
                            <div class="content-card-title">Choose Platform</div>
                            <div class="content-card-subtitle">Where will your video be published?</div>
                        </div>
                    </div>

                    <div class="platform-grid">
            `;

            Object.values(PLATFORM_PRESETS).forEach(platform => {
                const isSelected = selectedPlatform === platform.id;
                html += `
                    <div class="platform-card ${isSelected ? 'selected' : ''}"
                         onclick="selectPlatform('${platform.id}')">
                        <div class="platform-card-icon">${platform.icon}</div>
                        <div class="platform-card-name">${platform.name}</div>
                        <div class="platform-card-info">${platform.description}</div>
                    </div>
                `;
            });

            html += '</div></div>';

            // Format Selection (only show if platform selected)
            if (preset) {
                html += `
                    <div class="content-card">
                        <div class="content-card-header">
                            <div class="content-card-icon">üìê</div>
                            <div>
                                <div class="content-card-title">Select Format</div>
                                <div class="content-card-subtitle">Choose aspect ratio for your video</div>
                            </div>
                        </div>

                        <div class="format-selector">
                `;

                const allFormats = ['16:9', '9:16', '1:1', '4:5'];
                allFormats.forEach(format => {
                    const isAvailable = preset.formats.includes(format);
                    const isSelected = state.platform.aspectRatio === format;
                    const info = FORMAT_INFO[format];

                    html += `
                        <div class="format-option ${isSelected ? 'selected' : ''} ${!isAvailable ? 'disabled' : ''}"
                             onclick="${isAvailable ? `selectFormat('${format}')` : ''}">
                            <div class="format-preview">
                                <div class="format-preview-box ${info.className}"></div>
                            </div>
                            <div class="format-label">${info.ratio}</div>
                            <div class="format-desc">${info.desc}</div>
                        </div>
                    `;
                });

                html += '</div>';

                // Duration Slider
                html += `
                    <div class="duration-container">
                        <div class="duration-header">
                            <span class="duration-label">Video Duration</span>
                            <span class="duration-value">${formatDuration(state.platform.targetDuration)}</span>
                        </div>
                        <input type="range"
                               class="duration-slider"
                               id="duration-slider"
                               min="${preset.minDuration}"
                               max="${preset.maxDuration}"
                               value="${state.platform.targetDuration}"
                               oninput="setDuration(this.value)">
                        <div class="duration-presets">
                            <span class="duration-preset" onclick="setDuration(${preset.minDuration})">${formatDuration(preset.minDuration)}</span>
                            <span class="duration-preset" onclick="setDuration(${Math.floor((preset.minDuration + preset.maxDuration) / 2)})">${formatDuration(Math.floor((preset.minDuration + preset.maxDuration) / 2))}</span>
                            <span class="duration-preset" onclick="setDuration(${preset.maxDuration})">${formatDuration(preset.maxDuration)}</span>
                        </div>
                    </div>
                `;

                // Cost Estimate
                const cost = estimateCost();
                html += `
                    <div class="cost-estimate">
                        <div class="cost-estimate-header">
                            <span class="cost-estimate-title">Estimated Cost</span>
                            <span class="cost-estimate-value">~${cost.total} tokens</span>
                        </div>
                        <div class="cost-estimate-breakdown">
                            ${cost.sceneCount} scenes ‚Ä¢ Script ${cost.breakdown.script} ‚Ä¢ Images ${cost.breakdown.images} ‚Ä¢ Voice ${cost.breakdown.voiceover} ‚Ä¢ Animation ${cost.breakdown.animation} ‚Ä¢ Export ${cost.breakdown.export}
                        </div>
                    </div>
                `;

                html += '</div>';
            }

            // Navigation
            html += renderNavButtons(null, isStepComplete(1) ? 2 : null);

            html += '</div>';
            return html;
        }

        // ==========================================
        // 7.6 STEP 2: NICHE & STYLE
        // ==========================================
        function renderStep2NicheStyle() {
            const selectedNiche = state.content.niche;
            const selectedSubniche = state.content.subniche;
            const selectedStyle = state.content.style;

            let html = '<div class="fade-in">';

            // Niche Selection Card
            html += `
                <div class="content-card">
                    <div class="content-card-header">
                        <div class="content-card-icon">üìÇ</div>
                        <div>
                            <div class="content-card-title">Select Your Niche</div>
                            <div class="content-card-subtitle">What category best describes your content?</div>
                        </div>
                    </div>

                    <div class="niche-grid">
            `;

            Object.values(VIDEO_NICHES).forEach(niche => {
                const isSelected = selectedNiche === niche.id;
                html += `
                    <div class="niche-card ${isSelected ? 'selected' : ''}"
                         onclick="selectNiche('${niche.id}')">
                        <div class="niche-icon">${niche.icon}</div>
                        <div class="niche-name">${niche.name}</div>
                    </div>
                `;
            });

            html += '</div>';

            // Sub-niche chips (if niche selected)
            if (selectedNiche && VIDEO_NICHES[selectedNiche]) {
                const niche = VIDEO_NICHES[selectedNiche];
                html += `
                    <div class="subniche-container">
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 0.75rem;">
                            Refine your focus (optional):
                        </div>
                        <div class="subniche-chips">
                `;

                niche.subniches.forEach(sub => {
                    const isSelected = selectedSubniche === sub.id;
                    html += `
                        <div class="subniche-chip ${isSelected ? 'selected' : ''}"
                             onclick="selectSubniche('${sub.id}')">
                            ${sub.name}
                        </div>
                    `;
                });

                html += '</div></div>';
            }

            html += '</div>';

            // Style Selection Card
            html += `
                <div class="content-card">
                    <div class="content-card-header">
                        <div class="content-card-icon">üé®</div>
                        <div>
                            <div class="content-card-title">Choose Visual Style</div>
                            <div class="content-card-subtitle">How should your video look and feel?</div>
                        </div>
                    </div>

                    <div class="style-grid">
            `;

            Object.values(VIDEO_STYLES).forEach(style => {
                const isSelected = selectedStyle === style.id;
                html += `
                    <div class="style-card ${isSelected ? 'selected' : ''}"
                         onclick="selectStyle('${style.id}')">
                        <div class="style-icon">${style.icon}</div>
                        <div class="style-name">${style.name}</div>
                        <div class="style-desc">${style.description}</div>
                    </div>
                `;
            });

            html += '</div></div>';

            // Pacing Control Card (NEW - Controls video timing)
            html += `
                <div class="content-card">
                    <div class="content-card-header">
                        <div class="content-card-icon">‚è±Ô∏è</div>
                        <div>
                            <div class="content-card-title">Video Pacing</div>
                            <div class="content-card-subtitle">How fast should your video flow?</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 0.5rem;">
                        <div onclick="setPacing('fast')"
                             style="padding: 1rem; border-radius: 0.75rem; border: 2px solid ${state.content.pacing === 'fast' ? '#8b5cf6' : 'rgba(255,255,255,0.15)'}; background: ${state.content.pacing === 'fast' ? 'rgba(139, 92, 246, 0.2)' : 'rgba(255,255,255,0.05)'}; cursor: pointer; text-align: center; transition: all 0.2s;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚ö°</div>
                            <div style="font-weight: 600; color: white; margin-bottom: 0.25rem;">Fast</div>
                            <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5);">Quick cuts, dense narration<br>~8s per scene</div>
                        </div>
                        <div onclick="setPacing('medium')"
                             style="padding: 1rem; border-radius: 0.75rem; border: 2px solid ${state.content.pacing === 'medium' ? '#8b5cf6' : 'rgba(255,255,255,0.15)'}; background: ${state.content.pacing === 'medium' ? 'rgba(139, 92, 246, 0.2)' : 'rgba(255,255,255,0.05)'}; cursor: pointer; text-align: center; transition: all 0.2s;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üéØ</div>
                            <div style="font-weight: 600; color: white; margin-bottom: 0.25rem;">Balanced</div>
                            <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5);">Natural flow<br>~12s per scene</div>
                        </div>
                        <div onclick="setPacing('slow')"
                             style="padding: 1rem; border-radius: 0.75rem; border: 2px solid ${state.content.pacing === 'slow' ? '#8b5cf6' : 'rgba(255,255,255,0.15)'}; background: ${state.content.pacing === 'slow' ? 'rgba(139, 92, 246, 0.2)' : 'rgba(255,255,255,0.05)'}; cursor: pointer; text-align: center; transition: all 0.2s;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üåä</div>
                            <div style="font-weight: 600; color: white; margin-bottom: 0.25rem;">Contemplative</div>
                            <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5);">Visual breathing room<br>~18s per scene</div>
                        </div>
                    </div>

                    <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(139, 92, 246, 0.1); border-radius: 0.5rem; border: 1px solid rgba(139, 92, 246, 0.2);">
                        <div style="font-size: 0.75rem; color: #a78bfa;">
                            üìä For your ${formatDuration(state.platform.targetDuration)} video:
                            <strong>${Math.round(state.platform.targetDuration / (state.content.pacing === 'fast' ? 8 : state.content.pacing === 'slow' ? 18 : 12))} scenes</strong>
                            with <strong>${state.content.pacing === 'fast' ? '85%' : state.content.pacing === 'slow' ? '50%' : '70%'}</strong> narration coverage
                        </div>
                    </div>
                </div>
            `;

            // Topic Input Card
            html += `
                <div class="content-card">
                    <div class="content-card-header">
                        <div class="content-card-icon">üí°</div>
                        <div>
                            <div class="content-card-title">Video Topic (Optional)</div>
                            <div class="content-card-subtitle">Describe what your video should be about</div>
                        </div>
                    </div>

                    <div class="topic-input-container">
                        <input type="text"
                               class="topic-input"
                               id="topic-input"
                               placeholder="e.g., 5 habits of successful entrepreneurs"
                               value="${state.content.topic}"
                               onchange="setTopic(this.value)">
            `;

            // Topic suggestions based on niche
            if (selectedNiche && TOPIC_SUGGESTIONS[selectedNiche]) {
                html += '<div class="topic-suggestions">';
                TOPIC_SUGGESTIONS[selectedNiche].forEach(suggestion => {
                    html += `
                        <div class="topic-suggestion" onclick="applyTopicSuggestion('${suggestion}')">
                            ${suggestion}
                        </div>
                    `;
                });
                html += '</div>';
            }

            html += '</div></div>';

            // Navigation
            html += renderNavButtons(1, isStepComplete(2) ? 3 : null);

            html += '</div>';
            return html;
        }

        // ==========================================
        // 7.7 STEP 3: SCRIPT GENERATION
        // ==========================================
        function renderStep3Script() {
            const hasScript = state.script.scenes && state.script.scenes.length > 0;
            const isGenerating = state.script.status === 'generating';

            let html = '<div class="fade-in">';

            // If no script yet, show generation form
            if (!hasScript && !isGenerating) {
                html += renderScriptGenerationForm();
            }
            // If generating, show progress
            else if (isGenerating) {
                html += renderScriptGeneratingState();
            }
            // If script exists, show editor
            else {
                html += renderScriptEditor();
            }

            // Navigation
            html += renderNavButtons(2, hasScript ? 4 : null);

            html += '</div>';
            return html;
        }

        function renderScriptGenerationForm() {
            const niche = VIDEO_NICHES[state.content.niche];
            const style = VIDEO_STYLES[state.content.style];

            return `
                <div class="content-card">
                    <div class="content-card-header">
                        <div class="content-card-icon">‚ú®</div>
                        <div>
                            <div class="content-card-title">Generate Your Script</div>
                            <div class="content-card-subtitle">AI will create a professional video script based on your settings</div>
                        </div>
                    </div>

                    <!-- Summary of selections -->
                    <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 0.75rem; padding: 1rem; margin-bottom: 1.5rem;">
                        <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem;">Your video configuration:</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            <span class="config-tag">${state.platform.selected || 'Platform'}</span>
                            <span class="config-tag">${state.platform.aspectRatio || '16:9'}</span>
                            <span class="config-tag">${formatDuration(state.platform.targetDuration)}</span>
                            <span class="config-tag">${niche?.icon || ''} ${niche?.name || 'Niche'}</span>
                            <span class="config-tag">${style?.icon || ''} ${style?.name || 'Style'}</span>
                        </div>
                    </div>

                    <!-- Topic (editable) -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-size: 0.9rem; font-weight: 600; color: white; margin-bottom: 0.5rem;">
                            Video Topic
                        </label>
                        <input type="text"
                               id="script-topic"
                               class="topic-input"
                               value="${state.content.topic || ''}"
                               placeholder="e.g., 5 Morning Habits That Changed My Life"
                               style="width: 100%;">
                    </div>

                    <!-- Tone selector -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-size: 0.9rem; font-weight: 600; color: white; margin-bottom: 0.5rem;">
                            Script Tone
                        </label>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem;">
                            ${['engaging', 'professional', 'casual', 'inspirational'].map(tone => `
                                <button onclick="setScriptTone('${tone}')"
                                        class="tone-btn ${state.content.tone === tone ? 'selected' : ''}"
                                        style="padding: 0.6rem; border-radius: 0.5rem; border: 1px solid ${state.content.tone === tone ? 'rgba(139, 92, 246, 0.6)' : 'rgba(255,255,255,0.2)'}; background: ${state.content.tone === tone ? 'rgba(139, 92, 246, 0.2)' : 'rgba(255,255,255,0.05)'}; color: white; cursor: pointer; font-size: 0.8rem; text-transform: capitalize;">
                                    ${tone}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Additional instructions -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-size: 0.9rem; font-weight: 600; color: white; margin-bottom: 0.5rem;">
                            Additional Instructions <span style="color: rgba(255,255,255,0.5); font-weight: 400;">(optional)</span>
                        </label>
                        <textarea id="script-instructions"
                                  placeholder="Any specific requirements? e.g., Include a personal story, mention specific products, focus on beginners..."
                                  style="width: 100%; min-height: 80px; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; font-size: 0.9rem; resize: vertical;"></textarea>
                    </div>

                    <!-- Generate button -->
                    <button onclick="generateScript()"
                            class="generate-btn"
                            style="width: 100%; padding: 1rem; border-radius: 0.75rem; border: none; background: linear-gradient(135deg, #8b5cf6, #06b6d4); color: white; font-size: 1rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                        <span>ü™Ñ</span>
                        <span>Generate Script with AI</span>
                    </button>

                    <div style="text-align: center; margin-top: 1rem; color: rgba(255,255,255,0.5); font-size: 0.8rem;">
                        Estimated cost: ~5 tokens ‚Ä¢ Powered by GPT-4o
                    </div>
                </div>
            `;
        }

        function renderScriptGeneratingState() {
            return `
                <div class="content-card" style="text-align: center; padding: 4rem 2rem;">
                    <div class="animate-float" style="font-size: 4rem; margin-bottom: 1.5rem;">‚ú®</div>
                    <div style="font-size: 1.25rem; font-weight: 700; color: white; margin-bottom: 0.5rem;">
                        Generating Your Script...
                    </div>
                    <div style="color: rgba(255,255,255,0.6); margin-bottom: 2rem;">
                        AI is crafting an engaging script for your video
                    </div>
                    <div class="loading-bar" style="width: 200px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin: 0 auto; overflow: hidden;">
                        <div style="width: 30%; height: 100%; background: linear-gradient(90deg, #8b5cf6, #06b6d4); border-radius: 2px; animation: shimmer 1.5s infinite;"></div>
                    </div>
                </div>
            `;
        }

        function renderScriptEditor() {
            const script = state.script;

            // Calculate timing breakdown
            const targetDuration = state.platform.targetDuration || 60;
            const totalVisualDuration = script.scenes.reduce((sum, s) => sum + (s.visualDuration || s.duration || 0), 0);
            const totalNarrationDuration = script.scenes.reduce((sum, s) => sum + (s.narrationDuration || Math.ceil((s.narration || '').split(/\s+/).length / 2.5) || 0), 0);
            const pacing = script.timing?.pacing || state.content.pacing || 'medium';

            let html = `
                <!-- Script Header -->
                <div class="content-card">
                    <div class="content-card-header">
                        <div class="content-card-icon">üìù</div>
                        <div style="flex: 1;">
                            <input type="text"
                                   id="script-title-input"
                                   value="${script.title || ''}"
                                   onchange="updateScriptTitle(this.value)"
                                   style="background: none; border: none; color: white; font-size: 1.1rem; font-weight: 700; width: 100%; outline: none;">
                            <div class="content-card-subtitle">${script.scenes.length} scenes ‚Ä¢ Target: ${formatDuration(targetDuration)}</div>
                        </div>
                        <button onclick="regenerateFullScript()"
                                style="background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 0.5rem; padding: 0.5rem 1rem; color: white; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 0.3rem;">
                            <span>üîÑ</span> Regenerate
                        </button>
                    </div>

                    <!-- Timing Breakdown Banner -->
                    <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 0.5rem; padding: 0.75rem 1rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                        <div style="display: flex; gap: 1.5rem; flex-wrap: wrap;">
                            <div style="text-align: center;">
                                <div style="font-size: 0.65rem; color: rgba(255,255,255,0.5); text-transform: uppercase;">Visual Time</div>
                                <div style="font-size: 1rem; font-weight: 700; color: #10b981;">${formatDuration(totalVisualDuration)}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.65rem; color: rgba(255,255,255,0.5); text-transform: uppercase;">Narration</div>
                                <div style="font-size: 1rem; font-weight: 700; color: #a78bfa;">${formatDuration(totalNarrationDuration)}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.65rem; color: rgba(255,255,255,0.5); text-transform: uppercase;">Per Scene</div>
                                <div style="font-size: 1rem; font-weight: 700; color: white;">~${Math.round(totalVisualDuration / script.scenes.length)}s</div>
                            </div>
                        </div>
                        <div style="font-size: 0.7rem; color: rgba(255,255,255,0.6); display: flex; align-items: center; gap: 0.3rem;">
                            <span>‚è±Ô∏è</span> ${pacing.charAt(0).toUpperCase() + pacing.slice(1)} pacing
                        </div>
                    </div>

                    <!-- Hook -->
                    <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem;">
                        <div style="font-size: 0.75rem; color: #10b981; font-weight: 600; margin-bottom: 0.5rem;">üé£ HOOK</div>
                        <input type="text"
                               value="${script.hook || ''}"
                               onchange="updateScriptHook(this.value)"
                               style="width: 100%; background: none; border: none; color: white; font-size: 0.95rem; outline: none;">
                    </div>

                    <!-- Metadata -->
                    ${script.metadata ? `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1rem;">
                            <div style="background: rgba(255,255,255,0.05); border-radius: 0.5rem; padding: 0.75rem;">
                                <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5);">Target Audience</div>
                                <div style="font-size: 0.85rem; color: white;">${script.metadata.targetAudience || '-'}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.05); border-radius: 0.5rem; padding: 0.75rem;">
                                <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5);">Key Message</div>
                                <div style="font-size: 0.85rem; color: white;">${script.metadata.keyMessage || '-'}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.05); border-radius: 0.5rem; padding: 0.75rem;">
                                <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5);">Suggested Music</div>
                                <div style="font-size: 0.85rem; color: white;">${script.metadata.suggestedMusic || '-'}</div>
                            </div>
                        </div>
                    ` : ''}
                </div>

                <!-- Scenes -->
                <div class="content-card">
                    <div class="content-card-header">
                        <div class="content-card-icon">üé¨</div>
                        <div>
                            <div class="content-card-title">Scenes</div>
                            <div class="content-card-subtitle">Edit narration and visuals for each scene</div>
                        </div>
                        <button onclick="addNewScene()"
                                style="background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.4); border-radius: 0.5rem; padding: 0.5rem 1rem; color: white; cursor: pointer; font-size: 0.8rem;">
                            + Add Scene
                        </button>
                    </div>

                    <div class="scenes-list" style="display: flex; flex-direction: column; gap: 1rem;">
            `;

            // Render each scene
            script.scenes.forEach((scene, index) => {
                html += renderSceneCard(scene, index);
            });

            html += `
                    </div>
                </div>

                <!-- CTA -->
                <div class="content-card">
                    <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.75rem; padding: 1rem;">
                        <div style="font-size: 0.75rem; color: #ef4444; font-weight: 600; margin-bottom: 0.5rem;">üì¢ CALL TO ACTION</div>
                        <input type="text"
                               value="${script.cta || ''}"
                               onchange="updateScriptCTA(this.value)"
                               style="width: 100%; background: none; border: none; color: white; font-size: 0.95rem; outline: none;">
                    </div>
                </div>
            `;

            return html;
        }

        function renderSceneCard(scene, index) {
            const isExpanded = state.script.expandedScene === scene.id;

            return `
                <div class="scene-card" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.75rem; overflow: hidden;">
                    <!-- Scene Header -->
                    <div onclick="toggleSceneExpand(${scene.id})"
                         style="padding: 1rem; cursor: pointer; display: flex; align-items: center; gap: 1rem; border-bottom: ${isExpanded ? '1px solid rgba(255,255,255,0.1)' : 'none'};">
                        <div style="width: 2rem; height: 2rem; background: linear-gradient(135deg, #8b5cf6, #06b6d4); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">
                            ${index + 1}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="color: white; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                ${scene.narration?.substring(0, 60) || 'No narration'}${scene.narration?.length > 60 ? '...' : ''}
                            </div>
                            <div style="color: rgba(255,255,255,0.5); font-size: 0.75rem;">
                                ${scene.duration}s ‚Ä¢ ${scene.transition || 'cut'}
                            </div>
                        </div>
                        <div style="color: rgba(255,255,255,0.5); transform: rotate(${isExpanded ? '180deg' : '0deg'}); transition: transform 0.2s;">‚ñº</div>
                    </div>

                    ${isExpanded ? `
                        <!-- Expanded Content -->
                        <div style="padding: 1rem;">
                            <!-- Narration -->
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem;">üéôÔ∏è Narration</label>
                                <textarea id="scene-narration-${scene.id}"
                                          onchange="updateSceneNarration(${scene.id}, this.value)"
                                          style="width: 100%; min-height: 60px; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; font-size: 0.9rem; resize: vertical;">${scene.narration || ''}</textarea>
                            </div>

                            <!-- Visual Description -->
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem;">üé® Visual Description (for AI image generation)</label>
                                <textarea id="scene-visual-${scene.id}"
                                          onchange="updateSceneVisual(${scene.id}, this.value)"
                                          style="width: 100%; min-height: 80px; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; font-size: 0.9rem; resize: vertical;">${scene.visual || ''}</textarea>
                            </div>

                            <!-- Duration & Transition -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem;">‚è±Ô∏è Duration (seconds)</label>
                                    <input type="number"
                                           value="${scene.duration || 8}"
                                           min="3" max="30"
                                           onchange="updateSceneDuration(${scene.id}, this.value)"
                                           style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem;">üîÄ Transition</label>
                                    <select onchange="updateSceneTransition(${scene.id}, this.value)"
                                            style="width: 100%; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(30,30,50,1); color: white;">
                                        ${['cut', 'fade', 'zoom', 'slide'].map(t => `
                                            <option value="${t}" ${scene.transition === t ? 'selected' : ''}>${t.charAt(0).toUpperCase() + t.slice(1)}</option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>

                            <!-- Scene Actions -->
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button onclick="regenerateScene(${scene.id})"
                                        style="flex: 1; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid rgba(139, 92, 246, 0.4); background: rgba(139, 92, 246, 0.1); color: white; cursor: pointer; font-size: 0.8rem;">
                                    üîÑ Regenerate
                                </button>
                                <button onclick="moveSceneUp(${scene.id})"
                                        ${index === 0 ? 'disabled' : ''}
                                        style="padding: 0.5rem 0.75rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; cursor: pointer; opacity: ${index === 0 ? '0.5' : '1'};">
                                    ‚Üë
                                </button>
                                <button onclick="moveSceneDown(${scene.id})"
                                        ${index === state.script.scenes.length - 1 ? 'disabled' : ''}
                                        style="padding: 0.5rem 0.75rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; cursor: pointer; opacity: ${index === state.script.scenes.length - 1 ? '0.5' : '1'};">
                                    ‚Üì
                                </button>
                                <button onclick="deleteScene(${scene.id})"
                                        style="padding: 0.5rem 0.75rem; border-radius: 0.5rem; border: 1px solid rgba(239, 68, 68, 0.4); background: rgba(239, 68, 68, 0.1); color: #ef4444; cursor: pointer;">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // ==========================================
        // 7.8 STEP 4: STORYBOARD
        // ==========================================
        function renderStep4Storyboard() {
            const scenes = state.script.scenes || [];
            const storyboardScenes = state.storyboard.scenes || [];

            // Check if we need to auto-generate
            if (scenes.length > 0 && storyboardScenes.length === 0 && state.storyboard.status !== 'generating') {
                // Trigger auto-generation on first visit
                setTimeout(() => generateInitialStoryboard(), 100);
            }

            let html = '<div class="fade-in">';

            // Header with Model Selector
            const currentModel = state.storyboard.imageModel || 'hidream';
            const modelConfig = IMAGE_MODELS[currentModel] || IMAGE_MODELS['hidream'];

            html += `
                <div class="content-card">
                    <div class="content-card-header">
                        <div class="content-card-icon">üé®</div>
                        <div style="flex: 1;">
                            <div class="content-card-title">Storyboard</div>
                            <div class="content-card-subtitle">Visual preview of each scene ‚Ä¢ ${storyboardScenes.filter(s => s.imageUrl && s.status === 'ready').length}/${scenes.length} images ready</div>
                        </div>
                    </div>

                    <!-- AI Model Selector -->
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="color: rgba(255,255,255,0.7); font-size: 0.75rem; margin-bottom: 0.5rem;">ü§ñ AI Model for Image Generation:</div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            ${Object.entries(IMAGE_MODELS).map(([id, model]) => `
                                <button onclick="setImageModel('${id}')"
                                        style="padding: 0.5rem 0.75rem; border-radius: 0.5rem; border: 1px solid ${currentModel === id ? '#8b5cf6' : 'rgba(255,255,255,0.2)'}; background: ${currentModel === id ? 'rgba(139, 92, 246, 0.2)' : 'rgba(255,255,255,0.05)'}; color: ${currentModel === id ? 'white' : 'rgba(255,255,255,0.7)'}; cursor: pointer; font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; gap: 0.15rem; transition: all 0.2s;">
                                    <span style="font-weight: 600;">${model.name}</span>
                                    <span style="font-size: 0.65rem; color: ${currentModel === id ? 'rgba(255,255,255,0.7)' : 'rgba(255,255,255,0.5)'};">${model.tokenCost} token${model.tokenCost > 1 ? 's' : ''}</span>
                                </button>
                            `).join('')}
                        </div>
                        <div style="color: rgba(255,255,255,0.5); font-size: 0.7rem; margin-top: 0.5rem;">
                            ${modelConfig.description}
                        </div>
                    </div>
                </div>
            `;

            // Storyboard Grid
            html += `<div class="storyboard-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; margin-top: 1rem;">`;

            scenes.forEach((scene, index) => {
                const storyboardScene = storyboardScenes.find(s => s.sceneId === scene.id) || {};
                html += renderStoryboardCard(scene, storyboardScene, index);
            });

            html += `</div>`;

            // Navigation
            const hasAllImages = storyboardScenes.filter(s => s.status === 'ready').length >= scenes.length;
            html += renderNavButtons(3, hasAllImages ? 5 : null);

            html += '</div>';

            // Modify Modal (rendered outside main flow)
            if (state.storyboard.modifyingScene) {
                html += renderModifyModal();
            }

            return html;
        }

        function renderStoryboardCard(scene, storyboardScene, index) {
            const status = storyboardScene.status || 'pending';
            const imageUrl = storyboardScene.imageUrl;
            const prompt = storyboardScene.prompt || scene.visual || '';

            let cardContent = '';

            if (status === 'pending') {
                // Empty state - needs generation (show both AI and Stock options)
                cardContent = `
                    <div style="height: 160px; background: rgba(255,255,255,0.03); border: 2px dashed rgba(255,255,255,0.2); border-radius: 0.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1rem;">
                        <div style="color: rgba(255,255,255,0.6); font-size: 0.75rem; margin-bottom: 0.75rem;">Choose image source:</div>
                        <div style="display: flex; gap: 0.5rem; width: 100%;">
                            <button onclick="generateSingleSceneImage(${scene.id})"
                                    style="flex: 1; padding: 0.6rem 0.5rem; background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(6, 182, 212, 0.3)); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 0.5rem; color: white; cursor: pointer; font-size: 0.7rem; display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                                <span style="font-size: 1.1rem;">üé®</span>
                                <span>AI Generate</span>
                                <span style="font-size: 0.6rem; color: rgba(255,255,255,0.5);">2 tokens</span>
                            </button>
                            <button onclick="openStockBrowser(${scene.id})"
                                    style="flex: 1; padding: 0.6rem 0.5rem; background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.4); border-radius: 0.5rem; color: white; cursor: pointer; font-size: 0.7rem; display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                                <span style="font-size: 1.1rem;">üì∑</span>
                                <span>Stock Media</span>
                                <span style="font-size: 0.6rem; color: rgba(16, 185, 129, 0.8);">FREE</span>
                            </button>
                        </div>
                    </div>
                `;
            } else if (status === 'generating') {
                // Loading state
                cardContent = `
                    <div style="height: 160px; background: rgba(139, 92, 246, 0.1); border-radius: 0.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <div class="animate-spin" style="width: 2rem; height: 2rem; border: 3px solid rgba(139,92,246,0.3); border-top-color: #8b5cf6; border-radius: 50%; margin-bottom: 0.75rem;"></div>
                        <div style="color: rgba(255,255,255,0.6); font-size: 0.8rem;">Generating...</div>
                    </div>
                `;
            } else if (status === 'ready' && imageUrl) {
                // Image ready
                const isVideo = storyboardScene.source === 'stock-video';
                const sourceLabel = storyboardScene.source === 'stock' ? 'üì∑ Stock' :
                                   isVideo ? 'üé¨ Video' : 'üé® AI';
                const sourceBgColor = storyboardScene.source === 'stock' ? 'rgba(16, 185, 129, 0.9)' :
                                     isVideo ? 'rgba(6, 182, 212, 0.9)' : 'rgba(139, 92, 246, 0.9)';
                // Get fallback thumbnail URL if available
                const fallbackUrl = storyboardScene.stockInfo?.thumbnailFallback || '';
                // Get clip duration for videos
                const clipDuration = storyboardScene.stockInfo?.clipDuration || storyboardScene.stockInfo?.duration;

                cardContent = `
                    <div style="height: 160px; border-radius: 0.5rem; overflow: hidden; position: relative; background: rgba(0,0,0,0.3);">
                        <img src="${imageUrl}"
                             alt="Scene ${index + 1}"
                             style="width: 100%; height: 100%; object-fit: cover;"
                             data-scene-id="${scene.id}"
                             data-retry-count="0"
                             onload="this.dataset.loaded='true';"
                             onerror="
                                this.onerror=null;
                                ${fallbackUrl ? `this.src='${fallbackUrl}';` : `
                                    // For AI images, retry a few times with cache-busting before showing placeholder
                                    const retryCount = parseInt(this.dataset.retryCount || '0');
                                    if (retryCount < 3) {
                                        this.dataset.retryCount = retryCount + 1;
                                        setTimeout(() => {
                                            const url = this.src.split('&t=')[0].split('?t=')[0];
                                            this.src = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now();
                                            this.onerror = function() {
                                                this.style.display='none';
                                                this.parentElement.querySelector('.placeholder-retry').style.display='flex';
                                            };
                                        }, 2000);
                                    } else {
                                        this.style.display='none';
                                        this.parentElement.querySelector('.placeholder-retry').style.display='flex';
                                    }
                                `}">
                        <!-- Placeholder with retry option if image fails after retries -->
                        <div class="placeholder-retry" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.6); gap: 0.5rem;">
                            <span style="font-size: 1.5rem;">${isVideo ? 'üé¨' : 'üñºÔ∏è'}</span>
                            <span style="font-size: 0.7rem; color: rgba(255,255,255,0.7);">Image not available</span>
                            <button onclick="regenerateSingleSceneImage(${scene.id})" style="padding: 0.3rem 0.6rem; border-radius: 0.3rem; border: 1px solid rgba(139,92,246,0.5); background: rgba(139,92,246,0.3); color: white; cursor: pointer; font-size: 0.65rem;">
                                üîÑ Regenerate
                            </button>
                        </div>
                        ${isVideo ? `
                            <!-- Video play icon overlay -->
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 36px; height: 36px; background: rgba(0,0,0,0.6); border-radius: 50%; display: flex; align-items: center; justify-content: center; pointer-events: none;">
                                <div style="width: 0; height: 0; border-left: 10px solid white; border-top: 6px solid transparent; border-bottom: 6px solid transparent; margin-left: 2px;"></div>
                            </div>
                            ${clipDuration ? `
                                <!-- Duration badge -->
                                <div style="position: absolute; bottom: 2.5rem; right: 0.4rem; background: rgba(0,0,0,0.8); color: white; padding: 0.15rem 0.35rem; border-radius: 0.2rem; font-size: 0.6rem;">
                                    ${formatDuration(clipDuration)}
                                </div>
                            ` : ''}
                        ` : ''}
                        <!-- Source badge -->
                        <div style="position: absolute; top: 0.5rem; right: 0.5rem; background: ${sourceBgColor}; color: white; padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 0.6rem;">
                            ${sourceLabel}
                        </div>
                        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); padding: 0.5rem; display: flex; gap: 0.3rem;">
                            <button onclick="openEditModal(${scene.id})" style="flex: 1; padding: 0.35rem; border-radius: 0.4rem; border: 1px solid rgba(236, 72, 153, 0.5); background: linear-gradient(135deg, rgba(236, 72, 153, 0.3), rgba(139, 92, 246, 0.3)); color: white; cursor: pointer; font-size: 0.65rem;" title="Edit with AI">
                                ‚ú® Edit
                            </button>
                            <button onclick="openModifyModal(${scene.id})" style="padding: 0.35rem 0.5rem; border-radius: 0.4rem; border: 1px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.5); color: white; cursor: pointer; font-size: 0.65rem;" title="Modify prompt">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="openStockBrowser(${scene.id})" style="padding: 0.35rem 0.5rem; border-radius: 0.4rem; border: 1px solid rgba(16, 185, 129, 0.5); background: rgba(16, 185, 129, 0.2); color: white; cursor: pointer; font-size: 0.65rem;" title="Browse stock media">
                                üì∑
                            </button>
                            <button onclick="regenerateSingleSceneImage(${scene.id})" style="padding: 0.35rem 0.5rem; border-radius: 0.4rem; border: 1px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.5); color: white; cursor: pointer; font-size: 0.65rem;" title="Regenerate with AI">
                                üîÑ
                            </button>
                        </div>
                    </div>
                `;
            } else if (status === 'error') {
                // Error state - show both retry options
                const errorMsg = storyboardScene.error || 'Generation failed';
                cardContent = `
                    <div style="height: 160px; background: rgba(239, 68, 68, 0.05); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.4rem; margin-bottom: 0.75rem;">
                            <span style="font-size: 1rem;">‚ö†Ô∏è</span>
                            <span style="color: #ef4444; font-size: 0.75rem;">${errorMsg.substring(0, 40)}${errorMsg.length > 40 ? '...' : ''}</span>
                        </div>
                        <div style="color: rgba(255,255,255,0.6); font-size: 0.7rem; margin-bottom: 0.5rem;">Choose to retry:</div>
                        <div style="display: flex; gap: 0.5rem; width: 100%;">
                            <button onclick="generateSingleSceneImage(${scene.id})"
                                    style="flex: 1; padding: 0.5rem 0.4rem; background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(6, 182, 212, 0.3)); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 0.5rem; color: white; cursor: pointer; font-size: 0.7rem; display: flex; flex-direction: column; align-items: center; gap: 0.2rem;">
                                <span style="font-size: 1rem;">üé®</span>
                                <span>Retry AI</span>
                            </button>
                            <button onclick="openStockBrowser(${scene.id})"
                                    style="flex: 1; padding: 0.5rem 0.4rem; background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.4); border-radius: 0.5rem; color: white; cursor: pointer; font-size: 0.7rem; display: flex; flex-direction: column; align-items: center; gap: 0.2rem;">
                                <span style="font-size: 1rem;">üì∑</span>
                                <span>Use Stock</span>
                            </button>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="storyboard-card" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.75rem; overflow: hidden;">
                    <!-- Scene number badge -->
                    <div style="position: relative;">
                        <div style="position: absolute; top: 0.5rem; left: 0.5rem; background: rgba(0,0,0,0.7); color: white; padding: 0.2rem 0.5rem; border-radius: 0.25rem; font-size: 0.7rem; font-weight: 600; z-index: 1;">
                            Scene ${index + 1}
                        </div>
                        ${cardContent}
                    </div>

                    <!-- Prompt -->
                    <div style="padding: 0.75rem;">
                        <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5); margin-bottom: 0.25rem;">PROMPT</div>
                        <div style="font-size: 0.8rem; color: rgba(255,255,255,0.8); line-height: 1.4; max-height: 3.6em; overflow: hidden; text-overflow: ellipsis;">
                            ${prompt.substring(0, 120)}${prompt.length > 120 ? '...' : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderModifyModal() {
            const sceneId = state.storyboard.modifyingScene;
            const scene = state.script.scenes.find(s => s.id === sceneId);
            const storyboardScene = state.storyboard.scenes.find(s => s.sceneId === sceneId) || {};

            if (!scene) return '';

            const currentPrompt = state.storyboard.modifyPrompt || storyboardScene.prompt || scene.visual || '';

            return `
                <div id="modify-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1rem;" onclick="if(event.target.id === 'modify-modal') closeModifyModal()">
                    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 1rem; width: 100%; max-width: 700px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
                        <!-- Header -->
                        <div style="padding: 1.25rem; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: white;">‚úèÔ∏è Modify Scene ${scene.id}</div>
                                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.5);">Customize the image generation</div>
                            </div>
                            <button onclick="closeModifyModal()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0.25rem;">√ó</button>
                        </div>

                        <!-- Content -->
                        <div style="padding: 1.25rem; overflow-y: auto; flex: 1;">
                            <!-- Current Image Preview -->
                            ${storyboardScene.imageUrl ? `
                                <div style="margin-bottom: 1.25rem;">
                                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem;">Current Image</div>
                                    <img src="${storyboardScene.imageUrl}" alt="Current" style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 0.5rem;">
                                </div>
                            ` : ''}

                            <!-- Prompt Editor -->
                            <div style="margin-bottom: 1.25rem;">
                                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: white; margin-bottom: 0.5rem;">
                                    Image Prompt
                                </label>
                                <textarea id="modify-prompt-input"
                                          style="width: 100%; min-height: 100px; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; font-size: 0.9rem; resize: vertical;"
                                          placeholder="Describe what you want to see...">${currentPrompt}</textarea>
                            </div>

                            <!-- Style Selector -->
                            <div style="margin-bottom: 1.25rem;">
                                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: white; margin-bottom: 0.5rem;">
                                    Style
                                </label>
                                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem;">
                                    ${['cinematic', 'modern', 'retro', 'cartoon', 'dark'].map(styleOpt => `
                                        <button onclick="setModifyStyle('${styleOpt}')"
                                                style="padding: 0.5rem; border-radius: 0.4rem; border: 1px solid ${state.storyboard.modifyStyle === styleOpt ? 'rgba(139, 92, 246, 0.6)' : 'rgba(255,255,255,0.2)'}; background: ${state.storyboard.modifyStyle === styleOpt ? 'rgba(139, 92, 246, 0.2)' : 'rgba(255,255,255,0.05)'}; color: white; cursor: pointer; font-size: 0.75rem; text-transform: capitalize;">
                                            ${styleOpt}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Camera/Composition -->
                            <div style="margin-bottom: 1.25rem;">
                                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: white; margin-bottom: 0.5rem;">
                                    Camera Shot
                                </label>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem;">
                                    ${['wide shot', 'medium shot', 'close-up', 'aerial'].map(shot => `
                                        <button onclick="appendToModifyPrompt('${shot}')"
                                                style="padding: 0.5rem; border-radius: 0.4rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; cursor: pointer; font-size: 0.75rem; text-transform: capitalize;">
                                            ${shot}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Lighting -->
                            <div style="margin-bottom: 1.25rem;">
                                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: white; margin-bottom: 0.5rem;">
                                    Lighting
                                </label>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem;">
                                    ${['golden hour', 'dramatic', 'soft light', 'neon'].map(light => `
                                        <button onclick="appendToModifyPrompt('${light} lighting')"
                                                style="padding: 0.5rem; border-radius: 0.4rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; cursor: pointer; font-size: 0.75rem; text-transform: capitalize;">
                                            ${light}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div style="padding: 1.25rem; border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 0.75rem;">
                            <button onclick="closeModifyModal()"
                                    style="flex: 1; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: transparent; color: white; cursor: pointer; font-weight: 600;">
                                Cancel
                            </button>
                            <button onclick="applyModifyAndGenerate()"
                                    style="flex: 2; padding: 0.75rem; border-radius: 0.5rem; border: none; background: linear-gradient(135deg, #8b5cf6, #06b6d4); color: white; cursor: pointer; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <span>‚ú®</span>
                                <span>Generate New Image</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==========================================
        // 7.9 STEP 5: ANIMATION
        // ==========================================
        function renderStep5Animation() {
            const storyboardScenes = state.storyboard.scenes || [];
            const animationScenes = state.animation.scenes || [];
            const scriptScenes = state.script.scenes || [];

            // Initialize animation scenes if needed
            if (animationScenes.length === 0 && storyboardScenes.length > 0) {
                initializeAnimationScenes();
            }

            // Calculate scene readiness stats
            const voiceoversReady = animationScenes.filter(s => s.voiceoverUrl).length;
            const animatedScenes = animationScenes.filter(s => s.videoUrl).length;
            const stockVideoScenes = storyboardScenes.filter(s => s.source === 'stock-video' && s.videoUrl).length;
            const staticImageScenes = storyboardScenes.filter(s => s.imageUrl && s.source !== 'stock-video').length;

            // A scene is ready if it has voiceover AND (animated OR stock-video OR image)
            const readyScenes = storyboardScenes.filter(sb => {
                const anim = animationScenes.find(a => a.sceneId === sb.sceneId);
                const hasVoiceover = anim?.voiceoverUrl;
                const hasVisual = anim?.videoUrl || (sb.source === 'stock-video' && sb.videoUrl) || sb.imageUrl;
                return hasVoiceover && hasVisual;
            }).length;

            let html = '<div class="fade-in">';

            // Header with global settings
            html += `
                <div class="content-card">
                    <div class="content-card-header">
                        <div class="content-card-icon">üé¨</div>
                        <div style="flex: 1;">
                            <div class="content-card-title">Animation Studio</div>
                            <div class="content-card-subtitle">Generate voiceovers and optionally animate scenes ‚Ä¢ ${readyScenes}/${storyboardScenes.length} ready</div>
                        </div>
                    </div>

                    <!-- Progress Stats -->
                    <div style="display: flex; gap: 1rem; margin-top: 0.75rem; flex-wrap: wrap;">
                        <div style="background: rgba(139, 92, 246, 0.15); padding: 0.5rem 0.75rem; border-radius: 0.5rem; font-size: 0.75rem;">
                            <span style="color: #a78bfa;">üéôÔ∏è Voiceovers:</span>
                            <span style="color: ${voiceoversReady >= storyboardScenes.length ? '#10b981' : 'white'}; font-weight: 600;">${voiceoversReady}/${storyboardScenes.length}</span>
                        </div>
                        <div style="background: rgba(6, 182, 212, 0.15); padding: 0.5rem 0.75rem; border-radius: 0.5rem; font-size: 0.75rem;">
                            <span style="color: #06b6d4;">üé¨ Animated:</span>
                            <span style="color: white; font-weight: 600;">${animatedScenes}</span>
                            <span style="color: rgba(255,255,255,0.5);">(optional)</span>
                        </div>
                        <div style="background: rgba(16, 185, 129, 0.15); padding: 0.5rem 0.75rem; border-radius: 0.5rem; font-size: 0.75rem;">
                            <span style="color: #10b981;">üìπ Stock Videos:</span>
                            <span style="color: white; font-weight: 600;">${stockVideoScenes}</span>
                        </div>
                        <div style="background: rgba(251, 191, 36, 0.15); padding: 0.5rem 0.75rem; border-radius: 0.5rem; font-size: 0.75rem;">
                            <span style="color: #fbbf24;">üñºÔ∏è Static Images:</span>
                            <span style="color: white; font-weight: 600;">${staticImageScenes - animatedScenes}</span>
                        </div>
                    </div>

                    <!-- Info Banner -->
                    <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 0.5rem; padding: 0.75rem; margin-top: 0.75rem; font-size: 0.75rem; color: rgba(255,255,255,0.7);">
                        üí° <strong>Animation is optional!</strong> Scenes with static images will display for the correct duration. Stock videos play as-is. Only animate if you want Ken Burns zoom/pan effects.
                    </div>

                    <!-- Global Voice Settings -->
                    <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 0.75rem; padding: 1rem; margin-top: 1rem;">
                        <div style="font-size: 0.85rem; font-weight: 600; color: white; margin-bottom: 0.75rem;">üéôÔ∏è Global Voice Settings</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem;">Voice</label>
                                <select id="global-voice-select" onchange="setGlobalVoice(this.value)"
                                        style="width: 100%; padding: 0.6rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(30,30,50,1); color: white; font-size: 0.85rem;">
                                    ${['alloy', 'nova', 'shimmer', 'echo', 'onyx', 'fable'].map(v => `
                                        <option value="${v}" ${state.animation.voiceover.voice === v ? 'selected' : ''}>${v.charAt(0).toUpperCase() + v.slice(1)}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem;">Speed: ${state.animation.voiceover.speed.toFixed(1)}x</label>
                                <input type="range" min="0.5" max="2.0" step="0.1" value="${state.animation.voiceover.speed}"
                                       onchange="setGlobalSpeed(this.value)"
                                       style="width: 100%; height: 6px; cursor: pointer;">
                            </div>
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 0.75rem;">
                            <button onclick="generateAllVoiceovers()"
                                    style="flex: 1; padding: 0.75rem; border-radius: 0.5rem; border: none; background: linear-gradient(135deg, #8b5cf6, #a855f7); color: white; cursor: pointer; font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <span>üéôÔ∏è</span> Generate All Voiceovers
                            </button>
                            <button onclick="animateAllScenes()"
                                    ${voiceoversReady < storyboardScenes.length ? 'disabled' : ''}
                                    style="flex: 1; padding: 0.75rem; border-radius: 0.5rem; border: none; background: ${voiceoversReady >= storyboardScenes.length ? 'linear-gradient(135deg, #06b6d4, #10b981)' : 'rgba(255,255,255,0.1)'}; color: ${voiceoversReady >= storyboardScenes.length ? 'white' : 'rgba(255,255,255,0.4)'}; cursor: ${voiceoversReady >= storyboardScenes.length ? 'pointer' : 'not-allowed'}; font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <span>üé¨</span> Animate All (Optional)
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Animation Scene Cards
            html += `<div style="display: grid; gap: 1rem; margin-top: 1rem;">`;

            scriptScenes.forEach((scriptScene, index) => {
                const storyboardScene = storyboardScenes.find(s => s.sceneId === scriptScene.id) || {};
                const animScene = animationScenes.find(s => s.sceneId === scriptScene.id) || {};
                html += renderAnimationSceneCard(scriptScene, storyboardScene, animScene, index);
            });

            html += `</div>`;

            // Navigation - Check if scenes are ready for assembly
            // A scene is ready if it has: voiceover + visual (animated video, stock video, OR static image)
            const allScenesReady = storyboardScenes.every(storyboardScene => {
                const animScene = animationScenes.find(a => a.sceneId === storyboardScene.sceneId) || {};

                // Must have voiceover
                const hasVoiceover = !!animScene.voiceoverUrl;

                // Must have visual: animated video, stock video, or at least a static image
                const hasAnimatedVideo = !!animScene.videoUrl;
                const hasStockVideo = storyboardScene.source === 'stock-video' && storyboardScene.videoUrl;
                const hasImage = !!storyboardScene.imageUrl;

                return hasVoiceover && (hasAnimatedVideo || hasStockVideo || hasImage);
            });

            html += renderNavButtons(4, allScenesReady ? 6 : null);

            html += '</div>';
            return html;
        }

        function initializeAnimationScenes() {
            const storyboardScenes = state.storyboard.scenes || [];
            const scriptScenes = state.script.scenes || [];

            state.animation.scenes = scriptScenes.map(scene => ({
                sceneId: scene.id,
                voiceoverStatus: 'idle',
                voiceoverUrl: null,
                animationStatus: 'idle',
                videoUrl: null,
                voice: state.animation.voiceover.voice,
                speed: state.animation.voiceover.speed,
                animationType: 'ken_burns',
                jobId: null
            }));
            saveProject();
        }

        function renderAnimationSceneCard(scriptScene, storyboardScene, animScene, index) {
            const imageUrl = storyboardScene.imageUrl;
            const voiceoverStatus = animScene.voiceoverStatus || 'idle';
            const voiceoverUrl = animScene.voiceoverUrl;
            const animationStatus = animScene.animationStatus || 'idle';
            const videoUrl = animScene.videoUrl;
            const animationType = animScene.animationType || 'ken_burns';

            return `
                <div class="content-card" style="padding: 0; overflow: hidden;">
                    <div style="display: grid; grid-template-columns: 200px 1fr; gap: 0;">
                        <!-- Left: Image/Video Preview -->
                        <div style="position: relative; background: rgba(0,0,0,0.3);">
                            ${videoUrl ? `
                                <video src="${videoUrl}" controls style="width: 100%; height: 180px; object-fit: cover;"></video>
                                <div style="position: absolute; top: 0.5rem; right: 0.5rem; background: rgba(16, 185, 129, 0.9); padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.65rem; font-weight: 600;">
                                    ‚úì ANIMATED
                                </div>
                            ` : imageUrl ? `
                                <img src="${imageUrl}" alt="Scene ${index + 1}" style="width: 100%; height: 180px; object-fit: cover;">
                                ${animationStatus === 'generating' ? `
                                    <div style="position: absolute; inset: 0; background: rgba(0,0,0,0.7); display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                        <div class="animate-spin" style="width: 2rem; height: 2rem; border: 3px solid rgba(6,182,212,0.3); border-top-color: #06b6d4; border-radius: 50%; margin-bottom: 0.5rem;"></div>
                                        <div style="color: white; font-size: 0.75rem;">Animating...</div>
                                    </div>
                                ` : ''}
                            ` : `
                                <div style="width: 100%; height: 180px; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.4);">
                                    No Image
                                </div>
                            `}
                            <div style="position: absolute; top: 0.5rem; left: 0.5rem; width: 1.75rem; height: 1.75rem; background: linear-gradient(135deg, #8b5cf6, #06b6d4); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.75rem;">
                                ${index + 1}
                            </div>
                        </div>

                        <!-- Right: Controls -->
                        <div style="padding: 1rem;">
                            <!-- Narration Preview -->
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.8); margin-bottom: 0.75rem; line-height: 1.4; max-height: 2.8em; overflow: hidden; text-overflow: ellipsis;">
                                "${scriptScene.narration?.substring(0, 100) || 'No narration'}${scriptScene.narration?.length > 100 ? '...' : ''}"
                            </div>

                            <!-- Voiceover Section -->
                            <div style="margin-bottom: 0.75rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">üéôÔ∏è Voiceover:</span>
                                    ${voiceoverStatus === 'idle' ? `
                                        <span style="font-size: 0.7rem; color: rgba(255,255,255,0.4);">Not generated</span>
                                    ` : voiceoverStatus === 'generating' ? `
                                        <span style="font-size: 0.7rem; color: #a855f7;" class="animate-pulse">Generating...</span>
                                    ` : voiceoverStatus === 'ready' ? `
                                        <span style="font-size: 0.7rem; color: #10b981;">‚úì Ready</span>
                                    ` : `
                                        <span style="font-size: 0.7rem; color: #ef4444;">Error</span>
                                    `}
                                </div>
                                ${voiceoverUrl ? `
                                    <audio src="${voiceoverUrl}" controls style="width: 100%; height: 28px; margin-bottom: 0.5rem;"></audio>
                                ` : ''}
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="generateSceneVoiceover(${scriptScene.id})"
                                            ${voiceoverStatus === 'generating' ? 'disabled' : ''}
                                            style="flex: 1; padding: 0.4rem 0.6rem; border-radius: 0.4rem; border: 1px solid rgba(139, 92, 246, 0.4); background: rgba(139, 92, 246, 0.15); color: ${voiceoverStatus === 'generating' ? 'rgba(255,255,255,0.4)' : 'white'}; cursor: ${voiceoverStatus === 'generating' ? 'wait' : 'pointer'}; font-size: 0.75rem;">
                                        ${voiceoverUrl ? 'üîÑ Regenerate' : 'üéôÔ∏è Generate'} Voice
                                    </button>
                                </div>
                            </div>

                            <!-- Animation Section -->
                            <div>
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">üé¨ Animation Type:</span>
                                    <select onchange="setSceneAnimationType(${scriptScene.id}, this.value)"
                                            style="padding: 0.3rem 0.5rem; border-radius: 0.3rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(30,30,50,1); color: white; font-size: 0.7rem;">
                                        ${[
                                            { id: 'ken_burns', name: 'Ken Burns (Zoom/Pan)' },
                                            { id: 'talking_head', name: 'Talking Head' },
                                            { id: 'static', name: 'Static (No Animation)' }
                                        ].map(type => `
                                            <option value="${type.id}" ${animationType === type.id ? 'selected' : ''}>${type.name}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                <button onclick="animateScene(${scriptScene.id})"
                                        ${!voiceoverUrl || animationStatus === 'generating' ? 'disabled' : ''}
                                        style="width: 100%; padding: 0.5rem; border-radius: 0.4rem; border: none; background: ${voiceoverUrl && animationStatus !== 'generating' ? 'linear-gradient(135deg, #06b6d4, #10b981)' : 'rgba(255,255,255,0.1)'}; color: ${voiceoverUrl && animationStatus !== 'generating' ? 'white' : 'rgba(255,255,255,0.4)'}; cursor: ${voiceoverUrl && animationStatus !== 'generating' ? 'pointer' : 'not-allowed'}; font-size: 0.8rem; font-weight: 600;">
                                    ${animationStatus === 'generating' ? '‚è≥ Animating...' : videoUrl ? 'üîÑ Re-Animate' : 'üé¨ Animate Scene'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Animation Functions
        function setGlobalVoice(voice) {
            state.animation.voiceover.voice = voice;
            // Update all scenes that haven't generated voiceover yet
            state.animation.scenes.forEach(scene => {
                if (!scene.voiceoverUrl) {
                    scene.voice = voice;
                }
            });
            saveProject();
            render();
        }

        function setGlobalSpeed(speed) {
            state.animation.voiceover.speed = parseFloat(speed);
            // Update all scenes that haven't generated voiceover yet
            state.animation.scenes.forEach(scene => {
                if (!scene.voiceoverUrl) {
                    scene.speed = parseFloat(speed);
                }
            });
            saveProject();
            render();
        }

        function setSceneAnimationType(sceneId, type) {
            const scene = state.animation.scenes.find(s => s.sceneId === sceneId);
            if (scene) {
                scene.animationType = type;
                saveProject();
            }
        }

        async function generateSceneVoiceover(sceneId) {
            const animScene = state.animation.scenes.find(s => s.sceneId === sceneId);
            const scriptScene = state.script.scenes.find(s => s.id === sceneId);

            if (!animScene || !scriptScene || !scriptScene.narration) {
                showToast('No narration available for this scene', 'error');
                return;
            }

            animScene.voiceoverStatus = 'generating';
            render();

            try {
                const generateVoiceover = firebase.functions().httpsCallable('creationWizardGenerateVoiceover');
                const result = await generateVoiceover({
                    projectId: state.project.id,
                    sceneId: sceneId,
                    text: scriptScene.narration,
                    voice: animScene.voice || state.animation.voiceover.voice,
                    speed: animScene.speed || state.animation.voiceover.speed
                });

                animScene.voiceoverStatus = 'ready';
                animScene.voiceoverUrl = result.data.audioUrl;
                showToast('Voiceover generated successfully!', 'success');
            } catch (error) {
                console.error('Voiceover generation error:', error);
                animScene.voiceoverStatus = 'error';
                showToast('Failed to generate voiceover: ' + error.message, 'error');
            }

            saveProject();
            render();
        }

        async function generateAllVoiceovers() {
            const scenesToGenerate = state.animation.scenes.filter(s => !s.voiceoverUrl && s.voiceoverStatus !== 'generating');

            if (scenesToGenerate.length === 0) {
                showToast('All voiceovers are already generated', 'info');
                return;
            }

            showToast(`Generating ${scenesToGenerate.length} voiceovers...`, 'info');

            // Generate sequentially to avoid rate limits
            for (const scene of scenesToGenerate) {
                await generateSceneVoiceover(scene.sceneId);
                // Small delay between generations
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            showToast('All voiceovers generated!', 'success');
        }

        async function animateScene(sceneId) {
            const animScene = state.animation.scenes.find(s => s.sceneId === sceneId);
            const storyboardScene = state.storyboard.scenes.find(s => s.sceneId === sceneId);

            if (!animScene || !storyboardScene || !storyboardScene.imageUrl) {
                showToast('No image available for animation', 'error');
                return;
            }

            if (!animScene.voiceoverUrl) {
                showToast('Please generate voiceover first', 'error');
                return;
            }

            animScene.animationStatus = 'generating';
            render();

            try {
                const animate = firebase.functions().httpsCallable('creationWizardAnimateScene');
                const result = await animate({
                    projectId: state.project.id,
                    sceneId: sceneId,
                    imageUrl: storyboardScene.imageUrl,
                    audioUrl: animScene.voiceoverUrl,
                    animationType: animScene.animationType || 'ken_burns'
                });

                // Start polling for completion
                animScene.jobId = result.data.jobId;
                pollAnimationStatus(sceneId, result.data.jobId);

            } catch (error) {
                console.error('Animation error:', error);
                animScene.animationStatus = 'error';
                showToast('Failed to start animation: ' + error.message, 'error');
                saveProject();
                render();
            }
        }

        async function pollAnimationStatus(sceneId, jobId) {
            const animScene = state.animation.scenes.find(s => s.sceneId === sceneId);
            if (!animScene) return;

            try {
                const checkStatus = firebase.functions().httpsCallable('creationWizardCheckAnimationStatus');
                const result = await checkStatus({ jobId });

                if (result.data.status === 'COMPLETED') {
                    animScene.animationStatus = 'ready';
                    animScene.videoUrl = result.data.videoUrl;
                    animScene.jobId = null;
                    showToast(`Scene ${state.script.scenes.findIndex(s => s.id === sceneId) + 1} animated!`, 'success');
                    saveProject();
                    render();
                } else if (result.data.status === 'FAILED') {
                    animScene.animationStatus = 'error';
                    animScene.jobId = null;
                    showToast('Animation failed. Please try again.', 'error');
                    saveProject();
                    render();
                } else {
                    // Still processing, poll again
                    setTimeout(() => pollAnimationStatus(sceneId, jobId), 5000);
                }
            } catch (error) {
                console.error('Animation status check error:', error);
                // Retry polling
                setTimeout(() => pollAnimationStatus(sceneId, jobId), 8000);
            }
        }

        async function animateAllScenes() {
            const scenesToAnimate = state.animation.scenes.filter(s => s.voiceoverUrl && !s.videoUrl && s.animationStatus !== 'generating');

            if (scenesToAnimate.length === 0) {
                showToast('No scenes ready to animate', 'info');
                return;
            }

            showToast(`Starting animation for ${scenesToAnimate.length} scenes...`, 'info');

            // Start all animations (they will poll independently)
            for (const scene of scenesToAnimate) {
                await animateScene(scene.sceneId);
                // Small delay between starting jobs
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }

        // ==========================================
        // 7.10 STEP 6: ASSEMBLY
        // ==========================================

        async function initializeAssembly() {
            // Load music library and options if not already loaded
            if (state.assembly.musicLibrary.length === 0) {
                try {
                    const getMusicLibrary = firebase.functions().httpsCallable('creationWizardGetMusicLibrary');
                    const result = await getMusicLibrary({});
                    state.assembly.musicLibrary = result.data.tracks || [];
                    state.assembly.transitionTypes = result.data.transitionTypes || [];
                    state.assembly.captionStyles = result.data.captionStyles || [];
                } catch (error) {
                    console.error('Failed to load music library:', error);
                    // Use defaults
                    state.assembly.transitionTypes = [
                        { id: 'cut', name: 'Cut' },
                        { id: 'fade', name: 'Fade' },
                        { id: 'crossfade', name: 'Crossfade' },
                        { id: 'dissolve', name: 'Dissolve' }
                    ];
                    state.assembly.captionStyles = [
                        { id: 'karaoke', name: 'Karaoke' },
                        { id: 'subtitle', name: 'Subtitle' },
                        { id: 'dynamic', name: 'Dynamic' },
                        { id: 'none', name: 'No Captions' }
                    ];
                }
            }

            // Initialize scene order if empty
            if (state.assembly.sceneOrder.length === 0 && state.script.scenes.length > 0) {
                state.assembly.sceneOrder = state.script.scenes.map(s => s.id);
            }

            // Initialize transitions for each scene if empty
            if (Object.keys(state.assembly.transitions).length === 0) {
                state.script.scenes.forEach(scene => {
                    state.assembly.transitions[scene.id] = { type: 'cut' };
                });
            }
        }

        function renderStep6Assembly() {
            // Initialize on first render
            if (state.assembly.musicLibrary.length === 0) {
                setTimeout(() => initializeAssembly().then(() => render()), 100);
            }

            const scriptScenes = state.script.scenes || [];
            const animationScenes = state.animation.scenes || [];
            const sceneOrder = state.assembly.sceneOrder.length > 0
                ? state.assembly.sceneOrder
                : scriptScenes.map(s => s.id);

            // Calculate total duration
            let totalDuration = 0;
            sceneOrder.forEach(sceneId => {
                const scene = scriptScenes.find(s => s.id === sceneId);
                if (scene) totalDuration += scene.duration || 8;
            });

            let html = '<div class="fade-in">';

            // Header
            html += `
                <div class="content-card">
                    <div class="content-card-header">
                        <div class="content-card-icon">üéûÔ∏è</div>
                        <div style="flex: 1;">
                            <div class="content-card-title">Video Assembly</div>
                            <div class="content-card-subtitle">Arrange scenes, add music & captions ‚Ä¢ Total: ${formatDuration(totalDuration)}</div>
                        </div>
                    </div>
                </div>
            `;

            // Main Assembly Layout - Two columns with preview
            html += `<div style="display: grid; grid-template-columns: 1fr 440px; gap: 1rem; margin-top: 1rem;">`;

            // Left Column - Timeline
            html += `
                <div>
                    <div class="content-card" style="padding: 1rem;">
                        <div style="font-size: 0.9rem; font-weight: 600; color: white; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üìã</span> Scene Timeline
                            <span style="font-size: 0.75rem; color: rgba(255,255,255,0.5); font-weight: 400; margin-left: auto;">Click to preview ‚Ä¢ Drag to reorder</span>
                        </div>
                        <div id="timeline-container" style="display: flex; flex-direction: column; gap: 0.5rem;">
            `;

            sceneOrder.forEach((sceneId, index) => {
                const scriptScene = scriptScenes.find(s => s.id === sceneId);
                const animScene = animationScenes.find(s => s.sceneId === sceneId);
                const storyboardScene = state.storyboard.scenes.find(s => s.sceneId === sceneId);
                const transition = state.assembly.transitions[sceneId] || { type: 'cut' };

                if (scriptScene) {
                    html += renderTimelineSceneCard(scriptScene, animScene, storyboardScene, transition, index, sceneOrder.length);
                }
            });

            html += `
                        </div>
                    </div>
                </div>
            `;

            // Right Column - Preview + Settings
            html += `
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    ${renderPreviewPanel()}
                    <div style="max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 1rem;">
                        ${renderMusicSettings()}
                        ${renderCaptionSettings()}
                        ${renderAudioMixSettings()}
                    </div>
                </div>
            `;

            html += `</div>`;

            // Navigation
            const isAssemblyReady = sceneOrder.length > 0;
            html += renderNavButtons(5, isAssemblyReady ? 7 : null);

            html += '</div>';
            return html;
        }

        function renderPreviewPanel() {
            const { isReady, isPlaying, currentTime, totalDuration, currentSceneIndex, loadProgress } = state.preview;
            const scriptScenes = state.script.scenes || [];
            const currentScene = scriptScenes[currentSceneIndex] || {};

            return `
                <div class="content-card" style="padding: 1rem;">
                    <div style="font-size: 0.9rem; font-weight: 600; color: white; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span>üé¨</span> Live Preview
                        ${isReady ? '<span style="font-size: 0.65rem; padding: 0.15rem 0.4rem; background: rgba(16, 185, 129, 0.2); color: #10b981; border-radius: 0.25rem; margin-left: auto;">Ready</span>' :
                          loadProgress > 0 ? `<span style="font-size: 0.65rem; padding: 0.15rem 0.4rem; background: rgba(139, 92, 246, 0.2); color: #a78bfa; border-radius: 0.25rem; margin-left: auto;">Loading ${loadProgress}%</span>` :
                          '<span style="font-size: 0.65rem; padding: 0.15rem 0.4rem; background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.5); border-radius: 0.25rem; margin-left: auto;">Click to load</span>'}
                    </div>

                    <!-- Preview Canvas Container -->
                    <div style="position: relative; width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 0.5rem; overflow: hidden; margin-bottom: 0.75rem;">
                        <canvas id="preview-canvas" style="width: 100%; height: 100%; display: block;"></canvas>

                        <!-- Loading Overlay -->
                        ${!isReady ? `
                            <div id="preview-loading-overlay" style="position: absolute; inset: 0; background: rgba(0,0,0,0.7); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.5rem;">
                                ${loadProgress > 0 ? `
                                    <div style="width: 60%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; overflow: hidden;">
                                        <div style="width: ${loadProgress}%; height: 100%; background: linear-gradient(135deg, #8b5cf6, #06b6d4); transition: width 0.3s;"></div>
                                    </div>
                                    <span style="font-size: 0.75rem; color: rgba(255,255,255,0.6);">Loading media...</span>
                                ` : `
                                    <button onclick="initializePreviewEngine()" style="padding: 0.75rem 1.5rem; border-radius: 0.5rem; border: none; background: linear-gradient(135deg, #8b5cf6, #06b6d4); color: white; font-weight: 600; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="font-size: 1.2rem;">‚ñ∂</span> Load Preview
                                    </button>
                                    <span style="font-size: 0.7rem; color: rgba(255,255,255,0.4); margin-top: 0.25rem;">Loads all scenes for preview</span>
                                `}
                            </div>
                        ` : ''}

                        <!-- Play Button Overlay (when paused) -->
                        ${isReady && !isPlaying ? `
                            <div onclick="togglePreviewPlayback()" style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; cursor: pointer; background: rgba(0,0,0,0.3); transition: background 0.2s;" onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='rgba(0,0,0,0.3)'">
                                <div style="width: 60px; height: 60px; background: rgba(139, 92, 246, 0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 20px rgba(0,0,0,0.4);">
                                    <span style="font-size: 1.5rem; margin-left: 4px;">‚ñ∂</span>
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Playback Controls -->
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <button onclick="togglePreviewPlayback()" ${!isReady ? 'disabled' : ''}
                                style="width: 36px; height: 36px; border-radius: 50%; border: none; background: ${isReady ? 'linear-gradient(135deg, #8b5cf6, #06b6d4)' : 'rgba(255,255,255,0.1)'}; color: white; cursor: ${isReady ? 'pointer' : 'not-allowed'}; display: flex; align-items: center; justify-content: center; font-size: 0.9rem;">
                            ${isPlaying ? '‚ùö‚ùö' : '‚ñ∂'}
                        </button>

                        <button onclick="stopPreview()" ${!isReady ? 'disabled' : ''}
                                style="width: 28px; height: 28px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); background: transparent; color: ${isReady ? 'white' : 'rgba(255,255,255,0.3)'}; cursor: ${isReady ? 'pointer' : 'not-allowed'}; display: flex; align-items: center; justify-content: center; font-size: 0.7rem;">
                            ‚ñ†
                        </button>

                        <!-- Time Display -->
                        <span style="font-size: 0.75rem; color: rgba(255,255,255,0.7); font-family: monospace; min-width: 90px;">
                            ${formatDuration(currentTime)} / ${formatDuration(totalDuration)}
                        </span>

                        <!-- Volume Control -->
                        <div style="margin-left: auto; display: flex; align-items: center; gap: 0.3rem;">
                            <span style="font-size: 0.75rem;">üîä</span>
                            <input type="range" min="0" max="100" value="${(state.preview.volume || 100)}"
                                   onchange="setPreviewVolume(this.value)"
                                   style="width: 60px; height: 4px; cursor: pointer;">
                        </div>
                    </div>

                    <!-- Scrubber -->
                    <div style="margin-bottom: 0.75rem;">
                        <input type="range" id="preview-scrubber" min="0" max="${totalDuration || 100}" step="0.1" value="${currentTime}"
                               onchange="seekPreview(this.value)" oninput="updateScrubberPreview(this.value)"
                               ${!isReady ? 'disabled' : ''}
                               style="width: 100%; height: 6px; cursor: ${isReady ? 'pointer' : 'not-allowed'}; background: linear-gradient(to right, #8b5cf6 0%, #8b5cf6 ${(currentTime / (totalDuration || 1)) * 100}%, rgba(255,255,255,0.2) ${(currentTime / (totalDuration || 1)) * 100}%, rgba(255,255,255,0.2) 100%); border-radius: 3px;">
                    </div>

                    <!-- Current Scene Info -->
                    <div style="background: rgba(139, 92, 246, 0.1); border-radius: 0.4rem; padding: 0.5rem;">
                        <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5); margin-bottom: 0.2rem;">Currently Playing</div>
                        <div style="font-size: 0.8rem; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            Scene ${currentSceneIndex + 1}: "${currentScene.narration?.substring(0, 35) || 'No scene loaded'}${currentScene.narration?.length > 35 ? '...' : ''}"
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                            <button onclick="prevPreviewScene()" ${!isReady || currentSceneIndex <= 0 ? 'disabled' : ''}
                                    style="flex: 1; padding: 0.3rem; border-radius: 0.25rem; border: 1px solid rgba(255,255,255,0.2); background: transparent; color: ${isReady && currentSceneIndex > 0 ? 'white' : 'rgba(255,255,255,0.3)'}; cursor: ${isReady && currentSceneIndex > 0 ? 'pointer' : 'not-allowed'}; font-size: 0.7rem;">
                                ‚óÄ Prev
                            </button>
                            <button onclick="nextPreviewScene()" ${!isReady || currentSceneIndex >= (scriptScenes.length - 1) ? 'disabled' : ''}
                                    style="flex: 1; padding: 0.3rem; border-radius: 0.25rem; border: 1px solid rgba(255,255,255,0.2); background: transparent; color: ${isReady && currentSceneIndex < (scriptScenes.length - 1) ? 'white' : 'rgba(255,255,255,0.3)'}; cursor: ${isReady && currentSceneIndex < (scriptScenes.length - 1) ? 'pointer' : 'not-allowed'}; font-size: 0.7rem;">
                                Next ‚ñ∂
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTimelineSceneCard(scriptScene, animScene, storyboardScene, transition, index, totalScenes) {
            const imageUrl = storyboardScene?.imageUrl;
            const hasVideo = animScene?.videoUrl;
            const transitionTypes = state.assembly.transitionTypes || [];

            let html = `
                <div class="timeline-scene" data-scene-id="${scriptScene.id}"
                     onclick="seekToScene(${scriptScene.id})"
                     style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.5rem; overflow: hidden; cursor: pointer; transition: border-color 0.2s, box-shadow 0.2s;"
                     onmouseover="this.style.borderColor='rgba(139, 92, 246, 0.5)'" onmouseout="if(!this.classList.contains('active')) this.style.borderColor='rgba(255,255,255,0.1)'">
                    <div style="display: flex; gap: 0.75rem; padding: 0.75rem;">
                        <!-- Drag Handle & Number -->
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem;" onclick="event.stopPropagation()">
                            <div style="cursor: grab; color: rgba(255,255,255,0.3); font-size: 1rem;">‚ãÆ‚ãÆ</div>
                            <div style="width: 1.5rem; height: 1.5rem; background: linear-gradient(135deg, #8b5cf6, #06b6d4); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 700;">
                                ${index + 1}
                            </div>
                        </div>

                        <!-- Thumbnail -->
                        <div style="width: 80px; height: 50px; border-radius: 0.25rem; overflow: hidden; background: rgba(0,0,0,0.3); flex-shrink: 0;">
                            ${imageUrl ? `<img src="${imageUrl}" style="width: 100%; height: 100%; object-fit: cover;">` :
                              `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.3); font-size: 0.7rem;">No image</div>`}
                        </div>

                        <!-- Scene Info -->
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 0.8rem; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 0.25rem;">
                                ${scriptScene.narration?.substring(0, 40) || 'No narration'}...
                            </div>
                            <div style="display: flex; gap: 0.5rem; font-size: 0.7rem; color: rgba(255,255,255,0.5);">
                                <span>‚è±Ô∏è ${scriptScene.duration || 8}s</span>
                                ${hasVideo ? '<span style="color: #10b981;">‚úì Video</span>' : '<span style="color: #f59e0b;">‚ö†Ô∏è No video</span>'}
                            </div>
                        </div>

                        <!-- Reorder Buttons -->
                        <div style="display: flex; flex-direction: column; gap: 0.25rem;" onclick="event.stopPropagation()">
                            <button onclick="event.stopPropagation(); moveSceneInOrder(${scriptScene.id}, -1)" ${index === 0 ? 'disabled' : ''}
                                    style="padding: 0.25rem 0.4rem; border-radius: 0.25rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: ${index === 0 ? 'rgba(255,255,255,0.2)' : 'white'}; cursor: ${index === 0 ? 'not-allowed' : 'pointer'}; font-size: 0.65rem;">
                                ‚Üë
                            </button>
                            <button onclick="event.stopPropagation(); moveSceneInOrder(${scriptScene.id}, 1)" ${index === totalScenes - 1 ? 'disabled' : ''}
                                    style="padding: 0.25rem 0.4rem; border-radius: 0.25rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: ${index === totalScenes - 1 ? 'rgba(255,255,255,0.2)' : 'white'}; cursor: ${index === totalScenes - 1 ? 'not-allowed' : 'pointer'}; font-size: 0.65rem;">
                                ‚Üì
                            </button>
                        </div>
                    </div>

                    <!-- Transition Selector (between scenes) -->
                    ${index < totalScenes - 1 ? `
                        <div onclick="event.stopPropagation()" style="padding: 0.5rem 0.75rem; background: rgba(139, 92, 246, 0.1); border-top: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 0.7rem; color: rgba(255,255,255,0.6);">Transition:</span>
                            <select onchange="setSceneTransition(${scriptScene.id}, this.value)"
                                    style="flex: 1; padding: 0.3rem 0.5rem; border-radius: 0.25rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(30,30,50,1); color: white; font-size: 0.7rem;">
                                ${transitionTypes.map(t => `
                                    <option value="${t.id}" ${transition.type === t.id ? 'selected' : ''}>${t.name}</option>
                                `).join('')}
                            </select>
                        </div>
                    ` : ''}
                </div>
            `;
            return html;
        }

        function renderMusicSettings() {
            const musicLibrary = state.assembly.musicLibrary || [];
            const selectedTrackId = state.assembly.music.trackId;
            const musicEnabled = state.assembly.music.enabled;
            const musicVolume = state.assembly.music.volume;

            // Group by category
            const categories = ['upbeat', 'calm', 'dramatic', 'electronic', 'hiphop', 'none'];
            const categoryNames = {
                upbeat: 'üéâ Upbeat',
                calm: 'üåä Calm',
                dramatic: 'üé¨ Dramatic',
                electronic: 'üéß Electronic',
                hiphop: 'üé§ Hip Hop',
                none: 'üîá None'
            };

            return `
                <div class="content-card" style="padding: 1rem;">
                    <div style="font-size: 0.9rem; font-weight: 600; color: white; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span>üéµ</span> Background Music
                        <label style="margin-left: auto; display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" ${musicEnabled ? 'checked' : ''} onchange="toggleMusic(this.checked)"
                                   style="width: 1rem; height: 1rem; cursor: pointer;">
                            <span style="font-size: 0.75rem; font-weight: 400; color: rgba(255,255,255,0.6);">Enable</span>
                        </label>
                    </div>

                    <div style="opacity: ${musicEnabled ? '1' : '0.5'}; pointer-events: ${musicEnabled ? 'auto' : 'none'};">
                        <select id="music-select" onchange="selectMusicTrack(this.value)"
                                style="width: 100%; padding: 0.6rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(30,30,50,1); color: white; font-size: 0.85rem; margin-bottom: 0.75rem;">
                            <option value="">Select a track...</option>
                            ${categories.map(cat => `
                                <optgroup label="${categoryNames[cat] || cat}">
                                    ${musicLibrary.filter(t => t.category === cat).map(track => `
                                        <option value="${track.id}" ${selectedTrackId === track.id ? 'selected' : ''}>
                                            ${track.name} ${track.duration ? `(${Math.floor(track.duration / 60)}:${(track.duration % 60).toString().padStart(2, '0')})` : ''}
                                        </option>
                                    `).join('')}
                                </optgroup>
                            `).join('')}
                        </select>

                        ${selectedTrackId && selectedTrackId !== 'none' ? `
                            <div style="background: rgba(139, 92, 246, 0.1); border-radius: 0.4rem; padding: 0.5rem; margin-bottom: 0.75rem;">
                                <div style="font-size: 0.75rem; color: rgba(255,255,255,0.7);">
                                    ${musicLibrary.find(t => t.id === selectedTrackId)?.mood || ''}
                                </div>
                            </div>
                        ` : ''}

                        <div>
                            <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.4rem;">
                                Volume: ${musicVolume}%
                            </label>
                            <input type="range" min="0" max="100" value="${musicVolume}"
                                   onchange="setMusicVolume(this.value)"
                                   style="width: 100%; height: 6px; cursor: pointer;">
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCaptionSettings() {
            const captionStyles = state.assembly.captionStyles || [];
            const captionsEnabled = state.assembly.captions.enabled;
            const selectedStyle = state.assembly.captions.style;
            const position = state.assembly.captions.position;

            return `
                <div class="content-card" style="padding: 1rem;">
                    <div style="font-size: 0.9rem; font-weight: 600; color: white; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span>üí¨</span> Captions
                        <label style="margin-left: auto; display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" ${captionsEnabled ? 'checked' : ''} onchange="toggleCaptions(this.checked)"
                                   style="width: 1rem; height: 1rem; cursor: pointer;">
                            <span style="font-size: 0.75rem; font-weight: 400; color: rgba(255,255,255,0.6);">Enable</span>
                        </label>
                    </div>

                    <div style="opacity: ${captionsEnabled ? '1' : '0.5'}; pointer-events: ${captionsEnabled ? 'auto' : 'none'};">
                        <!-- Style Selection -->
                        <div style="margin-bottom: 0.75rem;">
                            <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.4rem;">Style</label>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.4rem;">
                                ${captionStyles.filter(s => s.id !== 'none').map(style => `
                                    <button onclick="setCaptionStyle('${style.id}')"
                                            style="padding: 0.4rem; border-radius: 0.4rem; border: 1px solid ${selectedStyle === style.id ? 'rgba(139, 92, 246, 0.6)' : 'rgba(255,255,255,0.2)'}; background: ${selectedStyle === style.id ? 'rgba(139, 92, 246, 0.2)' : 'rgba(255,255,255,0.05)'}; color: white; cursor: pointer; font-size: 0.7rem;">
                                        ${style.name}
                                    </button>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Position -->
                        <div>
                            <label style="display: block; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.4rem;">Position</label>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.4rem;">
                                ${['top', 'center', 'bottom'].map(pos => `
                                    <button onclick="setCaptionPosition('${pos}')"
                                            style="padding: 0.4rem; border-radius: 0.4rem; border: 1px solid ${position === pos ? 'rgba(6, 182, 212, 0.6)' : 'rgba(255,255,255,0.2)'}; background: ${position === pos ? 'rgba(6, 182, 212, 0.2)' : 'rgba(255,255,255,0.05)'}; color: white; cursor: pointer; font-size: 0.7rem; text-transform: capitalize;">
                                        ${pos}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAudioMixSettings() {
            const voiceVolume = state.assembly.audioMix?.voiceVolume || 100;
            const musicVolume = state.assembly.audioMix?.musicVolume || 30;

            return `
                <div class="content-card" style="padding: 1rem;">
                    <div style="font-size: 0.9rem; font-weight: 600; color: white; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span>üéöÔ∏è</span> Audio Mix
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <div>
                            <label style="display: flex; justify-content: space-between; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.4rem;">
                                <span>üéôÔ∏è Voiceover</span>
                                <span>${voiceVolume}%</span>
                            </label>
                            <input type="range" min="0" max="100" value="${voiceVolume}"
                                   onchange="setVoiceVolume(this.value)"
                                   style="width: 100%; height: 6px; cursor: pointer;">
                        </div>

                        <div>
                            <label style="display: flex; justify-content: space-between; font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.4rem;">
                                <span>üéµ Music</span>
                                <span>${musicVolume}%</span>
                            </label>
                            <input type="range" min="0" max="100" value="${musicVolume}"
                                   onchange="setAudioMixMusicVolume(this.value)"
                                   style="width: 100%; height: 6px; cursor: pointer;">
                        </div>
                    </div>

                    <!-- Save Assembly Button -->
                    <button onclick="saveAssemblySettings()"
                            style="width: 100%; margin-top: 1rem; padding: 0.75rem; border-radius: 0.5rem; border: none; background: linear-gradient(135deg, #8b5cf6, #06b6d4); color: white; font-weight: 600; cursor: pointer; font-size: 0.85rem;">
                        üíæ Save Assembly Settings
                    </button>
                </div>
            `;
        }

        // Assembly Functions
        function moveSceneInOrder(sceneId, direction) {
            const order = state.assembly.sceneOrder.length > 0
                ? [...state.assembly.sceneOrder]
                : state.script.scenes.map(s => s.id);

            const currentIndex = order.indexOf(sceneId);
            const newIndex = currentIndex + direction;

            if (newIndex >= 0 && newIndex < order.length) {
                [order[currentIndex], order[newIndex]] = [order[newIndex], order[currentIndex]];
                state.assembly.sceneOrder = order;
                saveProject();
                render();
            }
        }

        function setSceneTransition(sceneId, transitionType) {
            state.assembly.transitions[sceneId] = { type: transitionType };
            saveProject();
        }

        function toggleMusic(enabled) {
            state.assembly.music.enabled = enabled;
            saveProject();
            render();
        }

        function selectMusicTrack(trackId) {
            state.assembly.music.trackId = trackId;
            if (trackId && trackId !== 'none') {
                state.assembly.music.enabled = true;
            }
            saveProject();
            render();
        }

        function setMusicVolume(volume) {
            state.assembly.music.volume = parseInt(volume);
            saveProject();
        }

        function toggleCaptions(enabled) {
            state.assembly.captions.enabled = enabled;
            saveProject();
            render();
        }

        function setCaptionStyle(style) {
            state.assembly.captions.style = style;
            saveProject();
            render();
        }

        function setCaptionPosition(position) {
            state.assembly.captions.position = position;
            saveProject();
            render();
        }

        function setVoiceVolume(volume) {
            if (!state.assembly.audioMix) state.assembly.audioMix = {};
            state.assembly.audioMix.voiceVolume = parseInt(volume);
            saveProject();
            render();
        }

        function setAudioMixMusicVolume(volume) {
            if (!state.assembly.audioMix) state.assembly.audioMix = {};
            state.assembly.audioMix.musicVolume = parseInt(volume);
            saveProject();
            render();
        }

        async function saveAssemblySettings() {
            try {
                const updateAssembly = firebase.functions().httpsCallable('creationWizardUpdateAssembly');
                await updateAssembly({
                    projectId: state.project.id,
                    assembly: {
                        status: 'ready',
                        sceneOrder: state.assembly.sceneOrder,
                        transitions: state.assembly.transitions,
                        music: state.assembly.music,
                        captions: state.assembly.captions,
                        audioMix: state.assembly.audioMix
                    }
                });
                state.assembly.status = 'ready';
                showToast('Assembly settings saved!', 'success');
                saveProject();
                render();
            } catch (error) {
                console.error('Failed to save assembly:', error);
                showToast('Failed to save assembly settings', 'error');
            }
        }

        // ==========================================
        // 7.10.1 VIDEO PREVIEW ENGINE CONTROLS
        // ==========================================

        let previewEngine = null;

        async function initializePreviewEngine() {
            const canvas = document.getElementById('preview-canvas');
            if (!canvas) {
                console.error('Preview canvas not found');
                return;
            }

            // Update state to show loading
            state.preview.loadProgress = 1;
            render();

            // Create the engine
            previewEngine = new VideoPreviewEngine(canvas, {
                width: 1280,
                height: 720,
                onTimeUpdate: (time) => {
                    state.preview.currentTime = time;
                    // Update scrubber without full re-render
                    const scrubber = document.getElementById('preview-scrubber');
                    if (scrubber) {
                        scrubber.value = time;
                        const percent = (time / state.preview.totalDuration) * 100;
                        scrubber.style.background = `linear-gradient(to right, #8b5cf6 0%, #8b5cf6 ${percent}%, rgba(255,255,255,0.2) ${percent}%, rgba(255,255,255,0.2) 100%)`;
                    }
                },
                onSceneChange: (sceneIndex) => {
                    state.preview.currentSceneIndex = sceneIndex;
                    highlightTimelineScene(sceneIndex);
                    render();
                },
                onEnded: () => {
                    state.preview.isPlaying = false;
                    state.preview.currentTime = 0;
                    render();
                },
                onLoadProgress: (progress) => {
                    state.preview.loadProgress = progress;
                    render();
                },
                onReady: () => {
                    state.preview.isReady = true;
                    state.preview.loadProgress = 100;
                    render();
                }
            });

            // Build scenes array from current state
            const scenes = buildPreviewScenes();
            state.preview.totalDuration = scenes.reduce((sum, s) => sum + (s.duration || 8), 0);

            try {
                await previewEngine.loadScenes(scenes);

                // Set caption settings
                previewEngine.captionsEnabled = state.assembly.captions.enabled;
                previewEngine.captionStyle = state.assembly.captions.style;
                previewEngine.captionPosition = state.assembly.captions.position;

                // Set music if enabled
                if (state.assembly.music.enabled && state.assembly.music.trackId) {
                    const track = state.assembly.musicLibrary.find(t => t.id === state.assembly.music.trackId);
                    if (track?.url) {
                        await previewEngine.setBackgroundMusic(track.url, state.assembly.music.volume / 100);
                    }
                }

            } catch (error) {
                console.error('Failed to initialize preview:', error);
                showToast('Failed to load preview', 'error');
                state.preview.loadProgress = 0;
                render();
            }
        }

        function buildPreviewScenes() {
            const scriptScenes = state.script.scenes || [];
            const animationScenes = state.animation.scenes || [];
            const storyboardScenes = state.storyboard.scenes || [];
            const sceneOrder = state.assembly.sceneOrder.length > 0
                ? state.assembly.sceneOrder
                : scriptScenes.map(s => s.id);

            return sceneOrder.map(sceneId => {
                const scriptScene = scriptScenes.find(s => s.id === sceneId);
                const animScene = animationScenes.find(s => s.sceneId === sceneId);
                const storyboardScene = storyboardScenes.find(s => s.sceneId === sceneId);
                const transition = state.assembly.transitions[sceneId] || { type: 'cut' };

                if (!scriptScene) return null;

                return {
                    id: sceneId,
                    type: animScene?.videoUrl ? 'video' : (storyboardScene?.source === 'stock-video' ? 'video' : 'image'),
                    imageUrl: storyboardScene?.imageUrl,
                    videoUrl: animScene?.videoUrl || (storyboardScene?.source === 'stock-video' ? storyboardScene?.videoUrl : null),
                    duration: scriptScene.duration || 8,
                    voiceoverUrl: animScene?.voiceoverUrl,
                    voiceoverDuration: animScene?.voiceoverDuration,
                    caption: scriptScene.narration,
                    transition: transition.type,
                    transitionDuration: transition.duration || 0.5,
                    kenBurns: {
                        startZoom: 1.0,
                        endZoom: 1.15,
                        panX: (Math.random() - 0.5) * 0.1,
                        panY: (Math.random() - 0.5) * 0.1
                    }
                };
            }).filter(Boolean);
        }

        function togglePreviewPlayback() {
            if (!previewEngine || !state.preview.isReady) return;

            if (state.preview.isPlaying) {
                previewEngine.pause();
                state.preview.isPlaying = false;
            } else {
                previewEngine.play();
                state.preview.isPlaying = true;
            }
            render();
        }

        function stopPreview() {
            if (!previewEngine || !state.preview.isReady) return;

            previewEngine.pause();
            previewEngine.seek(0);
            state.preview.isPlaying = false;
            state.preview.currentTime = 0;
            state.preview.currentSceneIndex = 0;
            render();
        }

        function seekPreview(time) {
            if (!previewEngine || !state.preview.isReady) return;

            const newTime = parseFloat(time);
            previewEngine.seek(newTime);
            state.preview.currentTime = newTime;
        }

        function updateScrubberPreview(time) {
            // Visual feedback while dragging - update time display
            state.preview.currentTime = parseFloat(time);
            const timeDisplay = document.querySelector('[style*="font-family: monospace"]');
            if (timeDisplay) {
                timeDisplay.textContent = `${formatDuration(parseFloat(time))} / ${formatDuration(state.preview.totalDuration)}`;
            }
        }

        function setPreviewVolume(volume) {
            state.preview.volume = parseInt(volume);
            if (previewEngine) {
                previewEngine.voiceVolume = volume / 100;
            }
        }

        function prevPreviewScene() {
            if (!previewEngine || !state.preview.isReady) return;
            if (state.preview.currentSceneIndex > 0) {
                const newIndex = state.preview.currentSceneIndex - 1;
                const scenes = previewEngine.scenes;
                if (scenes[newIndex]) {
                    previewEngine.seek(scenes[newIndex].startTime);
                    state.preview.currentSceneIndex = newIndex;
                    state.preview.currentTime = scenes[newIndex].startTime;
                    render();
                }
            }
        }

        function nextPreviewScene() {
            if (!previewEngine || !state.preview.isReady) return;
            const scriptScenes = state.script.scenes || [];
            if (state.preview.currentSceneIndex < scriptScenes.length - 1) {
                const newIndex = state.preview.currentSceneIndex + 1;
                const scenes = previewEngine.scenes;
                if (scenes[newIndex]) {
                    previewEngine.seek(scenes[newIndex].startTime);
                    state.preview.currentSceneIndex = newIndex;
                    state.preview.currentTime = scenes[newIndex].startTime;
                    render();
                }
            }
        }

        function seekToScene(sceneId) {
            if (!previewEngine || !state.preview.isReady) return;

            const sceneIndex = previewEngine.scenes.findIndex(s => s.id === sceneId);
            if (sceneIndex >= 0) {
                const scene = previewEngine.scenes[sceneIndex];
                previewEngine.seek(scene.startTime);
                state.preview.currentSceneIndex = sceneIndex;
                state.preview.currentTime = scene.startTime;
                render();
            }
        }

        function highlightTimelineScene(sceneIndex) {
            // Highlight the currently playing scene in the timeline
            const timelineScenes = document.querySelectorAll('.timeline-scene');
            timelineScenes.forEach((el, idx) => {
                if (idx === sceneIndex) {
                    el.style.borderColor = 'rgba(139, 92, 246, 0.8)';
                    el.style.boxShadow = '0 0 10px rgba(139, 92, 246, 0.3)';
                } else {
                    el.style.borderColor = 'rgba(255,255,255,0.1)';
                    el.style.boxShadow = 'none';
                }
            });
        }

        // Cleanup preview when leaving Assembly step
        function cleanupPreviewEngine() {
            if (previewEngine) {
                previewEngine.pause();
                previewEngine.destroy();
                previewEngine = null;
            }
            state.preview.isReady = false;
            state.preview.isPlaying = false;
            state.preview.loadProgress = 0;
        }

        // ==========================================
        // 7.11 STEP 7: EXPORT
        // ==========================================

        const EXPORT_QUALITIES = {
            '720p': { name: '720p HD', description: 'Good quality, smaller file', icon: 'üì±' },
            '1080p': { name: '1080p Full HD', description: 'High quality, recommended', icon: 'üñ•Ô∏è' },
            '4k': { name: '4K Ultra HD', description: 'Maximum quality, large file', icon: 'üé¨' }
        };

        function renderStep7Export() {
            const exportState = state.export || {};
            const isExporting = exportState.status === 'exporting' || exportState.status === 'processing';
            const isCompleted = exportState.status === 'completed';
            const isFailed = exportState.status === 'failed' || exportState.status === 'error';
            const progress = exportState.progress || 0;

            // Calculate video summary
            const scriptScenes = state.script.scenes || [];
            const animationScenes = state.animation.scenes || [];
            const animatedCount = animationScenes.filter(s => s.videoUrl).length;
            const totalDuration = scriptScenes.reduce((sum, s) => sum + (s.duration || 8), 0);
            const platform = PLATFORM_PRESETS[state.platform.selected] || {};

            let html = '<div class="fade-in">';

            // Header
            html += `
                <div class="content-card">
                    <div class="content-card-header">
                        <div class="content-card-icon">üé¨</div>
                        <div style="flex: 1;">
                            <div class="content-card-title">Export Video</div>
                            <div class="content-card-subtitle">Render your final video and download</div>
                        </div>
                    </div>
                </div>
            `;

            // Main content based on state
            if (isExporting) {
                html += renderExportProgress(exportState);
            } else if (isCompleted && exportState.outputUrl) {
                html += renderExportComplete(exportState);
            } else if (isFailed) {
                html += renderExportFailed(exportState);
            } else {
                html += renderExportSettings(scriptScenes, animatedCount, totalDuration, platform);
            }

            // Navigation (only back button on export step)
            html += `
                <div class="nav-buttons">
                    <button class="nav-button nav-button-back" onclick="goToStep(6)">
                        <span>‚Üê</span>
                        <span>Back</span>
                    </button>
                    <div></div>
                </div>
            `;

            html += '</div>';
            return html;
        }

        function renderExportSettings(scriptScenes, animatedCount, totalDuration, platform) {
            const selectedQuality = state.export.selectedQuality || '1080p';

            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                    <!-- Left: Video Summary -->
                    <div class="content-card" style="padding: 1.25rem;">
                        <div style="font-size: 0.9rem; font-weight: 600; color: white; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üìã</span> Video Summary
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">Platform</span>
                                <span style="color: white; font-size: 0.85rem;">${platform.icon || 'üì∫'} ${platform.name || 'YouTube'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">Aspect Ratio</span>
                                <span style="color: white; font-size: 0.85rem;">${state.platform.aspectRatio || '16:9'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">Total Scenes</span>
                                <span style="color: white; font-size: 0.85rem;">${scriptScenes.length} scenes</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">Animated Scenes</span>
                                <span style="color: ${animatedCount === scriptScenes.length ? '#10b981' : '#f59e0b'}; font-size: 0.85rem;">
                                    ${animatedCount}/${scriptScenes.length} ${animatedCount === scriptScenes.length ? '‚úì' : '‚ö†Ô∏è'}
                                </span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <span style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">Duration</span>
                                <span style="color: white; font-size: 0.85rem;">${formatDuration(totalDuration)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                                <span style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">Background Music</span>
                                <span style="color: white; font-size: 0.85rem;">${state.assembly.music?.enabled ? 'üéµ Enabled' : 'üîá Disabled'}</span>
                            </div>
                        </div>

                        ${animatedCount < scriptScenes.length ? `
                            <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 0.5rem;">
                                <div style="font-size: 0.8rem; color: #f59e0b;">
                                    ‚ö†Ô∏è ${scriptScenes.length - animatedCount} scene(s) don't have animated videos. They will use static images.
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Right: Export Settings -->
                    <div class="content-card" style="padding: 1.25rem;">
                        <div style="font-size: 0.9rem; font-weight: 600; color: white; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>‚öôÔ∏è</span> Export Settings
                        </div>

                        <!-- Quality Selection -->
                        <div style="margin-bottom: 1.25rem;">
                            <label style="display: block; font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-bottom: 0.5rem;">Video Quality</label>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                ${Object.entries(EXPORT_QUALITIES).map(([id, q]) => `
                                    <button onclick="setExportQuality('${id}')"
                                            style="padding: 0.75rem; border-radius: 0.5rem; border: 1px solid ${selectedQuality === id ? 'rgba(139, 92, 246, 0.6)' : 'rgba(255,255,255,0.15)'}; background: ${selectedQuality === id ? 'rgba(139, 92, 246, 0.2)' : 'rgba(255,255,255,0.03)'}; color: white; cursor: pointer; text-align: left; display: flex; align-items: center; gap: 0.75rem;">
                                        <span style="font-size: 1.25rem;">${q.icon}</span>
                                        <div>
                                            <div style="font-size: 0.9rem; font-weight: 600;">${q.name}</div>
                                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5);">${q.description}</div>
                                        </div>
                                        ${selectedQuality === id ? '<span style="margin-left: auto; color: #8b5cf6;">‚úì</span>' : ''}
                                    </button>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Estimated Info -->
                        <div style="padding: 0.75rem; background: rgba(139, 92, 246, 0.1); border-radius: 0.5rem; margin-bottom: 1.25rem;">
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.25rem;">Estimated Processing Time</div>
                            <div style="font-size: 1rem; color: white; font-weight: 600;">~${Math.ceil(totalDuration * 2 / 60)} minutes</div>
                        </div>

                        <!-- Export Button -->
                        <button onclick="startExport()"
                                ${animatedCount === 0 ? 'disabled' : ''}
                                style="width: 100%; padding: 1rem; border-radius: 0.75rem; border: none; background: ${animatedCount > 0 ? 'linear-gradient(135deg, #8b5cf6, #06b6d4)' : 'rgba(255,255,255,0.1)'}; color: ${animatedCount > 0 ? 'white' : 'rgba(255,255,255,0.4)'}; font-size: 1rem; font-weight: 700; cursor: ${animatedCount > 0 ? 'pointer' : 'not-allowed'}; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <span>üöÄ</span>
                            <span>Start Export</span>
                        </button>

                        ${animatedCount === 0 ? `
                            <div style="text-align: center; margin-top: 0.75rem; font-size: 0.8rem; color: rgba(255,255,255,0.5);">
                                Complete the Animation step before exporting
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderExportProgress(exportState) {
            const progress = exportState.progress || 0;
            const currentStage = exportState.currentStage || 'Starting export...';

            return `
                <div class="content-card" style="text-align: center; padding: 3rem 2rem; margin-top: 1rem;">
                    <div class="animate-float" style="font-size: 4rem; margin-bottom: 1.5rem;">üé¨</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: white; margin-bottom: 0.5rem;">
                        Rendering Your Video
                    </div>
                    <div style="color: rgba(255,255,255,0.6); margin-bottom: 2rem;">
                        ${currentStage}
                    </div>

                    <!-- Progress Bar -->
                    <div style="width: 100%; max-width: 400px; margin: 0 auto 1.5rem;">
                        <div style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: ${progress}%; background: linear-gradient(90deg, #8b5cf6, #06b6d4); border-radius: 4px; transition: width 0.5s ease;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.85rem;">
                            <span style="color: rgba(255,255,255,0.5);">Progress</span>
                            <span style="color: #8b5cf6; font-weight: 600;">${progress}%</span>
                        </div>
                    </div>

                    <!-- Cancel Button -->
                    <button onclick="cancelExport()"
                            style="padding: 0.6rem 1.5rem; border-radius: 0.5rem; border: 1px solid rgba(239, 68, 68, 0.4); background: rgba(239, 68, 68, 0.1); color: #ef4444; cursor: pointer; font-size: 0.85rem;">
                        Cancel Export
                    </button>

                    <div style="margin-top: 1.5rem; color: rgba(255,255,255,0.4); font-size: 0.75rem;">
                        Please don't close this page while exporting
                    </div>
                </div>
            `;
        }

        function renderExportComplete(exportState) {
            const outputUrl = exportState.outputUrl;

            return `
                <div class="content-card" style="text-align: center; padding: 3rem 2rem; margin-top: 1rem;">
                    <div style="font-size: 4rem; margin-bottom: 1.5rem;">üéâ</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: white; margin-bottom: 0.5rem;">
                        Export Complete!
                    </div>
                    <div style="color: rgba(255,255,255,0.6); margin-bottom: 2rem;">
                        Your video is ready to download
                    </div>

                    <!-- Video Preview -->
                    ${outputUrl ? `
                        <div style="max-width: 500px; margin: 0 auto 2rem; border-radius: 0.75rem; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);">
                            <video src="${outputUrl}" controls style="width: 100%; display: block;"></video>
                        </div>
                    ` : ''}

                    <!-- Action Buttons -->
                    <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                        <a href="${outputUrl}" download
                           style="padding: 0.75rem 2rem; border-radius: 0.5rem; border: none; background: linear-gradient(135deg, #8b5cf6, #06b6d4); color: white; font-weight: 600; cursor: pointer; text-decoration: none; display: flex; align-items: center; gap: 0.5rem;">
                            <span>‚¨áÔ∏è</span>
                            <span>Download Video</span>
                        </a>
                        <button onclick="copyExportUrl()"
                                style="padding: 0.75rem 1.5rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üìã</span>
                            <span>Copy Link</span>
                        </button>
                        <button onclick="exportAgain()"
                                style="padding: 0.75rem 1.5rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üîÑ</span>
                            <span>Export Again</span>
                        </button>
                    </div>

                    <!-- Share Options -->
                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 1rem;">Share your video</div>
                        <div style="display: flex; justify-content: center; gap: 0.75rem;">
                            ${['YouTube', 'TikTok', 'Instagram', 'Twitter'].map(platform => `
                                <button onclick="shareToSocial('${platform.toLowerCase()}')"
                                        style="width: 3rem; height: 3rem; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; cursor: pointer; font-size: 1.25rem; display: flex; align-items: center; justify-content: center;"
                                        title="Share to ${platform}">
                                    ${platform === 'YouTube' ? 'üì∫' : platform === 'TikTok' ? 'üéµ' : platform === 'Instagram' ? 'üì∏' : 'üê¶'}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderExportFailed(exportState) {
            const error = exportState.error || 'An unknown error occurred';

            return `
                <div class="content-card" style="text-align: center; padding: 3rem 2rem; margin-top: 1rem;">
                    <div style="font-size: 4rem; margin-bottom: 1.5rem;">‚ùå</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: white; margin-bottom: 0.5rem;">
                        Export Failed
                    </div>
                    <div style="color: rgba(255,255,255,0.6); margin-bottom: 1rem;">
                        Something went wrong during export
                    </div>

                    <div style="max-width: 400px; margin: 0 auto 2rem; padding: 1rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.5rem;">
                        <div style="font-size: 0.85rem; color: #ef4444;">
                            ${error}
                        </div>
                    </div>

                    <button onclick="retryExport()"
                            style="padding: 0.75rem 2rem; border-radius: 0.5rem; border: none; background: linear-gradient(135deg, #8b5cf6, #06b6d4); color: white; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem;">
                        <span>üîÑ</span>
                        <span>Try Again</span>
                    </button>
                </div>
            `;
        }

        // Export Functions
        function setExportQuality(quality) {
            if (!state.export) state.export = {};
            state.export.selectedQuality = quality;
            render();
        }

        async function startExport() {
            const animatedCount = (state.animation.scenes || []).filter(s => s.videoUrl).length;
            if (animatedCount === 0) {
                showToast('Please complete animation step first', 'error');
                return;
            }

            state.export.status = 'exporting';
            state.export.progress = 0;
            state.export.currentStage = 'Starting export...';
            render();

            try {
                const startExport = firebase.functions().httpsCallable('creationWizardStartExport');
                const result = await startExport({
                    projectId: state.project.id,
                    quality: state.export.selectedQuality || '1080p',
                    format: 'mp4'
                });

                state.export.jobId = result.data.jobId;
                showToast('Export started!', 'success');

                // Start polling for progress
                pollExportStatus();

            } catch (error) {
                console.error('Export error:', error);
                state.export.status = 'failed';
                state.export.error = error.message;
                showToast('Failed to start export: ' + error.message, 'error');
                render();
            }
        }

        async function pollExportStatus() {
            if (!state.export.jobId) return;

            try {
                const checkStatus = firebase.functions().httpsCallable('creationWizardCheckExportStatus');
                const result = await checkStatus({ jobId: state.export.jobId });

                state.export.status = result.data.status;
                state.export.progress = result.data.progress || 0;
                state.export.currentStage = result.data.currentStage || '';
                state.export.outputUrl = result.data.outputUrl || null;
                state.export.error = result.data.error || null;

                render();

                if (result.data.status === 'completed') {
                    showToast('Export complete!', 'success');
                    saveProject();
                } else if (result.data.status === 'failed' || result.data.status === 'error') {
                    showToast('Export failed', 'error');
                } else if (result.data.status === 'processing' || result.data.status === 'pending') {
                    // Continue polling
                    setTimeout(pollExportStatus, 2000);
                }
            } catch (error) {
                console.error('Poll status error:', error);
                // Retry polling
                setTimeout(pollExportStatus, 5000);
            }
        }

        async function cancelExport() {
            if (!state.export.jobId) return;

            try {
                const cancelExport = firebase.functions().httpsCallable('creationWizardCancelExport');
                await cancelExport({ jobId: state.export.jobId });

                state.export.status = 'cancelled';
                state.export.jobId = null;
                showToast('Export cancelled', 'info');
                render();
            } catch (error) {
                console.error('Cancel error:', error);
                showToast('Failed to cancel export', 'error');
            }
        }

        function copyExportUrl() {
            if (state.export.outputUrl) {
                navigator.clipboard.writeText(state.export.outputUrl)
                    .then(() => showToast('Link copied to clipboard!', 'success'))
                    .catch(() => showToast('Failed to copy link', 'error'));
            }
        }

        function exportAgain() {
            state.export.status = 'idle';
            state.export.jobId = null;
            state.export.outputUrl = null;
            state.export.progress = 0;
            render();
        }

        function retryExport() {
            state.export.status = 'idle';
            state.export.error = null;
            render();
        }

        function shareToSocial(platform) {
            const url = state.export.outputUrl;
            if (!url) return;

            let shareUrl;
            switch (platform) {
                case 'twitter':
                    shareUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent('Check out my new video!')}`;
                    break;
                default:
                    showToast(`Download the video to upload to ${platform}`, 'info');
                    return;
            }

            if (shareUrl) {
                window.open(shareUrl, '_blank', 'width=600,height=400');
            }
        }

        // ==========================================
        // 7.12 HELPER RENDERS
        // ==========================================

        function renderComingSoonStep(stepNum, title, description) {
            return `
                <div class="fade-in">
                    <div class="content-card" style="text-align: center; padding: 4rem 2rem;">
                        <div style="font-size: 4rem; margin-bottom: 1.5rem;">üöß</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: white; margin-bottom: 0.5rem;">
                            Step ${stepNum}: ${title}
                        </div>
                        <div style="color: rgba(255,255,255,0.6); margin-bottom: 2rem;">
                            ${description}
                        </div>
                        <div style="color: rgba(139, 92, 246, 0.8); font-size: 0.9rem;">
                            Coming soon in Phase ${stepNum > 2 ? Math.ceil((stepNum - 2) / 2) + 1 : 1}...
                        </div>
                    </div>
                    ${renderNavButtons(stepNum - 1, stepNum < 7 ? stepNum + 1 : null)}
                </div>
            `;
        }

        // ==========================================
        // 7.8 NAVIGATION BUTTONS
        // ==========================================
        function renderNavButtons(backStep, nextStep) {
            let html = '<div class="nav-buttons">';

            if (backStep) {
                html += `
                    <button class="nav-button nav-button-back" onclick="goToStep(${backStep})">
                        <span>‚Üê</span>
                        <span>Back</span>
                    </button>
                `;
            } else {
                html += '<div></div>';
            }

            if (nextStep) {
                html += `
                    <button class="nav-button nav-button-next" onclick="goToStep(${nextStep})">
                        <span>Continue</span>
                        <span>‚Üí</span>
                    </button>
                `;
            } else if (state.currentStep < 7) {
                html += `
                    <button class="nav-button nav-button-next" disabled>
                        <span>Continue</span>
                        <span>‚Üí</span>
                    </button>
                `;
            }

            html += '</div>';
            return html;
        }

        // ==========================================
        // 7.9 EVENT LISTENERS
        // ==========================================
        function attachEventListeners() {
            // Duration slider continuous update
            const durationSlider = document.getElementById('duration-slider');
            if (durationSlider) {
                durationSlider.addEventListener('input', function() {
                    const value = parseInt(this.value);
                    state.platform.targetDuration = value;
                    // Update just the display without full re-render
                    const valueDisplay = document.querySelector('.duration-value');
                    if (valueDisplay) {
                        valueDisplay.textContent = formatDuration(value);
                    }
                });
            }

            // Topic input
            const topicInput = document.getElementById('topic-input');
            if (topicInput) {
                topicInput.addEventListener('input', function() {
                    state.content.topic = this.value;
                });
            }
        }

        // ==========================================
        // 7.10 INITIALIZATION
        // ==========================================
        async function init() {
            try {
                await initAuth();

                // Update loading text after auth
                const loadingText = document.getElementById('loading-text');
                if (loadingText) {
                    loadingText.textContent = 'Loading Video Creation Wizard...';
                }

                // Check if loading an existing project
                const projectId = checkUrlForProject();
                if (projectId) {
                    await loadProject(projectId);
                } else {
                    state.isLoading = false;
                    render();
                }
            } catch (error) {
                console.error('Init error:', error);
                state.isLoading = false;
                render();
            }
        }

        // Start the app
        init();
    </script>
</body>
</html>
